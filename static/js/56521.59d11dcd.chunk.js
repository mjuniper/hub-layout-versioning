"use strict";(self.webpackChunkhub_layout_versioning=self.webpackChunkhub_layout_versioning||[]).push([[56521],{16063:function(t,e,n){n.d(e,{g:function(){return o}});var r=n(67450),a=n(64369);function o(t){return(0,r.r)((0,a.c)(t.url),t)}},56521:function(t,e,n){n.r(e),n.d(e,{hub_download_card:function(){return ut}});var r=n(74165),a=n(15861),o=n(97326),i=n(29439),s=n(43144),l=n(15671),c=n(60136),d=n(92572),u=n(28664),h=n(5692),f=n(95101),p=n(13129),m=n(4541),v=n(54825),w=n(25240),y=n(13115),g=n(35137),I=n(25212),b=n(12969),x=n(17684),D=n(45059),E=n(16063),k=n(46356),C=n(67450),S=n(72528),R=n(54805),T=n(6798),P=n(80673);n(7597),n(1319),n(89732);function _(t){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(t);return e<0?void 0:e}function L(t){if(t>=0&&t<64)return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[t]}var O={atob:function(t){if((t=(t="".concat(t)).replace(/[ \t\n\f\r]/g,"")).length%4===0&&(t=t.replace(/==?$/,"")),t.length%4===1||/[^+/0-9A-Za-z]/.test(t))return null;for(var e="",n=0,r=0,a=0;a<t.length;a++)n<<=6,n|=_(t[a]),24===(r+=6)&&(e+=String.fromCharCode((16711680&n)>>16),e+=String.fromCharCode((65280&n)>>8),e+=String.fromCharCode(255&n),n=r=0);return 12===r?(n>>=4,e+=String.fromCharCode(n)):18===r&&(n>>=2,e+=String.fromCharCode((65280&n)>>8),e+=String.fromCharCode(255&n)),e},btoa:function(t){var e;for(t="".concat(t),e=0;e<t.length;e++)if(t.charCodeAt(e)>255)return null;var n="";for(e=0;e<t.length;e+=3){var r=[void 0,void 0,void 0,void 0];r[0]=t.charCodeAt(e)>>2,r[1]=(3&t.charCodeAt(e))<<4,t.length>e+1&&(r[1]|=t.charCodeAt(e+1)>>4,r[2]=(15&t.charCodeAt(e+1))<<2),t.length>e+2&&(r[2]|=t.charCodeAt(e+2)>>6,r[3]=63&t.charCodeAt(e+2));for(var a=0;a<r.length;a++)"undefined"===typeof r[a]?n+="=":n+=L(r[a])}return n}},A="4326",j={csv:{name:"CSV",itemTypes:["CSV","CSV Collection"],supportsProjection:!0},kml:{name:"KML",itemTypes:["KML","KML Collection"],supportsProjection:!1},shapefile:{name:"Shapefile",itemTypes:["Shapefile"],supportsProjection:!0},fileGeodatabase:{name:"File Geodatabase",itemTypes:["File Geodatabase"],supportsProjection:!0},geojson:{name:"GeoJson",itemTypes:["GeoJson"],supportsProjection:!1},excel:{name:"Excel",itemTypes:["Microsoft Excel"],supportsProjection:!0},featureCollection:{name:"Feature Collection",itemTypes:["Feature Collection"],supportsProjection:!0}};function Z(t,e){var n,r=function(t){if(t)return{onlyTypes:t.onlyTypes,layerId:t.layerId,spatialRefId:t.spatialRefId};return{}}(e),a=r.onlyTypes,o=r.layerId,i=r.spatialRefId,s=Object.keys(j).map((function(t){return j[t]})),l=new Set((0,b.f)(s.filter((function(t){return!t.supportsProjection})).map((function(t){return t.itemTypes}))));n=a||(0,b.f)(s.map((function(t){return t.itemTypes})));var c=(new x.S).startGroup().match(M(t)).in("typekeywords").and().match(U(o)).in("typekeywords").endGroup().and().startGroup();return function(t,e){var n=e.types,r=e.noProjectionItemTypes,a=e.spatialRefId,o=function(t,e){var n=A;return t&&!r.has(e)&&(n=t),n},i=function(t,e){e.startGroup().match(/\s/g.test(t)?t:'"'.concat(t,'"')).in("type").and().match(F(o(a,t))).in("typekeywords").endGroup()};n.forEach((function(e,r){i(e,t),r<n.length-1&&t.or()}))}(c,{types:n,spatialRefId:i,noProjectionItemTypes:l}),c.endGroup(),c.toParam()}function F(t){var e=function(t){var e;try{e=JSON.parse(t)}catch(n){e=t}return e}(t),n=function(t){if("object"===typeof t){var e=t.wkid,n=t.wkt;return e?e+"":O.btoa(n)}return t}(e);return"spatialRefId:".concat(n)}function M(t){return"exportItem:".concat(t)}function U(t){return t?"exportLayer:0".concat(t):"exportLayer:null"}var G=(0,f.c)((function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}function a(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function o(t,e,r,o,i){if("function"!==typeof r)throw new TypeError("The listener must be a function");var s=new a(r,o||t,i),l=n?n+e:e;return t._events[l]?t._events[l].fn?t._events[l]=[t._events[l],s]:t._events[l].push(s):(t._events[l]=s,t._eventsCount++),t}function i(t,e){0===--t._eventsCount?t._events=new r:delete t._events[e]}function s(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),s.prototype.eventNames=function(){var t,r,a=[];if(0===this._eventsCount)return a;for(r in t=this._events)e.call(t,r)&&a.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(t)):a},s.prototype.listeners=function(t){var e=n?n+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,o=r.length,i=new Array(o);a<o;a++)i[a]=r[a].fn;return i},s.prototype.listenerCount=function(t){var e=n?n+t:t,r=this._events[e];return r?r.fn?1:r.length:0},s.prototype.emit=function(t,e,r,a,o,i){var s=n?n+t:t;if(!this._events[s])return!1;var l,c,d=this._events[s],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(t,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,e),!0;case 3:return d.fn.call(d.context,e,r),!0;case 4:return d.fn.call(d.context,e,r,a),!0;case 5:return d.fn.call(d.context,e,r,a,o),!0;case 6:return d.fn.call(d.context,e,r,a,o,i),!0}for(c=1,l=new Array(u-1);c<u;c++)l[c-1]=arguments[c];d.fn.apply(d.context,l)}else{var h,f=d.length;for(c=0;c<f;c++)switch(d[c].once&&this.removeListener(t,d[c].fn,void 0,!0),u){case 1:d[c].fn.call(d[c].context);break;case 2:d[c].fn.call(d[c].context,e);break;case 3:d[c].fn.call(d[c].context,e,r);break;case 4:d[c].fn.call(d[c].context,e,r,a);break;default:if(!l)for(h=1,l=new Array(u-1);h<u;h++)l[h-1]=arguments[h];d[c].fn.apply(d[c].context,l)}}return!0},s.prototype.on=function(t,e,n){return o(this,t,e,n,!1)},s.prototype.once=function(t,e,n){return o(this,t,e,n,!0)},s.prototype.removeListener=function(t,e,r,a){var o=n?n+t:t;if(!this._events[o])return this;if(!e)return i(this,o),this;var s=this._events[o];if(s.fn)s.fn!==e||a&&!s.once||r&&s.context!==r||i(this,o);else{for(var l=0,c=[],d=s.length;l<d;l++)(s[l].fn!==e||a&&!s[l].once||r&&s[l].context!==r)&&c.push(s[l]);c.length?this._events[o]=1===c.length?c[0]:c:i(this,o)}return this},s.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&i(this,e)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,t.exports=s})),N=function(t){(0,c.Z)(n,t);var e=(0,d.Z)(n);function n(t,r,a){var o;return(0,l.Z)(this,n),(o=e.call(this,t)).status=a,o.url=r,o}return(0,s.Z)(n)}((0,u.Z)(Error));function K(t){var e=t.host,n=t.route,r=t.query,a=e.endsWith("/")?e:"".concat(e,"/"),o=new URL(n,a);return o.search=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=Object.keys(t).filter((function(e){return void 0!==t[e]})).reduce((function(e,n){return e[n]=t[n],e}),{});return new URLSearchParams(e).toString()}(r),o.toString()}function H(t){var e=t.datasetId,n=t.format,r=t.spatialRefId,a=t.geometry,o=t.where;return"".concat(e,":").concat(n,":").concat(r,":").concat(a,":").concat(o)}var z={Shapefile:"shp",CSV:"csv","File Geodatabase":"fgdb",GeoJson:"geojson",KML:"kml"};function q(t){if(!z[t])throw new Error("Unsupported Hub download format: ".concat(t));return z[t]}function B(t){var e=t.host,n=t.datasetId,r=t.spatialRefId,a=t.geometry,o=t.where,s={spatialRefId:r,formats:q(t.format),geometry:a?JSON.stringify(a):void 0,where:o},l=K({host:e,route:"/api/v3/datasets/".concat(n,"/downloads"),query:s});return fetch(l).then((function(t){var e=t.ok,n=t.status,r=t.statusText;if(!e)throw new N(r,l,n);return t.json()})).then((function(e){return function(t){var e=t.data;if(!e)throw new Error('Unexpected API response; no "data" property.');if(!Array.isArray(e))throw new Error('Unexpected API response; "data" is not an array.');if(e.length>1)throw new Error('Unexpected API response; "data" contains more than one download.')}(e),function(t,e){var n=(0,i.Z)(t.data,1),r=n[0];if(!r)return{downloadId:e,status:"not_ready"};var a=r.attributes,o=a.contentLastModified,s=a.lastModified,l=a.status,c=a.errors,d=a.contentLength,u=a.cacheTime,h=a.source.lastEditDate,f=r.links.content;return{downloadId:e,contentLastModified:o,lastEditDate:h,lastModified:s,status:l,errors:c||[],downloadUrl:f,contentLength:d,cacheTime:u}}(e,H(t))}))}var J,V=function(){function t(){(0,l.Z)(this,t)}return(0,s.Z)(t,[{key:"disablePoll",value:function(){clearInterval(this.pollTimer),this.pollTimer=null}},{key:"activatePoll",value:function(t){var e=this,n=t.downloadId,r=t.eventEmitter,a=t.pollingInterval,o=t.existingFileDate,s=void 0===o?new Date(0).toISOString():o,l=new Date(s).getTime();this.pollTimer=setInterval((function(){B(t).then((function(t){if(function(t,e){var n=t.status,r=t.lastModified,a=new Date(r).getTime();return"ready"===n||"ready_unknown"===n&&a>e}(t,l))return r.emit("".concat(n,"ExportComplete"),{detail:{metadata:t}}),e.disablePoll();if(function(t){return t&&("error_updating"===t.status||"error_creating"===t.status)}(t)){var a=(0,i.Z)(t.errors,1)[0];return r.emit("".concat(n,"ExportError"),{detail:{error:a,metadata:t}}),e.disablePoll()}})).catch((function(t){return r.emit("".concat(n,"PollingError"),{detail:{error:t,metadata:{status:"error"}}}),e.disablePoll()}))}),a)}}]),t}();function Y(t){return function(t){var e=t.folderId,n=t.start,r=void 0===n?1:n,a=t.num,o=void 0===a?10:a,i=t.authentication,s=e?"/"+e:"";return(0,g.d)(t).then((function(e){return(0,k.g)(t)+"/content/users/"+e+s})).then((function(t){return(0,C.r)(t,{httpMethod:"GET",authentication:i,params:{start:r,num:o}})}))}({authentication:t}).then((function(e){var n=e.folders.find((function(t){return"item-exports"===t.title}));return n?{folder:n}:(0,S.a)({authentication:t,title:"item-exports"})})).then((function(t){return t.folder.id}))}!function(t){t.READY="ready",t.READY_UNKNOWN="ready_unknown",t.STALE="stale",t.NOT_READY="not_ready",t.LOCKED="locked",t.STALE_LOCKED="stale_locked",t.DISABLED="disabled",t.CREATING="creating",t.UPDATING="updating",t.ERROR_CREATING="error_creating",t.ERROR_UPDATING="error_updating",t.ERROR="error"}(J||(J={}));var W=function(t){(0,c.Z)(n,t);var e=(0,d.Z)(n);function n(t){var r;return(0,l.Z)(this,n),r=e.call(this,t),Object.setPrototypeOf((0,o.Z)(r),n.prototype),r}return(0,s.Z)(n)}((0,u.Z)(Error));var Q,X=function(){function t(){(0,l.Z)(this,t)}return(0,s.Z)(t,[{key:"disablePoll",value:function(){clearInterval(this.pollTimer),this.pollTimer=null}},{key:"activatePoll",value:function(t){var e=this,n=t.downloadId,r=t.datasetId,a=t.format,o=t.spatialRefId,i=t.jobId,s=t.authentication,l=t.exportCreated,c=t.eventEmitter,d=t.pollingInterval;this.pollTimer=setInterval((function(){(0,g.j)({id:n,jobId:i,jobType:"export",authentication:s}).then((function(t){return"completed"===t.status?function(t){var e=t.downloadId,n=t.datasetId,r=t.exportCreated,a=t.spatialRefId,o=t.eventEmitter,i=t.authentication,s=(0,D.p)(n),l=s.itemId,c=s.layerId,d=[M(l),U(c),"modified:".concat(r),F(a)];return(0,R.u)({item:{id:e,typekeywords:d.join(",")},authentication:i}).then((function(){return(0,T.s)({id:e,authentication:i,access:"private"})})).then((function(){return Y(i)})).then((function(t){return(0,R.m)({itemId:e,folderId:t,authentication:i})})).catch((function(t){if(!t||"CONT_0011"!==t.code)throw(0,P.a)({id:e,authentication:i}),new W(t.message)})).then((function(){return o.emit("".concat(e,"ExportComplete"),{detail:{metadata:{downloadId:e,status:J.READY,lastModified:(new Date).toISOString(),downloadUrl:K({host:i.portal,route:"content/items/".concat(e,"/data"),query:{token:i.token}})}}})}))}({datasetId:r,format:a,authentication:s,downloadId:n,spatialRefId:o,exportCreated:l,eventEmitter:c}).then((function(){e.disablePoll()})):"failed"===t.status?(c.emit("".concat(n,"ExportError"),{detail:{error:new Error(t.statusMessage),metadata:{status:J.ERROR,errors:[new Error(t.statusMessage)]}}}),e.disablePoll()):void 0})).catch((function(t){return t instanceof W?c.emit("".concat(n,"ExportError"),{detail:{error:t,metadata:{status:J.ERROR,errors:[t]}}}):c.emit("".concat(n,"PollingError"),{detail:{error:t,metadata:{status:J.ERROR,errors:[t]}}}),e.disablePoll()}))}),d)}}]),t}();function $(t){var e=t.target,n=t.downloadId,r=t.datasetId,a=t.jobId,o=t.format,i=t.authentication,s=t.exportCreated,l=t.eventEmitter,c=t.pollingInterval,d=t.spatialRefId,u=t.geometry,h=t.where,f=t.host,p=t.existingFileDate;return e&&"hub"!==e?function(t){var e=new X;return e.activatePoll(t),e}({downloadId:n,datasetId:r,jobId:a,authentication:i,exportCreated:s,format:o,spatialRefId:d,eventEmitter:l,pollingInterval:c,geometry:u,where:h}):function(t){var e=new V;return e.activatePoll(t),e}({host:f,downloadId:n,datasetId:r,format:o,eventEmitter:l,pollingInterval:c,spatialRefId:d,geometry:u,where:h,existingFileDate:p})}function tt(t){var e=t.datasetId,n=t.title,r=t.format,a=t.authentication,o=e.split("_");return function(t){var e=t.authentication,n=t.id,r=t.title,a=t.exportFormat,o=t.exportParameters;return(0,g.d)(t).then((function(e){return(0,k.g)(t)+"/content/users/"+e+"/export"})).then((function(t){return(0,C.r)(t,{httpMethod:"POST",authentication:e,params:{itemId:n,title:r,exportFormat:a,exportParameters:o}})}))}({id:(0,i.Z)(o,1)[0],exportFormat:r,exportParameters:et(t),title:n,authentication:a}).then((function(t){var e=t.size,n=t.jobId;return{downloadId:t.exportItemId,jobId:n,size:e,exportCreated:Date.now()}}))}function et(t){var e=t.datasetId,n=t.spatialRefId,r=t.where,a=e.split("_")[1];if(!a)return n?{targetSR:{wkid:Number(n)}}:{};var o=[{id:Number(a),where:r}];return n?{layers:o,targetSR:{wkid:Number(n)}}:{layers:o}}function nt(t){var e=t.host,n=t.datasetId,r=t.format,a=t.spatialRefId,o=t.geometry,i=t.where,s=t.title,l=t.target,c=t.authentication;return l&&"hub"!==l?tt({datasetId:n,format:r,title:s,authentication:c,spatialRefId:a,where:i}):function(t){var e=t.host,n=t.datasetId,r=t.spatialRefId,a=t.geometry,o=t.where,i={spatialRefId:r,format:q(t.format),geometry:a,where:o},s=K({host:e,route:"/api/v3/datasets/".concat(n,"/downloads")});return fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then((function(t){var e=t.ok,n=t.status,r=t.statusText;if(!e)throw new N(r,s,n)})).then((function(){return{downloadId:H(t)}}))}({host:e,datasetId:n,format:r,spatialRefId:a,geometry:o,where:i})}!function(t){t.Shapefile="Shapefile",t.CSV="CSV",t.KML="KML",t.GeoJson="GeoJson",t.Excel="Excel",t["File Geodatabase"]="File Geodatabase",t["Feature Collection"]="Feature Collection",t["Scene Package"]="Scene Package"}(Q||(Q={}));var rt;!function(t){t.FeatureService="Feature Service",t.MapService="Map Service"}(rt||(rt={}));function at(t){var e,n,r,a,o=t.datasetId,i=t.authentication,s=t.format,l=t.spatialRefId,c=t.target,d=t.portal,u=(0,D.p)(o),h=u.itemId,f=u.layerId;return(0,g.g)(h,{authentication:i,portal:d}).then((function(t){var e=t.type,o=t.modified,l=t.url;return a=t,n=o,r=e,function(t){var e=t.format,n=t.layerId,r=t.url,a=t.type,o=t.modified,i=t.authentication,s=t.portal;if(a!==rt.FeatureService&&a!==rt.MapService)return Promise.resolve({modified:o,format:e});return st((0,E.g)({url:r,authentication:i,portal:s})).then((function(t){var e=(t.layers||[]).map((function(t){return st((0,D.g)({url:"".concat(r,"/").concat(t.id),authentication:i,portal:s}))}));return Promise.all(e)})).then((function(t){return{format:ot({format:e,layerId:n,layers:t}),modified:it(t)}}))}({url:l,authentication:i,type:e,modified:o,format:s,layerId:f,portal:d})})).then((function(t){var n=t.modified,r=t.format;return e=n,(0,I.s)({q:Z(h,{layerId:f,onlyTypes:[r],spatialRefId:l}),num:1,sortField:"modified",sortOrder:"DESC",authentication:i,portal:d})})).then((function(t){return function(t){var e=t.cachedDownload,n=t.serviceLastEditDate,r=t.authentication,a=t.target,o=t.item,i=t.format,s=t.portal,l=void 0===n?void 0:new Date(n).toISOString(),c=e||{},d=c.created,u=c.id,h=function(t,e){return"portal"===t&&e&&(new Date).getTime()-e<=6e5}(a,n),f=function(t,e){var n=e?e.toLowerCase():"",r=!1!==(0,y.g)(t,"properties.downloadsConfig.enabled"),a=(0,y.g)(t,"properties.downloadsConfig.formats")||{},o=!a[n]||!1!==a[n].enabled;return!!r&&o}(o,i),p=f?function(t,e,n){if(!e)return n?J.LOCKED:J.NOT_READY;if(!t)return J.READY_UNKNOWN;if(t>e)return n?J.STALE_LOCKED:J.STALE;return J.READY}(n,d,h):J.DISABLED;if(!e)return{downloadId:H(t),status:p,lastEditDate:l};return{downloadId:u,status:p,lastEditDate:l,contentLastModified:new Date(d).toISOString(),lastModified:new Date(d).toISOString(),downloadUrl:K({host:s||r.portal,route:"content/items/".concat(u,"/data"),query:{token:null===r||void 0===r?void 0:r.token}})}}({cachedDownload:t.results[0],datasetId:o,format:s,spatialRefId:l,serviceLastEditDate:e,itemModifiedDate:n,itemType:r,authentication:i,target:c,item:a,portal:d})})).catch((function(t){throw t}))}function ot(t){var e=t.format,n=function(t,e){return void 0===t&&e.length>1}(t.layerId,t.layers);return n&&function(t){return t===Q.CSV||t===Q.KML}(e)?"".concat(e," Collection"):e}function it(t){return t.map((function(t){var e=t.editingInfo;return(e=void 0===e?{}:e).lastEditDate})).filter((function(t){return void 0!==t})).sort((function(t,e){return e-t}))[0]}function st(t){return t.catch((function(t){if("ArcGISAuthError"===t.name)return t.retry((function(){return Promise.resolve(null)}),1);throw t}))}function lt(t){var e=t.host,n=t.datasetId,r=t.spatialRefId,a=t.format,o=t.geometry,i=t.where,s=t.target,l=t.authentication;return s&&"hub"!==s?at({portal:"".concat(e,"/sharing/rest"),datasetId:n,format:a,authentication:l,spatialRefId:r,target:s}):B({host:e,datasetId:n,format:a,spatialRefId:r,geometry:o,where:i})}var ct={year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric",hour12:!1};function dt(t,e){return"hub"===t||!!e}var ut=function(){function t(e){(0,l.Z)(this,t),(0,h.r)(this,e),this.hubTelemetry=(0,h.c)(this,"hubTelemetry",7),this.hubDownloadCardSuccess=(0,h.c)(this,"hubDownloadCardSuccess",7),this.exportRequested=!1,this.contentLengthString=null,this.poller=null,this.target="hub",this.spatialRefId="4326",(0,v.b)(this,"exportDatasetComplete","exportDatasetError","exportPollingError","download","downloadKeyDown","exportDataset","exportDatasetKeyDown")}return(0,s.Z)(t,[{key:"componentWillLoad",value:function(){var t=(0,a.Z)((0,r.Z)().mark((function t(){return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.resetUndefinedProps(),t.next=3,this.setLocalization();case 3:return this.setAuthentication(),t.next=6,this.fetchMetadataAndSetState();case 6:this.setTranslations();case 7:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"buildDownloadTelemetry",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.isSuccess,n=void 0===e||e,r=t.isCached,a=void 0===r||r;return Object.assign(Object.assign({},a?m.d.dictionary.category.interaction.action.download.details.cache:m.d.dictionary.category.interaction.action.download.details.export),{label:this.format,response:n?m.d.constants.response.SUCCESS:m.d.constants.response.FAILURE})}},{key:"resetUndefinedProps",value:function(){var t=this;["spatialRefId","where","geometry","filename","target"].forEach((function(e){t[e]="undefined"===t[e]?void 0:t[e]})),this.spatialRefId||(this.spatialRefId="4326")}},{key:"setLocalization",value:function(){var t=(0,a.Z)((0,r.Z)().mark((function t(){return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p.i.loadIntlForComponent(this.element);case 2:this.intl=t.sent,this.dateTimeFormatter=new Intl.DateTimeFormat(this.intl.locale,ct),this.setLabels();case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"setLabels",value:function(){var t=this;this.labels=["buttonDownload","fileCreated","fileSize","buttonOptions","menuRequest"].reduce((function(e,n){return e[n]=t.intl.t(n),e}),{})}},{key:"setAuthentication",value:function(){var t=this;this.username&&this.token&&(this.authentication=new w.U({username:this.username,portal:"".concat(this.host,"/sharing/rest"),token:this.token}),this.authentication.getToken=function(){return new Promise((function(e){e(t.token)}))})}},{key:"setTranslations",value:function(){this.setContentLengthString()}},{key:"setContentLengthString",value:function(){var t=this.metadata,e=(t=void 0===t?{}:t).contentLength;if(e){var n=function(t){var e=["Bytes","KB","MB","GB","TB"],n=t;if(0===n)return"n/a";var r=Math.floor(Math.log(n)/Math.log(1024));return 0===r?[n,e[r]]:[(n/Math.pow(1024,r)).toFixed(1),e[r]]}(e);this.contentLengthString="string"===typeof n?this.intl.t(n.toLowerCase()):"".concat(n[0]," ").concat(this.intl.t(n[1].toLowerCase()))}}},{key:"watchHandler",value:function(){var t=(0,a.Z)((0,r.Z)().mark((function t(){return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.resetUndefinedProps(),t.next=3,this.fetchMetadataAndSetState();case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"disconnectedCallback",value:function(){var t=(0,a.Z)((0,r.Z)().mark((function t(){return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.resetUndefinedProps(),this.poller&&this.poller.disablePoll();case 2:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"fetchMetadataAndSetState",value:function(){var t=(0,a.Z)((0,r.Z)().mark((function t(){var e;return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.poller&&this.poller.disablePoll(),e=this.getServiceParams(),t.prev=2,t.next=5,lt(e);case 5:this.metadata=t.sent,this.pollingEvent=new G,this.exportInProgress()&&this.poll(),t.next=13;break;case 10:t.prev=10,t.t0=t.catch(2),this.apiError=t.t0;case 13:case"end":return t.stop()}}),t,this,[[2,10]])})));return function(){return t.apply(this,arguments)}}()},{key:"getServiceParams",value:function(){var t={host:this.host,datasetId:this.datasetId,format:this.format,target:this.target,authentication:this.authentication,spatialRefId:this.spatialRefId};return this.where&&(t.where=this.where),this.geometry&&(t.geometry=this.geometry),t}},{key:"poll",value:function(){var t=this.getServiceParams();this.pollingEvent.on("".concat(this.metadata.downloadId,"ExportComplete"),this.exportDatasetComplete),this.pollingEvent.on("".concat(this.metadata.downloadId,"ExportError"),this.exportDatasetError),this.pollingEvent.on("".concat(this.metadata.downloadId,"PollingError"),this.exportPollingError),this.poller=$(Object.assign(Object.assign({},t),{downloadId:this.metadata.downloadId,jobId:this.metadata.jobId,exportCreated:this.metadata.exportCreated,eventEmitter:this.pollingEvent,pollingInterval:5e3,existingFileDate:new Date(this.metadata.lastModified||0).toISOString()}))}},{key:"download",value:function(){var t=(0,a.Z)((0,r.Z)().mark((function t(){var e;return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.metadata||!this.metadata.downloadUrl){t.next=12;break}return t.prev=1,e=this.transferFile(this.metadata.downloadUrl),this.hubTelemetry.emit(this.buildDownloadTelemetry()),this.hubDownloadCardSuccess.emit(),t.abrupt("return",e);case 8:throw t.prev=8,t.t0=t.catch(1),this.hubTelemetry.emit(this.buildDownloadTelemetry({isSuccess:!1})),t.t0;case 12:return t.next=14,this.exportDataset();case 14:return t.abrupt("return",t.sent);case 15:case"end":return t.stop()}}),t,this,[[1,8]])})));return function(){return t.apply(this,arguments)}}()},{key:"transferFile",value:function(t){return"Feature Collection"===this.format?window.open(t):window.location.href=t}},{key:"exportDataset",value:function(){var t=(0,a.Z)((0,r.Z)().mark((function t(){var e,n;return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.exportRequested=!0,this.metadata.status=this.downloadCached()?"updating":"creating",e=Object.assign({title:this.filename},this.getServiceParams()),t.prev=3,t.next=6,nt(e);case 6:n=t.sent,this.metadata=Object.assign(Object.assign({},this.metadata),n),this.poll(),t.next=16;break;case 11:t.prev=11,t.t0=t.catch(3),this.apiError=t.t0,this.metadata.status="error",this.metadata.errors=[t.t0];case 16:case"end":return t.stop()}}),t,this,[[3,11]])})));return function(){return t.apply(this,arguments)}}()},{key:"exportDatasetComplete",value:function(t){if(this.exportDatasetHandler(t),this.hubTelemetry.emit(this.buildDownloadTelemetry({isCached:!1})),this.hubDownloadCardSuccess.emit(),this.exportRequested){var e=this.metadata.downloadUrl;if(e)return this.transferFile(e)}}},{key:"exportDatasetError",value:function(t){this.exportDatasetHandler(t),this.hubTelemetry.emit(this.buildDownloadTelemetry({isSuccess:!1,isCached:!1}))}},{key:"exportPollingError",value:function(t){this.apiError=t.detail.error,this.exportDatasetHandler(t),this.hubTelemetry.emit(this.buildDownloadTelemetry({isSuccess:!1,isCached:!1}))}},{key:"exportDatasetHandler",value:function(t){this.metadata=Object.assign(Object.assign({},this.metadata),t.detail.metadata),this.pollingEvent.off("".concat(this.metadata.downloadId,"ExportComplete"),this.exportDatasetComplete),this.pollingEvent.off("".concat(this.metadata.downloadId,"ExportError"),this.exportDatasetError),this.pollingEvent.off("".concat(this.metadata.downloadId,"PollingError"),this.exportDatasetError)}},{key:"renderNotice",value:function(){var t=this.metadata,e=this.apiError,n=this.exportRequested,r=(t||{}).status,a=r;"locked"===r?a="not_ready":"stale_locked"===r&&(a="stale");var o=e?e.status||e.message:void 0;return(0,h.h)("hub-download-notice",{"api-error":o,"cannot-export":!dt(this.target,this.username),"export-requested":n,"file-status":a})}},{key:"exportInProgress",value:function(){var t=this.metadata,e=(t=void 0===t?{}:t).status;return"creating"===e||"updating"===e}},{key:"downloadCached",value:function(){var t=this.metadata,e=(t=void 0===t?{}:t).status;return["ready","ready_unknown","stale","stale_locked","updating","error_updating"].includes(e)}},{key:"downloadUpToDate",value:function(){return this.metadata&&"ready"===this.metadata.status}},{key:"isFormatDownloadDisabled",value:function(){return this.metadata&&"disabled"===this.metadata.status}},{key:"renderFileDescription",value:function(){var t=[],e=this.metadata,n=(e=void 0===e?{}:e).lastModified;return this.downloadCached()?(n&&("rtl"===this.intl.direction?t.push((0,h.h)("dt",null,this.dateTimeFormatter.format(new Date(n))),(0,h.h)("dd",{class:"rtl"},this.labels.fileCreated)):t.push((0,h.h)("dt",{class:"ltr"},this.labels.fileCreated),(0,h.h)("dd",null,this.dateTimeFormatter.format(new Date(n))))),this.contentLengthString&&("rtl"===this.intl.direction?t.push((0,h.h)("dt",null,this.contentLengthString),(0,h.h)("dd",{class:"rtl"},this.labels.fileSize)):t.push((0,h.h)("dt",{class:"ltr"},this.labels.fileSize),(0,h.h)("dd",null,this.contentLengthString))),t):null}},{key:"exportDatasetKeyDown",value:function(t){["Enter"," "].includes(t.key)&&this.exportDataset()}},{key:"downloadKeyDown",value:function(t){["Enter"," "].includes(t.key)&&this.download()}},{key:"renderDownloadControl",value:function(){return this.shouldUseDownloadButton()?(0,h.h)("calcite-button",{appearance:"solid",color:"blue",disabled:this.shouldDisableDownload(),"icon-position":"start",onClick:this.download,scale:"m",width:"full"},this.labels.buttonDownload):(0,h.h)("calcite-dropdown",{active:!1,placement:"top",scale:"m",type:"click"},(0,h.h)("calcite-button",{appearance:"solid",color:"blue","icon-end":"caretUp",scale:"m",slot:"dropdown-trigger"},this.labels.buttonOptions),(0,h.h)("calcite-dropdown-group",{"selection-mode":"none"},(0,h.h)("calcite-dropdown-item",{hidden:this.exportInProgress(),onClick:this.exportDataset,onKeyDown:this.exportDatasetKeyDown,role:"menuitem","selection-mode":"none",tabindex:"0"},(0,h.h)("span",null,this.labels.menuRequest)),(0,h.h)("calcite-dropdown-item",{onClick:this.download,onKeyDown:this.downloadKeyDown,role:"menuitem","selection-mode":"none",tabindex:"0"},(0,h.h)("span",null,this.intl.t("menuDownload",{createdDate:this.dateTimeFormatter.format(new Date(this.metadata.lastModified))})))))}},{key:"shouldUseDownloadButton",value:function(){return this.downloadUpToDate()||!this.downloadCached()||this.isFormatDownloadDisabled()||!dt(this.target,this.username)}},{key:"shouldDisableDownload",value:function(){return this.isFormatDownloadDisabled()||this.exportInProgress()&&!this.downloadCached()}},{key:"render",value:function(){return(0,h.h)(h.H,{"data-element":"download-card"},(0,h.h)("calcite-card",{dir:this.intl.direction},(0,h.h)("h3",{slot:"title"},this.name),(0,h.h)("dl",{slot:"subtitle"},this.renderFileDescription()),(0,h.h)("div",{slot:"footer-leading"},this.renderNotice(),this.renderDownloadControl())))}},{key:"element",get:function(){return(0,h.g)(this)}}],[{key:"assetsDirs",get:function(){return["locales"]}},{key:"watchers",get:function(){return{host:["watchHandler"],datasetId:["watchHandler"],format:["watchHandler"],spatialRefId:["watchHandler"],where:["watchHandler"],geometry:["watchHandler"],target:["watchHandler"],username:["watchHandler"],token:["watchHandler"]}}}]),t}();ut.style=":host{font-size:1em}calcite-card div{font-size:1em}h3{font-size:1.25em}dl{font-size:inherit}dt,dd,calcite-dropdown-item{font-size:0.875em}dt{float:left;clear:left;margin-right:0.25rem}dt.ltr::after{content:':'}dd.rtl::after{content:':'}dd{margin:0px;padding:0px;margin-left:110px;-webkit-margin-start:0;margin-inline-start:0}a{vertical-align:middle}calcite-icon{margin-left:0.25rem}a:visited{color:inherit}calcite-dropdown{width:100%;--calcite-dropdown-width:100%;position:relative}calcite-dropdown-item span{color:#323232}calcite-button{width:100%}calcite-card div{width:100%}div[slot=\"footer-leading\"]{display:block}"},63326:function(t,e,n){function r(t){"{"===t[0]&&(t=t.substring(1,t.length-1));return/^(\{){0,1}[0-9a-fA-F]{8}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{4}[-]?[0-9a-fA-F]{12}(\}){0,1}$/gi.test(t)}n.d(e,{i:function(){return r}})},80673:function(t,e,n){n.d(e,{a:function(){return s},r:function(){return l}});var r=n(29847),a=n(46356),o=n(35137),i=n(67450);function s(t){return(0,o.d)(t).then((function(e){var n=(0,a.g)(t)+"/content/users/"+e+"/items/"+t.id+"/delete";return(0,i.r)(n,t)}))}function l(t){return(0,o.d)(t).then((function(e){var n=(0,a.g)(t)+"/content/users/"+e+"/items/"+t.id+"/removeResources";return t.params=(0,r._)((0,r._)({},t.params),{resource:t.resource}),"undefined"!==typeof t.deleteAll&&(t.params.deleteAll=t.deleteAll),(0,i.r)(n,t)}))}},45059:function(t,e,n){n.d(e,{a:function(){return d},g:function(){return s},i:function(){return c},p:function(){return l}});var r=n(29439),a=n(67450),o=n(64369),i=n(63326);function s(t){return(0,a.r)((0,o.c)(t.url),t)}function l(t){var e=t?t.split("_"):[],n=(0,r.Z)(e,2);return{itemId:n[0],layerId:n[1]}}function c(t){var e=l(t).itemId;return!(!e||(0,i.i)(e))}function d(t,e){return/.+::.+/.test(t)?t:"".concat(e,"::").concat(t)}},54805:function(t,e,n){n.d(e,{a:function(){return l},m:function(){return c},u:function(){return s}});var r=n(29847),a=n(46356),o=n(35137),i=n(67450);function s(t){return(0,o.d)(t).then((function(e){var n=t.folderId?(0,a.g)(t)+"/content/users/"+e+"/"+t.folderId+"/items/"+t.item.id+"/update":(0,a.g)(t)+"/content/users/"+e+"/items/"+t.item.id+"/update";return t.params=(0,r._)((0,r._)({},t.params),(0,o.s)(t.item)),t.params.extent&&(0,o.i)(t.params.extent)&&(t.params.extent=(0,o.b)(t.params.extent)),(0,i.r)(n,t)}))}function l(t){return(0,o.d)(t).then((function(e){var n=(0,a.g)(t)+"/content/users/"+e+"/items/"+t.id+"/updateResources";return t.params=(0,r._)({file:t.resource,fileName:t.name,resourcesPrefix:t.prefix,text:t.content},t.params),"undefined"!==typeof t.private&&(t.params.access=t.private?"private":"inherit"),(0,i.r)(n,t)}))}function c(t){return(0,o.d)(t).then((function(e){var n=(0,a.g)(t)+"/content/users/"+e+"/items/"+t.itemId+"/move",o=t.folderId;return o||(o="/"),t.params=(0,r._)({folder:o},t.params),(0,i.r)(n,t)}))}}}]);
//# sourceMappingURL=56521.59d11dcd.chunk.js.map