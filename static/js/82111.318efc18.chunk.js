"use strict";(self.webpackChunkhub_layout_versioning=self.webpackChunkhub_layout_versioning||[]).push([[82111],{17247:function(e,t,n){n.d(t,{Z:function(){return Bt}});var r=n(37762),i=n(93433),a=n(74165),o=n(15861),s=n(1413),l=n(29439),u=n(15671),c=n(43144),h=n(11752),d=n(61120),f=n(60136),p=n(92572),v=n(27366),m=n(19545),_=n(41649),y=n(36721),g=n(80987),b=n(10064),w=n(54472),C=n(93002),x=n(32718),T=n(92026),S=n(97642),k=n(67426),P=n(66978),R=n(94172),A=n(35995),E=n(49861),O=n(25243),M=(n(63780),n(38511)),Z=n(69912),I=n(31201),D=n(15909),L=n(92562),N=n(78952),F=n(92975),U=n(81753),V=n(25899),H=n(37933),z=n(70630),B=n(70032),G=n(98995),W=n(73117),j=n(45362),q=n(81943),Y=n(23037),X=n(46784),Q=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).facilityIdField=null,r.layerId=null,r.nameField=null,r.siteIdField=null,r.sublayerId=null,r}return(0,c.Z)(n)}(X.wq);(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],Q.prototype,"facilityIdField",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],Q.prototype,"layerId",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],Q.prototype,"nameField",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],Q.prototype,"siteIdField",void 0),(0,v._)([(0,E.Cb)({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],Q.prototype,"sublayerId",void 0);var J=Q=(0,v._)([(0,Z.j)("esri.layers.support.FacilityLayerInfo")],Q),K=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).facilityIdField=null,r.layerId=null,r.levelIdField=null,r.levelNumberField=null,r.longNameField=null,r.shortNameField=null,r.sublayerId=null,r.verticalOrderField=null,r}return(0,c.Z)(n)}(X.wq);(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],K.prototype,"facilityIdField",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],K.prototype,"layerId",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],K.prototype,"levelIdField",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],K.prototype,"levelNumberField",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],K.prototype,"longNameField",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],K.prototype,"shortNameField",void 0),(0,v._)([(0,E.Cb)({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],K.prototype,"sublayerId",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],K.prototype,"verticalOrderField",void 0);var $=K=(0,v._)([(0,Z.j)("esri.layers.support.LevelLayerInfo")],K),ee=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).layerId=null,r.nameField=null,r.siteIdField=null,r.sublayerId=null,r}return(0,c.Z)(n)}(X.wq);(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],ee.prototype,"layerId",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],ee.prototype,"nameField",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],ee.prototype,"siteIdField",void 0),(0,v._)([(0,E.Cb)({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],ee.prototype,"sublayerId",void 0);var te=ee=(0,v._)([(0,Z.j)("esri.layers.support.SiteLayerInfo")],ee),ne=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).levelLayer=null,r.facilityLayer=null,r.siteLayer=null,r}return(0,c.Z)(n)}(X.wq);(0,v._)([(0,E.Cb)({type:$,json:{write:!0}})],ne.prototype,"levelLayer",void 0),(0,v._)([(0,E.Cb)({type:J,json:{write:!0}})],ne.prototype,"facilityLayer",void 0),(0,v._)([(0,E.Cb)({type:te,json:{write:!0}})],ne.prototype,"siteLayer",void 0);var re=ne=(0,v._)([(0,Z.j)("esri.support.MapFloorInfo")],ne),ie=n(11582),ae=n(27135),oe=n(43404),se=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).expression=null,r.returnType="string",r.title=null,r}return(0,c.Z)(n)}((0,ie.J)(X.wq));(0,v._)([(0,E.Cb)({type:String,json:{write:{isRequired:!0}}})],se.prototype,"expression",void 0),(0,v._)([(0,E.Cb)({type:["number","string"],json:{write:!0}})],se.prototype,"returnType",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],se.prototype,"title",void 0);var le=se=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.ExpressionInfo")],se),ue=new oe.X({deviceLocation:"device-location"}),ce=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).filterExpression=null,r.type="device-location",r}return(0,c.Z)(n)}((0,ie.J)(X.wq));(0,v._)([(0,E.Cb)({type:le,json:{write:!0}})],ce.prototype,"filterExpression",void 0),(0,v._)([(0,E.Cb)({type:ue.apiValues,readOnly:!0,json:{type:ue.jsonValues,read:ue.read,write:ue.write}})],ce.prototype,"type",void 0);var he=ce=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.DeviceLocationFeed")],ce),de=n(59486),fe=n(77981),pe=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).geometry=null,r.where=null,r}return(0,c.Z)(n)}((0,ie.J)(X.wq));(0,v._)([(0,E.Cb)({types:de.qM,json:{read:fe.im,write:!0}})],pe.prototype,"geometry",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],pe.prototype,"where",void 0);var ve=pe=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.FeatureFilter")],pe),me=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).layerId=null,r.layerUrl=null,r.type="feature-layer",r}return(0,c.Z)(n)}((0,ie.J)(X.wq));(0,v._)([(0,E.Cb)({type:String,json:{write:{overridePolicy:function(){return{isRequired:null===this.layerUrl}}}}})],me.prototype,"layerId",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:{overridePolicy:function(){return{isRequired:null===this.layerId}}}}})],me.prototype,"layerUrl",void 0),(0,v._)([(0,ae.J)({featureLayer:"feature-layer"},{readOnly:!0})],me.prototype,"type",void 0);var _e=me=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.FeatureLayerSource")],me),ye=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).fenceSource=null,r.filter=null,r.bufferDistance=null,r.type="features",r}return(0,c.Z)(n)}((0,ie.J)(X.wq));(0,v._)([(0,E.Cb)({type:_e,json:{write:{isRequired:!0}}})],ye.prototype,"fenceSource",void 0),(0,v._)([(0,E.Cb)({type:ve,json:{write:!0}})],ye.prototype,"filter",void 0),(0,v._)([(0,E.Cb)({type:Number,json:{write:!0}})],ye.prototype,"bufferDistance",void 0),(0,v._)([(0,ae.J)({features:"features"},{readOnly:!0})],ye.prototype,"type",void 0);var ge=ye=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.FeatureFenceParameters")],ye),be=(n(93169),function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).type="fence",r}return(0,c.Z)(n)}((0,ie.J)(X.wq)));(0,v._)([(0,ae.J)({fence:"fence"},{readOnly:!0})],be.prototype,"type",void 0);var we=be=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.Geotrigger")],be),Ce=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).expressionInfo=null,r.requestedActions=null,r}return(0,c.Z)(n)}((0,ie.J)(X.wq));(0,v._)([(0,E.Cb)({type:le,json:{write:!0}})],Ce.prototype,"expressionInfo",void 0),(0,v._)([(0,E.Cb)({type:[String],json:{write:!0}})],Ce.prototype,"requestedActions",void 0);var xe=Ce=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.GeotriggerNotificationOptions")],Ce),Te=new oe.X({enterContainsAndExitDoesNotContain:"enter-contains-and-exit-does-not-contain",enterContainsAndExitDoesNotIntersect:"enter-contains-and-exit-does-not-intersect",enterIntersectsAndExitDoesNotIntersect:"enter-intersects-and-exit-does-not-intersect"}),Se=new oe.X({useGeometry:"use-geometry",useGeometryWithAccuracy:"use-geometry-with-accuracy"}),ke=new oe.X({enter:"enter",enterOrExit:"enter-or-exit",exit:"exit"}),Pe=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).enterExitRule="enter-contains-and-exit-does-not-intersect",r.feed=null,r.feedAccuracyMode="use-geometry",r.fenceNotificationRule=null,r.fenceParameters=null,r.name=null,r.notificationOptions=null,r.type="fence",r}return(0,c.Z)(n)}(we);(0,v._)([(0,ae.J)(Te)],Pe.prototype,"enterExitRule",void 0),(0,v._)([(0,E.Cb)({type:he,json:{write:{isRequired:!0}}})],Pe.prototype,"feed",void 0),(0,v._)([(0,ae.J)(Se)],Pe.prototype,"feedAccuracyMode",void 0),(0,v._)([(0,E.Cb)({type:ke.apiValues,json:{type:ke.jsonValues,read:ke.read,write:{writer:ke.write,isRequired:!0}}})],Pe.prototype,"fenceNotificationRule",void 0),(0,v._)([(0,E.Cb)({type:ge,json:{write:{isRequired:!0}}})],Pe.prototype,"fenceParameters",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],Pe.prototype,"name",void 0),(0,v._)([(0,E.Cb)({type:xe,json:{write:!0}})],Pe.prototype,"notificationOptions",void 0),(0,v._)([(0,ae.J)({fence:"fence"},{readOnly:!0})],Pe.prototype,"type",void 0);var Re={base:we,key:"type",typeMap:{fence:Pe=(0,v._)([(0,Z.j)("esri.webdoc.geotriggersInfo.FenceGeotrigger")],Pe)}},Ae=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).geotriggers=null,r}return(0,c.Z)(n)}((0,ie.J)(X.wq));(0,v._)([(0,E.Cb)({types:[Re],json:{write:{isRequired:!0}}})],Ae.prototype,"geotriggers",void 0);var Ee,Oe=Ae=(0,v._)([(0,Z.j)("esri.webdoc.GeotriggersInfo")],Ae),Me=n(84652),Ze=Ee=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).activeRange=null,r.currentRangeExtent=null,r.fullRangeExtent=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new Ee((0,Me.d9)({activeRange:this.activeRange,currentRangeExtent:this.currentRangeExtent,fullRangeExtent:this.fullRangeExtent}))}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:String,nonNullable:!0,json:{read:{source:"activeRangeName"},write:{target:"activeRangeName",isRequired:!0}}})],Ze.prototype,"activeRange",void 0),(0,v._)([(0,E.Cb)({type:[Number],json:{write:!0}})],Ze.prototype,"currentRangeExtent",void 0),(0,v._)([(0,E.Cb)({type:[Number],json:{write:!0}})],Ze.prototype,"fullRangeExtent",void 0);var Ie=Ze=Ee=(0,v._)([(0,Z.j)("esri.webdoc.RangeInfo")],Ze),De=n(54931),Le={width:600,height:400},Ne=1.5;function Fe(e,t){var n=t=t||Le,r=n.width,i=n.height,a=r/i;return a<Ne?i=r/Ne:a>Ne&&(r=i*Ne),r>e.width&&(i*=e.width/r,r=e.width),i>e.height&&(r*=e.height/i,i=e.height),{width:Math.round(r),height:Math.round(i)}}var Ue=n(41190);function Ve(e){return{enabled:!(null===e||void 0===e||!e.length)}}var He,ze=n(85249),Be=He=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).exactMatch=!1,r.name=null,r.type=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new He({exactMatch:this.exactMatch,type:this.type,name:this.name})}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:Boolean,json:{write:!0}})],Be.prototype,"exactMatch",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],Be.prototype,"name",void 0),(0,v._)([(0,ae.J)(ze.v)],Be.prototype,"type",void 0);var Ge,We=Be=He=(0,v._)([(0,Z.j)("esri.webdoc.applicationProperties.SearchLayerField")],Be),je=Ge=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).field=null,r.id=null,r.subLayer=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new Ge((0,Me.d9)({field:this.field,id:this.id,subLayer:this.subLayer}))}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:We,json:{write:{isRequired:!0}}})],je.prototype,"field",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:{isRequired:!0}}})],je.prototype,"id",void 0),(0,v._)([(0,E.Cb)({type:O.z8,json:{write:!0}})],je.prototype,"subLayer",void 0);var qe,Ye=je=Ge=(0,v._)([(0,Z.j)("esri.webdoc.applicationProperties.SearchLayer")],je),Xe=qe=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).exactMatch=!1,r.name=null,r.type=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new qe({exactMatch:this.exactMatch,type:this.type,name:this.name})}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:Boolean,json:{write:!0}})],Xe.prototype,"exactMatch",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],Xe.prototype,"name",void 0),(0,v._)([(0,ae.J)(ze.v)],Xe.prototype,"type",void 0);var Qe,Je=Xe=qe=(0,v._)([(0,Z.j)("esri.webdoc.applicationProperties.SearchTableField")],Xe),Ke=Qe=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).field=null,r.id=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new Qe((0,Me.d9)({field:this.field,id:this.id}))}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:Je,json:{write:{isRequired:!0}}})],Ke.prototype,"field",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:{isRequired:!0}}})],Ke.prototype,"id",void 0);var $e,et=Ke=Qe=(0,v._)([(0,Z.j)("esri.webdoc.applicationProperties.SearchTable")],Ke),tt=g.Z.ofType(Ye),nt=g.Z.ofType(et),rt=$e=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).addressSearchEnabled=!0,r.enabled=!0,r.hintText=null,r.layers=new tt,r.tables=new nt,r}return(0,c.Z)(n,[{key:"readAddressSearchEnabled",value:function(e){return!e}},{key:"writeAddressSearchEnabled",value:function(e,t,n){t[n]=!e}},{key:"clone",value:function(){return new $e((0,Me.d9)({addressSearchEnabled:this.addressSearchEnabled,enabled:this.enabled,hintText:this.hintText,layers:this.layers,tables:this.tables}))}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:Boolean,nonNullable:!0,json:{read:{source:"disablePlaceFinder"},write:{target:"disablePlaceFinder",isRequired:!0},origins:{"web-scene":{read:!1,write:!1}}}})],rt.prototype,"addressSearchEnabled",void 0),(0,v._)([(0,M.r)("addressSearchEnabled")],rt.prototype,"readAddressSearchEnabled",null),(0,v._)([(0,I.c)("addressSearchEnabled")],rt.prototype,"writeAddressSearchEnabled",null),(0,v._)([(0,E.Cb)({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-map":{write:{isRequired:!0}},"web-scene":{default:!0,write:!0}}}})],rt.prototype,"enabled",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:!0}})],rt.prototype,"hintText",void 0),(0,v._)([(0,E.Cb)({type:tt,json:{write:{overridePolicy:Ve},origins:{"web-scene":{write:{isRequired:!0}}}}})],rt.prototype,"layers",void 0),(0,v._)([(0,E.Cb)({type:nt,json:{read:!0,write:{overridePolicy:Ve}}})],rt.prototype,"tables",void 0);var it,at=rt=$e=(0,v._)([(0,Z.j)("esri.webdoc.applicationProperties.Search")],rt),ot=it=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).search=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new it((0,Me.d9)({search:this.search}))}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:at,json:{write:!0}})],ot.prototype,"search",void 0);var st,lt=ot=it=(0,v._)([(0,Z.j)("esri.webdoc.applicationProperties.Viewing")],ot),ut=st=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).editing=null,r.offline=null,r.viewing=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new st((0,Me.d9)({editing:this.editing,offline:this.offline,viewing:this.viewing}))}}]),n}(X.wq);(0,v._)([(0,E.Cb)({json:{write:!0}})],ut.prototype,"editing",void 0),(0,v._)([(0,E.Cb)({json:{write:!0}})],ut.prototype,"offline",void 0),(0,v._)([(0,E.Cb)({type:lt,json:{write:!0}})],ut.prototype,"viewing",void 0);var ct,ht,dt=ut=st=(0,v._)([(0,Z.j)("esri.webmap.ApplicationProperties")],ut),ft=n(62044),pt=n(79056),vt=n(89125),mt=ct=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(){var e;return(0,u.Z)(this,n),(e=t.apply(this,arguments)).url="",e}return(0,c.Z)(n,[{key:"destroy",value:function(){this.url=""}},{key:"clone",value:function(){return new ct({url:this.url})}}]),n}(X.wq);(0,v._)([(0,E.Cb)({type:String,json:{write:{isRequired:!0}}})],mt.prototype,"url",void 0),mt=ct=(0,v._)([(0,Z.j)("esri.webdoc.support.SlideThumbnail")],mt);var _t=ht=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).name=null,r.thumbnail=new mt,r.timeExtent=null,r}return(0,c.Z)(n,[{key:"castThumbnail",value:function(e){return"string"==typeof e?new mt({url:e}):(0,O.se)(mt,e)}},{key:"viewpoint",set:function(e){var t=e.targetGeometry,n=e.scale;(0,T.pC)(t)&&"point"===t.type&&(0,T.Wi)(n)&&x.Z.getLogger(this.declaredClass).warn("Bookmark.viewpoint should include 'scale' when its targetGeometry is a point.",e),this._set("viewpoint",e)}},{key:"readViewpoint",value:function(e,t){var n=t.extent,r=t.viewpoint;return y.Z.fromJSON(r||{targetGeometry:n})}},{key:"writeViewpoint",value:function(e,t,n,r){if(e){var i=e.targetGeometry;if((0,T.pC)(i)&&"extent"!==i.type){var a="Bookmark.viewpoint cannot be written to JSON when the viewpoint's targetGeometry is not an extent.";null!==r&&void 0!==r&&r.messages?r.messages.push(new b.Z("property:unsupported",a)):x.Z.getLogger(this.declaredClass).error(a)}else(0,T.pC)(i)&&(t.extent=i.toJSON()),t[n]=e.toJSON()}}},{key:"clone",value:function(){return new ht((0,Me.d9)({name:this.name,thumbnail:this.thumbnail,timeExtent:this.timeExtent,viewpoint:this.viewpoint}))}}]),n}((0,pt.IG)(X.wq));(0,v._)([(0,E.Cb)({type:String,nonNullable:!0,json:{write:{isRequired:!0}}})],_t.prototype,"name",void 0),(0,v._)([(0,E.Cb)({type:mt,json:{write:{overridePolicy:function(e){return{enabled:!(!e||!e.url)}}}}})],_t.prototype,"thumbnail",void 0),(0,v._)([(0,vt.p)("thumbnail")],_t.prototype,"castThumbnail",null),(0,v._)([(0,E.Cb)({type:ft.Z,json:{write:!0}})],_t.prototype,"timeExtent",void 0),(0,v._)([(0,E.Cb)({type:y.Z,nonNullable:!0,json:{write:!0}})],_t.prototype,"viewpoint",null),(0,v._)([(0,M.r)("viewpoint",["extent","viewpoint"])],_t.prototype,"readViewpoint",null),(0,v._)([(0,I.c)("viewpoint")],_t.prototype,"writeViewpoint",null);var yt,gt=_t=ht=(0,v._)([(0,Z.j)("esri.webmap.Bookmark")],_t),bt=n(31319),wt=n(53042),Ct=yt=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).background=null,r.rangeInfo=null,r.spatialReference=null,r.viewpoint=null,r}return(0,c.Z)(n,[{key:"clone",value:function(){return new yt((0,Me.d9)({background:this.background,rangeInfo:this.rangeInfo,spatialReference:this.spatialReference,viewpoint:this.viewpoint}))}}]),n}(bt.Z);(0,v._)([(0,E.Cb)({type:wt.Z})],Ct.prototype,"background",void 0),(0,v._)([(0,E.Cb)({type:Ie})],Ct.prototype,"rangeInfo",void 0),(0,v._)([(0,E.Cb)({type:N.Z})],Ct.prototype,"spatialReference",void 0),(0,v._)([(0,E.Cb)({type:y.Z})],Ct.prototype,"viewpoint",void 0);var xt=Ct=yt=(0,v._)([(0,Z.j)("esri.webmap.InitialViewProperties")],Ct),Tt=function(e){(0,f.Z)(n,e);var t=(0,p.Z)(n);function n(e,r){return(0,u.Z)(this,n),t.call(this,e,r,"webmap")}return(0,c.Z)(n)}(n(49901).G),St=new Tt(2,27),kt="Web Map",Pt=g.Z.ofType(gt),Rt=g.Z.ofType(z.default),At=new Map;At.set("image/jpeg","jpeg"),At.set("image/jpg","jpg"),At.set("image/png","png"),At.set("image/gif","gif");var Et=W.Kz.JSAPI,Ot="CollectorDisabled",Mt="Collector",Zt="Data Editing",It="OfflineDisabled",Dt="Offline",Lt="Workforce Project",Nt="Workforce Worker",Ft="Workforce Dispatcher",Ut=W.Kz.DEVELOPER_BASEMAP,Vt="UtilityNetwork",Ht=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((function(e){return e.toLowerCase()})),zt=function(e){(0,f.Z)(v,e);var t=(0,p.Z)(v);function v(e){var n;return(0,u.Z)(this,v),(n=t.call(this,e))._isAuthoringAppSetByUser=!1,n._isAuthoringAppVersionSetByUser=!1,n._thumbnailFilename=null,n._updateFromPromise=null,n._resourceReferences={portalItem:null,paths:[]},n.applicationProperties=null,n.bookmarks=new Pt,n.floorInfo=null,n.geotriggersInfo=null,n.initialViewProperties=new xt,n.portalItem=null,n.presentation=null,n.sourceVersion=null,n.widgets=null,n.utilityNetworks=null,n.authoringApp=n.authoringAppVersion=null,n._isAuthoringAppSetByUser=n._isAuthoringAppVersionSetByUser=!1,n}return(0,c.Z)(v,[{key:"destroy",value:function(){var e=this.portalItem;this.portalItem=null,null===e||void 0===e||e.destroy()}},{key:"initialize",value:function(){var e=this;if(this.when().catch((function(t){x.Z.getLogger(e.declaredClass).error("#load()","Failed to load web map",t)})),this.resourceInfo){var t;try{t=this._validateJSON(this.resourceInfo)}catch(Ve){return void this.addResolvingPromise(Promise.reject(Ve))}this.read(t)}}},{key:"authoringApp",set:function(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}},{key:"writeAuthoringApp",value:function(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp=Et}},{key:"authoringAppVersion",set:function(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}},{key:"writeAuthoringAppVersion",value:function(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=m.i8}},{key:"readInitialViewProperties",value:function(e,t){var n,r=new xt;t.background&&(r.background=wt.Z.fromJSON(t.background));var i=null===(n=t.initialState)||void 0===n?void 0:n.viewpoint;return i&&(i.rotation&&Tt.parse(t.version||"","webmap").lessThan(2,20)&&"ArcGIS Pro"===t.authoringApp&&(i.rotation*=-1),r.viewpoint=y.Z.fromJSON(i)),t.mapRangeInfo&&(r.rangeInfo=Ie.fromJSON(t.mapRangeInfo)),t.spatialReference&&(r.spatialReference=N.Z.fromJSON(t.spatialReference)),r}},{key:"writeInitialViewProperties",value:function(e,t,n,r){if(e){var i=e.background;i&&i.color&&(t.background=i.write({},r)),e.viewpoint&&(t.initialState={viewpoint:e.viewpoint.write({},r)}),e.rangeInfo&&(t.mapRangeInfo=e.rangeInfo.toJSON(r)),e.spatialReference&&(t.spatialReference=e.spatialReference.write({},r))}}},{key:"writeLayers",value:function(e,t,n,r){t[n]=this._writeLayers(e,r,"operational-layers")}},{key:"readSourceVersion",value:function(e,t){var n=t.version.split("."),r=(0,l.Z)(n,2),i=r[0],a=r[1];return new Tt(parseInt(i,10),parseInt(a,10))}},{key:"writeSourceVersion",value:function(e,t,n){t[n]="".concat(St.major,".").concat(St.minor)}},{key:"writeTables",value:function(e,t,n,r){var i=this._writeLayers(e,r,"tables");i.length&&(t[n]=i)}},{key:"thumbnailUrl",get:function(){return this.portalItem&&this.portalItem.thumbnailUrl||null},set:function(e){e?(this._override("thumbnailUrl",e),this._thumbnailFilename=this._generateCustomThumbnailFilename(e)):this._clearThumbnailOverride()}},{key:"load",value:function(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}},{key:"loadAll",value:function(){var e=this;return(0,C.G)(this,(function(t){t(e.ground,e.basemap,e.layers,e.tables)}))}},{key:"read",value:function(e,t){var n=this;t=(0,s.Z)((0,s.Z)({},t),{},{origin:"web-map"});var r=this._getAuthoringPropsState();(0,L.$)(this,e,(function(t){return(0,h.Z)((0,d.Z)(v.prototype),"read",n).call(n,e,t)}),t),this._restoreAuthoringPropsFromState(r)}},{key:"write",value:function(e,t){if("loaded"!==this.loadStatus){var n=new b.Z("webmap:not-loaded","Web map must be loaded before it can be serialized");throw x.Z.getLogger(this.declaredClass).error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),n}return this._removeDanglingLayerRefs(),t=(0,s.Z)((0,s.Z)({},t),{},{origin:"web-map",restrictedWebMapWriting:!0,webmap:this}),(0,h.Z)((0,d.Z)(v.prototype),"write",this).call(this,e,t)}},{key:"save",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var r,i,o,s,l,u=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},this._validateItem(),r=n.e(9634).then(n.bind(n,9634)),e.next=4,this._updateFromPromise;case 4:return e.next=6,this.load();case 6:return e.next=8,this._loadLayerContainers();case 8:return e.next=10,this._beforeSave();case 10:return e.next=12,this._validateMap();case 12:return i=this.portalItem,o=(0,A.mN)(i.itemUrl),s={origin:"web-map",messages:[],writtenProperties:[],url:o,portal:i.portal||B.Z.getDefault(),portalItem:i,verifyItemRelativeUrls:o?{rootPath:o.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},l=this.write({},s),e.next=15,Promise.all(s.resources.pendingOperations);case 15:return this._validateJSONForWriting(s,t),e.next=18,this._updateItemProperties(i);case 18:return e.next=20,this._updateItem(i,l,s);case 20:return e.next=22,Promise.all([this._updateItemThumbnail(),r.then((function(e){return(0,e.saveResources)(u._resourceReferences,s,null)}))]);case 22:return e.abrupt("return",i);case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"saveAs",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,r){var i,o,s,l,u,c=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=r||{},i=this._getPortalItem(t),o=n.e(9634).then(n.bind(n,9634)),e.next=4,this._updateFromPromise;case 4:return e.next=6,this.load();case 6:return e.next=8,this._loadLayerContainers();case 8:return e.next=10,this._beforeSave();case 10:return e.next=12,this._validateMap();case 12:return s={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:i.portal,portalItem:i,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},l=this.write({},s),e.next=15,Promise.all(s.resources.pendingOperations);case 15:return this._validateJSONForWriting(s,r),e.next=18,this._updateItemPropertiesForSaveAs(i);case 18:return u=this._getThumbnailState(),e.next=21,this._createItem(i,l,s,r);case 21:if(e.t0=e.sent,!e.t0){e.next=24;break}this._resourceReferences.portalItem=i;case 24:return this._restoreThumbnailFromState(u),e.next=27,Promise.all([this._updateItemThumbnail(),o.then((function(e){return(0,e.saveResources)(c._resourceReferences,s,null)}))]);case 27:return e.abrupt("return",i);case 28:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"updateFrom",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._updateFromInternal(t,n),this._updateFromPromise=r,e.next=4,r;case 4:r===this._updateFromPromise&&(this._updateFromPromise=null);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getLayerJSONFromResourceInfo",value:function(e){var t,n,r,a,o=this.resourceInfo;return this._collectAllLayersJSON([].concat((0,i.Z)((null===o||void 0===o||null===(t=o.baseMap)||void 0===t?void 0:t.baseMapLayers)||[]),(0,i.Z)((null===o||void 0===o?void 0:o.operationalLayers)||[]),(0,i.Z)((null===(n=this.basemap)||void 0===n||null===(r=n.resourceInfo)||void 0===r||null===(a=r.data)||void 0===a?void 0:a.baseMapLayers)||[]))).find((function(t){return t.id===e.id}))}},{key:"_collectAllLayersJSON",value:function(e){var t=this;return e.reduce((function(e,n){return e.push(n),"GroupLayer"===n.layerType&&(e=e.concat(t._collectAllLayersJSON(n.layers||[]))),e}),[])}},{key:"_writeLayers",value:function(e,t,n){var r=this;return t=(0,s.Z)((0,s.Z)({},t),{},{layerContainerType:n}),e.map((function(e){return(0,T.Wg)((0,Ue.Nw)(e,"tables"===n?null:r.getLayerJSONFromResourceInfo(e),t))})).filter(Boolean).toArray()}},{key:"_loadFromSource",value:function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-map"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):Promise.resolve()}},{key:"_loadFromItem",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.load().catch((function(e){throw new b.Z("webmap:load-portal-item","Failed to load portal item",{error:e})}));case 2:if("Web Map"===t.type){e.next=4;break}throw new b.Z("webmap:invalid-portal-item","Invalid portal item type '".concat(t.type,"', expected 'Web Map'"),{type:t.type});case 4:return e.next=6,t.fetchData();case 6:return r=e.sent,this.resourceInfo=r,i={origin:"web-map",url:(0,A.mN)(t.itemUrl),portal:t.portal||B.Z.getDefault(),portalItem:t,readResourcePaths:[]},e.next=11,this._readAndLoadFromJSON(r,i);case 11:return this._resourceReferences={portalItem:t,paths:null!==(n=i.readResourcePaths)&&void 0!==n?n:[]},e.abrupt("return",this._computeInitialViewpoint());case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_readAndLoadFromJSON",value:function(e,t){var n=this._validateJSON(e);return this.read(n,t),this._loadFromJSON(n,t)}},{key:"_validateJSON",value:function(e){var t=Tt.parse(e.version||"","webmap");return St.validate(t),e.version="".concat(t.major,".").concat(t.minor),e}},{key:"_loadFromJSON",value:function(e,t){var r=this,i={context:(0,s.Z)((0,s.Z)({},t),{},{layerContainerType:"operational-layers"})};return this.portalItem&&(i.context.portal=this.portalItem.portal||B.Z.getDefault()),Promise.all([n.e(46727),n.e(43139),n.e(20519)]).then(n.bind(n,20519)).then((function(t){var n=t.populateOperationalLayers,a=[],o=e.operationalLayers;o&&o.length&&a.push(n(r.layers,o,i));var l=(0,s.Z)((0,s.Z)({},i),{},{context:(0,s.Z)((0,s.Z)({},i.context),{},{layerContainerType:"tables"}),defaultLayerType:"ArcGISFeatureLayer"}),u=e.tables;return u&&u.length&&a.push(n(r.tables,u,l)),(0,P.as)(a).then((function(){}))}))}},{key:"_computeInitialViewpoint",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,n,r,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.initialViewProperties,!(null===(t=r)||void 0===t||null===(n=t.viewpoint)||void 0===n?void 0:n.targetGeometry)){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,this._getExtentFromItem();case 6:(i=e.sent)&&((r=r?r.clone():new xt).viewpoint=new y.Z,r.viewpoint.targetGeometry=i,this.initialViewProperties=r);case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getExtentFromItem",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,r,i,o,s=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=null===(t=this.initialViewProperties)||void 0===t?void 0:t.spatialReference,o=null===(r=this.portalItem)||void 0===r?void 0:r.extent,!i||!o){e.next=9;break}if(!i.isWGS84){e.next=4;break}return e.abrupt("return",o.clone());case 4:if(!i.isWebMercator){e.next=6;break}return e.abrupt("return",(0,U.$)(o));case 6:return e.next=8,Promise.resolve().then(n.bind(n,67387));case 8:return e.abrupt("return",e.sent.getGeometryServiceURL(this.portalItem).then((function(e){var t=new q.Z;return t.geometries=[o],t.outSpatialReference=i,(0,j.i)(e,t)})).then((function(e){return e[0]})).catch((function(e){return x.Z.getLogger(s.declaredClass).error("Error projecting item's extent:",e),null})));case 9:return e.abrupt("return",null);case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_removeDanglingLayerRefs",value:function(){var e=this,t=this.applicationProperties,n=t&&t.viewing&&t.viewing.search,r=function(t){return e.allLayers.some((function(e){return e.id===t}))};n&&n.layers&&(n.layers=n.layers.filter((function(e){return r(e.id)}))),n&&n.tables&&(n.tables=n.tables.filter((function(t){return e.tables.some((function(e){return e.id===t.id}))})));var i=t&&t.editing&&t.editing.locationTracking;i&&i.info&&!r(i.info.layerId)&&(t.editing=null);var a=this.presentation&&this.presentation.slides;a&&a.forEach((function(e){e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((function(e){return r(e.id)})))}))}},{key:"_validateMap",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,n,r=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(t=this.basemap)&&void 0!==t&&t.baseLayers.length){e.next=2;break}throw new b.Z("webmap:save","Map does not have a valid basemap with a base layer.");case 2:return n=null,e.next=5,(0,R.N1)((function(){var e=(0,Y.Us)(r.initialViewProperties,r.basemap);return n=e.spatialReference,!e.updating}));case 5:if((0,F.fS)(n,this.initialViewProperties.spatialReference)){e.next=7;break}throw new b.Z("webmap:save","The spatial reference of the basemap is not compatible with the one from the map.",{expected:this.initialViewProperties.spatialReference,actual:n});case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_validateItem",value:function(){if(!this.portalItem)throw x.Z.getLogger(this.declaredClass).error("save: requires the portalItem property to be set"),new b.Z("webmap:portal-item-not-set","Portal item to save to has not been set on the WebMap");this._validateItemType(this.portalItem)}},{key:"_validateItemType",value:function(e){if(e.type!==kt)throw new b.Z("webmap:portal-item-wrong-type",'Portal item needs to have type "'.concat(kt,'"'))}},{key:"_loadLayerContainers",value:function(){var e=[];return this.basemap&&e.push(this.basemap.load()),this.ground&&e.push(this.ground.load()),(0,P.as)(e).then((function(){}))}},{key:"_beforeSave",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,n,i,o,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=(0,r.Z)(this.allLayers);try{for(n.s();!(i=n.n()).done;)"beforeSave"in(o=i.value)&&"function"==typeof o.beforeSave&&(s=o.beforeSave())&&t.push(s)}catch(a){n.e(a)}finally{n.f()}return e.next=5,(0,P.as)(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_loadAllLayers",value:function(){var e=this._getAllLayersAndTables().map((function(e){return e.load()}));return(0,P.as)(e).then((function(){}))}},{key:"_getAllLayersAndTables",value:function(){return this.allLayers.concat(this.allTables)}},{key:"_validateJSONForWriting",value:function(e,t){var n=(e.messages?e.messages:[]).filter((function(e){return"error"===e.type})).map((function(e){return new b.Z(e.name,e.message,e.details)}));if(e.blockedRelativeUrls&&(n=n.concat(e.blockedRelativeUrls.map((function(e){return new b.Z("url:unsupported","Relative url '".concat(e,"' is not supported in Web Map"))})))),t.ignoreUnsupported&&(n=n.filter((function(e){return"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name}))),n.length>0)throw new b.Z("webmap:save","Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:n})}},{key:"_updateItemProperties",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getWGS84Extent(this.initialViewProperties.viewpoint.targetGeometry);case 2:return t.extent=e.sent,e.next=5,this._updateTypeKeywords(t);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateItemPropertiesForSaveAs",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,W.ck)(t,Ot),(0,W.ck)(t,"FieldMapsDisabled"),(0,W.ck)(t,W.Kz.METADATA),(0,W.ck)(t,It),(0,W.ck)(t,"Offline Map Areas"),(0,W.ck)(t,Ft),(0,W.ck)(t,Lt),(0,W.ck)(t,Nt),e.next=10,this._updateItemProperties(t);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getWGS84Extent",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,i,o,s,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=t.clone().normalize()).length>1){o=(0,r.Z)(n);try{for(o.s();!(s=o.n()).done;)l=s.value,i?l.width>i.width&&(i=l):i=l}catch(a){o.e(a)}finally{o.f()}}else i=n[0];return e.abrupt("return",this._projectToWGS84(i));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_projectToWGS84",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var r,i,o,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=t.spatialReference).isWGS84){e.next=3;break}return e.abrupt("return",t.clone());case 3:if(!r.isWebMercator){e.next=5;break}return e.abrupt("return",(0,U.Sx)(t));case 5:return e.next=7,Promise.resolve().then(n.bind(n,67387));case 7:return i=e.sent,e.next=10,i.getGeometryServiceURL(this.portalItem);case 10:return o=e.sent,(s=new q.Z).geometries=[t],s.outSpatialReference=N.Z.WGS84,e.next=15,(0,j.i)(o,s);case 15:return e.abrupt("return",e.sent[0]);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateTypeKeywords",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,W.qj)(t,Et),e.next=3,this._loadAllLayers();case 3:this._evalCollectorKeyword(t),this._evalDataEditingKeyword(t),this._evalOfflineKeyword(t),this._evalDeveloperBasemapKeyword(t),this._evalUtilityNetworkKeyword(t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter((function(e,t,n){return n.indexOf(e)===t})));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_evalCollectorKeyword",value:function(e){(0,W._$)(e,Ot)||(0,W._$)(e,Lt)||(0,W._$)(e,Nt)||(0,W._$)(e,Ft)||!this._hasEditableFeatureLayer()?(0,W.ck)(e,Mt):(0,W.qj)(e,Mt)}},{key:"_evalDataEditingKeyword",value:function(e){this._hasEditableFeatureLayer()?(0,W.qj)(e,Zt):(0,W.ck)(e,Zt)}},{key:"_evalOfflineKeyword",value:function(e){!(0,W._$)(e,It)&&this._isOfflineCapableMap()?(0,W.qj)(e,Dt):(0,W.ck)(e,Dt)}},{key:"_evalDeveloperBasemapKeyword",value:function(e){(0,Y.zb)(this.basemap)?(0,W.qj)(e,Ut):(0,W.ck)(e,Ut)}},{key:"_evalUtilityNetworkKeyword",value:function(e){var t;null!==(t=this.utilityNetworks)&&void 0!==t&&t.length?(0,W.qj)(e,Vt):(0,W.ck)(e,Vt)}},{key:"_hasEditableFeatureLayer",value:function(){return this._getAllLayersAndTables().some((function(e){return e.loaded&&(0,H.y2)(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled}))}},{key:"_isOfflineCapableMap",value:function(){var e=this;return this._getAllLayersAndTables().filter((function(e){return"group"!==e.type})).every((function(t){return t.loaded&&e._isOfflineCapableLayer(t)}))}},{key:"_isFeatureCollectionLike",value:function(e){return(0,H.rQ)(e)||"map-notes"===e.type||"route"===e.type}},{key:"_isOfflineCapableLayer",value:function(e){return(0,H.y2)(e)&&e.capabilities.operations.supportsSync||this._isFeatureCollectionLike(e)&&!e.portalItem||("tile"===e.type||"vector-tile"===e.type)&&(e.capabilities.operations.supportsExportTiles||this._isExportableAGOLTileLayer(e)||(0,Y.aL)(e))&&e.spatialReference.equals(this.initialViewProperties.spatialReference)}},{key:"_isExportableAGOLTileLayer",value:function(e){return"tile"===e.type&&(0,V.h3)(e.url)&&Ht.some((function(t){var n;return null===(n=e.url)||void 0===n?void 0:n.toLowerCase().includes("/"+t+"/")}))}},{key:"_updateItem",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.update({data:n});case 2:this._syncUpInstanceWithItem(t,n,r);case 3:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_createItem",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i){var o,s,l,u,c,h,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.portalItem,s={item:o,authenticated:!(null===o||void 0===o||!o.id||!o.portal.user)},l=t.portal,e.next=3,l.signIn();case 3:return e.next=5,this._isCopyAllowed(s,l);case 5:if(u=e.sent,c=u.copyAllowed,h=u.itemReloaded,s.authenticated||(s.authenticated=h),c){e.next=10;break}throw new b.Z("webmap:save-as-copy-not-allowed","Owner of this map does not allow others to save a copy");case 10:return e.next=12,this._initializeNewItem(t,s,n,i);case 12:return d=e.sent,e.abrupt("return",(this.portalItem=t,this._syncUpInstanceWithItem(t,n,r),d));case 14:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"_isCopyAllowed",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.item,o=t.authenticated,null===i||void 0===i||!i.id||null===(r=i.typeKeywords)||void 0===r||!r.includes("useOnly")){e.next=14;break}if(i.portal.portalHostname===n.portalHostname){e.next=6;break}e.t1={copyAllowed:!1,itemReloaded:!1},e.next=11;break;case 6:if(e.t2=o,e.t2){e.next=10;break}return e.next=10,i.reload();case 10:e.t1={copyAllowed:"admin"===i.itemControl||"update"===i.itemControl,itemReloaded:!0};case 11:e.t0=e.t1,e.next=15;break;case 14:e.t0={copyAllowed:!0,itemReloaded:!1};case 15:return e.abrupt("return",e.t0);case 16:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_initializeNewItem",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i){var o,s,l,u,c,h,d,f,p,v,m;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.portal,l=n.item,u=n.authenticated,c=i.folder,h=i.copyAllResources,d=!1,e.t0=h&&null!==l&&void 0!==l&&l.id&&(0,A.Am)(l.portal.url,s.url),!e.t0){e.next=9;break}if(e.t1=u,e.t1){e.next=8;break}return e.next=8,l.reload();case 8:e.t0=l.isOrgItem;case 9:if(!e.t0){e.next=15;break}return e.next=12,l.fetchResources();case 12:f=e.sent,p=f.total,d=!!p;case 15:if(!d){e.next=28;break}return e.next=18,l.copy({copyResources:"all",folder:c});case 18:return v=e.sent,t.id=v.id,t.portal=v.portal,m=t.toJSON(),e.next=23,t.load();case 23:return t.read(m),e.next=26,t.update({data:r});case 26:e.next=30;break;case 28:return e.next=30,null===(o=s.user)||void 0===o?void 0:o.addItem({item:t,folder:c,data:r});case 30:return e.abrupt("return",d);case 31:case"end":return e.stop()}}),e)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"_syncUpInstanceWithItem",value:function(e,t,n){S.w.prototype.read.call(this,{version:t.version,authoringApp:t.authoringApp,authoringAppVersion:t.authoringAppVersion},{origin:"web-map",ignoreDefaults:!0,url:e.itemUrl&&(0,A.mN)(e.itemUrl)}),(0,D.D)(n),this.resourceInfo=t}},{key:"_updateItemThumbnail",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.thumbnailUrl&&this._isOverridden("thumbnailUrl"),!e.t0){e.next=5;break}return e.next=4,null===(t=this.portalItem)||void 0===t?void 0:t.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename});case 4:this._clearThumbnailOverride();case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_getPortalItem",value:function(e){var t=G.default.from(e);return t.id&&((t=t.clone()).id=null),t.type||(t.type=kt),t.portal||(t.portal=B.Z.getDefault()),this._validateItemType(t),t}},{key:"_updateFromInternal",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var i,o,s,l,u,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=n||{},e.next=3,(0,R.N1)((function(){return t.ready}));case 3:if(this._updateInitialViewProperties(t,n),t.map!==this){e.next=7;break}i=(0,r.Z)(t.allLayerViews);try{for(i.s();!(o=i.n()).done;)for(s=o.value,l=0,u=["visible","featureEffect"];l<u.length;l++)(c=u[l])in s&&c in s.layer&&s._isOverridden(c)&&(s.layer[c]=s[c])}catch(a){i.e(a)}finally{i.f()}case 7:return e.next=9,this._updateThumbnailUrl(t,n);case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_updateInitialViewProperties",value:function(e,t){var n,i;if(t.backgroundExcluded||(this.initialViewProperties.background=null===(n=e.background)||void 0===n?void 0:n.clone()),this.initialViewProperties.spatialReference=null===(i=e.spatialReference)||void 0===i?void 0:i.clone(),t.viewpointExcluded||(this.initialViewProperties.viewpoint=new y.Z({rotation:e.rotation,scale:t.scalePreserved?e.scale:null,targetGeometry:this._getViewExtent(e)})),!t.widgetsExcluded){var a,o=(0,r.Z)(e.persistableViewModels);try{for(o.s();!(a=o.n()).done;){a.value.updateWebDocument(this)}}catch(s){o.e(s)}finally{o.f()}}}},{key:"_getViewExtent",value:function(e){var t=e.center.clone().normalize(),n=e.extent.clone(),r=n.width/2;return n.xmin=t.x-r,n.xmax=t.x+r,n}},{key:"_updateThumbnailUrl",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.thumbnailExcluded){e.next=2;break}return e.abrupt("return");case 2:return r=Fe(t,n.thumbnailSize),e.next=5,t.takeScreenshot({format:"png",width:r.width,height:r.height});case 5:i=e.sent,this._setAutoGeneratedThumbnail(i.dataUrl);case 7:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_setAutoGeneratedThumbnail",value:function(e){this.thumbnailUrl=e,this._thumbnailFilename=null}},{key:"_clearThumbnailOverride",value:function(){this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),this._thumbnailFilename=null}},{key:"_generateCustomThumbnailFilename",value:function(e){if((0,A.HK)(e)){var t=(0,A.sJ)(e),n=t&&t.mediaType,r=n&&At.get(n.toLowerCase())||null,i="thumbnail".concat(Date.now());return r?"".concat(i,".").concat(r):i}return null}},{key:"_getThumbnailState",value:function(){var e=this.thumbnailUrl;return e&&(e=this._isOverridden("thumbnailUrl")?e:(0,A.ZN)(e,"w","8192")),{thumbnailUrl:e,filename:this._thumbnailFilename}}},{key:"_restoreThumbnailFromState",value:function(e){this.thumbnailUrl=e.thumbnailUrl,this._thumbnailFilename=e.filename}},{key:"_getAuthoringPropsState",value:function(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}}},{key:"_restoreAuthoringPropsFromState",value:function(e){e.isAuthoringAppSetByUser?this.authoringApp=e.authoringApp:this._isAuthoringAppSetByUser=!1,e.isAuthoringAppVersionSetByUser?this.authoringAppVersion=e.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1}}],[{key:"fromJSON",value:function(e){var t=e;if(!t)throw new b.Z("webmap:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:t})}}]),v}((0,S.R)(w.Z.LoadableMixin((0,k.v)(_.Z))));zt.VERSION=St,(0,v._)([(0,E.Cb)({type:dt,json:{write:!0}})],zt.prototype,"applicationProperties",void 0),(0,v._)([(0,E.Cb)({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],zt.prototype,"authoringApp",null),(0,v._)([(0,I.c)("authoringApp")],zt.prototype,"writeAuthoringApp",null),(0,v._)([(0,E.Cb)({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],zt.prototype,"authoringAppVersion",null),(0,v._)([(0,I.c)("authoringAppVersion")],zt.prototype,"writeAuthoringAppVersion",null),(0,v._)([(0,E.Cb)({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],zt.prototype,"basemap",void 0),(0,v._)([(0,E.Cb)({type:Pt,json:{write:{overridePolicy:function(e){return{enabled:!!(e&&e.length>0),ignoreOrigin:!0}}}}})],zt.prototype,"bookmarks",void 0),(0,v._)([(0,E.Cb)({type:re,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],zt.prototype,"floorInfo",void 0),(0,v._)([(0,E.Cb)({type:Oe,json:{write:!0}})],zt.prototype,"geotriggersInfo",void 0),(0,v._)([(0,E.Cb)({type:xt,nonNullable:!0,json:{read:{source:["background","initialState.viewpoint","mapRangeInfo","spatialReference"]},write:{ignoreOrigin:!0,target:{background:{type:wt.Z},"initialState.viewpoint":{type:y.Z},mapRangeInfo:{type:Ie},spatialReference:{type:N.Z}}}}})],zt.prototype,"initialViewProperties",void 0),(0,v._)([(0,M.r)("initialViewProperties")],zt.prototype,"readInitialViewProperties",null),(0,v._)([(0,I.c)("initialViewProperties")],zt.prototype,"writeInitialViewProperties",null),(0,v._)([(0,E.Cb)({json:{read:!1,write:{target:"operationalLayers",ignoreOrigin:!0}}})],zt.prototype,"layers",void 0),(0,v._)([(0,I.c)("layers")],zt.prototype,"writeLayers",null),(0,v._)([(0,E.Cb)({type:G.default})],zt.prototype,"portalItem",void 0),(0,v._)([(0,E.Cb)({json:{write:!0}})],zt.prototype,"presentation",void 0),(0,v._)([(0,E.Cb)()],zt.prototype,"resourceInfo",void 0),(0,v._)([(0,E.Cb)({readOnly:!0,type:Tt,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],zt.prototype,"sourceVersion",void 0),(0,v._)([(0,M.r)("sourceVersion")],zt.prototype,"readSourceVersion",null),(0,v._)([(0,I.c)("sourceVersion")],zt.prototype,"writeSourceVersion",null),(0,v._)([(0,E.Cb)({json:{read:!1,write:{ignoreOrigin:!0}}})],zt.prototype,"tables",void 0),(0,v._)([(0,I.c)("tables")],zt.prototype,"writeTables",null),(0,v._)([(0,E.Cb)()],zt.prototype,"thumbnailUrl",null),(0,v._)([(0,E.Cb)({type:De.Z,json:{write:!0}})],zt.prototype,"widgets",void 0),(0,v._)([(0,E.Cb)({type:Rt,json:{read:!0,write:!0}})],zt.prototype,"utilityNetworks",void 0);var Bt=zt=(0,v._)([(0,Z.j)("esri.WebMap")],zt)},86868:function(e,t,n){n.d(t,{B:function(){return y},a:function(){return s},b:function(){return _}});var r,i,a,o,s,l=n(30168),u=n(91835),c=n(63434),h=n(32426),d=n(49450),f=n(58406),p=n(98634),v=n(64201),m=n(19253);function _(e){var t=new v.kG;if(t.include(h.T),e.background===s.Only){var n=e.output===c.lG.ColorComposite;return n?t.fragment.uniforms.add(new d.J("backgroundColor",(function(e){return e.backgroundColor}))):(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(u.H)),t.fragment.code.add((0,p.H)(r||(r=(0,l.Z)(["\n    void main() {\n      gl_FragColor = vec4(",", 1.0);\n    }\n  "])),n?(0,p.H)(i||(i=(0,l.Z)(["backgroundColor"]))):(0,p.H)(a||(a=(0,l.Z)(["gridColor(uv)"]))))),t}return t.include(c.JT,e),t.fragment.uniforms.add(new m.A("tex",(function(e){return e.texture}))),t.fragment.uniforms.add(new f.p("opacity",(function(e){return e.opacity}))),t.fragment.code.add((0,p.H)(o||(o=(0,l.Z)(["void main() {\nvec4 bgColor = getBackground(uv);\ngl_FragColor = blendLayers(bgColor, texture2D(tex, uv), opacity);\n}"])))),t}!function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(s||(s={}));var y=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return s},build:_},Symbol.toStringTag,{value:"Module"}))},98757:function(e,t,n){n.d(t,{B:function(){return p},b:function(){return f}});var r,i,a=n(30168),o=n(98634),s=n(64201),l=n(19253),u=n(4760),c=n(90541),h=8,d=16;function f(){var e=new s.kG,t=e.attributes,n=e.varyings,f=e.vertex,p=e.fragment;return t.add(u.T.POSITION,"vec2"),n.add("uv","vec2"),n.add("offsets[2]","vec4"),n.add("maxOffset","vec4"),n.add("pixelCoord","vec2"),(0,c.dz)(f),f.code.add((0,o.H)(r||(r=(0,a.Z)(["\n      void main() {\n        uv = position * 0.5 + vec2(0.5);\n        gl_Position = vec4(position, 0, 1);\n\n        pixelCoord = uv * resolution.zw;\n        offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );\n        offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );\n        maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( "," );\n      }\n    "])),o.H.int(h))),p.uniforms.add(new l.A("edgesTexture",(function(e){return e.edges.colorTexture}))),p.uniforms.add(new l.A("areaTexture",(function(e){return e.areaTexture}))),p.uniforms.add(new l.A("searchTexture",(function(e){return e.searchTexture}))),(0,c.dz)(p),p.code.add((0,o.H)(i||(i=(0,a.Z)(["\n      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )\n      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )\n\n      vec4 sampleLevelZeroOffset(sampler2D texture, vec2 coord, vec2 offset) {\n        return texture2D(texture, coord + offset.x * resolution.xy, 0.0);\n      }\n\n      vec2 round( vec2 x ) {\n        return sign(x) * floor(abs(x) + 0.5);\n      }\n\n      float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {\n        e.r = bias + e.r * scale;\n        return 255.0 * texture2D( searchTex, e, 0.0 ).r;\n      }\n\n      float searchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 0.0, 1.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;\n          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n        }\n        texcoord.x += 0.25 * resolution.x;\n        texcoord.x += resolution.x;\n        texcoord.x += 2.0 * resolution.x;\n        texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);\n        return texcoord.x;\n      }\n\n      float searchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 0.0, 1.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;\n          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n        }\n        texcoord.x -= 0.25 * resolution.x;\n        texcoord.x -= resolution.x;\n        texcoord.x -= 2.0 * resolution.x;\n        texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );\n        return texcoord.x;\n      }\n\n      float searchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 1.0, 0.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;\n          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n        }\n        texcoord.y -= 0.25 * resolution.y;\n        texcoord.y -= resolution.y;\n        texcoord.y -= 2.0 * resolution.y;\n        texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );\n        return texcoord.y;\n      }\n\n      float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n        vec2 e = vec2( 1.0, 0.0 );\n        for ( int i = 0; i < ","; i ++ ) {\n          e = texture2D( edgesTex, texcoord, 0.0 ).rg;\n          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;\n          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n        }\n        texcoord.y += 0.25 * resolution.y;\n        texcoord.y += resolution.y;\n        texcoord.y += 2.0 * resolution.y;\n        texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );\n        return texcoord.y;\n      }\n\n      vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {\n        vec2 texcoord = float( "," ) * round( 4.0 * vec2( e1, e2 ) ) + dist;\n        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );\n        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;\n        return texture2D( areaTex, texcoord, 0.0 ).rg;\n      }\n\n      void main() {\n        ivec4 subsampleIndices = ivec4(0.0);\n        vec4 weights = vec4(0.0);\n        vec2 e = texture2D( edgesTexture, uv ).rg;\n        if ( e.g > 0.0 ) {\n          vec2 d;\n          vec2 coords;\n          coords.x = searchXLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x );\n          coords.y = offsets[1].y;\n          d.x = coords.x;\n          float e1 = texture2D( edgesTexture, coords, 0.0 ).r;\n          coords.x = searchXRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y );\n          d.y = coords.x;\n          d = d * resolution.z - pixelCoord.x;\n          vec2 sqrt_d = sqrt( abs(d) );\n          coords.y -= 1.0 * resolution.y;\n          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ) ).r;\n          weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );\n        }\n\n        if ( e.r > 0.0 ) {\n          vec2 d;\n          vec2 coords;\n          coords.y = searchYUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z );\n          coords.x = offsets[0].x;\n          d.x = coords.y;\n          float e1 = texture2D( edgesTexture, coords, 0.0 ).g;\n          coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w );\n          d.y = coords.y;\n          d = d * resolution.w - pixelCoord.y;\n          vec2 sqrt_d = sqrt(abs(d));\n          coords.y -= 1.0 * resolution.y;\n          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0)).g;\n          weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );\n\n          // for some reason the following lines are necessary to prevent\n          // texture lookup precision issues on some Intel integrated graphics chips\n          vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);\n          weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);\n        }\n        gl_FragColor = weights;\n      }\n    "])),o.H.int(h),o.H.int(h),o.H.int(h),o.H.int(h),o.H.int(d))),e}var p=Object.freeze(Object.defineProperty({__proto__:null,build:f},Symbol.toStringTag,{value:"Module"}))},40051:function(e,t,n){n.d(t,{B:function(){return d},b:function(){return h}});var r,i,a=n(30168),o=n(98634),s=n(64201),l=n(19253),u=n(4760),c=n(90541);function h(){var e=new s.kG,t=e.attributes,n=e.varyings,h=e.vertex,d=e.fragment;return t.add(u.T.POSITION,"vec2"),n.add("uv","vec2"),n.add("offsets[2]","vec4"),(0,c.dz)(h),h.code.add((0,o.H)(r||(r=(0,a.Z)(["void main() {\nuv = position * 0.5 + vec2(0.5);\ngl_Position = vec4(position, 0, 1);\noffsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );\noffsets[1] = uv.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );\n}"])))),d.uniforms.add(new l.A("blendWeightsTexture",(function(e){return e.blend.colorTexture}))),d.uniforms.add(new l.A("colorTexture",(function(e){return e.colorTexture}))),(0,c.dz)(d),d.code.add((0,o.H)(i||(i=(0,a.Z)(["void main() {\nvec4 a;\na.rb = texture2D(blendWeightsTexture, uv).rb;\na.g = texture2D(blendWeightsTexture, offsets[1].zw).g;\na.a = texture2D(blendWeightsTexture, offsets[1].xy).a;\nif ( dot(a, vec4(1.0)) < 1e-5 ) {\ngl_FragColor = texture2D( colorTexture, uv, 0.0 );\n} else {\nvec2 offset;\noffset.x = a.a > a.b ? a.a : -a.b;\noffset.y = a.g > a.r ? -a.g : a.r;\nif ( abs( offset.x ) > abs( offset.y )) {\noffset.y = 0.0;\n} else {\noffset.x = 0.0;\n}\nvec4 C = texture2D( colorTexture, uv, 0.0 );\nvec4 Cop = texture2D( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );\nfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );\ngl_FragColor = mix(C, Cop, s);\n}\n}"])))),e}var d=Object.freeze(Object.defineProperty({__proto__:null,build:h},Symbol.toStringTag,{value:"Module"}))},39073:function(e,t,n){n.d(t,{C:function(){return H},a:function(){return U},b:function(){return L}});var r,i,a,o,s,l,u,c,h,d,f,p,v,m,_,y=n(30168),g=n(14226),b=n(81949),w=n(71353),C=n(5461),x=n(60113),T=n(21002),S=n(29202),k=n(92395),P=n(82999),R=n(49450),A=n(95276),E=n(58406),O=n(98634),M=n(8654),Z=n(64201),I=n(19253),D=n(4760),L=(0,w.f)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),N=(0,w.f)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),F=(0,w.f)(parseFloat(Number(L[0]+N[0]).toFixed(6)),parseFloat(Number(L[1]+N[1]).toFixed(6)),parseFloat(Number(L[2]+N[2]).toFixed(6)));function U(e){var t=new Z.kG;t.attributes.add(D.T.POSITION,"vec2"),t.include(x.D,{textureCoordinateType:x.N.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");var n=t.vertex,b=t.fragment;return n.uniforms.add([new M.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new M.g("inverseViewMatrix",(function(e,t){return(0,g.p)(V,t.camera.viewMatrix)}))]),n.code.add((0,O.H)(r||(r=(0,y.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),b.uniforms.add([new P.A("radii",(function(e){return e.radii})),new R.J("cameraPosition",(function(e,t){return t.camera.eye})),new A.N("heightParameters",(function(e){return e.heightParameters})),new E.p("innerFadeDistance",(function(e){return e.innerFadeDistance})),new E.p("altitudeFade",(function(e){return e.altitudeFade})),new I.A("depthTex",(function(e){return e.depthTex})),new E.p("hazeStrength",(function(e){return e.hazeStrength}))]),b.constants.add("betaRayleigh","vec3",L),b.constants.add("betaCombined","vec3",F),b.constants.add("betaMie","float",3996e-9),b.constants.add("scaleHeight","float",C.TR*C.k8),(0,k.Pe)(b),t.include(S.D),e.haze&&(b.include(T.S),b.uniforms.add(new P.A("nearFar",(function(e,t){return t.camera.nearFar})))),b.code.add((0,O.H)(i||(i=(0,y.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = planet ? heightParameters[1] - radius * radius : heightParameters[2];\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),b.code.add((0,O.H)(a||(a=(0,y.Z)(["float chapmanApproximation(float X, float h, float cosZenith) {\nfloat c = sqrt(X + h);\nfloat cExpH = c * exp(-h);\nif (cosZenith >= 0.0) {\nreturn cExpH / (c * cosZenith + 1.0);\n} else {\nfloat x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);\nfloat c0 = sqrt(x0);\nreturn 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);\n}\n}"])))),b.code.add((0,O.H)(o||(o=(0,y.Z)(["float getOpticalDepth(vec3 position, vec3 dir, float h) {\nreturn scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));\n}"])))),b.code.add((0,O.H)(s||(s=(0,y.Z)(["\n    const int STEPS = 6;\n\n    float getGlow(float dist, float radius, float intensity) {\n      return pow(radius / max(dist, 1e-6), intensity);\n    }\n\n    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {\n      float reducedPlanetRadius = radii[0] - 20000.0;\n      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);\n      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);\n      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;\n      bool insideAtmosphere = heightParameters[0] < radii[1];\n\n      if (!(hitsAtmosphere || insideAtmosphere)) {\n        return vec3(0);\n      }\n\n      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;\n\n      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;\n\n      if (heightParameters[0] < reducedPlanetRadius) {\n        // Long light rays from the night side of the planet lead to numerical instability\n        // Do not render the atmosphere in such cases\n        if (dot(rayDir, normalize(cameraPos)) < -0.025) {\n          return vec3(0);\n        }\n        start = rayPlanetIntersect.y;\n      }\n\n      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;\n      float maxEnd = end;\n\n      ","\n\n      vec3 samplePoint = cameraPos + rayDir * end;\n      float multiplier = hitsPlanet ? -1.0 : 1.0;\n\n      vec3 scattering = vec3(0);\n      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);\n      float stepSize = (end - start) / float(STEPS);\n      for (int i = 0; i < STEPS; i++) {\n        samplePoint -= stepSize * rayDir;\n        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;\n        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);\n\n        if (i > 0) {\n          scattering *= "," exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));\n        }\n\n        if (dot(normalize(samplePoint), lightDir) > -0.3) {\n\n          float scale = exp(-scaleFract);\n          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);\n\n          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);\n          ","\n        }\n\n        lastOpticalDepth = opticalDepth;\n\n      }\n\n      float mu = dot(rayDir, lightDir);\n      float mumu = 1.0 + mu * mu;\n\n      float phaseRayleigh = 0.0596831 * mumu;\n\n      ","\n    }\n\n    vec3 tonemapACES(vec3 x) {\n      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n    }\n\n    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {\n      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);\n      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {\n        return fragColor;\n      }\n\n      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));\n      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);\n      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;\n      if (relDist > 1.0) {\n        return surfaceColor;\n      }\n\n      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));\n    }\n\n    void main() {\n      vec3 rayDir = normalize(worldRay);\n      float terrainDepth = -1.0;\n      ","\n\n      ","\n      col = tonemapACES(col);\n      gl_FragColor = delinearizeGamma(vec4(col, alpha));\n      ","\n    }\n  "])),e.haze?(0,O.H)(l||(l=(0,y.Z)(["if (terrainDepth != -1.0) { end = terrainDepth; }"]))):"",e.haze?(0,O.H)(u||(u=(0,y.Z)([""]))):" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * ",e.haze?"":(0,O.H)(c||(c=(0,y.Z)(["scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);"]))),e.haze?(0,O.H)(h||(h=(0,y.Z)(["return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;"]))):(0,O.H)(d||(d=(0,y.Z)(["\n            const float g = 0.8;\n            const float gg = g * g;\n            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;\n            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));\n            phaseMie = clamp(phaseMie, 0.0, 128.0);\n            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);"]))),e.haze?(0,O.H)(f||(f=(0,y.Z)(["\n          vec4 depthSample = texture2D(depthTex, vuv0).rgba;\n          if (depthSample != vec4(0)) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);\n            terrainDepth = max(0.0, length(cameraSpaceRay));\n          }"]))):(0,O.H)(p||(p=(0,y.Z)(["\n          float depthSample = texture2D(depthTex, vuv0).r;\n          if (depthSample != 1.0) {\n            gl_FragColor = vec4(0);\n            return;\n          }"]))),e.haze?(0,O.H)(v||(v=(0,y.Z)(["\n            vec3 col = vec3(0);\n            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);\n            if(depthSample != vec4(0)){\n              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);\n            }\n            float alpha = 1.0 - fadeOut;"]))):(0,O.H)(m||(m=(0,y.Z)(["\n            vec3 col = getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);;\n            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));"]))),e.haze?"":(0,O.H)(_||(_=(0,y.Z)(["\n          if (depthSample == 1.0) {\n            gl_FragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, gl_FragColor);\n          }"]))))),t}var V=(0,b.c)(),H=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:L,build:U},Symbol.toStringTag,{value:"Module"}))},50703:function(e,t,n){n.d(t,{C:function(){return Z},a:function(){return I},b:function(){return N},c:function(){return D}});var r,i,a,o,s,l,u,c,h,d,f=n(30168),p=n(43144),v=n(15671),m=n(60136),_=n(92572),y=n(16889),g=n(92026),b=n(11873),w=n(88396),C=n(6394),x=n(12658),T=n(20460),S=n(68820),k=n(24967),P=n(82999),R=n(58406),A=n(98634),E=n(82644),O=n(64201),M=n(19253),Z=function(e){(0,m.Z)(n,e);var t=(0,_.Z)(n);function n(){var e;return(0,v.Z)(this,n),(e=t.apply(this,arguments)).cloudRadius=0,e.cloudSize=0,e.detailSize=0,e.absorption=0,e.density=0,e.smoothness=0,e.cloudHeight=0,e.coverage=0,e.raymarchingSteps=x.L.default.raymarchingSteps,e.weatherTile=(0,C.a)(),e}return(0,p.Z)(n)}(A.K),I=function(e){(0,m.Z)(n,e);var t=(0,_.Z)(n);function n(){var e;return(0,v.Z)(this,n),(e=t.apply(this,arguments)).viewMatrix=(0,b.c)(),e}return(0,p.Z)(n)}(A.K);function D(e){var t=new O.kG;t.include(k.k,!1);var n=t.fragment;return n.uniforms.add([new R.p("cloudRadius",(function(e){return e.cloudRadius})),new R.p("power",(function(e){return(0,y.t7)(35,120,e.absorption)})),new R.p("sigmaE",(function(e){return 1+e.absorption})),new R.p("density",(function(e){return(0,y.t7)(0,.3,e.density)})),new R.p("cloudSize",(function(e){return(0,y.t7)(0,.02,Math.max(.01,1-e.cloudSize))})),new R.p("detailSize",(function(e){return(0,y.t7)(0,.2,Math.max(.01,1-e.detailSize))})),new R.p("smoothness",(function(e){return(0,y.t7)(0,.5,1-e.smoothness)})),new R.p("cloudHeight",(function(e){return(0,y.t7)(0,1500,e.cloudHeight)})),new R.p("coverage",(function(e){return e.coverage})),new E.j("view",(function(e){return e.viewMatrix})),new M.A("cloudShapeTexture",(function(e){return(0,g.pC)(e.noiseTexture)?e.noiseTexture.textureAtlas:null})),new P.A("cloudVariables",(function(e){return(0,w.s)(L,e.coverage,e.absorption)}))]),n.constants.add("halfCubeMapSize","float",.5*e.cubeMapSize),n.code.add((0,A.H)(r||(r=(0,f.Z)(["\n    const int STEPS = ",";\n    const int STEPS_LIGHT = 6;\n    const float stepL = 300.0 / float(STEPS_LIGHT);\n    const float cloudStart = 1500.0;\n\n    vec3 rayDirection(vec2 fragCoord) {\n      vec2 xy = fragCoord - halfCubeMapSize;\n      return normalize(vec3(-xy, -halfCubeMapSize));\n    }\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }"])),e.steps===T.p.SIXTEEN?(0,A.H)(i||(i=(0,f.Z)(["16"]))):e.steps===T.p.HUNDRED?(0,A.H)(a||(a=(0,f.Z)(["100"]))):(0,A.H)(o||(o=(0,f.Z)(["200"]))))),n.code.add((0,A.H)(s||(s=(0,f.Z)(["\n    float getCloudShape(vec3 pos, float pOffset) {\n      const float textureWidth = ",";\n      const float dataWidth = ",";\n      const float tileRows = ",";\n      const vec3 atlasDimensions = vec3(",", ",", tileRows * tileRows);\n\n      //Change from Y being height to Z being height\n      vec3 p = float(",") * pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }\n\n    float getCloudMap(vec2 p){\n      // Non-power-of-two textures can't be tiled using WebGL1\n      // Get fractional part of uv to tile\n      // Shift the texture center to origin to avoid seam artifacts\n      vec2 uv = fract(("," * p) / "," + 0.5);\n\n      return texture2D(cloudShapeTexture, uv).a;\n    }\n    "])),A.H.float(S.IQ),A.H.float(S.IQ),A.H.float(S.jy),A.H.float(S.I_),A.H.float(S.I_),A.H.float(S.kR),A.H.float(S.QZ),A.H.float(S.IQ))),n.code.add((0,A.H)(l||(l=(0,f.Z)(["float clouds(vec3 p) {\nfloat cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat cloudMap = getCloudMap(cloudSize * p.xy);\ncloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat shape = getCloudShape(8.0 * cloudSize * p, 0.0);\ncloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nfloat heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\ncloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);\nif (cloud <= 0.0) {\nreturn 0.0;\n}\nreturn density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));\n}"])))),n.code.add((0,A.H)(u||(u=(0,f.Z)(["vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat c = dot(start, start) - (radius * radius);\nfloat d = (b * b) - 4.0 * a * c;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}\nfloat HenyeyGreenstein(float g, float costh) {\nreturn (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n}"])))),n.code.add("\n    float multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      float luminance = 0.0;\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),n.code.add((0,A.H)(c||(c=(0,f.Z)(["float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\nfloat lightRayDensity = clouds(p);\nlightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\nlightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\nfloat beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\nreturn mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n}"])))),n.code.add((0,A.H)(h||(h=(0,f.Z)(["float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\nif (dir.z < 0.0) {\nreturn 0.0;\n}\ntotalTransmittance = 1.0;\nfloat stepS = totalDistance / float(STEPS);\nfloat cameraHeight = length(org);\nfloat mu = 0.5 + 0.5 * dot(sunDirection, dir);\nfloat phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\nvec3 p = org + distToStart  * dir;\nfloat dist = distToStart;\nfloat shading = 0.0;\nfor (int i = 0; i < STEPS; i++) {\nfloat sampleDensity = clouds(p);\nfloat sampleSigmaE = sampleDensity * sigmaE;\nif (sampleDensity > 0.0 ) {\nfloat ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\nfloat luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\nfloat transmittance = exp(-sampleSigmaE * stepS);\nshading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\ntotalTransmittance *= transmittance;\nif (totalTransmittance <= 0.001) {\ntotalTransmittance = 0.0;\nbreak;\n}\n}\ndist += stepS;\np = org + dir * dist;\n}\nreturn shading;\n}"])))),n.code.add((0,A.H)(d||(d=(0,f.Z)(["void main() {\nif (coverage ==  0.0) {\ngl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);\nreturn;\n}\nvec3 rayDir = rayDirection(gl_FragCoord.xy);\nrayDir = normalize(view * rayDir);\nvec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\nbool hitsPlanet = rayDir.z < 0.0;\nfloat hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));\nfloat totalTransmittance = 1.0;\nfloat shading = 0.0;\nif (hitsPlanet) {\nshading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);\ntotalTransmittance = hazeFactor;\ngl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\nreturn;\n}\nvec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\nvec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\nfloat distToStart = rayStartIntersect.y;\nfloat totalDistance = rayEndIntersect.y - distToStart;\nvec3 sunDirection = normalize(vec3(0, 0, 1));\nshading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);\nshading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);\ntotalTransmittance = mix(0.0, totalTransmittance, hazeFactor);\ngl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);\n}"])))),t}var L=(0,C.a)(),N=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:I,CloudsPassParameters:Z,build:D},Symbol.toStringTag,{value:"Module"}))},4685:function(e,t,n){n.d(t,{C:function(){return x},b:function(){return w}});var r,i,a=n(30168),o=n(14226),s=n(81949),l=n(60750),u=n(29202),c=n(92395),h=n(41481),d=n(85586),f=n(73619),p=n(116),v=n(78980),m=n(49450),_=n(98634),y=n(8654),g=n(64201),b=n(4760);function w(){var e=new g.kG;e.attributes.add(b.T.POSITION,"vec2"),e.varyings.add("worldRay","vec3");var t=e.vertex,n=e.fragment;return t.uniforms.add([new y.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new y.g("inverseViewMatrix",(function(e,t){return(0,o.p)(C,t.camera.viewMatrix)}))]),t.code.add((0,_.H)(r||(r=(0,a.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;\ngl_Position = vec4(position, 1.0, 1.0);\n}"])))),n.include(p.Y),n.include(v.n),e.include(l._,{pbrMode:h.f7.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(d.e),e.include(u.D),e.include(c.kR,{useLegacyTerrainShading:!1}),e.include(f.j,{instancedDoublePrecision:!1,useLegacyTerrainShading:!1}),n.uniforms.add([new m.J("cameraPosition",(function(e,t){return t.camera.eye}))]),n.code.add((0,_.H)(i||(i=(0,a.Z)(["void main() {\nvec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);\ngl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);\n}"])))),e}var C=(0,s.c)(),x=Object.freeze(Object.defineProperty({__proto__:null,build:w},Symbol.toStringTag,{value:"Module"}))},34659:function(e,t,n){n.d(t,{C:function(){return Pe},b:function(){return Se},g:function(){return ke}});var r,i,a,o,s,l,u,c,h,d,f,p,v,m,_,y,g,b,w,C,x,T,S,k,P,R,A,E,O,M,Z,I,D,L,N,F,U,V,H,z,B,G,W=n(30168),j=n(22186),q=n(54134),Y=n(7564),X=n(37107),Q=n(91871),J=n(22357),K=n(37081),$=n(33280),ee=n(73782),te=n(60113),ne=n(48655),re=n(85380),ie=n(74058),ae=n(16574),oe=n(137),se=n(21002),le=n(98864),ue=n(38171),ce=n(48051),he=n(34975),de=n(92395),fe=n(15226),pe=n(41481),ve=n(51612),me=n(58335),_e=n(22702),ye=n(26461),ge=n(10763),be=n(86097),we=n(98634),Ce=n(64201),xe=n(19253),Te=n(25920);function Se(e){var t=new Ce.kG;t.include(ie.up,e),t.include(re.Bb,e),t.include(ne.c,e),t.include(te.D,e),t.include(J.qj,e),t.include(X.AD,e),t.include(ge.o,e),t.include($.P_,e),t.include(ve.s,e),t.include(Q.z,e);var n=t.vertex,q=t.fragment;e.pbrMode!==pe.f7.Normal&&e.pbrMode!==pe.f7.Schematic||(t.include(pe.jV,e),e.hasNormalTexture&&t.include(ue.Q,e));var Se=e.output===K.H.Shadow||e.output===K.H.ShadowHighlight||e.output===K.H.ShadowExcludeHighlight;Se&&e.componentData===X._N.Varying?n.code.add((0,we.H)(r||(r=(0,W.Z)(["#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"])))):n.code.add((0,we.H)(i||(i=(0,W.Z)(["#define discardShadows(castShadows) {}"]))));var Pe=e.integratedMeshMode===Y.O.ColorOverlay||e.integratedMeshMode===Y.O.ColorOverlayWithWater,Re=Pe&&e.output===K.H.Color&&e.pbrMode===pe.f7.WaterOnIntegratedMesh;return Pe&&(t.include(he.XP,e),t.include(_e.WB,e),e.spherical?n.code.add((0,we.H)(a||(a=(0,W.Z)(["\n      const float invEllipsoidRadius = ",";\n      vec2 projectOverlay(vec3 pos) {\n        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);\n      }\n      "])),we.H.float(1/(e.ellipsoidMode===be.U.Earth?j.sv.radius:e.ellipsoidMode===be.U.Mars?j.yr.radius:j.Z1.radius)))):n.code.add((0,we.H)(o||(o=(0,W.Z)(["vec2 projectOverlay(vec3 pos) { return pos.xy; }"]))))),Re&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),n.code.add((0,we.H)(s||(s=(0,W.Z)(["\n    void main() {\n      bool castShadows;\n      vec4 externalColor = forwardExternalColor(castShadows);\n      discardShadows(castShadows);\n\n      vertexDiscardByOpacity(externalColor.a);\n\n      ","\n\n      if (externalColor.a < ",") {\n        // Discard this vertex\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n\n      forwardPosition(readElevationOffset());\n      forwardNormal();\n      forwardTextureCoordinates();\n      forwardVertexColor();\n      forwardLinearDepth();\n      ","\n      ","\n      ","\n    }\n  "])),e.output===K.H.ObjectAndLayerIdColor?(0,we.H)(l||(l=(0,W.Z)(["externalColor.a = 1.0;"]))):"",we.H.float(ye.b),e.output===K.H.ObjectAndLayerIdColor?(0,we.H)(u||(u=(0,W.Z)(["forwardObjectAndLayerIdColor();"]))):"",Re?e.spherical?(0,we.H)(c||(c=(0,W.Z)(["\n                groundNormal = normalize(positionWorld());\n                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));\n                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));"]))):(0,we.H)(h||(h=(0,W.Z)(["\n                groundNormal = vec3(0.0, 0.0, 1.0);\n                tbnTangent = vec3(1.0, 0.0, 0.0);\n                tbnBiTangent = vec3(0.0, 1.0, 0.0);"]))):"",Pe?(0,we.H)(d||(d=(0,W.Z)(["setOverlayVTC(projectOverlay(position));"]))):"")),e.output===K.H.Alpha&&(q.include(se.S),t.include(fe.l,e),t.include(le.P,e),Pe&&q.uniforms.add(new xe.A("ovColorTex",(function(e,t){return(0,_e.Tw)(e,t)}))),q.code.add((0,we.H)(f||(f=(0,W.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n\n        gl_FragColor = vec4(materialColor.a);\n      }\n    "])),e.hasMultipassTerrain?(0,we.H)(p||(p=(0,W.Z)(["terrainDepthTest(gl_FragCoord, vPosition_view.z);"]))):"",Pe?(0,we.H)(v||(v=(0,W.Z)(["\n                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);\n                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):""))),e.output===K.H.Color&&(q.include(se.S),t.include(fe.l,e),t.include(le.P,e),t.include(ce.B,e),t.include(he.XP,e),e.receiveShadows?(t.include(me.hb,e),q.code.add((0,we.H)(m||(m=(0,W.Z)(["float evaluateShadow() {\nreturn readShadowMap(vPositionWorldCameraRelative, linearDepth);\n}"]))))):q.code.add((0,we.H)(_||(_=(0,W.Z)(["float evaluateShadow() { return 0.0; }"])))),Pe&&q.uniforms.add(new xe.A("ovColorTex",(function(e,t){return(0,_e.Tw)(e,t)}))),q.code.add((0,we.H)(y||(y=(0,W.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n        ","\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        vec4 externalColor;\n        int externalColorMixMode;\n        readExternalColor(externalColor, externalColorMixMode);\n\n        vec4 materialColor = computeMaterialColor(\n          textureColor,\n          externalColor,\n          externalColorMixMode\n        );\n        ","\n    "])),e.hasMultipassTerrain?(0,we.H)(g||(g=(0,W.Z)(["terrainDepthTest(gl_FragCoord, vPosition_view.z);"]))):"",Pe?(0,we.H)(b||(b=(0,W.Z)(["vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);"]))):"")),e.pbrMode===pe.f7.Normal||e.pbrMode===pe.f7.Schematic?((0,de.F1)(q),q.code.add((0,we.H)(w||(w=(0,W.Z)(["\n        ","\n        vec3 normalVertex = shadingNormalWorld();\n        float additionalIrradiance = 0.02 * mainLightIntensity[2];\n      "])),e.pbrMode===pe.f7.Normal?(0,we.H)(C||(C=(0,W.Z)(["\n                applyPBRFactors();\n                if (int(externalColorMixMode) == 3) {\n                  mrr = vec3(0.0, 0.6, 0.2);\n                }"]))):"")),e.hasNormalTexture?q.code.add((0,we.H)(x||(x=(0,W.Z)(["mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);\nvec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);"])))):q.code.add((0,we.H)(T||(T=(0,W.Z)(["vec3 shadingNormal = normalVertex;"])))),q.code.add((0,we.H)(S||(S=(0,W.Z)(["","\n      "])),e.spherical?(0,we.H)(k||(k=(0,W.Z)(["vec3 normalGround = normalize(positionWorld());"]))):(0,we.H)(P||(P=(0,W.Z)(["vec3 normalGround = vec3(0.0, 0.0, 1.0);"]))))),q.code.add((0,we.H)(R||(R=(0,W.Z)(["\n        vec3 viewDir = normalize(vPositionWorldCameraRelative);\n        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());\n\n        ","\n\n        ","\n\n        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());\n        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);\n        "])),e.snowCover?(0,we.H)(A||(A=(0,W.Z)(["\n                vec3 surfaceNormal = normalize(shadingNormalWorld());\n                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\n                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);\n\n                shadingNormal = mix(shadingNormal, surfaceNormal, snow);\n                ssao = mix(ssao, 0.0, snow);\n                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);\n                emission = mix(emission, vec3(0.0), snow);"]))):"",Pe?(0,we.H)(E||(E=(0,W.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):""))):(e.receiveShadows?q.code.add((0,we.H)(O||(O=(0,W.Z)(["float shadow = evaluateShadow();"])))):e.spherical?((0,he.sC)(q),q.code.add((0,we.H)(M||(M=(0,W.Z)(["float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());\nfloat shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);"]))))):q.code.add((0,we.H)(Z||(Z=(0,W.Z)(["float shadow = 0.0;"])))),Re&&q.uniforms.add(new xe.A("ovNormalTex",(function(e,t){return ke(t)}))),e.snowCover&&(t.extensions.add("GL_OES_standard_derivatives"),q.code.add((0,we.H)(I||(I=(0,W.Z)(["vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));\nfloat snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));\nmaterialColor.rgb = mix(materialColor.rgb, vec3(1), snow);"]))))),q.code.add((0,we.H)(D||(D=(0,W.Z)(["\n        float ambientOcclusion = evaluateAmbientOcclusion();\n        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());\n\n        ","\n\n        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);\n      ","\n      "])),Pe?(0,we.H)(L||(L=(0,W.Z)([" materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;"]))):"",Re?(0,we.H)(N||(N=(0,W.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                // un-gamma the ground color to mix in linear space\n                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);\n              }"]))):""))),q.code.add((0,we.H)(F||(F=(0,W.Z)(["\n        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);\n        ","\n      }\n    "])),e.transparencyPassType===Te.A.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""))),(e.output===K.H.Depth||Se)&&(t.include(ae.F,e),q.code.add((0,we.H)(U||(U=(0,W.Z)(["void main() {\ndiscardBySlice(vPositionWorldCameraRelative);\nvec4 textureColor = readBaseColorTexture();\ndiscardOrAdjustAlpha(textureColor);\noutputDepth(linearDepth);\n}"]))))),e.output===K.H.Normal&&(t.include(ce.B,e),q.code.add((0,we.H)(V||(V=(0,W.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        // note: the alpha component needs to be 1.0 in order for this material\n        // to influence ambient occlusion, see the ssao fragment shader\n        float alpha = ",";\n        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);\n      }\n    "])),e.normalType===ee.h.Ground?"0.0":"1.0"))),e.output===K.H.ObjectAndLayerIdColor&&t.fragment.code.add((0,we.H)(H||(H=(0,W.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n      }\n    "])),Pe?(0,we.H)(z||(z=(0,W.Z)(["gl_FragColor = getOverlayColorTexel(vtcOverlay);"]))):"outputObjectAndLayerIdColor();")),e.output===K.H.Highlight&&(t.include(oe.bA,e),q.code.add((0,we.H)(B||(B=(0,W.Z)(["\n      void main() {\n        discardBySlice(vPositionWorldCameraRelative);\n\n        vec4 textureColor = readBaseColorTexture();\n        discardOrAdjustAlpha(textureColor);\n\n        ","\n\n        outputHighlight();\n      }\n    "])),Pe?(0,we.H)(G||(G=(0,W.Z)(["\n                vec4 overlayColor = getCombinedOverlayColor();\n                if (overlayColor.a == 0.0) {\n                  gl_FragColor = vec4(0.0);\n                  return;\n                }"]))):""))),t}function ke(e){return 0===e.overlays.length?null:e.overlays[q.fu.INNER].getValidTexture(q.NH.Water)}var Pe=Object.freeze(Object.defineProperty({__proto__:null,build:Se,getOverlayNormalTexture:ke},Symbol.toStringTag,{value:"Module"}))},4170:function(e,t,n){n.d(t,{C:function(){return p},a:function(){return m},b:function(){return v}});var r,i=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(92572),u=n(24967),c=n(58406),h=n(98634),d=n(64201),f=n(19253),p=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).opacity=1,e}return(0,a.Z)(n)}(h.K);function v(e){var t=new d.kG;return t.include(u.k),t.fragment.uniforms.add(new f.A("tex",(function(e){return e.texture}))),e.hasOpacityFactor&&t.fragment.uniforms.add(new c.p("opacity",(function(e){return e.opacity}))),t.fragment.code.add((0,h.H)(r||(r=(0,i.Z)(["\n    void main() {\n      gl_FragColor = texture2D(tex, uv) ",";\n    }"])),e.hasOpacityFactor?"* opacity":"")),t}var m=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:p,build:v},Symbol.toStringTag,{value:"Module"}))},82396:function(e,t,n){n.d(t,{E:function(){return p},b:function(){return f}});var r,i,a=n(30168),o=n(98634),s=n(64201),l=n(19253),u=n(4760),c=n(90541),h=.05,d=2;function f(){var e=new s.kG,t=e.attributes,n=e.varyings,f=e.vertex,p=e.fragment;return t.add(u.T.POSITION,"vec2"),(0,c.dz)(f),n.add("uv","vec2"),n.add("offsets[3]","vec4"),f.code.add((0,o.H)(r||(r=(0,a.Z)(["void main() {\nuv = position * 0.5 + vec2(0.5);\ngl_Position = vec4(position, 0, 1);\noffsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );\noffsets[1] = uv.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );\noffsets[2] = uv.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );\n}"])))),p.uniforms.add(new l.A("colorTexture",(function(e){return e.colorTexture}))),p.code.add((0,o.H)(i||(i=(0,a.Z)(["\n    float absMax3(vec3 v) {\n      vec3 t = abs(v);\n      return max(max(t.r, t.g), t.b);\n    }\n\n    void main() {\n      // Calculate color deltas:\n      vec4 delta;\n      vec3 C = texture2D(colorTexture, uv).rgb;\n\n      vec3 Cleft = texture2D(colorTexture, offsets[0].xy).rgb;\n      delta.x = absMax3(C - Cleft);\n\n      vec3 Ctop = texture2D(colorTexture, offsets[0].zw).rgb;\n      delta.y = absMax3(C - Ctop);\n\n      vec2 edges = step(vec2(","), delta.xy);\n\n      // discard if there is no edge:\n      if (dot(edges, vec2(1.0)) == 0.0) {\n        discard;\n      }\n\n      // Calculate right and bottom deltas:\n      vec3 Cright = texture2D(colorTexture, offsets[1].xy).rgb;\n      delta.z = absMax3(C - Cright);\n\n      vec3 Cbottom  = texture2D(colorTexture, offsets[1].zw).rgb;\n      delta.w = absMax3(C - Cbottom);\n\n      // Calculate the maximum delta in the direct neighborhood:\n      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n\n      // Calculate left-left and top-top deltas:\n      vec3 Cleftleft  = texture2D(colorTexture, offsets[2].xy).rgb;\n      delta.z = absMax3(C - Cleftleft);\n\n      vec3 Ctoptop = texture2D(colorTexture, offsets[2].zw).rgb;\n      delta.w = absMax3(C - Ctoptop);\n\n      // Calculate the final maximum delta:\n      maxDelta = max(max(maxDelta, delta.z), delta.w);\n\n      // Local contrast adaptation in action:\n      edges.xy *= step(maxDelta, float(",") * delta.xy);\n\n      gl_FragColor = vec4(edges, 0.0, 0.0);\n    }\n  "])),o.H.float(h),o.H.float(d))),e}var p=Object.freeze(Object.defineProperty({__proto__:null,build:f},Symbol.toStringTag,{value:"Module"}))},32602:function(e,t,n){n.d(t,{E:function(){return D},b:function(){return M}});var r,i,a,o,s,l,u=n(43144),c=n(15671),h=n(60136),d=n(92572),f=n(30168),p=n(88396),v=n(6394),m=n(33280),_=n(15226),y=n(82999),g=n(95276),b=n(58406),w=n(98634),C=n(64201),x=n(61809),T=n(4760),S=n(99954),k=n(63438),P=n(11268),R=n(34016),A=n(48779),E=n(64711),O=n(80883);function M(e){var t=new C.kG,n=t.vertex,u=t.fragment;return e.legacy&&n.uniforms.add([new I("model"),new I("localView")]),t.include(S.g,e),t.include(R.UR,e),t.include(A.B,e),t.include(O.H,e),t.include(E.N,e),t.include(m.f5,e),t.include(P.o,e),t.include(k.S,e),t.include(_.l,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),n.uniforms.add([new y.A("pixelToNDC",(function(e,t){return(0,p.s)(Z,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3])})),new g.N("viewport",(function(e,t){return t.camera.fullViewport})),new b.p("pixelRatio",(function(e,t){return t.camera.pixelRatio}))]),t.attributes.add(T.T.POSITION0,"vec3"),t.attributes.add(T.T.POSITION1,"vec3"),t.attributes.add(T.T.VARIANTOFFSET,"float"),t.attributes.add(T.T.VARIANTSTROKE,"float"),t.attributes.add(T.T.VARIANTEXTENSION,"float"),n.code.add((0,w.H)(r||(r=(0,f.Z)(["\n    const float opaqueCutoff = 1.0 / 255.0;\n\n    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {\n      vec2 sideness = unpackedAttributes.sideness;\n      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;\n\n      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;\n\n      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);\n      vViewPos = viewPos;\n\n      vec4 projPosV0 = projFromViewPosition(viewPosV0);\n      vec4 projPosV1 = projFromViewPosition(viewPosV1);\n      vec4 projPos = projFromViewPosition(viewPos);\n\n      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);\n      vec2 ndcToPixel = viewport.zw * 0.5;\n      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;\n      float lineLengthPixels = length(screenSpaceLinePixels);\n\n      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;\n      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;\n      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;\n\n      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;\n      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;\n\n      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;\n      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;\n\n      vSizeFalloffFactor = falloffFactor;\n\n      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;\n      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;\n\n      ","\n\n      // Half line width in NDC including padding for anti aliasing\n      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;\n      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;\n      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;\n\n      // Compute screen space position of vertex, offsetting for line size and end caps\n      vec2 ndcOffset = (\n          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)\n        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC\n      );\n\n      projPos.xy += ndcOffset * projPos.w;\n      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;\n\n      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));\n\n      // Line length with end caps\n      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;\n\n      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;\n\n      // Position in pixels with origin at first vertex of line segment\n      vPosition = vec3(\n        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,\n        pixelPositionAlongLine,\n        pixelPositionAlongLine / extendedLineLengthPixels\n      );\n\n      // The line width radius in pixels\n      vRadius = lineWidthPixels * 0.5;\n      vLineLengthPixels = extendedLineLengthPixels;\n\n      // discard short edges below a certain length threshold\n      ","\n      gl_Position = projPos;\n    }\n\n    void main() {\n      ComponentData component = readComponentData();\n      UnpackedAttributes unpackedAttributes = unpackAttributes(component);\n\n      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;\n      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);\n      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);\n\n      // Component color\n      vColor = component.color;\n\n      // Discard fully transparent edges\n      if (vColor.a < opaqueCutoff) {\n        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);\n        return;\n      }\n\n      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {\n        return;\n      }\n\n      // General geometric computation for all types of edges\n      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);\n\n      // Specific computation for different edge styles\n      calculateStyleOutputs(unpackedAttributes);\n    }\n  "])),e.antialiasing?(0,w.H)(i||(i=(0,f.Z)(["\n        const float aaPaddingPixels = 1.0;\n\n        // Line size with padding\n        float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;\n        float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;"]))):(0,w.H)(a||(a=(0,f.Z)(["\n        float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;\n        float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;"]))),e.mode===R.Jb.SKETCH?(0,w.H)(o||(o=(0,f.Z)(["\n        if (lineLengthPixels <= 3.0) {\n          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);\n          return;\n        }"]))):e.mode===R.Jb.MIXED?(0,w.H)(s||(s=(0,f.Z)(["\n        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {\n           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);\n           return;\n        }"]))):"")),u.code.add((0,w.H)(l||(l=(0,f.Z)(["\n    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {\n      float positionX = position.x - calculateLineOffset();\n\n      if (radius < 1.0) {\n        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);\n        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);\n        return vec2(0.5 - min(coverageX, coverageY), 0.0);\n      }\n      else {\n        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius\n        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);\n\n        vec2 lineToPosition = vec2(positionX, positionOnCap);\n        return vec2(length(lineToPosition) - radius, positionOnCap / radius);\n      }\n    }\n\n    void main() {\n      ","\n      float radius = vRadius * calculateLinePressure();\n\n      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);\n      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);\n\n      discardByCoverage(radius, coverage);\n      discardBySlice(vWorldPosition);\n\n      gl_FragColor = vec4(vColor.rgb, vColor.a * coverage);\n    }\n  "])),e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":"")),t}var Z=(0,v.a)(),I=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){return(0,c.Z)(this,n),t.call(this,e,"mat4")}return(0,u.Z)(n)}(x.x),D=Object.freeze(Object.defineProperty({__proto__:null,build:M},Symbol.toStringTag,{value:"Module"}))},1674:function(e,t,n){n.d(t,{F:function(){return P},H:function(){return E},b:function(){return R}});var r,i,a,o,s,l=n(30168),u=n(43144),c=n(15671),h=n(60136),d=n(92572),f=n(14226),p=n(81949),v=n(71353),m=n(60113),_=n(21002),y=n(29202),g=n(82999),b=n(49450),w=n(58406),C=n(98634),x=n(8654),T=n(64201),S=n(19253),k=n(4760),P=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(){var e;return(0,c.Z)(this,n),(e=t.apply(this,arguments)).fogColor=(0,v.c)(),e.hazeColor=(0,v.c)(),e.fogStrength=4e-6,e.hazeStrength=4e-6,e.atmosphereC=1,e.fogAmount=0,e.hazeAmount=0,e}return(0,u.Z)(n)}(C.K);function R(e){var t=new T.kG;t.attributes.add(k.T.POSITION,"vec2"),t.include(m.D,{textureCoordinateType:m.N.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");var n=t.vertex,u=t.fragment;return n.uniforms.add([new x.g("inverseProjectionMatrix",(function(e,t){return t.camera.inverseProjectionMatrix})),new x.g("inverseViewMatrix",(function(e,t){return(0,f.p)(A,t.camera.viewMatrix)}))]),n.code.add((0,C.H)(r||(r=(0,l.Z)(["void main(void) {\nvec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;\neyeDir = posViewNear;\nworldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;\nforwardTextureCoordinates();\ngl_Position = vec4(position, 1, 1);\n}"])))),u.uniforms.add(new w.p("atmosphereC",(function(e){return e.atmosphereC}))),u.uniforms.add(new b.J("cameraPosition",(function(e,t){return t.camera.eye}))),u.uniforms.add(new g.A("nearFar",(function(e,t){return t.camera.nearFar}))),u.uniforms.add(new S.A("depthTex",(function(e){return e.depthTexture}))),u.uniforms.add(new w.p("fogStrength",(function(t){return e.haze?t.hazeStrength:t.fogStrength}))),u.uniforms.add(new w.p("fogAmount",(function(t){return e.haze?t.hazeAmount:t.fogAmount}))),u.uniforms.add(new b.J("fogColor",(function(t){return e.haze?t.hazeColor:t.fogColor}))),t.include(y.D),u.include(_.S),u.code.add((0,C.H)(i||(i=(0,l.Z)(["vec2 sphereIntersect(vec3 start, vec3 dir) {\nfloat a = dot(dir, dir);\nfloat b = 2.0 * dot(dir, start);\nfloat d = (b * b) - 4.0 * a * atmosphereC;\nif (d < 0.0) {\nreturn vec2(1e5, -1e5);\n}\nreturn vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n}"])))),u.code.add((0,C.H)(a||(a=(0,l.Z)(["vec4 applyFog(float dist, vec3 rayDir){\nif(dist == -1.0){\nvec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);\ndist = 0.055 * rayAtmosphereIntersect.y;\n}\nfloat fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));\nreturn vec4(fogAmount * fogColor, fogAmount);\n}"])))),u.code.add((0,C.H)(o||(o=(0,l.Z)(["\n    vec3 tonemapACES(vec3 x) {\n      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);\n    }\n\n    void main() {\n      vec3 rayDir = normalize(worldRay);\n      float terrainDepth = -1.0;\n\n      float depthSample = texture2D(depthTex, vuv0).r;\n      float zNorm = 2.0 * depthSample - 1.0;\n      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));\n      if(depthSample < 1.0 && depthSample > 0.0){\n        vec3 cameraSpaceRay = normalize(eyeDir);\n        cameraSpaceRay /= cameraSpaceRay.z;\n        cameraSpaceRay *= linDepth;\n        terrainDepth = max(0.0, length(cameraSpaceRay));\n      }\n\n      ","\n\n      vec4 fog = applyFog(terrainDepth, rayDir);\n\n      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));\n    }\n  "])),e.haze?(0,C.H)(s||(s=(0,l.Z)(["\n          if(terrainDepth == -1.0){\n            gl_FragColor = vec4(0);\n            return;\n          }"]))):"")),t}var A=(0,p.c)(),E=Object.freeze(Object.defineProperty({__proto__:null,FogHazePassParameters:P,build:R},Symbol.toStringTag,{value:"Module"}))},67273:function(e,t,n){n.d(t,{H:function(){return f},a:function(){return v},b:function(){return p}});var r,i=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(92572),u=n(24967),c=n(98634),h=n(64201),d=n(19253),f=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n)}(c.K);function p(){var e=new h.kG;return e.include(u.k),e.fragment.uniforms.add(new d.A("tex",(function(e){return e.texture}))),e.fragment.code.add((0,c.H)(r||(r=(0,i.Z)(["void main() {\ngl_FragColor = vec4(1.0 - texture2D(tex, uv).a);\n}"])))),e}var v=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:f,build:p},Symbol.toStringTag,{value:"Module"}))},90765:function(e,t,n){n.d(t,{H:function(){return v},b:function(){return f}});var r,i,a=n(30168),o=n(90045),s=n(67077),l=n(95276),u=n(98634),c=n(64201),h=n(19253),d=n(4760);function f(){var e=new c.kG,t=e.vertex,n=e.fragment,s=t.code,f=n.code;return e.attributes.add(d.T.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(d.T.UV0,"vec2"),t.uniforms.add(new h.A("coverageTex",(function(e){return e.coverageTexture}))),s.add((0,u.H)(r||(r=(0,a.Z)(["void main() {\nvec4 cov = texture2D(coverageTex, uv0);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\nreturn;\n}\ngl_Position = vec4(position, 0.0, 1.0);\nuv = position.xy * 0.5 + vec2(0.5);\n}"])))),n.uniforms.add(new h.A("tex",(function(e){return e.blurColorTexture}))),n.uniforms.add(new h.A("origin",(function(e){return e.highlightColorTexture}))),n.uniforms.add(new l.N("uColor",(function(e){return e.color}))),n.uniforms.add(new l.N("haloColor",(function(e){return e.haloColor}))),n.uniforms.add(new l.N("opacities",(function(e){return(0,o.s)(p,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}))),n.constants.add("outlineSize","float",8.6),n.constants.add("blurSize","float",.4),f.add((0,u.H)(i||(i=(0,a.Z)(["void main() {\nvec4 blurredHighlightValue = texture2D(tex, uv);\nfloat highlightIntensity = blurredHighlightValue.a;\nif (highlightIntensity == 0.0) {\ndiscard;\n}\nvec4 origin_color = texture2D(origin, uv);\nfloat outlineIntensity;\nfloat fillIntensity;\nif (blurredHighlightValue.g > blurredHighlightValue.b) {\noutlineIntensity = haloColor.w * opacities[1];\nfillIntensity = uColor.w * opacities[3];\n}\nelse {\noutlineIntensity = haloColor.w * opacities[0];\nfillIntensity = uColor.w * opacities[2];\n}\nfloat inner = 1.0 - outlineSize / 9.0;\nfloat outer = 1.0 - (outlineSize + blurSize) / 9.0;\nfloat outlineFactor = smoothstep(outer, inner, highlightIntensity);\nfloat fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;\nfloat intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;\ngl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);\n}"])))),e}var p=(0,s.c)(),v=Object.freeze(Object.defineProperty({__proto__:null,build:f},Symbol.toStringTag,{value:"Module"}))},56384:function(e,t,n){n.d(t,{H:function(){return _},a:function(){return g},b:function(){return y}});var r,i,a=n(30168),o=n(43144),s=n(15671),l=n(60136),u=n(92572),c=n(6394),h=n(22527),d=n(98634),f=n(64201),p=n(78050),v=n(19253),m=n(4760),_=function(e){(0,l.Z)(n,e);var t=(0,u.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).blurSize=(0,c.a)(),e}return(0,o.Z)(n)}(d.K);function y(){var e=new f.kG,t=e.vertex,n=e.fragment,o=t.code,s=n.code;return e.attributes.add(m.T.POSITION,"vec2"),e.attributes.add(m.T.UV0,"vec2"),e.varyings.add("blurCoordinate","vec3"),t.uniforms.add(new v.A("coverageTex",(function(e){return e.coverageTexture}))),n.uniforms.add(new h.q("blurSize",(function(e){return e.blurSize}))),o.add((0,d.H)(r||(r=(0,a.Z)(["void main() {\ngl_Position = vec4(position, 0.0, 1.0);\nvec4 cov = texture2D(coverageTex, uv0);\nif (cov.r == 0.0) {\ngl_Position = vec4(0.0);\n}\nblurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));\n}"])))),n.uniforms.add(new p.R("tex",(function(e){return e.blurInputTexture}))),s.add((0,d.H)(i||(i=(0,a.Z)(["void main() {\nvec2 uv = blurCoordinate.xy;\nvec4 center = texture2D(tex, uv);\nif (blurCoordinate.z == 1.0) {\ngl_FragColor = center;\n} else {\nvec4 sum = vec4(0.0);\nsum += center * 0.204164;\nsum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;\nsum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;\nsum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;\nsum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;\ngl_FragColor = sum;\n}\n}"])))),e}var g=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:_,build:y},Symbol.toStringTag,{value:"Module"}))},69012:function(e,t,n){n.d(t,{H:function(){return m},a:function(){return y},b:function(){return _}});var r,i,a=n(30168),o=n(43144),s=n(15671),l=n(60136),u=n(92572),c=n(6394),h=n(22527),d=n(98634),f=n(64201),p=n(78050),v=n(4760),m=function(e){(0,l.Z)(n,e);var t=(0,u.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).invFramebufferDim=(0,c.a)(),e}return(0,o.Z)(n)}(d.K);function _(){var e=new f.kG,t=e.vertex,n=e.fragment,o=t.code,s=n.code;return e.attributes.add(v.T.POSITION,"vec2"),o.add((0,d.H)(r||(r=(0,a.Z)(["void main() {\ngl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);\n}"])))),n.uniforms.add(new p.R("tex",(function(e){return e.inputTexture}))),n.uniforms.add(new h.q("invFramebufferDim",(function(e){return e.invFramebufferDim}))),s.add((0,d.H)(i||(i=(0,a.Z)(["void main() {\nvec2 coord = gl_FragCoord.xy * invFramebufferDim;\nvec4 value = texture2D(tex, coord);\nfloat mx = floor(max(value.g, value.b));\ngl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);\n}"])))),e}var y=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:m,build:_},Symbol.toStringTag,{value:"Module"}))},50214:function(e,t,n){n.d(t,{N:function(){return x},a:function(){return S},b:function(){return T}});var r,i,a,o,s,l,u,c,h=n(30168),d=n(43144),f=n(15671),p=n(60136),v=n(92572),m=n(6394),_=n(84819),y=n(68820),g=n(24967),b=n(82999),w=n(98634),C=n(64201),x=function(e){(0,p.Z)(n,e);var t=(0,v.Z)(n);function n(){var e;return(0,f.Z)(this,n),(e=t.apply(this,arguments)).weatherTile=(0,m.f)(0,0),e}return(0,d.Z)(n)}(w.K);function T(e){var t=new C.kG;if(t.include(g.k,!1),t.fragment.code.add((0,w.H)(r||(r=(0,h.Z)(["float remap(float x, float low1, float high1, float low2, float high2) {\nreturn low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n}"])))),e.mode===_.u.Full){t.fragment.code.add((0,w.H)(i||(i=(0,h.Z)(["\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    // Safer modulo for positive and negative values\n    vec3 modulo(vec3 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec3 hash(vec3 p3, float frequency){\n      p3 = modulo(p3, frequency);\n      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yxz + 33.33);\n      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);\n    }\n\n    // 5th order polynomial interpolation\n    vec3 fade(vec3 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec3 p, float frequency){\n      // Cell point is in\n      vec3 i = floor(p);\n\n      // Position in the cell in [0, 1]\n      vec3 f = fract(p);\n\n      // Interpolation value for gradient mixing\n      vec3 u = fade(f);\n\n      // Trilinear interpolation of gradients at cube vertices around point\n      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),\n                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),\n                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),\n                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),\n                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),\n                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),\n                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      float octaveFrequencyFactor = 2.0;\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * gradientNoise(p, frequency);\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv) {\n      vec2 tile = floor(uv);\n      float z = floor("," * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPointPerlinWorley(vec3 p) {\n      float perlinNoise = getPerlinNoise(p, ",");\n\n      float worley0 = worley(p, "," * 2.0);\n      float worley1 = worley(p, "," * 8.0);\n      float worley2 = worley(p, "," * 14.0);\n\n      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n    }\n\n    float getTextureForPointWorley(vec3 p) {\n      float worley0 = worley(p, ",");\n      float worley1 = worley(p, "," * 2.0);\n      float worley2 = worley(p, "," * 4.0);\n      float worley3 = worley(p, "," * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "])),w.H.float(y.jy),w.H.float(8),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2),w.H.float(2)))}return t.fragment.uniforms.add(new b.A("weatherTile",(function(e){return e.weatherTile}))),t.fragment.code.add((0,w.H)(a||(a=(0,h.Z)(["\n    vec2 modulo(vec2 m, float n){\n      return mod(mod(m, n) + n, n);\n    }\n\n    vec2 hash(vec2 p){\n      // Get position of p in weather tile\n      p = modulo(p, ",");\n\n      // Get global coordinates of p\n      p += weatherTile * ",";\n\n      // Limit position to avoid numerical instability\n      p = modulo(p, ",");\n\n      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;\n    }\n\n    vec2 fade(vec2 t){\n      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);\n    }\n\n    float gradientNoise(vec2 p){\n      vec2 i = floor( p );\n      vec2 f = fract( p );\n\n      vec2 u = fade(f);\n\n      // Bilinear interpolation of gradients at cell vertices around point\n      return  mix(\n                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),\n                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),\n                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),\n                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),\n                u.y);\n    }\n\n    float worley(vec2 p){\n      float d = 1.0e10;\n      for (int x = -1; x <= 1; x++){\n        for (int y = -1; y <= 1; y++){\n                vec2 tp = floor(p) + vec2(x, y);\n                tp = p - tp - (0.5 + 0.5 * hash(tp));\n                d = min(d, dot(tp, tp));\n            }\n        }\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n  "])),w.H.float(y.A),w.H.float(y.A),w.H.float(y.iZ))),t.fragment.code.add((0,w.H)(o||(o=(0,h.Z)(["void main() {"])))),e.mode===_.u.Full&&t.fragment.code.add((0,w.H)(s||(s=(0,h.Z)(["\n        float padWidth = 1.0;\n        float paddedSize = "," + 2.0 * padWidth;\n        float tileCount = "," * ",";\n        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n        bool padCell = false;\n        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n          padCell = true;\n        }\n\n        bool startPadX = false;\n        bool startPadY = false;\n        bool endPadX = false;\n        bool endPadY = false;\n\n        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n          startPadX = true;\n        }\n\n        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n          startPadY = true;\n        }\n\n        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n          endPadX = true;\n        }\n\n        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n          endPadY = true;\n        }\n\n        vec2 padding = vec2(2.0 * padWidth) * tile;\n        vec2 uv;\n\n        if (padCell) {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n          if (startPadX) {\n            pixel.x += ",";\n          }\n\n          if (startPadY) {\n            pixel.y += ",";\n          }\n\n          if (endPadX) {\n            pixel.x -= ",";\n          }\n\n          if (endPadY) {\n            pixel.y -= ",";\n          }\n\n          uv = vec2(pixel.xy / ",");\n        } else {\n          vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n          uv = vec2(pixel.xy / ",");\n        }\n\n        vec3 p_ = get3Dfrom2D(uv);\n        vec3 p = p_;\n        p.z /= ("," * ",");\n\n        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        float worleyNoise = getTextureForPointWorley(p);\n\n        gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n        p_ = mod(p_ + 1.0, "," * ",");\n        p = p_;\n        p.z /= ("," * ",");\n\n        worleyPerlinNoise = getTextureForPointPerlinWorley(p);\n        worleyNoise = getTextureForPointWorley(p);\n\n        gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n      "])),w.H.float(y.I_),w.H.float(y.jy),w.H.float(y.jy),w.H.float(y.I_),w.H.float(y.I_),w.H.float(y.I_),w.H.float(y.I_),w.H.float(y.I_),w.H.float(y.I_),w.H.float(y.jy),w.H.float(y.jy),w.H.float(y.jy),w.H.float(y.jy),w.H.float(y.jy),w.H.float(y.jy))),t.fragment.code.add((0,w.H)(l||(l=(0,h.Z)(["\n      vec2 mapUV = "," * (gl_FragCoord.xy / ",");\n      float map = abs(gradientNoise(mapUV));\n      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);\n\n      ",";\n    }\n  "])),w.H.float(y.A),w.H.float(y.IQ),e.mode===_.u.Full?(0,w.H)(u||(u=(0,h.Z)(["gl_FragColor.ba = vec2(0.0, map);"]))):(0,w.H)(c||(c=(0,h.Z)(["gl_FragColor = vec4(map);"]))))),t}var S=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:x,build:T},Symbol.toStringTag,{value:"Module"}))},90829:function(e,t,n){n.d(t,{O:function(){return f},a:function(){return v},b:function(){return p}});var r,i=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(92572),u=n(24967),c=n(98634),h=n(64201),d=n(19253),f=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n)}(c.K);function p(){var e=new h.kG;return e.include(u.k),e.fragment.uniforms.add([new d.A("colorTexture",(function(e){return e.colorTexture})),new d.A("alphaTexture",(function(e){return e.alphaTexture})),new d.A("frontFaceTexture",(function(e){return e.frontFaceTexture}))]),e.fragment.code.add((0,c.H)(r||(r=(0,i.Z)(["void main() {\nvec4 srcColor = texture2D(colorTexture, uv);\nif(srcColor.a <= 1e-5){\ndiscard;\n}\nfloat srcAlpha = texture2D(alphaTexture, uv).r;\nvec4 frontFace = texture2D(frontFaceTexture, uv);\ngl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);\n}"])))),e}var v=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:f,build:p},Symbol.toStringTag,{value:"Module"}))},38365:function(e,t,n){n.d(t,{O:function(){return m},a:function(){return y},b:function(){return _}});var r,i=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(92572),u=n(54134),c=n(24967),h=n(58406),d=n(99339),f=n(98634),p=n(64201),v=n(19253),m=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).overlayIndex=u.fu.INNER,e.opacity=1,e}return(0,a.Z)(n)}(f.K);function _(){var e=new p.kG;return e.include(c.k),e.fragment.uniforms.add(new v.A("tex",(function(e){return e.texture}))),e.fragment.uniforms.add(new d._("overlayIdx",(function(e){return e.overlayIndex}))),e.fragment.uniforms.add(new h.p("opacity",(function(e){return e.opacity}))),e.fragment.code.add((0,f.H)(r||(r=(0,i.Z)(["void main() {\nvec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);\ngl_FragColor = texture2D(tex, overlayUV) * opacity;\n}"])))),e}var y=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:m,build:_},Symbol.toStringTag,{value:"Module"}))},19159:function(e,t,n){n.d(t,{P:function(){return S},b:function(){return g}});var r,i,a,o,s,l,u=n(30168),c=n(11186),h=n(71353),d=n(96916),f=n(49450),p=n(58406),v=n(98634),m=n(8654),_=n(64201),y=n(4760);function g(e){var t=new _.kG;return t.attributes.add(y.T.POSITION,"vec3"),t.attributes.add(y.T.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new f.J("cameraPosition",(function(e,t){return t.camera.eye}))),t.vertex.uniforms.add(new f.J("offset",(function(e,t){return function(e,t){var n=t.camera.eye,r=.5*e.width,i=1/e.width,a=(0,c.H)(b,(0,c.s)(b,(n[0]+r)*i,(n[1]+r)*i,(n[2]+r)*i));return(0,c.w)(a,n,(0,c.g)(a,a,e.width))}(e,t)}))),t.vertex.uniforms.add(new p.p("width",(function(e){return e.width}))),t.vertex.uniforms.add(new m.g("proj",(function(e,t){return t.camera.projectionMatrix}))),t.vertex.uniforms.add(new m.g("view",(function(e,t){return t.camera.viewMatrix}))),t.vertex.uniforms.add(new p.p("time",(function(e){return e.time}))),t.varyings.add("vUv","vec2"),t.vertex.code.add((0,v.H)(r||(r=(0,u.Z)(["\n    vec3 hash31(float p){\n      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));\n      p3 += dot(p3, p3.yzx + 33.33);\n      return fract((p3.xxy + p3.yzz) * p3.zyx);\n    }\n\n    float hash11(float p){\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);\n    }\n\n    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/\n    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){\n      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;\n    }\n\n    void main(void) {\n\n      vUv = position.xz;\n\n      vec3 rand = hash31(instanceFeatureAttribute);\n\n      // Set random position for all particles\n      // The hash function space is not high resolution so offset particles by an additional random value\n      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width\n      // overlaying multiple identical but offset grids\n      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;\n\n      // Random orientation of rain drops\n      float angle = 3.1415 * hash11(instanceFeatureAttribute);\n\n      vec3 up = vec3(0, 0, 1);\n\n      // Gravity and wind direction\n      vec3 direction = normalize(cameraPosition);\n\n      vec3 tangent = normalize(cross(direction, up));\n\n      // Gravity\n      vec3 animatedPos = randomPosition + direction * -time;\n\n      // Rain particles fall straight down and are randomly oriented\n      // Snow particles have random sinusoid trajectories and are rotated to face the camera\n      ","\n    }\n  "])),e.type===d.H.Rain?(0,v.H)(i||(i=(0,u.Z)(["\n            // Random rotation for particle\n            vec3 rotationAxis = up;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);\n\n            // Rotate particle to planetary position\n            rotationAxis = tangent;\n            angle = 0.5 * -acos(dot(direction, up));\n            quat = vec4(rotationAxis * sin(angle), cos(angle));\n            transformedPos = rotateVectorByQuaternion(transformedPos, quat);\n\n            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * pos;\n      "]))):(0,v.H)(a||(a=(0,u.Z)(["\n            vec3 rotationAxis = direction;\n            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));\n\n            tangent = rotateVectorByQuaternion(tangent, quat);\n            // Random sinusoid from friction\n            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));\n            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);\n            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);\n      "]))))),t.fragment.uniforms.add([new p.p("opacity",(function(e){return e.opacity})),new f.J("particleColor",(function(t,n){return function(e,t){var n=t.type===d.H.Rain?x:C,r=(0,c.g)(b,n,T),i=e.camera.eye;(0,c.n)(w,i);var a=Math.max(0,(0,c.e)(w,e.lighting.mainLight.direction));return(0,c.h)(r,r,n,a)}(n,e)}))]),t.fragment.code.add((0,v.H)(o||(o=(0,u.Z)(["\n    void main() {\n\n      // Cut off corners of the triangle\n      if(vUv.x < 0.0 || vUv.y < 0.0){\n        discard;\n      }\n\n      float d = length(vUv - vec2(0.5));\n\n      ","\n      gl_FragColor = opacity * vec4(particleColor * d, d);\n    }\n  "])),e.type===d.H.Rain?(0,v.H)(s||(s=(0,u.Z)(["d = 0.35 * smoothstep(0.5, 0.0, d);"]))):(0,v.H)(l||(l=(0,u.Z)(["d = smoothstep(0.5, 0.1, d);"]))))),t}var b=(0,h.c)(),w=(0,h.c)(),C=(0,h.f)(1,1,1),x=(0,h.f)(.85,.85,.85),T=.7,S=Object.freeze(Object.defineProperty({__proto__:null,build:g},Symbol.toStringTag,{value:"Module"}))},87016:function(e,t,n){n.d(t,{C:function(){return L},R:function(){return V},a:function(){return N},b:function(){return F},c:function(){return U}});var r,i,a,o,s,l,u,c,h,d,f,p,v,m=n(30168),_=n(43144),y=n(15671),g=n(60136),b=n(92572),w=n(71353),C=n(39395),x=n(54786),T=n(9386),S=n(63434),k=n(32426),P=n(116),R=n(13773),A=n(82999),E=n(58406),O=n(699),M=n(99339),Z=n(98634),I=n(64201),D=n(19253),L=function(e){(0,g.Z)(n,e);var t=(0,b.Z)(n);function n(e,r,i,a,o,s){var l;return(0,y.Z)(this,n),(l=t.call(this,e,a,o)).colormap=r,l.symbolizer=i,l.u_colormap=s,l.backgroundColor=w.Z,l.fboTexture=null,l.baseOpacity=1,l}return(0,_.Z)(n)}(T.J),N=function(e){(0,g.Z)(n,e);var t=(0,b.Z)(n);function n(){return(0,y.Z)(this,n),t.apply(this,arguments)}return(0,_.Z)(n)}(L),F=function(e){(0,g.Z)(n,e);var t=(0,b.Z)(n);function n(){return(0,y.Z)(this,n),t.apply(this,arguments)}return(0,_.Z)(n)}(L);function U(e){var t=new I.kG;return t.include(k.T),t.include(T.G,e),t.include(x.i,e),t.include(S.JT,e),t.fragment.code.add((0,Z.H)(r||(r=(0,m.Z)(["vec4 applyBackgroundBlend(vec4 layerColor) {\nvec4 bgColor = getBackground(vuv);\nreturn blendLayers(bgColor, layerColor, u_opacity);\n}"])))),e.colorizerType===C.U.Stretch?function(e,t){e.fragment.uniforms.add([new M._("u_bandCount",(function(e){return e.symbolizer.u_bandCount})),new O.O("u_minCutOff",(function(e){return e.symbolizer.u_minCutOff}),3),new O.O("u_maxCutOff",(function(e){return e.symbolizer.u_maxCutOff}),3),new O.O("u_factor",(function(e){return e.symbolizer.u_factor}),3),new E.p("u_minOutput",(function(e){return e.symbolizer.u_minOutput})),new E.p("u_maxOutput",(function(e){return e.symbolizer.u_maxOutput})),new R.U("u_useGamma",(function(e){return e.symbolizer.u_useGamma})),new O.O("u_gamma",(function(e){return e.symbolizer.u_gamma}),3),new O.O("u_gammaCorrection",(function(e){return e.symbolizer.u_gammaCorrection}),3),new E.p("u_opacity",(function(e){return e.common.u_opacity}))]),e.fragment.code.add((0,Z.H)(a||(a=(0,m.Z)(["float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {\nif (val >= maxCutOff) {\nreturn maxOutput;\n} else if (val <= minCutOff) {\nreturn minOutput;\n}\nfloat stretchedVal;\nif (useGamma) {\nfloat tempf = 1.0;\nfloat outRange = maxOutput - minOutput;\nfloat relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);\nif (gamma > 1.0) {\ntempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);\n}\nstretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;\n} else {\nstretchedVal = minOutput + (val - minCutOff) * factor;\n}\nreturn stretchedVal;\n}"]))));var n=t.applyColormap?(0,Z.H)(o||(o=(0,m.Z)(["gl_FragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));"]))):(0,Z.H)(s||(s=(0,m.Z)(["gl_FragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));"])));e.fragment.code.add((0,Z.H)(l||(l=(0,m.Z)(["\n      void main() {\n        vec2 pixelLocation = getPixelLocation(uv);\n        if (isOutside(pixelLocation)) {\n          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n\n        vec4 currentPixel = getPixel(pixelLocation);\n        ","\n      }"])),t.stretchType===C.H.Noop?(0,Z.H)(u||(u=(0,m.Z)(["\n        gl_FragColor = applyBackgroundBlend(currentPixel);"]))):(0,Z.H)(c||(c=(0,m.Z)(["\n        if (currentPixel.a == 0.0) {\n          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n          return;\n        }\n        if (u_bandCount == 1) {\n          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          ","\n        } else {\n          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);\n          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);\n          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);\n          gl_FragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));\n        }"])),n)))}(t,e):e.colorizerType===C.U.Lut?function(e){e.fragment.code.add((0,Z.H)(i||(i=(0,m.Z)(["void main() {\nvec2 pixelLocation = getPixelLocation(uv);\nif (isOutside(pixelLocation)) {\ngl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\nreturn;\n}\nvec4 currentPixel = getPixel(pixelLocation);\ngl_FragColor = applyBackgroundBlend(colormap(currentPixel, true));\n}"]))))}(t):e.colorizerType===C.U.Hillshade&&function(e,t){var n=e.fragment;n.uniforms.add([new D.A("u_image",(function(e){return e.u_image})),new M._("u_hillshadeType",(function(e){return e.symbolizer.u_hillshadeType})),new O.O("u_sinZcosAs",(function(e){return e.symbolizer.u_sinZcosAs}),6),new O.O("u_sinZsinAs",(function(e){return e.symbolizer.u_sinZsinAs}),6),new O.O("u_cosZs",(function(e){return e.symbolizer.u_cosZs}),6),new O.O("u_weights",(function(e){return e.symbolizer.u_weights}),6),new A.A("u_factor",(function(e){return e.symbolizer.u_factor})),new E.p("u_minValue",(function(e){return e.symbolizer.u_minValue})),new E.p("u_maxValue",(function(e){return e.symbolizer.u_maxValue})),new A.A("u_srcImageSize",(function(e){return e.common.u_srcImageSize}))]),n.include(P.Y),n.code.add((0,Z.H)(h||(h=(0,m.Z)(["vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {\nval = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);\nvec4 color = colormap(vec4(val, val, val, 1.0), false);\nvec3 hsv = rgb2hsv(color.rgb);\nhsv.z = hillshade;\nreturn vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;\n}"])))),n.code.add((0,Z.H)(d||(d=(0,m.Z)(["float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){\nif (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {\nreturn 0.0;\n}  else {\nreturn e;\n}\n}"]))));var r=t.applyColormap?(0,Z.H)(f||(f=(0,m.Z)(["gl_FragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));"]))):(0,Z.H)(p||(p=(0,m.Z)(["hillshade *= alpha;\ngl_FragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));"])));n.code.add((0,Z.H)(v||(v=(0,m.Z)(["\n    void main() {\n      vec2 pixelLocation = getPixelLocation(uv);\n      if (isOutside(pixelLocation)) {\n        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      vec4 currentPixel = getPixel(pixelLocation);\n      if (currentPixel.a == 0.0) {\n        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));\n        return;\n      }\n\n      //mirror edge pixels\n      vec2 axy = vec2(-1.0, -1.0);\n      vec2 bxy = vec2(0.0, -1.0);\n      vec2 cxy = vec2(1.0, -1.0);\n      vec2 dxy = vec2(-1.0, 0.0);\n      vec2 fxy = vec2(1.0, 0.0);\n      vec2 gxy = vec2(-1.0, 1.0);\n      vec2 hxy = vec2(0.0, 1.0);\n      vec2 ixy = vec2(1.0, 1.0);\n      vec2 onePixel = 1.0 / u_srcImageSize;\n      if (pixelLocation.s < onePixel.s) {\n        axy[0] = 1.0;\n        dxy[0] = 1.0;\n        gxy[0] = 1.0;\n      }\n      if (pixelLocation.t < onePixel.t) {\n        axy[1] = 1.0;\n        bxy[1] = 1.0;\n        cxy[1] = 1.0;\n      }\n      if (pixelLocation.s > 1.0 - onePixel.s) {\n        cxy[0] = -1.0;\n        fxy[0] = -1.0;\n        ixy[0] = -1.0;\n      }\n      if (pixelLocation.t > 1.0 - onePixel.t) {\n        gxy[1] = -1.0;\n        hxy[1] = -1.0;\n        ixy[1] = -1.0;\n      }\n\n      // calculate hillshade\n      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);\n      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);\n      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);\n      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);\n      vec4 ve = texture2D(u_image, pixelLocation);\n      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);\n      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);\n      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);\n      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);\n\n      // calculate the rate of z change along the x, y, and diagonal direction\n      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;\n      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;\n      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);\n      float hillshade = 0.0;\n\n      // traditional single light source\n      if (u_hillshadeType == 0){\n        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;\n        float z = (u_cosZs[0] + cosDelta) / dzd;\n        if (z < 0.0)  z = 0.0;\n        hillshade = z;\n      } else {\n        // multi-directional with 6 light sources\n        for (int k = 0; k < 6; k++) {\n        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;\n        float z = (u_cosZs[k] + cosDelta) / dzd;\n        if (z < 0.0) z = 0.0;\n        hillshade = hillshade + z * u_weights[k];\n        if (k == 5) break;\n        }\n      }\n\n      // set color\n      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);\n      alpha *= u_opacity;\n      ","\n    }\n  "])),r))}(t,e),t}var V=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:F,ColorizerStretchUniforms:N,ColorizerUniforms:L,build:U},Symbol.toStringTag,{value:"Module"}))},13378:function(e,t,n){n.d(t,{S:function(){return w},a:function(){return C},b:function(){return k},c:function(){return T}});var r,i=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(92572),u=n(14226),c=n(81949),h=n(24967),d=n(21002),f=n(58335),p=n(96415),v=n(78980),m=n(82999),_=n(98634),y=n(8654),g=n(64201),b=n(19253),w=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){return(0,o.Z)(this,n),t.apply(this,arguments)}return(0,a.Z)(n)}(f.ry),C=255,x=1/C;function T(e){var t=new g.kG,n=t.fragment;return n.include(v.n),n.include(d.S),t.include(p.G),t.include(h.k),t.include(f.hb,e),n.uniforms.add([new b.A("depthMap",(function(e){return e.linearDepthTexture})),new y.g("inverseViewMatrix",(function(e,t){return(0,u.a)(S,(0,u.w)(S,t.camera.viewMatrix,t.camera.center))})),new m.A("nearFar",(function(e,t){return t.camera.nearFar}))]),n.constants.add("sampleValue","float",x),n.code.add((0,_.H)(r||(r=(0,i.Z)(["void main(void) {\nfloat depth = rgba2float(texture2D(depthMap, uv));\nif (depth == 0.0) {\ndiscard;\n}\nfloat currentPixelDepth = linearDepthFromFloat(depth, nearFar);\nif (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {\ndiscard;\n}\nvec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\nvec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\nmat4 shadowMatrix;\nfloat linearDepth = -currentPixelDepth;\nint i = chooseCascade(linearDepth, shadowMatrix);\nif (i >= numCascades) {\ndiscard;\n}\nvec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\nif (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\ndiscard;\n}\nvec2 uvShadow = cascadeCoordinates(i, lvpos);\nfloat depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);\nbool shadow = depthShadow < lvpos.z;\nif (!shadow) {\ndiscard;\n}\ngl_FragColor = vec4(sampleValue);\n}"])))),t}var S=(0,c.c)(),k=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:w,ShadowCastMaxSamples:C,build:T},Symbol.toStringTag,{value:"Module"}))},89822:function(e,t,n){n.d(t,{S:function(){return T},a:function(){return P},b:function(){return k}});var r,i,a,o,s=n(30168),l=n(43144),u=n(15671),c=n(60136),h=n(92572),d=n(67077),f=n(24967),p=n(21002),v=n(96415),m=n(78980),_=n(95276),y=n(58406),g=n(98634),b=n(64201),w=n(19253),C=n(13378),x=n(79485),T=function(e){(0,c.Z)(n,e);var t=(0,h.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this)).shadowCastMap=e,r.sampleScale=0,r.opacityFromElevation=1,r.color=(0,d.d)(S),r.bandSize=.1,r.threshold=.5,r}return(0,l.Z)(n)}(g.K),S=(0,d.f)(.01,0,.25,1);function k(e){var t=new b.kG,n=t.fragment;n.include(m.n),n.include(p.S),t.include(v.G),t.include(f.k);var l=e.visualization,u=e.bandsEnabled;n.constants.add("inverseSampleValue","float",C.a),n.uniforms.add([new w.A("shadowCastMap",(function(e){return e.shadowCastMap})),new y.p("sampleScale",(function(e){return e.sampleScale})),new y.p("opacityFromElevation",(function(e){return e.opacityFromElevation})),new _.N("uColor",(function(e){return e.color}))]);var c=l===x.w.Gradient,h=l===x.w.Threshold;return c&&u?n.uniforms.add(new y.p("bandSize",(function(e){return e.bandSize}))):h&&n.uniforms.add(new y.p("threshold",(function(e){return e.threshold}))),n.code.add((0,g.H)(r||(r=(0,s.Z)(["\n      void main(void) {\n        vec4 record = texture2D(shadowCastMap, uv);\n        float pixelSamples = record.r * inverseSampleValue;\n        if (pixelSamples < 1.0) {\n          discard;\n        }\n\n        float strength = pixelSamples * sampleScale;\n\n        ","\n\n        ","\n\n        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ",");\n      }\n    "])),h?(0,g.H)(i||(i=(0,s.Z)(["\n            if (strength <= threshold) {\n              discard;\n            }"]))):"",c&&u?(0,g.H)(a||(a=(0,s.Z)(["strength = ceil(strength / bandSize) * bandSize;"]))):"",c?(0,g.H)(o||(o=(0,s.Z)(["* strength"]))):"")),t}var P=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:T,build:k},Symbol.toStringTag,{value:"Module"}))},38727:function(e,t,n){n.d(t,{S:function(){return I},b:function(){return E}});var r,i,a=n(30168),o=n(92026),s=n(14226),l=n(81949),u=n(88396),c=n(6394),h=n(11186),d=n(71353),f=n(24967),p=n(137),v=n(21002),m=n(58335),_=n(96415),y=n(78980),g=n(82999),b=n(49450),w=n(95276),C=n(58406),x=n(98634),T=n(8654),S=n(64201),k=n(19253),P=n(471),R=.99999,A=.025;function E(e){var t=new S.kG;t.include(m.XE,e);var n=t.fragment;return n.include(y.n),n.include(v.S),t.include(_.G),t.include(f.k),n.uniforms.add([new k.A("defaultDepthTex",(function(e,t){return t.shadowMap.getSnapshot(P.i.Default)})),new k.A("highlightDepthTex",(function(e,t){return t.shadowMap.getSnapshot(P.i.Highlight)})),new k.A("depthMap",(function(e,t){return t.linearDepthTexture})),new k.A("highlightMap",(function(e,t){return t.highlightColorTexture})),new w.N("uColor",(function(e){return e.shadowColor})),new g.A("nearFar",(function(e,t){return t.camera.nearFar})),new C.p("opacity",(function(e){return e.shadowOpacity})),new C.p("occludedOpacity",(function(e){return e.occludedShadowOpacity})),new C.p("terminationFactor",(function(e){return e.opacityElevation*e.dayNightTerminator})),new b.J("lightingMainDirectionView",(function(e,t){return(0,h.n)(M,(0,h.m)(M,t.lighting.mainLight.direction,t.camera.viewInverseTransposeMatrix))})),new g.A("texelSize",(function(e,t){return(0,o.pC)(t.linearDepthTexture)?(0,u.s)(Z,1/t.linearDepthTexture.descriptor.width,1/t.linearDepthTexture.descriptor.height):c.Z})),new T.g("inverseViewMatrix",(function(e,t){return(0,s.a)(O,(0,s.w)(O,t.camera.viewMatrix,t.camera.center))}))]),n.constants.add("unoccludedHighlightFlag","vec4",p.ck).add("highlightedThreshold","float",R).add("selfShadowThreshold","float",A),n.code.add((0,x.H)(r||(r=(0,a.Z)(["vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {\nfloat leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);\nfloat rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);\nfloat bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);\nfloat topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);\nbool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);\nbool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);\nvec3 fragCoordHorizontal = pickLeft\n? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)\n: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);\nvec3 fragCoordVertical = pickBottom\n? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)\n: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);\nvec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);\nvec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);\nvec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));\nreturn pickLeft == pickBottom ? normal : -normal;\n}"])))),n.code.add((0,x.H)(i||(i=(0,a.Z)(["void main(void) {\nvec4 highlightInfo = texture2D(highlightMap, uv);\nfloat visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;\nif (visiblyHighlighted > highlightedThreshold) {\ndiscard;\n}\nfloat depth = rgba2float(texture2D(depthMap, uv));\nif (depth == 0.0) {\ndiscard;\n}\nfloat currentPixelDepth = linearDepthFromFloat(depth, nearFar);\nif (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {\ndiscard;\n}\nvec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);\nvec4 worldSpacePos = inverseViewMatrix * currentPixelPos;\nmat4 shadowMatrix;\nfloat linearDepth = -currentPixelDepth;\nint i = chooseCascade(linearDepth, shadowMatrix);\nif (i >= numCascades) {\ndiscard;\n}\nvec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);\nif (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {\ndiscard;\n}\nvec2 uvShadow = cascadeCoordinates(i, lvpos);\nfloat depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);\nbool shadowHighlight = depthHighlight < lvpos.z;\nif (!shadowHighlight) {\ndiscard;\n}\nfloat depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);\nbool shadowDefault = depthDefault < lvpos.z;\nvec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);\nbool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;\nfloat fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;\ngl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);\n}"])))),t}var O=(0,l.c)(),M=(0,d.c)(),Z=(0,c.a)(),I=Object.freeze(Object.defineProperty({__proto__:null,build:E},Symbol.toStringTag,{value:"Module"}))},92014:function(e,t,n){n.d(t,{S:function(){return A},a:function(){return M},b:function(){return E},c:function(){return O}});var r,i,a,o,s,l,u,c,h=n(30168),d=n(43144),f=n(15671),p=n(60136),v=n(92572),m=n(6394),_=n(71353),y=n(69362),g=n(94951),b=n(92395),w=n(82999),C=n(49450),x=n(58406),T=n(98634),S=n(8654),k=n(64201),P=n(19253),R=n(4760),A=function(e){(0,p.Z)(n,e);var t=(0,v.Z)(n);function n(){var e;return(0,f.Z)(this,n),(e=t.apply(this,arguments)).texV=(0,m.a)(),e.altitudeFade=0,e.innerScale=0,e.undergroundFadeAlpha=0,e.silhouette=new E,e}return(0,d.Z)(n)}(T.K),E=(0,d.Z)((function e(){(0,f.Z)(this,e),this.center=(0,_.c)(),this.v1=(0,_.c)(),this.v2=(0,_.c)()}));function O(e){var t=new k.kG,n=t.vertex,d=t.fragment;if((0,b.Pe)(n),e.geometry===y.n.Underground)t.attributes.add(R.T.POSITION,"vec2"),t.varyings.add("color","vec4"),n.uniforms.add([new C.J("cameraPosition",(function(e,t){return t.camera.eye})),new x.p("undergroundFadeAlpha",(function(e){return e.undergroundFadeAlpha}))]),n.code.add((0,T.H)(r||(r=(0,h.Z)(["void main(void) {\nfloat ndotl = dot(normalize(cameraPosition), mainLightDirection);\nfloat lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\ncolor = vec4(vec3(lighting), undergroundFadeAlpha);\ngl_Position = vec4(position.xy, 1.0, 1.0);\n}"])))),d.code.add((0,T.H)(i||(i=(0,h.Z)(["void main() {\ngl_FragColor = color;\n}"]))));else{t.include(g.w,e),t.attributes.add(R.T.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");var f=e.geometry===y.n.Cylinder;n.uniforms.add([new S.g("proj",(function(e,t){return t.camera.projectionMatrix})),new S.g("view",(function(e,t){return t.camera.viewMatrix}))]),f||(t.varyings.add("innerFactor","float"),n.uniforms.add(new C.J("silCircleCenter",(function(e){return e.silhouette.center}))),n.uniforms.add(new C.J("silCircleV1",(function(e){return e.silhouette.v1}))),n.uniforms.add(new C.J("silCircleV2",(function(e){return e.silhouette.v2}))),n.uniforms.add(new w.A("texV",(function(e){return e.texV}))),n.uniforms.add(new x.p("innerScale",(function(e){return e.innerScale}))));var p=1/128;n.code.add((0,T.H)(a||(a=(0,h.Z)(["\n\t\tvoid main(void) {\n      ","\n      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));\n\n\t\t  gl_Position = transformPosition(proj, view, pos);\n\t\t  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane\n    }\n\t  "])),f?(0,T.H)(o||(o=(0,h.Z)(["\n      vec3 pos = position;\n      float ndotl = mainLightDirection.z;\n      vtc = vec2(0.0, position.z + 0.05);"]))):(0,T.H)(s||(s=(0,h.Z)(["\n      innerFactor = clamp(-position.z, 0.0, 1.0);\n      float scale = position.y * (1.0 + innerFactor * innerScale);\n      float phi = position.x * "," + 1.0;\n      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;\n      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);\n      vtc.x = position.x  * ",";\n      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;\n      "])),T.H.float(6.2831853*p),T.H.float(p)))),d.uniforms.add(new P.A("tex",(function(e){return e.texture}))),f||d.uniforms.add(new x.p("altitudeFade",(function(e){return e.altitudeFade}))),d.code.add((0,T.H)(l||(l=(0,h.Z)(["\n\t\tvoid main() {\n\t\t\tvec4 atmosphereColor = texture2D(tex, vtc) * falloff;\n      ","\n    }"])),f?(0,T.H)(u||(u=(0,h.Z)(["gl_FragColor = atmosphereColor;"]))):(0,T.H)(c||(c=(0,h.Z)(["\n\t\t\tvec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);\n\t\t\tgl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));\n      "])))))}return t}var M=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:E,SimpleAtmospherePassParameters:A,build:O},Symbol.toStringTag,{value:"Module"}))},96894:function(e,t,n){n.d(t,{S:function(){return _},b:function(){return v}});var r,i,a=n(30168),o=n(14226),s=n(81949),l=n(28156),u=n(95276),c=n(58406),h=n(98634),d=n(8654),f=n(64201),p=n(4760);function v(){var e=new f.kG;return e.attributes.add(p.T.POSITION,"vec3"),e.attributes.add(p.T.COLOR,"vec4"),e.attributes.add(p.T.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add([new d.g("transform",(function(e,t){return function(e,t){var n=24e-8;return(0,o.c)(m,t.camera.projectionMatrix),m[10]=n-1,m[11]=-1,m[14]=(n-2)*t.camera.near,(0,o.m)(m,m,t.camera.viewMatrix),(0,o.m)(m,m,e.modelMatrix)}(e,t)})),new u.N("viewport",(function(e,t){return t.camera.fullViewport})),new c.p("pixelRatio",(function(e,t){return t.camera.pixelRatio}))]),e.include(l.H),e.vertex.code.add((0,h.H)(r||(r=(0,a.Z)(["void main(void) {\nvec4 posProj = transform * vec4(position, 0);\ngl_Position = alignToPixelCenter(posProj, viewport.zw);\nvcolor = color / 1.2;\nvsize = size * 5.0 * pixelRatio;\ngl_PointSize = vsize;\n}"])))),e.fragment.code.add((0,h.H)(i||(i=(0,a.Z)(["void main() {\nfloat cap = 0.7;\nfloat scale = 1.0 / cap;\nfloat helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);\nfloat alpha = clamp((cap - helper) * scale, 0.0, 1.0);\nfloat intensity = alpha * alpha * alpha;\nif (vsize < 3.0) {\nintensity *= 0.5;\n}\ngl_FragColor = vec4(vcolor.xyz, intensity);\n}"])))),e}var m=(0,s.c)(),_=Object.freeze(Object.defineProperty({__proto__:null,build:v},Symbol.toStringTag,{value:"Module"}))},89438:function(e,t,n){n.d(t,{T:function(){return Se},a:function(){return Ae},b:function(){return ke}});var r,i,a,o,s,l,u,c,h,d,f,p,v,m,_,y,g,b,w,C,x,T,S,k,P,R,A,E,O,M,Z,I,D,L,N,F,U,V,H,z,B,G=n(1413),W=n(30168),j=n(43144),q=n(15671),Y=n(60136),X=n(92572),Q=n(14226),J=n(81949),K=n(11186),$=n(71353),ee=n(54134),te=n(22357),ne=n(37081),re=n(33280),ie=n(94951),ae=n(73782),oe=n(52276),se=n(60113),le=n(97397),ue=n(16574),ce=n(137),he=n(30694),de=n(34975),fe=n(92395),pe=n(8555),ve=n(41481),me=n(58335),_e=n(22702),ye=n(28288),ge=n(41012),be=n(49450),we=n(98634),Ce=n(76028),xe=n(64201),Te=n(19253),Se=function(e){(0,Y.Z)(n,e);var t=(0,X.Z)(n);function n(){return(0,q.Z)(this,n),t.apply(this,arguments)}return(0,j.Z)(n)}(ye.uS);function ke(e){var t=new xe.kG,n=t.vertex,j=t.fragment,q=t.varyings;t.include(oe.f),t.include(ae.O,e),t.include(se.D,e);var Y=function(){t.include(pe.n,e),n.code.add((0,we.H)(r||(r=(0,W.Z)(["\n      vec3 decodeNormalTerrain(vec2 e) {\n        float z = 1.0 - abs(e.x) - abs(e.y);\n        vec3 n = vec3(e + vec2(e.x >= 0.0 ? 1.0 : -1.0, e.y >= 0.0 ? 1.0 : -1.0) * min(z,0.0),z);\n        return normalize(n);\n      }\n\n      vec3 getNormal() {\n        return  ",";\n      }\n  "])),e.shading?(0,we.H)(i||(i=(0,W.Z)(["decodeNormalTerrain(normalCompressed)"]))):(0,we.H)(a||(a=(0,W.Z)(["getLocalUp(position, localOrigin)"])))))};(0,ge.Sv)(n,e),t.include(ie.w,e);var X=e.overlayMode!==_e.gT.Disabled;switch(e.output){case ne.H.Color:t.include(ye.EK,e),t.include(de.XP,e),X&&t.include(ye.yl,(0,G.Z)((0,G.Z)({},e),{},{pbrMode:e.pbrMode===ve.f7.Terrain?ve.f7.TerrainWithWater:ve.f7.Water}));var J=e.overlayMode===_e.gT.EnabledWithWater;J&&t.include(le.M,e),q.add("vnormal","vec3"),q.add("vpos","vec3"),q.add("vup","vec3"),Y(),(e.atmosphere||e.screenSizePerspective)&&(0,ge._8)(n);var $=e.receiveShadows&&!e.renderOccluded;$&&t.include(te.qj,e),e.atmosphere&&q.add("wnormal","vec3"),e.screenSizePerspective&&(q.add("screenSizeDistanceToCamera","float"),q.add("screenSizeCosAngle","float")),n.code.add((0,we.H)(o||(o=(0,W.Z)(["\n        void main(void) {\n          //Position\n          vpos = position;\n          vec3 positionWorld = position + localOrigin;\n          gl_Position = transformPosition(proj, view, vpos);\n\n          //Normal\n          vnormal = getNormal();\n\n          //Up\n          vup = getLocalUp(position, localOrigin);\n\n          ","\n\n          ","\n\n          //Texture UV\n          vec2 uv = getUV0();\n          forwardTextureCoordinatesWithTransform(uv);\n          ","\n          ","\n\n          ","\n\n          ","\n\n        }\n      "])),J?(0,we.H)(s||(s=(0,W.Z)(["forwardVertexTangent(vnormal);"]))):(0,we.H)(l||(l=(0,W.Z)([""]))),e.atmosphere?(0,we.H)(u||(u=(0,W.Z)(["wnormal = normalize((viewNormal * vec4(normalize(positionWorld), 1.0)).xyz);"]))):"",X?(0,we.H)(c||(c=(0,W.Z)(["setOverlayVTC(uv);"]))):"",e.tileBorders?(0,we.H)(h||(h=(0,W.Z)(["forwardTextureCoordinates();"]))):"",e.screenSizePerspective?(0,we.H)(d||(d=(0,W.Z)(["\n          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;\n          screenSizeDistanceToCamera = length(viewPos);\n          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;\n          screenSizeCosAngle = abs(viewSpaceNormal.z);"]))):"",$?(0,we.H)(f||(f=(0,W.Z)(["forwardLinearDepth();"]))):"")),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(re.f5,e),t.include(de.XP,e),t.include(he.K,e),t.include(me.XE,e),(0,ge.hY)(j,e),(0,de.PN)(j),(0,de.sC)(j),j.uniforms.add([n.uniforms.get("localOrigin"),new be.J("viewDirection",(function(e,t){return(0,K.n)(Re,(0,K.s)(Re,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14]))}))]),J&&j.uniforms.add([new Te.A("ovWaterTex",(function(e,t){return 0===t.overlays.length?null:t.overlays[ee.fu.INNER].getNormalTexture(e.overlaySource)})),new Ce.K("view",(function(e,t){return(0,Q.w)(Pe,t.camera.viewMatrix,e.origin)}))]),j.code.add((0,we.H)(p||(p=(0,W.Z)(["const float sliceOpacity = 0.2;\nfloat lum(vec3 c) {\nreturn (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;\n}"])))),(0,fe.Pe)(j),(0,fe.F1)(j),j.code.add((0,we.H)(v||(v=(0,W.Z)(["\n        void main() {\n          vec3 normal = normalize(vnormal);\n          float vndl = dot(normal, mainLightDirection);\n\n          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));\n          float shadow = ",";\n\n          float ssao = evaluateAmbientOcclusionInverse();\n          vec4 tileColor = getTileColor();\n\n          ","\n\n          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here\n          // is neglectable because terrain typically renders first into the framebuffer.\n          if(tileColor.a <= 0.0) {\n            discard;\n          }\n\n          bool sliced = rejectBySlice(vpos);\n          if (sliced) {\n            tileColor *= sliceOpacity;\n          }\n          ","\n\n          vec3 albedo = ","\n\n          // heuristic shading function used in the old terrain, now used to add ambient lighting\n\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n\n          ","\n          ","\n          ","\n          ","\n          ","\n          gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        }\n      "])),e.receiveShadows&&!e.renderOccluded?"readShadowMap(vpos, linearDepth)":e.spherical&&e.shading?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0",X?(0,we.H)(m||(m=(0,W.Z)(["\n              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);\n              vec4 overlayColor = overlayOpacity * overlayColorOpaque;\n              ","\n              vec4 groundColor = tileColor;\n              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;"])),e.invisible?(0,we.H)(_||(_=(0,W.Z)(["if (overlayColor.a == 0.0) { discard; }"]))):""):"",e.atmosphere?(0,we.H)(y||(y=(0,W.Z)(["\n              float ndotl = clamp(vndl, 0.0, 1.0);\n              vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));\n              atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); // avoid atmosphere on bright base maps\n              atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe\n              atm *= tileColor.a; // premultiply with tile alpha"]))):"",e.atmosphere?(0,we.H)(g||(g=(0,W.Z)(["atm + tileColor.rgb;"]))):(0,we.H)(b||(b=(0,W.Z)(["tileColor.rgb;"]))),e.pbrMode===ve.f7.Terrain||e.pbrMode===ve.f7.TerrainWithWater?(0,we.H)(w||(w=(0,W.Z)(["gl_FragColor = vec4(evaluateTerrainLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);"]))):(0,we.H)(C||(C=(0,W.Z)(["gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);"]))),J?(0,we.H)(x||(x=(0,W.Z)(["\n              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);\n              float waterNormalLength = length(overlayWaterMask);\n              if (waterNormalLength > 0.95) {\n                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);\n                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);\n                vec4 viewPosition = view*vec4(vpos, 1.0);\n                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);\n                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));\n                float opacity = sliced ? sliceOpacity : 1.0;\n                // un-gamma the ground color to mix in linear space\n                gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;\n              }"]))):"",e.screenSizePerspective?(0,we.H)(T||(T=(0,W.Z)(["\n            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));\n            if (perspectiveScale <= 0.25) {\n              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);\n            }\n            else if (perspectiveScale <= 0.5) {\n              gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);\n            }\n            else if (perspectiveScale >= 0.99) {\n              gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);\n            }\n            else {\n              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);\n            }"]))):"",e.visualizeNormals?e.spherical?(0,we.H)(S||(S=(0,W.Z)(["\n                  vec3 localUp = normalize(vpos + localOrigin);\n                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));\n                  vec3 forward = normalize(cross(localUp, right));\n                  mat3 tbn = mat3(right, forward, localUp);\n                  vec3 tNormal = normalize(normal * tbn);\n                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):(0,we.H)(k||(k=(0,W.Z)(["\n                  vec3 tNormal = normalize(normal);\n                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);\n              "]))):"",e.tileBorders?(0,we.H)(P||(P=(0,W.Z)(["\n              vec2 dVuv = fwidth(vuv0);\n              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));\n              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);\n              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);"]))):""));break;case ne.H.Depth:X&&t.include(ye.yl,e),t.include(ue.F,e),(0,te.Lm)(t),(0,te.Zu)(t),n.code.add((0,we.H)(R||(R=(0,W.Z)(["\n              void main(void) {\n                ","\n                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n              }\n          "])),X?(0,we.H)(A||(A=(0,W.Z)(["setOverlayVTC(getUV0());"]))):"")),j.code.add((0,we.H)(E||(E=(0,W.Z)(["\n              void main() {\n                ","\n                outputDepth(linearDepth);\n              }\n          "])),X&&e.invisible?(0,we.H)(O||(O=(0,W.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case ne.H.Shadow:case ne.H.ShadowHighlight:case ne.H.ShadowExcludeHighlight:t.include(ue.F,e),(0,te.Lm)(t),(0,te.Zu)(t),n.code.add((0,we.H)(M||(M=(0,W.Z)(["void main(void) {\ngl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);\n}"])))),j.code.add((0,we.H)(Z||(Z=(0,W.Z)(["void main() {\noutputDepth(linearDepth);\n}"]))));break;case ne.H.Normal:X&&t.include(ye.yl,e),q.add("vnormal","vec3"),(0,ge._8)(n),Y(),n.code.add((0,we.H)(I||(I=(0,W.Z)(["\n            void main(void) {\n              ","\n              gl_Position = transformPosition(proj, view, position);\n              vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);\n            }\n        "])),X?(0,we.H)(D||(D=(0,W.Z)(["setOverlayVTC(getUV0());"]))):"")),j.code.add((0,we.H)(L||(L=(0,W.Z)(["\n            void main() {\n              ","\n              vec3 normal = normalize(vnormal);\n              if (gl_FrontFacing == false) {\n                normal = -normal;\n              }\n              gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);\n            }\n        "])),X&&e.invisible?(0,we.H)(N||(N=(0,W.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""));break;case ne.H.Highlight:X&&t.include(ye.yl,e),n.code.add((0,we.H)(F||(F=(0,W.Z)(["\n          void main() {\n            ","\n            gl_Position = transformPosition(proj, view, position);\n          }\n        "])),X?(0,we.H)(U||(U=(0,W.Z)(["setOverlayVTC(getUV0());"]))):"")),t.include(ce.bA,e),j.code.add((0,we.H)(V||(V=(0,W.Z)(["\n          void main() {\n            ","\n            outputHighlight();\n          }\n        "])),X?(0,we.H)(H||(H=(0,W.Z)(["if (getCombinedOverlayColor().a == 0.0) { discard; }"]))):""))}return e.output===ne.H.ObjectAndLayerIdColor&&(t.include(ye.yl,(0,G.Z)((0,G.Z)({},e),{},{pbrMode:ve.f7.Disabled})),n.code.add((0,we.H)(z||(z=(0,W.Z)(["void main(void) {\ngl_Position = transformPosition(proj, view, position);\nsetOverlayVTC(getUV0());\n}"])))),j.code.add((0,we.H)(B||(B=(0,W.Z)(["void main() {\ngl_FragColor = getOverlayColorTexel(vtcOverlay);\n}"]))))),t}var Pe=(0,J.c)(),Re=(0,$.c)(),Ae=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:Se,build:ke},Symbol.toStringTag,{value:"Module"}))},48976:function(e,t,n){n.d(t,{a:function(){return _},c:function(){return p},g:function(){return c},i:function(){return f},j:function(){return A},k:function(){return m},m:function(){return h},r:function(){return O},s:function(){return u}});var r=n(11873),i=n(98131),a=n(71353),o=n(26277),s=n(11186),l=n(90045);function u(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e}function c(e,t){var n=2*Math.acos(t[3]),r=Math.sin(n/2);return r>(0,o.g)()?(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r):(e[0]=1,e[1]=0,e[2]=0),n}function h(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],l=n[1],u=n[2],c=n[3];return e[0]=r*c+o*s+i*u-a*l,e[1]=i*c+o*l+a*s-r*u,e[2]=a*c+o*u+r*l-i*s,e[3]=o*c-r*s-i*l-a*u,e}function d(e,t,n,r){var i,a,s,l,u,c=t[0],h=t[1],d=t[2],f=t[3],p=n[0],v=n[1],m=n[2],_=n[3];return(a=c*p+h*v+d*m+f*_)<0&&(a=-a,p=-p,v=-v,m=-m,_=-_),1-a>(0,o.g)()?(i=Math.acos(a),s=Math.sin(i),l=Math.sin((1-r)*i)/s,u=Math.sin(r*i)/s):(l=1-r,u=r),e[0]=l*c+u*p,e[1]=l*h+u*v,e[2]=l*d+u*m,e[3]=l*f+u*_,e}function f(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n*n+r*r+i*i+a*a,s=o?1/o:0;return e[0]=-n*s,e[1]=-r*s,e[2]=-i*s,e[3]=a*s,e}function p(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function v(e,t){var n,r=t[0]+t[4]+t[8];if(r>0)n=Math.sqrt(r+1),e[3]=.5*n,n=.5/n,e[0]=(t[5]-t[7])*n,e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;n=Math.sqrt(t[3*i+i]-t[3*a+a]-t[3*o+o]+1),e[i]=.5*n,n=.5/n,e[3]=(t[3*a+o]-t[3*o+a])*n,e[a]=(t[3*a+i]+t[3*i+a])*n,e[o]=(t[3*o+i]+t[3*i+o])*n}return e}function m(e,t,n,r){var i=.5*Math.PI/180;t*=i,n*=i,r*=i;var a=Math.sin(t),o=Math.cos(t),s=Math.sin(n),l=Math.cos(n),u=Math.sin(r),c=Math.cos(r);return e[0]=a*l*c-o*s*u,e[1]=o*s*c+a*l*u,e[2]=o*l*u-a*s*c,e[3]=o*l*c+a*s*u,e}var _=l.c,y=l.s,g=l.a,b=h,w=l.b,C=l.d,x=l.l,T=l.e,S=T,k=l.f,P=k,R=l.n,A=l.g,E=l.h;function O(e,t,n){var r=(0,s.e)(t,n);return r<-.999999?((0,s.f)(M,Z,t),(0,s.u)(M)<1e-6&&(0,s.f)(M,I,t),(0,s.n)(M,M),u(e,M,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):((0,s.f)(M,t,n),e[0]=M[0],e[1]=M[1],e[2]=M[2],e[3]=1+r,R(e,e))}var M=(0,a.c)(),Z=(0,a.f)(1,0,0),I=(0,a.f)(0,1,0);var D=(0,i.a)(),L=(0,i.a)();var N=(0,r.c)();Object.freeze(Object.defineProperty({__proto__:null,add:g,calculateW:function(e,t){var n=t[0],r=t[1],i=t[2];return e[0]=n,e[1]=r,e[2]=i,e[3]=Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e},conjugate:p,copy:_,dot:C,equals:E,exactEquals:A,fromEuler:m,fromMat3:v,getAxisAngle:c,identity:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},invert:f,len:S,length:T,lerp:x,mul:b,multiply:h,normalize:R,random:function(e){var t=o.R,n=t(),r=t(),i=t(),a=Math.sqrt(1-n),s=Math.sqrt(n);return e[0]=a*Math.sin(2*Math.PI*r),e[1]=a*Math.cos(2*Math.PI*r),e[2]=s*Math.sin(2*Math.PI*i),e[3]=s*Math.cos(2*Math.PI*i),e},rotateX:function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l+o*s,e[1]=i*l+a*s,e[2]=a*l-i*s,e[3]=o*l-r*s,e},rotateY:function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l-a*s,e[1]=i*l+o*s,e[2]=a*l+r*s,e[3]=o*l-i*s,e},rotateZ:function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l+i*s,e[1]=i*l-r*s,e[2]=a*l+o*s,e[3]=o*l-a*s,e},rotationTo:O,scale:w,set:y,setAxes:function(e,t,n,r){var i=N;return i[0]=n[0],i[3]=n[1],i[6]=n[2],i[1]=r[0],i[4]=r[1],i[7]=r[2],i[2]=-t[0],i[5]=-t[1],i[8]=-t[2],R(e,v(e,i))},setAxisAngle:u,slerp:d,sqlerp:function(e,t,n,r,i,a){return d(D,t,i,a),d(L,n,r,a),d(e,D,L,2*a*(1-a)),e},sqrLen:P,squaredLength:k,str:function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}},Symbol.toStringTag,{value:"Module"}))},4582:function(e,t,n){function r(){var e=new Float32Array(4);return e[3]=1,e}function i(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function a(e,t){return new Float32Array(e,t,4)}n.d(t,{a:function(){return a},b:function(){return i},c:function(){return r}});Object.freeze(Object.defineProperty({__proto__:null,clone:i,create:r,createView:a,fromValues:function(e,t,n,r){var i=new Float32Array(4);return i[0]=e,i[1]=t,i[2]=n,i[3]=r,i}},Symbol.toStringTag,{value:"Module"}))},8229:function(e,t,n){function r(){return new Float32Array(3)}function i(e){var t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function a(e,t,n){var r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=n,r}function o(e,t){return new Float32Array(e,t,3)}function s(){return r()}function l(){return a(1,1,1)}function u(){return a(1,0,0)}function c(){return a(0,1,0)}function h(){return a(0,0,1)}n.d(t,{a:function(){return o},b:function(){return i},c:function(){return r},f:function(){return a},z:function(){return s}});var d=s(),f=l(),p=u(),v=c(),m=h();Object.freeze(Object.defineProperty({__proto__:null,ONES:f,UNIT_X:p,UNIT_Y:v,UNIT_Z:m,ZEROS:d,clone:i,create:r,createView:o,fromValues:a,ones:l,unitX:u,unitY:c,unitZ:h,zeros:s},Symbol.toStringTag,{value:"Module"}))},151:function(e,t,n){function r(){return new Float32Array(4)}function i(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function a(e,t,n,r){var i=new Float32Array(4);return i[0]=e,i[1]=t,i[2]=n,i[3]=r,i}function o(){return r()}function s(){return a(1,1,1,1)}function l(){return a(1,0,0,0)}function u(){return a(0,1,0,0)}function c(){return a(0,0,1,0)}function h(){return a(0,0,0,1)}n.d(t,{c:function(){return i},f:function(){return a}});var d=o(),f=s(),p=l(),v=u(),m=c(),_=h();Object.freeze(Object.defineProperty({__proto__:null,ONES:f,UNIT_W:_,UNIT_X:p,UNIT_Y:v,UNIT_Z:m,ZEROS:d,clone:i,create:r,createView:function(e,t){return new Float32Array(e,t,4)},fromValues:a,ones:s,unitW:h,unitX:l,unitY:u,unitZ:c,zeros:o},Symbol.toStringTag,{value:"Module"}))},75409:function(e,t,n){n.d(t,{w:function(){return a}});var r,i,a={},o={get exports(){return a},set exports(e){a=e}};r=o,void 0!==(i=function(){var e=function(e){var t;window.console&&window.console.error?window.console.error(e):(t=e,window.console&&window.console.log&&window.console.log(t))},t={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},n=null,r=null;function i(e){if(null==n)for(var t in n={},r={},e)"number"==typeof e[t]&&(n[e[t]]=t,r[t]=e[t])}function a(){if(null==n)throw"WebGLDebugUtils.init(ctx) not called"}function o(e){a();var t=n[e];return void 0!==t?"gl."+t:"/*UNKNOWN WebGL ENUM*/ 0x"+e.toString(16)}function s(e,n,i,a){var s;if(void 0!==(s=t[e])&&void 0!==(s=s[n])&&s[i]){if("object"==typeof s[i]&&void 0!==s[i].enumBitwiseOr){for(var l=s[i].enumBitwiseOr,u=0,c=[],h=0;h<l.length;++h){var d=r[l[h]];0!=(a&d)&&(u|=d,c.push(o(d)))}return u===a?c.join(" | "):o(a)}return o(a)}return null===a?"null":void 0===a?"undefined":a.toString()}function l(e,t,n){e.__defineGetter__(n,(function(){return t[n]})),e.__defineSetter__(n,(function(e){t[n]=e}))}function u(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS),n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n);for(var r=0;r<t;++r)e.disableVertexAttribArray(r),e.vertexAttribPointer(r,4,e.FLOAT,!1,0,0),e.vertexAttrib1f(r,0);e.deleteBuffer(n);var i=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(r=0;r<i;++r)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);for(e.activeTexture(e.TEXTURE0),e.useProgram(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.DITHER),e.disable(e.SCISSOR_TEST),e.blendColor(0,0,0,0),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(-1),e.colorMask(!0,!0,!0,!0),e.cullFace(e.BACK),e.depthFunc(e.LESS),e.depthMask(!0),e.depthRange(0,1),e.frontFace(e.CCW),e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE),e.lineWidth(1),e.pixelStorei(e.PACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.UNPACK_COLORSPACE_CONVERSION_WEBGL&&e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),e.polygonOffset(0,0),e.sampleCoverage(1,!1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilMask(4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);e.getError(););}return{init:i,mightBeEnum:function(e){return a(),void 0!==n[e]},glEnumToString:o,glFunctionArgToString:s,glFunctionArgsToString:function(e,t){for(var n="",r=t.length,i=0;i<r;++i)n+=(0==i?"":", ")+s(e,r,i,t[i]);return n},makeDebugContext:function t(n,r,a,u){u=u||n,i(n),r=r||function(t,n,r){for(var i="",a=r.length,l=0;l<a;++l)i+=(0==l?"":", ")+s(n,a,l,r[l]);e("WebGL error "+o(t)+" in "+n+"("+i+")")};var c={};function h(e,t){return function(){a&&a(t,arguments);var n=e[t].apply(e,arguments),i=u.getError();return 0!=i&&(c[i]=!0,r(i,t,arguments)),n}}var d={};for(var f in n)if("function"==typeof n[f])if("getExtension"!=f)d[f]=h(n,f);else{var p=h(n,f);d[f]=function(){return t(p.apply(n,arguments),r,a,u)}}else l(d,n,f);return d.getError=function(){for(var e in c)if(c.hasOwnProperty(e)&&c[e])return c[e]=!1,e;return n.NO_ERROR},d},makeLostContextSimulatingCanvas:function(e){var t,n,r=[],i=[],a={},o=1,s=!1,c=[],h=0,d=0,f=!1,p=0,v={};function m(e){return"function"==typeof e?e:function(t){e.handleEvent(t)}}e.getContext=(n=e.getContext,function(){var r=n.apply(e,arguments);if(r instanceof WebGLRenderingContext){if(r!=t){if(t)throw"got different context";a=C(t=r)}return a}return r});var _=function(e){r.push(m(e))},y=function(e){i.push(m(e))};function g(){++d,s||h==d&&e.loseContext()}function b(e,t){var n=e[t];return function(){if(g(),!s)return n.apply(e,arguments)}}function w(e){return{statusMessage:e,preventDefault:function(){f=!0}}}return function(e){var t=e.addEventListener;e.addEventListener=function(n,r,i){switch(n){case"webglcontextlost":_(r);break;case"webglcontextrestored":y(r);break;default:t.apply(e,arguments)}}}(e),e.loseContext=function(){if(!s){for(s=!0,h=0,++o;t.getError(););(function(){for(var e=Object.keys(v),t=0;t<e.length;++t)delete v[e]})(),v[t.CONTEXT_LOST_WEBGL]=!0;var n=w("context lost"),i=r.slice();setTimeout((function(){for(var t=0;t<i.length;++t)i[t](n);p>=0&&setTimeout((function(){e.restoreContext()}),p)}),0)}},e.restoreContext=function(){s&&i.length&&setTimeout((function(){if(!f)throw"can not restore. webglcontestlost listener did not call event.preventDefault";(function(){for(var e=0;e<c.length;++e){var n=c[e];n instanceof WebGLBuffer?t.deleteBuffer(n):n instanceof WebGLFramebuffer?t.deleteFramebuffer(n):n instanceof WebGLProgram?t.deleteProgram(n):n instanceof WebGLRenderbuffer?t.deleteRenderbuffer(n):n instanceof WebGLShader?t.deleteShader(n):n instanceof WebGLTexture&&t.deleteTexture(n)}})(),u(t),s=!1,d=0,f=!1;for(var e=i.slice(),n=w("context restored"),r=0;r<e.length;++r)e[r](n)}),0)},e.loseContextInNCalls=function(e){if(s)throw"You can not ask a lost contet to be lost";h=d+e},e.getNumCalls=function(){return d},e.setRestoreTimeout=function(e){p=e},e;function C(e){for(var n in e)"function"==typeof e[n]?a[n]=b(e,n):l(a,e,n);a.getError=function(){if(g(),!s)for(;e=t.getError();)v[e]=!0;for(var e in v)if(v[e])return delete v[e],e;return a.NO_ERROR};for(var r=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],i=0;i<r.length;++i){var u=r[i];a[u]=function(t){return function(){if(g(),s)return null;var n=t.apply(e,arguments);return n.__webglDebugContextLostId__=o,c.push(n),n}}(e[u])}var h=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(i=0;i<h.length;++i)a[u=h[i]]=function(t){return function(){return g(),s?null:t.apply(e,arguments)}}(a[u]);var d=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(i=0;i<d.length;++i)a[u=d[i]]=function(t){return function(){return g(),!s&&t.apply(e,arguments)}}(a[u]);return a.checkFramebufferStatus=function(t){return function(){return g(),s?a.FRAMEBUFFER_UNSUPPORTED:t.apply(e,arguments)}}(a.checkFramebufferStatus),a.getAttribLocation=function(t){return function(){return g(),s?-1:t.apply(e,arguments)}}(a.getAttribLocation),a.getVertexAttribOffset=function(t){return function(){return g(),s?0:t.apply(e,arguments)}}(a.getVertexAttribOffset),a.isContextLost=function(){return s},a}},resetToInitialState:u}}())&&(r.exports=i)},15909:function(e,t,n){n.d(t,{D:function(){return i}});var r=n(80292);function i(e){e&&e.writtenProperties&&e.writtenProperties.forEach((function(e){var t=e.target,n=e.propName,i=e.newOrigin;(0,r.l)(t)&&i&&t.originOf(n)!==i&&t.updateOrigin(n,i)}))}},80292:function(e,t,n){function r(e){return e&&"getAtOrigin"in e&&"originOf"in e}n.d(t,{l:function(){return r}})},46798:function(e,t,n){n.d(t,{q:function(){return f}});var r=n(37762),i=n(1413),a=n(15671),o=n(43144),s=n(63780),l=n(42537),u=n(32718),c=n(92026),h=n(66978),d=n(31009),f=function(){function e(t,n,o,s){var l=this,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};(0,a.Z)(this,e),this._mainMethod=n,this._transferLists=o,this._listeners=[],this._promise=(0,d.bA)(t,(0,i.Z)((0,i.Z)({},c),{},{schedule:s})).then((function(e){if(void 0===l._thread){l._thread=e,l._promise=null,c.hasInitialize&&l.broadcast({},"initialize");var t,n=(0,r.Z)(l._listeners);try{for(n.s();!(t=n.n()).done;){var i=t.value;l._connectListener(i)}}catch(a){n.e(a)}finally{n.f()}}else e.close()})),this._promise.catch((function(e){return u.Z.getLogger("esri.core.workers.WorkerHandle").error("Failed to initialize ".concat(t," worker: ").concat(e))}))}return(0,o.Z)(e,[{key:"on",value:function(e,t){var n=this,r={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(r),this._connectListener(r),(0,l.kB)((function(){r.removed=!0,(0,s.Od)(n._listeners,r),n._thread&&(0,c.pC)(r.threadHandle)&&r.threadHandle.remove()}))}},{key:"destroy",value:function(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}},{key:"invoke",value:function(e,t){return this.invokeMethod(this._mainMethod,e,t)}},{key:"invokeMethod",value:function(e,t,n){var r=this;if(this._thread){var i=this._transferLists[e],a=i?i(t):[];return this._thread.invoke(e,t,{transferList:a,signal:n})}return this._promise?this._promise.then((function(){return(0,h.k_)(n),r.invokeMethod(e,t,n)})):Promise.reject(null)}},{key:"broadcast",value:function(e,t){var n=this;return this._thread?Promise.all(this._thread.broadcast(t,e)).then((function(){})):this._promise?this._promise.then((function(){return n.broadcast(e,t)})):Promise.reject()}},{key:"promise",get:function(){return this._promise}},{key:"_connectListener",value:function(e){this._thread&&this._thread.on(e.eventName,e.callback).then((function(t){e.removed||(e.threadHandle=t)}))}}]),e}()},45238:function(e,t,n){n.d(t,{EU:function(){return d},Ue:function(){return s},WH:function(){return f},ZZ:function(){return h},qC:function(){return c},uT:function(){return l},zk:function(){return u}});var r=n(16889),i=n(48976),a=n(98131),o=n(11186);function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v;return[e[0],e[1],e[2],e[3]]}function l(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:s();return(0,o.c)(n,e),n[3]=t,n}function u(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:s();return(0,o.f)(n,e,t),(0,o.n)(n,n),n[3]=-(0,o.v)(e,t),n}function c(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:s();return(0,i.s)(m,e,f(e)),(0,i.s)(_,t,f(t)),(0,i.m)(m,_,m),p(n,(0,r.BV)((0,i.g)(n,m)))}function h(e){return e}function d(e){return e[3]}function f(e){return(0,r.Vl)(e[3])}function p(e,t){return e[3]=t,e}var v=[0,0,1,0],m=(0,a.a)(),_=(0,a.a)();s()},85305:function(e,t,n){n.d(t,{BR:function(){return w},E2:function(){return E},Is:function(){return T},Kf:function(){return b},NE:function(){return k},P0:function(){return g},Tz:function(){return A},Ue:function(){return d},ej:function(){return C},id:function(){return x},pb:function(){return y},pt:function(){return m},qf:function(){return f},rF:function(){return S},yS:function(){return R}});var r=n(14226),i=n(11186),a=n(71353),o=n(83448),s=n(78952),l=n(29691),u=n(14320),c=n(82218),h=n(23470);function d(e){var t=e.value,n=e.operations;return{operations:n,value:n.create(t)}}function f(e,t,n){return e.operations.setExtent(e.value,t,n.value),n}function p(e){return{operations:e,value:e.create()}}function v(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:p(e);return n.operations=e,e.copy(t,n.value),n}function m(e){return v(h.s,(0,h.f)(0,0,0,(0,o.Iu)(e).radius))}var _=Math.pow(2,50);function y(){return v(c.b,(0,c.f)([0,0,0],[_,0,0],[0,_,0]))}function g(e,t,n){return e.operations.axisAt(e.value,t,u.R.Z,n)}function b(e,t,n,r){return e.operations.axisAt(e.value,t,n,r)}function w(e,t,n){return e.operations.intersectRay(e.value,t,n)}function C(e,t,n){return e.operations.intersectRayClosestSilhouette(e.value,t,n)}function x(e,t){return e.operations.altitudeAt(e.value,t)}function T(e,t,n,r){return e.operations.setAltitudeAt(e.value,t,n,r)}function S(e,t,n,a){return t!==a&&(0,r.c)(a,t),(0,i.s)(P,a[12],a[13],a[14]),T(e,P,n,P),a[12]=P[0],a[13]=P[1],a[14]=P[2],a}function k(e,t,n){return e.operations.elevate(e.value,t,n.value)}var P=(0,a.c)();function R(e,t,n,r,a){return a[0]=(0,i.e)(e,t),a[1]=(0,i.e)(e,n),a[2]=(0,i.e)(e,r),a}function A(e,t,n,r,a){(0,i.c)(n,e),(0,i.c)(O,t),(0,i.n)(O,O),(0,i.f)(r,O,n),(0,i.f)(a,r,n)}function E(e,t){return e?(0,l.rS)(t):t.isGeographic?s.Z.PlateCarree:t}var O=(0,a.c)()},58971:function(e,t,n){n.d(t,{G6:function(){return S},Ie:function(){return T},J9:function(){return C},RF:function(){return y},U1:function(){return x},vY:function(){return u},ym:function(){return w}});var r=n(29439),i=n(92026),a=n(77981);var o=function(e,t,n){return[t,n]},s=function(e,t,n){return[t,n,e[2]]},l=function(e,t,n){return[t,n,e[2],e[3]]};function u(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:(0,i.pC)(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function c(e,t){var n=e.scale,r=e.translate;return Math.round((t-r[0])/n[0])}function h(e,t){var n=e.scale,r=e.translate;return Math.round((r[1]-t)/n[1])}function d(e,t,n){for(var r,i,a,o,s=[],l=0;l<n.length;l++){var u=n[l];l>0?(a=c(e,u[0]),o=h(e,u[1]),a===r&&o===i||(s.push(t(u,a-r,o-i)),r=a,i=o)):(r=c(e,u[0]),i=h(e,u[1]),s.push(t(u,r,i)))}return s.length>0?s:null}function f(e,t){var n=e.scale,r=e.translate;return t*n[0]+r[0]}function p(e,t){var n=e.scale;return e.translate[1]-t*n[1]}function v(e,t,n){var i=new Array(n.length);if(!n.length)return i;var a=(0,r.Z)(e.scale,2),o=a[0],s=a[1],l=f(e,n[0][0]),u=p(e,n[0][1]);i[0]=t(n[0],l,u);for(var c=1;c<n.length;c++){var h=n[c];l+=h[0]*o,u-=h[1]*s,i[c]=t(h,l,u)}return i}function m(e,t,n){for(var r=new Array(n.length),i=0;i<n.length;i++)r[i]=v(e,t,n[i]);return r}function _(e,t,n,r,i){var a;return t.points=null!==(a=function(e,t,n,r){return d(e,n?r?l:s:r?s:o,t)}(e,n.points,r,i))&&void 0!==a?a:[],t}function y(e,t,n,r,i){return t.x=c(e,n.x),t.y=h(e,n.y),t!==n&&(r&&(t.z=n.z),i&&(t.m=n.m)),t}function g(e,t,n,r,i){var a=function(e,t,n,r){for(var i=[],a=n?r?l:s:r?s:o,u=0;u<t.length;u++){var c=d(e,a,t[u]);c&&c.length>=3&&i.push(c)}return i.length?i:null}(e,n.rings,r,i);return a?(t.rings=a,t):null}function b(e,t,n,r,i){var a=function(e,t,n,r){for(var i=[],a=n?r?l:s:r?s:o,u=0;u<t.length;u++){var c=d(e,a,t[u]);c&&c.length>=2&&i.push(c)}return i.length?i:null}(e,n.paths,r,i);return a?(t.paths=a,t):null}function w(e,t){return e&&t?(0,a.wp)(t)?y(e,{},t,!1,!1):(0,a.l9)(t)?b(e,{},t,!1,!1):(0,a.oU)(t)?g(e,{},t,!1,!1):(0,a.aW)(t)?_(e,{},t,!1,!1):(0,a.YX)(t)?function(e,t,n,r,i){return t.xmin=c(e,n.xmin),t.ymin=h(e,n.ymin),t.xmax=c(e,n.xmax),t.ymax=h(e,n.ymax),t!==n&&(r&&(t.zmin=n.zmin,t.zmax=n.zmax),i&&(t.mmin=n.mmin,t.mmax=n.mmax)),t}(e,{},t,!1,!1):null:null}function C(e,t,n,r,a){return(0,i.pC)(n)&&(t.points=function(e,t,n,r){return v(e,n?r?l:s:r?s:o,t)}(e,n.points,r,a)),t}function x(e,t,n,r,a){return(0,i.Wi)(n)||(t.x=f(e,n.x),t.y=p(e,n.y),t!==n&&(r&&(t.z=n.z),a&&(t.m=n.m))),t}function T(e,t,n,r,a){return(0,i.pC)(n)&&(t.rings=function(e,t,n,r){return m(e,n?r?l:s:r?s:o,t)}(e,n.rings,r,a)),t}function S(e,t,n,r,a){return(0,i.pC)(n)&&(t.paths=function(e,t,n,r){return m(e,n?r?l:s:r?s:o,t)}(e,n.paths,r,a)),t}},82582:function(e,t,n){n.d(t,{D9:function(){return s},DE:function(){return o},dp:function(){return a},yZ:function(){return i}});var r=n(68860);function i(e,t){var n=t||e.extent,i=e.width,a=(0,r.c9)(n&&n.spatialReference);return n&&i?n.width/i*a*r.hd*96:0}function a(e,t){return e/((0,r.c9)(t)*r.hd*96)}function o(e){return e/(96*r.hd)}function s(e,t){var n=e.extent,r=e.width-(e.padding?e.padding.left+e.padding.right:0),i=a(t,n.spatialReference);return n.clone().expand(i*r/n.width)}},34311:function(e,t,n){function r(e,t,n){return{objectId:e,target:t,distance:n,type:"vertex"}}function i(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];return{objectId:e,target:t,distance:n,type:"edge",start:r,end:i,draped:a}}n.d(t,{p:function(){return i},u:function(){return r}})},70178:function(e,t,n){n.d(t,{f:function(){return u},k:function(){return s}});n(93169);var r=n(92026),i=n(92975);function a(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++){var r=e[n],i=t[n];if(r.length!==i.length)return!1;for(var a=0;a<r.length;a++)if(r[a]!==i[a])return!1}return!0}function o(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!a(e[n],t[n]))return!1;return!0}function s(e,t){return e===t||(0,r.pC)(e)&&(0,r.pC)(t)&&(0,i.fS)(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function l(e,t){if(e===t)return!0;if((0,r.Wi)(e)||(0,r.Wi)(t))return!1;if(e.type!==t.type)return!1;switch(e.type){case"point":return s(e,t);case"extent":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,i.fS)(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}(e,t);case"polyline":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,i.fS)(e.spatialReference,t.spatialReference)&&o(e.paths,t.paths)}(e,t);case"polygon":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,i.fS)(e.spatialReference,t.spatialReference)&&o(e.rings,t.rings)}(e,t);case"multipoint":return function(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!(0,i.fS)(e.spatialReference,t.spatialReference)&&a(e.points,t.points)}(e,t);case"mesh":return!1;default:return}}function u(e,t){return e===t||null!=e&&null!=t&&e.objectId===t.objectId&&!!l(e.geometry,t.geometry)&&!!function(e,t){if(e===t)return!0;if(!e||!t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var i=0,a=n;i<a.length;i++){var o=a[i];if(e[o]!==t[o])return!1}return!0}(e.attributes,t.attributes)}},65618:function(e,t,n){n.d(t,{FS:function(){return S},MS:function(){return P},PA:function(){return g},Pj:function(){return y},R3:function(){return x},S6:function(){return _},TF:function(){return k},Tx:function(){return w},Wh:function(){return m},Xw:function(){return C},dF:function(){return T}});var r=n(37762),i=n(43144),a=n(15671),o=n(59896),s=(n(93169),n(92026)),l=n(18722),u=n(95439),c=n(78952),h=n(41414),d=n(65156),f=n(58971),p=n(27823),v=n(83040),m=(n(70178),(0,i.Z)((function e(t,n,r){(0,a.Z)(this,e),this.uid=t,this.geometry=n,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null})));function _(e){return(0,s.pC)(e.geometry)}var y=(0,i.Z)((function e(){(0,a.Z)(this,e),this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}));function g(e){var t,n,r=p.M.fromJSON(e.geometryType),i=c.Z.fromJSON(e.spatialReference),a=e.transform,o=e.features.map((function(t){var n=function(e,t,n,r){return{uid:(0,u.D)(),objectId:r&&e.attributes?e.attributes[r]:null,attributes:e.attributes,geometry:b(e.geometry,t,n),visible:!0}}(t,r,i,e.objectIdFieldName),o=n.geometry;if((0,s.pC)(o)&&a)switch(o.type){case"point":n.geometry=(0,f.U1)(a,o,o,o.hasZ,o.hasM);break;case"multipoint":n.geometry=(0,f.J9)(a,o,o,!!o.hasZ,!!o.hasM);break;case"polygon":n.geometry=(0,f.Ie)(a,o,o,!!o.hasZ,!!o.hasM);break;case"polyline":n.geometry=(0,f.G6)(a,o,o,!!o.hasZ,!!o.hasM);break;case"extent":case"mesh":n.geometry=o}return n}));return{geometryType:r,features:o,spatialReference:i,fields:null!==(t=null===(n=e.fields)||void 0===n?void 0:n.map((function(e){return v.Z.fromJSON(e)})))&&void 0!==t?t:[],objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}}function b(e,t,n){if((0,s.Wi)(e))return null;switch(t){case"point":var r=e;return{x:r.x,y:r.y,z:r.z,m:r.m,hasZ:null!=r.z,hasM:null!=r.m,type:"point",spatialReference:n};case"polyline":var i=e;return{paths:i.paths,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polyline",spatialReference:n};case"polygon":var a=e;return{rings:a.rings,hasZ:!!a.hasZ,hasM:!!a.hasM,type:"polygon",spatialReference:n};case"multipoint":var o=e;return{points:o.points,hasZ:!!o.hasZ,hasM:!!o.hasM,type:"multipoint",spatialReference:n}}}function w(e,t,n,r){return{x:e,y:t,z:n,hasZ:null!=n,hasM:!1,spatialReference:r,type:"point"}}function C(e){var t=32;return t+=(0,o.f2)(e.attributes),t+=3,t+=8+function(e){if((0,s.Wi)(e))return 0;var t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":var n,i=0,a=2+(e.hasZ?1:0)+(e.hasM?1:0),o="polyline"===e.type?e.paths:e.rings,u=(0,r.Z)(o);try{for(u.s();!(n=u.n()).done;)i+=n.value.length}catch(d){u.e(d)}finally{u.f()}t+=8*i*a+64,t+=128*i,t+=34,t+=32*(o.length+1);break;case"multipoint":var c=2+(e.hasZ?1:0)+(e.hasM?1:0),h=e.points.length;t+=8*h*c+64,t+=128*h,t+=34,t+=32;break;case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=(0,l.Xw)(e.vertexAttributes.position),t+=(0,l.Xw)(e.vertexAttributes.normal),t+=(0,l.Xw)(e.vertexAttributes.uv),t+=(0,l.Xw)(e.vertexAttributes.tangent)}return t}(e.geometry),t}function x(e){if((0,s.Wi)(e))return 0;switch(e.type){case"point":return 1;case"polyline":var t,n=0,i=(0,r.Z)(e.paths);try{for(i.s();!(t=i.n()).done;){n+=t.value.length}}catch(c){i.e(c)}finally{i.f()}return n;case"polygon":var a,o=0,l=(0,r.Z)(e.rings);try{for(l.s();!(a=l.n()).done;){o+=a.value.length}}catch(c){l.e(c)}finally{l.f()}return o;case"multipoint":return e.points.length;case"extent":return 2;case"mesh":var u=e.vertexAttributes&&e.vertexAttributes.position;return u?u.length/3:0;default:return}}function T(e){if((0,s.Wi)(e))return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":var t,n=(0,r.Z)(e.paths);try{for(n.s();!(t=n.n()).done;){if(t.value.length>0)return!0}}catch(o){n.e(o)}finally{n.f()}return!1;case"polygon":var i,a=(0,r.Z)(e.rings);try{for(a.s();!(i=a.n()).done;){if(i.value.length>0)return!0}}catch(o){a.e(o)}finally{a.f()}return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}}function S(e,t){switch((0,h.cS)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(var n=0;n<e.paths.length;n++)(0,h.Wi)(t,e.paths[n],!!e.hasZ);break;case"polygon":for(var r=0;r<e.rings.length;r++)(0,h.Wi)(t,e.rings[r],!!e.hasZ);break;case"multipoint":(0,h.Wi)(t,e.points,!!e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function k(e,t){switch((0,d.cS)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(var n=0;n<e.paths.length;n++)(0,d.Wi)(t,e.paths[n]);break;case"polygon":for(var r=0;r<e.rings.length;r++)(0,d.Wi)(t,e.rings[r]);break;case"multipoint":(0,d.Wi)(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function P(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}},8904:function(e,t,n){n.d(t,{G$:function(){return y},Tl:function(){return _}});var r=n(37762),i=n(60136),a=n(92572),o=n(15671),s=n(43144),l=(n(59486),n(93169),n(32718)),u=n(92026),c=n(68860),h=n(65156),d=n(81753),f=n(585),p=l.Z.getLogger("esri.layers.support.ElevationSampler"),v=function(){function e(){(0,o.Z)(this,e)}return(0,s.Z)(e,[{key:"queryElevation",value:function(e){return y(e.clone(),this)}},{key:"on",value:function(){return w}},{key:"projectIfRequired",value:function(e,t){return g(e,t)}}]),e}(),m=function(e){(0,i.Z)(n,e);var t=(0,a.Z)(n);function n(e,r,i){var a;(0,o.Z)(this,n),(a=t.call(this)).tile=e,a.noDataValue=i;var s=e.tile.extent;a.extent=(0,h.HH)(s,r.spatialReference),a.extent.zmin=e.zmin,a.extent.zmax=e.zmax,a._aaExtent=s;var l=(0,c.c9)(r.spatialReference),u=r.lodAt(e.tile.level).resolution*l;return a.demResolution={min:u,max:u},a}return(0,s.Z)(n,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"contains",value:function(e){var t=this.projectIfRequired(e,this.spatialReference);return!(0,u.Wi)(t)&&this.containsAt(t.x,t.y)}},{key:"containsAt",value:function(e,t){return(0,h.jE)(this._aaExtent,e,t)}},{key:"elevationAt",value:function(e,t){if(!this.containsAt(e,t)){var n=this.extent,r="".concat(n.xmin,", ").concat(n.ymin,", ").concat(n.xmax,", ").concat(n.ymax);return p.warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(r,")")),this.noDataValue}return(0,u.Pt)(this.tile.sample(e,t),this.noDataValue)}}]),n}(v),_=function(e){(0,i.Z)(n,e);var t=(0,a.Z)(n);function n(e,r,i){var a,s;(0,o.Z)(this,n),a=t.call(this),"number"==typeof r?(a.noDataValue=r,s=null):(s=r,a.noDataValue=i),a.samplers=s?e.map((function(e){return new m(e,s,a.noDataValue)})):e;var l=a.samplers[0];if(l){a.extent=l.extent.clone();var u=l.demResolution,c=u.min,d=u.max;a.demResolution={min:c,max:d};for(var f=1;f<a.samplers.length;f++){var p=a.samplers[f];a.extent.union(p.extent),a.demResolution.min=Math.min(a.demResolution.min,p.demResolution.min),a.demResolution.max=Math.max(a.demResolution.max,p.demResolution.max)}}else a.extent=(0,h.HH)((0,h.Ue)(),s.spatialReference),a.demResolution={min:0,max:0};return a}return(0,s.Z)(n,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"elevationAt",value:function(e,t){var n,i=(0,r.Z)(this.samplers);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a.containsAt(e,t))return a.elevationAt(e,t)}}catch(o){i.e(o)}finally{i.f()}return p.warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler")),this.noDataValue}}]),n}(v);function y(e,t){var n=g(e,t.spatialReference);if(!n)return null;switch(e.type){case"point":!function(e,t,n){e.z=n.elevationAt(t.x,t.y)}(e,n,t);break;case"polyline":!function(e,t,n){b.spatialReference=t.spatialReference;for(var r=e.hasM&&!e.hasZ,i=0;i<e.paths.length;i++)for(var a=e.paths[i],o=t.paths[i],s=0;s<a.length;s++){var l=a[s],u=o[s];b.x=u[0],b.y=u[1],r&&(l[3]=l[2]),l[2]=n.elevationAt(b.x,b.y)}e.hasZ=!0}(e,n,t);break;case"multipoint":!function(e,t,n){b.spatialReference=t.spatialReference;for(var r=e.hasM&&!e.hasZ,i=0;i<e.points.length;i++){var a=e.points[i],o=t.points[i];b.x=o[0],b.y=o[1],r&&(a[3]=a[2]),a[2]=n.elevationAt(b.x,b.y)}e.hasZ=!0}(e,n,t)}return e}function g(e,t){if((0,u.Wi)(e))return null;var n=e.spatialReference;if(n.equals(t))return e;var r=(0,d.iV)(e,t);return r||p.error("Cannot project geometry spatial reference (wkid:".concat(n.wkid,") to elevation sampler spatial reference (wkid:").concat(t.wkid,")")),r}var b=new f.Z,w={remove:function(){}}},11939:function(e,t,n){n.d(t,{K:function(){return a}});var r=n(43144),i=n(15671),a=(0,r.Z)((function e(t,n){(0,i.Z)(this,e),this.data=t,this.safeWidth=.99999999*(t.width-1),this.dx=(t.width-1)/(n[2]-n[0]),this.dy=(t.width-1)/(n[3]-n[1]),this.x0=n[0],this.y1=n[3]}))},48932:function(e,t,n){n.d(t,{v:function(){return s}});var r=n(37762),i=n(15671),a=n(43144),o=n(92026),s=function(){function e(t,n,r,a){(0,i.Z)(this,e),this._hasNoDataValues=null,this._minValue=null,this._maxValue=null,"pixelData"in t?(this.values=t.pixelData,this.width=t.width,this.height=t.height,this.noDataValue=t.noDataValue):(this.values=t,this.width=n,this.height=r,this.noDataValue=a)}return(0,a.Z)(e,[{key:"hasNoDataValues",get:function(){if((0,o.Wi)(this._hasNoDataValues)){var e=this.noDataValue;this._hasNoDataValues=this.values.includes(e)}return this._hasNoDataValues}},{key:"minValue",get:function(){return this._ensureBounds(),(0,o.Wg)(this._minValue)}},{key:"maxValue",get:function(){return this._ensureBounds(),(0,o.Wg)(this._maxValue)}},{key:"_ensureBounds",value:function(){if(!(0,o.pC)(this._minValue)){var e,t=this.noDataValue,n=this.values,i=1/0,a=-1/0,s=!0,l=(0,r.Z)(n);try{for(l.s();!(e=l.n()).done;){var u=e.value;u===t?this._hasNoDataValues=!0:(i=u<i?u:i,a=u>a?u:a,s=!1)}}catch(c){l.e(c)}finally{l.f()}s?(this._minValue=0,this._maxValue=0):(this._minValue=i,this._maxValue=a>-3e38?a:0)}}}]),e}()},41665:function(e,t,n){n.d(t,{w:function(){return c}});var r=n(15671),i=n(43144),a=n(60136),o=n(92572),s=n(92026),l=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return(0,r.Z)(this,n),(e=t.call(this,"LercWorker","_decode",{_decode:function(e){return[e.buffer]}},i,{strategy:"dedicated"})).schedule=i,e.ref=0,e}return(0,i.Z)(n,[{key:"decode",value:function(e,t,n){return e&&0!==e.byteLength?this.invoke({buffer:e,options:t},n):Promise.resolve(null)}},{key:"release",value:function(){var e=this;--this.ref<=0&&(u.forEach((function(t,n){t===e&&u.delete(n)})),this.destroy())}}]),n}(n(46798).q),u=new Map;function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=u.get((0,s.Wg)(e));return t||((0,s.pC)(e)?(t=new l((function(t){return e.immediate.schedule(t)})),u.set(e,t)):(t=new l,u.set(null,t))),++t.ref,t}},12322:function(e,t,n){n.d(t,{UK:function(){return s},qo:function(){return u}});var r=n(74165),i=n(15861),a=n(92026),o=n(21149);function s(e,t,n){return l.apply(this,arguments)}function l(){return l=(0,i.Z)((0,r.Z)().mark((function e(t,n,i){var o,s,l,h;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=n.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(n.maxRecordCountFactor=c(t)),o=u(t),s=t.capabilities.query.supportsPagination,n.start=0,n.num=o,l=null;case 4:return e.next=6,t.source.queryFeaturesJSON(n,i);case 6:if(h=e.sent,(0,a.Wi)(l)?l=h:l.features=l.features.concat(h.features),l.exceededTransferLimit=h.exceededTransferLimit,s&&h.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:n.start+=o;case 10:e.next=4;break;case 12:return e.abrupt("return",l);case 13:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}function u(e){return c(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function c(e){return e.capabilities.query.supportsMaxRecordCountFactor?o.Z.MAX_MAX_RECORD_COUNT_FACTOR:1}},16553:function(e,t,n){n.r(t),n.d(t,{createLabelFunction:function(){return _},formatField:function(){return g}});var r=n(74165),i=n(37762),a=n(15861),o=n(10064),s=n(32718),l=n(92026),u=n(76969),c=n(6291),h=n(80031),d=n(93253),f=n(819),p=s.Z.getLogger("esri.layers.support.labelFormatUtils"),v={type:"simple",evaluate:function(){return null}},m={getAttribute:function(e,t){return e.field(t)}};function _(e,t,n){return y.apply(this,arguments)}function y(){return y=(0,a.Z)((0,r.Z)().mark((function e(t,i,a){var s,u,c,h,_,y,b;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.symbol&&i){e.next=2;break}return e.abrupt("return",v);case 2:if(s=t.where,u=(0,d.hV)(t),!s){e.next=10;break}return e.next=7,Promise.all([n.e(48562),n.e(33751)]).then(n.bind(n,48562));case 7:e.t0=e.sent,e.next=11;break;case 10:e.t0=null;case 11:if(c=e.t0,"arcade"!==u.type){e.next=21;break}return e.next=15,(0,f.WW)(u.expression,a,i);case 15:if(_=e.sent,!(0,l.Wi)(_)){e.next=18;break}return e.abrupt("return",v);case 18:h={type:"arcade",evaluate:function(e){try{var t=_.evaluate({$feature:"attributes"in e?_.repurposeFeature(e):e});if(null!=t)return t.toString()}catch(i){p.error(new o.Z("arcade-expression-error","Encountered an error when evaluating label expression for feature",{feature:e,expression:u}))}return null},needsHydrationToEvaluate:function(){return null==(0,d.el)(u.expression)}},e.next=22;break;case 21:h={type:"simple",evaluate:function(e){return u.expression.replace(/{[^}]*}/g,(function(t){var n=t.slice(1,-1),r=i.get(n);if(!r)return t;var a=null;return"attributes"in e?e&&e.attributes&&(a=e.attributes[r.name]):a=e.field(r.name),null==a?"":g(a,r)}))}};case 22:if(!s){e.next=32;break}e.prev=23,y=c.WhereClause.create(s,i),e.next=30;break;case 27:return e.prev=27,e.t1=e.catch(23),e.abrupt("return",(p.error(new o.Z("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:s,error:e.t1})),v));case 30:b=h.evaluate,h.evaluate=function(e){var t="attributes"in e?void 0:m;try{if(y.testFeature(e,t))return b(e)}catch(n){p.error(new o.Z("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:s,feature:e,error:n}))}return null};case 32:return e.abrupt("return",h);case 33:case"end":return e.stop()}}),e,null,[[23,27]])}))),y.apply(this,arguments)}function g(e,t){if(null==e)return"";var n=t.domain;if(n)if("codedValue"===n.type||"coded-value"===n.type){var r,a=e,o=(0,i.Z)(n.codedValues);try{for(o.s();!(r=o.n()).done;){var s=r.value;if(s.code===a)return s.name}}catch(v){o.e(v)}finally{o.f()}}else if("range"===n.type){var l=+e,d="range"in n?n.range[0]:n.minValue,f="range"in n?n.range[1]:n.maxValue;if(d<=l&&l<=f)return n.name}var p=e;return"date"===t.type||"esriFieldTypeDate"===t.type?p=(0,u.p6)(p,(0,u.Ze)("short-date")):(0,h.H7)(t)&&(p=(0,c.uf)(+p)),p||""}},70630:function(e,t,n){n.r(t),n.d(t,{default:function(){return se}});var r=n(93433),i=n(37762),a=n(74165),o=n(15861),s=n(15671),l=n(43144),u=n(11752),c=n(61120),h=n(60136),d=n(92572),f=n(27366),p=n(44927),v=n(32718),m=n(49861),_=(n(25243),n(63780),n(69912)),y=n(64326),g=n(12322),b=n(1413),w=n(76200),C=n(10064),x=n(54472),T=n(92026),S=n(97642),k=n(66978),P=n(35995),R=n(53866),A=n(78952),E=n(56601),O=n(25899),M=(n(93169),n(43404)),Z=n(27135),I=n(64267),D=(0,M.w)()({Pending:"job-waiting",InProgress:"job-executing",Completed:"job-succeeded"}),L=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).featureServiceUrl=null,r.statusUrl=null,r.status=null,r.submissionTime=null,r.lastUpdatedTime=null,r._timer=void 0,r}return(0,l.Z)(n,[{key:"destroy",value:function(){clearInterval(this._timer)}},{key:"checkJobStatus",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,i,o,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,b.Z)((0,b.Z)({},t),{},{query:{f:"json"}}),e.next=3,(0,w.default)(this.statusUrl,n);case 3:return r=e.sent,i=r.data,this.read(i),(this.serviceEdits||this.exceededTransferLimit)&&this.featureServiceUrl&&(s={edits:null,addedFeatures:[],updatedFeatures:[],deletedFeatures:[],addedAttachments:[],updatedAttachments:[],deletedAttachments:[],exceededTransferLimit:!0},E.dU.emit("edits",{serviceUrl:null!==(o=this.featureServiceUrl)&&void 0!==o?o:"",layerId:null,event:s})),e.abrupt("return",this);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"waitForJobCompletion",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,n,r,i,o=this,s=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:{},n=t.interval,r=void 0===n?1e3:n,i=t.statusCallback,e.abrupt("return",new Promise((function(e,t){o._clearTimer();var n=setInterval((function(){o._timer||t((0,k.zE)()),o.checkJobStatus().then((function(t){var n=t.status;switch(o.status=n,n){case"job-succeeded":o._clearTimer(),e(o);break;case"job-waiting":case"job-executing":i&&i(o)}}),(function(e){o._clearTimer(),t(e)}))}),r);o._timer=n})));case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"_clearTimer",value:function(){clearInterval(this._timer),this._timer=void 0}}]),n}(I.Z);(0,f._)([(0,m.Cb)()],L.prototype,"featureServiceUrl",void 0),(0,f._)([(0,m.Cb)({type:String,json:{write:!0}})],L.prototype,"statusUrl",void 0),(0,f._)([(0,Z.J)(D)],L.prototype,"status",void 0),(0,f._)([(0,m.Cb)({type:Date,json:{type:Number,write:{writer:function(e,t){t.submissionTime=e?e.getTime():null}}}})],L.prototype,"submissionTime",void 0),(0,f._)([(0,m.Cb)({type:Date,json:{type:Number,write:{writer:function(e,t){t.lastUpdatedTime=e?e.getTime():null}}}})],L.prototype,"lastUpdatedTime",void 0);var N=L=(0,f._)([(0,_.j)("esri.networks.support.TopologyValidationJobInfo")],L),F=n(98995);n(49818);function U(e,t){return V.apply(this,arguments)}function V(){return V=(0,o.Z)((0,a.Z)().mark((function e(t,r){var i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("Utility Network Layer"!==t){e.next=6;break}return e.next=3,Promise.resolve().then(n.bind(n,70630));case 3:return i=e.sent,o=i.default,e.abrupt("return",new o({layerUrl:r}));case 6:return e.abrupt("return",null);case 7:case"end":return e.stop()}}),e)}))),V.apply(this,arguments)}function H(){return H=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,i,o,s,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return!(n="portalItem"in t?t:{portalItem:t}).portalItem||n.portalItem instanceof F.default||(n=(0,b.Z)((0,b.Z)({},n),{},{portalItem:new F.default(n.portalItem)})),r=n.portalItem,e.next=5,r.load();case 5:if("Feature Service"===r.type){e.next=7;break}throw new C.Z("portal:unknown-item-type","Unknown item type '${type}'",{type:r.type});case 7:return i=r.url,e.next=10,(0,w.default)(i,{responseType:"json",query:{f:"json"}});case 10:if(o=e.sent,s="Network Layer",!o.data.type||!o.data.type.includes(s)){e.next=14;break}return e.abrupt("return",U(o.data.type,i));case 14:if(!o.data.layers){e.next=19;break}if(l=o.data.layers.find((function(e){return e.type.includes(s)})),!l){e.next=19;break}return u="".concat(i,"/").concat(l.id),e.abrupt("return",U(l.type,u));case 19:return e.abrupt("return",null);case 20:case"end":return e.stop()}}),e)}))),H.apply(this,arguments)}var z=n(46784),B=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).globalIds=[],r.creators=[],r.tags=[],r.names=[],r}return(0,l.Z)(n)}(z.wq);(0,f._)([(0,m.Cb)({type:[String],json:{write:!0}})],B.prototype,"globalIds",void 0),(0,f._)([(0,m.Cb)({type:[String],json:{write:!0}})],B.prototype,"creators",void 0),(0,f._)([(0,m.Cb)({type:[String],json:{write:!0}})],B.prototype,"tags",void 0),(0,f._)([(0,m.Cb)({type:[String],json:{write:!0}})],B.prototype,"names",void 0);var G=B=(0,f._)([(0,_.j)("esri.rest.networks.support.QueryNamedTraceConfigurationsParameters")],B),W=function(e){(0,h.Z)(r,e);var t=(0,d.Z)(r);function r(e){var n;return(0,s.Z)(this,r),(n=t.call(this,e)).id=null,n.title=null,n.layerUrl=null,n.dataElement=null,n.fullExtent=null,n.spatialReference=null,n.type=null,n.sourceJSON=null,n}return(0,l.Z)(r,[{key:"initialize",value:function(){var e=this;this.when().catch((function(t){var n,r;(0,k.D_)(t)||v.Z.getLogger(e.declaredClass).error("#load()","Failed to load layer (title: '".concat(null!==(n=e.title)&&void 0!==n?n:"no title","', id: '").concat(null!==(r=e.id)&&void 0!==r?r:"no id","')"),{error:t})}))}},{key:"datasetName",get:function(){var e,t;return null!==(e=null===(t=this.dataElement)||void 0===t?void 0:t.name)&&void 0!==e?e:null}},{key:"owner",get:function(){var e,t;return null!==(e=null===(t=this.dataElement)||void 0===t?void 0:t.userIdentity)&&void 0!==e?e:null}},{key:"schemaGeneration",get:function(){var e,t;return null!==(e=null===(t=this.dataElement)||void 0===t?void 0:t.schemaGeneration)&&void 0!==e?e:null}},{key:"parsedUrl",get:function(){return(0,P.mN)(this.layerUrl)}},{key:"featureServiceUrl",get:function(){var e=this.parsedUrl&&(0,O.Qc)(this.parsedUrl.path);return(0,T.pC)(e)?e.url.path:null}},{key:"networkServiceUrl",get:function(){return this.featureServiceUrl?this.featureServiceUrl.replace(/\/FeatureServer/i,"/UtilityNetworkServer"):null}},{key:"layerId",get:function(){var e=this.parsedUrl&&(0,O.Qc)(this.parsedUrl.path);return(0,T.pC)(e)?e.sublayer:null}},{key:"networkSystemLayers",get:function(){return null}},{key:"load",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(this.addResolvingPromise(this._fetchDataElement(this.featureServiceUrl,this.layerId.toString(),t)),this.addResolvingPromise(this._fetchLayerMetaData(this.layerUrl,t)),this));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getLayerIdBySourceId",value:function(e){if(this.dataElement){var t,n=this.dataElement.domainNetworks,r=(0,i.Z)(n);try{for(r.s();!(t=r.n()).done;){var a,o=t.value,s=(0,i.Z)(o.edgeSources?o.edgeSources:[]);try{for(s.s();!(a=s.n()).done;){var l=a.value;if(l.sourceId===e)return l.layerId}}catch(d){s.e(d)}finally{s.f()}var u,c=(0,i.Z)(o.junctionSources?o.junctionSources:[]);try{for(c.s();!(u=c.n()).done;){var h=u.value;if(h.sourceId===e)return h.layerId}}catch(d){c.e(d)}finally{c.f()}}}catch(d){r.e(d)}finally{r.f()}return null}return null}},{key:"queryNamedTraceConfigurations",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,r){var i,o,s,l,u,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.e(59154).then(n.bind(n,59154));case 2:return s=e.sent,l=s.queryNamedTraceConfigurations,u=this.networkServiceUrl,c=new G((0,b.Z)({},t)),e.next=8,l(u,c,(0,b.Z)({},r));case 8:if(e.t2=o=e.sent,e.t1=null===e.t2,e.t1){e.next=12;break}e.t1=void 0===o;case 12:if(!e.t1){e.next=16;break}e.t3=void 0,e.next=17;break;case 16:e.t3=o.namedTraceConfigurations;case 17:if(e.t4=i=e.t3,e.t0=null!==e.t4,!e.t0){e.next=21;break}e.t0=void 0!==i;case 21:if(!e.t0){e.next=25;break}e.t5=i,e.next=26;break;case 25:e.t5=null;case 26:return e.abrupt("return",e.t5);case 27:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"validateTopology",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,r){var i,o,s,l,u,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.validateArea){e.next=2;break}throw new C.Z("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");case 2:return e.next=4,n.e(59130).then(n.bind(n,59130));case 4:return i=e.sent,o=i.validateNetworkTopology,s=this.networkServiceUrl,e.next=9,o(s,t,(0,b.Z)({},r));case 9:return null!==(l=e.sent)&&void 0!==l&&l.serviceEdits&&(c={edits:null,addedFeatures:[],updatedFeatures:[],deletedFeatures:[],addedAttachments:[],updatedAttachments:[],deletedAttachments:[],editedFeatures:l.serviceEdits,exceededTransferLimit:!1},E.dU.emit("edits",{serviceUrl:null!==(u=this.featureServiceUrl)&&void 0!==u?u:"",layerId:null,event:c})),e.abrupt("return",l);case 12:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"submitTopologyValidationJob",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,r){var i,o,s,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.validateArea){e.next=2;break}throw new C.Z("network:undefined-validateArea","the network must have validateArea defined in the validate network topology parameters.");case 2:if(t.gdbVersion){e.next=4;break}throw new C.Z("network:undefined-gdb-version","version must be defined");case 4:return e.next=6,n.e(59130).then(n.bind(n,59130));case 6:return i=e.sent,o=i.submitValidateNetworkTopologyJob,s=this.networkServiceUrl,e.next=11,o(s,t,(0,b.Z)({},r));case 11:return l=e.sent,e.abrupt("return",new N({statusUrl:l,featureServiceUrl:this.featureServiceUrl}));case 13:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_fetchLayerMetaData",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,w.default)(t,(0,b.Z)({responseType:"json",query:{f:"json"}},n));case 2:r=e.sent,this.sourceJSON=r.data,this.read(r.data,{origin:"service"});case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_fetchDataElement",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.dataElement){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,(0,w.default)("".concat(t,"/queryDataElements"),(0,b.Z)({responseType:"json",query:{layers:JSON.stringify([n]),f:"json"}},r)).then((function(e){var t;return null===(t=e.data.layerDataElements)||void 0===t?void 0:t[0]}));case 4:(i=e.sent)&&this.read(i,{origin:"service"});case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()}],[{key:"fromPortalItem",value:function(e){return function(e){return H.apply(this,arguments)}(e)}}]),r}((0,S.R)(x.Z));(0,f._)([(0,m.Cb)({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:!0}},read:!1}})],W.prototype,"id",void 0),(0,f._)([(0,m.Cb)({type:String,nonNullable:!0,json:{origins:{"web-map":{read:!0,write:{isRequired:!0}},service:{read:{source:"name"}}},read:!1}})],W.prototype,"title",void 0),(0,f._)([(0,m.Cb)({type:String,nonNullable:!0,json:{origins:{"web-map":{read:{source:"url"},write:{target:"url",isRequired:!0}}},read:!1}})],W.prototype,"layerUrl",void 0),(0,f._)([(0,m.Cb)({type:Object,json:{origins:{service:{read:!0}},read:!1}})],W.prototype,"dataElement",void 0),(0,f._)([(0,m.Cb)({type:R.Z,json:{origins:{service:{read:{source:"extent"}}},read:!1}})],W.prototype,"fullExtent",void 0),(0,f._)([(0,m.Cb)({type:A.Z,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:!1}})],W.prototype,"spatialReference",void 0),(0,f._)([(0,m.Cb)({type:["utility","trace"],readOnly:!0,json:{read:!1,write:!1}})],W.prototype,"type",void 0),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"datasetName",null),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"owner",null),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"schemaGeneration",null),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"parsedUrl",null),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"featureServiceUrl",null),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"networkServiceUrl",null),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"layerId",null),(0,f._)([(0,m.Cb)()],W.prototype,"sourceJSON",void 0),(0,f._)([(0,m.Cb)({readOnly:!0})],W.prototype,"networkSystemLayers",null);var j=W=(0,f._)([(0,_.j)("esri.networks.Network")],W),q=n(18769),Y=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).request=w.default,r}return(0,l.Z)(n,[{key:"initialize",value:function(){}},{key:"load",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.layer.load(t).then((function(){return r._initializeRulesTable()})),e.abrupt("return",(this.addResolvingPromise(n),this));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFeatureSQL",value:function(e,t){var n,r,i=e.layerId.toString(),a=null===(n=e.fieldsIndex)||void 0===n?void 0:n.normalizeFieldName("assetGroup"),o=null===(r=e.fieldsIndex)||void 0===r?void 0:r.normalizeFieldName("assetType"),s=a?t.attributes[a]:null,l=o?t.attributes[o]:null,u=this.rulesHash[i];if(u){var c=u.assetGroupHash[s];if(c)return c.assetTypeHash[l]||null}return null}},{key:"_initializeRulesTable",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,n,r,o,s,l,u,c,h,d,f,p,v,m,_,y,g,b,w,C,x,T,S,k,P,R,A,E,O,M,Z,I,D,L,N,F,U;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t={},function(e){e[e.from=0]="from",e[e.to=1]="to",e[e.via=2]="via"}(n||(n={})),r=[{networkSourceId:"fromNetworkSource",assetGroupId:"fromAssetGroup",assetTypeId:"fromAssetType"},{networkSourceId:"toNetworkSource",assetGroupId:"toAssetGroup",assetTypeId:"toAssetType"},{networkSourceId:"viaNetworkSource",assetGroupId:"viaAssetGroup",assetTypeId:"viaAssetType"}],o=(0,i.Z)(this.rules),e.prev=4,o.s();case 6:if((s=o.n()).done){e.next=35;break}if((l=s.value).ruleType===q.SV.RTJunctionJunctionConnectivity||l.ruleType===q.SV.RTJunctionEdgeConnectivity||l.ruleType===q.SV.RTEdgeJunctionEdgeConnectivity){e.next=10;break}return e.abrupt("continue",33);case 10:u=[[n.from,n.to],[n.to,n.from]],l.ruleType===q.SV.RTEdgeJunctionEdgeConnectivity&&(u=[[n.from,n.via],[n.via,n.from],[n.to,n.via],[n.via,n.to]]),c=0,h=u;case 13:if(!(c<h.length)){e.next=33;break}w=h[c],C=w.shift(),x=w.shift(),T=!1,e.t0=l.ruleType,e.next=e.t0===q.SV.RTEdgeJunctionEdgeConnectivity?20:e.t0===q.SV.RTJunctionEdgeConnectivity?22:23;break;case 20:return T=C===n.from||C===n.to,e.abrupt("break",23);case 22:T=C===n.to;case 23:if(S=r[C],k=l[S.networkSourceId].layerId.toString(),P=null===(d=l[S.assetGroupId])||void 0===d||null===(f=d.assetGroupCode)||void 0===f?void 0:f.toString(),R=null===(p=l[S.assetTypeId])||void 0===p||null===(v=p.assetTypeCode)||void 0===v?void 0:v.toString(),A=r[x],E=l[A.networkSourceId].layerId.toString(),O=null===(m=l[A.assetGroupId])||void 0===m||null===(_=m.assetGroupCode)||void 0===_?void 0:_.toString(),M=l[A.assetTypeId],Z=null===M||void 0===M||null===(y=M.assetTypeCode)||void 0===y?void 0:y.toString(),I=t[k]?t[k]:{assetGroupHash:{}},P&&R&&O&&Z){e.next=26;break}return e.abrupt("continue",30);case 26:D=I.assetGroupHash[P]?I.assetGroupHash[P]:{assetTypeHash:{}},(L=D.assetTypeHash[R]?D.assetTypeHash[R]:{})[E]=L[E]?L[E]:{},T&&(L[k]=L[k]?L[k]:{},F="(assetgroup = ".concat(P," AND assettype = ").concat(R,")"),L[k].anyVertex=L[k].anyVertex?"".concat(L[k].anyVertex):"".concat(F),"esriNECPEndVertex"===M.connectivityPolicy&&(L[k].endVertex=null!==(N=L[k])&&void 0!==N&&N.endVertex?"".concat(L[k].endVertex):"".concat(F))),U="(assetgroup = ".concat(O," AND assettype = ").concat(Z,")"),L[E].anyVertex=null!==(g=L[E])&&void 0!==g&&g.anyVertex?"".concat(L[E].anyVertex," OR ").concat(U):"".concat(U),"esriNECPEndVertex"===M.connectivityPolicy&&(L[E].endVertex=null!==(b=L[E])&&void 0!==b&&b.endVertex?"".concat(L[E].endVertex," OR ").concat(U):"".concat(U)),D.assetTypeHash[R]=L,I.assetGroupHash[P]=D,t[k]=I;case 30:c++,e.next=13;break;case 33:e.next=6;break;case 35:e.next=40;break;case 37:e.prev=37,e.t1=e.catch(4),o.e(e.t1);case 40:return e.prev=40,o.f(),e.finish(40);case 43:this.rulesHash=t;case 44:case"end":return e.stop()}}),e,this,[[4,37,40,43]])})));return function(){return e.apply(this,arguments)}}()}]),n}((0,z.eC)(x.Z));(0,f._)([(0,m.Cb)({constructOnly:!0})],Y.prototype,"layer",void 0),(0,f._)([(0,m.Cb)({constructOnly:!0})],Y.prototype,"rules",void 0),(0,f._)([(0,m.Cb)()],Y.prototype,"rulesHash",void 0),(0,f._)([(0,m.Cb)({constructOnly:!0})],Y.prototype,"request",void 0);var X=Y=(0,f._)([(0,_.j)("esri.networks.RulesTable")],Y),Q=n(79076),J=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).rulesTableId=null,r.rulesTableUrl=null,r.subnetworksTableId=null,r.subnetworksTableUrl=null,r.dirtyAreasLayerId=null,r.dirtyAreasLayerUrl=null,r}return(0,l.Z)(n)}(n(31319).Z);(0,f._)([(0,m.Cb)({constructOnly:!0})],J.prototype,"rulesTableId",void 0),(0,f._)([(0,m.Cb)({constructOnly:!0})],J.prototype,"rulesTableUrl",void 0),(0,f._)([(0,m.Cb)({constructOnly:!0})],J.prototype,"subnetworksTableId",void 0),(0,f._)([(0,m.Cb)({constructOnly:!0})],J.prototype,"subnetworksTableUrl",void 0),(0,f._)([(0,m.Cb)({constructOnly:!0})],J.prototype,"dirtyAreasLayerId",void 0),(0,f._)([(0,m.Cb)({constructOnly:!0})],J.prototype,"dirtyAreasLayerUrl",void 0);var K=J=(0,f._)([(0,_.j)("esri.networks.support.NetworkSystemLayers")],J),$=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).id=null,r.name=null,r}return(0,l.Z)(n)}(z.wq);(0,f._)([(0,m.Cb)({type:Number,json:{read:{source:"terminalId"},write:{target:"terminalId"}}})],$.prototype,"id",void 0),(0,f._)([(0,m.Cb)({type:String,json:{read:{source:"terminalName"},write:{target:"terminalName"}}})],$.prototype,"name",void 0),(0,f._)([(0,m.Cb)({type:Boolean,json:{write:!0}})],$.prototype,"isUpstreamTerminal",void 0);var ee=$=(0,f._)([(0,_.j)("esri.networks.support.Terminal")],$),te=new M.X({esriUNTMBidirectional:"bidirectional",esriUNTMDirectional:"directional"}),ne=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).defaultConfiguration=null,r.id=null,r.name=null,r.terminals=[],r.traversabilityModel=null,r}return(0,l.Z)(n)}(z.wq);(0,f._)([(0,m.Cb)({type:String,json:{write:!0}})],ne.prototype,"defaultConfiguration",void 0),(0,f._)([(0,m.Cb)({type:Number,json:{read:{source:"terminalConfigurationId"},write:{target:"terminalConfigurationId"}}})],ne.prototype,"id",void 0),(0,f._)([(0,m.Cb)({type:String,json:{read:{source:"terminalConfigurationName"},write:{target:"terminalConfigurationName"}}})],ne.prototype,"name",void 0),(0,f._)([(0,m.Cb)({type:[ee],json:{write:!0}})],ne.prototype,"terminals",void 0),(0,f._)([(0,m.Cb)({type:te.apiValues,json:{type:te.jsonValues,read:te.read,write:te.write}})],ne.prototype,"traversabilityModel",void 0);var re=ne=(0,f._)([(0,_.j)("esri.networks.support.TerminalConfiguration")],ne),ie=n(21149),ae=v.Z.getLogger("esri.networks.UtilityNetwork"),oe=function(e){(0,h.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).sharedNamedTraceConfigurations=[],r.type="utility",r}return(0,l.Z)(n,[{key:"serviceTerritoryFeatureLayerId",get:function(){var e,t;return null!==(e=null===(t=this.dataElement)||void 0===t?void 0:t.serviceTerritoryFeatureLayerId)&&void 0!==e?e:null}},{key:"networkSystemLayers",get:function(){var e,t,n,r,i,a;return new K({rulesTableId:null===(e=this.sourceJSON)||void 0===e?void 0:e.systemLayers.rulesTableId,rulesTableUrl:this.sourceJSON?"".concat(this.featureServiceUrl,"/").concat(null===(t=this.sourceJSON)||void 0===t?void 0:t.systemLayers.rulesTableId):null,subnetworksTableId:null===(n=this.sourceJSON)||void 0===n?void 0:n.systemLayers.subnetworksTableId,subnetworksTableUrl:this.sourceJSON?"".concat(this.featureServiceUrl,"/").concat(null===(r=this.sourceJSON)||void 0===r?void 0:r.systemLayers.subnetworksTableId):null,dirtyAreasLayerId:null===(i=this.sourceJSON)||void 0===i?void 0:i.systemLayers.dirtyAreasLayerId,dirtyAreasLayerUrl:this.sourceJSON?"".concat(this.featureServiceUrl,"/").concat(null===(a=this.sourceJSON)||void 0===a?void 0:a.systemLayers.dirtyAreasLayerId):null})}},{key:"rulesTableId",get:function(){var e;return(0,p.Mr)(ae,"rulesTableId",{replacement:"networkSystemLayers.rulesTableId",version:"4.25"}),null===(e=this.sourceJSON)||void 0===e?void 0:e.systemLayers.rulesTableId}},{key:"rulesTableUrl",get:function(){return(0,p.Mr)(ae,"rulesTableUrl",{replacement:"networkSystemLayers.rulesTableUrl",version:"4.25"}),this.sourceJSON?"".concat(this.featureServiceUrl,"/").concat(this.networkSystemLayers.rulesTableId):null}},{key:"subnetworksTableId",get:function(){var e;return(0,p.Mr)(ae,"subnetworksTableId",{replacement:"networkSystemLayers.subnetworksTableId",version:"4.25"}),null===(e=this.sourceJSON)||void 0===e?void 0:e.systemLayers.subnetworksTableId}},{key:"subnetworksTableUrl",get:function(){return(0,p.Mr)(ae,"subnetworksTableUrl",{replacement:"networkSystemLayers.subnetworksTableUrl",version:"4.25"}),this.sourceJSON?"".concat(this.featureServiceUrl,"/").concat(this.networkSystemLayers.subnetworksTableId):null}},{key:"terminalConfigurations",get:function(){var e;return(null===(e=this.dataElement)||void 0===e?void 0:e.terminalConfigurations.map((function(e){return re.fromJSON(e)})))||[]}},{key:"domainNetworkNames",get:function(){var e;return(null===(e=this.dataElement)||void 0===e?void 0:e.domainNetworks.map((function(e){return e.domainNetworkName})))||[]}},{key:"_utilityLayerList",get:function(){var e,t,n=new Set;return null!==(e=this.dataElement)&&void 0!==e&&null!==(t=e.domainNetworks)&&void 0!==t&&t.map((function(e){e.edgeSources.map((function(e){n.add(e.layerId)})),e.junctionSources.map((function(e){n.add(e.layerId)}))})),n}},{key:"load",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(this.addResolvingPromise((0,u.Z)((0,c.Z)(n.prototype),"load",this).call(this,t)),this.addResolvingPromise(this._loadNamedTraceConfigurationsFromNetwork(t)),this));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getTerminalConfiguration",value:function(e){var t,n=null,r=null,a=e.layer;if("feature"!==(null===a||void 0===a?void 0:a.type))return null;if(null===(t=a.layerId))return null;var o=e.attributes;if(null==o)return null;for(var s=0,l=Object.keys(o);s<l.length;s++){var u=l[s];"ASSETGROUP"===u.toUpperCase()&&(n=e.getAttribute(u)),"ASSETTYPE"===u.toUpperCase()&&(r=e.getAttribute(u))}if(!this.dataElement)return null;var c,h=null,d=this.dataElement.domainNetworks,f=(0,i.Z)(d);try{for(f.s();!(c=f.n()).done;){var p,v=null===(p=c.value.junctionSources)||void 0===p?void 0:p.find((function(e){return e.layerId===t}));if(v){var m,_=null===(m=v.assetGroups)||void 0===m?void 0:m.find((function(e){return e.assetGroupCode===n}));if(_){var y,g=null===(y=_.assetTypes)||void 0===y?void 0:y.find((function(e){return e.assetTypeCode===r}));if(g){h=g.terminalConfigurationId;break}}}}}catch(C){f.e(C)}finally{f.f()}if(null!=h){var b,w=null===(b=this.dataElement.terminalConfigurations)||void 0===b?void 0:b.find((function(e){return e.terminalConfigurationId===h}));return w?re.fromJSON(w):null}return null}},{key:"getTierNames",value:function(e){var t,n=null===(t=this.dataElement)||void 0===t?void 0:t.domainNetworks.find((function(t){return t.domainNetworkName===e}));return(null===n||void 0===n?void 0:n.tiers.map((function(e){return e.name})))||[]}},{key:"getRulesTable",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._createRulesTable());case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isUtilityLayer",value:function(e){return this._utilityLayerList.has(e.layerId)}},{key:"_loadNamedTraceConfigurationsFromNetwork",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,o,s,l,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(null===(n=this.sharedNamedTraceConfigurations)||void 0===n?void 0:n.length)){e.next=2;break}return e.abrupt("return");case 2:return r=this.sharedNamedTraceConfigurations.map((function(e){return e.globalId})),e.next=5,this.queryNamedTraceConfigurations({globalIds:r},t);case 5:o=e.sent,s=(0,i.Z)(this.sharedNamedTraceConfigurations);try{for(u=function(){var e=l.value,t=null===o||void 0===o?void 0:o.find((function(t){return t.globalId===e.globalId}));if(t){var n=t.write({},{origin:"service"});e.read(n,{origin:"service"})}},s.s();!(l=s.n()).done;)u()}catch(a){s.e(a)}finally{s.f()}case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createRulesTable",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,n,i,o,s,l=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new y.default({url:this.rulesTableUrl}),e.next=3,n.load();case 3:if(i=null===(t=this.dataElement)||void 0===t?void 0:t.domainNetworks){e.next=6;break}return e.abrupt("return",null);case 6:return o=i.flatMap((function(e){return[].concat((0,r.Z)(e.edgeSources),(0,r.Z)(e.junctionSources))})),e.next=9,this._queryRulesTable(n);case 9:return s=e.sent.map((function(e){return l._hydrateRuleInfo(n,o,e)})),e.abrupt("return",new X({layer:n,rules:s}));case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRulesTable",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new ie.Z({where:"1=1",outFields:["*"]}),e.next=3,(0,g.UK)(t,n);case 3:return e.abrupt("return",e.sent.features);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_hydrateRuleInfo",value:function(e,t,n){var r,i=this,a=e.fieldsIndex,o=a.get("RULETYPE"),s=a.get("CREATIONDATE"),l=a.get("FROMNETWORKSOURCEID"),u=a.get("FROMASSETGROUP"),c=a.get("FROMASSETTYPE"),h=a.get("FROMTERMINALID"),d=a.get("TONETWORKSOURCEID"),f=a.get("TOASSETGROUP"),p=a.get("TOASSETTYPE"),v=a.get("TOTERMINALID"),m=a.get("VIANETWORKSOURCEID"),_=a.get("VIAASSETGROUP"),y=a.get("VIAASSETTYPE"),g=a.get("VIATERMINALID"),b=n.attributes[o.name],w=new Date(n.attributes[s.name]),C=[{networkSourceId:n.attributes[l.name],assetGroupId:n.attributes[u.name],assetTypeId:n.attributes[c.name],terminalId:n.attributes[h.name]},{networkSourceId:n.attributes[d.name],assetGroupId:n.attributes[f.name],assetTypeId:n.attributes[p.name],terminalId:n.attributes[v.name]},{networkSourceId:n.attributes[m.name],assetGroupId:n.attributes[_.name],assetTypeId:n.attributes[y.name],terminalId:n.attributes[g.name]}];!function(e){e[e.from=0]="from",e[e.to=1]="to",e[e.via=2]="via"}(r||(r={}));for(var x={ruleType:b,creationDate:w},T=function(){var e=k[S];if(b!==q.SV.RTEdgeJunctionEdgeConnectivity&&e===r.via)return"continue";var n=C[e],a=t.find((function(e){return e.sourceId===n.networkSourceId})),o=null===a||void 0===a?void 0:a.assetGroups.find((function(e){return e.assetGroupCode===n.assetGroupId})),s=null===o||void 0===o?void 0:o.assetTypes.find((function(e){return e.assetTypeCode===n.assetTypeId})),l=i._getTerminal(b,s,n);b!==q.SV.RTContainment&&b!==q.SV.RTAttachment||(l=null);var u="";switch(e){case r.from:u="from";break;case r.to:u="to";break;case r.via:u="via"}x["".concat(u,"NetworkSource")]=a,x["".concat(u,"AssetGroup")]=o,x["".concat(u,"AssetType")]=s,x["".concat(u,"Terminal")]=l},S=0,k=[r.from,r.to,r.via];S<k.length;S++)T();return x}},{key:"_getTerminal",value:function(e,t,n){var r,i,a;if(e===q.SV.RTAttachment||e===q.SV.RTContainment)return null;var o=null===t||void 0===t?void 0:t.terminalConfigurationId,s=null===(r=this.terminalConfigurations)||void 0===r?void 0:r.find((function(e){return e.id===o}));return null!==(i=null===s||void 0===s||null===(a=s.terminals)||void 0===a?void 0:a.find((function(e){return e.id===n.terminalId})))&&void 0!==i?i:null}}]),n}(j);(0,f._)([(0,m.Cb)({type:[Q.Z],json:{origins:{"web-map":{read:{source:"traceConfigurations"},write:{target:"traceConfigurations"}},service:{read:{source:"traceConfigurations"}}},read:!1}})],oe.prototype,"sharedNamedTraceConfigurations",void 0),(0,f._)([(0,m.Cb)({type:["utility"],readOnly:!0,json:{read:!1,write:!1}})],oe.prototype,"type",void 0),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"serviceTerritoryFeatureLayerId",null),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"networkSystemLayers",null),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"rulesTableId",null),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"rulesTableUrl",null),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"subnetworksTableId",null),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"subnetworksTableUrl",null),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"terminalConfigurations",null),(0,f._)([(0,m.Cb)({readOnly:!0})],oe.prototype,"domainNetworkNames",null);var se=oe=(0,f._)([(0,_.j)("esri.networks.UtilityNetwork")],oe)},79076:function(e,t,n){n.d(t,{Z:function(){return y}});var r=n(15671),i=n(43144),a=n(60136),o=n(92572),s=n(27366),l=n(97642),u=n(49861),c=(n(25243),n(63780),n(38511)),h=n(69912),d=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).conditionBarriers=[],i.outputConditions=[],i.functions=[],i.functionBarriers=[],i.traversabilityScope=null,i.shortestPathNetworkAttributeName=null,i.includeBarriers=null,i.validateConsistency=null,i.ignoreBarriersAtStartingPoints=null,i}return(0,i.Z)(n)}(n(46784).wq);(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],d.prototype,"conditionBarriers",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],d.prototype,"outputConditions",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],d.prototype,"functions",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],d.prototype,"functionBarriers",void 0),(0,s._)([(0,u.Cb)({type:["junctions","edges","junctionsAndEdges"],json:{write:!0}})],d.prototype,"traversabilityScope",void 0),(0,s._)([(0,u.Cb)({type:String,json:{write:!0}})],d.prototype,"shortestPathNetworkAttributeName",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],d.prototype,"includeBarriers",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],d.prototype,"validateConsistency",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],d.prototype,"ignoreBarriersAtStartingPoints",void 0);var f=d=(0,s._)([(0,h.j)("esri.networks.support.TraceConfiguration")],d),p=n(18769),v=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).filterBarriers=[],i.domainNetworkName=null,i.filterBitsetNetworkAttributeName=null,i.filterFunctionBarriers=[],i.filterScope=null,i.includeContainers=null,i.includeContent=null,i.includeIsolated=null,i.includeStructures=null,i.includeUpToFirstSpatialContainer=null,i.nearestNeighbor=null,i.outputFilterCategories=[],i.outputFilters=[],i.propagators=[],i.subnetworkName=null,i.targetTierName=null,i.tierName=null,i.validateLocatability=null,i}return(0,i.Z)(n)}(f);(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],v.prototype,"filterBarriers",void 0),(0,s._)([(0,u.Cb)({type:String,json:{write:!0}})],v.prototype,"domainNetworkName",void 0),(0,s._)([(0,u.Cb)({type:String,json:{write:!0}})],v.prototype,"filterBitsetNetworkAttributeName",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],v.prototype,"filterFunctionBarriers",void 0),(0,s._)([(0,u.Cb)({type:["junctions","edges","junctionsAndEdges"],json:{write:!0}})],v.prototype,"filterScope",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],v.prototype,"includeContainers",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],v.prototype,"includeContent",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],v.prototype,"includeIsolated",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],v.prototype,"includeStructures",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],v.prototype,"includeUpToFirstSpatialContainer",void 0),(0,s._)([(0,u.Cb)({type:Object,json:{write:!0}})],v.prototype,"nearestNeighbor",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],v.prototype,"outputFilterCategories",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],v.prototype,"outputFilters",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],v.prototype,"propagators",void 0),(0,s._)([(0,u.Cb)({type:String,json:{write:!0}})],v.prototype,"subnetworkName",void 0),(0,s._)([(0,u.Cb)({type:String,json:{write:!0}})],v.prototype,"targetTierName",void 0),(0,s._)([(0,u.Cb)({type:String,json:{write:!0}})],v.prototype,"tierName",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],v.prototype,"validateLocatability",void 0);var m=v=(0,s._)([(0,h.j)("esri.networks.support.UNTraceConfiguration")],v),_=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var i;return(0,r.Z)(this,n),(i=t.call(this,e)).globalId=null,i.title=null,i.traceConfiguration=null,i.creationDate=null,i.creator=null,i.description=null,i.minStartingPoints=null,i.resultTypes=[],i.tags=[],i.traceType=null,i}return(0,i.Z)(n,[{key:"readTraceConfiguration",value:function(e,t){return void 0!==e.tierName?m.fromJSON(e):f.fromJSON(e)}}]),n}(l.w);(0,s._)([(0,u.Cb)({type:String,nonNullable:!0,json:{origins:{"web-map":{read:{source:"id"},write:{target:"id",isRequired:!0}},service:{read:{source:"globalId"},write:{target:"globalId",isRequired:!0}}},read:!1}})],_.prototype,"globalId",void 0),(0,s._)([(0,u.Cb)({type:String,nonNullable:!0,json:{origins:{"web-map":{read:{source:"title"},write:{target:"title",isRequired:!0}},service:{read:{source:"name"},write:{target:"name",isRequired:!0}}},read:!1}})],_.prototype,"title",void 0),(0,s._)([(0,u.Cb)({type:f,json:{origins:{service:{read:!0,write:!0}},read:!1}})],_.prototype,"traceConfiguration",void 0),(0,s._)([(0,c.r)("service","traceConfiguration")],_.prototype,"readTraceConfiguration",null),(0,s._)([(0,u.Cb)({type:Date,json:{origins:{service:{read:!0,write:!0}},read:!1}})],_.prototype,"creationDate",void 0),(0,s._)([(0,u.Cb)({type:String,json:{origins:{service:{read:!0,write:!0}},read:!1}})],_.prototype,"creator",void 0),(0,s._)([(0,u.Cb)({type:String,json:{origins:{service:{read:!0,write:!0}},read:!1}})],_.prototype,"description",void 0),(0,s._)([(0,u.Cb)({type:["none","one","many"],json:{origins:{service:{read:{source:"minNumStartingPoints"},write:{target:"minNumStartingPoints"}}},read:!1}})],_.prototype,"minStartingPoints",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{origins:{service:{read:!0,write:!0}},read:!1}})],_.prototype,"resultTypes",void 0),(0,s._)([(0,u.Cb)({type:[String],json:{origins:{service:{read:!0,write:!0}},read:!1}})],_.prototype,"tags",void 0),(0,s._)([(0,u.Cb)({type:p.Fh.apiValues,json:{type:p.Fh.jsonValues,origins:{service:{read:p.Fh.read,write:p.Fh.write}},read:!1}})],_.prototype,"traceType",void 0);var y=_=(0,s._)([(0,h.j)("esri.networks.support.NamedTraceConfiguration")],_)},18769:function(e,t,n){n.d(t,{Fh:function(){return a},SV:function(){return r}});var r,i=n(43404);!function(e){e[e.RTJunctionJunctionConnectivity=1]="RTJunctionJunctionConnectivity",e[e.RTContainment=2]="RTContainment",e[e.RTAttachment=3]="RTAttachment",e[e.RTJunctionEdgeConnectivity=4]="RTJunctionEdgeConnectivity",e[e.RTEdgeJunctionEdgeConnectivity=5]="RTEdgeJunctionEdgeConnectivity"}(r||(r={}));var a=new i.X({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation"});new i.X({connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionMidspanConnectivity:"junction-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"}),new i.X({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"})},64267:function(e,t,n){n.d(t,{Z:function(){return d}});var r=n(43144),i=n(15671),a=n(60136),o=n(92572),s=n(27366),l=n(46784),u=n(49861),c=(n(25243),n(63780),n(69912)),h=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e){var r;return(0,i.Z)(this,n),(r=t.call(this,e)).moment=null,r.fullUpdate=!1,r.validateErrorsCreated=!1,r.dirtyAreaCount=null,r.exceededTransferLimit=null,r.serviceEdits=null,r}return(0,r.Z)(n)}(l.wq);(0,s._)([(0,u.Cb)({type:Date,json:{type:Number,write:{writer:function(e,t){t.moment=e?e.getTime():null}}}})],h.prototype,"moment",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],h.prototype,"fullUpdate",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],h.prototype,"validateErrorsCreated",void 0),(0,s._)([(0,u.Cb)({type:Number,json:{write:!0}})],h.prototype,"dirtyAreaCount",void 0),(0,s._)([(0,u.Cb)({type:Boolean,json:{write:!0}})],h.prototype,"exceededTransferLimit",void 0),(0,s._)([(0,u.Cb)({type:[Object],json:{write:!0}})],h.prototype,"serviceEdits",void 0);var d=h=(0,s._)([(0,c.j)("esri.rest.networks.support.ValidateNetworkTopologyResult")],h)},87422:function(e,t,n){n.d(t,{s:function(){return d}});var r=n(15671),i=n(43144),a=n(60136),o=n(92572),s=n(91505),l=n(93169),u=n(92026),c=n(66978),h=1/(0,l.Z)("mapview-transitions-duration"),d=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){var e;return(0,r.Z)(this,n),(e=t.apply(this,arguments))._fadeOutResolver=null,e._fadeInResolver=null,e._clips=null,e.computedVisible=!0,e.computedOpacity=1,e.fadeTransitionEnabled=!1,e.inFadeTransition=!1,e._isReady=!1,e._opacity=1,e.parent=null,e._stage=null,e._visible=!0,e}return(0,i.Z)(n,[{key:"clips",get:function(){return this._clips},set:function(e){this._clips=e,this.requestRender()}},{key:"isReady",get:function(){return this._isReady}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}},{key:"stage",get:function(){return this._stage},set:function(e){var t;if(this._stage!==e){var n=this._stage;this._stage=e,e?(null===(t=this._stage)||void 0===t?void 0:t.untrashDisplayObject(this))||(this.onAttach(),this.emit("attach")):null===n||void 0===n||n.trashDisplayObject(this)}}},{key:"transforms",get:function(){return this._getTransforms()}},{key:"_getTransforms",value:function(){return(0,u.Wi)(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}},{key:"visible",get:function(){return this._visible},set:function(e){this._visible!==e&&(this._visible=e,this.requestRender())}},{key:"fadeIn",value:function(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=(0,c.hh)(),this.requestRender()),this._fadeInResolver.promise}},{key:"fadeOut",value:function(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=(0,c.hh)(),this.requestRender()),this._fadeOutResolver.promise}},{key:"endTransitions",value:function(){var e,t;null!==(e=this._fadeInResolver)&&void 0!==e&&e.call(this),this._fadeInResolver=null,null!==(t=this._fadeOutResolver)&&void 0!==t&&t.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}},{key:"beforeRender",value:function(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}},{key:"afterRender",value:function(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&0===this.computedOpacity&&(this._fadeOutResolver(),this._fadeOutResolver=null)}},{key:"remove",value:function(){var e;null===(e=this.parent)||void 0===e||e.removeChild(this)}},{key:"setTransform",value:function(e){}},{key:"processRender",value:function(e){this.stage&&this.computedVisible&&this.doRender(e)}},{key:"requestRender",value:function(){this.stage&&this.stage.requestRender()}},{key:"processDetach",value:function(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}},{key:"updateTransitionProperties",value:function(e,t){if(this.fadeTransitionEnabled){var n=this._fadeOutResolver||!this.visible?0:this.opacity,r=this.computedOpacity;if(r===n)this.computedVisible=this.visible;else{var i=e*h;this.computedOpacity=r>n?Math.max(n,r-i):Math.min(n,r+i),this.computedVisible=this.computedOpacity>0;var a=n===this.computedOpacity;this.inFadeTransition=!a,a||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}},{key:"onAttach",value:function(){}},{key:"onDetach",value:function(){}},{key:"doRender",value:function(e){}},{key:"ready",value:function(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}]),n}(s.Z)},39395:function(e,t,n){var r,i;n.d(t,{H:function(){return i},U:function(){return r}}),function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(r||(r={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(i||(i={}))},72291:function(e,t,n){n.d(t,{i:function(){return S},K:function(){return P}});var r=n(29439),i=n(37762),a=n(15671),o=n(43144),s=n(11752),l=n(61120),u=n(60136),c=n(92572),h=n(92026),d=n(22753),f=n(23588),p=n(10106),v=n(50127),m=n(44070),_=n(8548),y=n(45412),g=function(){function e(t,n){(0,a.Z)(this,e),this.layerUIDs=[],this.isDestroyed=!1,this._data=t,this.memoryUsed=t.byteLength;var r=1,i=new Uint32Array(t);this.layerUIDs=[];for(var o=i[r++],s=0;s<o;s++)this.layerUIDs[s]=i[r++];this.bufferDataOffset=r,n&&(this.layer=n.getStyleLayerByUID(this.layerUIDs[0]))}return(0,o.Z)(e,[{key:"isPreparedForRendering",get:function(){return(0,h.Wi)(this._data)}},{key:"offset",get:function(){return this.bufferDataOffset}},{key:"destroy",value:function(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}},{key:"prepareForRendering",value:function(e){(0,h.Wi)(this._data)||(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}]),e}(),b=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(e,r){var i;(0,a.Z)(this,n),(i=t.call(this,e,r)).type=p.al.LINE,i.lineIndexStart=0,i.lineIndexCount=0;var o=new Uint32Array(e),s=i.bufferDataOffset;i.lineIndexStart=o[s++],i.lineIndexCount=o[s++];var l=o[s++];if(l>0){for(var u=new Map,c=0;c<l;c++){var h=o[s++],d=o[s++],f=o[s++];u.set(h,[d,f])}i.patternMap=u}return i.bufferDataOffset=s,i}return(0,o.Z)(n,[{key:"hasData",value:function(){return this.lineIndexCount>0}},{key:"triangleCount",value:function(){return this.lineIndexCount/3}},{key:"doDestroy",value:function(){(0,h.pC)(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),(0,h.pC)(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),(0,h.pC)(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,n){var r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++];this.lineVertexBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,new Int32Array(i.buffer,4*n,a)),n+=a;var o=r[n++];this.lineIndexBuffer=m.f.createIndex(e,_.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*n,o)),n+=o;var s=this.layer.lineMaterial;this.lineVertexArrayObject=new y.U(e,s.getAttributeLocations(),s.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}]),n}(g),w=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(e,r){var i;(0,a.Z)(this,n),(i=t.call(this,e,r)).type=p.al.FILL,i.fillIndexStart=0,i.fillIndexCount=0,i.outlineIndexStart=0,i.outlineIndexCount=0;var o=new Uint32Array(e),s=i.bufferDataOffset;i.fillIndexStart=o[s++],i.fillIndexCount=o[s++],i.outlineIndexStart=o[s++],i.outlineIndexCount=o[s++];var l=o[s++];if(l>0){for(var u=new Map,c=0;c<l;c++){var h=o[s++],d=o[s++],f=o[s++];u.set(h,[d,f])}i.patternMap=u}return i.bufferDataOffset=s,i}return(0,o.Z)(n,[{key:"hasData",value:function(){return this.fillIndexCount>0||this.outlineIndexCount>0}},{key:"triangleCount",value:function(){return(this.fillIndexCount+this.outlineIndexCount)/3}},{key:"doDestroy",value:function(){(0,h.pC)(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),(0,h.pC)(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),(0,h.pC)(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,(0,h.pC)(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),(0,h.pC)(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),(0,h.pC)(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,n){var r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++];this.fillVertexBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,new Int32Array(i.buffer,4*n,a)),n+=a;var o=r[n++];this.fillIndexBuffer=m.f.createIndex(e,_.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*n,o)),n+=o;var s=r[n++];this.outlineVertexBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,new Int32Array(i.buffer,4*n,s)),n+=s;var l=r[n++];this.outlineIndexBuffer=m.f.createIndex(e,_.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*n,l)),n+=l;var u=this.layer,c=u.fillMaterial,h=u.outlineMaterial;this.fillVertexArrayObject=new y.U(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new y.U(e,h.getAttributeLocations(),h.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}]),n}(g),C=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(e,r,i){var o;(0,a.Z)(this,n),(o=t.call(this,e,r)).type=p.al.SYMBOL,o.iconPerPageElementsMap=new Map,o.glyphPerPageElementsMap=new Map,o.symbolInstances=[],o.isIconSDF=!1,o.opacityChanged=!1,o.lastOpacityUpdate=0,o.symbols=[];var s=new Uint32Array(e),l=new Int32Array(e),u=new Float32Array(e),c=o.bufferDataOffset;o.isIconSDF=!!s[c++];for(var h=s[c++],d=0;d<h;d++){var f=s[c++],m=s[c++],_=s[c++];o.iconPerPageElementsMap.set(f,[m,_])}for(var y=s[c++],g=0;g<y;g++){var b=s[c++],w=s[c++],C=s[c++];o.glyphPerPageElementsMap.set(b,[w,C])}var x=s[c++],T=s[c++];return o.iconOpacity=new Int32Array(x),o.textOpacity=new Int32Array(T),c=(0,v.wB)(s,l,u,c,o.symbols,i),o.bufferDataOffset=c,o}return(0,o.Z)(n,[{key:"hasData",value:function(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}},{key:"triangleCount",value:function(){var e,t=0,n=(0,i.Z)(this.iconPerPageElementsMap);try{for(n.s();!(e=n.n()).done;){var a=(0,r.Z)(e.value,2);a[0];t+=a[1][1]}}catch(u){n.e(u)}finally{n.f()}var o,s=(0,i.Z)(this.glyphPerPageElementsMap);try{for(s.s();!(o=s.n()).done;){var l=(0,r.Z)(o.value,2);l[0];t+=l[1][1]}}catch(u){s.e(u)}finally{s.f()}return t/3}},{key:"doDestroy",value:function(){(0,h.pC)(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),(0,h.pC)(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),(0,h.pC)(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),(0,h.pC)(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,(0,h.pC)(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),(0,h.pC)(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),(0,h.pC)(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),(0,h.pC)(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}},{key:"updateOpacityInfo",value:function(){if(this.opacityChanged){this.opacityChanged=!1;var e=(0,h.Wg)(this.iconOpacity),t=(0,h.Wg)(this.iconOpacityBuffer);e.length>0&&e.byteLength===t.size&&t.setSubData(e,0,0,e.length);var n=(0,h.Wg)(this.textOpacity),r=(0,h.Wg)(this.textOpacityBuffer);n.length>0&&n.byteLength===r.size&&r.setSubData(n,0,0,n.length)}}},{key:"doPrepareForRendering",value:function(e,t,n){var r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++];this.iconVertexBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,new Int32Array(i.buffer,4*n,a)),n+=a;var o=r[n++];this.iconIndexBuffer=m.f.createIndex(e,_.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*n,o)),n+=o;var s=r[n++];this.textVertexBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,new Int32Array(i.buffer,4*n,s)),n+=s;var l=r[n++];this.textIndexBuffer=m.f.createIndex(e,_.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*n,l)),n+=l,this.iconOpacityBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,(0,h.Wg)(this.iconOpacity).buffer),this.textOpacityBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,(0,h.Wg)(this.textOpacity).buffer);var u=this.layer,c=u.iconMaterial,d=u.textMaterial;this.iconVertexArrayObject=new y.U(e,c.getAttributeLocations(),c.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new y.U(e,d.getAttributeLocations(),d.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}]),n}(g),x=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(e,r){var i;(0,a.Z)(this,n),(i=t.call(this,e,r)).type=p.al.CIRCLE,i.circleIndexStart=0,i.circleIndexCount=0;var o=new Uint32Array(e),s=i.bufferDataOffset;return i.circleIndexStart=o[s++],i.circleIndexCount=o[s++],i.bufferDataOffset=s,i}return(0,o.Z)(n,[{key:"hasData",value:function(){return this.circleIndexCount>0}},{key:"triangleCount",value:function(){return this.circleIndexCount/3}},{key:"doDestroy",value:function(){(0,h.pC)(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),(0,h.pC)(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),(0,h.pC)(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}},{key:"doPrepareForRendering",value:function(e,t,n){var r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++];this.circleVertexBuffer=m.f.createVertex(e,_.l1.STATIC_DRAW,new Int32Array(i.buffer,4*n,a)),n+=a;var o=r[n++];this.circleIndexBuffer=m.f.createIndex(e,_.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*n,o)),n+=o;var s=this.layer.circleMaterial;this.circleVertexArrayObject=new y.U(e,s.getAttributeLocations(),s.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}]),n}(g),T=n(46618),S=function(e){(0,u.Z)(n,e);var t=(0,c.Z)(n);function n(e,r,i,o,s,l,u){var c,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;return(0,a.Z)(this,n),(c=t.call(this,e,r,i,o,s,l,4096,4096))._memCache=h,c.type="vector-tile",c._referenced=0,c._hasSymbolBuckets=!1,c._memoryUsedByLayerData=0,c.layerData=new Map,c.layerCount=0,c.status="loading",c.allSymbolsFadingOut=!1,c.lastOpacityUpdate=0,c.symbols=new Map,c.isCoverage=!1,c.neededForCoverage=!1,c.decluttered=!1,c.invalidating=!1,c.parentTile=null,c.childrenTiles=new Set,c._processed=!1,c._referenced=1,c.styleRepository=u,c.id=e.id,c}return(0,o.Z)(n,[{key:"hasSymbolBuckets",get:function(){return this._hasSymbolBuckets}},{key:"isFading",get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<T.nN}},{key:"isHoldingForFade",get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<T.nN)}},{key:"wasRequested",get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}},{key:"setData",value:function(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}},{key:"deleteLayerData",value:function(e){var t,n=!1,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(this.layerData.has(a)){var o=this.layerData.get(a);this._memoryUsedByLayerData-=o.memoryUsed,o.type===p.al.SYMBOL&&this.symbols.has(a)&&(this.symbols.delete(a),n=!0),o.destroy(),this.layerData.delete(a),this.layerCount--}}}catch(s){r.e(s)}finally{r.f()}(0,h.pC)(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),n&&this.emit("symbols-changed"),this.requestRender()}},{key:"processed",value:function(){return this._processed}},{key:"hasData",value:function(){return this.layerCount>0}},{key:"dispose",value:function(){"unloaded"!==this.status&&(k.delete(this),n._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}},{key:"release",value:function(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}},{key:"retain",value:function(){++this._referenced}},{key:"referenced",get:function(){return this._referenced}},{key:"memoryUsage",get:function(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}},{key:"changeDataImpl",value:function(e){var t=!1;if(e){var n=e.bucketsWithData,a=e.emptyBuckets,o=this._createRenderBuckets(n);if(a&&a.byteLength>0){var s,l=new Uint32Array(a),u=(0,i.Z)(l);try{for(u.s();!(s=u.n()).done;){var c=s.value;this._deleteLayerData(c)}}catch(w){u.e(w)}finally{u.f()}}var d,f=(0,i.Z)(o);try{for(f.s();!(d=f.n()).done;){var v=(0,r.Z)(d.value,2),m=v[0],_=v[1];this._deleteLayerData(m),_.type===p.al.SYMBOL&&(this.symbols.set(m,_.symbols),t=!0),this._memoryUsedByLayerData+=_.memoryUsed,this.layerData.set(m,_),this.layerCount++}}catch(w){f.e(w)}finally{f.f()}(0,h.pC)(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;var y,g=(0,i.Z)(this.layerData);try{for(g.s();!(y=g.n()).done;){var b=(0,r.Z)(y.value,2);b[0];b[1].type===p.al.SYMBOL&&(this._hasSymbolBuckets=!0)}}catch(w){g.e(w)}finally{g.f()}t&&this.emit("symbols-changed")}},{key:"attachWithContext",value:function(e){this.stage={context:e,trashDisplayObject:function(e){e.processDetach()},untrashDisplayObject:function(){return!1}}}},{key:"setTransform",value:function(e){(0,s.Z)((0,l.Z)(n.prototype),"setTransform",this).call(this,e);var t=this.resolution/(e.resolution*e.pixelRatio),r=this.width/this.rangeX*t,i=this.height/this.rangeY*t,a=[0,0];e.toScreen(a,[this.x,this.y]);var o=this.transforms.tileUnitsToPixels;(0,d.g)(o),(0,d.h)(o,o,a),(0,d.r)(o,o,Math.PI*e.rotation/180),(0,d.d)(o,o,[r,i,1])}},{key:"_createTransforms",value:function(){return{dvs:(0,f.c)(),tileMat3:(0,f.c)(),tileUnitsToPixels:(0,f.c)()}}},{key:"_createRenderBuckets",value:function(e){var t,n=new Map,r=new Map,a=(0,i.Z)(e);try{for(a.s();!(t=a.n()).done;){var o,s=t.value,l=this._deserializeBucket(s,r),u=(0,i.Z)(l.layerUIDs);try{for(u.s();!(o=u.n()).done;){var c=o.value;n.set(c,l)}}catch(h){u.e(h)}finally{u.f()}}}catch(h){a.e(h)}finally{a.f()}return n}},{key:"_deserializeBucket",value:function(e,t){var n=t.get(e);if(n)return n;switch(new Uint32Array(e)[0]){case p.al.FILL:n=new w(e,this.styleRepository);break;case p.al.LINE:n=new b(e,this.styleRepository);break;case p.al.SYMBOL:n=new C(e,this.styleRepository,this);break;case p.al.CIRCLE:n=new x(e,this.styleRepository)}return t.set(e,n),n}},{key:"_deleteLayerData",value:function(e){if(this.layerData.has(e)){var t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--}}}],[{key:"_destroyRenderBuckets",value:function(e){if(e){var t=new Set;e.forEach((function(e){t.has(e)||(e.destroy(),t.add(e))})),e.clear()}}}]),n}(n(72900).I),k=new Map;function P(){k.forEach((function(e,t){console.log("\n".concat(t.key,":")),e[0].forEach((function(e){return console.log(e)})),console.log("========"),e[1].forEach((function(e){return console.log(e)}))}))}},46618:function(e,t,n){n.d(t,{Bf:function(){return r},PF:function(){return i},Ts:function(){return a},nN:function(){return o}});var r=!0,i=32,a=1.5,o=200},38684:function(e,t,n){n.d(t,{J:function(){return o},a:function(){return a}});var r=n(43144),i=n(15671),a=(0,r.Z)((function e(t){(0,i.Z)(this,e),this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t})),o=(0,r.Z)((function e(){(0,i.Z)(this,e),this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}))},50127:function(e,t,n){n.d(t,{C$:function(){return d},HX:function(){return c},co:function(){return u},wB:function(){return h}});var r=n(29439),i=n(37762),a=n(15671),o=n(43144),s=n(10106),l=n(38684);function u(e,t,n,r,i,a){var o=n-i;if(o>=0)return(t>>o)+(r-(a<<o))*(e>>o);var s=-o;return t-(a-(r<<s))*(e>>s)<<s}var c=function(){function e(t,n,r){(0,a.Z)(this,e),this._rows=Math.ceil(n/r),this._columns=Math.ceil(t/r),this._cellSize=r,this.cells=new Array(this._rows);for(var i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(var o=0;o<this._columns;o++)this.cells[i][o]=[]}}return(0,o.Z)(e,[{key:"getCell",value:function(e,t){var n=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[n]&&this.cells[n][r]||null}},{key:"getCellSpan",value:function(e,t,n,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(n/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}},{key:"cellSize",get:function(){return this._cellSize}},{key:"columns",get:function(){return this._columns}},{key:"rows",get:function(){return this._rows}}]),e}();function h(e,t,n,r,i,a){for(var o=t[r++],s=0;s<o;s++){var u=new l.a(a);u.xTile=t[r++],u.yTile=t[r++],u.hash=t[r++],u.priority=t[r++];for(var c=t[r++],h=0;h<c;h++){var d=t[r++],f=t[r++],p=t[r++],v=t[r++],m=!!t[r++],_=t[r++],y=n[r++],g=n[r++],b=t[r++],w=t[r++];u.colliders.push({xTile:d,yTile:f,dxPixels:p,dyPixels:v,hard:m,partIndex:_,width:b,height:w,minLod:y,maxLod:g})}for(var C=e[r++],x=0;x<C;x++)u.textVertexRanges.push([e[r++],e[r++]]);for(var T=e[r++],S=0;S<T;S++)u.iconVertexRanges.push([e[r++],e[r++]]);i.push(u)}return r}function d(e,t,n){var a,o=(0,i.Z)(e.symbols);try{for(o.s();!(a=o.n()).done;){var s=(0,r.Z)(a.value,2),l=s[0];f(e,t,n,s[1],l)}}catch(u){o.e(u)}finally{o.f()}}function f(e,t,n,a,o){var l=e.layerData.get(o);if(l.type===s.al.SYMBOL){var u,c=(0,i.Z)(a);try{for(c.s();!(u=c.n()).done;){var h=u.value,d=h.unique,f=void 0;if(h.selectedForRendering){var p=d.parts[0],v=p.startOpacity,m=p.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===m;var _=n?Math.floor(127*v)|m<<7:m?255:0;f=_<<24|_<<16|_<<8|_}else f=0;var y,g=(0,i.Z)(h.iconVertexRanges);try{for(g.s();!(y=g.n()).done;)for(var b=(0,r.Z)(y.value,2),w=b[0],C=b[1],x=w;x<w+C;x+=4)l.iconOpacity[x/4]=f}catch(I){g.e(I)}finally{g.f()}if(h.selectedForRendering){var T=d.parts[1],S=T.startOpacity,k=T.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===k;var P=n?Math.floor(127*S)|k<<7:k?255:0;f=P<<24|P<<16|P<<8|P}else f=0;var R,A=(0,i.Z)(h.textVertexRanges);try{for(A.s();!(R=A.n()).done;)for(var E=(0,r.Z)(R.value,2),O=E[0],M=E[1],Z=O;Z<O+M;Z+=4)l.textOpacity[Z/4]=f}catch(I){A.e(I)}finally{A.f()}}}catch(I){c.e(I)}finally{c.f()}l.lastOpacityUpdate=t,l.opacityChanged=!0}}},10106:function(e,t,n){var r,i,a;n.d(t,{Fr:function(){return a},_K:function(){return i},al:function(){return r}}),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(r||(r={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(i||(i={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(a||(a={}))},61441:function(e,t,n){n.d(t,{As:function(){return o},cD:function(){return s},sy:function(){return a}});var r=n(8548),i=n(61109),a={geometry:[new i.G("a_pos",2,r.g.BYTE,0,2)]},o={geometry:[new i.G("a_pos",2,r.g.BYTE,0,4),new i.G("a_tex",2,r.g.BYTE,2,4)]},s={geometry:[new i.G("a_pos",2,r.g.UNSIGNED_SHORT,0,4)]}},72900:function(e,t,n){n.d(t,{I:function(){return h}});var r=n(29439),i=n(15671),a=n(43144),o=n(60136),s=n(92572),l=n(22753),u=n(87422),c=n(73828),h=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e,r,a,o,s,l){var u,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:s,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:l;return(0,i.Z)(this,n),(u=t.call(this)).triangleCountReportedInDebug=0,u.triangleCount=0,u.texture=null,u.key=new c.Z(e),u.resolution=r,u.x=a,u.y=o,u.width=s,u.height=l,u.rangeX=h,u.rangeY=d,u}return(0,a.Z)(n,[{key:"destroy",value:function(){this.texture&&(this.texture.dispose(),this.texture=null)}},{key:"setTransform",value:function(e){var t=this.resolution/(e.resolution*e.pixelRatio),n=this.transforms.tileMat3,i=e.toScreenNoRotation([0,0],[this.x,this.y]),a=(0,r.Z)(i,2),o=a[0],s=a[1],u=this.width/this.rangeX*t,c=this.height/this.rangeY*t;(0,l.s)(n,u,0,0,0,c,0,o,s,1),(0,l.m)(this.transforms.dvs,e.displayViewMat3,n)}}]),n}(u.s)},12658:function(e,t,n){n.d(t,{L:function(){return l}});var r=n(43144),i=n(15671),a=n(20460),o=(0,r.Z)((function e(t,n,r,a,o,s,l,u){var c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:.5;(0,i.Z)(this,e),this.coverage=t,this.density=n,this.absorption=r,this.cloudSize=a,this.detailSize=o,this.smoothness=s,this.cloudHeight=l,this.raymarchingSteps=u,this.median=c})),s=new o([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],a.p.SIXTEEN),l={sunny:s,cloudy:new o([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],a.p.TWOHUNDRED,.6),rainy:new o([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],a.p.TWOHUNDRED,.4),snowy:new o([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],a.p.HUNDRED,.65),foggy:new o([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],a.p.SIXTEEN),default:s}},20460:function(e,t,n){n.d(t,{p:function(){return r},t:function(){return d}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(27366),u=n(93169),c=n(46208),h=n(33559);!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(r||(r={}));var d=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).steps=r.SIXTEEN,e.writeTextureChannels=c.uz.RG,e}return(0,i.Z)(n)}(h.m);(0,l._)([(0,h.o)({count:r.COUNT})],d.prototype,"steps",void 0),(0,l._)([(0,h.o)({constValue:(0,u.Z)("esri-mobile")?1024:2048})],d.prototype,"cubeMapSize",void 0),(0,l._)([(0,h.o)()],d.prototype,"writeTextureChannels",void 0)},84819:function(e,t,n){n.d(t,{i:function(){return c},u:function(){return r}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(27366),u=n(33559);!function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(r||(r={}));var c=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).mode=r.Full,e}return(0,i.Z)(n)}(u.m);(0,l._)([(0,u.o)({count:r.COUNT})],c.prototype,"mode",void 0)},68820:function(e,t,n){n.d(t,{A:function(){return l},IQ:function(){return o},I_:function(){return r},QZ:function(){return u},iZ:function(){return s},jy:function(){return a},kR:function(){return i}});var r=(0,n(93169).Z)("esri-mobile")?64:128,i=r/128,a=Math.ceil(Math.sqrt(r)),o=(r+2)*a,s=1e5,l=128,u=o/1560},96916:function(e,t,n){n.d(t,{H:function(){return r},Y:function(){return c}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(27366),u=n(33559);!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(r||(r={}));var c=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).type=r.Rain,e}return(0,i.Z)(n)}(u.m);(0,l._)([(0,u.o)({count:r.COUNT})],c.prototype,"type",void 0)},69362:function(e,t,n){n.d(t,{f:function(){return h},n:function(){return r}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(27366),u=n(33559),c=n(8883);!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(r||(r={}));var h=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).geometry=r.Cone,e}return(0,i.Z)(n)}(c.W);(0,l._)([(0,u.o)({count:r.COUNT})],h.prototype,"geometry",void 0)},5461:function(e,t,n){n.d(t,{TR:function(){return o},Tk:function(){return a},k8:function(){return s},yx:function(){return i}});var r=n(16889);function i(e){var t=1e5;return(0,r.uZ)((e-t)/9e5,0,1)}var a=1e4,o=.085,s=1e5},87015:function(e,t,n){n.d(t,{S:function(){return xe},C:function(){return ke}});var r=n(74165),i=n(15861),a=n(37762),o=n(60136),s=n(92572),l=n(43144),u=n(15671),c=n(27366),h=n(31319),d=n(14921),f=n(100),p=n(32718),v=n(77427),m=n(92026),_=n(66978),y=n(94172),g=n(49861),b=(n(25243),n(63780),n(69912)),w=n(37818),C=n(16553),x=n(29481),T=n(64488),S=n(70446),k=n(67166),P=n(95437),R=n(89639),A=n(19477);function E(e){return e instanceof A.Z?e.graphics3DSymbol:e instanceof R.Z?e:null}n(93169);var O=n(6394),M=n(11186),Z=n(71353),I=n(67077),D=n(41414),L=n(21400),N=p.Z.getLogger("esri.views.3d.layers.graphics.labelPlacement");function F(e){var t=function(e){var t=e.labelClass.labelPlacement,n=e.labelSymbol,r=e.graphics3DGraphic,i=E(r.graphics3DSymbol),a=(0,m.yw)(i,(function(e){return"point-3d"===e.symbol.type?e.symbol:null})),o=G[t]||H(e);return(0,m.pC)(a)&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:B(a.verticalOffset),anchor:null,normalizedOffset:null}:n&&n.hasVisibleVerticalOffset()&&((0,m.Wi)(a)||!a.supportsCallout()||!a.verticalOffset||r.isDraped)?function(e){return"above-center"===e}(o.placement)?{placement:"above-center",verticalOffset:B(n.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(N.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}(e);if((0,m.Wi)(t))return null;var n=function(e,t){if(t.anchor)return t;var n=e.labelClass.labelPlacement,r=G[n],i=r||H(e);return n&&!r&&N.warnOncePerTick("the requested label placement '".concat(n,"' is currently unsupported in SceneView.")),function(e,t){var n=t.graphics3DGraphic.graphic.geometry;if((0,m.Wi)(n))return null;if((0,m.pC)(t.disablePlacement))return t.labelClass.labelPlacement?(N.warnOncePerTick(V(e.placement,t.disablePlacement.logEntityDescription)),H(t)):e;var r=n.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return N.warnOncePerTick(V(e.placement,"'".concat(r,"' geometries"))),H(t);break;case"point":case"mesh":return e}return e}(i,e)}(e,t);if((0,m.Wi)(n))return null;var r=n.anchor,i=!!t.hasLabelVerticalOffset;return function(e,t,n){var r=n.graphics3DGraphic.graphic.geometry;if((0,m.Wi)(r))return null;switch(r.type){case"point":!function(e,t,n){var r=U(n);if((0,m.Wi)(r))return;var i=n.graphics3DGraphic.layers[0];switch((0,m.pC)(i)?i.getCenterObjectSpace(e.translation):(0,M.s)(e.translation,0,0,0),r.type){case"icon":case"text":!function(e,t,n,r){var i=n.graphics3DGraphic,a=(0,m.pC)(r)?r.getScreenSize():null;if(!i.isDraped&&(0,m.pC)(a)){var o=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:X,n=e.graphics3DGraphic,r=n.layers[0],i=(0,m.pC)(r)?r.stageObject.geometries[0].material:null;if(i&&i instanceof L.A){var a=i.parameters.anchorPosition;t[0]=2*(a[0]-.5),t[1]=2*(a[1]-.5)}else t[0]=0,t[1]=0;return t}(n);Y[0]=a[0]/2*(t.normalizedOffset[0]-o[0]),Y[1]=a[1]/2*(t.normalizedOffset[1]-o[1]),e.screenOffset[0]=Y[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=Y[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=Y[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(G[n.labelClass.labelPlacement]&&N.warnOncePerTick("the requested placement '".concat(t.placement,"' is currently unsupported for draped graphics")),e.anchor="center")}(e,t,n,i);break;case"object":z(e,t,i)}}(e,t,n);break;case"polygon":!function(e,t,n){var r=U(n);if(!(0,m.Wi)(r)&&"extrude"===r.type){var i=n.graphics3DGraphic.layers[0];(0,m.pC)(i)?(i.getBoundingBoxObjectSpace(Q),(0,D.be)(Q,e.translation),e.translation[2]=(0,D.Cb)(Q)/2):(0,M.s)(e.translation,0,0,0),z(e,t,i)}}(e,t,n);break;case"mesh":z(e,t,n.graphics3DGraphic.layers[0])}return e}({anchor:r,verticalOffset:t.verticalOffset,screenOffset:(0,O.a)(),centerOffset:(0,I.f)(0,0,0,-1),centerOffsetUnits:"world",translation:(0,Z.c)(),elevationOffset:0,hasLabelVerticalOffset:i},n,e)}function U(e){var t=E(e.graphics3DGraphic.graphics3DSymbol);return(0,m.pC)(t)?t.symbol.symbolLayers.getItemAt(0):null}function V(e,t){return"the requested label placement '".concat(e,"' is currently unsupported for ").concat(t," in SceneView.")}function H(e){var t=e.graphics3DGraphic.graphic.geometry;if((0,m.Wi)(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":var n=U(e);return(0,m.pC)(n)&&"extrude"===n.type?G["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"};case"point":case"mesh":return G["above-center"];default:return}}function z(e,t,n){var r=(0,m.pC)(n)?n.getBoundingBoxObjectSpace(Q):Q,i=(0,Z.f)(r[3]-r[0],r[4]-r[1],r[5]-r[2]),a=Math.sqrt(i[0]*i[0]+i[1]*i[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];var o=e.translation[2],s=i[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+s;var l=(0,M.l)(i);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function B(e){return{screenLength:e.screenLength,minWorldLength:e.minWorldLength,maxWorldLength:e.maxWorldLength}}var G={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},W={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]},j=function(e){var t=W[e],n=G[e];t.forEach((function(e){G[e]=n}))};for(var q in W)j(q);Object.freeze&&(Object.freeze(G),Object.keys(G).forEach((function(e){Object.freeze(G[e]),Object.freeze(G[e].normalizedOffset)})));var Y=[0,0],X=[0,0],Q=(0,D.Ue)(),J=n(31908),K=function(){function e(t){(0,u.Z)(this,e),this._stage=t,this._materials=new Map}return(0,l.Z)(e,[{key:"get",value:function(e){return this._materials.get(e)}},{key:"add",value:function(e,t){this._materials.set(e,t),this._stage.add(t)}},{key:"dispose",value:function(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}]),e}(),$=n(5008),ee=n(43164),te=n(91505),ne=n(16889),re=n(95439),ie=n(90045),ae=n(79100),oe=n(17852),se=n(4760),le=n(93463),ue=n(8548),ce=n(371),he=512,de=4096,fe=(0,l.Z)((function e(){(0,u.Z)(this,e),this.offset={x:0,y:0},this.uvMinMax=(0,I.c)()})),pe=(0,l.Z)((function e(t,n){(0,u.Z)(this,e),this.textId=t,this.textRenderer=n,this.placement=new fe,this.rendered=!1})),ve=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e)).type=ae.U.Texture,r.id=(0,re.D)(),r.events=new te.Z,r._glTexture=null,r._needsClear=!1,r._elementsToAddOrUpdate=new Map,r._elementsToRemove=new Map,r._elementsToRender=new Map,r._elements=new Map,r._stageObjects=new Map,r.updating=!1,r}return(0,l.Z)(n,[{key:"initialize",value:function(){this._stage=this.view._stage,this._canvas=this._create2DCanvas(),this._ctx=this._canvas.getContext("2d"),this._stage.add(this);var e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}},{key:"unload",value:function(){this._glTexture=(0,m.M2)(this._glTexture),this.updating=!1,this.events.emit("unloaded")}},{key:"width",get:function(){return this._atlas.size.width}},{key:"height",get:function(){return this._atlas.size.height}},{key:"requiresFrameUpdates",get:function(){return!1}},{key:"_createDescriptor",value:function(e){return{target:ue.No.TEXTURE_2D,pixelFormat:ue.VI.RGBA,dataType:ue.Br.UNSIGNED_BYTE,wrapMode:ue.e8.CLAMP_TO_EDGE,flipped:!0,samplingMode:ue.cw.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}},{key:"glTexture",get:function(){return this._glTexture}},{key:"load",value:function(e){return(0,m.pC)(this._glTexture)||(this._glTexture=new ce.x(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(le.T8.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}},{key:"dispose",value:function(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=(0,m.hw)(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=(0,m.M2)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}},{key:"_create2DCanvas",value:function(){var e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",he.toString()),e.setAttribute("height",he.toString()),e}},{key:"_update2DCanvasSize",value:function(){this._canvas.setAttribute("width",this._atlas.size.width.toString()),this._canvas.setAttribute("height",this._atlas.size.height.toString())}},{key:"_createAtlasRegion",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:he;this._atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}},{key:"_computeAtlasResolution",value:function(e,t){var n=Math.max(e,t);return n+=256,n=(0,ne.Sf)(n),n=Math.min(n,de)}},{key:"_resizeAtlas",value:function(e,t){t=t||e;var n=this._atlas;n.size.width=e,n.size.height=t,(0,m.pC)(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}},{key:"_resetAtlasCursor",value:function(){var e=this._atlas;e.cursor.x=_e,e.cursor.y=_e+ye,e.lineHeight=0,this._needsClear=!0}},{key:"_getAtlasUsage",value:function(){var e=this._atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}},{key:"_getExpectedAtlasUsage",value:function(){var e=this._elementsToRemove.size,t=this._elementsToAddOrUpdate.size,n=this._elements.size;return this._getAtlasUsage()/n*(n+t-e)}},{key:"_addAtlasElement",value:function(e,t,n,r){var i=this._atlas,a=e.textRenderer,o=a.renderedWidth,s=a.renderedHeight;e.placement.offset.x=i.cursor.x,e.placement.offset.y=i.cursor.y,(0,ie.s)(e.placement.uvMinMax,e.placement.offset.x/i.size.width,1-(e.placement.offset.y+s)/i.size.height,(e.placement.offset.x+o)/i.size.width,1-e.placement.offset.y/i.size.height),i.cursor.x+=n,i.lineHeight=Math.max(i.lineHeight,r),this._elements.set(t,e)}},{key:"_removeAtlasElement",value:function(e){if(e&&this._elements.has(e.textId)){var t=e.placement.offset;this._ctx.clearRect(t.x,t.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),this._elements.delete(e.textId)}}},{key:"_ensureStageObjects",value:function(e){var t=this._stageObjects.get(e);if(t)return t;var n=new Set;return this._stageObjects.set(e,n),n}},{key:"_addStageObject",value:function(e,t){this._ensureStageObjects(e).add(t)}},{key:"_removeStageObject",value:function(e,t){var n=this._stageObjects.get(e);n&&n.delete(t)&&(t.geometries[0].vertexAttributes.get(se.T.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometries[0]))}},{key:"_processAddition",value:function(e,t){var n=this._atlas,r=e.textId,i=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,o=i+_e,s=a+_e+ye;if(n.cursor.x+o<n.size.width&&n.cursor.y+s<n.size.height)this._addAtlasElement(e,r,o,s),this._elementsToRender.set(r,e),this._elementsToAddOrUpdate.delete(r);else{if(!(n.cursor.y+s+n.lineHeight<n.size.height)){var l=this._getExpectedAtlasUsage(),u=l>.85&&n.size.width<de;return u&&this._resizeAtlas(2*n.size.width,2*n.size.height),!t||!u&&l>.95&&n.size.width===de?(this._processRemovals(),me.OK):(this._repack(),me.REPACK)}n.cursor.x=_e,n.cursor.y+=n.lineHeight,n.lineHeight=0,this._addAtlasElement(e,r,o,s),this._elementsToRender.set(r,e),this._elementsToAddOrUpdate.delete(r)}return me.OK}},{key:"_processRemovals",value:function(){var e=this;this._elementsToRemove.forEach((function(t,n){var r=e._stageObjects.get(n);r&&0!==r.size||e._removeAtlasElement(t),r&&0===r.size&&e._stageObjects.delete(n)})),this._elementsToRemove.clear()}},{key:"_repack",value:function(){var e=this;this._processRemovals(),this._elements.forEach((function(t,n){t.rendered=!1,e._elementsToAddOrUpdate.set(n,t)})),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()}},{key:"_processRenderingRequest",value:function(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);var t=this._stageObjects.get(e.textId);t&&t.forEach((function(t){t.geometries[0].vertexAttributes.get(se.T.UV0).data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get(se.T.SIZE).data=[e.textRenderer.displayWidth,e.textRenderer.displayHeight],t.geometryVertexAttrsUpdated(t.geometries[0])})),e.rendered=!0}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if((0,m.Wi)(this._glTexture))return le.iQ.YIELD;var r=!1;if((0,v.oE)(this._elementsToAddOrUpdate,(function(i,a){var o=t._elements.get(a);if(o&&o.rendered){var s=t._stageObjects.get(a);return s&&s.forEach((function(e){var n=e.geometries[0].vertexAttributes,r=t._elements.get(a);n.get(se.T.UV0).data=r.placement.uvMinMax,n.get(se.T.SIZE).data=[r.textRenderer.displayWidth,r.textRenderer.displayHeight],e.geometryVertexAttrsUpdated(e.geometries[0])})),t._elementsToAddOrUpdate.delete(a),e.madeProgress(),!1}return t._processAddition(t._elementsToAddOrUpdate.get(a),n)===me.REPACK&&(r=!0,!0)})),r)return this.runTask(le.G5,!1),void e.madeProgress();var i=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),(0,v.oE)(this._elementsToRender,(function(n,r){return t._processRenderingRequest(n),t._elementsToRender.delete(r),i=!0,e.madeProgress(),e.done})),i&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&oe.y.orderedRepackingEnabled&&(this.repackOrdered(),e.madeProgress())}},{key:"addTextTexture",value:function(e,t){var n=e.key;this._elementsToAddOrUpdate.has(n)||this._elementsToAddOrUpdate.set(n,new pe(n,e)),this._addStageObject(n,t),this._elementsToRemove.delete(n),this.setDirty()}},{key:"removeTextTexture",value:function(e,t){var n=e.key;this._elementsToRemove.set(n,this._elements.get(n)),this._removeStageObject(n,t)}},{key:"setDirty",value:function(){this._glTexture&&(this.updating=!0)}},{key:"repackOrdered",value:function(){if(0!==this._elements.size){var e=[];this._elements.forEach((function(t,n){return e.push({element:t,key:n})}));for(var t=!0,n=0;n<e.length-1;n++)if(e[n].key.localeCompare(e[n+1].key)>0){t=!1;break}if(!t||this._elementsToRemove.size){e.sort((function(e,t){return e.key.localeCompare(t.key)})),this._elements.clear();var r,i=(0,a.Z)(e);try{for(i.s();!(r=i.n()).done;){var o=r.value,s=o.element,l=o.key;this._elements.set(l,s)}}catch(u){i.e(u)}finally{i.f()}this._repack(),this.setDirty()}}}},{key:"test",get:function(){var e=this._elements,t=this._stageObjects,n=this._elementsToRemove,r=this._atlas,i=this;return{elements:e,stageObjects:t,elementsToRemove:n,atlas:r,resizeAtlas:function(e,t){return i._resizeAtlas(e,t)},run:function(e,t){return i.runTask(e,t)}}}}]),n}(h.Z);(0,c._)([(0,g.Cb)({constructOnly:!0})],ve.prototype,"view",void 0),(0,c._)([(0,g.Cb)({type:Boolean})],ve.prototype,"updating",void 0),ve=(0,c._)([(0,b.j)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],ve);var me,_e=2,ye=2;!function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"}(me||(me={}));var ge=n(97882),be=(0,l.Z)((function e(t,n){(0,u.Z)(this,e),this.labelingContext=t,this.graphics3DGraphic=n,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array})),we=(0,l.Z)((function e(t,n,r,i,a){(0,u.Z)(this,e),this.labelClass=t,this.graphics3DSymbol=n,this.graphics3DCalloutSymbolLayer=r,this.textRenderParameters=i,this.labelFunction=a,this.calloutSymbolLayerIndex=0})),Ce=(0,l.Z)((function e(t,n,r,i,a,o,s){(0,u.Z)(this,e),this.layer=t,this.graphics3DCore=n,this.scaleVisibility=r,this.emptySymbolLabelSupported=i,this.elevationInfoOverride=a,this.disablePlacement=o,this.active=s,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new ge.F({pickable:!0,disableOctree:!0},t.uid)})),xe=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(e){var r;return(0,u.Z)(this,n),(r=t.call(this,e))._dirty=!1,r._labels=new Map,r._labelsToAdd=new Map,r._labelsToRemove=new Map,r._labelingContexts=new Array,r}return(0,l.Z)(n,[{key:"setup",value:function(){var e=this;this.dispose(),this._handles=new f.Z,this._handles.add([(0,y.YP)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(){return e.setDirty()})),(0,y.YP)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.rasterPixelRatio}),(function(){return e._resetAllLabels()})),this.view.resourceController.scheduler.registerTask(le.T8.LABELER,this)]),this._textTextureAtlas=new ve({view:this.view}),this._hudMaterialCollection=new K(this.view._stage),this._calloutMaterialCollection=new K(this.view._stage)}},{key:"dispose",value:function(){this._handles=(0,m.SC)(this._handles),this._textTextureAtlas=(0,m.M2)(this._textTextureAtlas),this._hudMaterialCollection=(0,m.M2)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,m.M2)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}},{key:"_activateLabelingContext",value:function(e){var t=this;e.graphics.forEach((function(n,r){var i=new be(e,n);t._labels.set(r,i),e.labelsToInitialize.set(r,i),n.setVisibilityFlag(S.P.USER_SETTING,!0,S.E.LABEL)})),e.active=!0}},{key:"_deactivateLabelingContext",value:function(e){var t=this;e.graphics.forEach((function(e,n){e.setVisibilityFlag(S.P.USER_SETTING,!1,S.E.LABEL),t.setLabelGraphicVisibility(e,!1),t._labels.delete(n)})),e.active=!1}},{key:"_addLabelTextureToAtlas",value:function(e){var t,n=(0,a.Z)(e.graphics3DGraphic.labelLayers);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r._labelClass){var i=e.textRenderers[r._labelIndex];(0,m.pC)(i)&&this._textTextureAtlas.addTextTexture(i,r.stageObject)}}}catch(o){n.e(o)}finally{n.f()}e.rendered=!0}},{key:"_removeLabelTextureFromAtlas",value:function(e){var t,n=(0,a.Z)(e.graphics3DGraphic.labelLayers);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r._labelClass){var i=e.textRenderers[r._labelIndex];(0,m.pC)(i)&&this._textTextureAtlas.removeTextTexture(i,r.stageObject)}}}catch(o){n.e(o)}finally{n.f()}e.rendered=!1}},{key:"running",get:function(){return this.view.ready&&(this._dirty||this.deconflictor.running)}},{key:"runTask",value:function(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),le.iQ.YIELD}},{key:"_updateLabels",value:function(e){var t=this;if(this._dirty){this._dirty=!1;var n,r=(0,a.Z)(this._labelingContexts);try{var i=function(){var r=n.value;if(r.active){if(!Se(r)){if(function(e){return null===e.labelClassContexts}(r))return t._deactivateLabelingContext(r),"continue";if(t._createLabelClassContext(r),Te(r))return t._dirty=!0,"continue";if(!Se(r))return"continue"}(0,v.oE)(r.labelsToInitialize,(function(n,i){return t._ensureGraphics3DResources(n)&&(t._labels.set(i,n),t.deconflictor.setDirty(),e.madeProgress()),(n.visible&&n.textInitialized||!n.visible&&n.hasGraphics3DResources)&&(r.labelsToInitialize.delete(i),e.madeProgress()),e.done}))&&(t._dirty=!0)}};for(r.s();!(n=r.n()).done;)i()}catch(o){r.e(o)}finally{r.f()}this._labelsToRemove.forEach((function(e){return t._removeLabelTextureFromAtlas(e)})),this._labelsToAdd.forEach((function(e){return t._addLabelTextureToAtlas(e)})),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}},{key:"_createLabelClassContextAsync",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(t){var n,a,o,s,l,u,c,h=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=null===(n=t.labelClassAbortController)||void 0===n?void 0:n.signal,e.next=3,null===(a=(o=t.layer).when)||void 0===a?void 0:a.call(o);case 3:if((0,_.k_)(s),t.scaleVisibility&&t.scaleVisibility.updateScaleRangeActive(),l=t.graphics3DCore,u=l.layer,c=u.labelingInfo&&u.labelingInfo.filter((function(e){return!!e.symbol})),c&&0!==c.length){e.next=8;break}return e.abrupt("return");case 8:return!1,e.next=11,(0,d.Ed)(c,function(){var e=(0,i.Z)((0,r.Z)().mark((function e(n,i){var a,o,u,c,f;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.symbol,o=E(l.getOrCreateGraphics3DSymbol(a)),!(0,m.Wi)(o)){e.next=3;break}return e.abrupt("return",void p.Z.getLogger(h.declaredClass).error("Failed to create Graphics3DSymbol for label"));case 3:return e.next=5,o.load();case 5:if((0,_.k_)(s),u=null,e.t0=(0,x.Pd)(a)&&a.hasVisibleCallout(),!e.t0){e.next=13;break}return u=(0,k.S)(a,l.symbolCreationContext),e.next=12,u.load();case 12:(0,_.k_)(s);case 13:return e.next=15,(0,d.q6)((0,C.createLabelFunction)(n,t.layer.fieldsIndex,h.view.spatialReference));case 15:if(c=e.sent,(0,_.k_)(s),!0!==c.ok){e.next=23;break}return e.next=19,h._createTextRenderParameters(o.symbol);case 19:f=e.sent,(0,_.k_)(s),t.labelClassContexts[i]=new we(n,o,u,f,c.value),e.next=24;break;case 23:p.Z.getLogger(h.declaredClass).error("Label expression failed to evaluate: ".concat(c.error)),!0;case 24:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}());case 11:(0,_.k_)(s);case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createLabelClassContext",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(t){var n=this;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",((0,m.Wi)(t.labelClassPromise)&&(t.labelClassPromise=this._createLabelClassContextAsync(t).catch((function(e){if((0,_.D_)(e))throw e;t.labelClassContexts.length=0})).then((function(){t.labelClassAbortController=null,n.notifyChange("updating")})).catch((function(){})),this.notifyChange("updating")),t.labelClassPromise));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createTextRenderParameters",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(t){var n;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.symbolLayers.getItemAt(0),e.abrupt("return",n&&"text"===n.type?ee.V.fromSymbol(n,this.view.state.rasterPixelRatio):null);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_destroyLabelClassContext",value:function(e){var t,n=(0,a.Z)(e.labelClassContexts);try{for(n.s();!(t=n.n()).done;){--t.value.graphics3DSymbol.referenced}}catch(i){n.e(i)}finally{n.f()}var r=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,m.IM)(r),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}},{key:"_createTextSymbolGraphic",value:function(e,t,n,r,i){var a=new T.i(n.verticalOffset,(0,J.zi)(n.anchor),(0,J.EP)(n.anchor),e.text,n.translation,n.elevationOffset,n.centerOffset,n.screenOffset,n.centerOffsetUnits,e.displayWidth,e.displayHeight);return Pe.graphic=t,Pe.renderingInfo=null,Pe.layer=r,i.createLabel(Pe,a,this._hudMaterialCollection,this._textTextureAtlas)}},{key:"_createLineCalloutGraphic",value:function(e,t,n,r,i){return Pe.graphic=e,Pe.layer=i,Pe.renderingInfo=new P.Ly(null,t,r.translation,r.centerOffset,r.screenOffset,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),n.createGraphics3DGraphic(Pe)}},{key:"_ensureGraphics3DResources",value:function(e){if(e.hasGraphics3DResources)return!1;var t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);var n=e.labelingContext,r=n.labelClassContexts;if(!r||0===r.length||!n.emptySymbolLabelSupported&&0===t.layers.length)return!1;for(var i=!1,a=t.graphic,o=n.layer,s=ke(n.layer),l=this.view._stage,u=0;u<r.length;u++){var c=e.textRenderers[u],h=e.textLabelPlacements[u];if(!(0,m.Wi)(c)&&!(0,m.Wi)(h)){var d=r[u],f=d.graphics3DSymbol,p=f.symbol&&"label-3d"===f.symbol.type?f.symbol:null,v=f.symbolLayers[0];if(v){v.setElevationInfoOverride(n.elevationInfoOverride);var _=this._createTextSymbolGraphic(c,a,h,o,v);if((0,m.Wi)(_))return!1;_._labelClass=d.labelClass,_._labelIndex=u,t.addLabelGraphic(_,l,n.stageLayer),t.setVisibilityFlag(S.P.USER_SETTING,s,S.E.LABEL),t.clearVisibilityFlag(S.P.SCALE_RANGE,S.E.LABEL),t.setVisibilityFlag(S.P.DECONFLICTION,!1,S.E.LABEL),i=!0;var y=d.graphics3DCalloutSymbolLayer;if(y&&h.hasLabelVerticalOffset){y.setElevationInfoOverride(n.elevationInfoOverride);var g=this._createLineCalloutGraphic(a,p,y,h,o);(0,m.pC)(g)&&(d.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(g,l,n.stageLayer))}break}}}return n.scaleVisibility&&i&&n.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}},{key:"_destroyGraphics3DResources",value:function(e){var t,n=e.labelingContext.labelClassContexts,r=(0,a.Z)(e.graphics3DGraphic.labelLayers);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(null!=i._labelClass){var o=n[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=o&&o.onRemoveGraphic(i)}}}catch(s){r.e(s)}finally{r.f()}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}},{key:"_ensureTextTextureResources",value:function(e){if(!e.textInitialized){var t=e.labelingContext,n=t.labelClassContexts;if(n&&0!==n.length){for(var r=e.graphics3DGraphic.graphic,i=0;i<n.length;i++){var a,o=n[i];if(e.textRenderers[i]=null,e.textLabelPlacements[i]=null,o.textRenderParameters){var s=o.labelFunction,l=void 0;if("arcade"===s.type)try{var u=s.needsHydrationToEvaluate()?(0,w.mW)(r,t.layer):r;l=s.evaluate(u)}catch(v){l=null}else l=s.evaluate(r);if(!(0,m.Wi)(l)&&""!==l&&!/^\s+$/.test(l)){var c=o.graphics3DSymbol,h="label-3d"===(null===(a=c.symbol)||void 0===a?void 0:a.type)?c.symbol:null;if(c.symbolLayers[0]){var d=F({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:h,labelClass:o.labelClass,disablePlacement:t.disablePlacement});if(!(0,m.Wi)(d)){var f=(0,J.zi)(d.anchor),p=(0,J.mq)(f);e.textRenderers[i]=new $.tV(l,p,o.textRenderParameters),e.textLabelPlacements[i]=d}}}}}e.textInitialized=!0}}}},{key:"_destroyTextTextureResources",value:function(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}},{key:"_addGraphic",value:function(e,t){var n=t.graphic.uid;if(e.graphics.set(n,t),e.active){var r=new be(e,t);this._labels.set(n,r),e.labelsToInitialize.set(n,r)}this.setDirty(),this.deconflictor.setDirty()}},{key:"_removeGraphic",value:function(e,t){var n=t.graphic.uid,r=this._labels.get(n);e.graphics.delete(n),r&&(this._destroyGraphic(r,n),e.labelsToInitialize.delete(n),this.setDirty(),this.deconflictor.setDirty())}},{key:"_destroyGraphic",value:function(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}},{key:"_labelingInfoChange",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(t,n){var i,o,s,l;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}return e.abrupt("return",(this._visibilityInfoChange(t),this._resetLabels(t),this._createLabelClassContext(t)));case 2:i=(0,a.Z)(n);try{for(i.s();!(o=i.n()).done;)s=o.value,(l=t.graphics.get(s))&&(this._removeGraphic(t,l),this._addGraphic(t,l))}catch(r){i.e(r)}finally{i.f()}case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_globalPropertyChanged",value:function(e,t){var n,r=(0,a.Z)(t.labelClassContexts);try{var i=function(){var r=n.value,i=new Map;t.graphics.forEach((function(e){return i.set(e.graphic.uid,e)}));if((0,m.Wg)(r.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,i,(function(e){return e.labelLayers[0]})),r.graphics3DCalloutSymbolLayer){r.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,i,(function(e){return e.labelLayers[r.calloutSymbolLayerIndex]}))}};for(r.s();!(n=r.n()).done;)i()}catch(o){r.e(o)}finally{r.f()}}},{key:"_visibilityInfoChange",value:function(e){var t=ke(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}},{key:"_resetAllLabels",value:function(){var e,t=(0,a.Z)(this._labelingContexts);try{for(t.s();!(e=t.n()).done;){var n=e.value;this._resetLabels(n)}}catch(r){t.e(r)}finally{t.f()}}},{key:"_resetLabels",value:function(e){var t=this;e.graphics.forEach((function(n,r){var i=t._labels.get(r);i&&(t._destroyGraphic(i,r),i.visible=!1,i.rendered=!1,e.labelsToInitialize.set(r,i))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}},{key:"_findLabelingContext",value:function(e){var t,n=(0,a.Z)(this._labelingContexts);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.graphics3DCore===e)return r}}catch(i){n.e(i)}finally{n.f()}return null}},{key:"addGraphicsOwner",value:function(e,t,n){var r=this,i=n&&n.emptySymbolLabelSupported||!1,a=n&&n.elevationInfoOverride||null,o=n&&n.disablePlacement||null;if(!this._findLabelingContext(e)){var s=e.layer,l=new Ce(s,e,t,i,a,o,ke(s));return this.view._stage.add(l.stageLayer),this._labelingContexts.push(l),this.setDirty(),{addGraphic:function(e){return r._addGraphic(l,e)},removeGraphic:function(e){return r._removeGraphic(l,e)},featureReductionChange:function(){},layerLabelsEnabled:function(){return ke(l.layer)},labelingInfoChange:function(e){return r._labelingInfoChange(l,e)},elevationInfoChange:function(){return r._globalPropertyChanged("elevationInfo",l)},slicePlaneEnabledChange:function(){return r._globalPropertyChanged("slicePlaneEnabled",l)},visibilityInfoChange:function(){return r._visibilityInfoChange(l)},reset:function(){return r._resetLabels(l)},clear:function(){}}}}},{key:"removeGraphicsOwner",value:function(e){var t=this,n=this._findLabelingContext(e);if(n){var r=this._labelingContexts.indexOf(n);this._labelingContexts.splice(r,1),n.graphics.forEach((function(e){return t._removeGraphic(n,e)})),this.view._stage.remove(n.stageLayer),this.setDirty()}}},{key:"setLabelGraphicVisibility",value:function(e,t){var n=e.graphic.uid,r=this._labels.get(n);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(n,r),this._labelsToRemove.delete(n),r.textInitialized||r.labelingContext.labelsToInitialize.set(n,r)):!t&&r.rendered&&(this._labelsToRemove.set(n,r),this._labelsToAdd.delete(n)),r.visible=t,this.setDirty())}},{key:"setDirty",value:function(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}},{key:"updating",get:function(){var e;return this._dirty||(null===(e=this._textTextureAtlas)||void 0===e?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((function(e){return Te(e)}))}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;var e=this._labelingContexts.length>0?this._labelingContexts.reduce((function(e,t){return e+(Te(t)?0:1)}),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){var e=this;return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:function(){return e._resetAllLabels()}}}}]),n}(h.Z);function Te(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function Se(e){return e.labelClassContexts&&e.labelClassContexts.length}function ke(e){var t;return!0===e.labelsVisible&&!(null===(t=e.labelingInfo)||void 0===t||!t.some((function(e){return!!e.symbol})))}(0,c._)([(0,g.Cb)({constructOnly:!0})],xe.prototype,"view",void 0),(0,c._)([(0,g.Cb)({constructOnly:!0})],xe.prototype,"deconflictor",void 0),(0,c._)([(0,g.Cb)()],xe.prototype,"_textTextureAtlas",void 0),(0,c._)([(0,g.Cb)({type:Boolean,readOnly:!0})],xe.prototype,"updating",null),xe=(0,c._)([(0,b.j)("esri.views.3d.layers.graphics.Labeler")],xe);var Pe=new P._D(null,null,null)},85312:function(e,t,n){n.d(t,{A8:function(){return v},AK:function(){return c},DI:function(){return f},GS:function(){return p},a8:function(){return h},f9:function(){return d}});var r=n(43144),i=n(15671),a=n(60136),o=n(92572),s=n(54463),l=n(55848),u=n(22178),c=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,r,a,o){var s;return(0,i.Z)(this,n),(s=t.call(this,r,a)).point=e,s.createGraphic=o,s}return(0,r.Z)(n)}(l.Dx);function h(e){return(0,u.nn)(e)&&e.intersector===s.q7.PCL&&!!e.target}var d=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,r,a,o,s){var l;return(0,i.Z)(this,n),(l=t.call(this,e)).layerUid=e,l.sublayerUid=r,l.nodeIndex=a,l.componentIndex=o,l.triangleNr=s,l}return(0,r.Z)(n)}(l.Zh),f=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,r,a){var o;return(0,i.Z)(this,n),(o=t.call(this,r,null)).point=e,o.createVoxelGraphic=a,o}return(0,r.Z)(n)}(l.Dx);function p(e){return(0,u.nn)(e)&&e.intersector===s.q7.I3S&&!!e.target}function v(e){return(0,u.nn)(e)&&e.intersector===s.q7.VOXEL&&!!e.target}},13470:function(e,t,n){n.d(t,{C:function(){return l},E:function(){return r}});var r,i,a=n(15671),o=n(43144),s=n(65156),l=function(){function e(t,n,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,a.Z)(this,e),this.lij=[0,0,0],this.extent=(0,s.Ue)(),this.resolution=0,this.loadPriority=0,this.measures={visibility:r.VISIBLE_ON_SURFACE,screenRect:(0,s.Ue)(),distance:0,shouldSplit:!1},this.used=!1,o&&this.acquire(t,n,i,o)}return(0,o.Z)(e,[{key:"acquire",value:function(t,n,r,i){this.tilingScheme=i,this.id=e.id(t,n,r),this.lij[0]=t,this.lij[1]=n,this.lij[2]=r,i.getExtent(t,n,r,this.extent),this.resolution=i.resolutionAtLevel(t)}},{key:"release",value:function(){this.tilingScheme=null}},{key:"getChildren",value:function(t){var n=this.lij[0]+1,r=2*this.lij[1],i=2*this.lij[2];return t?(t[0].acquire(n,r,i,this.tilingScheme),t[1].acquire(n,r+1,i,this.tilingScheme),t[2].acquire(n,r,i+1,this.tilingScheme),t[3].acquire(n,r+1,i+1,this.tilingScheme),t):[new e(n,r,i,this.tilingScheme),new e(n,r+1,i,this.tilingScheme),new e(n,r,i+1,this.tilingScheme),new e(n,r+1,i+1,this.tilingScheme)]}},{key:"copyMeasurementsFrom",value:function(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,(0,s.JG)(e.measures.screenRect,this.measures.screenRect)}}],[{key:"id",value:function(e,t,n){return"".concat(e,"/").concat(t,"/").concat(n)}}]),e}();(i=r||(r={}))[i.INVISIBLE=0]="INVISIBLE",i[i.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",i[i.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"},38161:function(e,t,n){n.d(t,{i:function(){return l}});var r=n(15671),i=n(43144),a=n(11186),o=n(71353),s=n(95773),l=function(){function e(t){(0,r.Z)(this,e),this.renderCoordsHelper=t,this.frustum=(0,s.Ue)(),this._points=(0,s.Hf)(),this.lines=new Array(12),this._origin=(0,o.c)(),this._direction=(0,o.c)(),this._altitude=null;for(var n=0;n<12;n++)this.lines[n]={origin:null,direction:(0,o.c)(),endpoint:null}}return(0,i.Z)(e,[{key:"planes",get:function(){return this.frustum}},{key:"points",get:function(){return this._points}},{key:"mutablePoints",get:function(){return this._points}},{key:"direction",get:function(){return this._direction}},{key:"update",value:function(e){(0,s.q_)(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,a.c)(this._origin,e.eye),(0,a.c)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}},{key:"updatePoints",value:function(e){for(var t=0;t<this._points.length;t++)(0,a.c)(this._points[t],e[t]);(0,s.Jp)(this.frustum,this._points),this._updateLines()}},{key:"altitude",get:function(){return this._altitude}},{key:"intersectsSphere",value:function(e){return(0,s.hr)(this.frustum,e)}},{key:"intersectsRay",value:function(e){return(0,s.Zr)(this.frustum,e)}},{key:"intersectsLineSegment",value:function(e,t){return(0,s.rN)(this.frustum,e,t)}},{key:"intersectsPoint",value:function(e){return(0,s.g8)(this.frustum,e)}},{key:"_updateLines",value:function(){for(var e=this._points,t=0;t<4;t++){var n=t+4;u(this.lines[t],e[t],e[n]),u(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),u(this.lines[t+8],e[n],3===t?e[4]:e[n+1])}}}]),e}();function u(e,t,n){e.origin=t,e.endpoint=n,(0,a.r)(e.direction,t,n)}l.planePointIndices=s.xu,l.nearFarLineIndices=[[s.NQ.NEAR_BOTTOM_LEFT,s.NQ.FAR_BOTTOM_LEFT],[s.NQ.NEAR_BOTTOM_RIGHT,s.NQ.FAR_BOTTOM_RIGHT],[s.NQ.NEAR_TOP_RIGHT,s.NQ.FAR_TOP_RIGHT],[s.NQ.NEAR_TOP_LEFT,s.NQ.FAR_TOP_LEFT]]},17539:function(e,t,n){n.d(t,{Z:function(){return w}});var r=n(15671),i=n(43144),a=n(16889),o=n(92026),s=n(68860),l=n(14226),u=n(11186),c=n(18722);function h(e){return function(e){return(0,c.xZ)(e)&&e.length>=3}(e)||function(e){return((0,c.fS)(e)||Array.isArray(e))&&e.length>=3}(e)}var d=n(79803),f=n(14320),p=n(85305),v=n(55652),m=n(40927),_=n(51378),y=n(81020),g=n(50951),b=n(92028),w=function(){function e(t,n,i,a){(0,r.Z)(this,e),this.viewingMode=t,this.spatialReference=n,this.unitInMeters=i,this._coordinateSystem=a,this._tmpCoordinateSystem=(0,p.Ue)(a)}return(0,i.Z)(e,[{key:"extent",set:function(e){e&&(0,p.qf)(this._coordinateSystem,e,this._coordinateSystem)}},{key:"getAltitude",value:function(e){return(0,p.id)(this._coordinateSystem,e)}},{key:"setAltitude",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return(0,p.Is)(this._coordinateSystem,n,t,e)}},{key:"setAltitudeOfTransformation",value:function(e,t){(0,p.rF)(this._coordinateSystem,t,e,t)}},{key:"worldUpAtPosition",value:function(e,t){return(0,p.P0)(this._coordinateSystem,e,t)}},{key:"worldBasisAtPosition",value:function(e,t,n){return(0,p.Kf)(this._coordinateSystem,e,t,n)}},{key:"basisMatrixAtPosition",value:function(e,t){var n=this.worldBasisAtPosition(e,f.R.X,_.WM.get()),r=this.worldBasisAtPosition(e,f.R.Y,_.WM.get()),i=this.worldBasisAtPosition(e,f.R.Z,_.WM.get());return(0,l.s)(t,n[0],n[1],n[2],0,r[0],r[1],r[2],0,i[0],i[1],i[2],0,0,0,0,1),t}},{key:"headingAtPosition",value:function(e,t){var n=this.worldUpAtPosition(e,_.WM.get()),r=this.worldBasisAtPosition(e,f.R.Y,_.WM.get()),i=(0,m.cp)(t,r,n);return(0,a.BV)(i)}},{key:"intersectManifoldClosestSilhouette",value:function(e,t,n){return(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem),(0,p.ej)(this._tmpCoordinateSystem,e,n),n}},{key:"intersectManifold",value:function(e,t,n){(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);var r=_.WM.get();return(0,p.BR)(this._tmpCoordinateSystem,e,r)?(0,u.c)(n,r):null}},{key:"intersectInfiniteManifold",value:function(e,t,n){if(this.viewingMode===g.JY.Global)return this.intersectManifold(e,t,n);(0,p.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);var r=this._tmpCoordinateSystem.value,i=_.WM.get();return(0,v.BR)(r.plane,e,i)?(0,u.c)(n,i):null}},{key:"toRenderCoords",value:function(e,t,n){return(0,y.f)(e)?(0,d.KC)(e,t,this.spatialReference):(0,d.SH)(e,t,n,this.spatialReference)}},{key:"fromRenderCoords",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,y.f)(t)?((0,o.pC)(n)&&(t.spatialReference=n),(0,d.MT)(e,this.spatialReference,t)):h(t)?(0,d.SH)(e,this.spatialReference,t,n)?t:null:(0,d.fA)(e,this.spatialReference,t)}}],[{key:"create",value:function(t,n){switch(t){case g.JY.Local:return new e(g.JY.Local,n,(0,s.c9)(n),(0,p.pb)());case g.JY.Global:return new e(g.JY.Global,n,1,(0,p.pt)(n))}}},{key:"renderUnitScaleFactor",value:function(e,t){return C(e)/C(t)}}]),e}();function C(e){if((0,b.D)(e,g.JY.Global))return 1;var t=(0,p.E2)(!1,e);return(0,s.c9)(t)}},95911:function(e,t,n){n.d(t,{nN:function(){return R},wu:function(){return S}});var r=n(1413),i=n(37762),a=n(15671),o=n(43144),s=n(60136),l=n(92572),u=n(27366),c=n(76200),h=n(31319),d=n(63780),f=n(10064),p=n(84652),v=n(92026),m=n(66978),_=n(49861),y=(n(25243),n(69912)),g=n(97731),b=(0,o.Z)((function e(t){(0,a.Z)(this,e),this.client=t,this._cancelled=!1,this.size=0,this.duration=0})),w=(0,o.Z)((function e(t){(0,a.Z)(this,e),this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new C})),C=(0,o.Z)((function e(){(0,a.Z)(this,e),this.requests=0,this.size=0,this.duration=0,this.speed=0})),x=function(){function e(t,n,r,i){(0,a.Z)(this,e),this._workerFunc=t,this._callbackFunc=n,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=i.map((function(e){return new w(e)}))}return(0,o.Z)(e,[{key:"destroy",value:function(){this._clients.length=0}},{key:"hasQuota",value:function(e){var t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}},{key:"push",value:function(e){var t=this,n=this._clients[e.client];n&&(this._totalNumWorkers<this._maxTotalNumWorkers?(n.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(function(e,n){return t._taskCallback(e,n)}))):n.tasks.push(e))}},{key:"cancel",value:function(e){this._taskFinished(e),e._cancelled=!0}},{key:"_taskFinished",value:function(e){var t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,g.hu)(t.numWorkers>=0),this._next()}},{key:"_next",value:function(){var e,t=(0,i.Z)(this._clients);try{for(t.s();!(e=t.n()).done;){var n=e.value;if(n&&n.numWorkers<n.typeWorkerQuota&&this._processQueue(n))return}}catch(s){t.e(s)}finally{t.f()}var r,a=(0,i.Z)(this._clients);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o&&this._processQueue(o))return}}catch(s){a.e(s)}finally{a.f()}}},{key:"_processQueue",value:function(e){for(var t=this;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(function(e,n){return t._taskCallback(e,n)})))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}},{key:"_taskCallback",value:function(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}},{key:"getStatsForType",value:function(e){var t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}},{key:"test",get:function(){var e=this;return{set workerFunc(t){e._workerFunc=t}}}}]),e}(),T=n(93463),S=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments))._tasks=new Map,e._onLoadQueue=new Array,e._doneQueue=new Array,e.updating=!1,e}return(0,o.Z)(n,[{key:"setup",value:function(e,t,n){var r=this;this._loadQueue=new x((function(e,t){return r._startLoading(e,t)}),(function(e,t){return r._doneLoadingCB(e,t)}),e,t),n&&(this._frameTask=n.registerTask(T.T8.STREAM_DATA_LOADER,this))}},{key:"destroy",value:function(){this._frameTask=(0,v.hw)(this._frameTask),this._tasks.forEach((function(e){return(0,v.IM)(e.abortController)})),this._loadQueue=(0,v.SC)(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}},{key:"hasDownloadSlots",value:function(e){return this._loadQueue.hasQuota(e)}},{key:"request",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=(0,m.hh)();a.__signal=(0,v.pC)(i)?i.signal:null;var o=this._createOrUpdateTask(e,t,n,i,a);return(0,m.fu)(i,(function(){return r._cancelRequest(o,a)})),a.promise}},{key:"_createTask",value:function(e,t,n,r,i,a){var o=new A(e,t,n,r,i);return this._updateTask(o,a),this._tasks.set(i,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}},{key:"_cancelRequest",value:function(e,t){var n;(0,d.e$)(e.resolvers,t),t.reject((0,m.zE)()),0===e.resolvers.length&&(e.status===P.DOWNLOADING&&(e.status=P.CANCELLED,this._loadQueue.cancel(e),null!==(n=e.abortController)&&void 0!==n&&n.abort(),e.request=null,e.abortController=null),e.status=P.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}},{key:"_updateTask",value:function(e,t){e.resolvers.push(t)}},{key:"_createOrUpdateTask",value:function(e,t,n,r,i){var a=function(e,t,n){return"".concat(e,":").concat(t,":").concat(n)}((0,v.pC)(r)&&r.uid||e,t,n),o=this._tasks.get(a);return o?(this._updateTask(o,i),o):this._createTask(e,r,t,n,a,i)}},{key:"_doneLoadingCB",value:function(e,t){this._loadQueue&&((0,g.hu)(e.status===P.DOWNLOADING),e.status=P.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}},{key:"running",get:function(){return this._doneQueue.length>0||this._onLoadQueue.length>0}},{key:"runTask",value:function(e){for(;!e.done&&this._onLoadQueue.length>0;){var t=this._onLoadQueue.shift();(0,m.k_)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){var n=this._doneQueue.shift();n.task.status!==P.DOWNLOADED&&(n.err=n.err||(0,m.zE)()),this._doneLoading(n.task,n.err),e.madeProgress()}}},{key:"_doneLoading",value:function(e,t){if(t&&!(0,m.D_)(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);var n,r=e.result instanceof HTMLImageElement?0:e.resolvers.length,a=(0,i.Z)(e.resolvers);try{for(a.s();!(n=a.n()).done;){var o=n.value;if(t)(0,m.D_)(t)?o.reject(t):o.reject(new f.Z("stream-data-loader:request-error","Failed to request resource at '".concat(e.url,"'. ").concat(t),{url:e.url,error:t}));else{var s=--r<=0?e.result:(0,p.d9)(e.result);o.resolve(s)}}}catch(l){a.e(l)}finally{a.f()}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}},{key:"_startLoading",value:function(e,t){var n,i,a=this;if(e.status===P.CANCELLED)return!1;switch(e.startTime=performance.now(),e.status=P.DOWNLOADING,e.docType){case"binary":i="array-buffer",n=0;break;case"image":i="image";break;case"image+type":i="array-buffer";break;default:i="json"}e.abortController=new AbortController;var o=e.abortController.signal;e.request=(0,c.default)(e.url,(0,r.Z)((0,r.Z)({},e.options),{},{responseType:i,timeout:n,signal:o}));var s=function(){},l=function(n){e.duration=performance.now()-e.startTime,e.size=n instanceof ArrayBuffer?n.byteLength:e.size||0,e.result=n,a._frameTask?a._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},u=function(n){e.status===P.DOWNLOADING&&t(e,n),s()};return"image+type"!==e.docType?(e.request.then((function(e){return l(e.data)}),u),!0):(e.request.then((function(t){var r=t.data,a=function(e){if(e.byteLength<2)return"unknown";var t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(r);if(i="image",e.size=r.byteLength,"unknown"===a)return e.request=(0,c.default)(e.url,{responseType:i,timeout:n,signal:o}),void e.request.then((function(e){return l(e.data)}),u);var h=new Blob([r],{type:a}),d=window.URL.createObjectURL(h);s=function(){return window.URL.revokeObjectURL(d)},e.request=(0,c.default)(d,{responseType:i,timeout:n,signal:o}),e.request.then((function(e){return l(new R(e.data,a,s))}),u)}),u),!0)}},{key:"test",get:function(){return{loadQueue:this._loadQueue}}}]),n}(h.Z);(0,u._)([(0,_.Cb)({readOnly:!0})],S.prototype,"updating",void 0),S=(0,u._)([(0,y.j)("esri.views.3d.support.StreamDataLoader")],S);var k=0;var P,R=function(){function e(t,n,r){(0,a.Z)(this,e),this.image=t,this.type=n,this.release=r}return(0,o.Z)(e,[{key:"isOpaque",get:function(){return"image/jpeg"===this.type}}]),e}(),A=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,r,i,o,s){var l;return(0,a.Z)(this,n),(l=t.call(this,o)).url=e,l.options=r,l.docType=i,l.key=s,l.result=null,l.status=P.QUEUED,l.request=null,l.abortController=null,l.resolvers=new Array,l.startTime=0,l.numRetries=k,l}return(0,o.Z)(n)}(b);!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(P||(P={}))},22526:function(e,t,n){n.d(t,{HL:function(){return o},aj:function(){return s}});var r=n(1413),i=n(25158),a=n(55158);function o(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:l(e.layout)}}function s(e){return function(e){var t=(0,a.U$)();return t.stride=e.stride,t.fieldNames=e.fieldNames,e.fields.forEach((function(e){return t.fields.set(e[0],(0,r.Z)((0,r.Z)({},e[1]),{},{constructor:h(e[1].constructor)}))})),t}(e.layout).createView(e.buffer)}function l(e){var t=new Array;return e.fields.forEach((function(e,n){var i=(0,r.Z)((0,r.Z)({},e),{},{constructor:c(e.constructor)});t.push([n,i])})),{stride:e.stride,fields:t,fieldNames:e.fieldNames}}var u=[i.ly,i.Eu,i.ct,i.ek,i.gK,i.bj,i.oS,i.q6,i.fP,i.Cd,i.ey,i.O1,i.D_,i.xA,i.ne,i.mc,i.av,i.TS,i.mw,i.v6,i.Nu,i.qt,i.G5,i.hu,i.Hz,i.Vs,i.P_,i.ir,i.o7,i.or,i.n1,i.zO,i.Jj,i.wA,i.PP,i.TN];function c(e){return"".concat(e.ElementType,"_").concat(e.ElementCount)}function h(e){return d.get(e)}var d=new Map;u.forEach((function(e){return d.set(c(e),e)}))},81703:function(e,t,n){n.d(t,{Bh:function(){return u},eW:function(){return h},iE:function(){return c},u4:function(){return l}});var r=n(92026),i=n(17842),a=n(88396),o=n(11186),s=n(51378);function l(e,t,n){return u(e,e.screenToRender(t,(0,i.Wv)(s.WM.get())),n)}function u(e,t,n){var l=(0,i.Wv)((0,a.c)(s.WM.get(),t));if(l[2]=0,!e.unprojectFromRenderScreen(l,n.origin))return null;var u=(0,i.Wv)((0,a.c)(s.WM.get(),t));u[2]=1;var c=e.unprojectFromRenderScreen(u,s.WM.get());return(0,r.Wi)(c)?null:((0,o.b)(n.direction,c,n.origin),n)}function c(e,t,n){return h(e,e.screenToRender(t,(0,i.Wv)(s.WM.get())),n)}function h(e,t,n){(0,o.c)(n.origin,e.eye);var i=(0,o.s)(s.WM.get(),t[0],t[1],1),a=e.unprojectFromRenderScreen(i,s.WM.get());return(0,r.Wi)(a)?null:((0,o.b)(n.direction,a,n.origin),n)}},45888:function(e,t,n){var r;n.d(t,{Bh:function(){return r},NT:function(){return a},Ty:function(){return i}}),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(r||(r={}));var i=function(){var e=new Array;return e[r.ELEVATION]=10,e[r.BASEMAP]=10,e[r.I3S_INDEX]=10,e[r.I3S_DATA]=10,e[r.SYMBOLOGY]=5,e}(),a=30},89414:function(e,t,n){n.d(t,{JF:function(){return ye},d9:function(){return be},Qb:function(){return Ce},gI:function(){return Me},$e:function(){return Ee},Ue:function(){return ge},fn:function(){return Re},hZ:function(){return xe},pn:function(){return Pe},n3:function(){return ke},JH:function(){return Se},xz:function(){return Ae},q0:function(){return Oe},t8:function(){return we},mr:function(){return Te}});var r=n(43144),i=n(15671),a=n(22753),o=n(11873),s=n(48976),l=n(4582),u=n(98131),c=n(11186),h=n(8229),d=n(71353),f=(n(90045),n(67077)),p=n(41414),v=n(55652),m=n(50951),_=n(91526),y=1e-6,g=[0,0,0],b=[0,0,0];function w(e,t,n,r,i,a,o,s,l,u){return function(e,t,n){for(var r=de(e.maxVert[0],e.minVert[0]),i=0,a=1;a<7;++a){var o=de(e.maxVert[a],e.minVert[a]);o>r&&(r=o,i=a)}le(t,e.minVert[i]),le(n,e.maxVert[i])}(e,r,i),de(r,i)<y?1:(oe(o,r,i),ce(o,o),function(e,t,n,r){for(var i=e.data,a=e.size,o=Number.NEGATIVE_INFINITY,s=0,l=0;l<i.length;l+=a){O[0]=i[l]-t[0],O[1]=i[l+1]-t[1],O[2]=i[l+2]-t[2];var u=n[0]*O[0]+n[1]*O[1]+n[2]*O[2],c=n[0]*n[0]+n[1]*n[1]+n[2]*n[2],h=O[0]*O[0]+O[1]*O[1]+O[2]*O[2]-u*u/c;h>o&&(o=h,s=l)}return le(r,i,s),o}(t,r,o,a)<y?2:(oe(s,i,a),ce(s,s),oe(l,a,r),ce(l,l),ue(n,s,o),ce(n,n),V(t,n,o,s,l,u),0))}var C=[0,0,0],x=[0,0,0],T=[0,0,0],S=[0,0,0],k=[0,0,0],P=[0,0,0],R=[0,0,0],A=[0,0,0];function E(e,t,n,r,i,a,o,s,l){Z(e,t,n,C,x),void 0!==C[0]&&(oe(T,C,n),ce(T,T),oe(S,C,r),ce(S,S),oe(k,C,i),ce(k,k),ue(P,S,a),ce(P,P),ue(R,k,o),ce(R,R),ue(A,T,s),ce(A,A),V(e,P,a,S,T,l),V(e,R,o,k,S,l),V(e,A,s,T,k,l)),void 0!==x[0]&&(oe(T,x,n),ce(T,T),oe(S,x,r),ce(S,S),oe(k,x,i),ce(k,k),ue(P,S,a),ce(P,P),ue(R,k,o),ce(R,R),ue(A,T,s),ce(A,A),V(e,P,a,S,T,l),V(e,R,o,k,S,l),V(e,A,s,T,k,l))}var O=[0,0,0];var M=[0,0];function Z(e,t,n,r,i){!function(e,t,n,r,i){var a=e.data,o=e.size;le(r,a),le(i,r),n[0]=fe(H,t),n[1]=n[0];for(var s=o;s<a.length;s+=o){var l=a[s]*t[0]+a[s+1]*t[1]+a[s+2]*t[2];l<n[0]&&(n[0]=l,le(r,a,s)),l>n[1]&&(n[1]=l,le(i,a,s))}}(e,t,M,i,r);var a=fe(n,t);M[1]-y<=a&&(r[0]=void 0),M[0]+y>=a&&(i[0]=void 0)}var I=[0,0,0],D=[0,0,0],L=[0,0,0],N=[0,0,0],F=[0,0,0],U=[0,0,0];function V(e,t,n,r,i,a){if(!(he(t)<y)){ue(I,n,t),ue(D,r,t),ue(L,i,t),z(e,t,M),F[1]=M[0],N[1]=M[1],U[1]=N[1]-F[1];for(var o=[n,r,i],s=[I,D,L],l=0;l<3;++l){z(e,o[l],M),F[0]=M[0],N[0]=M[1],z(e,s[l],M),F[2]=M[0],N[2]=M[1],U[0]=N[0]-F[0],U[2]=N[2]-F[2];var u=ie(U);u<a.quality&&(le(a.b0,o[l]),le(a.b1,t),le(a.b2,s[l]),a.quality=u)}}}var H=[0,0,0];function z(e,t,n){var r=e.data,i=e.size;n[0]=Number.POSITIVE_INFINITY,n[1]=Number.NEGATIVE_INFINITY;for(var a=0;a<r.length;a+=i){var o=r[a]*t[0]+r[a+1]*t[1]+r[a+2]*t[2];n[0]=Math.min(n[0],o),n[1]=Math.max(n[1],o)}}function B(e,t,n){le(n.center,e),se(n.halfSize,t,.5),n.quaternion[0]=0,n.quaternion[1]=0,n.quaternion[2]=0,n.quaternion[3]=1}var G=[0,0,0],W=[0,0,0],j=[0,0,0],q=[0,0,0],Y=[0,0,0],X=[0,0,0];function Q(e,t,n){le(G,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?G[0]=0:Math.abs(t[1])>Math.abs(t[2])?G[1]=0:G[2]=0,he(G)<y&&(G[0]=G[1]=G[2]=1),ue(W,t,G),ce(W,W),ue(j,t,W),ce(j,j),J(e,t,W,j,q,Y),oe(X,Y,q),te(t,W,j,q,Y,X,n)}function J(e,t,n,r,i,a){z(e,t,M),i[0]=M[0],a[0]=M[1],z(e,n,M),i[1]=M[0],a[1]=M[1],z(e,r,M),i[2]=M[0],a[2]=M[1]}var K=[0,0,0],$=[1,0,0,0,1,0,0,0,1],ee=[0,0,0];function te(e,t,n,r,i,a,o){$[0]=e[0],$[1]=e[1],$[2]=e[2],$[3]=t[0],$[4]=t[1],$[5]=t[2],$[6]=n[0],$[7]=n[1],$[8]=n[2],function(e,t){var n=t[0]+t[4]+t[8];if(n>0){var r=Math.sqrt(n+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3,s=Math.sqrt(t[3*i+i]-t[3*a+a]-t[3*o+o]+1);e[i]=.5*s,s=.5/s,e[3]=(t[3*a+o]-t[3*o+a])*s,e[a]=(t[3*a+i]+t[3*i+a])*s,e[o]=(t[3*o+i]+t[3*i+o])*s}}(o.quaternion,$),ae(ee,r,i),se(ee,ee,.5),se(o.center,e,ee[0]),se(K,t,ee[1]),ae(o.center,o.center,K),se(K,n,ee[2]),ae(o.center,o.center,K),se(o.halfSize,a,.5)}var ne=(0,r.Z)((function e(t){(0,i.Z)(this,e),this.minVert=new Array(7),this.maxVert=new Array(7);this.buffer=new ArrayBuffer(448);var n=0;this.minProj=new Float64Array(this.buffer,n,7),n+=56,this.maxProj=new Float64Array(this.buffer,n,7),n+=56;for(var r=0;r<7;++r)this.minVert[r]=new Float64Array(this.buffer,n,3),n+=24;for(var a=0;a<7;++a)this.maxVert[a]=new Float64Array(this.buffer,n,3),n+=24;for(var o=0;o<7;++o)this.minProj[o]=Number.POSITIVE_INFINITY,this.maxProj[o]=Number.NEGATIVE_INFINITY;for(var s=new Array(7),l=new Array(7),u=t.data,c=t.size,h=0;h<u.length;h+=c){var d=u[h];d<this.minProj[0]&&(this.minProj[0]=d,s[0]=h),d>this.maxProj[0]&&(this.maxProj[0]=d,l[0]=h),(d=u[h+1])<this.minProj[1]&&(this.minProj[1]=d,s[1]=h),d>this.maxProj[1]&&(this.maxProj[1]=d,l[1]=h),(d=u[h+2])<this.minProj[2]&&(this.minProj[2]=d,s[2]=h),d>this.maxProj[2]&&(this.maxProj[2]=d,l[2]=h),(d=u[h]+u[h+1]+u[h+2])<this.minProj[3]&&(this.minProj[3]=d,s[3]=h),d>this.maxProj[3]&&(this.maxProj[3]=d,l[3]=h),(d=u[h]+u[h+1]-u[h+2])<this.minProj[4]&&(this.minProj[4]=d,s[4]=h),d>this.maxProj[4]&&(this.maxProj[4]=d,l[4]=h),(d=u[h]-u[h+1]+u[h+2])<this.minProj[5]&&(this.minProj[5]=d,s[5]=h),d>this.maxProj[5]&&(this.maxProj[5]=d,l[5]=h),(d=u[h]-u[h+1]-u[h+2])<this.minProj[6]&&(this.minProj[6]=d,s[6]=h),d>this.maxProj[6]&&(this.maxProj[6]=d,l[6]=h)}for(var f=0;f<7;++f){var p=s[f];le(this.minVert[f],u,p),p=l[f],le(this.maxVert[f],u,p)}})),re=(0,r.Z)((function e(){(0,i.Z)(this,e),this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}));function ie(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function ae(e,t,n){e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2]}function oe(e,t,n){e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2]}function se(e,t,n){e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n}function le(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e[0]=t[n+0],e[1]=t[n+1],e[2]=t[n+2]}function ue(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[0],s=n[1],l=n[2];e[0]=i*l-a*s,e[1]=a*o-r*l,e[2]=r*s-i*o}function ce(e,t){var n=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(n>0){var r=1/Math.sqrt(n);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function he(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function de(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return n*n+r*r+i*i}function fe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}var pe=(0,u.a)(),ve=(0,d.c)(),me=(0,d.c)(),_e=((0,f.c)(),(0,o.c)()),ye=(0,r.Z)((function e(t){(0,i.Z)(this,e);var n=56*t;this.buffer=new ArrayBuffer(n),this.obbs=new Array(t);for(var r=0;r<t;r++)this.obbs[r]={center:(0,d.b)(this.buffer,56*r+0),halfSize:(0,h.a)(this.buffer,56*r+24),quaternion:(0,l.a)(this.buffer,56*r+36)}}));function ge(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[-1,-1,-1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,u.a)();return{center:(0,d.a)(e),halfSize:(0,h.b)(t),quaternion:(0,l.b)(n)}}function be(e){return ge(e.center,e.halfSize,e.quaternion)}function we(e,t){(0,c.c)(t.center,e.center),(0,c.c)(t.halfSize,e.halfSize),(0,s.a)(t.quaternion,e.quaternion)}function Ce(e,t){return function(e,t){var n=e,r=n.data,i=n.size,a=r.length/i;if(!(a<=0)){var o=new ne(e);ae(g,o.minProj,o.maxProj),se(g,g,.5),oe(b,o.maxProj,o.minProj);var s=ie(b),l=new re;l.quality=s,a<14&&(e=new _.a(new Float64Array(o.buffer,112,42),3));var u=[0,0,0],c=[0,0,0],h=[0,0,0],d=[0,0,0],f=[0,0,0],p=[0,0,0],v=[0,0,0];switch(w(o,e,v,u,c,h,d,f,p,l)){case 1:return void B(g,b,t);case 2:return void Q(e,d,t)}E(e,v,u,c,h,d,f,p,l),J(e,l.b0,l.b1,l.b2,q,Y);var m=[0,0,0];oe(m,Y,q),l.quality=ie(m),l.quality<s?te(l.b0,l.b1,l.b2,q,Y,m,t):B(g,b,t)}}(e,t=t||ge()),t}function xe(e,t){var n=(0,v.jH)(t,e.center),r=Ae(e,(0,v.mJ)(t));return n>r?1:n<-r?-1:0}function Te(e,t){t||(t=(0,p.Ue)());var n=(0,a.c)(_e,e.quaternion),r=e.halfSize[0]*Math.abs(n[0])+e.halfSize[1]*Math.abs(n[3])+e.halfSize[2]*Math.abs(n[6]),i=e.halfSize[0]*Math.abs(n[1])+e.halfSize[1]*Math.abs(n[4])+e.halfSize[2]*Math.abs(n[7]),o=e.halfSize[0]*Math.abs(n[2])+e.halfSize[1]*Math.abs(n[5])+e.halfSize[2]*Math.abs(n[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-i,t[2]=e.center[2]-o,t[3]=e.center[0]+r,t[4]=e.center[1]+i,t[5]=e.center[2]+o,t}function Se(e,t){return(0,v.jH)(t,e.center)-Ae(e,(0,v.mJ)(t))}function ke(e,t){return(0,v.jH)(t,e.center)+Ae(e,(0,v.mJ)(t))}function Pe(e,t){return xe(e,t[0])<=0&&xe(e,t[1])<=0&&xe(e,t[2])<=0&&xe(e,t[3])<=0&&xe(e,t[4])<=0&&xe(e,t[5])<=0}function Re(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;(0,s.c)(pe,e.quaternion),(0,c.b)(ve,t,e.center);for(var i=(0,c.q)(ve,ve,pe),a=(0,c.q)(me,n,pe),o=-1/0,l=1/0,u=0;u<3;u++)if(Math.abs(a[u])>1e-6){var h=(r+e.halfSize[u]-i[u])/a[u],d=(-r-e.halfSize[u]-i[u])/a[u];o=Math.max(o,Math.min(h,d)),l=Math.min(l,Math.max(h,d))}else if(i[u]>e.halfSize[u]+r||i[u]<-e.halfSize[u]-r)return!1;return o<=l}!function(){var e=new Int8Array(162),t=0,n=function(n){for(var r=0;r<n.length;r++)e[t+r]=n[r];t+=6};n([6,2,3,1,5,4]),n([0,2,3,1,5,4]),n([0,2,3,7,5,4]),n([0,1,3,2,6,4]),n([0,1,3,2,0,0]),n([0,1,5,7,3,2]),n([0,1,3,7,6,4]),n([0,1,3,7,6,2]),n([0,1,5,7,6,2]),n([0,1,5,4,6,2]),n([0,1,5,4,0,0]),n([0,1,3,7,5,4]),n([0,2,6,4,0,0]),n([0,0,0,0,0,0]),n([1,3,7,5,0,0]),n([2,3,7,6,4,0]),n([2,3,7,6,0,0]),n([2,3,1,5,7,6]),n([0,1,5,7,6,2]),n([0,1,5,7,6,4]),n([0,1,3,7,6,4]),n([4,5,7,6,2,0]),n([4,5,7,6,0,0]),n([4,5,1,3,7,6]),n([0,2,3,7,5,4]),n([6,2,3,7,5,4]),n([6,2,3,1,5,4])}();function Ae(e,t){(0,s.c)(pe,e.quaternion),(0,c.q)(ve,t,pe);var n=e.halfSize;return Math.abs(ve[0]*n[0])+Math.abs(ve[1]*n[1])+Math.abs(ve[2]*n[2])}function Ee(e,t){for(var n=0;n<8;++n){var r=t[n];r[0]=1&n?-e.halfSize[0]:e.halfSize[0],r[1]=2&n?-e.halfSize[1]:e.halfSize[1],r[2]=4&n?-e.halfSize[2]:e.halfSize[2],(0,c.q)(r,r,e.quaternion),(0,c.a)(r,r,e.center)}}function Oe(e){return(0,c.u)(e.halfSize)}function Me(e,t,n,r,i){if((0,s.a)(i.quaternion,e.quaternion),r===m.JY.Global){(0,s.c)(Le,e.quaternion),(0,c.q)(Ze,e.center,Le),(0,c.x)(Ie,Ze),(0,c.y)(De,Ie,e.halfSize),(0,c.w)(De,Ie,De);var a=(0,c.l)(De);(0,c.a)(De,Ie,e.halfSize);var o=(0,c.l)(De);if(a<n)(0,c.c)(i.center,e.center),(0,c.s)(Ze,n,n,n),(0,c.a)(i.halfSize,e.halfSize,Ze);else{var l=o>0?1+t/o:1,u=a>0?1+n/a:1,h=(u+l)/2,d=(u-l)/2;(0,c.g)(i.halfSize,Ie,d),(0,c.z)(i.halfSize,i.halfSize,e.halfSize,h),(0,c.g)(i.center,Ie,h),(0,c.z)(i.center,i.center,e.halfSize,d),(0,c.A)(Ze,Ze),(0,c.B)(i.center,i.center,Ze),(0,c.q)(i.center,i.center,i.quaternion)}}else{var f=(0,c.s)(Ze,0,0,1);(0,c.z)(i.center,e.center,f,(n+t)/2),(0,s.c)(Le,e.quaternion),(0,c.q)(f,f,Le),(0,c.x)(f,f),(0,c.z)(i.halfSize,e.halfSize,f,(n-t)/2)}return i}var Ze=(0,d.c)(),Ie=(0,d.c)(),De=(0,d.c)(),Le=(0,u.a)()},58890:function(e,t,n){n.d(t,{V:function(){return r},q:function(){return i}});var r={value:.5,readOnly:!0},i={readOnly:!0,value:.5,get:function(){return this.updating?this.updatingProgressValue:1}}},64153:function(e,t,n){n.d(t,{H:function(){return h}});var r=n(1413),i=n(15671),a=n(43144),o=n(92026),s=n(87016),l=n(8548),u=n(48673),c={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"},h=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;(0,i.Z)(this,e),this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=t,this.source=n,this.width=r||n.width,this.height=a||n.height}return(0,a.Z)(e,[{key:"source",get:function(){return this._source},set:function(e){this._source=e,this._rasterTexture=(0,o.M2)(this._rasterTexture),this._memoryUsed=null}},{key:"symbolizerParameters",get:function(){return this.isRendereredSource?(0,r.Z)((0,r.Z)({},c),{},{maxCutOff:[1,1,1],factor:[1,1,1]}):this._symbolizerParameters||c},set:function(e){this._symbolizerParameters=e}},{key:"bandIds",get:function(){return this._bandIds},set:function(e){var t=this;(0,o.pC)(e)&&e.length>0?this._bandIds&&e.every((function(e,n){var r;return!(null===(r=t._bandIds)||void 0===r||!r[n])&&e===t._bandIds[n]}))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}},{key:"interpolation",get:function(){return this._interpolation||"nearest"},set:function(e){if(this._interpolation=e,(0,o.pC)(this._rasterTexture)){var t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?l.cw.LINEAR:l.cw.NEAREST)}}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(e){this._transformGrid=e,this._transformGridTexture=(0,o.M2)(this._transformGridTexture),this._memoryUsed=null}},{key:"bind",value:function(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(((0,o.Wi)(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(e,this.bandIds),(0,o.pC)(this._rasterTexture)&&(this._updateColormapTexture(e),this.transformGrid&&(0,o.Wi)(this._transformGridTexture)&&(this._transformGridTexture=(0,u.Br)(e,this.transformGrid))),!0)}},{key:"getUniforms",value:function(){var e=this.symbolizerParameters,t=this.transformGrid,n=this.width,r=this.height,i=this.opacity,a=(0,u.Tc)(t,[n,r],[this.source.width,this.source.height],i),o=(0,u.Ue)(e.colormap,e.colormapOffset),l="stretch"===this.symbolizerParameters.type?(0,u.xW)(this.symbolizerParameters):null,c="hillshade"===this.symbolizerParameters.type?(0,u.Fm)(this.symbolizerParameters):null;return new s.C(a,o,l||c,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}},{key:"memoryUsage",get:function(){if((0,o.Wi)(this._memoryUsed)){var e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map((function(e){return(0,o.pC)(e)?e.descriptor.width*e.descriptor.height*4:0})).reduce((function(e,t){return e+t}),0)}return this._memoryUsed}},{key:"release",value:function(){return this._rasterTexture=(0,o.M2)(this._rasterTexture),this._transformGridTexture=(0,o.M2)(this._transformGridTexture),this._colormapTexture=(0,o.M2)(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}},{key:"_updateRasterTexture",value:function(e,t){var n=this.source?this.source.extractBands(t):null;if(n&&n.pixels&&n.pixels.length>0){var r=(0,o.Wi)(t)&&(0,o.Wi)(this.bandIds)||(0,o.pC)(t)&&(0,o.pC)(this.bandIds)&&t.join("")===this.bandIds.join("");if(!(0,o.pC)(this._rasterTexture)||!r){this._rasterTexture=(0,o.M2)(this._rasterTexture);var i=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=(0,u.s9)(e,n,i,this.isRendereredSource||this.hasStretchTypeNone())}}else this._rasterTexture=(0,o.M2)(this._rasterTexture)}},{key:"hasStretchTypeNone",value:function(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}},{key:"_getRasterTextureInterpolation",value:function(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e?"nearest":"bilinear"}},{key:"_updateColormapTexture",value:function(e){var t=this._colormap,n=this.symbolizerParameters.colormap;return n?t?n.length!==t.length||n.some((function(e,n){return e!==t[n]}))?(this._colormapTexture=(0,o.M2)(this._colormapTexture),this._colormapTexture=(0,u.iC)(e,n),void(this._colormap=n)):void 0:(this._colormapTexture=(0,u.iC)(e,n),void(this._colormap=n)):(this._colormapTexture=(0,o.M2)(this._colormapTexture),void(this._colormap=null))}}]),e}()},82394:function(e,t,n){var r;n.d(t,{z:function(){return r}}),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(r||(r={}))},35535:function(e,t,n){n.d(t,{$7:function(){return u},$r:function(){return o},DR:function(){return l},HB:function(){return s},L:function(){return m},Lz:function(){return d},Sx:function(){return c},Tg:function(){return f},cy:function(){return h},iU:function(){return p}});var r=n(16889),i=n(65156),a=n(62140),o=64,s=512,l=2.5,u=(0,r.oK)(r._3/10),c=2,h=(0,i.Ue)();a.t.WebMercatorAuxiliarySphere.getExtent(0,0,0,h);var d=(0,i.Ue)([-180,-90,180,90]),f="Cannot extend surface to encompass all layers because it would result in too many root tiles.",p="Surface extent is too large for tile resolution at level 0.",v=3;function m(e){return e<4?3:v}},62140:function(e,t,n){n.d(t,{_:function(){return g},t:function(){return y}});var r=n(15671),i=n(43144),a=(n(59486),n(10064)),o=n(16889),s=n(92026),l=n(68860),u=n(53866),c=n(79803),h=n(78952),d=n(65156),f=n(92975),p=n(81753),v=n(59068),m=n(22824),_=n(585),y=function(){function e(t){(0,r.Z)(this,e);var n=e.checkUnsupported(t);if((0,s.pC)(n))throw n;var i=(0,s.Wg)(t);this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,c.jF)(this.spatialReference)||(0,f.BZ)(this.spatialReference)||(0,f.V2)(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;var a=i.lods.reduce((function(e,t,n){return t.level<e.min&&(e.min=t.level,e.minIndex=n),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),o=i.lods[a.minIndex],l=Math.pow(2,o.level),u=o.resolution*l,h=o.scale*l;this.levels=new Array(a.max+1);for(var d=0;d<this.levels.length;d++)this.levels[d]={resolution:u,scale:h,tileSize:[u*i.size[0],u*i.size[1]]},u/=2,h/=2}return(0,i.Z)(e,[{key:"clone",value:function(){return new e(this.toTileInfo())}},{key:"toTileInfo",value:function(){return new m.Z({dpi:this.dpi,origin:new _.Z({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((function(e,t){return new v.Z({level:t,scale:e.scale,resolution:e.resolution})}))})}},{key:"getExtent",value:function(e,t,n,r){var i=this.levels[e],a=i.tileSize[0],o=i.tileSize[1];r[0]=this.origin[0]+n*a,r[2]=this.origin[0]+(n+1)*a,r[3]=this.origin[1]-t*o,r[1]=this.origin[1]-(t+1)*o}},{key:"convertExtentToRadians",value:function(e,t){this._isWebMercator?(t[0]=(0,p.tp)(e[0]),t[1]=(0,p.mZ)(e[1]),t[2]=(0,p.tp)(e[2]),t[3]=(0,p.mZ)(e[3])):this._isGCS&&(t[0]=(0,o.Vl)(e[0]),t[1]=(0,o.Vl)(e[1]),t[2]=(0,o.Vl)(e[2]),t[3]=(0,o.Vl)(e[3]))}},{key:"getExtentGeometry",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new u.Z;return this.getExtent(e,t,n,b),r.spatialReference=this.spatialReference,r.xmin=b[0],r.ymin=b[1],r.xmax=b[2],r.ymax=b[3],r.zmin=void 0,r.zmax=void 0,r}},{key:"ensureMaxLod",value:function(e){if(null==e)return!1;for(var t=!1;this.levels.length<=e;){var n=this.levels[this.levels.length-1],r=n.resolution/2;this.levels.push({resolution:r,scale:n.scale/2,tileSize:[r*this.pixelSize,r*this.pixelSize]}),t=!0}return t}},{key:"capMaxLod",value:function(e){this.levels.length>e+1&&(this.levels.length=e+1)}},{key:"getMaxLod",value:function(){return this.levels.length-1}},{key:"scaleAtLevel",value:function(e){return this.levels[0].scale/Math.pow(2,e)}},{key:"levelAtScale",value:function(e){var t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}},{key:"resolutionAtLevel",value:function(e){return this.levels[0].resolution/Math.pow(2,e)}},{key:"compatibleWith",value:function(t){if(!(t instanceof e)){if(e.checkUnsupported(t))return!1;t=new e(t)}if(!t.spatialReference.equals(this.spatialReference))return!1;if(t.pixelSize!==this.pixelSize)return!1;var n=Math.min(this.levels.length,t.levels.length)-1,r=this.levels[n].resolution,i=.5*r;return!(!(0,o.W8)(t.origin[0],this.origin[0],i)||!(0,o.W8)(t.origin[1],this.origin[1],i))&&(i=.5*r/Math.pow(2,n)/this.pixelSize*12,(0,o.W8)(r,t.levels[n].resolution,i))}},{key:"rootTilesInExtent",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,i=new Array,a=this.levels[0].tileSize;if((0,s.Wi)(t)||0===a[0]||0===a[1])return i;e.computeRowColExtent(t,a,this.origin,b);var o=b[1],l=b[3],u=b[0],c=b[2],h=c-u,d=l-o;if(h*d>r){var f=Math.floor(Math.sqrt(r));d>f&&(l=(o=o+Math.floor(.5*d)-Math.floor(.5*f))+f),h>f&&(c=(u=u+Math.floor(.5*h)-Math.floor(.5*f))+f)}for(var p=o;p<l;p++)for(var v=u;v<c;v++)i.push([0,p,v]);return(0,s.pC)(n)&&(n[0]=this.origin[0]+u*a[0],n[1]=this.origin[1]-l*a[1],n[2]=this.origin[0]+c*a[0],n[3]=this.origin[1]-o*a[1]),i}},{key:"test",get:function(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}],[{key:"computeRowColExtent",value:function(e,t,n,r){var i=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+i-n[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-i-n[0])/t[0])),r[1]=Math.max(0,Math.floor((n[1]-e[3]+i)/t[1])),r[3]=Math.max(0,Math.ceil((n[1]-e[1]-i)/t[1]))}},{key:"isPowerOfTwo",value:function(e){var t=e.lods,n=t[0].resolution*Math.pow(2,t[0].level);return!t.some((function(e){return!(0,o.Y8)(e.resolution,n/Math.pow(2,e.level))}))}},{key:"hasGapInLevels",value:function(e){var t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(var n=1;n<t.length;n++)if(t[n]!==t[0]+n)return!0;return!1}},{key:"tileSizeSupported",value:function(e){var t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}},{key:"hasOriginPerLODs",value:function(e){var t=e.origin;return e.lods.some((function(e){return null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)}))}},{key:"getMissingTileInfoError",value:function(){return new a.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}},{key:"checkUnsupported",value:function(t){return(0,s.Wi)(t)?g():t.lods.length<1?new a.Z("tilingscheme:generic","Tiling scheme must have at least one level"):e.isPowerOfTwo(t)?e.hasGapInLevels(t)?new a.Z("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):e.tileSizeSupported(t)?e.hasOriginPerLODs(t)?new a.Z("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new a.Z("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new a.Z("tilingscheme:power-of-two","Tiling scheme must be power of two")}},{key:"fromExtent",value:function(t,n){var r=t[2]-t[0],i=t[3]-t[1],a=(0,l.c9)(n),o=1.2*Math.max(r,i),s=256,u=new e(new m.Z({size:[s,s],origin:new _.Z({x:t[0]-.5*(o-r),y:t[3]+.5*(o-i)}),lods:[new v.Z({level:0,resolution:o/s,scale:1/(s/96*.0254/(o*a))})],spatialReference:n}));return u.ensureMaxLod(20),u}},{key:"makeWebMercatorAuxiliarySphere",value:function(t){var n=new e(e.WebMercatorAuxiliarySphereTileInfo);return n.ensureMaxLod(t),n}},{key:"makeGCSWithTileSize",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,i=256/n,a=new e(new m.Z({size:[n,n],origin:new _.Z({x:-180,y:90,spatialReference:t}),spatialReference:t,lods:[new v.Z({level:0,resolution:.703125*i,scale:295497598.570834*i})]}));return a.ensureMaxLod(r),a}}]),e}();function g(){return new a.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}y.WebMercatorAuxiliarySphereTileInfo=new m.Z({size:[256,256],origin:new _.Z({x:-20037508.342787,y:20037508.342787,spatialReference:h.Z.WebMercator}),spatialReference:h.Z.WebMercator,lods:[new v.Z({level:0,resolution:156543.03392800014,scale:591657527.591555})]}),y.WebMercatorAuxiliarySphere=y.makeWebMercatorAuxiliarySphere(19);var b=(0,d.Ue)()},53379:function(e,t,n){n.d(t,{jt:function(){return R},XJ:function(){return A},Wq:function(){return ne},er:function(){return Q},T9:function(){return O},b5:function(){return E},RB:function(){return Z},E_:function(){return J},Fp:function(){return M},TK:function(){return H},Eu:function(){return le},_1:function(){return U},a_:function(){return V},sR:function(){return D},Ay:function(){return G},GL:function(){return z},Mw:function(){return ce},wt:function(){return oe},x4:function(){return I},L4:function(){return q},uv:function(){return ue},wP:function(){return B},z7:function(){return j},FH:function(){return L},Q:function(){return N},Ke:function(){return W},OD:function(){return se},_0:function(){return ae},sP:function(){return ee},cA:function(){return de},OC:function(){return he},$v:function(){return re},_F:function(){return ie},z4:function(){return Y},Bu:function(){return $},FZ:function(){return X},zT:function(){return te},jO:function(){return K},wu:function(){return P}});var r=n(4942),i=n(80987),a=n(92026),o=n(92975),s=n(37933),l=n(50951),u=n(95911),c=n(54134),h=n(10064),d=n(11186),f=n(71353),p=n(79803),v=n(65156),m=n(35535),_=n(62140),y=(0,f.c)(),g=(0,f.c)(),b=(0,f.c)(),w=(0,f.c)();function C(e,t,n,r){(0,d.c)(y,n),y[r]=t[r];var i,a=(0,d.b)(y,y,t),o=(0,d.b)(g,e,t),s=(0,d.e)(o,a),l=(0,d.e)(a,a);i=s<=0?t:l<=s?n:(0,d.a)(y,t,(0,d.g)(a,a,s/l));var u=(0,d.b)(y,e,i);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}var x=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n){if((0,a.Wi)(e))return(0,_._)();if(e.spatialReference.isGeographic&&!(0,p.jF)(e.spatialReference))return new h.Z("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");var r=_.t.checkUnsupported(e);if((0,a.pC)(r))return r;if((0,a.Wi)(n))return new h.Z("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");var i=function(e,t){var n=e.lods,r=n[0].resolution*Math.pow(2,n[0].level),i=[r*e.size[0],r*e.size[1]],a=[e.origin.x,e.origin.y],o=(0,v.oJ)(t),s=(0,v.Ue)();_.t.computeRowColExtent(o,i,a,s);var l=(s[2]-s[0])*(s[3]-s[1]);if(l>m.$r){var u=n[0].scale*Math.pow(2,n[0].level),c=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*u/r,d=Math.floor(Math.log(c)/Math.log(10));return c=Math.ceil(c/Math.pow(10,d))*Math.pow(10,d),new h.Z("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(u).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+c.toLocaleString()+".",{level0Scale:u,suggestedLevel0Scale:c,requiredNumRootTiles:l,allowedNumRootTiles:m.$r})}return null}(e,n);if(i)return i;var o=e.spatialReference;return(0,a.pC)(t)&&!(o.equals(t)||t.isWGS84&&o.isWebMercator)?new h.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null},isInsideExtent:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=e.extent;if((0,a.Wi)(r))return!1;if(0===n)return(0,v.BD)(r,t);var i=Math.min(r[2]-r[0],r[3]-r[1]);return(0,v.Zm)(r,t,n*i)},tiltToExtentEdge:function(e,t,n){var r=e.extent;if((0,a.Wi)(r))return 0;b[0]=r[0],b[1]=r[1],b[2]=n,w[0]=r[2],w[1]=r[3],w[2]=n;var i=1/0,o=1/0;return t[0]<b[0]?i=C(t,b,w,0):t[0]>w[0]&&(i=C(t,w,b,0)),t[1]<b[1]?o=C(t,b,w,1):t[1]>w[1]&&(o=C(t,w,b,1)),Math.min(i,o)}},Symbol.toStringTag,{value:"Module"}));var T,S=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t){if((0,a.Wi)(e))return(0,_._)();var n=e.lods.length-1,r=e.spatialReference,i=(0,p.jF)(r)||(0,o.BZ)(r)||(0,o.V2)(r);if(r.isWebMercator){if(!_.t.makeWebMercatorAuxiliarySphere(n).compatibleWith(e))return new h.Z("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!i)return new h.Z("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!_.t.makeGCSWithTileSize(e.spatialReference,e.size[0],n).compatibleWith(e))return e.spatialReference.isWGS84?new h.Z("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new h.Z("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return(0,a.pC)(t)&&!e.spatialReference.equals(t)?new h.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0},isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0}},Symbol.toStringTag,{value:"Module"})),k=(T={},(0,r.Z)(T,l.JY.Global,S),(0,r.Z)(T,l.JY.Local,x),T);function P(e,t){e||console.warn("Terrain: "+t)}var R=!1,A=!1;function E(e){A=e,R=R||e}function O(e){R=e}function M(e,t){if(R&&!e){var n,r=null===(n=(new Error).stack)||void 0===n?void 0:n.slice(5);throw console.warn("Terrain internal: "+(t||"")+" at "+r),new Error("Assertion failed"+(t?": "+t:""))}}function Z(e){return D(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function I(e){return"imagery-tile"===(null===e||void 0===e?void 0:e.type)||"wcs"===(null===e||void 0===e?void 0:e.type)}function D(e){return"imagery-tile-3d"===(null===e||void 0===e?void 0:e.type)}function L(e){return"tile-3d"===(null===e||void 0===e?void 0:e.type)}function N(e){return"vector-tile-3d"===(null===e||void 0===e?void 0:e.type)}function F(e){return"wmts-3d"===(null===e||void 0===e?void 0:e.type)}function U(e){return"elevation-3d"===(null===e||void 0===e?void 0:e.type)}function V(e){return"group"===(null===e||void 0===e?void 0:e.type)}function H(e){return e&&(L(e)||F(e)||D(e)||N(e))}function z(e){return e&&(L(e)||D(e)||N(e)||F(e))}function B(e){return z(e)||U(e)}function G(e){var t,n=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return(0,a.pC)(n)&&"type"in n&&"raster-tile"===n.type}function W(e){var t,n=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return(0,a.pC)(n)&&"type"in n&&"vector-tile"===n.type}function j(e){var t,n=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return(0,a.pC)(n)&&"type"in n&&"tile-texture"===n.type}function q(e){var t,n=null===e||void 0===e||null===(t=e.sourceLayerInfo)||void 0===t?void 0:t.data;return n instanceof HTMLImageElement||n instanceof u.nN||n instanceof HTMLCanvasElement||n instanceof ImageData}function Y(e){return(0,a.pC)(e)&&"release"in e&&e.release(),null}function X(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function Q(e,t,n,r){return k[r].checkIfTileInfoSupportedForViewSR(e,n,t)}function J(e,t,n){var r=null,o=null;if("wmts"===(null===e||void 0===e?void 0:e.type)){var u=function(e,t,n){var r=(0,s.mt)(e);if((0,a.pC)(r)){if(!i.Z.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};var o=r.find((function(e){return null==Q(e.tileInfo,e.fullExtent,t,n)}));if(o)return{tileInfo:o.tileInfo,fullExtent:o.fullExtent}}return{tileInfo:null,fullExtent:null}}(e,t,n);r=u.tileInfo,o=u.fullExtent}else{o=I(e)?e.getCompatibleFullExtent(t):e.fullExtent;var c=n===l.JY.Local;if(I(e))r=e.getCompatibleTileInfo(t,o,c);else if("vector-tile"===(null===e||void 0===e?void 0:e.type)){var h=c&&!K(t)||$.force512VTL,d=e.tileInfo.spatialReference.isGeographic;r=h?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,d?1:2)}else r=e.tileInfo}return(0,a.pC)(r)&&(0,a.pC)(o)&&null==Q(r,o,t,n)?{tileInfo:r,fullExtent:o}:null}function K(e){return e.isWGS84||e.isWebMercator||(0,o.yW)(e)||!(0,o.N$)(e)}var $={force512VTL:!1};function ee(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function te(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function ne(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fe;return Math.abs(e-t)<n}function re(e){return e===c.Xo.NORTH_EAST?c.Xo.SOUTH_WEST:e===c.Xo.NORTH_WEST?c.Xo.SOUTH_EAST:e===c.Xo.SOUTH_WEST?c.Xo.NORTH_EAST:c.Xo.NORTH_WEST}function ie(e){return e===c.Xo.NORTH?c.Xo.SOUTH:e===c.Xo.EAST?c.Xo.WEST:e===c.Xo.SOUTH?c.Xo.NORTH:c.Xo.EAST}function ae(e){return e===c.Xo.NORTH_WEST||e===c.Xo.SOUTH_WEST}function oe(e){return e===c.Xo.NORTH_WEST||e===c.Xo.NORTH_EAST}function se(e){return e===c.Xo.NORTH_WEST||e===c.Xo.WEST||e===c.Xo.SOUTH_WEST}function le(e){return e===c.Xo.NORTH_EAST||e===c.Xo.EAST||e===c.Xo.SOUTH_EAST}function ue(e){return e===c.Xo.SOUTH_EAST||e===c.Xo.SOUTH||e===c.Xo.SOUTH_WEST}function ce(e){return e===c.Xo.NORTH_EAST||e===c.Xo.NORTH||e===c.Xo.NORTH_WEST}var he=[c.Xo.NORTH,c.Xo.EAST,c.Xo.SOUTH,c.Xo.WEST],de=[c.Xo.NORTH_EAST,c.Xo.SOUTH_EAST,c.Xo.SOUTH_WEST,c.Xo.NORTH_WEST],fe=1e-5},36734:function(e,t,n){n.d(t,{AA:function(){return u},E9:function(){return x},QT:function(){return w},b:function(){return b},dF:function(){return m},gl:function(){return d},rv:function(){return c},t8:function(){return C},yf:function(){return h},zW:function(){return f}});var r=n(37762),i=n(15671),a=n(43144),o=n(92026),s=n(27546),l=n(82394),u=function(){function e(){(0,i.Z)(this,e),this._queue=new s.Z,this.remove=function(){}}return(0,a.Z)(e,[{key:"done",get:function(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}},{key:"resetOne",value:function(e){this._queue.clear(),this._queue.push(e),this._last=void 0}},{key:"reset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._queue.clear(),(0,o.pC)(e)&&this._queue.pushArray(e),this._last=void 0}},{key:"skipSubtree",value:function(){this._last=void 0}},{key:"next",value:function(){var e,t=null===(e=this._last)||void 0===e?void 0:e.children;return t&&t[0]&&this._queue.pushArray(t),this._last=this._queue.pop(),this._last}}]),e}(),c=function(){function e(){(0,i.Z)(this,e),this._q=new s.Z}return(0,a.Z)(e,[{key:"done",get:function(){return 0===this._q.length}},{key:"reset",value:function(e){if(this._q.clear(),!(0,o.Wi)(e)){this._q.pushArray(e);for(var t=0;t<this._q.length;++t){var n=this._q.data[t];n.isLeaf||this._q.pushArray(n.children)}}}},{key:"next",value:function(){return this._q.pop()}}]),e}();function h(e,t,n){if((0,o.Wi)(t)||(0,o.Wi)(t.fullExtent))return!1;var r=t.fullExtent,i=e.extent;if(n){if(i[0]<r.xmin||i[1]<r.ymin||i[2]>r.xmax||i[3]>r.ymax)return!1}else if(r.xmin>i[2]||r.ymin>i[3]||r.xmax<i[0]||r.ymax<i[1])return!1;var a=e.surface.tilingScheme.levels[e.level].scale,s=t.minScale;if(s>0&&a>1.00000001*s)return!1;var l=t.maxScale;return!(l>0&&a<.99999999*l)}function d(e,t){var n=e.lij,r=t.lij;return n[0]-r[0]||n[1]-r[1]||n[2]-r[2]}function f(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,o.Wi)(n)||0===n.length?e===l.z.BACK_TO_FRONT?t.sort(p):t.sort(v):t.sort((function(t,r){return _(t,r,e,n)}))}function p(e,t){var n=t.screenDepth-e.screenDepth;if(0!==n)return n;var r=e.lij,i=t.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function v(e,t){var n=e.screenDepth-t.screenDepth;if(0!==n)return n;var r=e.lij,i=t.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function m(e,t,n){var r=e.screenDepth,i=t.screenDepth;return r<i?-n:r>i?n:d(e,t)}function _(e,t,n,r){return y(e,r)===y(t,r)?m(e,t,n):e?n:-n}function y(e,t){var n,i=(0,r.Z)(t);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(e.intersectsExtent(a))return!0}}catch(o){i.e(o)}finally{i.f()}return!1}function g(e,t){var n=e.distanceToPOI-t.distanceToPOI;if(0!==n)return n;var r=e.lij,i=t.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function b(e,t){for(var n=e.length,r=0;r<n;++r)e.getItemAt(r).updateDistanceToPOI(t);e.sort(g)}function w(e,t,n){for(var r=1,i=0,a=0;e!==t;)if(r*=.5,i*=.5,a*=.5,1&e.lij[2]&&(i+=.5),0==(1&e.lij[1])&&(a+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");n.init(t,i,a,r)}function C(e){for(var t=0;t<e.length;t++){var n=e[t],r=n.parent;if(r)for(var i=0;i<4;i++){var a=r.children[i];if(a&&a!==n)return!0}}return!1}function x(e,t){if(!e||!t||e[0]===t[0])return!1;var n=e[0]<t[0],r=n?e:t,i=n?t:e,a=1<<i[0]-r[0];return Math.floor(i[1]/a)===r[1]&&Math.floor(i[2]/a)===r[2]}},64630:function(e,t,n){n.d(t,{Z:function(){return r},c:function(){return d}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(27366),u=n(31319),c=n(49861),h=(n(25243),n(63780),n(69912)),d=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).visible=r.Hidden,e}return(0,i.Z)(n)}(u.Z);(0,l._)([(0,c.Cb)({autoDestroy:!0})],d.prototype,"renderable",void 0),(0,l._)([(0,c.Cb)({autoDestroy:!0})],d.prototype,"components",void 0),d=(0,l._)([(0,h.j)("esri.views.3d.webgl-engine.collections.Component.ComponentObject")],d),function(e){e[e.Hidden=0]="Hidden",e[e.Visible=1]="Visible"}(r||(r={}))},7564:function(e,t,n){n.d(t,{O:function(){return r},_:function(){return w}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(27366),u=n(37107),c=n(91871),h=n(37081),d=n(73782),f=n(60113),p=n(96658),v=n(41481),m=n(86097),_=n(99340),y=n(33559),g=n(68401),b=n(25920);!function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(r||(r={}));var w=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).output=h.H.Color,e.textureCoordinateType=f.N.None,e.componentData=u._N.Uniform,e.cullFace=g.Vr.Back,e.vertexDiscardMode=c.a.None,e.doubleSidedMode=p.q.WindingOrder,e.alphaDiscardMode=g.JJ.Opaque,e.integratedMeshMode=r.None,e.transparencyPassType=b.A.NONE,e.ellipsoidMode=m.U.Earth,e.pbrMode=v.f7.Disabled,e.normalType=d.h.Attribute,e.spherical=!1,e.doublePrecisionRequiresObfuscation=!1,e.hasVertexColors=!1,e.hasNormals=!1,e.hasSlicePlane=!1,e.hasBaseColorTexture=!1,e.receiveAmbientOcclusion=!0,e.receiveShadows=!0,e.blendingEnabled=!0,e.hasScreenSpaceReflections=!1,e.hasPolygonOffset=!1,e.hasMetallicRoughnessTexture=!1,e.hasEmissionTexture=!1,e.hasOcclusionTexture=!1,e.hasNormalTexture=!1,e.hasOccludees=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.useLegacyTerrainShading=!1,e.hasCloudsReflections=!0,e.snowCover=!1,e.objectAndLayerIdColor=!1,e.hasWebGL2Context=!1,e}return(0,i.Z)(n)}(y.m);(0,l._)([(0,y.o)({count:h.H.COUNT})],w.prototype,"output",void 0),(0,l._)([(0,y.o)({count:f.N.COUNT})],w.prototype,"textureCoordinateType",void 0),(0,l._)([(0,y.o)({count:u._N.COUNT})],w.prototype,"componentData",void 0),(0,l._)([(0,y.o)({count:g.Vr.COUNT})],w.prototype,"cullFace",void 0),(0,l._)([(0,y.o)({count:c.a.COUNT})],w.prototype,"vertexDiscardMode",void 0),(0,l._)([(0,y.o)({count:p.q.COUNT})],w.prototype,"doubleSidedMode",void 0),(0,l._)([(0,y.o)({count:g.JJ.COUNT})],w.prototype,"alphaDiscardMode",void 0),(0,l._)([(0,y.o)({count:r.COUNT})],w.prototype,"integratedMeshMode",void 0),(0,l._)([(0,y.o)({count:b.A.COUNT})],w.prototype,"transparencyPassType",void 0),(0,l._)([(0,y.o)({count:m.U.COUNT})],w.prototype,"ellipsoidMode",void 0),(0,l._)([(0,y.o)({count:v.f7.COUNT})],w.prototype,"pbrMode",void 0),(0,l._)([(0,y.o)({count:d.h.COUNT})],w.prototype,"normalType",void 0),(0,l._)([(0,y.o)()],w.prototype,"spherical",void 0),(0,l._)([(0,y.o)()],w.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasVertexColors",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasNormals",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasSlicePlane",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasBaseColorTexture",void 0),(0,l._)([(0,y.o)()],w.prototype,"receiveAmbientOcclusion",void 0),(0,l._)([(0,y.o)()],w.prototype,"receiveShadows",void 0),(0,l._)([(0,y.o)()],w.prototype,"blendingEnabled",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasScreenSpaceReflections",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasPolygonOffset",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasMetallicRoughnessTexture",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasEmissionTexture",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasOcclusionTexture",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasNormalTexture",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasOccludees",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasMultipassTerrain",void 0),(0,l._)([(0,y.o)()],w.prototype,"cullAboveGround",void 0),(0,l._)([(0,y.o)()],w.prototype,"useLegacyTerrainShading",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasCloudsReflections",void 0),(0,l._)([(0,y.o)()],w.prototype,"snowCover",void 0),(0,l._)([(0,y.o)()],w.prototype,"objectAndLayerIdColor",void 0),(0,l._)([(0,y.o)()],w.prototype,"hasWebGL2Context",void 0),(0,l._)([(0,y.o)({constValue:_.P.Draw})],w.prototype,"pbrTextureBindType",void 0),(0,l._)([(0,y.o)({constValue:!0})],w.prototype,"hasSliceHighlight",void 0),(0,l._)([(0,y.o)({constValue:!1})],w.prototype,"hasSliceInVertexProgram",void 0),(0,l._)([(0,y.o)({constValue:!1})],w.prototype,"useCustomDTRExponentForWater",void 0),(0,l._)([(0,y.o)({constValue:!1})],w.prototype,"hasVertexTangents",void 0),(0,l._)([(0,y.o)({constValue:!0})],w.prototype,"supportsTextureAtlas",void 0),(0,l._)([(0,y.o)({constValue:!1})],w.prototype,"highStepCount",void 0),(0,l._)([(0,y.o)({constValue:!1})],w.prototype,"instancedDoublePrecision",void 0),(0,l._)([(0,y.o)({constValue:!0})],w.prototype,"useFillLights",void 0),(0,l._)([(0,y.o)({constValue:!1})],w.prototype,"objectAndLayerIdColorInstanced",void 0)},37107:function(e,t,n){n.d(t,{AD:function(){return I},_N:function(){return h},E_:function(){return M},nO:function(){return Z}});var r,i,a,o,s,l,u,c,h,d=n(30168),f=n(41644),p=n(46228),v=n(93169),m=n(77343),_=n(37081),y=n(78980),g=n(75993),b=n(20395),w=n(43144),C=n(15671),x=n(60136),T=n(92572),S=n(61809),k=n(99340),P=function(e){(0,x.Z)(n,e);var t=(0,T.Z)(n);function n(e,r){return(0,C.Z)(this,n),t.call(this,e,"int",k.P.Draw,(function(t,n,i){return t.setUniform1i(e,r(n,i))}))}return(0,w.Z)(n)}(S.x),R=n(98634),A=n(78050),E=n(97528),O=n(4760);!function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"}(h||(h={}));var M=429496.7296;function Z(e,t){(0,p.I)(e/M*.5+.5,t)}function I(e,t){switch(t.componentData){case h.Varying:return function(e,t){var n=e.vertex,u=e.fragment;n.include(y.n),n.uniforms.add((0,A.F)("componentColorTex",(function(e){return e.componentParameters.texture.texture}),t.hasWebGL2Context?E.D.None:E.D.Size)),e.attributes.add(O.T.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");var c=t.output===_.H.ObjectAndLayerIdColor;c&&e.varyings.add("vObjectAndLayerIdColor","vec4"),e.include(m.A),n.constants.add("elevationScale","float",2*M),n.constants.add("stride","float",(0,v.Z)("enable-feature:objectAndLayerId-rendering")?3:2),n.code.add((0,R.H)(r||(r=(0,d.Z)(["\n  vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {\n    vec2 textureSize = ",";\n\n    float index = componentIndex * stride + typeOffset;\n    float coordX = mod(index, textureSize.x);\n    float coordY = floor(index / textureSize.x);\n\n    return vec2(coordX, coordY) + 0.5;\n  }\n  "])),(0,g.w_)(t,"componentColorTex"))),n.code.add((0,R.H)(i||(i=(0,d.Z)(["\n  vec4 _readComponentColor() {\n    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);\n\n    return ",";\n   }\n\n   float readElevationOffset() {\n    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);\n\n    vec4 encodedElevation = ",";\n    return (rgba2float(encodedElevation) - 0.5) * elevationScale;\n  }\n\n  ","\n\n  vec4 forwardExternalColor(out bool castShadows) {\n    vec4 componentColor = _readComponentColor() * 255.0;\n\n    float shadowFlag = mod(componentColor.b * 255.0, 2.0);\n    componentColor.b -= shadowFlag;\n    castShadows = shadowFlag >= 1.0;\n\n    int decodedColorMixMode;\n    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;\n    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts\n\n    return vExternalColor;\n  }\n"])),(0,g.b6)(t,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize"),(0,g.b6)(t,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize"),c?(0,R.H)(a||(a=(0,d.Z)(["\n          void forwardObjectAndLayerIdColor() {\n            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);\n\n            vObjectAndLayerIdColor = ",";\n          }"])),(0,g.b6)(t,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")):(0,R.H)(o||(o=(0,d.Z)(["void forwardObjectAndLayerIdColor() {}"]))))),u.code.add((0,R.H)(s||(s=(0,d.Z)(["\n  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {\n    externalColor = vExternalColor;\n    externalColorMixMode = int(vExternalColorMixMode);\n  }\n\n  void outputObjectAndLayerIdColor() {\n     ","\n  }\n"])),c?(0,R.H)(l||(l=(0,d.Z)(["gl_FragColor = vObjectAndLayerIdColor;"]))):""))}(e,t);case h.Uniform:return function(e){var t=e.vertex,n=e.fragment;t.uniforms.add(new b.$("externalColor",(function(e){return e.componentParameters.externalColor}))),n.uniforms.add(new P("externalColorMixMode",(function(e){return e.componentParameters.externalColorMixMode}))),e.varyings.add("vExternalColor","vec4"),t.code.add((0,R.H)(u||(u=(0,d.Z)(["float readElevationOffset() {\nreturn 0.0;\n}\nvoid forwardObjectAndLayerIdColor() {\n}\nvec4 forwardExternalColor(out bool castShadows) {\nvExternalColor = externalColor;\ncastShadows = true;\nreturn externalColor;\n}"])))),n.code.add((0,R.H)(c||(c=(0,d.Z)(["void readExternalColor(out vec4 color, out int colorMixMode) {\ncolor = vExternalColor;\ncolorMixMode = externalColorMixMode;\n}\nvoid outputObjectAndLayerIdColor() {\ngl_FragColor = vec4(1.0,0.0,0.0,0.0);\n}"]))))}(e);case h.COUNT:return;default:(0,f.Bg)(t.componentData)}}},91871:function(e,t,n){n.d(t,{a:function(){return s},z:function(){return c}});var r,i,a,o,s,l=n(30168),u=n(98634);function c(e,t){var n=e.vertex;switch(n.code.add((0,u.H)(r||(r=(0,l.Z)(["#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)"])))),t.vertexDiscardMode){case s.None:n.code.add((0,u.H)(i||(i=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) {}"]))));break;case s.Opaque:n.code.add((0,u.H)(a||(a=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))));break;case s.Transparent:n.code.add((0,u.H)(o||(o=(0,l.Z)(["#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }"]))))}}!function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(s||(s={}))},92911:function(e,t,n){n.d(t,{N:function(){return o}});var r=n(55158),i=n(60113),a=n(4760);function o(e){var t=(0,r.U$)().vec3f(a.T.POSITION);return e.normals&&t.vec2i16(a.T.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===i.N.Default?t.vec2f(a.T.UV0):e.textureCoordinates===i.N.Atlas&&(t.vec2f(a.T.UV0),t.vec4u16(a.T.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(a.T.COLOR,{glNormalized:!0}),t.alignTo(4)}},74779:function(e,t,n){n.d(t,{SP:function(){return d},T5:function(){return p},kF:function(){return f},o9:function(){return r}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(71353),u=n(37081),c=n(85380),h=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).slicePlaneLocalOrigin=(0,l.c)(),e.origin=e.slicePlaneLocalOrigin,e}return(0,i.Z)(n)}(c.d4);c.Pf;!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}(r||(r={}));var d=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).identifier=r.Material,e.output=u.H.Color,e.transparent=!1,e.integratedMesh=!1,e}return(0,i.Z)(n)}(h),f=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).identifier=r.ShadowMap,e}return(0,i.Z)(n)}(h),p=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).identifier=r.Highlight,e}return(0,i.Z)(n)}(h)},97397:function(e,t,n){n.d(t,{M:function(){return l}});var r,i,a,o=n(30168),s=n(98634);function l(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add((0,s.H)(r||(r=(0,o.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))):e.vertex.code.add((0,s.H)(i||(i=(0,o.Z)(["void forwardVertexTangent(vec3 n) {\ntbnTangent = vec3(1.0, 0.0, 0.0);\ntbnBiTangent = normalize(cross(n, tbnTangent));\n}"])))),e.fragment.code.add((0,s.H)(a||(a=(0,o.Z)(["mat3 getTBNMatrix(vec3 n) {\nreturn mat3(tbnTangent, tbnBiTangent, n);\n}"]))))}},35600:function(e,t,n){var r;n.d(t,{MV:function(){return a},iM:function(){return r},pU:function(){return i}}),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(r||(r={}));var i={normal:r.Normal,average:r.Average,lighten:r.Lighten,lighter:r.Lighter,screen:r.Screen,plus:r.Plus,"color-dodge":r.ColorDodge,darken:r.Darken,multiply:r.Multiply,"color-burn":r.ColorBurn,overlay:r.Overlay,"soft-light":r.SoftLight,"hard-light":r.HardLight,"vivid-light":r.VividLight,hue:r.Hue,saturation:r.Saturation,luminosity:r.Luminosity,color:r.Color,difference:r.Difference,exclusion:r.Exclusion,minus:r.Minus,invert:r.Invert,reflect:r.Reflect,"destination-over":r.DestinationOver,"destination-atop":r.DestinationAtop,"destination-in":r.DestinationIn,"destination-out":r.DestinationOut,"source-atop":r.SourceAtop,"source-in":r.SourceIn,"source-out":r.SourceOut,xor:r.Xor};function a(e){return e===r.DestinationOver||e===r.DestinationAtop||e===r.DestinationIn||e===r.DestinationOut||e===r.SourceAtop||e===r.SourceIn||e===r.SourceOut||e===r.Xor}},54786:function(e,t,n){n.d(t,{i:function(){return u}});var r,i=n(30168),a=n(75993),o=n(58406),s=n(98634),l=n(19253);function u(e,t){e.fragment.uniforms.add([new l.A("u_colormap",(function(e){return e.u_colormap})),new o.p("u_colormapOffset",(function(e){return e.colormap.u_colormapOffset})),new o.p("u_colormapMaxIndex",(function(e){return e.colormap.u_colormapMaxIndex})),new o.p("u_opacity",(function(e){return e.common.u_opacity}))]),e.fragment.code.add((0,s.H)(r||(r=(0,i.Z)(["\n    vec4 colormap(vec4 currentPixel, bool isFloat) {\n      float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;\n      vec4 result;\n      // handle no data and out of range pixels\n      if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {\n        result = vec4(0.0, 0.0, 0.0, 0.0);\n      } else {\n        // colormap lookup\n        vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);\n        result = ",";\n      }\n      return result;\n    }\n  "])),(0,a.b6)(t,"u_colormap","texelCoordinates","(1.0 / vec2(u_colormapMaxIndex + 1.0, 1.0))")))}},9386:function(e,t,n){n.d(t,{G:function(){return g},J:function(){return y}});var r,i=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(92572),u=n(75993),c=n(82999),h=n(98634),d=n(19253),f=n(97528);function p(e,t){e.fragment.uniforms.add((0,d.J)("u_transformGrid",(function(e){return e.u_transformGrid}),t.hasWebGL2Context?f.D.None:f.D.InvSize)),e.fragment.uniforms.add(new c.A("u_transformSpacing",(function(e){return e.common.u_transformSpacing}))),e.fragment.uniforms.add(new c.A("u_targetImageSize",(function(e){return e.common.u_targetImageSize}))),e.fragment.code.add((0,h.H)(r||(r=(0,i.Z)(["\n    vec2 projectPixelLocation(vec2 coords) {\n      // Pixel index in row/column, corresponds to upperleft corner, e.g. [100, 20]\n      vec2 index_image = floor(coords * u_targetImageSize);\n\n      // Pixel's corresponding cell index in transform grid\n      // Each transform cell corresponds to 4 pixels: 6 coefficients from lowerleft triangle followed by 6 coefficients from upperright triangle\n      vec2 oneTransformPixel = vec2(4.0, 1.0);\n      vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;\n\n      // Correspoding position in transform grid cell, cell center coordinates\n      vec2 pos = fract((index_image + 0.5) / u_transformSpacing);\n\n      // Pixel's corresponding transform cell location, cell center coordinates\n      vec2 transform_location = index_transform + 0.5;\n\n      vec2 srcLocation;\n\n      // Use lower triangle or upper triangle\n      if (pos.s <= pos.t) {\n        vec3 ll_abc = ",".rgb;\n        vec3 ll_def = ",".rgb;\n        srcLocation.s = dot(ll_abc, vec3(pos, 1.0));\n        srcLocation.t = dot(ll_def, vec3(pos, 1.0));\n      } else {\n        vec3 ur_abc = ",".rgb;\n        vec3 ur_def = ",".rgb;\n        srcLocation.s = dot(ur_abc, vec3(pos, 1.0));\n        srcLocation.t = dot(ur_def, vec3(pos, 1.0));\n      }\n\n      return srcLocation;\n    }\n  "])),(0,u.b6)(t,"u_transformGrid","transform_location"),(0,u.b6)(t,"u_transformGrid","vec2(transform_location.s + 1.0, transform_location.t)"),(0,u.b6)(t,"u_transformGrid","vec2(transform_location.s + 2.0, transform_location.t)"),(0,u.b6)(t,"u_transformGrid","vec2(transform_location.s + 3.0, transform_location.t)")))}var v,m=n(32426),_=n(13773),y=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,r,i){var a;return(0,o.Z)(this,n),(a=t.call(this)).common=e,a.u_image=r,a.u_transformGrid=i,a}return(0,a.Z)(n)}(m.R);function g(e,t){e.include(p,t),e.fragment.uniforms.add([new d.A("u_image",(function(e){return e.u_image})),new _.U("u_flipY",(function(e){return e.common.u_flipY})),new _.U("u_applyTransform",(function(e){return e.common.u_applyTransform}))]),e.fragment.code.add((0,h.H)(v||(v=(0,i.Z)(["vec2 getPixelLocation(vec2 coords) {\nvec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;\nif (!u_applyTransform) {\nreturn targetLocation;\n}\nreturn projectPixelLocation(targetLocation);\n}\nbool isOutside(vec2 coords){\nif (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {\nreturn true;\n} else {\nreturn false;\n}\n}\nvec4 getPixel(vec2 pixelLocation) {\nreturn texture2D(u_image, pixelLocation);\n}"]))))}},98864:function(e,t,n){n.d(t,{P:function(){return d}});var r,i,a,o=n(30168),s=n(48655),l=n(71033),u=n(20395),c=n(22035),h=n(98634);function d(e,t){e.include(s.c,t),e.fragment.include(l.y);var n=e.fragment;n.uniforms.add(new u.$("baseColor",(function(e){return e.baseColor}))),n.uniforms.add(new c.p("objectOpacity",(function(e){return e.objectOpacity}))),t.hasVertexColors?n.code.add((0,h.H)(r||(r=(0,o.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb * vColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a * vColor.a;\n}"])))):n.code.add((0,h.H)(i||(i=(0,o.Z)(["vec3 _baseColor() {\nreturn baseColor.rgb;\n}\nfloat _baseOpacity() {\nreturn baseColor.a;\n}"])))),n.code.add((0,h.H)(a||(a=(0,o.Z)(["vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {\nvec3 baseColor = _baseColor();\nfloat baseOpacity = _baseOpacity();\nvec3 color = mixExternalColor(\nbaseColor,\ntextureColor.rgb,\nexternalColor.rgb,\nexternalColorMixMode\n);\nfloat opacity = objectOpacity * mixExternalOpacity(\nbaseOpacity,\ntextureColor.a,\nexternalColor.a,\nexternalColorMixMode\n);\nreturn vec4(color, opacity);\n}"]))))}},48051:function(e,t,n){n.d(t,{B:function(){return y}});var r,i,a,o,s,l,u,c,h=n(30168),d=n(41644),f=n(73782),p=n(85380),v=n(74058),m=n(96658),_=n(98634);function y(e,t){var n=e.fragment;switch(t.doubleSidedMode){case m.q.None:n.code.add((0,_.H)(r||(r=(0,h.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn normal;\n}"]))));break;case m.q.View:e.include(v.up,t),n.code.add((0,_.H)(i||(i=(0,h.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;\n}"]))));break;case m.q.WindingOrder:n.code.add((0,_.H)(a||(a=(0,h.Z)(["vec3 _adjustDoublesided(vec3 normal) {\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;default:(0,d.Bg)(t.doubleSidedMode);case m.q.COUNT:}switch(t.normalType){case f.h.Attribute:case f.h.CompressedAttribute:e.include(p.Bb,t),n.code.add((0,_.H)(o||(o=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn _adjustDoublesided(normalize(vNormalWorld));\n}\nvec3 shadingNormal_view() {\nvec3 normal = normalize(vNormalView);\nreturn gl_FrontFacing ? normal : -normal;\n}"]))));break;case f.h.ScreenDerivative:e.extensions.add("GL_OES_standard_derivatives"),e.include(v.up,t),n.code.add((0,_.H)(s||(s=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(cross(\ndFdx(vPositionWorldCameraRelative),\ndFdy(vPositionWorldCameraRelative)\n));\n}\nvec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));\n}"]))));break;case f.h.Ground:t.spherical?(e.include(v.up,t),n.code.add((0,_.H)(l||(l=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn normalize(positionWorld());\n}"]))))):n.code.add((0,_.H)(u||(u=(0,h.Z)(["vec3 shadingNormalWorld() {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),e.extensions.add("GL_OES_standard_derivatives"),n.code.add((0,_.H)(c||(c=(0,h.Z)(["vec3 shadingNormal_view() {\nreturn normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;\n}"]))));break;default:(0,d.Bg)(t.normalType);case f.h.COUNT:}}},51612:function(e,t,n){n.d(t,{s:function(){return m}});var r,i,a,o=n(30168),s=n(37081),l=n(60113),u=n(51520),c=n(27193),h=n(75993),d=n(98634),f=n(78050),p=n(97528),v=n(68401);function m(e,t){var n=e.fragment;if(!t.hasBaseColorTexture||t.output!==s.H.Color&&t.alphaDiscardMode===v.JJ.Opaque)n.code.add((0,d.H)(a||(a=(0,o.Z)(["vec4 readBaseColorTexture() { return vec4(1.0); }"]))));else{e.include(u.i,t);var m=t.textureCoordinateType===l.N.Atlas;n.uniforms.add((0,f.F)("baseColorTexture",(function(e){return e.texture}),m?t.hasWebGL2Context?p.D.None:p.D.Size:p.D.None)),m?(e.include(c.r),n.code.add((0,d.H)(r||(r=(0,o.Z)(["\n        vec4 readBaseColorTexture() {\n          vec2 textureSize = ",";\n          return textureAtlasLookup(baseColorTexture, textureSize, vuv0, vuvRegion);\n        }\n      "])),(0,h.w_)(t,"baseColorTexture")))):n.code.add((0,d.H)(i||(i=(0,o.Z)(["vec4 readBaseColorTexture() {\nreturn texture2D(baseColorTexture, vuv0);\n}"]))))}}},91835:function(e,t,n){n.d(t,{H:function(){return o}});var r,i=n(30168),a=n(98634);function o(e){e.code.add((0,a.H)(r||(r=(0,i.Z)(["\n    float lineFactorAtPosition(float value) {\n      float pos = value * ",";\n      if(pos < 0.5 || pos > ",") {\n        return 1.0;\n      }\n\n      pos = pos + 0.5;\n      float modulo = mod(pos, 16.0);\n      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;\n    }\n\n    float lineFactorAtUV(vec2 uv) {\n      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));\n    }\n\n    float lineFactor(vec2 uv) {\n      vec2 offset = fwidth(uv) * 0.25;\n      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +\n              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +\n              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;\n    }\n\n    vec3 gridColor(vec2 uv) {\n      float line = lineFactor(uv) * 0.1 + 0.9;\n      return vec3(1.0, 0.972, 0.918) * line;\n    }"])),a.H.float(257),a.H.float(256.5)))}},22702:function(e,t,n){n.d(t,{IJ:function(){return S},Tw:function(){return k},WB:function(){return T},gT:function(){return l}});var r,i,a,o,s,l,u=n(37762),c=n(30168),h=n(67077),d=n(65156),f=n(54134),p=n(1883),v=n(74779),m=n(37081),_=n(92395),y=n(41481),g=n(68618),b=n(75993),w=n(20395),C=n(98634),x=n(19253);function T(e,t){var n=e.vertex,r=e.fragment;n.uniforms.add([new w.$("overlayTexOffset",(function(e,t){return function(e,t){var n,r=(0,u.Z)(t.overlays);try{for(r.s();!(n=r.n()).done;){var i=n.value,a=i.index,o=i.extent;(0,d.SO)(o)>0&&(P[2*a]=e.toMapSpace[0]/(0,d.bf)(o)-o[0]/(0,d.bf)(o),P[2*a+1]=e.toMapSpace[1]/(0,d.Cb)(o)-o[1]/(0,d.Cb)(o))}}catch(s){r.e(s)}finally{r.f()}return P}(e,t)})),new w.$("overlayTexScale",(function(e,t){return function(e,t){var n,r=(0,u.Z)(t.overlays);try{for(r.s();!(n=r.n()).done;){var i=n.value,a=i.index,o=i.extent;(0,d.SO)(o)>0&&(P[2*a]=e.toMapSpace[2]/(0,d.bf)(o),P[2*a+1]=e.toMapSpace[3]/(0,d.Cb)(o))}}catch(s){r.e(s)}finally{r.f()}return P}(e,t)}))]),r.constants.add("overlayOpacity","float",1),r.uniforms.add(new x.A("ovColorTex",(function(e,t){return k(e,t)}))),S(e,t)}function S(e,t){e.extensions.add("GL_OES_standard_derivatives"),t.pbrMode!==y.f7.Water&&t.pbrMode!==y.f7.WaterOnIntegratedMesh&&t.pbrMode!==y.f7.TerrainWithWater||e.include(g.B,t);var n=e.vertex,l=e.fragment;e.varyings.add("vtcOverlay","vec4"),n.code.add((0,C.H)(r||(r=(0,c.Z)(["void setOverlayVTC(in vec2 uv) {\nvtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;\n}"])))),l.code.add((0,C.H)(i||(i=(0,c.Z)(["bool isValid(vec2 uv, vec2 dxdy) {\nreturn (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);\n}\nvec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {\nvec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));\nvec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));\nbool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));\nbool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));\nreturn mix(color1 * float(isValid1), color0, float(isValid0));\n}"])))),l.code.add((0,C.H)(a||(a=(0,c.Z)(["vec4 getCombinedOverlayColor() {\nreturn overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);\n}"])))),l.code.add((0,C.H)(o||(o=(0,c.Z)(["\n    vec4 getOverlayColorTexel(vec4 texCoords) {\n          vec2 texDim =  ",";\n\n          vec4 color0 = ",";\n          vec4 color1 = ",";\n\n          bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));\n          bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));\n\n          return mix(color1 * float(isValid1), color0, float(isValid0));\n    }\n  "])),(0,b.w_)(t,"ovColorTex"),(0,b.b6)(t,"ovColorTex","vec2(texCoords.x * 0.5, texCoords.y)*texDim"),(0,b.b6)(t,"ovColorTex","vec2(texCoords.z * 0.5 + 0.5, texCoords.w)*texDim"))),t.pbrMode!==y.f7.Water&&t.pbrMode!==y.f7.WaterOnIntegratedMesh&&t.pbrMode!==y.f7.TerrainWithWater||((0,_.Pe)(l),(0,_.F1)(l),l.code.add((0,C.H)(s||(s=(0,c.Z)(["vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,\nfloat shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {\nvec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));\nvec3 v = vposEyeDir;\nvec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);\nreturn vec4(final, colorInput.w);\n}"])))))}function k(e,t){return 0===t.overlays.length?null:e.identifier===v.o9.Material&&e.output===m.H.Color?t.overlays[f.fu.INNER].getColorTextureNoRasterImage():e.identifier===v.o9.Material&&e.output===m.H.ObjectAndLayerIdColor?t.overlays[f.fu.INNER].getColorTexture(p.$.ObjectAndLayerIdColor):e.identifier===v.o9.Highlight?t.overlays[f.fu.INNER].getValidTexture(f.NH.Highlight):null}!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(l||(l={}));var P=(0,h.c)()},28288:function(e,t,n){n.d(t,{EK:function(){return R},uS:function(){return k},yl:function(){return P}});var r,i,a,o,s,l,u,c,h,d,f=n(30168),p=n(43144),v=n(15671),m=n(60136),_=n(92572),y=n(54134),g=n(91835),b=n(22702),w=n(55375),C=n(58406),x=n(98634),T=n(19253),S=n(61809),k=function(e){(0,m.Z)(n,e);var t=(0,_.Z)(n);function n(){var e;return(0,v.Z)(this,n),(e=t.apply(this,arguments)).overlayOpacity=1,e}return(0,p.Z)(n)}(x.K);function P(e,t){e.vertex.uniforms.add([new O("overlayTexOffset"),new O("overlayTexScale")]),e.fragment.uniforms.add([new C.p("overlayOpacity",(function(e){return e.overlayOpacity})),new T.A("ovColorTex",(function(e,t){return 0===t.overlays.length?null:t.overlays[y.fu.INNER].getColorTexture(e.overlaySource)}))]),(0,b.IJ)(e,t)}function R(e,t){var n=e.vertex,p=e.fragment,v=e.varyings;v.add("vtc","vec2"),n.uniforms.add(new O("texOffsetAndScale")),p.uniforms.add(new M("tex")),p.uniforms.add(new E("textureOpacities"));var m=t.textureFadingEnabled&&!t.renderOccluded;m&&(n.uniforms.add(new O("nextTexOffsetAndScale")),v.add("nvtc","vec2"),p.uniforms.add(new M("texNext")),p.uniforms.add(new E("nextTexOpacities")),p.uniforms.add(new A("fadeFactor")));var _=t.tileBlendInput===w.R.ColorComposite,y=t.tileBlendInput===w.R.GridComposite;y&&p.include(g.H),_&&p.uniforms.add(new E("backgroundColor")),n.code.add((0,x.H)(r||(r=(0,f.Z)(["\n  void forwardTextureCoordinatesWithTransform(in vec2 uv) {\n    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;\n    ","\n  }"])),m?(0,x.H)(i||(i=(0,f.Z)(["nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;"]))):(0,x.H)(a||(a=(0,f.Z)([""]))))),p.code.add((0,x.H)(o||(o=(0,f.Z)(["\n    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {\n      ","\n    }"])),y||_?(0,x.H)(s||(s=(0,f.Z)(["\n              if (opacities.y <= 0.0) {\n                return color * opacities.z * opacities.x;\n              }\n              vec4 bg = vec4("," * opacities.y, opacities.y);\n              vec4 layer = color * opacities.z;\n              return (bg * (1.0 - layer.a) + layer) * opacities.x;"])),_?(0,x.H)(l||(l=(0,f.Z)(["backgroundColor"]))):(0,x.H)(u||(u=(0,f.Z)(["gridColor(uv)"])))):(0,x.H)(c||(c=(0,f.Z)(["return color;"]))))),m?p.code.add((0,x.H)(h||(h=(0,f.Z)(["vec4 getTileColor() {\nvec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);\nif (fadeFactor >= 1.0) {\nreturn color;\n}\nvec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);\nreturn mix(nextColor, color, fadeFactor);\n}"])))):p.code.add((0,x.H)(d||(d=(0,f.Z)(["vec4 getTileColor() {\nreturn getColor(texture2D(tex, vtc), vtc, textureOpacities);\n}"]))))}var A=function(e){(0,m.Z)(n,e);var t=(0,_.Z)(n);function n(e){return(0,v.Z)(this,n),t.call(this,e,"float")}return(0,p.Z)(n)}(S.x),E=function(e){(0,m.Z)(n,e);var t=(0,_.Z)(n);function n(e){return(0,v.Z)(this,n),t.call(this,e,"vec3")}return(0,p.Z)(n)}(S.x),O=function(e){(0,m.Z)(n,e);var t=(0,_.Z)(n);function n(e){return(0,v.Z)(this,n),t.call(this,e,"vec4")}return(0,p.Z)(n)}(S.x),M=function(e){(0,m.Z)(n,e);var t=(0,_.Z)(n);function n(e){return(0,v.Z)(this,n),t.call(this,e,"sampler2D")}return(0,p.Z)(n)}(S.x)},63434:function(e,t,n){n.d(t,{Iu:function(){return he},lG:function(){return ce},m9:function(){return de},JT:function(){return ye}});var r,i,a,o,s,l,u,c,h,d,f,p,v,m,_,y,g,b,w,C,x,T,S,k,P,R,A,E,O,M,Z,I,D,L,N,F,U,V,H,z,B,G=n(30168),W=n(43144),j=n(15671),q=n(60136),Y=n(92572),X=n(71353),Q=n(35600),J=n(91835),K=n(98634);function $(e,t){var n=t.blendMode;n!==Q.iM.Normal&&(n===Q.iM.Reflect&&e.code.add((0,K.H)(r||(r=(0,G.Z)(["float reflectBlend(in float cb, in float cl) {\nreturn (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);\n}"])))),n!==Q.iM.ColorDodge&&n!==Q.iM.VividLight||e.code.add((0,K.H)(i||(i=(0,G.Z)(["float colorDodge(in float cb, in float cl) {\nreturn (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));\n}"])))),n!==Q.iM.ColorBurn&&n!==Q.iM.VividLight||e.code.add((0,K.H)(a||(a=(0,G.Z)(["float colorBurn(in float cb, in float cl) {\nreturn (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);\n}"])))),n===Q.iM.Overlay&&e.code.add((0,K.H)(o||(o=(0,G.Z)(["float overlay(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);\n}"])))),n===Q.iM.HardLight&&e.code.add((0,K.H)(s||(s=(0,G.Z)(["float hardLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));\n}"])))),n===Q.iM.SoftLight&&e.code.add((0,K.H)(l||(l=(0,G.Z)(["float softLight(in float cb, in float cl) {\nif (cl <= 0.5) {\nreturn cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);\n}\nif (cb <= 0.25) {\nreturn cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);\n}\nreturn cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);\n}"])))),n===Q.iM.VividLight&&e.code.add((0,K.H)(u||(u=(0,G.Z)(["float vividLight(in float cb, in float cl) {\nreturn (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));\n}"])))),n!==Q.iM.Hue&&n!==Q.iM.Saturation&&n!==Q.iM.Color&&n!==Q.iM.Luminosity||(e.code.add((0,K.H)(c||(c=(0,G.Z)(["float minv3(in vec3 c) {\nreturn min(min(c.r, c.g), c.b);\n}\nfloat maxv3(in vec3 c) {\nreturn max(max(c.r, c.g), c.b);\n}\nfloat lumv3(in vec3 c) {\nreturn dot(c, vec3(0.3, 0.59, 0.11));\n}\nvec3 clipColor(vec3 color) {\nfloat lum = lumv3(color);\nfloat mincol = minv3(color);\nfloat maxcol = maxv3(color);\nif (mincol < 0.0) {\ncolor = lum + ((color - lum) * lum) / (lum - mincol);\n}\nif (maxcol > 1.0) {\ncolor = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);\n}\nreturn color;\n}\nvec3 setLum(vec3 cbase, vec3 clum) {\nreturn clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));\n}"])))),n!==Q.iM.Hue&&n!==Q.iM.Saturation||e.code.add((0,K.H)(h||(h=(0,G.Z)(["float satv3(vec3 c) {\nreturn maxv3(c) - minv3(c);\n}\nvec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)\n{\nfloat minbase = minv3(cbase);\nfloat sbase = satv3(cbase);\nfloat ssat = satv3(csat);\nreturn setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);\n}"]))))),e.code.add((0,K.H)(d||(d=(0,G.Z)(["\n    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {\n      ","\n    }\n  "])),n===Q.iM.Multiply?(0,K.H)(f||(f=(0,G.Z)(["return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Average?(0,K.H)(p||(p=(0,G.Z)(["return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Lighten?(0,K.H)(v||(v=(0,G.Z)(["return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Darken?(0,K.H)(m||(m=(0,G.Z)(["return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Lighter?(0,K.H)(_||(_=(0,G.Z)(["return vec4(cl * ol + cb * ob, ol + ob);"]))):n===Q.iM.Plus?(0,K.H)(y||(y=(0,G.Z)(["return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);"]))):n===Q.iM.Minus?(0,K.H)(g||(g=(0,G.Z)(["return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);"]))):n===Q.iM.Screen?(0,K.H)(b||(b=(0,G.Z)(["return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Difference?(0,K.H)(w||(w=(0,G.Z)(["return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Invert?(0,K.H)(C||(C=(0,G.Z)(["return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);"]))):n===Q.iM.DestinationOver?(0,K.H)(x||(x=(0,G.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);"]))):n===Q.iM.DestinationAtop?(0,K.H)(T||(T=(0,G.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);"]))):n===Q.iM.DestinationOut?(0,K.H)(S||(S=(0,G.Z)(["return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));"]))):n===Q.iM.SourceAtop?(0,K.H)(k||(k=(0,G.Z)(["return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);"]))):n===Q.iM.SourceOut?(0,K.H)(P||(P=(0,G.Z)(["return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));"]))):n===Q.iM.Xor?(0,K.H)(R||(R=(0,G.Z)(["return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));"]))):n===Q.iM.DestinationIn?(0,K.H)(A||(A=(0,G.Z)(["return vec4(cb * ob * ol, ol * ob);"]))):n===Q.iM.SourceIn?(0,K.H)(E||(E=(0,G.Z)(["return vec4(cl * ol * ob, ol * ob);"]))):n===Q.iM.Hue?(0,K.H)(O||(O=(0,G.Z)(["\n          vec3 f = setLumSat(cl, cb, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Saturation?(0,K.H)(M||(M=(0,G.Z)(["\n          vec3 f = setLumSat(cb, cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Color?(0,K.H)(Z||(Z=(0,G.Z)(["\n          vec3 f = setLum(cl, cb);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Luminosity?(0,K.H)(I||(I=(0,G.Z)(["\n          vec3 f = setLum(cb, cl);\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Exclusion?(0,K.H)(D||(D=(0,G.Z)(["\n          vec3 f = cl + cb - 2.0 * cl * cb;\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Reflect?(0,K.H)(L||(L=(0,G.Z)(["\n          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.ColorDodge?(0,K.H)(N||(N=(0,G.Z)(["\n          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.ColorBurn?(0,K.H)(F||(F=(0,G.Z)(["\n          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.Overlay?(0,K.H)(U||(U=(0,G.Z)(["\n          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.SoftLight?(0,K.H)(V||(V=(0,G.Z)(["\n          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.HardLight?(0,K.H)(H||(H=(0,G.Z)(["\n          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):n===Q.iM.VividLight?(0,K.H)(z||(z=(0,G.Z)(["\n          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));\n          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));"]))):(0,K.H)(B||(B=(0,G.Z)([""]))))))}var ee,te,ne,re,ie,ae,oe,se,le,ue,ce,he,de,fe=n(75993),pe=n(49450),ve=n(58406),me=n(19253),_e=n(97528);!function(e){e[e.Composite=0]="Composite",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.GroupBackgroundComposite=3]="GroupBackgroundComposite",e[e.COUNT=4]="COUNT"}(ce||(ce={})),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(he||(he={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(de||(de={}));K.K;function ye(e,t){var n=t.output===ce.GridComposite,r=t.output===ce.ColorComposite,i=t.output===ce.GroupBackgroundComposite,a=t.output===ce.Composite;n&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.include(J.H)),r&&e.fragment.uniforms.add(new pe.J("backgroundColor",(function(e){return e.backgroundColor})));var o=t.baseOpacityMode===he.Required;if(o&&e.fragment.uniforms.add(new ve.p("baseOpacity",(function(e){return e.baseOpacity}))),a){var s=t.hasWebGL2Context?_e.D.None:_e.D.InvSize;e.fragment.uniforms.add((0,me.J)("fboColor",(function(e){return e.fboTexture}),s))}var l=t.blendMode!==Q.iM.Normal,u=t.premultipliedSource===de.On;e.fragment.include($,t),e.fragment.code.add((0,K.H)(ee||(ee=(0,G.Z)(["\n    vec4 getBackground(vec2 uv) {\n      return "," ",";\n    }\n\n    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {\n      ","\n    }"])),o?(0,K.H)(te||(te=(0,G.Z)(["baseOpacity *"]))):"",i?(0,K.H)(ne||(ne=(0,G.Z)(["vec4(0.0, 0.0, 0.0, 0.0)"]))):r?(0,K.H)(re||(re=(0,G.Z)(["vec4(backgroundColor, 1.0)"]))):n?(0,K.H)(ie||(ie=(0,G.Z)(["vec4(gridColor(uv), 1.0)"]))):(0,K.H)(ae||(ae=(0,G.Z)(["",""])),(0,fe.b6)(t,"fboColor","gl_FragCoord.xy")),l?(0,K.H)(oe||(oe=(0,G.Z)(["\n          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;\n          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;\n          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);"]))):(0,K.H)(se||(se=(0,G.Z)(["\n          float composeAlpha = colorLayer.a * opacity;\n          return ",""])),!u&&(a&&!o||i)?(0,K.H)(le||(le=(0,G.Z)(["colorLayer * opacity;"]))):(0,K.H)(ue||(ue=(0,G.Z)(["bgColor * (1.0 - composeAlpha) + colorLayer * opacity;"]))))))}},55375:function(e,t,n){var r;n.d(t,{R:function(){return r}}),function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(r||(r={}))},32426:function(e,t,n){n.d(t,{R:function(){return p},T:function(){return v}});var r,i=n(30168),a=n(43144),o=n(15671),s=n(60136),l=n(92572),u=n(6394),c=n(82999),h=n(58406),d=n(98634),f=n(4760),p=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e;return(0,o.Z)(this,n),(e=t.apply(this,arguments)).scale=1,e.offset=u.Z,e}return(0,a.Z)(n)}(d.K);function v(e){e.attributes.add(f.T.POSITION,"vec2"),e.attributes.add(f.T.UV0,"vec2"),e.vertex.uniforms.add(new h.p("scale",(function(e){return e.scale}))),e.vertex.uniforms.add(new c.A("offset",(function(e){return e.offset}))),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.code.add((0,d.H)(r||(r=(0,i.Z)(["void main(void) {\ngl_Position = vec4(position, 0.0, 1.0);\nuv = uv0 * scale + offset;\nvuv = uv0;\n}"]))))}},86097:function(e,t,n){n.d(t,{U:function(){return r},j:function(){return a}});var r,i=n(92975);function a(e){return e&&(0,i.BZ)(e)?r.Mars:e&&(0,i.V2)(e)?r.Moon:r.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(r||(r={}))},20395:function(e,t,n){n.d(t,{$:function(){return u}});var r=n(43144),i=n(15671),a=n(60136),o=n(92572),s=n(61809),l=n(99340),u=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(e,r){return(0,i.Z)(this,n),t.call(this,e,"vec4",l.P.Draw,(function(t,n,i){return t.setUniform4fv(e,r(n,i))}))}return(0,r.Z)(n)}(s.x)},91526:function(e,t,n){n.d(t,{a:function(){return a}});var r=n(43144),i=n(15671),a=(0,r.Z)((function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:n;(0,i.Z)(this,e),this.data=t,this.size=n,this.exclusive=r,this.stride=a}))},2263:function(e,t,n){n.d(t,{Y:function(){return r},n:function(){return s}});var r,i=n(93169),a=n(59447),o=n(75248);function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,i.Z)("enable-feature:high-quality-idle"),t=new a.r;return e&&(t.set(o.n.INTERACTING,r.Antialiasing,!0),t.set(o.n.IDLE,r.Antialiasing,!0),t.set(o.n.INTERACTING,r.HighQualityTransparency,!0),t.set(o.n.IDLE,r.HighQualityTransparency,!0),t.set(o.n.INTERACTING,r.RealisticAtmosphere,!0),t.set(o.n.IDLE,r.RealisticAtmosphere,!0),t.set(o.n.IDLE,r.SSAO,!0),t.set(o.n.IDLE,r.WaterReflection,!0),t.set(o.n.IDLE,r.PhysicalPixelRendering,!0)),t.set(o.n.ANIMATING,r.ShadowMapUpdate,!0),t.set(o.n.INTERACTING,r.ShadowMapUpdate,!0),t.set(o.n.IDLE,r.ShadowMapUpdate,!0),t.set(o.n.IDLE,r.HighQualityVoxel,!0),t}!function(e){e[e.Antialiasing=0]="Antialiasing",e[e.HighQualityTransparency=1]="HighQualityTransparency",e[e.HighQualityVoxel=2]="HighQualityVoxel",e[e.RealisticAtmosphere=3]="RealisticAtmosphere",e[e.SSAO=4]="SSAO",e[e.WaterReflection=5]="WaterReflection",e[e.ShadowMapUpdate=6]="ShadowMapUpdate",e[e.PhysicalPixelRendering=7]="PhysicalPixelRendering"}(r||(r={}))},4760:function(e,t,n){var r;n.d(t,{T:function(){return r}}),function(e){e.POSITION="position",e.NORMAL="normal",e.UV0="uv0",e.AUXPOS1="auxpos1",e.AUXPOS2="auxpos2",e.COLOR="color",e.SYMBOLCOLOR="symbolColor",e.SIZE="size",e.TANGENT="tangent",e.OFFSET="offset",e.SUBDIVISIONFACTOR="subdivisionFactor",e.COLORFEATUREATTRIBUTE="colorFeatureAttribute",e.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",e.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",e.DISTANCETOSTART="distanceToStart",e.UVMAPSPACE="uvMapSpace",e.BOUNDINGRECT="boundingRect",e.UVREGION="uvRegion",e.NORMALCOMPRESSED="normalCompressed",e.PROFILERIGHT="profileRight",e.PROFILEUP="profileUp",e.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",e.FEATUREVALUE="featureValue",e.MODELORIGINHI="modelOriginHi",e.MODELORIGINLO="modelOriginLo",e.MODEL="model",e.MODELNORMAL="modelNormal",e.INSTANCECOLOR="instanceColor",e.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",e.LOCALTRANSFORM="localTransform",e.GLOBALTRANSFORM="globalTransform",e.BOUNDINGSPHERE="boundingSphere",e.MODELORIGIN="modelOrigin",e.MODELSCALEFACTORS="modelScaleFactors",e.FEATUREATTRIBUTE="featureAttribute",e.STATE="state",e.LODLEVEL="lodLevel",e.POSITION0="position0",e.POSITION1="position1",e.NORMALA="normalA",e.NORMALB="normalB",e.COMPONENTINDEX="componentIndex",e.VARIANTOFFSET="variantOffset",e.VARIANTSTROKE="variantStroke",e.VARIANTEXTENSION="variantExtension",e.U8PADDING="u8padding",e.U16PADDING="u16padding",e.SIDENESS="sideness",e.START="start",e.END="end",e.UP="up",e.EXTRUDE="extrude",e.OBJECTANDLAYERIDCOLOR="objectAndLayerIdColor",e.OBJECTANDLAYERIDCOLOR_INSTANCED="objectAndLayerIdColor_instanced"}(r||(r={}))},7494:function(e,t,n){n.d(t,{D:function(){return f}});var r=n(74165),i=n(15861),a=n(15671),o=n(43144),s=n(60136),l=n(92572),u=n(18722),c=n(46798),h=n(22526),d=n(79762),f=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e){return(0,a.Z)(this,n),t.call(this,"EdgeProcessingWorker","extract",{extract:function(e){return[e.dataBuffer]},extractComponentsEdgeLocations:function(e){return[e.dataBuffer]},extractEdgeLocations:function(e){return[e.dataBuffer]}},e)}return(0,o.Z)(n,[{key:"process",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(t,n,i){var a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i){e.next=2;break}return e.abrupt("return",(0,d.Kl)(t));case 2:return e.next=4,this.invoke(new p(t),n);case 4:return a=e.sent,e.abrupt("return",this._unpackOutput(a));case 6:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"extractEdgeLocations",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(t,n){var i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.invokeMethod("extractEdgeLocations",new p(t),n);case 2:return i=e.sent,e.abrupt("return",(0,h.aj)(i));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"extractComponentsEdgeLocations",value:function(){var e=(0,i.Z)((0,r.Z)().mark((function e(t,n){var i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.invokeMethod("extractComponentsEdgeLocations",new p(t),n);case 2:return i=e.sent,e.abrupt("return",(0,h.aj)(i));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_unpackOutput",value:function(e){return{regular:{instancesData:(0,h.aj)(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:(0,h.aj)(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}]),n}(c.q),p=(0,o.Z)((function e(t){(0,a.Z)(this,e),this.dataBuffer=t.data.buffer,this.writerSettings=t.writerSettings,this.skipDeduplicate=t.skipDeduplicate,this.indices=Array.isArray(t.indices)?t.indices:t.indices.buffer,this.indicesType=Array.isArray(t.indices)?"Array":(0,u.ZY)(t.indices)?"Uint32Array":"Uint16Array",this.indicesLength=t.indicesLength}))},67009:function(e,t,n){n.d(t,{Hr:function(){return h},dG:function(){return c},dx:function(){return l},rD:function(){return s},so:function(){return d},tf:function(){return o}});var r=n(50256),i=n(55158),a=n(4760),o=(0,i.U$)().vec3f(a.T.POSITION).u16(a.T.COMPONENTINDEX).u16(a.T.U16PADDING),s=(0,i.U$)().vec2u8(a.T.SIDENESS),l=(0,r.K)(s),u=(0,i.U$)().vec3f(a.T.POSITION0).vec3f(a.T.POSITION1).u16(a.T.COMPONENTINDEX).u8(a.T.VARIANTOFFSET,{glNormalized:!0}).u8(a.T.VARIANTSTROKE).u8(a.T.VARIANTEXTENSION,{glNormalized:!0}).u8(a.T.U8PADDING,{glPadding:!0}).u16(a.T.U16PADDING,{glPadding:!0}),c=u.clone().vec3f(a.T.NORMAL),h=u.clone().vec3f(a.T.NORMALA).vec3f(a.T.NORMALB),d=new Map([[a.T.POSITION0,0],[a.T.POSITION1,1],[a.T.COMPONENTINDEX,2],[a.T.VARIANTOFFSET,3],[a.T.VARIANTSTROKE,4],[a.T.VARIANTEXTENSION,5],[a.T.NORMAL,6],[a.T.NORMALA,6],[a.T.NORMALB,7],[a.T.SIDENESS,8]])},41371:function(e,t,n){n.d(t,{D9:function(){return _},qE:function(){return y}});var r=n(15671),i=n(43144),a=n(84936),o=n(11186),s=n(71353),l=n(50256),u=n(67009),c=function(){function e(){(0,r.Z)(this,e)}return(0,i.Z)(e,[{key:"updateSettings",value:function(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?v:p}},{key:"write",value:function(e,t,n){var r=this._edgeHashFunction(n);b.seed=r;var i=b.getIntRange(0,255),a=b.getIntRange(0,this.settings.variants-1),o=b.getFloat(),s=255*(.5*function(e,t){var n=e<0?-1:1;return Math.pow(Math.abs(e),t)*n}(-(1-Math.min(o/.7,1))+Math.max(0,o-.7)/(1-.7),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,i),e.variantStroke.set(t,a),e.variantExtension.set(t,s)}},{key:"trim",value:function(e,t){return e.slice(0,t)}}]),e}(),h=new Float32Array(6),d=new Uint32Array(h.buffer),f=new Uint32Array(1);function p(e){var t=h;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],f[0]=5381;for(var n=0;n<d.length;n++)f[0]=31*f[0]+d[n];return f[0]}function v(e){var t=h;t[0]=m(e.position0[0]),t[1]=m(e.position0[1]),t[2]=m(e.position0[2]),t[3]=m(e.position1[0]),t[4]=m(e.position1[1]),t[5]=m(e.position1[2]),f[0]=5381;for(var n=0;n<d.length;n++)f[0]=31*f[0]+d[n];return f[0]}function m(e){return Math.round(1e4*e)/1e4}var _=function(){function e(){(0,r.Z)(this,e),this._commonWriter=new c}return(0,i.Z)(e,[{key:"updateSettings",value:function(e){this._commonWriter.updateSettings(e)}},{key:"allocate",value:function(e){return u.dG.createBuffer(e)}},{key:"write",value:function(e,t,n){this._commonWriter.write(e,t,n),(0,o.a)(g,n.faceNormal0,n.faceNormal1),(0,o.n)(g,g),e.normal.setVec(t,g)}},{key:"trim",value:function(e,t){return this._commonWriter.trim(e,t)}}]),e}();_.Layout=u.dG,_.glLayout=(0,l.K)(u.dG,1);var y=function(){function e(){(0,r.Z)(this,e),this._commonWriter=new c}return(0,i.Z)(e,[{key:"updateSettings",value:function(e){this._commonWriter.updateSettings(e)}},{key:"allocate",value:function(e){return u.Hr.createBuffer(e)}},{key:"write",value:function(e,t,n){this._commonWriter.write(e,t,n),e.normalA.setVec(t,n.faceNormal0),e.normalB.setVec(t,n.faceNormal1)}},{key:"trim",value:function(e,t){return this._commonWriter.trim(e,t)}}]),e}();y.Layout=u.Hr,y.glLayout=(0,l.K)(u.Hr,1);var g=(0,s.c)(),b=new a.Z},10662:function(e,t,n){n.d(t,{P:function(){return r},n:function(){return u}});var r,i=n(63780),a=n(16889),o=n(11186),s=n(71353),l=-1;function u(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:_,s=e.vertices.position,u=e.vertices.componentIndex,m=(0,a.Vl)(r.anglePlanar),y=(0,a.Vl)(r.angleSignificantEdge),g=Math.cos(y),b=Math.cos(m),w=v.edge,C=w.position0,x=w.position1,T=w.faceNormal0,S=w.faceNormal1,k=p(e),P=f(e),R=P.length/4,A=t.allocate(R),E=0,O=R,M=n.allocate(O),Z=0,I=0,D=0,L=(0,i.w6)(0,R),N=new Float32Array(R);N.forEach((function(e,t,n){s.getVec(P[4*t+0],C),s.getVec(P[4*t+1],x),n[t]=(0,o.i)(C,x)})),L.sort((function(e,t){return N[t]-N[e]}));for(var F=new Array,U=new Array,V=0;V<R;V++){var H=L[V],z=N[H],B=P[4*H+0],G=P[4*H+1],W=P[4*H+2],j=P[4*H+3],q=j===l;if(s.getVec(B,C),s.getVec(G,x),q)(0,o.s)(T,k[3*W+0],k[3*W+1],k[3*W+2]),(0,o.c)(S,T),w.componentIndex=u.get(B),w.cosAngle=(0,o.e)(T,S);else{if((0,o.s)(T,k[3*W+0],k[3*W+1],k[3*W+2]),(0,o.s)(S,k[3*j+0],k[3*j+1],k[3*j+2]),w.componentIndex=u.get(B),w.cosAngle=(0,o.e)(T,S),h(w,b))continue;w.cosAngle<-.9999&&(0,o.c)(S,T)}I+=z,D++,q||c(w,g)?(t.write(A,E++,w),F.push(z)):d(w,m)&&(n.write(M,Z++,w),U.push(z))}var Y=new Float32Array(F.reverse()),X=new Float32Array(U.reverse());return{regular:{instancesData:t.trim(A,E),lodInfo:{lengths:Y}},silhouette:{instancesData:n.trim(M,Z),lodInfo:{lengths:X}},averageEdgeLength:I/D}}function c(e,t){return e.cosAngle<t}function h(e,t){return e.cosAngle>t}function d(e,t){var n=(0,a.ZF)(e.cosAngle),r=v.fwd,i=v.ortho;return(0,o.r)(r,e.position1,e.position0),n*((0,o.e)((0,o.f)(i,e.faceNormal0,e.faceNormal1),r)>0?-1:1)>t}function f(e){for(var t=e.faces.length/3,n=e.faces,r=e.neighbors,i=0,a=0;a<t;a++){var o=r[3*a+0],s=r[3*a+1],u=r[3*a+2],c=n[3*a+0],h=n[3*a+1],d=n[3*a+2];i+=o===l||c<h?1:0,i+=s===l||h<d?1:0,i+=u===l||d<c?1:0}for(var f=new Int32Array(4*i),p=0,v=0;v<t;v++){var m=r[3*v+0],_=r[3*v+1],y=r[3*v+2],g=n[3*v+0],b=n[3*v+1],w=n[3*v+2];(m===l||g<b)&&(f[p++]=g,f[p++]=b,f[p++]=v,f[p++]=m),(_===l||b<w)&&(f[p++]=b,f[p++]=w,f[p++]=v,f[p++]=_),(y===l||w<g)&&(f[p++]=w,f[p++]=g,f[p++]=v,f[p++]=y)}return f}function p(e){for(var t=e.faces.length/3,n=e.vertices.position,r=e.faces,i=m.v0,a=m.v1,s=m.v2,l=new Float32Array(3*t),u=0;u<t;u++){var c=r[3*u+0],h=r[3*u+1],d=r[3*u+2];n.getVec(c,i),n.getVec(h,a),n.getVec(d,s),(0,o.b)(a,a,i),(0,o.b)(s,s,i),(0,o.f)(i,a,s),(0,o.n)(i,i),l[3*u+0]=i[0],l[3*u+1]=i[1],l[3*u+2]=i[2]}return l}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH"}(r||(r={}));var v={edge:{position0:(0,s.c)(),position1:(0,s.c)(),faceNormal0:(0,s.c)(),faceNormal1:(0,s.c)(),componentIndex:0,cosAngle:0},ortho:(0,s.c)(),fwd:(0,s.c)()},m={v0:(0,s.c)(),v1:(0,s.c)(),v2:(0,s.c)()},_={anglePlanar:4,angleSignificantEdge:35}},79762:function(e,t,n){n.d(t,{Kl:function(){return d},n_:function(){return y},kY:function(){return f},Yr:function(){return _}});var r=n(43144),i=n(15671),a=n(35888);function o(e,t,n){for(var r=t/3,i=new Uint32Array(n+1),a=new Uint32Array(n+1),o=function(e,t){e<t?i[e+1]++:a[t+1]++},s=0;s<r;s++){var l=e[3*s],u=e[3*s+1],c=e[3*s+2];o(l,u),o(u,c),o(c,l)}for(var h=0,d=0,f=0;f<n;f++){var p=i[f+1],v=a[f+1];i[f+1]=h,a[f+1]=d,h+=p,d+=v}for(var m=new Uint32Array(6*r),_=i[n],y=function(e,t,n){if(e<t){var r=i[e+1]++;m[2*r]=t,m[2*r+1]=n}else{var o=a[t+1]++;m[2*_+2*o]=e,m[2*_+2*o+1]=n}},g=0;g<r;g++){var b=e[3*g],w=e[3*g+1],C=e[3*g+2];y(b,w,g),y(w,C,g),y(C,b,g)}for(var x=function(e,t){for(var n=2*e,r=t-e,i=1;i<r;i++){for(var a=m[n+2*i],o=m[n+2*i+1],s=i-1;s>=0&&m[n+2*s]>a;s--)m[n+2*s+2]=m[n+2*s],m[n+2*s+3]=m[n+2*s+1];m[n+2*s+2]=a,m[n+2*s+3]=o}},T=0;T<n;T++)x(i[T],i[T+1]),x(_+a[T],_+a[T+1]);for(var S=new Int32Array(3*r),k=function(t,n){return t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1},P=function(e,t){var n=k(e,t);S[3*t+n]=-1},R=function(e,t,n,r){var i=k(e,t);S[3*t+i]=r;var a=k(n,r);S[3*r+a]=t},A=0;A<n;A++){for(var E=i[A],O=i[A+1],M=a[A],Z=a[A+1];E<O&&M<Z;){var I=m[2*E],D=m[2*_+2*M];I===D?(R(A,m[2*E+1],D,m[2*_+2*M+1]),E++,M++):I<D?(P(A,m[2*E+1]),E++):(P(D,m[2*_+2*M+1]),M++)}for(;E<O;)P(A,m[2*E+1]),E++;for(;M<Z;)P(m[2*_+2*M],m[2*_+2*M+1]),M++}return S}var s=n(55158),l=n(4760),u=n(67009),c=n(41371),h=n(10662);function d(e){var t=f(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return v.updateSettings(e.writerSettings),m.updateSettings(e.writerSettings),(0,h.n)(t,v,m)}function f(e,t,n,r){if(t){var i=o(n,r,e.count);return new p(n,r,i,e)}var s=(0,a.d)(e.buffer,e.stride/4,{originalIndices:n,originalIndicesLength:r}),l=o(s.indices,r,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:l,vertices:u.tf.createView(s.buffer)}}var p=(0,r.Z)((function e(t,n,r,a){(0,i.Z)(this,e),this.faces=t,this.facesLength=n,this.neighbors=r,this.vertices=a})),v=new c.D9,m=new c.qE,_=(0,s.U$)().vec3f(l.T.POSITION0).vec3f(l.T.POSITION1),y=(0,s.U$)().vec3f(l.T.POSITION0).vec3f(l.T.POSITION1).u16(l.T.COMPONENTINDEX).u16(l.T.U16PADDING,{glPadding:!0})},41781:function(e,t,n){n.d(t,{J4:function(){return d},VB:function(){return _},_s:function(){return y},bK:function(){return p},tB:function(){return f}});var r=n(92026),i=n(14226),a=n(71353),o=n(41414),s=n(23470),l=n(85312),u=n(43449),c=n(22178),h=n(22255);function d(e,t){var n,r;return(0,c.es)(e)||(0,c.G1)(e)?m(null===(n=e.target)||void 0===n?void 0:n.object.metadata,t):(0,u.TX)(e)?null===(r=t.map)||void 0===r?void 0:r.ground:(0,l.a8)(e)||(0,l.GS)(e)||(0,u.j9)(e)||(0,l.A8)(e)?m(e.target,t):null}function f(e,t){var n=p(e,t);return(0,r.pC)(n)&&"graphic"===n.type?n.graphic:null}function p(e,t){var n;if((0,r.Wi)(e))return null;if((0,c.es)(e)||(0,c.G1)(e))return v(null===(n=e.target)||void 0===n?void 0:n.object.metadata,t);if((0,l.a8)(e)){var i=e.target.createGraphic();return{type:"graphic",graphic:i,layer:i.layer}}if((0,l.A8)(e)){var a=e.target.createVoxelGraphic();return{type:"graphic",graphic:a,layer:a.layer}}return(0,u.j9)(e)||(0,h.w)(e)?v(e.target,t):(0,l.GS)(e)?function(e,t){var n=m(e,t);if((0,r.Wi)(n))return null;var i=t.allLayerViews.find((function(e){return e.layer===n}));return i&&!i.suspended&&"getGraphicFromIntersectorTarget"in i?function(e){return(0,r.pC)(e)?{type:"graphic",graphic:e,layer:e.layer}:null}(i.getGraphicFromIntersectorTarget(e)):null}(e.target,t):null}function v(e,t){if((0,r.Wi)(e)||(0,r.Wi)(e.graphicUid))return null;var n=m(e,t);if((0,r.Wi)(n))return null;if(n===t.graphics)return(0,r.Wi)(t.graphicsView)||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid);var i=t.allLayerViews.find((function(e){return e.layer===n}));return!i||i.suspended||(0,r.Wi)(e.graphicUid)?null:"getHit"in i?i.getHit(e.graphicUid):null}function m(e,t){return!e||(0,r.Wi)(e.layerUid)?null:(0,r.pC)(t.graphicsView)&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.findLayerByUid(e.layerUid)}function _(e,t){if((0,c.es)(e)||(0,c.G1)(e))return(0,s.a)(e.target.object.boundingVolumeWorldSpace.bounds);if((0,h.w)(e)){(0,i.l)(g,e.transformation);var n=Math.max(g[0],g[1],g[2]);return e.target.baseBoundingSphere.radius*n}return(0,l.GS)(e)?(0,r.yw)(function(e,t){var n=m(e,t);if((0,r.Wi)(n))return null;var i=t.allLayerViews.find((function(e){return e.layer===n}));return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(e):null}(e.target,t),(function(e){return.5*(0,o.wz)(e)})):null}function y(e){return!(0,c.es)(e)&&!(0,c.G1)(e)&&((0,h.w)(e)?e.target.numLodLevels>1:!!(0,l.GS)(e))}var g=(0,a.c)()},90541:function(e,t,n){n.d(t,{PR:function(){return c},dz:function(){return h}});var r=n(43144),i=n(15671),a=n(60136),o=n(92572),s=n(90045),l=n(67077),u=n(95276),c=function(e){(0,a.Z)(n,e);var t=(0,o.Z)(n);function n(){return(0,i.Z)(this,n),t.apply(this,arguments)}return(0,r.Z)(n)}(n(98634).K);function h(e){e.uniforms.add(new u.N("resolution",(function(e){var t=e.colorTexture.descriptor,n=t.width,r=t.height;return(0,s.s)(d,1/n,1/r,n,r)})))}var d=(0,l.c)()},79485:function(e,t,n){n.d(t,{l:function(){return c},w:function(){return r}});var r,i=n(43144),a=n(15671),o=n(60136),s=n(92572),l=n(27366),u=n(33559);!function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold",e[e.COUNT=2]="COUNT"}(r||(r={}));var c=function(e){(0,o.Z)(n,e);var t=(0,s.Z)(n);function n(){var e;return(0,a.Z)(this,n),(e=t.apply(this,arguments)).visualization=r.Gradient,e.bandsEnabled=!1,e}return(0,i.Z)(n)}(u.m);(0,l._)([(0,u.o)({count:r.COUNT})],c.prototype,"visualization",void 0),(0,l._)([(0,u.o)()],c.prototype,"bandsEnabled",void 0)},99954:function(e,t,n){n.d(t,{g:function(){return v}});var r,i=n(30168),a=n(6394),o=n(98634);function s(e){var t=(0,o.H)(r||(r=(0,i.Z)(["bool isNaN( float val )\n{\nreturn ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;\n}"])));e.code.add(t)}var l,u,c,h=n(82999),d=n(35522),f=n(8654),p=(0,a.f)(.5,-4e-4);function v(e,t){var n=e.vertex;n.include(s),n.constants.add("depthBias","vec2",p),n.uniforms.add(new h.A("inverseViewport",(function(e,t){return t.inverseViewport}))),t.legacy?(n.uniforms.add(new f.g("proj",(function(e,t){return t.camera.projectionMatrix}))),n.code.add((0,o.H)(l||(l=(0,i.Z)(["vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {\nfloat offsetXY = depthBias.x;\nvec4 projNormal = proj * localView * vec4(globalNormal, 0.0);\nreturn offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;\n}"]))))):(n.uniforms.add(new d.c("transformNormalViewFromGlobal",(function(e){return e.transformNormalViewFromGlobal}))),n.uniforms.add(new f.g("transformProjFromView",(function(e){return e.transformProjFromView}))),n.code.add((0,o.H)(u||(u=(0,i.Z)(["vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {\nfloat offsetXY = depthBias.x;\nvec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);\nreturn offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;\n}"]))))),n.code.add((0,o.H)(c||(c=(0,i.Z)(["float _calculateProjectedBiasZ(vec4 projPos) {\nfloat offsetZ = depthBias.y;\nreturn sqrt(max(projPos.z,0.0)) * offsetZ;\n}\nvec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {\nvec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);\nif (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {\nprojPos.xy += offsetXY;\n}\nprojPos.z += _calculateProjectedBiasZ(projPos);\nreturn projPos;\n}"]))))}},63438:function(e,t,n){n.d(t,{S:function(){return s}});var r,i,a=n(30168),o=n(98634);function s(e,t){var n=e.fragment;n.constants.add("coverageTestThreshold","float",.01),t.antialiasing?n.code.add((0,o.H)(r||(r=(0,a.Z)(["#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }"])))):n.code.add((0,o.H)(i||(i=(0,a.Z)(["#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }"]))))}},11268:function(e,t,n){n.d(t,{o:function(){return u}});var r,i,a,o,s=n(30168),l=n(98634);function u(e,t){var n=e.vertex;t.silhouette?(n.code.add((0,l.H)(r||(r=(0,s.Z)(["bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {\nfloat faceAVisible = dot(viewDir, normalA);\nfloat faceBVisible = dot(viewDir, normalB);\nreturn faceAVisible * faceBVisible < 0.0;\n}"])))),t.legacy?n.code.add((0,l.H)(i||(i=(0,s.Z)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {\nvec3 viewNormalA = _modelToViewNormal(normalA);\nvec3 viewNormalB = _modelToViewNormal(normalB);\nvec3 viewDir = -viewPos;\nif (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {\nreturn false;\n}\ngl_Position = vec4(10.0, 10.0, 10.0, 1.0);\nreturn true;\n}"])))):n.code.add((0,l.H)(a||(a=(0,s.Z)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {\nvec3 worldNormalA = _modelToWorldNormal(normalA);\nvec3 worldNormalB = _modelToWorldNormal(normalB);\nvec3 viewDir = -worldPos;\nif (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {\nreturn false;\n}\ngl_Position = vec4(10.0, 10.0, 10.0, 1.0);\nreturn true;\n}"]))))):n.code.add((0,l.H)(o||(o=(0,s.Z)(["bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {\nreturn false;\n}"]))))}},34016:function(e,t,n){n.d(t,{G7:function(){return m},Jb:function(){return v},UR:function(){return M},lV:function(){return Z}});var r,i,a,o,s,l,u,c,h,d,f,p,v,m,_=n(30168),y=n(37107),g=n(27254),b=n(78980),w=n(75993),C=n(86471),x=n(49450),T=n(58406),S=n(98634),k=n(82644),P=n(35522),R=n(8654),A=n(78050),E=n(97528),O=n(4760);function M(e,t){var n=e.vertex;n.include(b.n),n.uniforms.add(new T.p("distanceFalloffFactor",(function(e){return e.distanceFalloffFactor}))),n.code.add((0,S.H)(r||(r=(0,_.Z)(["float distanceBasedPerspectiveFactor(float distance) {\nreturn clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);\n}"])))),n.uniforms.add((0,A.F)("componentDataTex",(function(e){return e.componentDataTexture}),t.hasWebGL2Context?E.D.None:E.D.InvSize)),e.attributes.add(O.T.COMPONENTINDEX,"float"),n.constants.add("componentColorFieldOffset","float",0),n.constants.add("componentOtherFieldOffset","float",1),n.constants.add("componentVerticalOffsetFieldOffset","float",2),n.constants.add("componentFieldCount","float",3),n.constants.add("lineWidthFractionFactor","float",8),n.constants.add("extensionLengthOffset","float",128),n.constants.add("verticalOffsetScale","float",2*y.E_),n.code.add((0,S.H)(i||(i=(0,_.Z)(["\n    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {\n      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;\n\n      vec2 textureSizeInverse = ",";\n\n      float colIndex = mod(fieldIndex, 1.0 / textureSizeInverse.x);\n      float rowIndex = floor(fieldIndex * textureSizeInverse.x);\n\n      return vec2(colIndex, rowIndex) + 0.5;\n    }\n\n    struct ComponentData {\n      vec4 color;\n      float lineWidth;\n      float extensionLength;\n      float type;\n      float verticalOffset;\n    };\n\n    ComponentData readComponentData() {\n      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);\n      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);\n      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);\n\n      vec4 colorValue = ",";\n      vec4 otherValue = ",";\n      float verticalOffset = (rgba2float(",") - 0.5) * verticalOffsetScale;\n\n      return ComponentData(\n        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity\n        otherValue.x * (255.0 / lineWidthFractionFactor),\n        otherValue.y * 255.0 - extensionLengthOffset,\n        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;\n        verticalOffset\n      );\n    }\n  "])),(0,w.w_)(t,"componentDataTex",!0),(0,w.b6)(t,"componentDataTex","colorIndex"),(0,w.b6)(t,"componentDataTex","otherIndex"),(0,w.b6)(t,"componentDataTex","verticalOffsetIndex"))),t.legacy?n.code.add((0,S.H)(a||(a=(0,_.Z)(["vec3 _modelToWorldNormal(vec3 normal) {\nreturn (model * vec4(normal, 0.0)).xyz;\n}\nvec3 _modelToViewNormal(vec3 normal) {\nreturn (localView * model * vec4(normal, 0.0)).xyz;\n}"])))):(n.uniforms.add(new k.j("transformNormalGlobalFromModel",(function(e){return e.transformNormalGlobalFromModel}))),n.code.add((0,S.H)(o||(o=(0,_.Z)(["vec3 _modelToWorldNormal(vec3 normal) {\nreturn transformNormalGlobalFromModel * normal;\n}"]))))),t.silhouette?(e.attributes.add(O.T.NORMALA,"vec3"),e.attributes.add(O.T.NORMALB,"vec3"),n.code.add((0,S.H)(s||(s=(0,_.Z)(["vec3 worldNormal() {\nreturn _modelToWorldNormal(normalize(normalA + normalB));\n}"]))))):(e.attributes.add(O.T.NORMAL,"vec3"),n.code.add((0,S.H)(l||(l=(0,_.Z)(["vec3 worldNormal() {\nreturn _modelToWorldNormal(normal);\n}"]))))),t.legacy?n.code.add((0,S.H)(u||(u=(0,_.Z)(["void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {\nworldPos = (model * vec4(modelPos, 1.0)).xyz;\nviewPos = (localView * vec4(worldPos, 1.0)).xyz;\n}"])))):(n.include(g.$,t),n.include(g.$,t),n.uniforms.add([new P.c("transformViewFromCameraRelativeRS",(function(e){return e.transformViewFromCameraRelativeRS})),new k.j("transformWorldFromModelRS",(function(e){return e.transformWorldFromModelRS})),new C.B("transformWorldFromModelTL",(function(e){return e.transformWorldFromModelTL})),new C.B("transformWorldFromModelTH",(function(e){return e.transformWorldFromModelTH})),new x.J("transformWorldFromViewTL",(function(e){return e.transformWorldFromViewTL})),new x.J("transformWorldFromViewTH",(function(e){return e.transformWorldFromViewTH}))]),n.code.add((0,S.H)(c||(c=(0,_.Z)(["\n      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {\n        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;\n\n        vec3 transformCameraRelativeFromModel = dpAdd(\n          transformWorldFromModelTL,\n          transformWorldFromModelTH,\n          -transformWorldFromViewTL,\n          -transformWorldFromViewTH\n        );\n\n        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;\n\n        if (verticalOffset != 0.0) {\n          vec3 vUp = ","\n          worldPos += verticalOffset * vUp;\n        }\n\n        viewPos = transformViewFromCameraRelativeRS * worldPos;\n      }\n    "])),t.spherical?(0,S.H)(h||(h=(0,_.Z)(["normalize(transformWorldFromModelTL + rotatedModelPosition);"]))):(0,S.H)(d||(d=(0,_.Z)(["vec3(0.0, 0.0, 1.0);"])))))),n.uniforms.add(new R.g("transformProjFromView",(function(e,t){return t.camera.projectionMatrix}))),n.code.add((0,S.H)(f||(f=(0,_.Z)(["vec4 projFromViewPosition(vec3 position) {\nreturn transformProjFromView * vec4(position, 1.0);\n}"])))),n.code.add((0,S.H)(p||(p=(0,_.Z)(["float calculateExtensionLength(float extensionLength, float lineLength) {\nreturn extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);\n}"]))))}function Z(e){return e.mode===v.SKETCH||e.mode===v.MIXED}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"}(v||(v={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.SILHOUETTE=1]="SILHOUETTE"}(m||(m={}))},48779:function(e,t,n){n.d(t,{B:function(){return h}});var r,i,a,o=n(30168),s=n(22035),l=n(98634),u=n(34016),c=n(80883);function h(e,t){var n=e.vertex;switch(e.include(c.H,t),t.mode){case u.Jb.SOLID:n.code.add((0,l.H)(r||(r=(0,o.Z)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nreturn 0.0;\n}"]))));break;case u.Jb.SKETCH:n.uniforms.add(new s.p("strokesAmplitude",(function(e){return e.strokesTexture.amplitude}))),n.code.add((0,l.H)(i||(i=(0,o.Z)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nreturn strokesAmplitude;\n}"]))));break;case u.Jb.MIXED:n.uniforms.add(new s.p("strokesAmplitude",(function(e){return e.strokesTexture.amplitude}))),n.code.add((0,l.H)(a||(a=(0,o.Z)(["float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {\nfloat type = unpackedAttributes.type;\nif (type <= 0.0) {\nreturn strokesAmplitude;\n}\nelse {\nreturn 0.0;\n}\n}"]))))}}},64711:function(e,t,n){n.d(t,{N:function(){return T}});var r,i,a,o,s,l,u,c,h=n(30168),d=n(43144),f=n(15671),p=n(60136),v=n(92572),m=n(78980),_=n(75993),y=n(22035),g=n(98634),b=n(78050),w=n(97528),C=n(34016),x=n(80883);g.K;function T(e,t){e.include(x.H,t);var n=e.vertex,d=e.fragment;switch((0,C.lV)(t)&&(n.uniforms.add((0,b.F)("strokesTexture",(function(e){return e.strokesTexture.texture}),t.hasWebGL2Context?w.D.None:w.D.InvSize)),n.uniforms.add([new y.p("strokesLog2Resolution",(function(e){return Math.log2(e.strokesTexture.resolution)})),new y.p("strokeVariants",(function(e){return e.strokesTexture.variants}))]),e.varyings.add("vStrokeUV","vec2"),d.uniforms.add([new b.R("strokesTexture",(function(e){return e.strokesTexture.texture})),new y.p("strokesNormalizationScale",(function(e){return e.strokesTexture.normalizationScale}))]),n.code.add((0,g.H)(r||(r=(0,h.Z)(["\n      void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {\n        vec2 sidenessNorm = unpackedAttributes.sidenessNorm;\n\n        float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);\n\n        vec2 textureSizeInverse = ",";\n        vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * textureSizeInverse;\n        vStrokeUV.x += variantOffset;\n      }\n    "])),(0,_.w_)(t,"strokesTexture",!0))),e.fragment.include(m.n),d.code.add((0,g.H)(i||(i=(0,h.Z)(["float calculateLineOffsetSketch() {\nfloat offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));\nreturn (offsetNorm - 0.5) * strokesNormalizationScale;\n}\nfloat calculateLinePressureSketch() {\nreturn rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));\n}"]))))),t.mode){case C.Jb.SOLID:n.code.add((0,g.H)(a||(a=(0,h.Z)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}"])))),d.code.add((0,g.H)(o||(o=(0,h.Z)(["float calculateLineOffset() {\nreturn 0.0;\n}\nfloat calculateLinePressure() {\nreturn 1.0;\n}"]))));break;case C.Jb.SKETCH:n.code.add((0,g.H)(s||(s=(0,h.Z)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)\n{\ncalculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);\n}"])))),d.code.add((0,g.H)(l||(l=(0,h.Z)(["float calculateLineOffset() {\nreturn calculateLineOffsetSketch();\n}\nfloat calculateLinePressure() {\nreturn calculateLinePressureSketch();\n}"]))));break;case C.Jb.MIXED:e.varyings.add("vType","float"),n.code.add((0,g.H)(u||(u=(0,h.Z)(["void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)\n{\nvType = unpackedAttributes.type;\nif (unpackedAttributes.type <= 0.0) {\ncalculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);\n}\n}"])))),d.code.add((0,g.H)(c||(c=(0,h.Z)(["float calculateLineOffset() {\nif (vType <= 0.0) {\nreturn calculateLineOffsetSketch();\n}\nelse {\nreturn 0.0;\n}\n}\nfloat calculateLinePressure() {\nif (vType <= 0.0) {\nreturn calculateLinePressureSketch();\n}\nelse {\nreturn 1.0;\n}\n}"]))))}}},80883:function(e,t,n){n.d(t,{H:function(){return f}});var r,i,a,o,s,l=n(30168),u=n(41644),c=n(98634),h=n(4760),d=n(34016);function f(e,t){var n=e.vertex;switch(e.attributes.add(h.T.SIDENESS,"vec2"),t.mode===d.Jb.MIXED?n.code.add((0,c.H)(r||(r=(0,l.Z)(["struct UnpackedAttributes {\nvec2 sideness;\nvec2 sidenessNorm;\nfloat lineWidthPixels;\nfloat extensionLengthPixels;\nfloat type;\n};"])))):n.code.add((0,c.H)(i||(i=(0,l.Z)(["struct UnpackedAttributes {\nvec2 sideness;\nvec2 sidenessNorm;\nfloat lineWidthPixels;\nfloat extensionLengthPixels;\n};"])))),t.mode){case d.Jb.MIXED:n.code.add((0,c.H)(a||(a=(0,l.Z)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat fType = component.type;\nfloat extensionLengthPixels = component.extensionLength;\nfloat lineWidth = component.lineWidth;\nif (fType <= 0.0) {\nextensionLengthPixels *= variantExtension * 2.0 - 1.0;\n}\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);\n}"]))));break;case d.Jb.SKETCH:n.code.add((0,c.H)(o||(o=(0,l.Z)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat extensionLengthPixels = component.extensionLength;\nextensionLengthPixels *= variantExtension * 2.0 - 1.0;\nfloat lineWidth = component.lineWidth;\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);\n}"]))));break;case d.Jb.SOLID:n.code.add((0,c.H)(s||(s=(0,l.Z)(["UnpackedAttributes unpackAttributes(ComponentData component) {\nvec2 sidenessNorm = sideness;\nvec2 sideness = sidenessNorm * 2.0 - 1.0;\nfloat extensionLengthPixels = component.extensionLength;\nfloat lineWidth = component.lineWidth;\nreturn UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);\n}"]))));break;case d.Jb.COUNT:break;default:(0,u.Bg)(t.mode)}}},45727:function(e,t,n){n.d(t,{Z:function(){return kS}});var r=n(1413),i=n(37762),a=n(74165),o=n(15861),s=n(15671),l=n(43144),u=n(97326),c=n(11752),h=n(61120),d=n(60136),f=n(92572),p=n(27366),v=n(13058),m=(n(59486),n(52639)),_=n(36721),y=n(80987),g=n(50093),b=n(10064),w=n(98928),C=n(42537),x=n(93169),T=n(83704),S=n(32718),k=n(92026),P=n(62314),R=n(66978),A=n(94172),E=n(99346),O=n(17842),M=n(31009),Z=n(49861),I=n(89125),D=n(63780),L=n(69912),N=n(25243),F=n(71353),U=n(68748),V=n(90724),H=n(79803),z=n(65156),B=n(82218),G=n(85305),W=n(82582),j=n(28970),q=n(37933),Y=n(37319),X=n(6003),Q=n(78707),J=n(31319),K=n(100),$=n(91505),ee=n(78952),te=n(34066),ne=n(8904),re=n(35535),ie=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).demResolution={min:-1,max:-1},r.noDataValue=re.$7,r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this.view.basemapTerrain.on("elevation-change",(function(){return e.emit("changed",{})}))}},{key:"extent",get:function(){var e=this.view.basemapTerrain;if(null==e||(0,k.Wi)(e.extent)||(0,k.Wi)(e.spatialReference))return null;var t=(0,z.HH)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}},{key:"spatialReference",get:function(){var e;return(0,k.Pt)(null===(e=this.view.basemapTerrain)||void 0===e?void 0:e.spatialReference,ee.Z.WGS84)}},{key:"elevationAt",value:function(e,t){var n;if((0,k.Wi)(this.extent)||!(0,te.Kv)(this.extent,e,t)){var r=(0,k.pC)(this.extent)?"".concat(this.extent.xmin,", ").concat(this.extent.ymin,", ").concat(this.extent.xmax,", ").concat(this.extent.ymax):null;return S.Z.getLogger(this.declaredClass).warn("#elevationAt()","Point used to sample elevation (".concat(e,", ").concat(t,") is outside of the sampler extent (").concat(r,")")),this.noDataValue}return(0,k.Pt)(null===(n=this.view.elevationProvider)||void 0===n?void 0:n.getElevation(e,t,0,this.spatialReference,"ground"),this.noDataValue)}},{key:"queryElevation",value:function(e){return(0,ne.G$)(e.clone(),this)}}]),n}($.Z.EventedAccessor);(0,p._)([(0,Z.Cb)({readOnly:!0})],ie.prototype,"demResolution",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],ie.prototype,"extent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],ie.prototype,"noDataValue",void 0),(0,p._)([(0,Z.Cb)()],ie.prototype,"spatialReference",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],ie.prototype,"view",void 0);var ae=ie=(0,p._)([(0,L.j)("esri.views.support.GroundViewElevationSampler")],ie),oe=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r.view=null,r.layerViews=new y.Z,r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this._handles.add((0,A.gx)((function(){var t,n;return null===(t=e.view)||void 0===t||null===(n=t.map)||void 0===n?void 0:n.ground}),(function(e){return e.load()}))),this._handles.add(this.layerViews.on("after-changes",(function(){return e._layerViewsAfterChangesHandler()})))}},{key:"destroy",value:function(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null)}},{key:"elevationSampler",get:function(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new ae({view:this.view}):null:null}},{key:"updating",get:function(){return!this.suspended&&this.layerViews.some((function(e){return e.updating}))}},{key:"suspended",get:function(){return!this.view||this.view.suspended}},{key:"_layerViewsAfterChangesHandler",value:function(){var e=this;this._handles.remove("updating"),this._handles.add(this.layerViews.map((function(t){return(0,A.YP)((function(){return t.updating}),(function(){return e._updateUpdating()}),A.Z_)})).toArray(),"updating"),this._updateUpdating()}},{key:"_updateUpdating",value:function(){this.notifyChange("updating")}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({readOnly:!0})],oe.prototype,"elevationSampler",null),(0,p._)([(0,Z.Cb)({type:Boolean,readOnly:!0})],oe.prototype,"updating",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],oe.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({type:y.Z,readOnly:!0})],oe.prototype,"layerViews",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],oe.prototype,"suspended",null);var se=oe=(0,p._)([(0,L.j)("esri.views.GroundView")],oe),le=n(28435),ue=n(98921),ce=n(9918),he=n(50951),de=function(){return Promise.all([n.e(58985),n.e(31819)]).then(n.bind(n,31819))},fe=function(){return n.e(73725).then(n.bind(n,73725))},pe={"base-dynamic":function(){return Promise.all([n.e(69229),n.e(11166)]).then(n.bind(n,27304))},"base-elevation":fe,"base-tile":de,"bing-maps":de,"building-scene":function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(44011),n.e(63449),n.e(22075),n.e(59147),n.e(37791),n.e(48506)]).then(n.bind(n,7452))},csv:function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(4766)]).then(n.bind(n,4766))},dimension:function(){return n.e(46143).then(n.bind(n,46143))},elevation:fe,feature:function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(41863)]).then(n.bind(n,41863))},geojson:function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(74385)]).then(n.bind(n,74385))},graphics:function(){return Promise.all([n.e(56717),n.e(41170),n.e(80143),n.e(62573)]).then(n.bind(n,79240))},group:function(){return n.e(5407).then(n.bind(n,5407))},imagery:function(){return Promise.all([n.e(69229),n.e(9237)]).then(n.bind(n,11283))},"integrated-mesh":function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(44011),n.e(63449),n.e(22075),n.e(10983)]).then(n.bind(n,10983))},"line-of-sight":function(){return n.e(31484).then(n.bind(n,31484))},"map-image":function(){return Promise.all([n.e(58985),n.e(69229),n.e(23344)]).then(n.bind(n,23344))},media:function(){return n.e(99037).then(n.bind(n,99037))},"ogc-feature":function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(1732)]).then(n.bind(n,1732))},"open-street-map":de,"oriented-imagery":function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(41863)]).then(n.bind(n,41863))},"point-cloud":function(){return Promise.all([n.e(44011),n.e(90172),n.e(15502)]).then(n.bind(n,15502))},voxel:function(){return n.e(11749).then(n.bind(n,11749))},route:function(){return Promise.all([n.e(56717),n.e(80143),n.e(729),n.e(62923)]).then(n.bind(n,62923))},scene:function(e){return null==e.profile||"mesh-pyramids"===e.profile?Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(44011),n.e(63449),n.e(22075),n.e(79503),n.e(37791),n.e(47745)]).then(n.bind(n,47745)):Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(44011),n.e(63449),n.e(79503),n.e(65225)]).then(n.bind(n,65225))},stream:function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(41170),n.e(27826),n.e(97463),n.e(76627)]).then(n.bind(n,3082))},tile:de,"imagery-tile":function(){return Promise.all([n.e(80394),n.e(19481)]).then(n.bind(n,19481))},"vector-tile":function(){return Promise.all([n.e(9892),n.e(30969),n.e(77416),n.e(75049)]).then(n.bind(n,15585))},wcs:function(){return Promise.all([n.e(80394),n.e(19481)]).then(n.bind(n,19481))},"web-tile":de,wfs:function(){return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(50739),n.e(68928),n.e(56717),n.e(18495),n.e(41170),n.e(27826),n.e(53952),n.e(2662)]).then(n.bind(n,2662))},wms:function(){return Promise.all([n.e(69229),n.e(75781)]).then(n.bind(n,69121))},wmts:function(){return n.e(15421).then(n.bind(n,15421))},"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};var ve,me,_e=function(e){return(0,k.pC)(pe[e.type])},ye=function(e){var t=pe[e.type];if((0,k.Wi)(t))throw function(e){var t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",n=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new b.Z("".concat(n,":view-not-supported"),"".concat(t," is not supported in 3D"))}(e);return t(e)},ge=n(14921),be=n(41691),we="analyses-owner-handles";!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(ve||(ve={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(me||(me={}));var Ce=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(e){var n;return(0,s.Z)(this,r),(n=t.call(this,e))._allAnalysisViews=new y.Z,n._creatingViewCount=0,n._items=new Map,n._scheduledUpdateHandle=null,n._attachedToViewResolver=xe(),n._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}},n}return(0,l.Z)(r,[{key:"destroy",value:function(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,R.zE)("AnalysisViewManager was destroyed"))}},{key:"attach",value:function(){this._connectOwners(),this._attachedToViewResolver.resolve()}},{key:"detach",value:function(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,R.zE)()),this._attachedToViewResolver=xe()}},{key:"updating",get:function(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((function(e){return e.updating}))}},{key:"testInfo",get:function(){return{allAnalysisViews:this._allAnalysisViews}}},{key:"whenAnalysisView",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._attachedToViewResolver.promise;case 2:if(n=this._items.get(t),!(0,k.Wi)(n)&&n.state.list!==me.REMOVED){e.next=5;break}throw new b.Z("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});case 5:return e.abrupt("return",n.createAnalysisViewTask.promise);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_connectOwners",value:function(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),we)}},{key:"_disconnectOwners",value:function(){this.handles.remove(we),this._update(),this._creatingViewCount=0}},{key:"_connectAnalysesCollection",value:function(e){var t,n=this,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;this._addAnalysis(a)}}catch(l){r.e(l)}finally{r.f()}var o=e.on("after-add",(function(e){return n._addAnalysis(e.item)})),s=e.on("after-remove",(function(e){return n._removeAnalysis(e.item)}));return{remove:function(){o.remove(),s.remove();var t,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;n._removeAnalysis(a)}}catch(l){r.e(l)}finally{r.f()}}}}},{key:"_addAnalysis",value:function(e){var t=this,n=this._items.get(e);if(null==n){var r={state:{view:ve.PENDING,list:me.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,r),r.createAnalysisViewTask=(0,ge.vr)((function(e){return t._createAnalysisViewPromise(r,e)}))}else n.state.list=me.ADDED}},{key:"_removeAnalysis",value:function(e){var t=this._items.get(e);null!=t?(t.state.list=me.REMOVED,this._scheduleUpdate()):S.Z.getLogger(this.declaredClass).error("Trying to remove analysis which was not added")}},{key:"_scheduleUpdate",value:function(){var e=this;(0,k.pC)(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=(0,E.Os)((function(){return e._update()})))}},{key:"_update",value:function(){var e=this;this._scheduledUpdateHandle=(0,k.hw)(this._scheduledUpdateHandle),this._items.forEach((function(t){if(t.state.list===me.REMOVED)switch(e._items.delete(t.analysis),t.state.view){case ve.PENDING:t.createAnalysisViewTask=(0,k.IM)(t.createAnalysisViewTask);break;case ve.CREATED:(0,k.pC)(t.view)&&(e._allAnalysisViews.remove(t.view),t.view=(0,k.SC)(t.view),t.createAnalysisViewTask=null)}}))}},{key:"_createAnalysisViewPromise",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,i,o,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.analysis,i=r.type,o=this._analysisModules[i],this._creatingViewCount+=1,!(0,k.Wi)(o.module)){e.next=11;break}return e.prev=2,e.next=5,this._loadAnalysisModule(i);case 5:o.module=e.sent,e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(2),this._creatingViewCount-=1,e.t0;case 11:if(!(0,R.Hc)(n)){e.next=13;break}throw this._creatingViewCount-=1,(0,R.zE)("AnalysisView creation aborted");case 13:return s=new o.module.default({analysis:r,view:this.view}),e.prev=14,e.next=17,s.when();case 17:e.next=22;break;case 19:throw e.prev=19,e.t1=e.catch(14),this._creatingViewCount-=1,e.t1;case 22:if(!(0,R.Hc)(n)){e.next=24;break}throw this._creatingViewCount-=1,s.destroy(),(0,R.zE)("AnalysisView creation aborted");case 24:return e.abrupt("return",(t.view=s,t.state.view=ve.CREATED,this._allAnalysisViews.add(s),this._creatingViewCount-=1,s));case 25:case"end":return e.stop()}}),e,this,[[2,8],[14,19]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadAnalysisModule",value:function(e){switch(e){case"area-measurement":return Promise.all([n.e(99058),n.e(1103),n.e(56690),n.e(50793),n.e(60719),n.e(32590)]).then(n.bind(n,2909));case"dimension":return Promise.all([n.e(48562),n.e(71486),n.e(98074),n.e(1103),n.e(90170),n.e(56690),n.e(83639),n.e(13762),n.e(32050),n.e(71004),n.e(38856),n.e(93507),n.e(16432)]).then(n.bind(n,16432));case"direct-line-measurement":return Promise.all([n.e(99058),n.e(56690),n.e(32050),n.e(50793),n.e(60719),n.e(8951)]).then(n.bind(n,88978));case"line-of-sight":return Promise.all([n.e(90170),n.e(56690),n.e(83639),n.e(13762),n.e(40957)]).then(n.bind(n,40957));case"slice":return Promise.all([n.e(44011),n.e(90170),n.e(56690),n.e(83639),n.e(59147),n.e(38978),n.e(86487)]).then(n.bind(n,94018))}}}]),r}(be.r);function xe(){var e=(0,R.hh)();return e.promise.catch((function(){})),e}(0,p._)([(0,Z.Cb)()],Ce.prototype,"updating",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ce.prototype,"view",void 0),(0,p._)([(0,Z.Cb)()],Ce.prototype,"_allAnalysisViews",void 0),(0,p._)([(0,Z.Cb)()],Ce.prototype,"_creatingViewCount",void 0);var Te=Ce=(0,p._)([(0,L.j)("esri.views.3d.analysis.AnalysisViewManager3D")],Ce),Se=n(16889),ke=n(22186),Pe=n(80064),Re=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).collision=new Me,r.distance=1/0,r.minimumPoiDistance=4,r.tilt=null,r}return(0,l.Z)(n,[{key:"altitude",get:function(){return this.mode===he.JY.Local?null:this._get("altitude")||null},set:function(e){this.mode!==he.JY.Local?this._set("altitude",e):S.Z.getLogger(this.declaredClass).warn("Altitude constraint is ignored in local scenes")}},{key:"clampAltitude",value:function(e){return this.altitude?(0,Se.uZ)(e,this.altitude.min,this.altitude.max):e}},{key:"clampTilt",value:function(e,t){if(!this.tilt)return t;var n=this.tilt(e);return(0,Se.uZ)(t,n.min,n.max)}},{key:"clampDistance",value:function(e){return Math.min(e,this.distance)}},{key:"createDefaultTilt",value:function(){return this.mode===he.JY.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}},{key:"createConstantMaxTilt",value:function(e){return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oe;return n.min=Ee.min,n.max=e,n}}},{key:"_createDefaultTiltLocal",value:function(){var e=this.collision.enabled?(0,Pe.uV)([[4e3,Ee.max],[1e4,(0,Se.Vl)(88)],[6e6,(0,Se.Vl)(88)]]):function(){return Ee.max};return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oe;return n.min=Ee.min,n.max=e(t),n}}},{key:"_createDefaultTiltGlobal",value:function(){var e=this.collision.enabled?(0,Pe.uV)([[4e3,Ee.max],[5e4,(0,Se.Vl)(88)],[6e6,(0,Se.Vl)(88)],[2e7,Ee.min]]):(0,Pe.uV)([[3e5,Ee.max],[3e6,(0,Se.Vl)(88)],[6e6,(0,Se.Vl)(88)],[2e7,Ee.min]]);return function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Oe;return n.min=Ee.min,n.max=e(t),n}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],Re.prototype,"altitude",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Re.prototype,"collision",void 0),(0,p._)([(0,Z.Cb)()],Re.prototype,"distance",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Re.prototype,"minimumPoiDistance",void 0),(0,p._)([(0,Z.Cb)()],Re.prototype,"tilt",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Re.prototype,"mode",void 0),Re=(0,p._)([(0,L.j)("esri.views.3d.state.Constraints")],Re);var Ae=function(e){return{min:-2e5,max:4*e.radius}}(ke.sv),Ee={min:(0,Se.Vl)(.5),max:(0,Se.Vl)(179.5)},Oe={min:0,max:0},Me=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).enabled=!0,e.elevationMargin=5,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)({type:Boolean})],Me.prototype,"enabled",void 0),(0,p._)([(0,Z.Cb)({type:Number})],Me.prototype,"elevationMargin",void 0),Me=(0,p._)([(0,L.j)("esri.views.3d.state.Constraints.CollisionConstraint")],Me);var Ze=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).min=Ae.min,e.max=Ae.max,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)({type:Number})],Ze.prototype,"min",void 0),(0,p._)([(0,Z.Cb)({type:Number})],Ze.prototype,"max",void 0),Ze=(0,p._)([(0,L.j)("esri.views.3d.constraints.AltitudeConstraint")],Ze);var Ie=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).mode="auto",e}return(0,l.Z)(n,[{key:"near",get:function(){return this._get("near")},set:function(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}},{key:"castNear",value:function(e){return Math.max(1e-8,e)}},{key:"far",get:function(){return this._get("far")},set:function(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}},{key:"castFar",value:function(e){return Math.max(1e-8,e)}},{key:"autoUpdate",value:function(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({type:Number,value:1e-8})],Ie.prototype,"near",null),(0,p._)([(0,I.p)("near")],Ie.prototype,"castNear",null),(0,p._)([(0,Z.Cb)({type:Number,value:1e-8})],Ie.prototype,"far",null),(0,p._)([(0,I.p)("far")],Ie.prototype,"castFar",null),(0,p._)([(0,Z.Cb)({type:["auto","manual"]})],Ie.prototype,"mode",void 0),Ie=(0,p._)([(0,L.j)("esri.views.3d.constraints.ClipDistanceConstraint")],Ie);var De={min:(0,Se.BV)(Ee.min),max:(0,Se.BV)(Ee.max)},Le=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).mode="auto",e}return(0,l.Z)(n,[{key:"max",get:function(){return this._get("max")},set:function(e){this._set("max",e),this.mode="manual"}},{key:"castMax",value:function(e){return(0,Se.uZ)(e,De.min,De.max)}},{key:"autoUpdate",value:function(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({type:["auto","manual"]})],Le.prototype,"mode",void 0),(0,p._)([(0,Z.Cb)({type:Number,value:De.max})],Le.prototype,"max",null),(0,p._)([(0,I.p)("max")],Le.prototype,"castMax",null),Le=(0,p._)([(0,L.j)("esri.views.3d.constraints.TiltConstraint")],Le);var Ne=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).tilt=new Le,e.altitude=new Ze,e.clipDistance=new Ie,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)({type:Le})],Ne.prototype,"tilt",void 0),(0,p._)([(0,Z.Cb)({type:Ze})],Ne.prototype,"altitude",void 0),(0,p._)([(0,Z.Cb)({type:Ie})],Ne.prototype,"clipDistance",void 0),Ne=(0,p._)([(0,L.j)("esri.views.3d.constraints.Constraints")],Ne);var Fe,Ue=n(41644),Ve=n(84652),He=n(46784),ze=n(38511),Be=n(31201),Ge=Fe=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="sun",r.date=null,r.directShadowsEnabled=!1,r.displayUTCOffset=null,r}return(0,l.Z)(n,[{key:"readDate",value:function(e,t){return null!=t.datetime&&new Date(t.datetime)||null}},{key:"writeDate",value:function(e,t,n){t[n]=e.getTime()}},{key:"readDirectShadowsEnabled",value:function(e,t){return!!t.directShadows}},{key:"writedirectShadowsEnabled",value:function(e,t,n){e&&(t[n]=e)}},{key:"writeDisplayUTCOffset",value:function(e,t){null!=e&&(t.displayUTCOffset=e)}},{key:"clone",value:function(){return new Fe(this.cloneConstructProperties())}},{key:"cloneConstructProperties",value:function(){var e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}}]),n}(He.wq);(0,p._)([(0,Z.Cb)({readOnly:!0,type:["sun"],json:{write:!0}})],Ge.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:Date,json:{type:Number,write:{target:"datetime"}}})],Ge.prototype,"date",void 0),(0,p._)([(0,ze.r)("date",["datetime"])],Ge.prototype,"readDate",null),(0,p._)([(0,Be.c)("date")],Ge.prototype,"writeDate",null),(0,p._)([(0,Z.Cb)({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],Ge.prototype,"directShadowsEnabled",void 0),(0,p._)([(0,ze.r)("directShadowsEnabled",["directShadows"])],Ge.prototype,"readDirectShadowsEnabled",null),(0,p._)([(0,Be.c)("directShadowsEnabled")],Ge.prototype,"writedirectShadowsEnabled",null),(0,p._)([(0,Z.Cb)({type:Number,json:{write:!0}})],Ge.prototype,"displayUTCOffset",void 0),(0,p._)([(0,Be.c)("displayUTCOffset")],Ge.prototype,"writeDisplayUTCOffset",null);var We,je=Ge=Fe=(0,p._)([(0,L.j)("esri.webscene.SunLighting")],Ge),qe=We=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;(0,s.Z)(this,n),(r=t.call(this,e)).cameraTrackingEnabled=!0,r.ambientOcclusionEnabled=!1,r.waterReflectionEnabled=!1,r.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};var i=(new Date).getFullYear(),a=new Date("March 15, "+i+" 12:00:00 UTC");return r._set("defaultDate",a),r._set("date",a),r}return(0,l.Z)(n,[{key:"defaultDate",get:function(){return new Date(this._get("defaultDate").getTime())},set:function(e){var t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}},{key:"date",set:function(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}},{key:"autoUpdate",value:function(e,t){var n=We.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;var r=null;(0,k.pC)(e)&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));var i=We.calculateTimezoneOffset(this.positionTimezoneInfo);if(n!==i&&(Xe.target=this,Xe.timezoneOffset=i,this.emit("timezone-will-change",Xe)),(0,k.pC)(e))return!!isNaN(e.getTime())||r!==e.getTime()}},{key:"clone",value:function(){var e=this._get("date")===this._get("defaultDate"),t=new We((0,r.Z)((0,r.Z)({},this.cloneConstructProperties()),{},{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}));return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}},{key:"cloneWithWebsceneLighting",value:function(e){var t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}},{key:"cloneNonPersistentConstructProperties",value:function(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}}],[{key:"fromWebsceneLighting",value:function(e){return new We(e.cloneConstructProperties())}}]),n}($.Z.EventedMixin(je));(0,p._)([(0,Z.Cb)({type:Boolean})],qe.prototype,"cameraTrackingEnabled",void 0),(0,p._)([(0,Z.Cb)({type:Boolean})],qe.prototype,"ambientOcclusionEnabled",void 0),(0,p._)([(0,Z.Cb)({type:Boolean})],qe.prototype,"waterReflectionEnabled",void 0),(0,p._)([(0,Z.Cb)({type:Date})],qe.prototype,"defaultDate",null),(0,p._)([(0,Z.Cb)({type:Date})],qe.prototype,"date",null),function(e){e.calculateTimezoneOffset=function(e){var t=e.hours,n=e.minutes,r=e.seconds;return Math.round(t+n/60+r/3600)}}((qe=We=(0,p._)([(0,L.j)("esri.views.3d.environment.SunLighting")],qe))||(qe={}));var Ye,Xe={target:null,timezoneOffset:0},Qe=qe,Je=Ye=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="virtual",r.directShadowsEnabled=!1,r}return(0,l.Z)(n,[{key:"clone",value:function(){return new Ye(this.cloneConstructProperties())}},{key:"cloneConstructProperties",value:function(){return{directShadowsEnabled:this.directShadowsEnabled}}}]),n}(He.wq);(0,p._)([(0,Z.Cb)({readOnly:!0,type:["virtual"],json:{write:!0}})],Je.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],Je.prototype,"directShadowsEnabled",void 0);var Ke,$e=Je=Ye=(0,p._)([(0,L.j)("esri.webscene.VirtualLighting")],Je),et=Ke=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).ambientOcclusionEnabled=!1,r.waterReflectionEnabled=!1,r.cameraTrackingEnabled=!0,r}return(0,l.Z)(n,[{key:"clone",value:function(){return new Ke((0,r.Z)((0,r.Z)({},this.cloneConstructProperties()),{},{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}))}},{key:"cloneWithWebsceneLighting",value:function(e){var t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}},{key:"cloneNonPersistentConstructProperties",value:function(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}}],[{key:"fromWebsceneLighting",value:function(e){return new Ke(e.cloneConstructProperties())}}]),n}($.Z.EventedMixin($e));(0,p._)([(0,Z.Cb)({type:Boolean})],et.prototype,"ambientOcclusionEnabled",void 0),(0,p._)([(0,Z.Cb)({type:Boolean})],et.prototype,"waterReflectionEnabled",void 0),(0,p._)([(0,Z.Cb)({type:Boolean})],et.prototype,"cameraTrackingEnabled",void 0);var tt,nt=et=Ke=(0,p._)([(0,L.j)("esri.views.3d.environment.VirtualLighting")],et),rt={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Qe,virtual:nt}},it=tt=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"quality",set:function(e){["low","high"].includes(e)&&this._set("quality",e)}},{key:"clone",value:function(){return new tt({quality:this.quality})}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({type:["low","high"],value:"low"})],it.prototype,"quality",null),it=tt=(0,p._)([(0,L.j)("esri.views.3d.environment.SceneViewAtmosphere")],it);var at,ot=n(27135),st=at=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="sunny",r.cloudCover=.5,r}return(0,l.Z)(n,[{key:"clone",value:function(){return new at({cloudCover:this.cloudCover})}}]),n}(He.wq);(0,p._)([(0,ot.J)({sunny:"sunny"})],st.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],st.prototype,"cloudCover",void 0);var lt,ut=st=at=(0,p._)([(0,L.j)("esri.views.3d.environment.SunnyWeather")],st),ct=lt=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="cloudy",r.cloudCover=.5,r}return(0,l.Z)(n,[{key:"clone",value:function(){return new lt({cloudCover:this.cloudCover})}}]),n}(He.wq);(0,p._)([(0,ot.J)({cloudy:"cloudy"})],ct.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ct.prototype,"cloudCover",void 0);var ht,dt=ct=lt=(0,p._)([(0,L.j)("esri.views.3d.environment.CloudyWeather")],ct),ft=ht=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="foggy",r.fogStrength=.5,r}return(0,l.Z)(n,[{key:"clone",value:function(){return new ht({fogStrength:this.fogStrength})}}]),n}(He.wq);(0,p._)([(0,ot.J)({foggy:"foggy"})],ft.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ft.prototype,"fogStrength",void 0);var pt,vt=ft=ht=(0,p._)([(0,L.j)("esri.views.3d.environment.FoggyWeather")],ft),mt=pt=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="rainy",r.cloudCover=.5,r.precipitation=.5,r}return(0,l.Z)(n,[{key:"clone",value:function(){return new pt({cloudCover:this.cloudCover,precipitation:this.precipitation})}}]),n}(He.wq);(0,p._)([(0,ot.J)({rainy:"rainy"})],mt.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],mt.prototype,"cloudCover",void 0),(0,p._)([(0,Z.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],mt.prototype,"precipitation",void 0);var _t,yt=mt=pt=(0,p._)([(0,L.j)("esri.views.3d.environment.RainyWeather")],mt),gt=_t=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="snowy",r.cloudCover=.5,r.precipitation=.5,r.snowCover="disabled",r}return(0,l.Z)(n,[{key:"clone",value:function(){return new _t({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}}]),n}(He.wq);(0,p._)([(0,ot.J)({snowy:"snowy"})],gt.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],gt.prototype,"cloudCover",void 0),(0,p._)([(0,Z.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],gt.prototype,"precipitation",void 0),(0,p._)([(0,Z.Cb)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],gt.prototype,"snowCover",void 0);var bt={key:"type",base:ut,typeMap:{sunny:ut,cloudy:dt,rainy:yt,snowy:gt=_t=(0,p._)([(0,L.j)("esri.views.3d.environment.SnowyWeather")],gt),foggy:vt}},wt=Object.keys(bt.typeMap);var Ct=1e4,xt={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:je,virtual:$e}},Tt=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){return(0,s.Z)(this,n),t.call(this,e)}return(0,l.Z)(n,[{key:"clone",value:function(){}}]),n}(He.wq);(0,p._)([(0,Z.Cb)({readOnly:!0,json:{read:!1}})],Tt.prototype,"type",void 0);var St,kt=Tt=(0,p._)([(0,L.j)("esri.webscene.background.Background")],Tt),Pt=n(51995),Rt=n(70271),At=(0,r.Z)((0,r.Z)({},Rt.a),{},{nonNullable:!0}),Et=St=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type="color",r.color=new Pt.Z([0,0,0,1]),r}return(0,l.Z)(n,[{key:"clone",value:function(){return new St(this.cloneProperties())}},{key:"cloneProperties",value:function(){return{color:this.color.clone()}}}]),n}(kt);(0,p._)([(0,ot.J)({color:"color"},{readOnly:!0})],Et.prototype,"type",void 0),(0,p._)([(0,Z.Cb)(At)],Et.prototype,"color",void 0);var Ot=Et=St=(0,p._)([(0,L.j)("esri.webscene.background.ColorBackground")],Et),Mt={base:kt,key:"type",typeMap:{color:Ot}};var Zt,It={types:Mt,json:{read:function(e){return function(t,n,r){if(!t)return t;for(var i in e.typeMap)if(t.type===i){var a=new e.typeMap[i];return a.read(t,r),a}}}(Mt),write:{overridePolicy:function(e,t,n){return{enabled:!n||!n.isPresentation}}}}},Dt="esri.webscene.Environment",Lt=S.Z.getLogger(Dt),Nt=function(e,t,n){return{enabled:!n||!n.isPresentation}},Ft=Zt=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).lighting=new je,r.background=null,r.atmosphereEnabled=!0,r.starsEnabled=!0,r}return(0,l.Z)(n,[{key:"weather",set:function(e){(function(e,t){return!!wt.includes(e)||(t.error('"'.concat(e,'" is not a valid weather type')),!1)})(null===e||void 0===e?void 0:e.type,Lt)&&this._set("weather",e)}},{key:"clone",value:function(){return new Zt(this.cloneConstructProperties())}},{key:"cloneConstructProperties",value:function(){return{lighting:this.lighting&&"virtual"===this.lighting.type?$e.prototype.clone.call(this.lighting):je.prototype.clone.call(this.lighting),background:(0,Ve.d9)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}}]),n}(He.wq);(0,p._)([(0,Z.Cb)({types:xt,nonNullable:!0,json:{write:!0}})],Ft.prototype,"lighting",void 0),(0,p._)([(0,Z.Cb)(It)],Ft.prototype,"background",void 0),(0,p._)([(0,Z.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Nt}}})],Ft.prototype,"atmosphereEnabled",void 0),(0,p._)([(0,Z.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Nt}}})],Ft.prototype,"starsEnabled",void 0),(0,p._)([(0,Z.Cb)({types:bt,nonNullable:!0,json:{write:!0},value:new ut})],Ft.prototype,"weather",null);var Ut,Vt=Ft=Zt=(0,p._)([(0,L.j)(Dt)],Ft),Ht=Ut=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).atmosphere=new it,r.lighting=new Qe,r.cachedCameraTrackingEnabled=null,r}return(0,l.Z)(n,[{key:"castLighting",value:function(e){return this._convertLighting(e)}},{key:"applyLighting",value:function(e){this.lighting=this._convertLighting(e)}},{key:"_convertLighting",value:function(e){var t,n;return e?e instanceof Qe||e instanceof nt?e:e instanceof je?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Qe((0,r.Z)((0,r.Z)({},e.cloneConstructProperties()),null===(t=this.lighting)||void 0===t?void 0:t.cloneNonPersistentConstructProperties())):e instanceof $e?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new nt((0,r.Z)((0,r.Z)({},e.cloneConstructProperties()),null===(n=this.lighting)||void 0===n?void 0:n.cloneNonPersistentConstructProperties())):(0,N.N7)(rt,e):new Qe}},{key:"clone",value:function(){return new Ut({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ve.d9)(this.background)})}},{key:"cloneWithWebsceneEnvironment",value:function(e){return new Ut((0,r.Z)((0,r.Z)({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ve.d9)(this.background)},e.cloneConstructProperties()),{},{lighting:this._getLighting(e)}))}},{key:"_getLighting",value:function(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Qe.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):nt.fromWebsceneLighting(e.lighting);default:return(0,Ue.Bg)(e.lighting),Qe.fromWebsceneLighting(e.lighting)}}}],[{key:"fromWebsceneEnvironment",value:function(e){var t=e.cloneConstructProperties();return new Ut((0,r.Z)((0,r.Z)({},t),{},{lighting:t.lighting?"virtual"===t.lighting.type?nt.fromWebsceneLighting(t.lighting):Qe.fromWebsceneLighting(t.lighting):void 0}))}}]),n}(Vt);(0,p._)([(0,Z.Cb)({type:it,json:{read:!1},nonNullable:!0})],Ht.prototype,"atmosphere",void 0),(0,p._)([(0,Z.Cb)({nonNullable:!0})],Ht.prototype,"lighting",void 0),(0,p._)([(0,I.p)("lighting")],Ht.prototype,"castLighting",null);var zt,Bt=Ht=Ut=(0,p._)([(0,L.j)("esri.views.3d.environment.SceneViewEnvironment")],Ht),Gt=n(11186),Wt=n(67077),jt=n(92975),qt=n(83448);!function(e){e[e.Simple=0]="Simple",e[e.Realistic=1]="Realistic",e[e.Panoramic=2]="Panoramic",e[e.None=3]="None"}(zt||(zt={}));var Yt=n(88396),Xt=n(90045),Qt=n(5461),Jt=n(6394),Kt=n(39073),$t=n(98634),en=n(82144),tn=n(31132),nn=n(7566),rn=n(27627),an=n(8548),on=n(36207),sn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).heightParameters=(0,Wt.c)(),e.radii=(0,Jt.a)(),e.innerFadeDistance=0,e.altitudeFade=0,e.hazeStrength=1,e}return(0,l.Z)(n)}($t.K),ln=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return this.configuration.haze?(0,on.sm)({blending:(0,on.wK)(an.zi.ONE,an.zi.ZERO,an.zi.ONE_MINUS_SRC_COLOR,an.zi.ONE),colorWrite:on.BK}):(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK})}}]),n}(tn.A);ln.shader=new en.J(Kt.C,(function(){return n.e(40608).then(n.bind(n,40608))}));var un=n(33559),cn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).haze=!1,e}return(0,l.Z)(n)}(un.m);(0,p._)([(0,un.o)()],cn.prototype,"haze",void 0);var hn=n(53641),dn=n(20684),fn=function(){function e(t,n){var r=this;(0,s.Z)(this,e),this._view=t,this.type=zt.Realistic,this._handles=new K.Z,this._passParameters=new sn,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=ke.sv.radius,this._fadeHaze=0,this._updateRadius(ke.sv.radius);var i=n.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([(0,A.YP)((function(){return r._view.basemapTerrain.rootTileElevationBounds}),(function(){return r._updateRootTileElevationBounds()})),(0,A.YP)((function(){return r._view.basemapTerrain.visibleElevationBounds}),(function(){return r._updateVisibleElevationBounds()}))]);var a=new cn;a.haze=!1,this._atmosphereTechnique=n.techniqueRepository.acquire(ln,a),a.haze=!0,this._atmosphereHazeTechnique=n.techniqueRepository.acquire(ln,a),this._vao=(0,dn.ow)(i,hn.Bn)}return(0,l.Z)(e,[{key:"destroy",value:function(){this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._vao.dispose(),this._handles.destroy()}},{key:"render",value:function(e){this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}},{key:"renderHaze",value:function(e,t){this._fadeHaze=t,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}},{key:"_render",value:function(e,t,n){var r=this;if(!(0,k.Wi)(n)){this._update(e.bindParameters.camera),this._passParameters.depthTex=n;var i=e.rctx.bindTechnique(t,this._passParameters,e.bindParameters);e.offscreenRenderingHelper.renderDepthDetached((function(){return r._renderCommon(i,e)}))}}},{key:"_renderCommon",value:function(e,t){(0,k.Wi)(this._vao)||(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(an.MX.TRIANGLE_STRIP,0,4))}},{key:"_adjustRadiusForTesselation",value:function(e){return e*Math.cos(Math.PI/16/16)}},{key:"_updateRootTileElevationBounds",value:function(){var e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=ke.sv.radius,this._updateVisibleElevationBounds())}},{key:"_updateVisibleElevationBounds",value:function(){var e=this._adjustRadiusForTesselation(ke.sv.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}},{key:"_updateRadius",value:function(e){this._lowerBoundEarthRadius=e,(0,Yt.s)(this._passParameters.radii,e,e+Qt.k8),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-Qt.Tk)*Qt.Tk)}},{key:"_update",value:function(e){if(!(0,k.Wi)(e)){var t=(0,Gt.p)(e.eye),n=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],i=(0,Se.uZ)((n-this._passParameters.radii[0])/Qt.k8,0,1);(0,Xt.s)(this._passParameters.heightParameters,n,t,r,i),this._passParameters.altitudeFade=(0,Qt.yx)(n-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=(0,Se.t7)((0,Se.t7)(.6,1,(0,Se.CW)(9500,10500,n-ke.sv.radius)),1,this._fadeHaze)}}}],[{key:"isSupported",value:function(e){return e.renderContext.rctx.capabilities.depthTexture}}]),e}(),pn=n(4685),vn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),r=t.call(this,e,new un.m,(function(){return r.destroy()}))}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.ONE,an.zi.ZERO,an.zi.SRC_ALPHA,an.zi.ONE),depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK})}}]),n}(tn.A);vn.shader=new en.J(pn.C,(function(){return n.e(43359).then(n.bind(n,43359))}));var mn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._technique=new vn(e),r._vao=(0,dn.ow)(e.rctx),r}return(0,l.Z)(n,[{key:"destroy",value:function(){this._technique=(0,k.RY)(this._technique),this._vao=(0,k.M2)(this._vao)}},{key:"render",value:function(e){var t=e.bindParameters.cloudsFade;if(!(0,k.Wi)(this._vao)&&!(0,k.Wi)(t.data))if(this._technique.compiled){var n=e.rctx.bindTechnique(this._technique,_n,e.bindParameters);e.rctx.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(an.MX.TRIANGLE_STRIP,0,4)}else this.requestRender()}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],mn.prototype,"rctx",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],mn.prototype,"viewingMode",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],mn.prototype,"planetRadius",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],mn.prototype,"requestRender",void 0),mn=(0,p._)([(0,L.j)("esri.views.3d.environment.CloudsComposition")],mn);var _n=new $t.K,yn=n(91226),gn=n(46208),bn=n(22753),wn=n(14226),Cn=n(81949),xn=n(8229),Tn=n(50703),Sn=n(12658),kn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),i=t.call(this,e,r,(function(){return i.destroy()}))}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.if)(an.zi.CONSTANT_COLOR,an.zi.ONE_MINUS_CONSTANT_COLOR,an.db.ADD,this.configuration.writeTextureChannels===gn.uz.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK})}}]),n}(tn.A);kn.shader=new en.J(Tn.b,(function(){return n.e(78383).then(n.bind(n,78383))}));var Pn=n(20460),Rn=n(50214),An=n(84819),En=n(68820),On=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:this.configuration.mode===An.u.Full?(0,on.if)(an.zi.ONE,an.zi.ZERO):(0,on.wK)(an.zi.ZERO,an.zi.ONE,an.zi.ONE,an.zi.ZERO),depthTest:{func:an.wb.ALWAYS},colorWrite:on.BK})}}]),n}(tn.A);On.shader=new en.J(Rn.a,(function(){return n.e(52659).then(n.bind(n,52659))}));var Mn=n(53634),Zn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._needsRender=!0,r._passParameters=new Rn.N,r._frameBuffer=new Mn.X(e.context.renderContext.rctx,{colorTarget:an.Lm.TEXTURE,width:En.IQ,height:En.IQ},{target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:an.cw.LINEAR,hasMipmap:!1,width:En.IQ,height:En.IQ}),r._vao=(0,dn.ow)(e.context.renderContext.rctx),r}return(0,l.Z)(n,[{key:"_techniqueRepository",get:function(){return this.context.techniqueRepository}},{key:"textureAtlas",get:function(){return(0,k.pC)(this._texture)?(0,k.pC)(this._weatherMapTechnique)&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(An.u.WeatherMap)):(0,k.pC)(this._fullTechnique)&&this._fullTechnique.compiled&&(this._texture=this._render(An.u.Full)),this._texture}},{key:"_setDirty",value:function(){this._needsRender=!0}},{key:"updateWeatherMap",value:function(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||((0,Yt.c)(this._passParameters.weatherTile,e),this._setDirty())}},{key:"destroy",value:function(){this._fullTechniqueCached=(0,k.RY)(this._fullTechniqueCached),this._weatherMapTechniqueCached=(0,k.RY)(this._weatherMapTechniqueCached),this._frameBuffer=(0,k.M2)(this._frameBuffer),this._vao=(0,k.M2)(this._vao)}},{key:"_fullTechnique",get:function(){if((0,k.Wi)(this._fullTechniqueCached)){var e=new An.i;e.mode=An.u.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(On,e)}return this._fullTechniqueCached}},{key:"_weatherMapTechnique",get:function(){if((0,k.Wi)(this._weatherMapTechniqueCached)){var e=new An.i;e.mode=An.u.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(On,e)}return this._weatherMapTechniqueCached}},{key:"_render",value:function(e){if((0,k.Wi)(this._vao)||(0,k.Wi)(this._frameBuffer))return null;var t=e===An.u.Full?this._fullTechnique:this._weatherMapTechnique,n=this.context.renderContext.rctx,r=n.getViewport();n.setViewport(0,0,En.IQ,En.IQ),n.bindFramebuffer(this._frameBuffer);var i=n.bindTechnique(t,this._passParameters,null);return n.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),n.gl.drawArrays(n.gl.TRIANGLE_STRIP,0,4),n.setViewport(r.x,r.y,r.width,r.height),this._needsRender=!1,this._frameBuffer.colorTexture}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Zn.prototype,"context",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Zn.prototype,"_techniqueRepository",null),Zn=(0,p._)([(0,L.j)("esri.views.3d.environment.NoiseTextureAtlas")],Zn);var In=n(83377),Dn=n(93463),Ln=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r._techniques=new Array,r._techniqueConfiguration=new Pn.t,r._bindParameters=new In.p(null,null,null),r._passParameters=new Tn.C,r._drawParameters=new Tn.a,r._weatherTile=(0,Jt.a)(),r._weatherTileCount=128,r._faceIndex=0,r._tileIndex=0,r.coverage=(0,Se.t7)(Sn.L.default.coverage[0],Sn.L.default.coverage[1],.5),r.density=(0,Se.t7)(Sn.L.default.density[0],Sn.L.default.density[1],.5),r.absorption=(0,Se.t7)(Sn.L.default.absorption[0],Sn.L.default.absorption[1],.5),r.cloudSize=(0,Se.t7)(Sn.L.default.cloudSize[0],Sn.L.default.cloudSize[1],.5),r.detailSize=(0,Se.t7)(Sn.L.default.detailSize[0],Sn.L.default.detailSize[1],.5),r.smoothness=(0,Se.t7)(Sn.L.default.smoothness[0],Sn.L.default.smoothness[1],.5),r.cloudHeight=(0,Se.t7)(Sn.L.default.cloudHeight[0],Sn.L.default.cloudHeight[1],.5),r.raymarchingSteps=Sn.L.default.raymarchingSteps,r._viewMatrix=(0,Cn.c)(),r._dirty=!1,r.running=!1,r}return(0,l.Z)(n,[{key:"_getTechnique",value:function(e){var t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,n=t===gn.uz.RG?2*e:2*e+1;return this._techniques[n]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[n]=new kn({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[n])}},{key:"updateWeatherTile",value:function(){var e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(null!=e&&null!=t){(0,Yt.s)(this._weatherTile,(e+90)/180,(t+180)/360);var n=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-n)*this._weatherTile[1]);var r=0,i=0;if((0,k.pC)(this.view.environment)&&"virtual"!==this.view.environment.lighting.type&&(0,k.pC)(this.view.environment.lighting.date)){var a,o=new Date(this.view.environment.lighting.date);o.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(null!==(a=this.view.environment.lighting.displayUTCOffset)&&void 0!==a?a:0)),r=31*o.getUTCMonth()+o.getUTCDate(),i=o.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+r)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+i%100)%(4*this._weatherTileCount),(0,Yt.o)(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}}},{key:"initialize",value:function(){var e=this;this._vao=(0,dn.ow)(this.context.renderContext.rctx);var t=(0,qt.Iu)(this.view.spatialReference);this._passParameters.cloudRadius=.5*t.radius,this.setDirty(),this.updateWeatherTile(),this._handles.add([this.view.resourceController.scheduler.registerTask(Dn.T8.CLOUDS_GENERATOR,this),(0,A.YP)((function(){return[e.coverage,e.density,e.absorption,e.cloudSize,e.detailSize,e.smoothness,e.cloudHeight,e.raymarchingSteps]}),(function(){return e.setDirty()}),A.nn)])}},{key:"destroy",value:function(){this._handles.destroy(),this._techniques.forEach((function(e){return(0,k.RY)(e)})),this._frameBufferCube=(0,k.M2)(this._frameBufferCube),this._techniques.length=0,this._vao=(0,k.M2)(this._vao),this._passParameters.noiseTexture=(0,k.SC)(this._passParameters.noiseTexture)}},{key:"_tilesPerFace",get:function(){switch(this._techniqueConfiguration.steps){case Pn.p.SIXTEEN:return 1;case Pn.p.HUNDRED:return 4;case Pn.p.COUNT:case Pn.p.TWOHUNDRED:return 8}}},{key:"_ensureNoiseTexture",value:function(){if((0,k.pC)(this._passParameters.noiseTexture))this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{var e=this.context;this._passParameters.noiseTexture=new Zn({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return(0,k.pC)(this._passParameters.noiseTexture.textureAtlas)}},{key:"_ensureFrameBufferCube",value:function(e){if((0,k.Wi)(this._frameBufferCube)){var t={target:an.No.TEXTURE_CUBE_MAP,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:an.cw.LINEAR,hasMipmap:!1,width:e,height:e};this._frameBufferCube=new Mn.X(this.context.renderContext.rctx,{colorTarget:an.Lm.CUBEMAP,width:e,height:e},t)}return this._frameBufferCube}},{key:"cubeMap",get:function(){return this._frameBufferCube}},{key:"destroyFrameBufferCube",value:function(){this._frameBufferCube=(0,k.M2)(this._frameBufferCube)}},{key:"applyPreset",value:function(e,t){var n=e.median,r=function(e){var r=(0,Se.t7)(e[0],e[1],n);return t<.5?(0,Se.t7)(e[0],r,2*t):(0,Se.t7)(r,e[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}},{key:"setDirty",value:function(){this._dirty=this.running=!0}},{key:"runTask",value:function(e){if((0,k.Wi)(this._vao))return this._dirty=this.running=!1,this.context.renderContext.bindParameters.cloudsFade.renderingStage=gn.jL.FINISHED_RENDERING,void e.madeProgress();0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),(0,Yt.c)(this._passParameters.weatherTile,this._weatherTile));var t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return Dn.iQ.YIELD;if(!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return Dn.iQ.YIELD;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=gn.jL.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);var n=this.context.renderContext.rctx,r=n.bindTechnique(t,this._passParameters,this._bindParameters);n.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao);var i=n.getViewport(),a=t.configuration.cubeMapSize,o=a/this._tilesPerFace,s=this._tileIndex*o;n.setViewport(0,s,a,o);var l=this._ensureFrameBufferCube(a);n.bindFramebuffer(l);var u=Nn[this._faceIndex],c=Fn[this._faceIndex];(0,wn.v)(this._viewMatrix,Un,u,c),(0,bn.f)(this._drawParameters.viewMatrix,this._viewMatrix);var h=an.No.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return l.setColorTextureTarget(h),r.bindDraw(this._drawParameters,this._bindParameters,this._passParameters),n.gl.drawArrays(n.gl.TRIANGLE_STRIP,0,4),n.gl.flush(),n.setViewport(i.x,i.y,i.width,i.height),this.requestRender(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=gn.jL.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Dn.iQ.YIELD}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ln.prototype,"context",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ln.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ln.prototype,"requestRender",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"coverage",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"density",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"absorption",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"cloudSize",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"detailSize",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"smoothness",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"cloudHeight",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"raymarchingSteps",void 0),(0,p._)([(0,Z.Cb)()],Ln.prototype,"running",void 0),Ln=(0,p._)([(0,L.j)("esri.views.3d.environment.CloudsGenerator")],Ln);var Nn=[(0,xn.f)(1,0,0),(0,xn.f)(-1,0,0),(0,xn.f)(0,1,0),(0,xn.f)(0,-1,0),(0,xn.f)(0,0,1)],Fn=[(0,xn.f)(0,1,0),(0,xn.f)(0,1,0),(0,xn.f)(0,0,-1),(0,xn.f)(0,0,1),(0,xn.f)(0,1,0)],Un=(0,xn.z)(),Vn=n(1674),Hn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return this.configuration.haze?(0,on.sm)({blending:(0,on.wK)(an.zi.ONE,an.zi.ZERO,an.zi.ONE_MINUS_SRC_COLOR,an.zi.ONE),colorWrite:on.BK}):(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ZERO,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE),colorWrite:on.BK})}}]),n}(tn.A);Hn.shader=new en.J(Vn.H,(function(){return n.e(93625).then(n.bind(n,93625))}));var zn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).haze=!1,e}return(0,l.Z)(n)}(un.m);(0,p._)([(0,un.o)()],zn.prototype,"haze",void 0);var Bn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;(0,s.Z)(this,n),(r=t.call(this,e))._passParameters=new Vn.F;var i=e.context.renderContext.rctx;r._vao=(0,dn.ow)(i,hn.Bn),r._technique=e.context.techniqueRepository.acquire(Hn,new zn);var a=(0,qt.Iu)(e.view.spatialReference);return r._planetRadius=a.radius,r._atmosphereRadius=a.radius+Qt.k8,r}return(0,l.Z)(n,[{key:"destroy",value:function(){this._technique.release(),this._vao.dispose()}},{key:"strength",get:function(){return this._passParameters.fogStrength},set:function(e){this._passParameters.fogStrength=e}},{key:"render",value:function(e,t){var n=this;if(this._update(e,t),!(this._passParameters.fogAmount<=0)){var r=this._technique;if(r.compiled){var i=e.offscreenRenderingHelper;i.renderDepthDetached((function(){n._passParameters.depthTexture=i.depthTexture;var t=e.rctx.bindTechnique(r,n._passParameters,e.bindParameters);n._renderFog(t,e)}))}else this.context.requestRender()}}},{key:"_renderFog",value:function(e,t){var n=t.rctx;n.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays(an.MX.TRIANGLE_STRIP,0,4)}},{key:"_update",value:function(e,t){var n=e.bindParameters.camera;(0,Gt.n)(Wn,n.eye);var r=Math.max(0,(0,Gt.e)(Wn,e.bindParameters.lighting.mainLight.direction)),i=t.color;(0,Gt.g)(jn,i,.1),(0,Gt.h)(this._passParameters.fogColor,jn,i,r);var a=(0,Gt.l)(n.eye),o=a*a;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-(0,Se.CW)(9500,1e4,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}}],[{key:"isSupported",value:function(e){return e.capabilities.depthTexture}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Bn.prototype,"context",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Bn.prototype,"view",void 0),Bn=(0,p._)([(0,L.j)("esri.views.3d.environment.Fog")],Bn);var Gn=(0,l.Z)((function e(){(0,s.Z)(this,e),this.color=(0,F.c)(),this.strength=0,this.amount=0})),Wn=(0,F.c)(),jn=(0,F.c)(),qn=n(92014),Yn=n(69362),Xn=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return this.configuration.geometry===Yn.n.Cylinder?(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),culling:on.Rd,depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK}):(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK})}}]),n}(tn.A);Xn.shader=new en.J(qn.a,(function(){return n.e(35701).then(n.bind(n,35701))}));var Qn=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]),Jn=n(50256),Kn=n(55158),$n=n(70619),er=n(80658),tr=n(4760),nr=n(44070),rr=n(371),ir=n(3384),ar=function(){function e(t,n){(0,s.Z)(this,e),this.type=zt.Panoramic,this._configuration=new Yn.f,this._passParameters=new qn.S,this._configuration.geometry=Yn.n.Cylinder,this._technique=n.techniqueRepository.acquire(Xn,this._configuration);var r=n.renderContext.rctx;this._vao=this._createVertexArrayObject(r),this._vaoCount=(0,ir._V)(this._vao,"geometry"),this._passParameters.texture=new rr.x(r,{pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:an.cw.LINEAR,flipped:!0,width:1,height:512},Qn)}return(0,l.Z)(e,[{key:"destroy",value:function(){this._passParameters.texture=(0,k.M2)(this._passParameters.texture),this._vao.dispose(),this._technique.release()}},{key:"render",value:function(e){var t=e.rctx,n=t.bindTechnique(this._technique,this._passParameters,e.bindParameters);(function(e,t){(0,wn.c)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1})(or,e.bindParameters.camera.viewMatrix),n.setUniformMatrix4fv("view",or),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(an.MX.TRIANGLES,0,this._vaoCount)}},{key:"renderHaze",value:function(){return!1}},{key:"_createVertexArrayObject",value:function(e){for(var t=(0,$n.xu)(1,2,!1),n=t.indices[0][1],r=t.vertexAttributes[0][1],i=0;i<n.length;i+=3){var a=n[i];n[i]=n[i+2],n[i+2]=a}for(var o=r.data,s=sr.createBuffer(n.length),l=s.position,u=0;u<n.length;++u){var c=3*n[u];l.set(u,0,o[c]),l.set(u,1,o[c+1]),l.set(u,2,o[c+2])}return new er.U(e,nn.i,{geometry:(0,Jn.K)(sr)},{geometry:nr.f.createVertex(e,an.l1.STATIC_DRAW,s.buffer)})}}]),e}();var or=(0,Cn.c)(),sr=(0,Kn.U$)().vec3f(tr.T.POSITION),lr=n(38499),ur=n(61826),cr=n(19159),hr=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).time=0,e.radius=1,e.width=500,e.opacity=1,e}return(0,l.Z)(n)}($t.K),dr=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),fr)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.ONE,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK})}}]),n}(tn.A);dr.shader=new en.J(cr.P,(function(){return n.e(79090).then(n.bind(n,79090))}));var fr=new Map([[tr.T.POSITION,0],[tr.T.INSTANCEFEATUREATTRIBUTE,1]]),pr=n(96916),vr=n(96856),mr=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._numParticles=25e4,r._rainSpeed=.1,r._snowSpeed=.01,r._passParameters=new hr,r._animation=new vr.d,r._updatingTracking=new ur.t,r._passParameters.time=0,r._passParameters.radius=(0,qt.Iu)(e.view.spatialReference).radius,r._techniqueRepository=e.context.techniqueRepository,r}return(0,l.Z)(n,[{key:"destroy",value:function(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=(0,k.RY)(this._snowTechniqueCached),this._rainTechniqueCached=(0,k.RY)(this._rainTechniqueCached),this._vao=(0,k.M2)(this._vao),this._instanceIdBuffer=(0,k.M2)(this._instanceIdBuffer)}},{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"_rainTechnique",get:function(){if((0,k.Wi)(this._rainTechniqueCached)){var e=new pr.Y;e.type=pr.H.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(dr,e)}return this._rainTechniqueCached}},{key:"_snowTechnique",get:function(){if((0,k.Wi)(this._snowTechniqueCached)){var e=new pr.Y;e.type=pr.H.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(dr,e)}return this._snowTechniqueCached}},{key:"update",value:function(e){return this._animation.advance(e)}},{key:"render",value:function(e,t,n){var r,i="rainy"===n?this._rainTechnique:this._snowTechnique;if(i.compiled){var a=e.rctx;if(this._ensureResources(a),!((0,k.Wi)(i)||(0,k.Wi)(this._vao)||(0,k.Wi)(this._instanceIdBuffer))&&((0,k.pC)(e.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),!(this._passParameters.opacity<=0))){t=t<.5?(0,Se.t7)(0,.35,2*t):(0,Se.t7)(.35,1,2*(t-.5)),this._passParameters.time=("rainy"===n?this._rainSpeed:this._snowSpeed)*(0,lr.D9)(this._animation.time)%1e5;var o=a.bindTechnique(i,this._passParameters,e.bindParameters);a.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),(0,ir.XP)(a,fr,this._instanceIdBuffer,yr,0),null!==(r=a.capabilities.instancing)&&void 0!==r&&r.drawArraysInstanced(an.MX.TRIANGLES,0,3,this._numParticles*t),(0,ir.UF)(a,fr,this._instanceIdBuffer,yr)}}else this.context.requestRender()}},{key:"_ensureResources",value:function(e){(0,k.Wi)(this._vao)&&(this._vao=this._createVertexArrayObject(e)),(0,k.Wi)(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}},{key:"_createInstanceIndices",value:function(e){for(var t=[],n=0;n<this._numParticles;n++)t.push(n);return nr.f.createVertex(e,an.l1.STATIC_DRAW,new Float32Array(t))}},{key:"_createVertexArrayObject",value:function(e){var t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new er.U(e,fr,{geometry:(0,Jn.K)(_r)},{geometry:nr.f.createVertex(e,an.l1.STATIC_DRAW,t)})}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],mr.prototype,"context",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],mr.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],mr.prototype,"updating",null),(0,p._)([(0,Z.Cb)()],mr.prototype,"_updatingTracking",void 0),mr=(0,p._)([(0,L.j)("esri.views.3d.environment.Precipitation")],mr);var _r=(0,Kn.U$)().vec3f(tr.T.POSITION),yr=(0,Jn.K)((0,Kn.U$)().f32(tr.T.INSTANCEFEATUREATTRIBUTE),1),gr=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),br=n(73840),wr=n(97731),Cr=128,xr=-Qt.Tk,Tr=(0,Pe.uV)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]),Sr=function(){function e(t,n){var r=this;(0,s.Z)(this,e),this.view=t,this.type=zt.Simple,this._passParameters=new qn.S,this._vaoCount=0,this._texV1=1,this._isMars=(0,jt.BZ)(t.spatialReference);var i=(0,qt.Iu)(t.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+xr)/this._planetRadius,this._middleRimFactor=(this._planetRadius+0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=n.techniqueRepository;var a=n.renderContext.rctx;this._cameraChangeHandle=(0,A.YP)((function(){var e;return null===(e=r.view.state)||void 0===e?void 0:e.camera}),(function(){return n.requestRender()}),A.tX),this._vao=this._createRibbon(a),this._vaoCount=(0,ir._V)(this._vao,"geometry"),this._fadeVao=(0,dn.ow)(a),this._fadeVaoCount=(0,ir._V)(this._fadeVao,"geometry");var o=this._isMars?gr:Qn;this._passParameters.texture=new rr.x(a,{pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:an.cw.LINEAR,flipped:!0,width:1,height:512},o);var l=new Yn.f;l.geometry=Yn.n.Cone,this._coneTechnique=this._techniqueRepository.acquire(Xn,l),l.geometry=Yn.n.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(Xn,l)}return(0,l.Z)(e,[{key:"destroy",value:function(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=(0,k.M2)(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}},{key:"render",value:function(e){var t=e.bindParameters.camera;this._update(t);var n=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(n.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),n.bindVAO(this._vao),n.drawArrays(an.MX.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(n.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),n.bindVAO(this._fadeVao),n.drawArrays(an.MX.TRIANGLE_STRIP,0,this._fadeVaoCount))}},{key:"renderHaze",value:function(){}},{key:"_update",value:function(e){var t=(0,F.c)(),n=this._planetRadius,r=(0,Gt.l)(e.eye),i=r-n;if(i<0){var a=Math.min(-i/5e3,1);this._passParameters.undergroundFadeAlpha=a}else this._passParameters.undergroundFadeAlpha=0;var o=Math.max(50,i),s=n+xr;this._passParameters.innerScale=function(e,t,n){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-n*n)+t*n)}(n+o,n,s)-1,this._passParameters.altitudeFade=(0,Qt.yx)(i),(0,Gt.g)(t,e.eye,(n+50)/r),kr(t,e.center,e.up,n,this._passParameters.silhouette);var l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),u=1-511/512,c=Tr(i),h=this._texV0+u*this._texVScale,d=this._texV0+l*c*this._texVScale;if(i>50){kr(e.eye,e.center,e.up,n,this._passParameters.silhouette);var f=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),p=(0,Se.uZ)((f-1.5)/(l-1.5),0,1);h=this._texV0+p*u*this._texVScale,d=this._texV0+(0,Se.t7)(this._texV1,l*c,p)*this._texVScale}(0,Yt.s)(this._passParameters.texV,h,d)}},{key:"_createRibbon",value:function(e){var t=(0,br.xx)(1155),n=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(var r=0;r<Cr;r++){var i=9*r+3;t[i+0]=r,t[i+1]=this._innerRimFactor,t[i+2]=-1,t[i+3]=r,t[i+4]=this._middleRimFactor,t[i+5]=0,t[i+6]=r,t[i+7]=this._outerRimFactor,t[i+8]=1;var a=3*r+1,o=127===r?1:a+3,s=15*r;n[s+0]=a,n[s+1]=a+1,n[s+2]=o+1,n[s+3]=o+1,n[s+4]=o,n[s+5]=a,n[s+6]=a+1,n[s+7]=a+2,n[s+8]=o+2,n[s+9]=o+2,n[s+10]=o+1,n[s+11]=a+1,n[s+12]=a,n[s+13]=o,n[s+14]=0}for(var l=Er.createBuffer(n.length),u=l.position,c=0;c<n.length;++c){var h=3*n[c];u.set(c,0,t[h]),u.set(c,1,t[h+1]),u.set(c,2,t[h+2])}return new er.U(e,nn.i,{geometry:(0,Jn.K)(Er)},{geometry:nr.f.createVertex(e,an.l1.STATIC_DRAW,l.buffer)})}},{key:"_computeScreenRimWidth",value:function(e,t,n,r){return(0,Gt.a)(Rr,r.center,r.v2),(0,Gt.g)(Ar,Rr,this._outerRimFactor),(0,wn.u)(Pr,t,Rr,n),(0,wr.iV)(Rr,Pr,e.projectionMatrix,e.viewport,Rr),(0,wr.iV)(Ar,Pr,e.projectionMatrix,e.viewport,Ar),(0,Gt.i)(Rr,Ar)/e.height}}]),e}();function kr(e,t,n,r,i){var a=(0,Gt.l)(e),o=r*Math.sqrt(a*a-r*r)/a,s=Math.sqrt(r*r-o*o),l=i.v1,u=i.v2;return(0,Gt.g)(i.center,e,s/a),(0,Gt.f)(l,e,t),(0,Gt.p)(l)<1&&(0,Gt.f)(l,e,n),(0,Gt.g)(l,l,o/(0,Gt.l)(l)),(0,Gt.f)(u,l,e),(0,Gt.g)(u,u,o/(0,Gt.l)(u)),o}var Pr=(0,Cn.c)(),Rr=(0,F.c)(),Ar=(0,F.c)();var Er=(0,Kn.U$)().vec3f(tr.T.POSITION),Or=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.ONE,an.zi.ZERO,an.zi.ONE_MINUS_SRC_COLOR,an.zi.ONE),colorWrite:on.BK})}}]),n}(tn.A);Or.shader=new en.J(Vn.H,(function(){return n.e(93625).then(n.bind(n,93625))}));var Mr=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;(0,s.Z)(this,n),(r=t.call(this,e))._passParameters=new Vn.F;var i=e.context.renderContext.rctx;r._vao=(0,dn.ow)(i,hn.Bn);var a=(0,qt.Iu)(e.view.spatialReference);r._planetRadius=a.radius,r._atmosphereRadius=a.radius+Qt.k8;var o=new zn;return o.haze=!0,r._hazeTechnique=e.context.techniqueRepository.acquire(Or,o),r}return(0,l.Z)(n,[{key:"destroy",value:function(){this._hazeTechnique.release(),this._vao.dispose()}},{key:"strength",get:function(){return this._passParameters.hazeStrength},set:function(e){this._passParameters.hazeStrength=e}},{key:"render",value:function(e,t){var n=this;if(0!==this.view.basemapTerrain.baseOpacity&&(this._update(e,t),!(this._passParameters.hazeAmount<=0))){var r=this._hazeTechnique;if(r.compiled){var i=e.offscreenRenderingHelper;i.renderDepthDetached((function(){n._passParameters.depthTexture=i.depthTexture;var t=e.rctx.bindTechnique(r,n._passParameters,e.bindParameters);n._renderSimpleHaze(t,e)}))}else this.context.requestRender()}}},{key:"_renderSimpleHaze",value:function(e,t){var n=t.rctx;n.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays(an.MX.TRIANGLE_STRIP,0,4)}},{key:"_update",value:function(e,t){var n=e.bindParameters.camera;(0,Gt.n)(Dr,n.eye);var r=Math.max(0,(0,Gt.e)(Dr,e.bindParameters.lighting.mainLight.direction)),i=Ir;(0,Gt.g)(Lr,i,0),(0,Gt.h)(this._passParameters.hazeColor,Lr,i,r);var a=(0,Gt.l)(n.eye),o=a*a;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.hazeAmount=(1-(0,Se.CW)(7e3,1e4,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}}],[{key:"isSupported",value:function(e){return e.capabilities.depthTexture}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Mr.prototype,"context",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Mr.prototype,"view",void 0),Mr=(0,p._)([(0,L.j)("esri.views.3d.environment.SimpleHaze")],Mr);var Zr=(0,l.Z)((function e(){(0,s.Z)(this,e),this.strength=0,this.amount=0})),Ir=(0,F.f)(.24,.44,.8),Dr=(0,F.c)(),Lr=(0,F.c)(),Nr=n(65905),Fr=n(96894),Ur=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).modelMatrix=(0,Cn.c)(),e}return(0,l.Z)(n)}($t.K),Vr=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),r=t.call(this,e,new un.m,(function(){return r.destroy()}))}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK})}}]),n}(tn.A);Vr.shader=new en.J(Fr.S,(function(){return n.e(98080).then(n.bind(n,98080))}));var Hr=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._loadDataTask=null,r._numPoints=0,r._renderParameter=new Ur,r._updatingTracking=new ur.t,r}return(0,l.Z)(n,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return(0,k.pC)(this._loadDataTask)&&!this._loadDataTask.finished}},{key:"initialize",value:function(){this._loadDataTask=this._createLoadDataTask()}},{key:"destroy",value:function(){this._loadDataTask=(0,k.IM)(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=(0,k.RY)(this._technique),this._vao=(0,k.M2)(this._vao)}},{key:"render",value:function(e){var t=e.rctx;if(this._ensureResources(t),!(0,k.Wi)(this._technique)&&!(0,k.Wi)(this._vao))if(this._technique.compiled){var n=t.bindTechnique(this._technique,this._renderParameter,e.bindParameters);t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(an.MX.POINTS,0,this._numPoints)}else this.requestRender()}},{key:"_ensureResources",value:function(e){var t=this;if(!(0,k.pC)(this._technique)&&!(0,k.Wi)(qr)){this._technique=new Vr({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=qr.byteLength/Wr;var n=new Float32Array(qr,0,2*this._numPoints),r=new Uint8Array(qr,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,n,r,this._numPoints),this._updatingTracking.add((function(){return"virtual"!==t.view.environment.lighting.type?t.view.environment.lighting.date:null}),(function(e){return t._update(e)}),A.nn)}}},{key:"_computeDayDuration",value:function(e){var t=e,n=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+n)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+n)}},{key:"_update",value:function(e){if(e){var t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,n=2*this._computeDayDuration(e),r=(0,wn.c)(this._renderParameter.modelMatrix,Gr);(0,wn.o)(r,r,-n*Math.PI),(0,wn.m)(r,Br,r),(0,wn.o)(r,r,-t*Math.PI),this.requestRender()}}},{key:"_hexToRGB",value:function(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}},{key:"_unpackUint8Attributes",value:function(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}},{key:"_createVertexArrayObject",value:function(e,t,n,r){for(var i=jr.createBuffer(r),a=i.position,o=i.color,s=i.size,l=0;l<r;l++){var u=t[2*l+0],c=t[2*l+1];a.set(l,0,-Math.cos(u)*Math.sin(c)),a.set(l,1,-Math.sin(u)*Math.sin(c)),a.set(l,2,-Math.cos(c));var h=this._unpackUint8Attributes(n[l]),d=this._hexToRGB(zr[h[1]]);o.set(l,0,255*d[0]),o.set(l,1,255*d[1]),o.set(l,2,255*d[2]),o.set(l,3,255),s.set(l,h[0])}return new er.U(e,nn.i,{geometry:(0,Jn.K)(jr)},{geometry:nr.f.createVertex(e,an.l1.STATIC_DRAW,i.buffer)})}},{key:"_createLoadDataTask",value:function(){var e=this;if((0,k.pC)(qr))return null;var t=(0,ge.vr)(function(){var t=(0,o.Z)((0,a.Z)().mark((function t(n){var r,i;return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,Nr.b)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:n});case 2:r=t.sent,i=r.data,e._verifyStarData(i),qr=i;case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());return t.promise.catch((function(t){(0,R.D_)(t)||S.Z.getLogger(e.declaredClass).error(t)})).then((function(){e.destroyed||(e.requestRender(),e.notifyChange("updating"))})),t}},{key:"_verifyStarData",value:function(e){if(!e)throw new b.Z("stars:no-data-received","Failed to create stars because star catalogue is missing");var t=e.byteLength/Wr;if(t%1!=0||t>5e4||t<5e3)throw new b.Z("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Hr.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Hr.prototype,"requestRender",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Hr.prototype,"updating",null),(0,p._)([(0,Z.Cb)()],Hr.prototype,"_loadDataTask",void 0),(0,p._)([(0,Z.Cb)()],Hr.prototype,"_updatingTracking",void 0),Hr=(0,p._)([(0,L.j)("esri.views.3d.environment.Stars")],Hr);var zr=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],Br=(0,Cn.f)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),Gr=(0,Cn.f)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Wr=9,jr=(0,Kn.U$)().vec3f(tr.T.POSITION).vec4u8(tr.T.COLOR).f32(tr.T.SIZE),qr=null,Yr=n(45238),Xr=n(75248);function Qr(e,t,n,r){var i=e.fadeInOutHeight,a=i.stage===yn.hZ.FINISHED?n:e.startTimeHeightFade;if(0!==r){var o=(n-a)/(si*r);i.factor+=t?-o:o}else i.factor=t?0:1;e.startTimeHeightFade=n,i.factor=(0,Se.uZ)(i.factor,0,1),i.stage=yn.hZ.HEIGHT_FADE}function Jr(e,t,n,r,i){e.renderingStage===gn.jL.FINISHED_RENDERING&&(e.renderingStage=gn.jL.FADING_TEXTURE_CHANNELS);var a=(0,Gt.l)(t.eye);e.fadeInOutHeight.factor<0&&(e.fadeInOutHeight.factor=a-ke.sv.radius>Ct?1:0),e.isCameraPositionFinal=(0,Gt.F)(e.cameraPositionLastFrame,t.eye),(0,Gt.n)(ni,t.eye),(0,Gt.g)(ni,ni,ke.sv.radius);var o=e.parallax;0===o.anchorPointClouds[0]&&0===o.anchorPointClouds[1]&&0===o.anchorPointClouds[2]&&(0,Gt.c)(o.anchorPointClouds,ni);var s=(0,Gt.l)((0,Gt.b)(ri,o.anchorPointClouds,ni)),l=!0;s>e.fadeIn.distanceThresholdFactor*o.cloudsHeight||e.fadeIn.stage!==yn.YF.FINISHED?function(e,t,n){var r=e.parallax.anchorPointClouds;e.fadeIn.stage===yn.YF.FINISHED&&(e.fadeIn.factor=0,(0,Gt.c)(r,ni),e.fadeIn.stage=yn.YF.CHANGE_ANCHOR,e.crossFade.enabled=!1,e.fadeInOut.stage=yn.co.FINISHED),e.fadeIn.stage===yn.YF.CHANGE_ANCHOR&&e.isCameraPositionFinal&&((0,gn.WU)(e.data)&&e.renderingStage!==gn.jL.RENDERING||e.renderingStage===gn.jL.FADING_TEXTURE_CHANNELS)&&((0,Gt.c)(r,ni),e.fadeIn.stage=yn.YF.FADE_IN,e.startTime=t,e.renderingStage===gn.jL.FADING_TEXTURE_CHANNELS&&(e.renderingStage=gn.jL.SWITCH_CHANNELS)),e.fadeIn.factor<1&&e.fadeIn.stage===yn.YF.FADE_IN?e.fadeIn.factor=n?(0,Se.uZ)((t-e.startTime)/(ii*n),0,1):1:e.fadeIn.factor>=1&&e.fadeIn.stage===yn.YF.FADE_IN&&(e.fadeIn.stage=yn.YF.FINISHED,e.fadeIn.factor=1)}(e,r,i):s>e.fadeInOut.distanceThresholdFactor*o.cloudsHeight||e.fadeInOut.stage!==yn.co.FINISHED?function(e,t,n){var r=e.fadeInOut,i=e.crossFade;r.stage===yn.co.FINISHED&&(e.startTime=t,r.factor=1,r.stage=yn.co.FADE_OUT),r.factor>0&&r.stage===yn.co.FADE_OUT?r.factor=n?1-(0,Se.uZ)((t-e.startTime)/(ai*n),0,1):0:(r.factor<=0&&r.stage===yn.co.FADE_OUT&&(r.factor=0,(0,Gt.c)(e.parallax.anchorPointClouds,ni)),r.factor<=0&&r.stage===yn.co.FADE_OUT&&e.isCameraPositionFinal&&(r.factor=0,r.stage=yn.co.SWITCH,e.crossFade.enabled=!1,i.factor=1),r.stage===yn.co.SWITCH&&((0,gn.WU)(e.data)&&e.renderingStage!==gn.jL.RENDERING||e.renderingStage===gn.jL.FADING_TEXTURE_CHANNELS)&&(e.startTime=t,r.factor=0,r.stage=yn.co.FADE_IN,(0,Gt.c)(e.parallax.anchorPointClouds,ni),e.crossFade.enabled=!1,i.factor=1,e.renderingStage===gn.jL.FADING_TEXTURE_CHANNELS&&(e.renderingStage=gn.jL.SWITCH_CHANNELS)),r.factor<1&&r.stage===yn.co.FADE_IN?r.factor=n?(0,Se.uZ)((t-e.startTime)/(ii*n),0,1):1:r.factor>=1&&r.stage===yn.co.FADE_IN&&(r.stage=yn.co.FINISHED,r.factor=1))}(e,r,i):s>e.crossFade.distanceThresholdFactor*o.cloudsHeight||e.crossFade.enabled||e.renderingStage===gn.jL.FADING_TEXTURE_CHANNELS?function(e,t,n,r){var i=e.crossFade,a=e.parallax.anchorPointClouds;e.crossFade.enabled&&!r||((0,Gt.c)(e.parallaxNew.anchorPointClouds,ni),e.startTime=t,i.factor=0,e.crossFade.enabled=!0),i.factor<1&&e.crossFade.enabled?i.factor=n?(0,Se.uZ)((t-e.startTime)/(oi*n),0,1):1:i.factor>=1&&e.crossFade.enabled&&(e.crossFade.enabled=!1,i.factor=1,(0,Gt.c)(a,e.parallaxNew.anchorPointClouds),e.renderingStage===gn.jL.FADING_TEXTURE_CHANNELS&&(e.renderingStage=gn.jL.SWITCH_CHANNELS))}(e,r,i,(n!==Xr.n.IDLE||!(0,gn.WU)(e.data))&&e.renderingStage!==gn.jL.FADING_TEXTURE_CHANNELS):l=!1;var u=a-ke.sv.radius;if((u>17e3||u<-1e4)&&e.fadeInOutHeight.factor<1?e.fadeInOutHeight.factor=1:(u>Ct||u<-3500)&&e.fadeInOutHeight.factor<1?Qr(e,!1,r,i):u<Ct&&u>-3500&&e.fadeInOutHeight.factor>0?Qr(e,!0,r,i):e.fadeInOutHeight.stage=yn.hZ.FINISHED,e.renderingStage===gn.jL.SWITCH_CHANNELS&&(e.readChannels=1-e.readChannels,e.renderingStage=gn.jL.FINISHED),o.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(a*a-ke.sv.radius*ke.sv.radius,0))/a,(0,Yr.zk)(ei,o.anchorPointClouds,ti),(0,wn.e)(o.transform,Cn.I,ti[3],(0,Yr.ZZ)(ti)),l){var c=e.parallaxNew;(0,Yr.zk)(ei,c.anchorPointClouds,ti),(0,wn.e)(c.transform,Cn.I,ti[3],(0,Yr.ZZ)(ti))}(0,Gt.c)(e.cameraPositionLastFrame,t.eye)}var Kr,$r,ei=(0,F.f)(0,0,1),ti=(0,Yr.Ue)(),ni=(0,F.c)(),ri=(0,F.c)(),ii=1,ai=.5,oi=1.3,si=1,li=n(37081),ui=n(2263),ci=n(93822);!function(e){e[e.Immediate=0]="Immediate",e[e.Faded=1]="Faded"}(Kr||(Kr={}));var hi=[ci.r.POSTPROCESSING_ENVIRONMENT_OPAQUE,ci.r.POSTPROCESSING_ENVIRONMENT_TRANSPARENT],di=$r=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._context=null,r._atmosphere=null,r._hqAtmosphere=null,r._oldWeatherParameters=new pi,r._newWeatherParameters=new pi,r._fadedWeatherParameters=new pi,r._weatherParameters=r._newWeatherParameters,r}return(0,l.Z)(n,[{key:"initialize",value:function(){this.view._stage.addRenderPlugin(hi,this)}},{key:"destroy",value:function(){var e;this.removeHandles(),null!=(null===(e=this.view)||void 0===e?void 0:e._stage)&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}},{key:"atmosphere",get:function(){return(0,k.pC)(this._hqAtmosphere)&&this.view._stage.renderer.isFeatureEnabled(ui.Y.RealisticAtmosphere)?this._hqAtmosphere:this._atmosphere}},{key:"_atmosphereType",get:function(){return(0,k.pC)(this.atmosphere)?this.atmosphere.type:zt.None}},{key:"canRender",get:function(){var e;return!(null===(e=this.view.basemapTerrain)||void 0===e||!e.renderer.canRender)||"global"!==this.view.viewingMode}},{key:"needsLinearDepth",get:function(){return this._atmosphereType===zt.Realistic}},{key:"updateAnimation",value:function(e){return!!(0,k.pC)(this._precipitation)&&this._precipitation.update(e)}},{key:"updating",get:function(){return(0,k.pC)(this._stars)&&this._stars.updating||(0,k.pC)(this._clouds)&&this._clouds.running}},{key:"weatherVisible",get:function(){return(0,Gt.l)(this.view.state.camera.eye)-(0,qt.Iu)(this.view.spatialReference).radius<=Ct}},{key:"_stars",get:function(){var e,t,n=this,r=this.view,i=null!==(e=null===(t=r.environment)||void 0===t?void 0:t.starsEnabled)&&void 0!==e&&e,a=this._get("_stars");return!i||(0,k.Wi)(this._context)?((0,k.SC)(a),null):(0,k.pC)(a)?a:new Hr({view:r,requestRender:function(){return n._setNeedsRender()}})}},{key:"_precipitation",get:function(){var e=this._get("_precipitation");if(!this._precipitationEnabled||(0,k.Wi)(this._context))return(0,k.SC)(e),null;var t=this.view,n=this._context;return(0,k.pC)(e)&&e.context===n?e:((0,k.SC)(e),new mr({context:n,view:t}))}},{key:"_clouds",get:function(){var e=this,t=this._get("_clouds");if(!this.weatherEnabled||(0,k.Wi)(this._context))return(0,k.SC)(t),null;if((0,k.pC)(t))return t;var n=this.view,r=this._context;return(0,k.SC)(t),new Ln({context:r,view:n,requestRender:function(){return e._setNeedsRender()}})}},{key:"_cloudsComposition",get:function(){var e=this,t=this._get("_cloudsComposition");if(!this.weatherEnabled||(0,k.Wi)(this._context))return(0,k.SC)(t),null;var n=this.view.state.viewingMode,r=this._context.renderContext.rctx,i=(0,qt.Iu)(this.view.spatialReference).radius;return(0,k.pC)(t)&&t.viewingMode===n&&t.planetRadius===i?t:((0,k.SC)(t),new mn({rctx:r,viewingMode:n,planetRadius:i,requestRender:function(){return e._setNeedsRender()}}))}},{key:"_fog",get:function(){var e=this._get("_fog");if(!this.weatherEnabled||(0,k.Wi)(this._context))return(0,k.SC)(e),null;if((0,k.pC)(e))return e;var t=this.view,n=this._context;return new Bn({context:n,view:t})}},{key:"_simpleHaze",get:function(){var e=this._get("_simpleHaze");if(!this.weatherEnabled||(0,k.Wi)(this._context))return(0,k.SC)(e),null;if((0,k.pC)(e))return e;var t=this.view,n=this._context;return new Mr({context:n,view:t})}},{key:"weatherEnabled",get:function(){var e,t;return!(null===(e=this.view)||void 0===e||null===(t=e.environmentManager)||void 0===t||!t.weatherEnabled)}},{key:"_precipitationEnabled",get:function(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}},{key:"initializeRenderContext",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._context=t;var n=function(){return e._setNeedsRender()};this.addHandles([(0,A.gx)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.basemapTerrain}),(function(){return e._updateBasemapTerrain()}),A.tX),(0,A.YP)((function(){return{viewingMode:e.view.state.viewingMode,enabled:e.view.environment.atmosphereEnabled,quality:e.view.environment.atmosphere.quality}}),(function(t){return e._updateAtmosphere(t)}),A.tX),(0,A.YP)((function(){return e._stars}),n),(0,A.YP)((function(){return e._precipitation}),n),(0,A.YP)((function(){return e._clouds}),(function(){return e._updateWeather()}),A.nn),(0,A.YP)((function(){return e._fog}),(function(){return e._updateFogHaze()}),A.nn),(0,A.YP)((function(){return e._simpleHaze}),(function(){return e._updateFogHaze()}),A.nn),(0,A.YP)((function(){return e.view.state.mode}),(function(){e._setNeedsRender()}),A.Z_),(0,A.YP)((function(){return e._atmosphereType}),(function(){return e._updateBasemapTerrain()}),A.tX),(0,A.YP)((function(){return e._weatherUpdateParameters}),(function(){e._updateWeather(),e._updateFogHaze()}),A.tX)])}},{key:"uninitializeRenderContext",value:function(){this._context=null,this._atmosphere=(0,k.SC)(this._atmosphere),this._hqAtmosphere=(0,k.SC)(this._hqAtmosphere),this._set("_stars",(0,k.SC)(this._stars)),this._set("_precipitation",(0,k.SC)(this._precipitation)),this._set("_clouds",(0,k.SC)(this._clouds)),this._set("_cloudsComposition",(0,k.SC)(this._cloudsComposition)),this._set("_fog",(0,k.SC)(this._fog)),this._set("_simpleHaze",(0,k.SC)(this._simpleHaze))}},{key:"prepareRender",value:function(e){e.bindParameters.cloudsFade.data=(0,gn.Ck)(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&(Jr(e.bindParameters.cloudsFade,e.bindParameters.camera,this.view.state.mode,e.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(e.bindParameters),e.bindParameters.cloudsFade.renderingStage===gn.jL.FINISHED&&(0,k.pC)(this._clouds)&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}},{key:"render",value:function(e){if(e.output===li.H.Color)switch(e.bindParameters.slot){case ci.r.POSTPROCESSING_ENVIRONMENT_OPAQUE:(0,k.pC)(this._stars)&&this._stars.render(e),(0,k.pC)(this.atmosphere)&&(this.atmosphere.render(e),(0,k.pC)(this._cloudsComposition)&&(0,k.pC)(e.bindParameters.cloudsFade.data)&&(this.weatherVisible&&(0,k.pC)(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),function(e){return e.crossFade.enabled||e.fadeInOut.stage!==yn.co.FINISHED||e.fadeIn.stage!==yn.YF.FINISHED||e.fadeInOutHeight.stage!==yn.hZ.FINISHED||e.renderingStage!==gn.jL.FINISHED}(e.bindParameters.cloudsFade)&&(0,k.pC)(this._context)&&this._context.requestRender());break;case ci.r.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if((0,k.pC)(this.atmosphere)&&(this.atmosphere.renderHaze(e,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._atmosphereType!==zt.Realistic&&(0,k.pC)(this._simpleHaze)&&this._simpleHaze.render(e,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&(0,k.pC)(this._fog)&&this._fog.render(e,this._weatherParameters.fog),(0,k.pC)(this._precipitation))){var t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}},{key:"updateLightSources",value:function(e,t,n,r){if((0,k.pC)(this._context)){var i=this._context.renderContext;i.bindParameters.oldLighting.copyFrom(i.bindParameters.lighting),i.bindParameters.newLighting.noonFactor=t,i.bindParameters.newLighting.globalFactor=n,i.bindParameters.newLighting.set(e),r===Kr.Faded||i.bindParameters.weatherFading?i.bindParameters.fadeLighting(0):i.bindParameters.fadeLighting(1),this._context.requestRender()}}},{key:"_weatherUpdateParameters",get:function(){var e=this.weatherEnabled?this.view.environment.weather:null;return(0,k.Wi)(e)?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}},{key:"_updateWeatherFading",value:function(e){if(e.weatherFading){var t=e.cloudsFade;return t.fadeIn.stage===yn.YF.FADE_IN?(e.fadeLighting(t.fadeIn.factor),void this._fadeWeather(t.fadeIn.factor)):t.fadeInOut.stage===yn.co.FADE_IN?(e.fadeLighting(t.fadeInOut.factor),void this._fadeWeather(t.fadeInOut.factor)):t.crossFade.enabled?(e.fadeLighting(t.crossFade.factor),void this._fadeWeather(t.crossFade.factor)):(e.fadeLighting(0),void this._fadeWeather(0))}}},{key:"_fadeWeather",value:function(e){var t=this._newWeatherParameters,n=this._oldWeatherParameters;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(n,t,e),this._weatherParameters=this._fadedWeatherParameters)}},{key:"_updateWeather",value:function(){var e=this._weatherUpdateParameters;(0,k.Wi)(e)||(0,k.Wi)(this._clouds)||(this._clouds.applyPreset(Sn.L[e.type],e.weatherAdjustment),this._setNeedsRender())}},{key:"_setNeedsRender",value:function(){(0,k.pC)(this._context)&&this._context.requestRender()}},{key:"_updateFogHaze",value:function(){var e,t,n=this._weatherUpdateParameters;if(!((0,k.Wi)(this._fog)||(0,k.Wi)(this._simpleHaze)||(0,k.Wi)(n)||(0,k.Wi)(this._context))){var r=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),n.type){case"foggy":this._newWeatherParameters.fog.strength=(0,Se.t7)(3e-5,.005,Math.pow(n.weatherAdjustment,3)),(0,Gt.c)(this._newWeatherParameters.fog.color,mi),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===zt.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=(0,Se.t7)(4e-6,2e-4,Math.pow(null!==(e=n.effect)&&void 0!==e?e:0,3)),(0,Gt.c)(this._newWeatherParameters.fog.color,vi),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=(0,Se.t7)(4e-6,2e-4,Math.pow(null!==(t=n.effect)&&void 0!==t?t:0,3)),(0,Gt.c)(this._newWeatherParameters.fog.color,mi),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===zt.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}r.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}}},{key:"_updateAtmosphere",value:function(e){var t=this._selectAtmosphereType(e);if((0,k.pC)(this._atmosphere)?this._atmosphere.type!==t:t!==zt.None){this._atmosphere=(0,k.SC)(this._atmosphere),this._hqAtmosphere=(0,k.SC)(this._hqAtmosphere);var n=this._getAtmosphereClass(t);n&&(0,k.pC)(this._context)&&(this._atmosphere=new n(this.view,this._context),t===zt.Simple&&(this._hqAtmosphere=new fn(this.view,this._context))),this._setNeedsRender(),this._updateBasemapTerrain()}}},{key:"_getAtmosphereClass",value:function(e){switch(e){case zt.Realistic:return fn;case zt.Panoramic:return ar;case zt.Simple:return Sr;default:case zt.None:return null}}},{key:"_selectAtmosphereType",value:function(e){var t=e.enabled,n=e.quality,r=e.viewingMode;return!t||(0,jt.V2)(this.view.spatialReference)?zt.None:r===he.JY.Local?zt.Panoramic:(0,k.pC)(this._context)&&"high"===n&&fn.isSupported(this._context)&&(0,jt.N$)(this.view.spatialReference)?zt.Realistic:zt.Simple}},{key:"_updateBasemapTerrain",value:function(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=this._atmosphereType===zt.Simple)}},{key:"test",get:function(){var e=this;return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:function(){return e._selectAtmosphereType({viewingMode:e.view.state.viewingMode,enabled:e.view.environment.atmosphereEnabled,quality:e.view.environment.atmosphere.quality})},stubGetAtmosphereClass:function(e){fi=$r.prototype._getAtmosphereClass,$r.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:function(){$r.prototype._getAtmosphereClass=fi}}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],di.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"atmosphere",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_atmosphereType",null),(0,p._)([(0,Z.Cb)({type:Boolean,readOnly:!0})],di.prototype,"updating",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"weatherVisible",null),(0,p._)([(0,Z.Cb)()],di.prototype,"_context",void 0),(0,p._)([(0,Z.Cb)()],di.prototype,"_atmosphere",void 0),(0,p._)([(0,Z.Cb)()],di.prototype,"_hqAtmosphere",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_stars",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_precipitation",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_clouds",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_cloudsComposition",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_fog",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_simpleHaze",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"weatherEnabled",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_precipitationEnabled",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],di.prototype,"_weatherUpdateParameters",null),di=$r=(0,p._)([(0,L.j)("esri.views.3d.environment.EnvironmentRenderer")],di);var fi,pi=function(){function e(){(0,s.Z)(this,e),this.fog=new Gn,this.haze=new Zr}return(0,l.Z)(e,[{key:"copyFrom",value:function(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,(0,Gt.c)(this.fog.color,e.fog.color)}},{key:"lerp",value:function(e,t,n){this.fog.amount=(0,Se.t7)(e.fog.amount,t.fog.amount,n),this.haze.amount=(0,Se.t7)(e.haze.amount,t.haze.amount,n),this.fog.strength=(0,Se.t7)(e.fog.strength,t.fog.strength,n),this.haze.strength=(0,Se.t7)(e.haze.strength,t.haze.strength,n),(0,Gt.h)(this.fog.color,e.fog.color,t.fog.color,n)}}]),e}(),vi=(0,F.f)(.5,.5,.5),mi=(0,F.f)(1.5,1.5,1.5),_i=n(585);function yi(e,t,n){if((0,k.Wi)(t.longitude)||(0,k.Wi)(t.latitude)||(0,k.Wi)(n.longitude)||(0,k.Wi)(n.latitude))throw new Error("Invalid points: no lon/lat");return function(e,t,n,r,i){var a=(0,Se.Vl)(n),o=(0,Se.Vl)(i),s=a-o,l=(0,Se.Vl)(t)-(0,Se.Vl)(r),u=Math.sin(s/2),c=Math.sin(l/2),h=2*(0,Se.Kt)(Math.sqrt(u*u+Math.cos(a)*Math.cos(o)*c*c))*e;return Math.round(1e4*h)/1e4}(e,t.longitude,t.latitude,n.longitude,n.latitude)}function gi(e,t,n){var r=t.spatialReference,i=(0,qt.Iu)(r),a=new _i.Z(t.x,e.y,r),o=new _i.Z(n.x,e.y,r),s=new _i.Z(e.x,t.y,r),l=new _i.Z(e.x,n.y,r);return{lon:yi(i.radius,a,o),lat:yi(i.radius,s,l)}}function bi(e,t){var n=null===e||void 0===e?void 0:e[0];if(null==n)return null;t||(t={hours:0,minutes:0,seconds:0}),t.hours=function(e,t){var n=e/15;return t||(n=Math.round(n)),n}(n,!0);var r=t.hours%1;t.hours-=r,t.minutes=60*r;var i=t.minutes%1;return t.minutes-=i,t.seconds=Math.round(60*i),t}var wi,Ci,xi,Ti={};wi={get exports(){return Ti},set exports(e){Ti=e}},Ci=function(){var e=Math.PI,t=Math.sin,n=Math.cos,r=Math.tan,i=Math.asin,a=Math.atan2,o=Math.acos,s=e/180,l=864e5,u=2440588,c=2451545,h={dec:0,ra:0};function d(e){return new Date((e+.5-u)*l)}function f(e){return function(e){return e.valueOf()/l-.5+u}(e)-c}var p=23.4397*s;function v(e,i){return a(t(e)*n(p)-r(i)*t(p),n(e))}function m(e,r){return i(t(r)*n(p)+n(r)*t(p)*t(e))}function _(e,i,o){return a(t(e),n(e)*t(i)-r(o)*n(i))}function y(e,r,a){return i(t(r)*t(a)+n(r)*n(a)*n(e))}function g(e,t){return s*(280.16+360.9856235*e)-t}function b(e){return s*(357.5291+.98560028*e)}function w(e){return s*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function C(t,n){return t+n+102.9372*s+e}function x(e,t){var n=b(e),r=C(n,w(n));return t||(t={dec:0,ra:0}),t.dec=m(r,0),t.ra=v(r,0),t}var T={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,n,r){var i=s*-n,a=s*t,o=f(e),l=x(o,h),u=g(o,i)-l.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=_(u,a,l.dec),r.altitude=y(u,a,l.dec),r}},S=[[-.83,"sunrise","sunset"]];T.addTime=function(e,t,n){S.push([e,t,n])};var k=9e-4;function P(t,n){return Math.round(t-k-n/(2*e))}function R(t,n,r){return k+(t+n)/(2*e)+r}function A(e,n,r){return c+e+.0053*t(n)-.0069*t(2*r)}function E(e,r,i){return o((t(e)-t(r)*t(i))/(n(r)*n(i)))}function O(e){var r=s*(134.963+13.064993*e),i=s*(93.272+13.22935*e),a=s*(218.316+13.176396*e)+6.289*s*t(r),o=5.128*s*t(i),l=385001-20905*n(r);return{ra:v(a,o),dec:m(a,o),dist:l}}return T.getTimes=function(e,r,i){var a=s*-i,o=s*r,l=P(f(e),a),u=R(0,a,l),c=b(u),h=w(c),p=C(c,h),v=m(p,0),_=A(u,c,p);function y(e){return A(R(E(e,o,v),a,l),c,p)}var g,x,k,O,M,Z={solarNoon:d(_),nadir:d(_-.5),polarException:T.PolarException.NORMAL};for(g=0,x=S.length;g<x;g+=1)M=_-((O=y((k=S[g])[0]*s))-_),Z[k[1]]=d(M),Z[k[2]]=d(O);return Z.polarException=function(e){var r=(t(e)-t(o)*t(v))/(n(o)*n(v));return r<-1?T.PolarException.MIDNIGHT_SUN:r>1?T.PolarException.POLAR_NIGHT:T.PolarException.NORMAL}(S[0][0]*s),Z},T.getMoonPosition=function(e,t,n){var i=s*-n,a=s*t,o=f(e),l=O(o),u=g(o,i)-l.ra,c=y(u,a,l.dec);return c+=.017*s/r(c+10.26*s/(c+5.1*s)),{azimuth:_(u,a,l.dec),altitude:c,distance:l.dist}},T.getMoonFraction=function(e){var r=f(e),i=x(r),s=O(r),l=149598e3,u=o(t(i.dec)*t(s.dec)+n(i.dec)*n(s.dec)*n(i.ra-s.ra)),c=a(l*t(u),s.dist-l*n(u));return(1+n(c))/2},T},void 0!==(xi=Ci())&&(wi.exports=xi);var Si=Ti,ki={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function Pi(e,t,n,r,i,a){(0,Gt.s)(a.ambient.color,1,1,1),a.ambient.intensity=ki.global.ambient,(0,Gt.s)(a.direct.color,1,1,1),a.direct.intensity=ki.global.direct;var o,s=t[2],l=(0,Se.uZ)((Math.abs(s)-ki.local.altitude)/(ki.global.altitude-ki.local.altitude),0,1);if(a.globalFactor=l,(0,k.pC)(e)&&(o=Si.getTimes(e,t[1],t[0])),l<1){var u;if((0,k.pC)(e))u=function(e,t,n){var r,i,a=e.valueOf();t.polarException===Si.PolarException.MIDNIGHT_SUN?(r=a-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,i=r+432e6):t.polarException===Si.PolarException.POLAR_NIGHT?(r=a-2,i=a-1):(r=t.sunrise.valueOf(),i=t.sunset.valueOf());var o,s,l=i-r,u=r+l/2,c=l/4,h=u-c,d=u+c,f=.06*l,p=r-f/2,v=r+f/2,m=i-f/2,_=i+f/2,y=ki.local,g=[.01,y.ambientAtNight],b=[.8,.8,1],w=[.01,.01,.01],C=[y.directAtTwilight,y.ambientAtTwilight],x=[1,.6,.5],T=[.8,.8,1],S=[.9*y.directAtNoon,y.ambientAtNoon],k=[1,.98,.98],P=[.98,.98,1],R=[y.directAtNoon,y.ambientAtNoon],A=[1,1,1],E=[1,1,1],O=S,M=k,Z=P,I=C,D=x,L=T,N=[0,0],U=[0,0,0],V=[0,0,0];a<p||a>_?(N=g,U=w,V=b,s="night"):a<v?(o=v-p,N=Li(a-p,o,g,C),U=Li(a-p,o,w,x),V=Li(a-p,o,b,T),s="sun rising"):a<h?(o=h-v,N=Li(a-v,o,C,S),U=Li(a-v,o,x,k),V=Li(a-v,o,T,P),s="early morning"):a<u?(o=u-h,N=Li(a-h,o,S,R),U=Li(a-h,o,k,A),V=Li(a-h,o,P,E),s="late morning"):a<d?(o=d-u,N=Li(a-u,o,R,O),U=Li(a-u,o,A,M),V=Li(a-u,o,E,Z),s="early afternoon"):a<m?(o=m-d,N=Li(a-d,o,O,I),U=Li(a-d,o,M,D),V=Li(a-d,o,Z,L),s="late afternoon"):a<_&&(o=_-m,N=Li(a-m,o,I,g),U=Li(a-m,o,D,w),V=Li(a-m,o,L,b),s="sun setting");var H=0;switch(n){case"rainy":case"foggy":case"snowy":H=.5}H>0&&(U=Di(U,H),V=Di(V,H));var z=(0,F.f)(U[0],U[1],U[2]),B=(0,F.f)(V[0],V[1],V[2]),G=Ii(n);return{direct:{intensity:N[0]*G.direct,color:z},ambient:{intensity:N[1]*G.ambient,color:B},timeOfDay:s}}(e,o,r);else{var c=Ii(r);u={direct:{intensity:ki.local.directAtNoon*c.direct,color:(0,F.f)(1,1,1)},ambient:{intensity:ki.local.ambientAtNoon*c.ambient,color:(0,F.f)(1,1,1)},timeOfDay:"early afternoon"}}(0,Gt.h)(a.ambient.color,u.ambient.color,a.ambient.color,l),a.ambient.intensity=(0,Se.t7)(u.ambient.intensity,a.ambient.intensity,l),(0,Gt.h)(a.direct.color,u.direct.color,a.direct.color,l),a.direct.intensity=(0,Se.t7)(u.direct.intensity,a.direct.intensity,l),a.specularStrength="rainy"===r||"snowy"===r||"foggy"===r?0:1,a.environmentStrength="rainy"===r?.7:"snowy"===r||"foggy"===r?.75:1}a.noonFactor=(0,k.pC)(e)?function(e,t){var n,r,i=e.valueOf();t.polarException===Si.PolarException.MIDNIGHT_SUN?(n=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,r=n+432e6):t.polarException===Si.PolarException.POLAR_NIGHT?(n=i-2,r=i-1):(n=t.sunrise.valueOf(),r=t.sunset.valueOf());var a=n+(r-n)/2;return 1-(0,Se.uZ)(Math.abs(i-a)/432e5,0,1)}(e,o):1,(0,k.pC)(e)?Ai(e,t,n,a.direct.directionToLightSource):Ri(i,n,a.direct.directionToLightSource)}function Ri(e,t,n){t===he.JY.Global?(0,Gt.n)(Fi,e.eye):(0,Gt.s)(Fi,0,0,1),(0,Gt.g)(Ui,e.viewForward,-1);var r=(0,Pe.EU)(Ui,Fi),i=Math.max(r-2*Hi,0),a=.85*i/(i+1),o=Math.max(Hi,r-Hi-a);(0,wn.d)(Ni,-o,e.viewRight),(0,Gt.m)(n,Ui,Ni),(0,Gt.a)(n,n,(0,Gt.g)(Vi,e.viewRight,zi)),(0,Gt.n)(n,n)}function Ai(e,t,n,r){var i=Zi,a=(0,wn.i)(Mi);if(n===he.JY.Global)Si.getPosition(e,0,0,i),(0,Gt.s)(r,0,0,-1),(0,wn.r)(a,a,-i.azimuth),(0,wn.n)(a,a,-i.altitude),(0,Gt.m)(r,r,a);else{var o=ki.planarDirection,s=o.globalAngles,l=t[2],u=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);(u=(0,Se.uZ)(u,0,1))<1?(Si.getPosition(e,t[1],t[0],i),i.azimuth=(1-u)*i.azimuth+u*s.azimuth,i.altitude=(1-u)*i.altitude+u*s.altitude):(i.azimuth=s.azimuth,i.altitude=s.altitude),(0,Gt.s)(r,0,-1,0),(0,wn.o)(a,a,-i.azimuth),(0,wn.r)(a,a,-i.altitude),(0,Gt.m)(r,r,a)}}var Ei=(0,F.f)(.5773502691896258,-.5773502691896258,.5773502691896258),Oi=(0,l.Z)((function e(){(0,s.Z)(this,e),this.ambient={color:(0,F.f)(1,1,1),intensity:.55},this.direct={color:(0,F.f)(1,1,1),intensity:.55,directionToLightSource:(0,F.a)(Ei)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1})),Mi=(0,Cn.c)(),Zi={azimuth:0,altitude:0};function Ii(e){switch(e){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function Di(e,t){for(var n=(e[0]+e[1]+e[2])/3,r=0;r<3;r++)e[r]=e[r]+(n-e[r])*t;return e}function Li(e,t,n,r){for(var i=[],a=0;a<n.length;a++)i[a]=(r[a]-n[a])*e/t+n[a];return i}new Date(0);var Ni=(0,Cn.c)(),Fi=(0,F.c)(),Ui=(0,F.c)(),Vi=(0,F.c)(),Hi=.25,zi=.2,Bi=n(11954),Gi=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.call(this))._referencePointUpdateDelay=200,e._referencePointUpdateInterval=3e3,e._referencePointUpdateDistThreshold=1e6,e._referencePosUpdateQuery=null,e._referencePosMapCoordsRequested=null,e._viewHandles=new K.Z,e._preserveAbsoluteDateTime=!1,e._trackingEnabled=!1,e._referencePosResetPreserveAbsoluteTime=!1,e._referencePosUpdateTimer=null,e._referencePosMapCoords=null,e._mainLight=new Bi.Eg,e._ambientLight=new Bi.Mi,e._moonLight=new Bi.AM,e.disableQueries=!1,e._disableWeather=!1,e._renderer=null,e._referencePosWGS84Comparable=null,e._resetReferencePosition(),e}return(0,l.Z)(n,[{key:"destroy",value:function(){this.disconnectView(),this._viewHandles.destroy()}},{key:"_view",get:function(){var e;return null===(e=this._renderer)||void 0===e?void 0:e.view}},{key:"updating",get:function(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&(null===(e=this._renderer)||void 0===e||!e.updating))}},{key:"weatherEnabled",get:function(){var e,t,n;return(null===(e=this._view)||void 0===e?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&(null===(t=this._view)||void 0===t||null===(n=t.state)||void 0===n?void 0:n.viewingMode)===he.JY.Global&&(0,jt.N$)(this._view.spatialReference)}},{key:"weatherVisible",get:function(){var e;return this.weatherEnabled&&(null===(e=this._renderer)||void 0===e?void 0:e.weatherVisible)}},{key:"referencePositionWGS84Comparable",get:function(){return this._referencePosWGS84Comparable}},{key:"connectView",value:function(e){var t=this;if(!this._renderer){this._renderer=new di({view:e});var n=function(){return t._updateRenderParameters()},r=function(){return t._cameraHandler()};this._viewHandles.add([(0,A.YP)((function(){return e.environment.lighting}),(function(e){return t._updateLightingHandler(e)}),A.Z_),(0,A.YP)((function(){return"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null}),(function(e){return t._lightingDateHandler(e)}),A.Z_),(0,A.YP)((function(){return e.stationary}),(function(){return t._interactingStationaryHandler()})),(0,A.YP)((function(){return e.environment.lighting.directShadowsEnabled}),n,A.Z_),(0,A.YP)((function(){return e.environment.lighting.ambientOcclusionEnabled}),n,A.Z_),(0,A.YP)((function(){return e.environment.lighting.waterReflectionEnabled}),n,A.Z_),(0,A.YP)((function(){var t;return null===(t=e.environment.background)||void 0===t?void 0:t.color}),n,A.Z_),(0,A.YP)((function(){return e.spatialReference}),(function(){return t._resetReferencePosition(!0)}),A.Z_),(0,A.YP)((function(){return e.environment.weather.type}),(function(){return t._updateLighting(null,Kr.Faded)}),A.Z_),(0,A.YP)((function(){return t.weatherEnabled}),(function(){return t._updateLighting(null,Kr.Faded)}),A.Z_),(0,A.YP)((function(){return e.viewingMode}),(function(){return t._resetReferencePosition(!0)}),A.tX),(0,A.YP)((function(){return"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled}),(function(e){return t._updateCameraTracking(e)}),A.tX),(0,A.YP)((function(){return e.state.camera}),r,A.tX),(0,A.YP)((function(){return t.disableQueries}),r)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}}},{key:"disconnectView",value:function(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=(0,k.SC)(this._renderer)}},{key:"_updateLightingHandler",value:function(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}},{key:"_updateCameraTracking",value:function(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{var t=this._view.environment.lighting;"virtual"!==(null===t||void 0===t?void 0:t.type)&&(t.positionTimezoneInfo.autoUpdated=!1)}}},{key:"_lightingDateHandler",value:function(e){var t=this._view.environment.lighting;if("virtual"!==(null===t||void 0===t?void 0:t.type)){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;var n=this._view.spatialReference;if(!(0,H.jF)(n)){var r=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(r))return void this._requestReferencePositionUpdate(r)}if(this._preupdateTracking(e),(0,k.pC)(this._referencePosWGS84Comparable)){var i=bi(this._referencePosWGS84Comparable,Ji);(0,k.pC)(i)&&(t.autoUpdate(null,i),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}},{key:"_preupdateTracking",value:function(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}},{key:"_cameraHandler",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._view;if(t.ready){var n=t.stateManager.camera;n&&(this._cameraHandlerClientSide(n,e)||this._cameraHandlerServerSide(n))}}},{key:"_cameraHandlerClientSide",value:function(e,t){var n,r,i,a=(0,jt.N$)(this._view.spatialReference);if(a&&!(0,H.jF)(this._view.spatialReference))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;var o=e.position;return(0,k.Wi)(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=(0,F.c)()),a?(0,H.UY)(o,this._referencePosWGS84Comparable):(0,Gt.s)(this._referencePosWGS84Comparable,null!==(n=o.longitude)&&void 0!==n?n:0,null!==(r=o.latitude)&&void 0!==r?r:0,null!==(i=o.z)&&void 0!==i?i:0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}},{key:"_cameraHandlerServerSide",value:function(e){var t,n=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(n))&&this._requestReferencePositionUpdate(n,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(null!==(t=n.z)&&void 0!==t?t:0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}},{key:"_interactingStationaryHandler",value:function(){this._view.stationary&&this._executePendingReferencePositionUpdate()}},{key:"_updateLighting",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Kr.Immediate,n=this._view;e=e||("virtual"===n.environment.lighting.type?null:n.environment.lighting.date);var r=this._referencePosWGS84Comparable,i=(0,k.pC)(r)?Yi:Xi,a=this.weatherVisible?n.environment.weather.type:"disabled";(0,k.pC)(r)?Pi(e,r,n.state.viewingMode,a,n.state.camera,i):"virtual"===n.environment.lighting.type&&Ri(n.state.camera,n.state.viewingMode,i.direct.directionToLightSource);var o=this._mainLight,s=i.direct;(0,Gt.g)(o.intensity,s.color,s.intensity*Math.PI),(0,Gt.c)(o.direction,s.directionToLightSource),o.specularStrength=i.specularStrength,o.environmentStrength=i.environmentStrength;var l=this._ambientLight;(0,Gt.g)(l.intensity,i.ambient.color,i.ambient.intensity);var u=this._moonLight;(0,Gt.h)(u.intensity,Ki,$i,i.globalFactor);var c=(1-.5*i.globalFactor)*(1-.4*i.noonFactor*(1-i.globalFactor));(0,Gt.g)(u.intensity,u.intensity,c),(0,Gt.c)(u.direction,s.directionToLightSource),this._renderer.updateLightSources([o,l,u],i.noonFactor,i.globalFactor,t),this._updateRenderParameters()}},{key:"_autoUpdateTimezone",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||(0,k.Wi)(e))return!1;var n=Qi;n.setTime((t||this._view.environment.lighting.date).getTime());var r=bi(e,Ji);if((0,k.Wi)(r))return!1;var i=this._view.environment.lighting.positionTimezoneInfo;if(i.autoUpdated){if(i.hours===r.hours&&i.minutes===r.minutes&&i.seconds===r.seconds)return!1}else i=r;var a=n.getUTCHours()-(r.hours-i.hours),o=n.getUTCMinutes()-(r.minutes-i.minutes),s=n.getUTCSeconds()-(r.seconds-i.seconds);return n.setUTCHours(a),n.setUTCMinutes(o),n.setUTCSeconds(s),!t&&this._view.environment.lighting.autoUpdate(n,r)}},{key:"_updateRenderParameters",value:function(){var e=this,t=this._view._stage;if(t){var n=(0,k.R2)(this._referencePosWGS84Comparable,!0,(function(t){return function(e,t){if(t===he.JY.Global)return!0;var n=ki.planarDirection;return Math.abs(e)<n.localAltitude}(t[2],e._view.state.viewingMode)})),r=this._view.environment.background,i=r instanceof Ot?{type:"color",color:(0,Wt.b)(Pt.Z.toUnitRGBA(r.color))}:{type:"color",color:(0,Wt.f)(0,0,0,1)};t.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&n,background:i,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}}},{key:"_resetReferencePosition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}},{key:"_requestReferencePositionUpdate",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!n,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){var r=this._referencePosUpdateQuery=(0,R.e4)(this._referencePointUpdateDelay).then((function(){if(t._referencePosUpdateQuery===r){return t._doReferencePositionUpdateQuery((function(){return t._referencePosUpdateQuery!==r}))}})).catch((function(e){"mapcoordshelper:missing-geometry-service"===e.name&&(t.disableQueries=!0)})).then((function(){t._referencePosUpdateQuery===r&&(t._referencePosUpdateQuery=null,t._referencePosUpdateTimer||t._executePendingReferencePositionUpdate(),t.notifyChange("updating"))})),i=this._referencePosUpdateTimer=(0,R.e4)(this._referencePointUpdateInterval).then((function(){t._referencePosUpdateTimer===i&&(t._referencePosUpdateTimer=null,t._referencePosUpdateQuery||t._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}},{key:"_doReferencePositionUpdateQuery",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null,e.next=3,this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);case 3:n=e.sent,t()||isNaN(n[0])||isNaN(n[1])||(i=(null!==(r=this._referencePosMapCoords.z)&&void 0!==r?r:0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=n[0],this._referencePosWGS84Comparable[1]=n[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[n[0],n[1],i],this._referencePosChanged());case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_executePendingReferencePositionUpdate",value:function(){var e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}},{key:"_referencePosChanged",value:function(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}},{key:"_exceedsReferencePosDistThreshold",value:function(e){if(this._referencePosMapCoords){var t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}},{key:"_cancelReferencePosUpdates",value:function(){var e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}},{key:"test",get:function(){var e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}}]),n}($.Z.EventedAccessor);(0,p._)([(0,Z.Cb)({type:Boolean,readOnly:!0})],Gi.prototype,"updating",null),(0,p._)([(0,Z.Cb)()],Gi.prototype,"disableQueries",void 0),(0,p._)([(0,Z.Cb)()],Gi.prototype,"_disableWeather",void 0),(0,p._)([(0,Z.Cb)()],Gi.prototype,"weatherEnabled",null),(0,p._)([(0,Z.Cb)()],Gi.prototype,"weatherVisible",null),(0,p._)([(0,Z.Cb)()],Gi.prototype,"referencePositionWGS84Comparable",null),(0,p._)([(0,Z.Cb)()],Gi.prototype,"_renderer",void 0),(0,p._)([(0,Z.Cb)()],Gi.prototype,"_referencePosWGS84Comparable",void 0),Gi=(0,p._)([(0,L.j)("esri.views.3d.environment.SceneViewEnvironmentManager")],Gi);var Wi,ji,qi,Yi=new Oi,Xi=new Oi,Qi=new Date,Ji={hours:0,minutes:0,seconds:0},Ki=(0,F.f)(.22,.22,.33),$i=(0,F.f)(.22,.22,.22),ea=n(23470),ta=n(40885);function na(e,t){return 0!=(e&t)}function ra(e,t,n,r,i,a){0!==e&&(n?(a.min=Math.min(a.min,t),a.max=Math.max(a.max,t)):null!=r?(a.min-=Math.max(0,(t-a.min)*(1-r)),a.max+=Math.max(0,(t-a.max)*(1-r))):i&&(a.min-=Math.max(0,t-a.min-i),a.max+=Math.max(0,t-a.max-i)))}!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(Wi||(Wi={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(ji||(ji={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(qi||(qi={}));var ia={selection:Wi.NONE,interactionType:ji.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:qi.TUMBLE};function aa(e,t,n,r){return t=t||e.viewForward,(0,Gt.c)(r,t),(0,Gt.g)(r,r,Math.sign((0,Gt.e)(t,n))),r}var oa=n(83281);function sa(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ia;if(!la(e,n)||!e.state.constraints.altitude)return 0;var r=ha(e.state.constraints.altitude,da);ua(e,n,r);var i=e.renderCoordsHelper.getAltitude(t.eye),a=(0,Se.uZ)(i,r.min,r.max)-i;return Math.abs(a)<=1e-6?0:a}function la(e,t){var n=e.state.constraints.altitude;return!(!e.state.isGlobal||!n)&&(t.interactionType!==ji.TUMBLE||!na(t.selection,Wi.TILT))}function ua(e,t,n){var r=t.interactionType;if(r!==ji.NONE){var i=n.min,a=n.max,o=t.interactionStartCamera,s=t.interactionFactor;if(o){var l=r===ji.TUMBLE||r===ji.ZOOM,u=sa(e,o),c=0===u?0:e.renderCoordsHelper.getAltitude(o.eye);n.min=i,n.max=a,ra(u,c,l,s,.05*c,n)}}}function ca(e,t,n,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),(0,Gt.g)(r,r,n),r}function ha(e,t){return t.min=e.min,t.max=e.max,t}var da={min:0,max:0},fa=(0,F.c)(),pa=(0,F.c)(),va=(0,F.c)(),ma=(0,F.c)();function _a(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ia;if(!e.state.isLocal)return 0;var r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;wa.min=0,wa.max=r,ya(e,n,wa);var i=ga(e,t),a=wa.max-i;return a>=-1e-6?0:a}function ya(e,t,n){var r=t.interactionType;if(r!==ji.NONE){var i=n.min,a=n.max,o=t.interactionStartCamera,s=t.interactionFactor;if(o){var l=r===ji.ZOOM||r===ji.PAN,u=_a(e,o),c=0===u?0:ga(e,o);n.min=i,n.max=a,ra(u,c,l,s,.05*c,n)}}}function ga(e,t){var n=e.pointsOfInterest.surfaceOrigin;return n.renderLocation?(0,Gt.i)(t.eye,n.renderLocation):0}function ba(e,t,n){return(0,Gt.r)(n,e.eye,t)}var wa={min:0,max:0},Ca=(0,F.c)(),xa=(0,F.c)(),Ta=(0,F.c)(),Sa=(0,F.c)(),ka=(0,F.c)(),Pa=n(88153);function Ra(e,t,n,r){return(0,k.pC)(e.renderCoordsHelper.fromRenderCoords(t.eye,Ia,r))&&(0,z.BD)(n,Ia)}function Aa(e,t){return e.elevationProvider?(0,k.Pt)(e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function Ea(e,t,n,r){var i=e.state.camera.clone();t&&n&&r&&(i.eye=t,i.center=n,i.up=r),function(e,t,n){var r=Za[e.viewingMode];r||(r=(0,Pa.Z8)(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Za[e.viewingMode]=r);var i=e.state.isGlobal;return!(!e.sceneIntersectionHelper.intersectRay(t,r,n)||Oa(e,t.origin,n))||!(!e.renderCoordsHelper.intersectManifold(t,0,n)||Oa(e,t.origin,n))||!!i&&function(e,t,n){var r=(0,Gt.e)(e.origin,e.origin)-n*n,i=r>0?Math.sqrt(r)/3:1;return(0,Gt.g)(t,e.direction,i/(0,Gt.l)(e.direction)),(0,Gt.a)(t,t,e.origin),!0}(t,n,(0,qt.Iu)(e.spatialReference).radius)}(e,i.ray,Da)||(0,Gt.c)(Da,i.center);var a=e.state.constraints,o=a.minimumPoiDistance;if((0,Gt.d)(i.eye,Da)<o){var s=a.collision.enabled;(0,Gt.c)(La,i.viewForward),(0,Gt.g)(La,La,o),s?i.eye=(0,Gt.b)(Ia,Da,La):(0,Gt.a)(Da,i.eye,La);var l=e.renderCoordsHelper,u=l.getAltitude(i.eye),c=a.collision.elevationMargin;s&&u<c&&((0,Gt.b)(La,Da,i.eye),i.eye=l.setAltitude(Ia,c,i.eye),(0,Gt.a)(Da,i.eye,La))}return i.center=Da,i}function Oa(e,t,n){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;var r=Aa(e,t),i=e.stateManager.constraintsManager.nearFarHeuristic.compute(t,n,e.renderDataExtent,r,Na).far,a=i*i;return(0,Gt.d)(t,n)>a}var Ma,Za={},Ia=(0,F.c)(),Da=(0,F.c)(),La=(0,F.c)(),Na={near:0,far:0};function Fa(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ma.EYE,r=e.state.constraints;if(!r.collision.enabled)return!1;var i=Aa(e,t.eye),a=e.renderCoordsHelper.getAltitude(t.eye),o=i+r.collision.elevationMargin;if(a>=o)return!1;var s=(0,Gt.l)(t.eye);if((0,Gt.b)(Ua,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Va,o,t.eye),n===Ma.EYE_AND_CENTER)t.center=(0,Gt.a)(Ua,t.eye,Ua);else if(n===Ma.EYE_AND_CENTER_SCALE){var l=(s-a+o)/s;t.center=(0,Gt.g)(Ua,t.center,l)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(Ma||(Ma={}));var Ua=(0,F.c)(),Va=(0,F.c)();function Ha(e,t,n){e.worldUpAtPosition(t,za),(0,Gt.b)(Ba,n,t);var r=(0,Gt.l)(Ba);return 0===r?0:(0,Se.ZF)((0,Gt.e)(Ba,za)/r)}var za=(0,F.c)(),Ba=(0,F.c)();function Ga(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ia,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ia,i=arguments.length>4?arguments[4]:void 0;if(!e.state.constraints.tilt)return 0;var a=t.distance,o=e.state.constraints.tilt(a,to);return Xa(e,n,o),r.interactionType===ji.TUMBLE&&na(r.selection,Wi.ALTITUDE)&&Qa(e,r.interactionStartCamera,o),n.tiltMode===qi.LOOK_AROUND||r.tiltMode===qi.LOOK_AROUND?ja(e,t,o,i):Wa(e,t,o)}function Wa(e,t,n){var r=Ha(e.renderCoordsHelper,t.center,t.eye),i=r-(0,Se.uZ)(r,n.min,n.max);return qa(i)?i:0}function ja(e,t,n,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,n,r){var i,a,o=function(e,t,n){var r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,i=r+(0,qt.Iu)(e.spatialReference).radius,a=e.renderCoordsHelper.intersectManifold(t.ray,r,$a);return n.eyeCenterDistance=t.distance,n.centerIsOnSurface=!1,(0,k.pC)(a)?(n.eyeCenterDistance=(0,Gt.i)(t.eye,a),n.tiltAtCenter=Ha(e.renderCoordsHelper,a,t.eye),n.centerIsOnSurface=!0):e.state.isLocal?n.tiltAtCenter=Ha(e.renderCoordsHelper,t.center,t.eye):((0,ea.b)((0,ea.e)(ea.t,i),t.ray,$a),n.eyeCenterDistance=(0,Gt.i)(t.eye,$a),n.tiltAtCenter=(0,Se.ZF)(-(0,Gt.e)(t.viewForward,(0,Gt.n)($a,$a)))),n.radius=i,n.eyeRadius=(0,Gt.l)(t.eye),n.constraints=e.state.constraints,n}(e,t,no),s=(0,Se.uZ)(o.tiltAtCenter,n.min,n.max);return qa(o.tiltAtCenter-s)?(o.centerIsOnSurface?(i=function(e){var t=e.constraints,n=e.eyeCenterDistance,r=e.tiltAtCenter,i=r,a=t.clampTilt(n,r),o=Ya(e,a);if(t.clampTilt(o,r)===a)return a;for(var s=0;s<10&&qa(a-i);){var l=(i+a)/2,u=Ya(e,l);qa(t.clampTilt(u,l)-l)?i=l:a=l,s++}return a}(o),a=function(e,t){var n=(0,Se.Kt)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=(0,Se.Kt)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?n-r:r-n}(o,i)):(i=o.constraints.clampTilt(o.eyeCenterDistance,o.tiltAtCenter),r&&i<Math.PI/2&&(r.requiresTwoSteps=!0,i=Math.PI/2-1e-5),a=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(o,i)),r&&(r.eyeCenterDistance=Ya(o,i)),a):0}(e,t,n,r);case"local":return function(e,t,n,r){var i=Ha(e.renderCoordsHelper,t.center,t.eye),a=(0,Se.uZ)(i,n.min,n.max),o=i-a;if(!qa(o))return 0;if(r){var s=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=e.renderCoordsHelper.getAltitude(t.eye)-s,u=Math.cos(a);Math.abs(u)>1e-4?r.eyeCenterDistance=l/u:r.eyeCenterDistance=t.distance}return o}(e,t,n,r)}}function qa(e){return Math.abs(e)>1e-9}function Ya(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;var n=Math.PI-(0,Se.uZ)(t,0,Math.PI),r=(0,Se.Kt)(e.radius/e.eyeRadius*Math.sin(n)),i=Math.PI-n-r,a=Math.sin(i)/Math.sin(n);if(e.eyeRadius<e.radius&&a>1){var o=Math.PI-r,s=Math.PI-n-o;return Math.sin(s)/Math.sin(n)*e.eyeRadius}return a*e.eyeRadius}function Xa(e,t,n){if(t.interactionType!==ji.NONE){var r=t.interactionStartCamera,i=t.interactionFactor;if(r){var a=n.min,o=n.max,s=Ga(e,r,ia,t),l=0===s?0:Ha(e.renderCoordsHelper,r.center,r.eye);n.min=a,n.max=o,t.interactionType===ji.TUMBLE?(na(t.selection,Wi.ALTITUDE)&&Qa(e,r,n),ra(s,l,!0,i,eo,n)):ra(s,l,!1,i,eo,n)}}}function Qa(e,t,n){var r=e.state.constraints;if(!e.state.isLocal&&r.altitude&&t){var i=(0,Gt.p)(t.center),a=Math.sqrt(i),o=t.distance,s=(0,qt.Iu)(e.spatialReference).radius,l=r.altitude.min+s,u=r.altitude.max+s,c=(l*l-o*o-i)/(-2*a*o),h=(u*u-o*o-i)/(-2*a*o);n.min=Math.max(n.min,Math.min(Math.PI-(0,Se.ZF)(h),n.max)),n.max=Math.min(n.max,Math.PI-(0,Se.ZF)(c))}}var Ja=(0,F.c)(),Ka=(0,Cn.c)(),$a=(0,F.c)(),eo=(0,Se.Vl)(5),to={min:0,max:0},no={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},ro={eyeCenterDistance:0,requiresTwoSteps:!1};var io=function(e){return e*e},ao=function(e){return 1-io(1-e)},oo=function(e){return e*e*e},so=function(e){return 1-oo(1-e)},lo=function(e){return e<.5?oo(2*e)/2:(so(2*(e-.5))+1)/2},uo=function(e){return e*e*e*e},co=function(e){return 1-uo(1-e)},ho=function(e){return e*e*e*e*e},fo=function(e){return 1-ho(1-e)},po=function(e){return 1-Math.cos(e*Math.PI/2)},vo=function(e){return 1-po(1-e)},mo=function(e){return Math.pow(2,10*(e-1))},_o=function(e){return 1-mo(1-e)},yo=function(e){return-(Math.sqrt(1-e*e)-1)},go=function(e){return 1-yo(1-e)};function bo(e){var t=2*(e-Math.sqrt((e-1)*e)),n=t/2/e;return function(r){return r<n?e*r*r:t*r-t+1}}function wo(e,t){return function(n,r){return n<t?t*e(n/t,r):1-e((1-n)/(1-t),r)*(1-t)}}var Co=wo(bo(1),1),xo=wo(bo(1),0),To=wo(bo(1),.5),So=wo(bo(2),1),ko=wo(bo(2),0),Po=wo(bo(2),.5),Ro=wo(bo(3),1),Ao=wo(bo(3),0),Eo=wo(bo(3),.5),Oo=wo(bo(4),1),Mo=wo(bo(4),0),Zo=wo(bo(4),.5),Io={linear:function(e){return e},"in-quad":io,"out-quad":ao,"in-out-quad":function(e){return e<.5?io(2*e)/2:(ao(2*(e-.5))+1)/2},"in-coast-quad":Co,"out-coast-quad":xo,"in-out-coast-quad":To,"in-cubic":oo,"out-cubic":so,"in-out-cubic":lo,"in-coast-cubic":So,"out-coast-cubic":ko,"in-out-coast-cubic":Po,"in-quart":uo,"out-quart":co,"in-out-quart":function(e){return e<.5?uo(2*e)/2:(co(2*(e-.5))+1)/2},"in-coast-quart":Ro,"out-coast-quart":Ao,"in-out-coast-quart":Eo,"in-quint":ho,"out-quint":fo,"in-out-quint":function(e){return e<.5?ho(2*e)/2:(fo(2*(e-.5))+1)/2},"in-coast-quint":Oo,"out-coast-quint":Mo,"in-out-coast-quint":Zo,"in-sine":po,"out-sine":vo,"in-out-sine":function(e){return e<.5?po(2*e)/2:(vo(2*(e-.5))+1)/2},"in-expo":mo,"out-expo":_o,"in-out-expo":function(e){return e<.5?mo(2*e)/2:(_o(2*(e-.5))+1)/2},"in-circ":yo,"out-circ":go,"in-out-circ":function(e){return e<.5?yo(2*e)/2:(go(2*(e-.5))+1)/2}};function Do(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Uo,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(var a=!1,o=0;o<Vo;o++){var s,l=0,u=(0,i.Z)(Fo);try{for(u.s();!(s=u.n()).done;){var c=s.value;if(na(n.selection,c.type)){var h=Math.abs(c.error(e,r,n));c.apply(e,r,n)&&(a=!0,l+=h)}}}catch(p){u.e(p)}finally{u.f()}if(0===l)break}var d=na(n.selection,Wi.COLLISION),f=Lo(n.interactionType,e);return d&&Fa(e,r,f)&&(a=!0),a&&r.computeUp(e.state.viewingMode),a}function Lo(e,t){switch(e){case ji.PAN:return Ma.EYE_AND_CENTER;case ji.ASCEND:return t.state.isGlobal?Ma.EYE_AND_CENTER_SCALE:Ma.EYE_AND_CENTER;default:return Ma.EYE}}function No(e){var t=Math.min(1,e/150);return lo(t)}var Fo=[{type:Wi.TILT,error:function(e,t,n){return Ga(e,t,n)*t.distance},apply:function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ia,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];ro.eyeCenterDistance=0,ro.requiresTwoSteps=!1;var a=Ga(t,n,r,void 0,ro);if(0===a)return!1;switch((0,wn.d)(Ka,-a,n.viewRight),r.tiltMode){case qi.LOOK_AROUND:(0,Gt.m)(Ja,n.viewForward,Ka),(0,Gt.g)(Ja,Ja,ro.eyeCenterDistance),n.center=(0,Gt.a)($a,n.eye,Ja);break;case qi.TUMBLE:(0,Gt.b)(Ja,n.center,n.eye),(0,Gt.m)(Ja,Ja,Ka),n.eye=(0,Gt.b)($a,n.center,Ja);break;default:(0,Ue.Bg)(r.tiltMode)}return n.up=(0,Gt.m)($a,n.up,Ka),!ro.requiresTwoSteps||!i||e(t,n,r,!1)}},{type:Wi.ALTITUDE,error:sa,apply:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ia,r=sa(e,t,n);if(0===r)return!1;var i=e.renderCoordsHelper,a=i.getAltitude(t.eye)+r,o=aa(t,n.interactionDirection,ca(e,t,Math.sign(r),pa),fa),s=(0,Gt.c)(va,t.viewForward),l=i.intersectInfiniteManifold((0,ta.re)(t.eye,o),a,ma);return t.eye=(0,k.pC)(l)?l:i.setAltitude(ma,a,t.eye),t.center=(0,oa.W8)(ma,t.eye,s,t.center),!0}},{type:Wi.DISTANCE,error:_a,apply:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ia,r=_a(e,t,n);if(0===r)return!1;var i=e.pointsOfInterest.surfaceOrigin;if(!i.renderLocation)return!1;var a=ga(e,t)+r,o=(0,Gt.c)(Ca,t.eye),s=aa(t,n.interactionDirection,ba(t,i.renderLocation,Sa),Ta);if(!(0,ea.i)((0,ea.k)(i.renderLocation,a),(0,ta.re)(t.eye,s),ka))return!1;t.eye=ka;var l=(0,Gt.b)(xa,t.eye,o);t.center=(0,Gt.a)(ka,t.center,l);var u=e.renderCoordsHelper.getAltitude(t.center),c=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,u,ka);return(0,k.pC)(c)&&(t.center=c),!0}}],Uo={selection:Wi.ALL,interactionType:ji.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:qi.TUMBLE},Vo=5,Ho=n(11873),zo=(0,F.c)(),Bo=(0,F.c)(),Go=(0,F.c)(),Wo=(0,F.c)(),jo=(0,F.c)(),qo=(0,F.c)(),Yo={upward:(0,F.f)(0,0,1),forward:(0,F.f)(0,1,0),sideway:(0,F.f)(1,0,0)},Xo=(0,Ho.c)(),Qo=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:he.JY.Global;(0,s.Z)(this,e),this.viewingMode=t,this.center=(0,F.c)(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=(0,F.a)(Yo.forward)}return(0,l.Z)(e,[{key:"pixelsPerPanAtZoom",value:function(e){return this.size/2/(this._zoomToPanScale*e)}},{key:"zoomAtPixelsPerPan",value:function(e){return this.size/2/(this._zoomToPanScale*e)}},{key:"pixelsPerRotateAtZoom",value:function(){var e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}},{key:"compareTo",value:function(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===he.JY.Global){var n=((0,Gt.l)(this.center)+(0,Gt.l)(e.center))/2;t.pan=(0,Pe.EU)(this.center,e.center)*n}else t.pan=(0,Gt.i)(this.center,e.center);var r=Math.abs(e.yaw-this.yaw);r>=Math.PI&&(r=2*Math.PI-r);var i=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(r,i),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}},{key:"interpolate",value:function(e,t,n){this.viewingMode===he.JY.Global?(0,Pe.ZA)(e.center,t.center,n.pan,this.center):(0,Gt.h)(this.center,e.center,t.center,n.pan),this.distance=isFinite(t.distance)?(0,Se.t7)(e.distance,t.distance,n.zoom):e.distance,this.pitch=(0,Se.t7)(e.pitch,t.pitch,n.rotate);var r=e.yaw,i=t.yaw;Math.abs(i-r)>=Math.PI&&(r+=2*(r<i?1:-1)*Math.PI),this.yaw=(0,Se.t7)(r,i,n.rotate)}},{key:"copyFrom",value:function(e){(0,Gt.c)(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,(0,Gt.c)(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}},{key:"copyFromRenderCamera",value:function(e){var t=this._lookAtOrientation(e.center,Xo);(0,Gt.c)(this.center,e.center),(0,Gt.b)(Wo,e.center,e.eye),(0,Gt.t)(Wo,Wo,t),(0,Gt.t)(jo,e.up,t),this.distance=(0,Gt.l)(Wo),0!==this.distance&&(Wo[0]/=this.distance,Wo[1]/=this.distance,Wo[2]/=this.distance),this.pitch=this._eyeUpToPitch(Wo),this.yaw=this._eyeUpToYaw(Wo,jo),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}},{key:"copyFromCommon",value:function(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}},{key:"copyToRenderCamera",value:function(e){var t=this._lookAtOrientation(this.center,Xo);(0,bn.t)(t,t),this._axisAngleVec3(Yo.sideway,this.pitch-Math.PI/2,Yo.forward,Wo),this._axisAngleVec3(Yo.upward,this.yaw,Wo),this._axisAngleVec3(Yo.sideway,this.pitch-Math.PI/2,Yo.upward,jo),this._axisAngleVec3(Yo.upward,this.yaw,jo),(0,Gt.g)(Wo,Wo,this.distance),(0,Gt.t)(Wo,Wo,t),(0,Gt.t)(jo,jo,t),e.center=this.center,e.eye=(0,Gt.b)(Wo,this.center,Wo),e.up=jo}},{key:"_axisAngleVec3",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:n,i=Math.cos(t),a=Math.sin(t);return(0,Gt.g)(zo,n,i),(0,Gt.f)(Bo,e,n),(0,Gt.g)(Bo,Bo,a),(0,Gt.g)(Go,e,(1-i)*(0,Gt.e)(e,n)),(0,Gt.a)(r,(0,Gt.a)(r,zo,Bo),Go)}},{key:"_lookAtOrientation",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Ho.c)();return this._upAtLookAt(e,Go),(0,Gt.f)(zo,this.lookAtDirection,Go),(0,Gt.n)(zo,zo),0===zo[0]&&0===zo[1]&&0===zo[2]&&(0,Gt.c)(zo,Yo.sideway),(0,Gt.f)(Bo,Go,zo),(0,Gt.n)(Bo,Bo),t[0]=zo[0],t[1]=Bo[0],t[2]=Go[0],t[3]=zo[1],t[4]=Bo[1],t[5]=Go[1],t[6]=zo[2],t[7]=Bo[2],t[8]=Go[2],t}},{key:"_upAtLookAt",value:function(e,t){return this.viewingMode===he.JY.Local?(0,Gt.c)(t,Yo.upward):(0,Gt.n)(t,e)}},{key:"_eyeUpToPitch",value:function(e){return Math.PI-(0,Pe.EU)(Yo.upward,e)}},{key:"_eyeUpToYaw",value:function(e,t){var n=qo;return Math.abs(t[2])<.5?((0,Gt.c)(n,t),e[2]>0&&(0,Gt.g)(n,n,-1)):(0,Gt.c)(n,e),(0,Gt.f)(Bo,n,Yo.upward),(0,Gt.n)(Bo,Bo),(0,Pe.EU)(Yo.sideway,Bo,Yo.upward)}}]),e}(),Jo=n(86755),Ko=2,$o=(0,lr.HA)(500),es=(0,lr.HA)(8e3),ts=function(){function e(t){(0,s.Z)(this,e),this._createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:Ko},this.source=t(),this.target=t()}return(0,l.Z)(e,[{key:"clone",value:function(){var t=new e(this._createCamera);return t.copyFrom(this),t}},{key:"copyFrom",value:function(e){this.update(e.source,e.target,e.settings)}},{key:"update",value:function(e,t,n){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=n.desiredScreenFlow?n.desiredScreenFlow:Ko,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}},{key:"halfWindowPanAtZoom",value:function(e){var t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}},{key:"hasZoom",get:function(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}},{key:"hasPan",get:function(){return this.compared.pan>1e-9}},{key:"hasRotate",get:function(){return this.compared.rotate>1e-9}}]),e}(),ns=n(29439),rs=function(){function e(){(0,s.Z)(this,e),this.segments=[]}return(0,l.Z)(e,[{key:"time",get:function(){return this.segments.reduce((function(e,t){return(0,lr._H)(e+t.time)}),(0,lr._H)(0))}},{key:"interpolateComponentsAt",value:function(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;for(var n=0,r=0,i=this.definition,a=0;a<this.segments.length;a++){var o=this.segments[a],s=o.definition;if(e<=o.time||a===this.segments.length-1){if(t=this.segmentInterpolateComponentsAt(o,0===o.time?0:e/o.time,t),i.hasPan&&!isNaN(t.pan)&&isFinite(i.compared.pan)?t.pan=(n+s.compared.pan*t.pan)/i.compared.pan:t.pan=1,i.hasRotate&&!isNaN(t.rotate)&&isFinite(i.compared.rotate)?t.rotate=(r+s.compared.rotate*t.rotate)/i.compared.rotate:t.rotate=1,i.hasZoom&&!isNaN(t.zoom)&&isFinite(s.compared.targetZoom)){var l=t.zoom*(s.compared.targetZoom-s.compared.sourceZoom)+s.compared.sourceZoom,u=this.segments[0].definition.compared.sourceZoom,c=this.segments[this.segments.length-1].definition.compared.targetZoom;t.zoom=(l-u)/(c-u)}else t.zoom=1;return t}e-=o.time,n+=s.compared.pan,r+=s.compared.rotate}}},{key:"segmentInterpolateComponentsAt",value:function(e,t,n){return e.interpolateComponentsAt(t,n)}}]),e}(),is=function(){function e(t){(0,s.Z)(this,e),t&&this.update(t)}return(0,l.Z)(e,[{key:"time",get:function(){return this._time}},{key:"update",value:function(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}},{key:"_updatePrecomputedVariables",value:function(){var e=this.definition,t=e.compared,n=t.sourceZoom,r=t.targetZoom;this._zoomSign=n>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(n);var i=(e.source.pixelsPerRotateAtZoom(n)+e.target.pixelsPerRotateAtZoom(r))/2;this._rotatePixels=t.rotate*i}},{key:"_updatePixelFlow",value:function(){var e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,n=this.definition,r=n.hasZoom,i=n.hasPan,a=n.hasRotate,o=0,s=0;r&&(i&&(o=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),a&&(s=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;var l=this.definition.desiredPixelFlow;if(r&&i&&a){var u=o+s+o*s;this._zoomPixelFlow=o*s/u*l,this._panPixelFlow=s/u*l,this._rotatePixelFlow=o/u*l}else if(r&&i){var c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(r&&a){var h=1+s;this._zoomPixelFlow=s/h*l,this._rotatePixelFlow=1/h*l}else if(i&&a){var d=this._panPixelsAtSource/this._rotatePixels,f=1+d;this._panPixelFlow=d/f*l,this._rotatePixelFlow=1/f*l}else i?this._panPixelFlow=l:r?this._zoomPixelFlow=l:a&&(this._rotatePixelFlow=l);this._time=a?this.rotateTime:r?this.zoomTime:i?this.panTime:(0,lr._H)(0)}},{key:"rotateTime",get:function(){return this.definition.hasRotate?(0,lr._H)(this._rotatePixels/this._rotatePixelFlow):(0,lr._H)(0)}},{key:"zoomTime",get:function(){return this.definition.hasZoom?(0,lr._H)(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):(0,lr._H)(0)}},{key:"panTime",get:function(){if(this.definition.hasPan){if(this.definition.hasZoom){var e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return(0,lr._H)(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return(0,lr._H)(this._panPixelsAtSource/this._panPixelFlow)}return(0,lr._H)(0)}},{key:"_interpolateComponentsZoom",value:function(e){if(0===e||1===e)return e;if(this.definition.hasZoom){var t=this.definition.compared.sourceZoom,n=this.definition.compared.targetZoom;return(t*Math.pow(t/n,-e)-t)/(n-t)}return e}},{key:"_interpolateComponentsPan",value:function(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){var t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(Math.pow(2,t*e*this._time)-1))/(t*Math.LN2)}return e}},{key:"_interpolateComponentsRotate",value:function(e){return e}},{key:"interpolateComponentsAt",value:function(e,t){e=Math.min(Math.max(e,0),1);var n=this._interpolateComponentsZoom(e),r=this._interpolateComponentsPan(e),i=this._interpolateComponentsRotate(e);return t?(t.zoom=n,t.pan=r,t.rotate=i):t={zoom:n,pan:r,rotate:i},t}}]),e}();function as(e,t,n){var r=t-e.compared.sourceZoom,i=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(n.ascensionFactor*Math.LN2*e.compared.pan+i)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*i)}function os(e,t,n){var r=1/t,i=Math.log(e.compared.sourceZoom*r),a=1/e.desiredPixelFlow,o=1/Math.LN2,s=t-e.compared.sourceZoom,l=1/s,u=(n.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(s))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*a*o*l*u-e.halfWindowSize*i*a*o*l+e.halfWindowSize*i*a*o*u/(s*s)}function ss(e,t,n){var r=t-e.compared.sourceZoom,i=1/r,a=1/t,o=Math.log(e.compared.sourceZoom*a),s=(n.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*i*(-2*i*a*s+2*i*o+2*a-2*o*s/(r*r)-s/(t*t))/(e.desiredPixelFlow*Math.LN2)}function ls(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function us(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function cs(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function hs(e,t,n){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-n.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function ds(e,t,n){var r=Math.log(t/e.compared.targetZoom),i=1/e.desiredPixelFlow,a=1/Math.LN2,o=-t+e.compared.targetZoom,s=1/o,l=(-e.halfWindowPanAtZoom(t)-n.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*i*a*s+e.halfWindowSize*r*i*a*l/(o*o)+e.halfWindowSize*i*a*s*l/t}function fs(e,t,n){var r=t-e.compared.targetZoom,i=1/r,a=1/t,o=Math.log(t/e.compared.targetZoom),s=(e.halfWindowPanAtZoom(t)+n.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*i*(-2*i*a*s-2*i*o+2*a+2*o*s/(r*r)-s/(t*t))/(e.desiredPixelFlow*Math.LN2)}function ps(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function vs(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function ms(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function _s(e,t){var n,r=function(e,t){var n=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<n?null!=t.maximumDistance?n+(t.maximumDistance-n)/2:1.5*n:t.maximumDistance?Math.min(t.maximumDistance,r):r}(e,t),i={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},a=0===i.ascensionFactor,o=0===i.descensionFactor,s=a?ls:as,l=a?us:os,u=a?cs:ss,c=o?ps:hs,h=o?vs:ds,d=o?ms:fs,f=function(t){return s(e,t,i)+function(e,t,n){return-e.compared.pan*e.halfWindowSize*(n.ascensionFactor+n.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,i)+c(e,t,i)},p=function(t){return l(e,t,i)+function(e,t,n){return e.compared.pan*e.halfWindowSize*(n.ascensionFactor+n.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,i)+h(e,t,i)},v=function(t){return u(e,t,i)+function(e,t,n){return-2*e.compared.pan*e.halfWindowSize*(n.ascensionFactor+n.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,i)+d(e,t,i)},m=f(r),_=function(e){var t=Math.LN2*e.compared.pan,n=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(n),i=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?i*(t-r):i*(t+r)}(e),y=t.maximumIterations||20,g=null!=t.maximumDistance?t.maximumDistance:1/0;for(n=0;n<y;n++){var b=(p(r)+1e-6)/v(r);if(isNaN(b)||r>=g&&b<0){if(!isFinite(g))return null;m=f(r=g);break}if((r-=b)<e.compared.sourceZoom||r<e.compared.targetZoom)return null;var w=f(r);if(Math.abs(w-m)/m<=.005)break;m=w}return m>.7*_||r<e.compared.sourceZoom||r<e.compared.targetZoom?null:r}var ys,gs=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this))._preallocSegments=[new is,new is,new is],i._ascensionSegment=null,i._descensionSegment=null,i.update(e,r),i}return(0,l.Z)(n,[{key:"update",value:function(e,t){if(e){this.definition?this.definition.copyFrom(e):this.definition=e.clone();var n=null;t&&t.apex&&(n=_s(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==n?this._updateWithoutApex():this._updateWithApex(n,null===t||void 0===t?void 0:t.apex)}}},{key:"segmentInterpolateComponentsAt",value:function(e,t,n){return n=e.interpolateComponentsAt(t,n),e===this._ascensionSegment?n.zoom=ao(n.zoom):e===this._descensionSegment&&(n.zoom=io(n.zoom)),n}},{key:"_updateWithApex",value:function(e,t){var n,r=(0,ns.Z)(this._preallocSegments,3),i=r[0],a=r[1],o=r[2],s=null!==(n=null===t||void 0===t?void 0:t.ascensionFactor)&&void 0!==n?n:.5,l=Math.min(1-s,null!=(null===t||void 0===t?void 0:t.ascensionFactor)&&null!=t.descensionFactor?t.descensionFactor:.5),u=1-s-l;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*s,i.definition.compared.rotate=this.definition.compared.rotate*s,i.update(),this._ascensionSegment=i,this.segments.push(i),u>0&&(a.definition?a.definition.copyFrom(this.definition):a.definition=this.definition.clone(),a.definition.copyFrom(this.definition),a.definition.compared.sourceZoom=e,a.definition.compared.targetZoom=e,a.definition.compared.pan=this.definition.compared.pan*u,a.definition.compared.rotate=this.definition.compared.rotate*u,a.update(),this.segments.push(a)),o.definition?o.definition.copyFrom(this.definition):o.definition=this.definition.clone(),o.definition.compared.sourceZoom=e,o.definition.compared.pan=this.definition.compared.pan*l,o.definition.compared.rotate=this.definition.compared.rotate*l,o.update(),this._descensionSegment=o,this.segments.push(o)}},{key:"_updateWithoutApex",value:function(){var e=(0,ns.Z)(this._preallocSegments,1)[0];e.update(this.definition),this.segments.push(e)}}]),n}(rs),bs={zoom:0,pan:0,rotate:0},ws=function(){function e(t){(0,s.Z)(this,e),this._createCamera=t,this._time=(0,lr.HA)(0),this.definition=new ts(t),this.path=new gs}return(0,l.Z)(e,[{key:"time",get:function(){return this._time}},{key:"update",value:function(e,t,n){this.definition.update(e,t,n),this.path.update(this.definition,n),this._time=this._applyTimeSettings((0,lr.up)(isFinite(this.path.time)?this.path.time:(0,lr._H)(0)),n),this._easing=n.easing?n.easing:this._time>=1e3?To:_o}},{key:"cameraAt",value:function(e,t){t=t||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);var n=this.path.interpolateComponentsAt(e,bs);return t.interpolate(this.definition.source,this.definition.target,n),t}},{key:"_normalizedEasing",value:function(e){var t=this._easing(0,this._time),n=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(n-t)}},{key:"_applyTimeSettings",value:function(e,t){var n=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e=(0,lr.HA)(e/n));var r=null!=t.minDuration?t.minDuration:$o/n,i=null!=t.maxDuration?t.maxDuration:es/n;return(0,lr.HA)(Math.min(Math.max(r,e),i))}}]),e}(),Cs=(0,F.c)(),xs=function(){function e(t){(0,s.Z)(this,e),this.currentTime=(0,lr.HA)(0),this._animation=new ws((function(){return new Qo(t)})),this._current=new Qo(t)}return(0,l.Z)(e,[{key:"finished",get:function(){return this.currentTime>=this._animation.time}},{key:"time",get:function(){return this._animation.time}},{key:"update",value:function(e,t,n){var r=this._animation.definition.source,i=this._animation.definition.target,a=(0,Gt.b)(Cs,t.center,e.center),o=(0,Gt.l)(a);o>=1e-5?(a[0]/=o,a[1]/=o,a[2]/=o):(a[0]=0,a[1]=1,a[0]=0),(0,Gt.c)(r.lookAtDirection,a),(0,Gt.c)(i.lookAtDirection,a),r.copyFromRenderCamera(e),i.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,i,n),this.currentTime=(0,lr.HA)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}},{key:"cameraAt",value:function(e,t){return this._animation.cameraAt(e,this._current),t=t||new Jo.V,this._current.copyToRenderCamera(t),t}},{key:"step",value:function(e,t){return this.finished||(this.currentTime=(0,lr.HA)(this.currentTime+(0,lr.up)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}]),e}();!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(ys||(ys={}));var Ts=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).state=ys.Ready,r}return(0,l.Z)(n,[{key:"active",get:function(){return this.state===ys.Running}},{key:"isInteractive",get:function(){return!1}},{key:"canStop",get:function(){return!1}},{key:"stopController",value:function(){return!!this.canStop&&(this.state=ys.Stopped,!0)}},{key:"finishController",value:function(){this.state=ys.Finished}},{key:"steppingFinished",get:function(){return!1}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ts.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ts.prototype,"active",null),(0,p._)([(0,Z.Cb)()],Ts.prototype,"state",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ts.prototype,"isInteractive",null);var Ss=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._asyncResult=null,e}return(0,l.Z)(n,[{key:"canStop",get:function(){return!0}},{key:"asyncResult",get:function(){return this._asyncResult},set:function(e){this._asyncResult&&(this._asyncResult.reject((0,R.zE)()),this._asyncResult=null),this.state===ys.Finished||this.state===ys.Stopped?((0,k.O3)(e),this.state===ys.Finished?e.resolve():e.reject((0,R.zE)())):this._asyncResult=e}},{key:"onControllerStart",value:function(){var e=this;this.state=ys.Running,(0,k.pC)(this.viewAnimation)&&this.viewAnimation.when((function(){return e.updateStateFromViewAnimation()}),(function(){return e.updateStateFromViewAnimation()}))}},{key:"updateStateFromViewAnimation",value:function(){!(0,k.pC)(this.viewAnimation)||this.state!==ys.Ready&&this.state!==ys.Running||(this.viewAnimation.state===ce.Z.State.FINISHED?this.finish():this.viewAnimation.state===ce.Z.State.STOPPED&&(this.state=ys.Stopped))}},{key:"onControllerEnd",value:function(){(0,k.pC)(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===ys.Finished?this.viewAnimation.finish():this.state===ys.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ys.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,R.zE)()))}},{key:"finish",value:function(){this.finishController()}}]),n}(Ts=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.CameraController")],Ts)),ks=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).mode="interaction",r._hasTarget=!1,r}return(0,l.Z)(n,[{key:"intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"initialize",value:function(){this.animation=new xs(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new ce.Z}},{key:"isInteractive",get:function(){return"interaction"===this.mode}},{key:"begin",value:function(e,t){this._hasTarget=!0;var n=this.animationSettings(t);Ps.copyFrom(this.view.state.camera);var r=(0,Pa.Z8)(this.view.state.viewingMode);this.intersectionHelper.intersectRay(Ps.ray,r,Rs)&&(Ps.center=Rs),this.animation.update(Ps,e,n),this.animation.finished&&this.finish()}},{key:"finish",value:function(){this.animation.currentTime=this.animation.time,(0,c.Z)((0,h.Z)(n.prototype),"finish",this).call(this)}},{key:"steppingFinished",get:function(){return this._hasTarget&&this.animation.finished}},{key:"stepController",value:function(e,t){this._hasTarget&&this.animation.step(e,t)}},{key:"onControllerEnd",value:function(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),(0,c.Z)((0,h.Z)(n.prototype),"onControllerEnd",this).call(this,e)}},{key:"animationSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,r.Z)((0,r.Z)({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},e),{},{easing:"string"==typeof e.easing?Io[e.easing]:e.easing})}}]),n}(Ss=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.AnimationController")],Ss));(0,p._)([(0,Z.Cb)({constructOnly:!0})],ks.prototype,"mode",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],ks.prototype,"isInteractive",null),ks=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.PointToPointAnimationController")],ks);var Ps=new Jo.V,Rs=(0,F.c)(),As=n(17768),Es=n(48976),Os=n(98131),Ms=n(40927),Zs=n(51378);function Is(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Fs;return[e[0],e[1],e[2],e[3]]}function Ds(e,t){return Ls(e[0],e[1],e[2],t,Zs.o6.get())}function Ls(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Is();return i[0]=e,i[1]=t,i[2]=n,i[3]=r,i}function Ns(e,t,n){return(0,Gt.f)(n,e,t),(0,Gt.n)(n,n),n[3]=(0,Ms.EU)(e,t),n}var Fs=[0,0,1,0],Us=((0,Os.a)(),(0,Os.a)(),n(55652)),Vs=n(81703);function Hs(e,t,n,r){var i=(0,Vs.iE)(t,n,Bs);return(0,ea.i)(e,i,r)}var zs,Bs=(0,ta.Ue)(),Gs=n(76783);!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(zs||(zs={}));var Ws=[1,3e8],js=1508e5,qs={exclude:new Set([Gs.cy])};function Ys(e,t,n){return n[0]=t[0]/(e.fullWidth/e.pixelRatio),n[1]=t[1]/(e.fullHeight/e.pixelRatio),n}function Xs(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Qs(e,t,n){var r=(0,wn.d)(Zs.MP.get(),n[3],n);(0,k.Wi)(r)||(0,wn.j)(r,Cn.I)||((0,Gt.b)(Bl,e.eye,t),(0,Gt.m)(Bl,Bl,r),e.eye=(0,Gt.a)(Bl,Bl,t),(0,Gt.b)(Bl,e.center,t),(0,Gt.m)(Bl,Bl,r),e.center=(0,Gt.a)(Bl,Bl,t),e.up=(0,Gt.m)(Bl,e.up,r))}function Js(e,t,n,r){return(0,Us.BR)(e,(0,Vs.iE)(t,n,Yl),r)}function Ks(e,t,n,r){var i=Zs.WM.get(),a=1-n;(0,Gt.b)(i,t,e.eye);var o=(0,Gt.l)(i),s=o*(1-a);a>=0&&s<r&&(a=-((s=r)-o)/o),Math.abs(o-s)<1e-6||((0,Gt.g)(i,i,a),e.eye=(0,Gt.a)(Bl,e.eye,i),e.center=(0,Gt.h)(Bl,e.center,t,a))}function $s(e,t,n){t.getScreenCenter(tl),Hs(e,t,tl,Bl)&&(t.center=Bl);var r=t.distance,i=r*n;if(!(Math.abs(r-i)<1e-6)){var a=(0,Gt.g)(Zs.WM.get(),t.viewForward,i);t.eye=(0,Gt.b)(Bl,t.center,a)}}var el,tl=(0,O.s1)();function nl(e,t){(0,Gt.s)(t,0,0,0);var n,r=(0,i.Z)(e);try{for(r.s();!(n=r.n()).done;){var a=n.value;(0,Gt.a)(t,t,a)}}catch(o){r.e(o)}finally{r.f()}(0,Gt.g)(t,t,1/e.length)}function rl(e,t,n,r){return Math.sin(e/(0,Gt.l)(t))*(n+r.radius)}function il(e,t,n,r){return rl(Math.PI/2,t,n,r)+(e-Math.PI/2)}!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(el||(el={}));var al=3e4,ol=(0,Se.Vl)(16),sl=.95,ll=(0,Se.Vl)(18),ul=45,cl=(0,Se.Vl)(80);function hl(e,t,n,r,i,a){var o=(0,F.c)(),s=(0,ea.c)(),l=!0,u=!0;return e.intersectScreen(n,o,a)?s[3]=(0,Gt.l)(o):(u=!1,t.aboveGround&&i!==zs.Ellipsoid?s[3]=Math.max((0,Gt.l)(t.center),.9*r.radius):s[3]=(0,Gt.l)(t.eye)-t.relativeElevation,i===zs.Silhouette?vl(s,t,n,o):l=Hs(s,t,n,o)),{sphere:s,scenePickPoint:l?o:null,hasGeometryIntersection:u}}function dl(e,t,n){return(0,Gt.l)(e.eye)-n.radius>al?el.Horizontal:((0,Vs.iE)(e,t,Xl),-Math.sign(e.relativeElevation)*(.5*Math.PI+(0,Ms.EU)(e.eye,Xl.direction))<ol?el.Vertical:el.Horizontal)}function fl(e,t,n){(0,Gt.b)(pl,n,t),e.eye=(0,Gt.b)(Bl,e.eye,pl),e.center=(0,Gt.b)(Bl,e.center,pl)}var pl=(0,F.c)();function vl(e,t,n,r){var i=(0,Vs.iE)(t,n,Yl);return!(0,k.Wi)(i)&&((0,ea.b)(e,i,ml),(0,ea.i)(e,i,r)?!((0,Gt.d)(ml,i.origin)<(0,Gt.d)(r,i.origin))||((0,Gt.c)(r,ml),!1):((0,Gt.b)(_l,t.eye,t.center),(0,Gt.n)(_l,_l),(0,Us.Oy)(_l,-(0,Gt.e)((0,Gt.n)(_l,_l),ml),yl),(0,Us.BR)(yl,i,r),!1))}var ml=(0,F.c)(),_l=(0,F.c)(),yl=(0,Us.Ue)();function gl(e,t,n,r,i,a){var o=0;if((0,Gt.f)(jl,e,t),(0,Gt.b)(Gl,e,t),(0,Gt.l)(e)<=i||!r.aboveGround){(0,Gt.f)(n,Gl,r.eye);var s=(0,Gt.e)(e,t)/((0,Gt.l)(e)*(0,Gt.l)(t));if(s<.9999)o=(0,Se.ZF)(s);else{var l=(0,Gt.l)((0,Gt.f)((0,F.c)(),e,t))/((0,Gt.l)(e)*(0,Gt.l)(t));o=(0,Se.Kt)(l)}var u=Math.cos((0,Se.uZ)(As.Q4.normalize((0,Se.Vl)(a)),0,cl));o=-o-Math.max(0,(0,Gt.l)(t)-i)/(u*i)}else(0,Gt.b)(bl,r.eye,r.center),(0,Gt.f)(n,Gl,bl),o=-(0,Gt.l)(Gl)/i;return(0,Gt.n)(n,n),(0,Gt.g)(n,n,(0,Gt.l)(jl)),o}var bl=(0,F.c)();function wl(e,t,n,r){var i,a=Math.cos((0,Se.uZ)(As.Q4.normalize((0,Se.Vl)(r)),0,cl));return i=t>n?-(t-n)/(a*n):t<-n?Math.PI-(t+n)/(a*n):(0,Se.ZF)(t/n),((e>n?-(e-n)/(a*n):e<-n?Math.PI-(e+n)/(a*n):(0,Se.ZF)(e/n))-i)*n}function Cl(e,t,n,r,i,a,o,s,l,u){(0,Gt.f)(jl,e,t),(0,G.Tz)(a.up,a.eye,Ml,Zl,Il),(0,G.Tz)([0,0,1],a.eye,Al,El,Ol),(0,Gt.c)(n,El),(0,Gt.c)(r,Al),(0,Gt.n)(n,n),(0,Gt.g)(n,n,(0,Gt.l)(jl)),(0,G.yS)(e,(0,Gt.n)(Zl,Zl),(0,Gt.n)(Il,Il),(0,Gt.n)(Ml,Ml),Dl),(0,G.yS)(t,Zl,Il,Ml,Ll),function(e,t,n,r,i,a,o,s,l,u){var c=wl(e[2],t[2],a[3],s),h=l?wl(e[0],t[0],a[3],180):t[0]-e[0],d=Math.sin(o)*h-Math.cos(o)*c,f=Math.cos(o)*h+Math.sin(o)*c;(0,Gt.n)(Bl,i);var p=l?d/Math.sqrt(Math.abs(Math.pow(a[3],2)-Math.pow((0,Gt.e)(n,Bl),2))):d/a[3],v=f/Math.sqrt(Math.abs(Math.pow(a[3],2)-Math.pow((0,Gt.e)(n,r),2)));(0,Yt.s)(u,p,v)}(Dl,Ll,e,Al,El,o,s,l,u,i)}function xl(e,t,n,r,i,a,o){(0,wn.d)(Ul,i,r),(0,wn.d)(Vl,o,a),(0,wn.m)(Hl,Ul,Vl),(0,Gt.b)(t,e,n),(0,Gt.m)(t,t,Hl),(0,Gt.a)(t,t,n)}function Tl(e,t,n,r,i,a){(0,wn.d)(Ul,r,n),(0,wn.d)(Vl,a,i),(0,wn.m)(Hl,Ul,Vl),(0,Gt.b)(Bl,e.eye,t),(0,Gt.m)(Bl,Bl,Hl),e.eye=(0,Gt.a)(Bl,Bl,t),(0,Gt.b)(Bl,e.center,t),(0,Gt.m)(Bl,Bl,Hl),e.center=(0,Gt.a)(Bl,Bl,t),(0,Gt.b)(Bl,e.up,t),(0,Gt.m)(Bl,Bl,Hl),e.up=(0,Gt.a)(Bl,Bl,t)}function Sl(e,t,n,r,i,a){return(Math.abs(r)>Math.PI-ll||Math.abs(r)<ll)&&(Math.abs(e[2])<n*sl||Math.abs(t)>n)&&a.aboveGround&&i<ul}function kl(e,t,n,r,i,a){if(a)Ns(n,r,Fl),Qs(t,e,Fl);else{var o=gl(n,r,ql,t,e[3],i);Qs(t,e,Ds(ql,o))}}function Pl(e,t,n,r,i,a,o){var s,l=o?20:1;(0,Gt.c)(zl,r),Wl.copyFrom(t);for(var u=0;u<l&&(0,Gt.d)(n,zl)>1e-12&&(s=(0,Gt.d)(n,zl),Cl(n,zl,El,Al,Nl,Wl,e,i,a,o),Tl(Wl,e,Al,Nl[1],El,Nl[0]),xl(zl,zl,e,Al,Nl[1],El,Nl[0]),(0,Gt.d)(n,zl)<s||0===u);u++)t.copyFrom(Wl)}function Rl(e,t,n,r,i,a,o,s,l){Sl(e.center,(0,Gt.e)(e.up,e.center),(0,Gt.l)(e.center),-As.Q4.normalize((0,Se.Vl)(a)),o,t)?function(e,t,n,r,i,a){var o=e.eye;(0,G.Tz)([0,0,1],o,Al,El,Ol);var s=t.translation[0]*n.pan,l="zoom"===i.mode?0:t.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-Math.pow((0,Gt.e)(e.center,Al),2)/Math.pow((0,Gt.l)(e.center),2))),.5),c=(Math.sin(a)*l+Math.cos(a)*s)/u,h=-Math.cos(a)*l+Math.sin(a)*s;switch((0,wn.e)(r.pan.matrix,r.pan.matrix,c,Al),r.pan.enabled=!0,i.mode){case"pan":(0,wn.e)(r.pan.matrix,r.pan.matrix,h,El),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*n.zoom}}(t,n,r,s,l,-As.Q4.normalize((0,Se.Vl)(i))):function(e,t,n,r,i){var a=e.eye,o=e.viewRight,s=(0,Gt.f)(Zs.WM.get(),o,a),l=t.translation[0]*n.pan;switch(0!==l&&((0,wn.e)(r.pan.matrix,r.pan.matrix,-l,s),r.pan.enabled=!0),i.mode){case"pan":var u=t.translation[1]*n.pan;0!==u&&((0,wn.e)(r.pan.matrix,r.pan.matrix,u,o),r.pan.enabled=!0);break;case"zoom":r.zoom=-t.translation[1]*n.zoom}}(t,n,r,s,l)}var Al=(0,F.c)(),El=(0,F.c)(),Ol=(0,F.c)(),Ml=(0,F.c)(),Zl=(0,F.c)(),Il=(0,F.c)(),Dl=(0,F.c)(),Ll=(0,F.c)(),Nl=(0,Jt.a)(),Fl=Is(),Ul=(0,Cn.c)(),Vl=(0,Cn.c)(),Hl=(0,Cn.c)(),zl=(0,F.c)(),Bl=(0,F.c)(),Gl=(0,F.c)(),Wl=new Jo.V,jl=(0,F.c)(),ql=(0,F.c)(),Yl={origin:(0,F.c)(),direction:(0,F.c)()},Xl={origin:(0,F.c)(),direction:(0,F.c)()},Ql=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._zoomLocation=(0,F.c)(),e._tmpCamera=new Jo.V,e._tmpViewDir=(0,F.c)(),e._tmpRayDir={origin:(0,F.c)(),direction:(0,F.c)()},e._targetOnSphere=(0,F.c)(),e._tmpCenter=(0,F.c)(),e._constraintOptions={selection:Wi.ALL_EXCEPT_COLLISION,interactionType:ji.ZOOM,interactionFactor:null,interactionStartCamera:new Jo.V,interactionDirection:null,tiltMode:qi.TUMBLE},e._sphere=(0,ea.c)(),e}return(0,l.Z)(n,[{key:"initialize",value:function(){this._intersector=(0,Pa.Z8)(this.view.state.viewingMode)}},{key:"zoomStep",value:function(e,t){if(this.active){var n=this.view.state,r=this._constraintOptions.interactionStartCamera;r&&(this.animation.finished?r.copyFrom(n.camera):this.animation.cameraAt(1,r));var i=!1,a=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?qs:{})&&(i=e>0,a=!0),this._tmpCamera.copyFrom(n.camera),i?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Gt.c)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,a),this.begin(this._tmpCamera)}}},{key:"animationSettings",value:function(){return{duration:(0,lr.HA)(600),easing:_o}}},{key:"_updateCamera",value:function(e,t,n,r,i){var a=dl(e,r,(0,qt.Iu)(this.view.spatialReference)),o=Math.abs(this.view.camera.position.z);(0,Gt.n)(Kl,e.eye),(0,Gt.g)(Kl,Kl,-1),(0,Vs.iE)(e,r,this._tmpRayDir),(0,Gt.n)(this._tmpRayDir.direction,this._tmpRayDir.direction);var s=(0,Se.uZ)(Math.min(8,1/Math.abs((0,Gt.e)(Kl,this._tmpRayDir.direction)))*o,200,js);if(a===el.Horizontal){var l=Math.pow(.6,t);this._sphere[3]=(0,Gt.l)(n),(0,Gt.b)(this._tmpViewDir,e.center,e.eye);var u=Math.min((0,Gt.l)(this._tmpViewDir),s),c=u*l;if(l<=1&&c<4&&(l=(c=4)/u),Math.abs(u-c)<1e-6)return;var h=(0,Gt.l)(e.center);if(this._sphere[3]!==h){var d=this._sphere[3]+l*(h-this._sphere[3]);e.center=(0,Gt.g)(Jl,e.center,d/h)}(0,Gt.g)(this._tmpViewDir,this._tmpViewDir,-l),e.eye=(0,Gt.a)(Jl,e.center,this._tmpViewDir),Do(this.view,e,this._constraintOptions),(0,Gt.d)(n,e.center)>1e-12&&Hs(this._sphere,e,r,this._targetOnSphere)&&function(e,t,n,r,i,a,o){Sl(n,(0,Gt.e)(t.up,n),e[3],-As.Q4.normalize((0,Se.Vl)(i)),a,t)?Pl(e,t,n,r,-As.Q4.normalize((0,Se.Vl)(i)),a,o):kl(e,t,n,r,a,o)}(this._sphere,e,n,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{var f=Math.pow(.6,Math.abs(t)),p=t>0?1:-1;(0,Gt.b)(this._tmpViewDir,n,e.eye);var v=(0,Gt.l)(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,60),_=(0,k.pC)(m)?m:s;_=i&&t>0?Math.min(_,v):_,(0,Gt.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,_),(0,Gt.a)(n,this._tmpRayDir.origin,this._tmpRayDir.direction);var y=_*f,g=Math.max(4,1.01*e.nearFar[0]);if(t>0&&y<g&&(f=(y=g)/_),Math.abs(_-y)<1e-6)return;(0,Gt.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,p*(1-f)),e.eye=(0,Gt.a)(Jl,e.eye,this._tmpRayDir.direction),e.center=(0,Gt.a)(Jl,e.center,this._tmpRayDir.direction)}Fa(this.view,e)}}]),n}(ks);Ql=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.global.ZoomStepController")],Ql);var Jl=(0,F.c)(),Kl=(0,F.c)(),$l=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._zoomLocation=(0,F.c)(),e._tmpCamera=new Jo.V,e._tmpRayDir=(0,F.c)(),e._tmpCenter=(0,F.c)(),e._constraintOptions={selection:Wi.ALL,interactionType:ji.ZOOM,interactionFactor:null,interactionStartCamera:new Jo.V,interactionDirection:null,tiltMode:qi.TUMBLE},e}return(0,l.Z)(n,[{key:"zoomStep",value:function(e,t){if(this.active){var n=this.view.state,r=this._constraintOptions.interactionStartCamera;r&&(this.animation.finished?r.copyFrom(n.camera):this.animation.cameraAt(1,r)),this._tmpCamera.copyFrom(n.camera);var i=(0,Pa.Z8)(this.view.state.viewingMode),a=!1;e>0?(a=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,0===this.view.map.ground.opacity?qs:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,i,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,i,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Gt.c)(this._zoomLocation,this._tmpCamera.center);var o=Math.pow(.6,e),s=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],this.view.state.camera,60);(0,Gt.b)(nu,this._tmpCamera.eye,this._zoomLocation),(0,Gt.n)(nu,nu);var l=(0,Se.uZ)(Math.min(8,1/Math.abs((0,Gt.e)(tu,nu)))*Math.abs(this.view.camera.position.z),200,js);if(s=(0,k.pC)(s)?s:l){var u=(0,F.c)();(0,Gt.b)(u,this._zoomLocation,this._tmpCamera.eye),(s<(0,Gt.l)(u)||!a)&&((0,Gt.n)(u,u),(0,Gt.a)(this._zoomLocation,this._tmpCamera.eye,(0,Gt.g)(u,u,s)))}this._updateCamera(this._tmpCamera,o,this._zoomLocation),this.begin(this._tmpCamera)}}},{key:"animationSettings",value:function(){return{duration:(0,lr.HA)(600),easing:_o}}},{key:"_updateCamera",value:function(e,t,n){(0,Gt.b)(this._tmpRayDir,n,e.eye);var r=(0,Gt.l)(this._tmpRayDir),i=r*t,a=t<=1,o=Math.max(4,1.01*e.nearFar[0]);0!==i&&(a&&i<o&&(t=(i=o)/r),Math.abs(r-i)<1e-6||((0,Gt.g)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,Gt.b)(eu,n,this._tmpRayDir),e.center=(0,Gt.h)(eu,e.center,n,1-t),Do(this.view,e,this._constraintOptions)))}}]),n}(ks);$l=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.local.ZoomStepController")],$l);var eu=(0,F.c)(),tu=(0,F.f)(0,0,1),nu=(0,F.c)(),ru=n(45371),iu=n(41722),au=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this,!0))._view=e,i.registerIncoming("double-click",r,(function(e){return i._handleDoubleClick(e)})),i}return(0,l.Z)(n,[{key:"_handleDoubleClick",value:function(e){var t=e.data;if((0,iu.h)(t,"primary")){var n=this._view.state.isGlobal?new Ql({view:this._view,mode:"animation"}):new $l({view:this._view,mode:"animation"});this._view.state.switchCameraController(n),n.zoomStep(Math.log(.5)/Math.log(.6),(0,O.s1)(t.x,t.y)),e.stopPropagation()}}}]),n}(ru.a),ou=n(53866),su=n(81753),lu=n(68860);var uu=function(){function e(t,n){(0,s.Z)(this,e),this._elevationProvider=t,this._referenceEllipsoid=(0,qt.Iu)(n),this._unitInMeters=(0,lu.c9)(n,this._referenceEllipsoid.metersPerDegree)}return(0,l.Z)(e,[{key:"compute",value:function(e,t,n,r,i){var a;i||(i={near:0,far:0});var o=e[2]*this._unitInMeters,s=o,l=o-r,u=null===(a=this._elevationProvider)||void 0===a?void 0:a.visibleElevationBounds;u&&(o=l>=0?s-this._unitInMeters*u.min:this._unitInMeters*u.max-s);var c={x:(n=(0,k.pC)(n)?n:new ou.Z({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-n.xmin,y:n.ymax-n.ymin,z:4*Math.max(n.xmax-n.xmin,n.ymax-n.ymin)},h=Math.max(c.x,c.y,c.z);(0,Gt.b)(_u,t,e),mu[0]=_u[0]>0?n.xmax:n.xmin,mu[1]=_u[1]>0?n.ymax:n.ymin,mu[2]=_u[2]>0?h/2:-h/2,(0,Gt.b)(mu,mu,e),(0,Gt.n)(_u,_u);var d=1.1*(0,Gt.e)(mu,_u)*this._unitInMeters,f=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),p=Math.max(n.xmax-n.xmin,n.ymax-n.ymin),v=p*pu*this._unitInMeters,m=p*vu*this._unitInMeters,_=Math.pow((0,Se.uZ)((o-m)/(v-m),0,1),3),y=Math.min((0,Se.t7)(f,d,_),f)*Math.max(Math.log(Math.abs(l)),1);return hu(Math.min(y,Math.max(34064e4,h))/this._unitInMeters,du,this._unitInMeters,i)}}]),e}(),cu=function(){function e(t){(0,s.Z)(this,e),this._referenceEllipsoid=(0,qt.Iu)(t)}return(0,l.Z)(e,[{key:"compute",value:function(e,t,n,r,i){i||(i={near:0,far:0});var a=(0,Gt.l)(e),o=a-this._referenceEllipsoid.radius,s=this._referenceEllipsoid.radius+Math.min(0,r),l=Math.abs(o-r),u=Math.max(l,Math.abs(o)),c=Math.sqrt(u*(u+2*s)),h=a+this._referenceEllipsoid.radius;return hu(1.2*(0,Se.t7)(c,h,(0,Qt.yx)(u)),(0,Se.uZ)(2e4-(Math.log(u)-7.983)/9.011*19e3,1e3,2e4),1,i)}}]),e}();function hu(e,t,n,r){var i=fu/n;return e/t>i?(r.far=e,r.near=r.far/t):(r.near=i,r.far=r.near*t),r}var du=2e4,fu=2,pu=.001,vu=1e-4,mu=(0,F.c)(),_u=(0,F.c)(),yu=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){return(0,s.Z)(this,n),t.call(this,e)}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles(this.view.basemapTerrain.on("elevation-change",(function(t){return e._handleElevationChangeEvent(t)})))}},{key:"_handleElevationChangeEvent",value:function(e){if(!this.view.state.cameraController){var t=this.view.state.camera;(0,k.pC)(e.spatialReference)&&Ra(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}}},{key:"_applyToCurrentCamera",value:function(){var e=this;this.view.state.updateCamera((function(t){return Fa(e.view,t,Ma.EYE_AND_CENTER)}))}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],yu.prototype,"view",void 0),yu=(0,p._)([(0,L.j)("esri.views.3d.state.ElevationCollisionConstraint")],yu);var gu=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).nearFarHeuristic=function(e,t,n){return e===he.JY.Global?new cu(n):new uu(t,n)}(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference),r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([(0,A.YP)((function(){var t,n,r,i;return[null===(t=e.view.constraints)||void 0===t||null===(n=t.clipDistance)||void 0===n?void 0:n.near,null===(r=e.view.constraints)||void 0===r||null===(i=r.clipDistance)||void 0===i?void 0:i.far]}),(function(){return e._clipDistanceNearFarChanged()})),(0,A.YP)((function(){var t,n;return null===(t=e.view.constraints)||void 0===t||null===(n=t.clipDistance)||void 0===n?void 0:n.mode}),(function(){return e._updateNearFar()})),this.view.state.events.on("before-camera-change",(function(t){return e._updateCameraNearFar(t)})),(0,A.YP)((function(){return e.view.renderDataExtent}),(function(){return e._updateNearFar()}),A.Z_),(0,A.YP)((function(){var t,n,r,i;return[null===(t=e.view.constraints)||void 0===t||null===(n=t.altitude)||void 0===n?void 0:n.min,null===(r=e.view.constraints)||void 0===r||null===(i=r.altitude)||void 0===i?void 0:i.max]}),(function(){return e._updateAltitude()}),A.Z_),(0,A.YP)((function(){var t,n;return null===(t=e.view.constraints)||void 0===t||null===(n=t.tilt)||void 0===n?void 0:n.max}),(function(){return e._updateTiltMax()}),A.Z_),(0,A.YP)((function(){var t,n;return null===(t=e.view.constraints)||void 0===t||null===(n=t.tilt)||void 0===n?void 0:n.mode}),(function(){return e._updateTilt()}),A.Z_),(0,A.YP)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(){return e._updateTiltAutoMax()}),A.Z_),(0,A.YP)((function(){var t,n,r,i,a,o;return[null===(t=e.view.map)||void 0===t||null===(n=t.ground)||void 0===n||null===(r=n.navigationConstraint)||void 0===r?void 0:r.type,null===(i=e.view.state)||void 0===i||null===(a=i.constraints)||void 0===a||null===(o=a.collision)||void 0===o?void 0:o.enabled]}),(function(){return e._updateCollision()}),A.Z_)]),this.view.state.isLocal&&this.addHandles((0,A.YP)((function(){return e.view.renderDataExtent}),(function(t){return e._updateLocalSurfaceDistance(t)}),A.nn)),this._updateNearFar(),this.view.state.viewingMode!==he.JY.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new yu({view:this.view}))}},{key:"destroy",value:function(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}},{key:"_clipDistanceNearFarChanged",value:function(){var e,t=this,n=null===(e=this.view.constraints)||void 0===e?void 0:e.clipDistance;n&&"auto"!==n.mode&&this.view.state.updateCamera((function(e){return t._updateCameraNearFarManual(e,n)}))}},{key:"_updateNearFar",value:function(){var e=this;this.view.state.updateCamera((function(t){return e._updateCameraNearFar(t)}))}},{key:"_updateCameraNearFar",value:function(e){var t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}},{key:"_updateCameraNearFarAuto",value:function(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,Aa(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}},{key:"_updateCameraNearFarManual",value:function(e,t){t&&(e.near=t.near,e.far=t.far)}},{key:"_updateCollision",value:function(){var e,t,n,r=null===(e=this.view.map)||void 0===e||null===(t=e.ground)||void 0===t||null===(n=t.navigationConstraint)||void 0===n?void 0:n.type,i=!r||"stay-above"===r,a=this.view.state.constraints.collision;if(i!==a.enabled){a.enabled=i,i&&this._reapplyConstraints(Wi.COLLISION);var o=this.view.constraints&&this.view.constraints.tilt;o&&"auto"!==o.mode||this._updateTiltAuto()}}},{key:"_updateAltitude",value:function(){var e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==he.JY.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}},{key:"_updateTiltMax",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}},{key:"_updateTilt",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}},{key:"_updateTiltManual",value:function(e){var t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,Se.Vl)(e.max))}},{key:"_updateTiltAuto",value:function(){var e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}},{key:"_updateTiltAutoMax",value:function(){var e=this.view.constraints&&this.view.constraints.tilt;if(e&&"auto"===e.mode){var t=this.view.state.constraints;if(t.tilt){var n=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,Se.BV)(n))}}}},{key:"_updateLocalSurfaceDistance",value:function(e){if(!(0,k.Wi)(e)){var t=Math.max(e.width,e.height);if(!(t<=0)){null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));var n=this.view.state,r=3*t/Math.atan(n.camera.fov/2);r!==n.constraints.distance&&(n.constraints.distance=r)}}}},{key:"_reapplyConstraints",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Wi.ALL;this.view.state.updateCamera((function(n){return Do(e.view,n,{selection:t,interactionType:ji.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:qi.TUMBLE})}))}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],gu.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gu.prototype,"surfaceCollisionConstraint",void 0),gu=(0,p._)([(0,L.j)("esri.views.3d.state.ConstraintsManager")],gu);var bu=n(38161),wu=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r}return(0,l.Z)(n,[{key:"desiredCamera",set:function(e){this._set("desiredCamera",e.clone())}},{key:"canStop",get:function(){return!0}},{key:"constraintEnabled",get:function(){return this.view.state.constraints.collision.enabled}},{key:"onControllerStart",value:function(){var e=this;this.state=ys.Running,this._handles.add(this.view.basemapTerrain.on("elevation-change",(function(t){return e._handleElevationChangeEvent(t)}))),this._applyCorrection()}},{key:"onControllerEnd",value:function(){this._handles.removeAll()}},{key:"stepController",value:function(){}},{key:"_handleElevationChangeEvent",value:function(e){(0,k.pC)(e.spatialReference)&&!Ra(this.view,this.desiredCamera,e.extent,e.spatialReference)||this._applyCorrection()}},{key:"_applyCorrection",value:function(){var e=this;this.view.state.updateCamera((function(t){t.copyViewFrom(e.desiredCamera),Fa(e.view,t,Ma.EYE_AND_CENTER)||e.constraintEnabled||(e.state=ys.Stopped)}))}}]),n}(Ts);(0,p._)([(0,Z.Cb)({constructOnly:!0})],wu.prototype,"desiredCamera",null),wu=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],wu);var Cu=(0,F.c)(),xu=(0,F.c)();function Tu(){return{direction:(0,F.c)(),up:(0,F.c)()}}function Su(e,t,n,r,i){var a=(0,Gt.n)(Cu,e),o=(0,Gt.e)(a,r),s=o>0;(o=Math.abs(o))>.99&&((o=Math.abs((0,Gt.e)(t,r)))<.99?((0,Gt.c)(a,t),s&&(0,Gt.g)(a,a,-1)):a=null);var l=0;if(a){(0,Gt.g)(xu,r,(0,Gt.e)(r,a)),(0,Gt.b)(a,a,xu);var u=(0,Gt.e)(a,i)/((0,Gt.l)(a)*(0,Gt.l)(i));(0,Gt.f)(xu,a,i),l=((0,Gt.e)(xu,r)>0?1:-1)*(0,Se.BV)((0,Se.ZF)(u))}var c=(0,Se.BV)((0,Se.ZF)(-(0,Gt.e)(r,e)/(0,Gt.l)(e)));return n?(n.heading=l,n.tilt=c,n):{heading:l,tilt:c}}var ku=(0,F.f)(0,1,0),Pu=(0,F.f)(0,0,1),Ru=(0,Cn.c)(),Au=(0,F.c)(),Eu=(0,F.c)();function Ou(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Tu(),i=r.direction,a=r.up;return(0,wn.b)(Ru,-(0,Se.Vl)(t)),(0,wn.r)(Ru,Ru,(0,Se.Vl)(n)),(0,Gt.m)(i,Pu,Ru),(0,Gt.g)(i,i,-1),(0,Gt.m)(a,ku,Ru),r}function Mu(e,t,n,r,i){var a=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return(0,H.KC)(t,Au,a),(0,H.KC)(t,Eu,a),Au[0]-=n/2,Eu[0]+=n/2,Au[1]-=r/2,Eu[1]+=r/2,(0,H.SH)(Au,a,Au,o),(0,H.SH)(Eu,a,Eu,o),i?(i.xmin=Au[0],i.ymin=Au[1],i.xmax=Eu[0],i.ymax=Eu[1],i.spatialReference=o):i=new ou.Z(Au[0],Au[1],Eu[0],Eu[1],o),i}var Zu=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){return Su(t,n,r,Pu,ku)},eyeForCenterWithHeadingTilt:function(e,t,n,r){var i=Ou(e,n,r),a=(0,F.c)();return(0,Gt.g)(a,i.direction,-t),(0,Gt.a)(a,a,e),{up:i.up,eye:a,heading:n,tilt:r}},eyeTiltToLookAtTilt:function(e){return(0,Se.Vl)(e)},headingTiltToDirectionUp:Ou,lookAtTiltToEyeTilt:function(e){return(0,Se.BV)(e)},toExtent:Mu},Symbol.toStringTag,{value:"Module"})),Iu=(0,F.f)(0,0,1),Du=(0,Gt.n)((0,F.c)(),(0,F.f)(1,1,1)),Lu=new As.pE(-180,180),Nu=(0,Cn.c)(),Fu=(0,F.c)(),Uu=(0,F.c)();function Vu(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Tu();(0,Gt.f)(Fu,e,Iu),0===(0,Gt.e)(Fu,Fu)&&(0,Gt.f)(Fu,e,Du),(0,wn.d)(Nu,-(0,Se.Vl)(t),e),(0,wn.e)(Nu,Nu,-(0,Se.Vl)(n),Fu);var i=r.up,a=r.direction;return(0,Gt.f)(i,Fu,e),(0,Gt.n)(i,i),(0,Gt.m)(i,i,Nu),(0,Gt.n)(a,e),(0,Gt.o)(a,a),(0,Gt.m)(a,a,Nu),r}function Hu(e){var t=e[1];e[1]=-e[2],e[2]=t}function zu(e,t){var n=Vu(t,e.heading,e.tilt);return e.up=n.up,e}function Bu(e,t,n,r,i){var a,o,s,l,u=t.latitude,c=(0,qt.Iu)(e.spatialReference).radius,h=t.longitude,d=function(e,t,n){var r=t/n,i=(0,Se.Vl)(e),a=Math.sin(r/2),o=Math.cos(i),s=2*(0,Se.Kt)(Math.sqrt(a*a/(o*o)));return(0,Se.BV)(s)}(u,n,c)/2;a=h-d,o=h+d;var f=(0,Se.Vl)(u),p=(1+Math.sin(f))/(1-Math.sin(f)),v=(p+1)*Math.tan(r/c/2),m=v*v;function _(e){var t=Math.PI/2;return(e=As.c5.normalize(e,-t))>t&&(e=Math.PI-e),e}if(l=(s=1.5*Math.PI-2*Math.atan(.5*(v+Math.sqrt(4*p+m))))+r/c,s=_(s),(l=_(l))<s){var y=l;l=s,s=y}if(s=Math.max((0,Se.BV)(s),-90),l=Math.min((0,Se.BV)(l),90),(o=Lu.monotonic(a,o))-a>180){var g=(o-a-180)/2;a+=g,o-=g}var b=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:ee.Z.WGS84;return i?(i.xmin=a,i.ymin=s,i.xmax=o,i.ymax=l,i.spatialReference=b):i=new ou.Z(a,s,o,l,b),e.spatialReference&&e.spatialReference.isWebMercator&&(0,su.$)(i,!1,i),i}var Gu,Wu=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){var i=Fu,a=Uu;return(0,Gt.n)(i,e),(0,Gt.f)(Uu,i,Iu),0===(0,Gt.e)(Uu,Uu)&&(0,Gt.f)(Uu,i,Du),(0,Gt.f)(a,Uu,i),Su(t,n,r,i,a)},eyeForCenterWithHeadingTilt:function(e,t,n,r){var i={eye:(0,F.c)(),up:null,tilt:r,heading:n},a=Fu;a[0]=e[0],a[1]=e[2],a[2]=-e[1];var o,s=t,l=(0,Se.Vl)(n),u=(0,Se.Vl)(r),c=Math.sin(l),h=Math.cos(l),d=Math.sin(u),f=Math.cos(u),p=(0,Gt.l)(a);if(Math.abs(u)<1e-8)o=s+p;else{var v=p/d,m=(0,Se.Kt)(s/v),_=Math.PI-u-m;o=v*Math.sin(_)}var y=f*s,g=s*s*(d*d),b=h*h*g,w=o-y,C=w*w,x=b*(b+C-a[1]*a[1]);if(x<0)return(0,Gt.g)(i.eye,a,o/p),i.tilt=0,zu(i,e);var T,S=Math.sqrt(x),k=a[1]*w,P=b+C;if(T=h>0?-S+k:S+k,Math.abs(P)<1e-8)return p<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=s):(0,Gt.g)(i.eye,a,o/p),i.tilt=0,Hu(i.eye),zu(i,e);i.eye[1]=T/P;var R=c*c*g,A=d*s,E=h*A*i.eye[1],O=i.eye[1]*i.eye[1],M=1-O,Z=Math.sqrt(M),I=b*O+R-2*E*Z*w+M*C;return Math.abs(I)<1e-8?((0,Gt.g)(i.eye,a,o/p),i.tilt=0,Hu(i.eye),zu(i,e)):(i.eye[0]=(M*(o*a[0]-y*a[0])-A*Z*(a[0]*i.eye[1]*h+a[2]*c))/I,i.eye[2]=(M*(o*a[2]-y*a[2])-A*Z*(a[2]*i.eye[1]*h-a[0]*c))/I,(0,Gt.g)(i.eye,i.eye,o),Hu(i.eye),zu(i,e))},eyeTiltToLookAtTilt:function(e,t,n){var r=(0,Se.Vl)(e),i=(0,Gt.l)(t);return(0,Se.Kt)(n/(i/Math.sin(r)))+r},headingTiltToDirectionUp:Vu,lookAtTiltToEyeTilt:function(e,t,n){var r=(0,Gt.l)(t),i=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),a=(0,Se.Kt)(n/(i/Math.sin(e)));return(0,Se.BV)(e-a)},toExtent:Bu},Symbol.toStringTag,{value:"Module"})),ju=n(77648),qu=n(92028),Yu=S.Z.getLogger("esri.views.3d.support.cameraUtils"),Xu=(0,F.c)(),Qu={heading:0,tilt:0},Ju=new _i.Z,Ku=new As.pE(-20037508.342788905,20037508.342788905),$u=new As.pE(-180,180);function ec(e){return e.spatialReference||ee.Z.WGS84}function tc(e){return"global"===e.viewingMode?Wu:Zu}function nc(e,t){if((0,k.Wi)(t))return null;var n=e.renderSpatialReference,r=tc(e).headingTiltToDirectionUp,i=(0,F.c)();if(!(0,H.KC)(t.position,i,n))return null;var a=r(i,t.heading,t.tilt);(0,Gt.g)(a.direction,a.direction,e.state.camera.distance),(0,Gt.a)(a.direction,a.direction,i);var o=Ea(e,i,a.direction,a.up);return o.fov=(0,Se.Vl)(t.fov),o}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(Gu||(Gu={}));var rc=(0,F.c)();function ic(e,t,n){var r=e.renderSpatialReference,i=uc(e,t.eye,t.viewForward,t.up,Qu),a=ec(e);return(0,H.SH)(t.eye,r,rc,a)||(a=ee.Z.WGS84,(0,H.SH)(t.eye,r,rc,a)),(0,k.Wi)(n)?new v.Z(new _i.Z(rc,a),i.heading,i.tilt,(0,Se.BV)(t.fov)):(n.position.x=rc[0],n.position.y=rc[1],n.position.z=rc[2],n.position.spatialReference=a,n.heading=i.heading,n.tilt=i.tilt,n.fov=(0,Se.BV)(t.fov),n)}function ac(e,t,n){var r=e.state.camera,i=r.width/2/r.pixelRatio;return e.renderCoordsHelper.viewingMode===he.JY.Global&&null!=n&&(t*=Math.cos((0,Se.Vl)(n))),i/(96*39.37/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(r.fovX/2)}function oc(e,t,n){var r=e.state.camera,i=t*Math.tan(r.fovX/2),a=96*39.37/(r.width/2/r.pixelRatio/i);return e.renderCoordsHelper.viewingMode===he.JY.Global&&null!=n&&(a/=Math.cos((0,Se.Vl)(n))),a*=e.renderCoordsHelper.unitInMeters}function sc(e,t,n,r,i,a){return lc(e,t,ac(e,n,t.latitude),r,i,a)}function lc(e,t,n,r,i,a){if(Cc(a)){var o=new wc(a.signal);return dc(e,r.heading,r.tilt,t,n,i,o),void o.resolver.promise.then((function(t){var n=yc(e,t,r.fov);if(!(0,k.Wi)(n))return a.resolver.resolve(n);a.resolver.reject()}),(function(e){return a.resolver.reject(e)}))}var s=dc(e,r.heading,r.tilt,t,n,i);return yc(e,s,r.fov,a)}function uc(e,t,n,r,i){return tc(e).directionToHeadingTilt(t,n,r,i)}function cc(){return cc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i,o,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.renderCoordsHelper.fromRenderCoords(n,Ju,t.spatialReference)&&t.elevationProvider){e.next=2;break}return e.abrupt("return",!1);case 2:return o=null!==(i=Ju.z)&&void 0!==i?i:0,e.next=5,t.elevationProvider.queryElevation(Ju.x,Ju.y,o,Ju.spatialReference,"ground",r);case 5:return s=e.sent,e.abrupt("return",(0,k.Pt)(s,0)>o-1);case 7:case"end":return e.stop()}}),e)}))),cc.apply(this,arguments)}function hc(){return hc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i,o,s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=(0,F.c)(),!n){e.next=13;break}if(!(n instanceof _i.Z)){e.next=10;break}if((0,H.KC)(n,i,t.renderSpatialReference),null!=n.z||null==t.basemapTerrain||null==t.elevationProvider){e.next=8;break}return e.next=6,t.elevationProvider.queryElevation(n.x,n.y,null!==(o=n.z)&&void 0!==o?o:0,n.spatialReference,"ground",r);case 6:return s=e.sent,e.abrupt("return",((0,k.pC)(s)&&t.renderCoordsHelper.setAltitude(i,s),i));case 8:e.next=11;break;case 10:(0,Gt.c)(i,n);case 11:e.next=14;break;case 13:(0,Gt.c)(i,t.state.camera.center);case 14:return e.abrupt("return",i);case 15:case"end":return e.stop()}}),e)}))),hc.apply(this,arguments)}function dc(e,t,n,r,i,a,o){var s=r&&r instanceof _i.Z?r:null;if(Cc(o))return function(e,t,n){return hc.apply(this,arguments)}(e,r,o.signal).then((function(r){fc(e,t,n,s,r,i,a,o)}),(function(e){return o.resolver.reject(e)})),null;var l=function(e,t){var n=(0,F.c)();if(t&&t instanceof _i.Z){if((0,H.KC)(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain&&null!=e.elevationProvider){var r=(0,ju.KO)(e.elevationProvider,t);(0,k.pC)(r)&&e.renderCoordsHelper.setAltitude(n,r)}}else(0,Gt.c)(n,t||e.state.camera.center);return n}(e,r);return fc(e,t,n,s,l,i,a,o)}function fc(e,t,n,r,i,a,o,s){if((0,k.Wi)(r)){var l=e.renderSpatialReference;if(r=(0,H.fA)(i,l,ec(e)),(0,k.Wi)(r))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);var u=function(e,t,n,r,i,a){var o=0;return a===Gu.ADJUST&&function(e,t,n){var r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>8)return!0;var i=e.renderSpatialReference,a=ec(e),o=(0,H.fA)(t,i,a),s=(0,H.fA)(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a);if((0,k.Wi)(o)||(0,k.Wi)(s))return!1;var l=Math.tan(.5*e.state.camera.fov)*r;return s.distance(o)/l>5}(e,r,i)?(t=0,o=function(e,t,n,r){var i=_c(e,r,t,n);if(!e.state.constraints.tilt)return i;var a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);var o=a.min*(1-vc)+a.max*vc;return Math.min(i,o)}(e,i,n,r)):o=_c(e,r,i,n),o=e.state.constraints.clampTilt(i,o),{heading:t,tilt:n=mc(e,r,i,o)}}(e,t,n,i,a,o),c=(0,tc(e).eyeForCenterWithHeadingTilt)(i,a,u.heading,u.tilt);if(o===Gu.ADJUST&&"global"===e.viewingMode&&n>0){var h=function(){var l=mc(e,i,a,function(e,t,n,r){var i=_c(e,r,t,n);if(!e.state.constraints.tilt)return i;var a=e.state.constraints.tilt(t);return i=Math.min(i,.5*Math.PI),a.min*(1-vc)+i*vc}(e,a,n,i));return o=n-l<1?Gu.LOCKED:Gu.ADJUST,fc(e,t,l,r,i,a,o,s)},d=e.map.ground.navigationConstraint;if(!d||"stay-above"===d.type){if(function(e,t){var n;return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Ju,e.spatialReference)&&e.elevationProvider&&(0,k.Pt)((0,ju.KO)(e.elevationProvider,Ju),0)>(null!==(n=Ju.z)&&void 0!==n?n:0)-1)}(e,c.eye))return h();if(Cc(s))return function(e,t,n){return cc.apply(this,arguments)}(e,c.eye,s.signal).then((function(e){return e?h():(s.resolver.resolve({eye:c.eye,up:c.up,center:(0,F.a)(i),heading:c.heading,tilt:c.tilt}),null)})),null}}var f=!s||Cc(s)?{center:(0,F.c)(),eye:(0,F.c)(),up:(0,F.c)(),tilt:0,heading:0}:s;return f.eye=c.eye,f.up=c.up,f.center=(0,F.a)(i),f.heading=c.heading,f.tilt=c.tilt,Cc(s)&&s.resolver.resolve(f),f}function pc(e,t,n,r,i){var a,o,s,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;if(e.state.isGlobal){if(!(0,qu.D)(t.spatialReference,he.JY.Global))return Cc(l)&&l.resolver.reject(),null;var u=new _i.Z(t.xmin,t.ymin,t.spatialReference),c=new _i.Z(t.xmax,t.ymax,t.spatialReference),h=t.spatialReference.isGeographic?$u:Ku;a=new _i.Z({x:h.center(u.x,c.x),y:(c.y+u.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});var d=(0,qt.Iu)(t.spatialReference),f=gi(a,u,c);o=f.lon,s=f.lat,h.diff(u.x,c.x)>h.range/2&&(o+=d.halfCircumference),o=Math.min(o,d.halfCircumference),s=Math.min(s,d.halfCircumference)}else{var p=(0,k.Pt)(e.renderSpatialReference,t.spatialReference);p.equals(t.spatialReference)||(t=(0,H.iV)(t,p)),o=t.xmax-t.xmin,s=t.ymax-t.ymin;var v=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;a=new _i.Z({x:t.xmin+.5*o,y:t.ymin+.5*s,z:v,spatialReference:p})}var m=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,_=e.state.camera,y=1/Math.tan(_.fovX/2),g=1/Math.tan(_.fovY/2),b=1/Math.tan(_.fov/2),w=Math.max(.5*o*y,.5*s*g,.5*m*b)/1;if(Cc(l)){var C=new wc(l.signal);return dc(e,n,r,a,w,i,C),void C.resolver.promise.then((function(t){var n=yc(e,t,e.camera.fov);if(!(0,k.Wi)(n))return l.resolver.resolve(n);l.resolver.reject()}),(function(e){return l.resolver.reject(e)}))}var x=dc(e,n,r,a,w,i);return yc(e,x,e.camera.fov,l)}var vc=.7;function mc(e,t,n,r){return tc(e).lookAtTiltToEyeTilt(r,t,n)}function _c(e,t,n,r){return tc(e).eyeTiltToLookAtTilt(r,t,n)}function yc(e,t,n,r){if((0,k.Wi)(t))return null;var i=e.renderSpatialReference,a=(0,H.fA)(t.eye,i,ec(e));return(0,k.Wi)(a)?null:(0,k.pC)(r)?(r.position=a,r.heading=t.heading,r.tilt=t.tilt,r.fov=n,r):new v.Z(a,t.heading,t.tilt,n)}function gc(e,t){var n,r=null===(n=e.basemapTerrain)||void 0===n?void 0:n.tilingScheme;if(r)return r.scaleAtLevel(t);Yu.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function bc(e,t){return(0,H.SH)(t.center,e.renderSpatialReference,Xu,ee.Z.WGS84),oc(e,t.distance,Xu[1])}var wc=(0,l.Z)((function e(t){(0,s.Z)(this,e),this.signal=t,this.resolver=(0,R.hh)()}));function Cc(e){return e&&"resolver"in e}var xc=n(41414),Tc=n(95773),Sc=n(32238);function kc(e){return 360-As.BV.normalize(e)}function Pc(e){return As.BV.normalize(360-e)}function Rc(e){return(0,k.pC)(e)&&e.resolver&&e.resolver.reject(),null}function Ac(e,t){return(0,k.pC)(e)&&e.resolver&&e.resolver.resolve(t),t}function Ec(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!t)return Rc(r);var i=e.spatialReference||ee.Z.WGS84;if((0,k.pC)(t.camera)){var a=(0,su.iV)(t.camera.position,i);if((0,k.Wi)(a))return Rc(r);var o=t.camera.clone();return o.position=a,Ac(r,o)}if((0,k.Wi)(t.targetGeometry))return Rc(r);var s=t.get("targetGeometry.spatialReference");if(s&&!(0,su.Q8)(s,i))return Rc(r);var l=ic(e,e.state.camera),u=Gu.ADJUST;if(null!=t.rotation&&(l.heading=kc(t.rotation),u=Gu.LOCKED),null!=n&&(l.tilt=n),"point"===t.targetGeometry.type){var c=t.targetGeometry,h=t.targetGeometry.clone();return lc(e,h,null!=t.scale?ac(e,t.scale,c.latitude):e.state.camera.distance,l,u,r)}var d=t.targetGeometry.extent;return d?pc(e,d,l.heading,l.tilt,u,r):Rc(r)}function Oc(){return Oc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i,o,s,l,u,c,h,d,f;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=th(t,n)){e.next=3;break}throw new b.Z("viewpointutils-create:no-target","Missing target for creating viewpoint");case 3:if(o=new v.Z({fov:t.camera.fov}),s=new _.Z({camera:o}),!(i.target instanceof _.Z)){e.next=10;break}return e.t0=nh,e.next=8,Hc(t,i.target,i,r,s);case 8:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 10:if(!(i.target instanceof v.Z)){e.next=12;break}return e.abrupt("return",nh(Bc(t,i.target,s)));case 12:if(l=null!=i.scale||null!=i.zoom,!(i.target instanceof ou.Z)){e.next=27;break}if(u=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax,e.t2=nh,!l&&!u){e.next=22;break}return e.next=19,Wc(t,i,i.target.center,o,r,s);case 19:e.t3=e.sent,e.next=25;break;case 22:return e.next=24,Qc(t,i,i.target,o,r,s);case 24:e.t3=e.sent;case 25:return e.t4=e.t3,e.abrupt("return",(0,e.t2)(e.t4));case 27:return c={boundingBox:(0,xc.cS)(),hasZ:!1,screenSpaceObjects:[]},h=l?Zc(t,i):void 0,e.next=30,Uc(t,i.target,h,c);case 30:if(!isFinite(c.boundingBox[0])){e.next=43;break}if((0,xc.be)(c.boundingBox,ih),fh.x=ih[0],fh.y=ih[1],fh.z=ih[2],fh.spatialReference=t.spatialReference,isFinite(fh.z)&&c.hasZ?d=(0,xc.wp)(c.boundingBox):(fh.z=void 0,d=(0,z.wp)((0,xc.y8)(c.boundingBox,lh))),!l&&!d){e.next=37;break}return e.t5=nh,e.next=35,Wc(t,i,fh,o,r,s);case 35:return e.t6=e.sent,e.abrupt("return",(0,e.t5)(e.t6));case 37:return f=rh(t,c.screenSpaceObjects),e.t7=nh,e.next=41,$c(t,i,fh,c.boundingBox,f,o,r,s);case 41:return e.t8=e.sent,e.abrupt("return",(0,e.t7)(e.t8));case 43:if(!i.position){e.next=47;break}e.t9=nh(qc(t,i,o,s)),e.next=52;break;case 47:return e.t10=nh,e.next=50,Yc(t,i,o,r,s);case 50:e.t11=e.sent,e.t9=(0,e.t10)(e.t11);case 52:return e.abrupt("return",e.t9);case 53:case"end":return e.stop()}}),e)}))),Oc.apply(this,arguments)}function Mc(e,t){return null==t.scale&&null!=t.zoom?gc(e,t.zoom):t.scale}function Zc(e,t){var n=Mc(e,t);return n?(0,W.DE)(n):void 0}function Ic(e,t){var n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=kc(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function Dc(e,t,n,r){var i=e.spatialReference||ee.Z.WGS84;return t=(0,k.pC)(t)?t:nc(e,n),(0,k.Wi)(t)||(r.targetGeometry=(0,H.fA)(t.center,e.renderSpatialReference,i),r.scale=bc(e,t),r.rotation=Pc(n.heading),r.camera=n),r}function Lc(e,t,n){var r,i,a=function(){return new b.Z("viewpointutils:invalid-geometry","The target is missing a valid geometry")};if(!t)throw a();if(!(0,su.Q8)(t.spatialReference,e.spatialReference))throw new b.Z("viewpointutils:incompatible-spatialreference","Spatial reference (".concat(t.spatialReference?t.spatialReference.wkid:"unknown",") is incompatible with the view (").concat(null===(r=e.spatialReference)||void 0===r?void 0:r.wkid,")"),{geometry:t});var o=[];if(!t.hasZ&&e.basemapTerrain){var s;switch(t.type){case"point":s=t;break;case"multipoint":case"polyline":s=null===(i=t.extent)||void 0===i?void 0:i.center;break;case"mesh":s=t.origin;break;case"extent":s=t.center;break;case"polygon":s=t.centroid}s&&(0,k.pC)(e.basemapTerrain.spatialReference)&&(0,su.Q8)(s,e.basemapTerrain.spatialReference)&&e.elevationProvider?ih[2]=(0,k.Pt)((0,ju.KO)(e.elevationProvider,s),0):ih[2]=0}(0,ph[t.type])(t,(function(e){o.push(e[0],e[1],e[2])}),ih);var l=o.length/3;if(0===l)throw a();var u=new Array(o.length);if((0,H.CM)(o,t.spatialReference,0,u,e.spatialReference,0,l)){t.hasZ&&(n.hasZ=!0);for(var c=0;c<u.length;c+=3)t.hasZ?(ih[0]=u[c+0],ih[1]=u[c+1],ih[2]=u[c+2]):(ih[0]=u[c+0],ih[1]=u[c+1]),(0,xc.pp)(n.boundingBox,ih)}}function Nc(e,t,n,r){return Fc.apply(this,arguments)}function Fc(){return Fc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i){var o,s,l,u,c,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,ge.q6)(t.whenViewForGraphic(n));case 2:if(!1!==(o=e.sent).ok&&!(0,k.Wi)(o.value)&&"whenGraphicBounds"in o.value){e.next=5;break}return e.abrupt("return",void Lc(t,n.geometry,i));case 5:return s=o.value,e.next=8,(0,ge.q6)(s.whenGraphicBounds(n,{minDemResolution:r}));case 8:if(!1!==(l=e.sent).ok){e.next=11;break}return e.abrupt("return",void Lc(t,n.geometry,i));case 11:u=l.value,c=u.screenSpaceObjects,h=u.boundingBox,(0,xc.TC)(i.boundingBox,h),c&&c.forEach((function(e){i.screenSpaceObjects.push(e)})),isFinite(h[2])&&(i.hasZ=!0);case 13:case"end":return e.stop()}}),e)}))),Fc.apply(this,arguments)}function Uc(e,t,n,r){return Vc.apply(this,arguments)}function Vc(){return Vc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i){var o,s,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(n)||2!==n.length){e.next=4;break}if(s=n[0],l=n[1],"number"!=typeof s||"number"!=typeof l){e.next=4;break}return e.abrupt("return",(fh.x=s,fh.y=l,fh.z=void 0,fh.spatialReference=null!==(o=t.spatialReference)&&void 0!==o&&o.isGeographic?t.spatialReference:ee.Z.WGS84,void Lc(t,fh,i)));case 4:if(!n||"function"!=typeof n.map){e.next=9;break}return e.next=7,(0,R.as)(n.map((function(e){return Uc(t,e,r,i)})));case 7:e.next=17;break;case 9:if(!(n instanceof Sc.Z)){e.next=13;break}Lc(t,n,i),e.next=17;break;case 13:if(e.t0=n instanceof m.Z,!e.t0){e.next=17;break}return e.next=17,Nc(t,n,r,i);case 17:case"end":return e.stop()}}),e)}))),Vc.apply(this,arguments)}function Hc(e,t,n,r,i){return zc.apply(this,arguments)}function zc(){return zc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o){var s,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,k.pC)(n.camera)){e.next=2;break}return e.abrupt("return",Bc(t,n.camera,o));case 2:return o.scale=n.scale,o.rotation=n.rotation,o.targetGeometry=(0,k.pC)(n.targetGeometry)?n.targetGeometry.clone():null,o.camera=null,null!=r.heading?o.rotation=Pc(r.heading):null!=r.rotation&&(o.rotation=r.rotation),null!=(s=Mc(t,r))&&(o.scale=s),l=new wc(i),Ec(t,o,r.tilt,l),e.next=9,l.resolver.promise;case 9:return o.camera=e.sent,e.abrupt("return",o);case 11:case"end":return e.stop()}}),e)}))),zc.apply(this,arguments)}function Bc(e,t,n){var r=e.spatialReference,i=(0,su.iV)(t.position,r);return(0,k.Wi)(i)?null:((t=t.clone()).fov=e.camera.fov,t.position=i,Dc(e,null,t,n))}function Gc(e,t,n,r,i,a){var o=e.renderSpatialReference;return(0,H.KC)(n,ch,o),(0,H.KC)(t,hh,o),a.targetGeometry=new _i.Z(t),i.position=new _i.Z(n),(0,Gt.b)(uh,hh,ch),uc(e,ch,uh,r.up,i),a.scale=oc(e,(0,Gt.i)(ch,hh),a.targetGeometry.latitude),a.rotation=Pc(i.heading),a.camera=i,a}function Wc(e,t,n,r,i,a){return jc.apply(this,arguments)}function jc(){return jc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o,s){var l,u,c,h,d,f;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,k.Wi)(r)){e.next=2;break}throw new b.Z("createfromcenter","invalid point");case 2:if(s.targetGeometry=r.clone(),l=Ea(t),!n.position){e.next=6;break}return e.abrupt("return",Gc(t,s.targetGeometry,n.position,l,i,s));case 6:if(n.zoomFactor&&(u=l.distance/n.zoomFactor,c=(0,Gt.g)(ih,l.viewForward,-u),l.eye=(0,Gt.a)(ih,l.center,c),s.scale=oc(t,u,r.latitude)),ic(t,l,i),h=Ic(i,n)?Gu.LOCKED:Gu.ADJUST,n.zoomFactor){e.next=17;break}return null==(d=Mc(t,n))?((0,H.KC)(r,ih,t.renderSpatialReference),(0,Tc.g8)(l.frustum,ih)?s.scale=oc(t,(0,Gt.i)(l.eye,ih),r.latitude):s.scale=bc(t,l)):s.scale=d,f=new wc(o),sc(t,s.targetGeometry,s.scale,i,h,f),e.next=16,f.resolver.promise;case 16:s.camera=e.sent;case 17:return e.abrupt("return",s);case 18:case"end":return e.stop()}}),e)}))),jc.apply(this,arguments)}function qc(e,t,n,r){var i=Ea(e);return(0,Gt.c)(uh,i.viewForward),uc(e,i.eye,uh,i.up,dh),n.position=new _i.Z(t.position),n.heading=null!=t.heading?t.heading:dh.heading,n.tilt=null!=t.tilt?t.tilt:dh.tilt,Dc(e,null,n,r)}function Yc(e,t,n,r,i){return Xc.apply(this,arguments)}function Xc(){return Xc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o){var s;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=Ea(t),e.abrupt("return",Wc(t,n,(0,H.fA)(s.center,t.renderSpatialReference,t.spatialReference),r,i,o));case 2:case"end":return e.stop()}}),e)}))),Xc.apply(this,arguments)}function Qc(e,t,n,r,i,a){return Jc.apply(this,arguments)}function Jc(){return Jc=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o,s){var l,u,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s.targetGeometry=r.clone(),l=Ea(t),ic(t,l,i),u=Ic(i,n)?Gu.LOCKED:Gu.ADJUST,c=new wc(o),pc(t,r,i.heading,i.tilt,u,c),e.next=7,c.resolver.promise;case 7:return s.camera=e.sent,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e)}))),Jc.apply(this,arguments)}function Kc(e,t,n,r,i){var a=0;null!=n.z?a=n.z:e.basemapTerrain&&e.elevationProvider&&(a=(0,k.Wg)((0,ju.KO)(e.elevationProvider,n))),(0,Gt.s)(ih,n.x,n.y,a),(0,H.Bm)(e.spatialReference,ih,ah,e.renderSpatialReference),(0,bn.f)(oh,ah),(0,bn.t)(oh,oh),(0,xc.cS)(sh);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],s=0;s<o.length;s++){var l=o[s],u=r[l[2]];isFinite(u)||(u=a),(0,Gt.s)(ih,r[l[0]],r[l[1]],u),(0,H.SH)(ih,e.spatialReference,ih,e.renderSpatialReference),(0,xc.pp)(sh,(0,Gt.t)(ih,ih,oh))}var c=(0,xc.bf)(sh),h=(0,xc.Cb)(sh),d=(0,xc.Ye)(sh),f=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),v=.5*Math.sqrt(c*c+d*d)*Math.max(p,f)+.5*h,m=.5*h*p+.5*Math.max(c,d);return Math.max(v,m)/i}function $c(e,t,n,r,i,a,o,s){return eh.apply(this,arguments)}function eh(){return eh=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o,s,l,u){var c,h,d,f;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u.targetGeometry=r.clone(),c=Ea(t),h=Kc(t,c,r,i,o),ic(t,c,s),d=Ic(s,n)?Gu.LOCKED:Gu.ADJUST,u.scale=oc(t,h,u.targetGeometry.latitude),f=new wc(l),sc(t,u.targetGeometry,u.scale,s,d,f),e.next=9,f.resolver.promise;case 9:return u.camera=e.sent,e.abrupt("return",u);case 11:case"end":return e.stop()}}),e)}))),eh.apply(this,arguments)}function th(e,t){if(!t||!e.spatialReference)return null;var n={target:void 0};if("declaredClass"in t||Array.isArray(t))n.target=t;else{for(var r in t)n[r]=t[r];t.center&&!n.target&&(n.target=t.center)}return n}function nh(e){return e&&(0,k.pC)(e.camera)&&(e.rotation=Pc(e.camera.heading)),e}function rh(e,t){if(!t.length)return.66;for(var n=Number.NEGATIVE_INFINITY,r=0;r<t.length;r++){var i=t[r].screenSpaceBoundingRect;n=Math.max(n,Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2]),Math.abs(i[3]))}return.66-n/Math.min(e.width,e.height)*2}var ih=(0,F.c)(),ah=(0,Cn.c)(),oh=(0,Ho.c)(),sh=(0,xc.Ue)(),lh=(0,z.Ue)(),uh=(0,F.c)(),ch=(0,F.c)(),hh=(0,F.c)(),dh={heading:0,tilt:0},fh=new _i.Z,ph={point:function(e,t,n){n[0]=e.x,n[1]=e.y,null!=e.z&&(n[2]=e.z),t(n)},polygon:function(e,t,n){for(var r=e.hasZ,i=0;i<e.rings.length;i++)for(var a=e.rings[i],o=0;o<a.length;o++)n[0]=a[o][0],n[1]=a[o][1],r&&(n[2]=a[o][2]),t(n)},polyline:function(e,t,n){for(var r=e.hasZ,i=0;i<e.paths.length;i++)for(var a=e.paths[i],o=0;o<a.length;o++)n[0]=a[o][0],n[1]=a[o][1],r&&(n[2]=a[o][2]),t(n)},multipoint:function(e,t,n){for(var r=e.points,i=e.hasZ,a=0;a<r.length;a++)n[0]=r[a][0],n[1]=r[a][1],i&&(n[2]=r[a][2]),t(n)},extent:function(e,t,n){null!=e.zmin&&null!=e.zmax?(t((0,Gt.s)(n,e.xmin,e.ymin,e.zmin)),t((0,Gt.s)(n,e.xmax,e.ymin,e.zmin)),t((0,Gt.s)(n,e.xmin,e.ymax,e.zmin)),t((0,Gt.s)(n,e.xmax,e.ymax,e.zmin)),t((0,Gt.s)(n,e.xmin,e.ymin,e.zmax)),t((0,Gt.s)(n,e.xmax,e.ymin,e.zmax)),t((0,Gt.s)(n,e.xmin,e.ymax,e.zmax)),t((0,Gt.s)(n,e.xmax,e.ymax,e.zmax))):(t((0,Gt.s)(n,e.xmin,e.ymin,n[2])),t((0,Gt.s)(n,e.xmax,e.ymin,n[2])),t((0,Gt.s)(n,e.xmin,e.ymax,n[2])),t((0,Gt.s)(n,e.xmax,e.ymax,n[2])))},mesh:function(e,t,n){var r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(var i=0;i<r.length;i+=3)t((0,Gt.s)(n,r[i+0],r[i+1],r[i+2]))}},vh=function(){function e(t,n,r){var i=this;(0,s.Z)(this,e),this.target=t,this.options=n,this.view=r,this.state="pending",this._animationController=null,this._promise=new Promise((function(e,t){i._resolveCallback=e,i._rejectCallback=t;var n=new AbortController;(0,k.pC)(i.options.signal)&&(0,R.fu)(i.options.signal,(function(){i.abort()})),i._abortController=n,i.waitForReady()}))}return(0,l.Z)(e,[{key:"then",value:function(e,t){return this._promise.then(e,t)}},{key:"catch",value:function(e){return this._promise.catch(e)}},{key:"resolve",value:function(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}},{key:"reject",value:function(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}},{key:"abort",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&(0,k.pC)(this._animationController)&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject((0,R.zE)())}},{key:"waitForReady",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state="wait-for-ready",this.view.ready){e.next=9;break}return e.prev=1,e.next=4,(0,A.N1)((function(){return t.view.ready}),this._abortController.signal);case 4:e.next=9;break;case 6:return e.prev=6,e.t0=e.catch(1),e.abrupt("return",this.reject(e.t0));case 9:this.createViewPoint();case 10:case"end":return e.stop()}}),e,this,[[1,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"createViewPoint",value:function(){var e=this;"finished"!==this.state&&(this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null,function(e,t,n){return Oc.apply(this,arguments)}(this.view,this.target,this._abortController.signal).then((function(t){if("finished"!==e.state){var n=t?e._getCameraFromViewpoint(t):null;if(!(0,k.Wi)(n))if(e.options.animate){if((0,k.Wi)(e._animationController))return;e.startAnimation(n,e._animationController)}else e.view.stateManager.setStateCamera(n.camera,{applyConstraints:!n.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),e.resolve()}}),(function(t){e.reject(t)})))}},{key:"_getCameraFromViewpoint",value:function(e){var t=!!(this.target instanceof _.Z&&this.target.camera||this.target instanceof v.Z),n=e.camera;if((0,k.Wi)(n))return null;if(!this.view.stateManager.isCompatible(n)){var r,i=n.position,a=i&&i.spatialReference,o=a?a.wkid:"none",s=null===(r=this.view.spatialReference)||void 0===r?void 0:r.wkid;return this.reject(new b.Z("GotoAnimation:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: ".concat(o,", view: ").concat(s,")"),{camera:n})),null}var l=nc(this.view,n);return(0,k.Wi)(l)?(this.reject(new b.Z("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:l,isFullySpecified:t}}},{key:"startAnimation",value:function(e,t){var n=this;this.state="wait-for-animation-finish";var r=t.viewAnimation;if((0,k.Wi)(r))this.reject(new b.Z("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));else{if(r.update(e.viewpoint,"running"),!t.active||(0,k.Wi)(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();var i;e.isFullySpecified?(i=new wu({view:this.view,desiredCamera:e.camera}),Fa(this.view,e.camera,Ma.EYE_AND_CENTER)):Do(this.view,e.camera),t.begin(e.camera,this.options);var a=function(e){if(!(0,k.Wi)(n.view.state))switch(t.state){case ys.Finished:switch(n.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":n.resolve()}break;case ys.Ready:case ys.Rejected:case ys.Running:case ys.Stopped:switch(n.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":n.reject(e)}}};r.when((function(){var r=n.view.state.cameraController;i&&(r&&r.active?r instanceof ks&&(0,k.pC)(r.viewAnimation)&&r.viewAnimation.target===e.viewpoint&&(n.view.state.cameraController=i):(0,k.pC)(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(n.view.state.cameraController=i))}),(function(e){return a(e)})),t.asyncResult={resolve:function(){return a()},reject:function(e){return a(e)}}}}},{key:"_getAnimationController",value:function(){var e=null,t=null,n=this.view.state.cameraController;return n instanceof ks&&(n.updateStateFromViewAnimation(),n.active&&(t=(e=n).viewAnimation)),null!=e||(t=(e=new ks({view:this.view,mode:"animation"})).viewAnimation,this.view.state.switchCameraController(e))?e:((0,k.pC)(t)&&t.stop(),this.reject(new b.Z("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}]),e}(),mh=n(76419),_h=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._propertiesPool=new mh.L({frustum:bu.i},(0,u.Z)(r)),r._cameraSetByUser=!1,r._gotoOperation=null,r.constraintsManager=null,r.ready=!1,r._windowDevicePixelRatio=1,r._devicePixelRatioOverride=null,r._cameraChangeTime=0,r._updatingIgnoreRenderState=!1,r.test={viewStateManager:(0,u.Z)(r),contentCameraResetState:new Map,setDevicePixelRatio:function(e){return r._devicePixelRatioOverride=e},renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},set updatingIgnoreRenderState(e){this.viewStateManager._updatingIgnoreRenderState=e},get updatingIgnoreRenderState(){return this.viewStateManager._updatingIgnoreRenderState||(0,k.pC)(this.renderState)}},r}return(0,l.Z)(n,[{key:"camera",get:function(){var e=this._get("camera");if(!this.ready)return e;var t=ic(this.view,this.view.state.camera,Ch);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){var t,n;this._updatePropertyBeforeReady("camera",e)||(null!==(t=this.view.elevationProvider)&&void 0!==t&&t.enableElevationCache(!0),this.setStateCamera(nc(this.view,e),{applyConstraints:!1})||S.Z.getLogger(this.declaredClass).error("#camera=","Invalid camera",e),null===(n=this.view.elevationProvider)||void 0===n||n.enableElevationCache(!1))}},{key:"contentCamera",get:function(){var e=this._get("contentCamera");if(!this.ready)return e;var t=ic(this.view,this.view.state.contentCamera,Ch);return t&&e&&t.equals(e)?e:t.clone()},set:function(e){if(!this._updatePropertyBeforeReady("contentCamera",e)){var t=nc(this.view,e);(0,k.Wi)(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}}},{key:"installContentCameraReset",value:function(e){var t=this;if(this.removeHandles(kh),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;var n=this.zoom,r=Math.pow(this.view.state.camera.distance,2),i=(0,F.d)(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this.addHandles([(0,A.YP)((function(){return t.contentCamera}),(function(){e.sticky||(t.removeHandles(kh),t.test.contentCameraResetState.clear())})),(0,A.YP)((function(){return t.zoom}),(function(e){void 0!==e&&void 0!==n&&(t.test.contentCameraResetState.set("view.zoom",Math.abs(e-n)/2),Math.abs(e-n)>2?t.contentCamera=null:t.view.state.fixedContentCamera||(t.contentCamera=a))})),(0,A.YP)((function(){return t.view.state.camera}),(function(e){var n=(0,Gt.d)(i,e.center);t.test.contentCameraResetState.set("camera.center",n/r),n>r?t.contentCamera=null:t.view.state.fixedContentCamera||(t.contentCamera=a)}))],kh),!0}},{key:"center",get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():S.Z.getLogger(this.declaredClass).error("#center=","Invalid center",e):S.Z.getLogger(this.declaredClass).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):S.Z.getLogger(this.declaredClass).error("#center=","Center may not be null or undefined"))}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");var e=this.view,t=function(e,t,n){var r=e.renderSpatialReference,i=(0,H.fA)(n,r,ec(e));if((0,k.Wi)(i))return null;var a=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),s=(0,Gt.j)(t.eye,n),l=2*s*a*1,u=2*s*o*1;return"global"===e.viewingMode?Bu(e,i,l,u):Mu(e,i,l,u)}(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return(0,k.pC)(t)?t:this._get("extent")},set:function(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||S.Z.getLogger(this.declaredClass).error("#extent=","Invalid extent",e):S.Z.getLogger(this.declaredClass).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e):S.Z.getLogger(this.declaredClass).error("#extent=","Extent may not be null or undefined"))}},{key:"frustum",get:function(){var e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}},{key:"hasInitialView",get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")}},{key:"scale",get:function(){if(this.ready){var e=this.view.pointsOfInterest.centerOnContent;return oc(this.view,e.distance,e.location.latitude)}return this._get("scale")},set:function(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||S.Z.getLogger(this.declaredClass).error("#scale=","Invalid scale",e)}},{key:"padding",get:function(){if(!this.ready)return this._get("padding");var e=this.view.state.camera,t=e.padding,n=e.pixelRatio,r=this._get("padding"),i=Math.round(t[Jo.N.TOP]/n),a=Math.round(t[Jo.N.RIGHT]/n),o=Math.round(t[Jo.N.BOTTOM]/n),s=Math.round(t[Jo.N.LEFT]/n);return null!=r&&r.top===i&&r.right===a&&r.bottom===o&&r.left===s?r:{top:i,right:a,bottom:o,left:s}},set:function(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,Th),this.view.state.updateCamera((function(e){return e.padding=Th})))}},{key:"_paddingToArray",value:function(e,t,n){e?(0,Xt.s)(n,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,Xt.s)(n,0,0,0,0);for(var r=0;r<4;r++)n[r]=Math.round(n[r]*t)}},{key:"screenCenter",get:function(){var e=this.padding;return(0,O.vW)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}},{key:"viewpoint",get:function(){return this.ready?function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,k.Wi)(n)&&(n=new _.Z),Dc(e,null,t.clone(),n)}(this.view,this.camera):this._get("viewpoint")},set:function(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||S.Z.getLogger(this.declaredClass).error("#viewpoint=","Invalid viewpoint",e);else{var t,n=(0,k.pC)(e.camera)?e.camera.position:e.targetGeometry,r=(0,k.pC)(n)&&n.spatialReference;S.Z.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(r?r.wkid:"none")+", view: "+(null===(t=this.view.spatialReference)||void 0===t?void 0:t.wkid)+")",e)}else S.Z.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint may not be null or undefined")}},{key:"zoom",get:function(){return this.ready?function(e,t){var n,r=null===(n=e.basemapTerrain)||void 0===n?void 0:n.tilingScheme;if(r)return r.levelAtScale(t);Yu.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}(this.view,this.scale):this._get("zoom")},set:function(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||S.Z.getLogger(this.declaredClass).error("#zoom=","Invalid zoom",e)}},{key:"_pixelRatio",get:function(){var e;return(0,k.pC)(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRendering?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,null===(e=this.view)||void 0===e?void 0:e.qualitySettings.maximumPixelRatio)}},{key:"_rasterPixelRatio",get:function(){return(0,k.pC)(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}},{key:"_usePhysicalPixelRendering",get:function(){var e,t,n;return null!==(e=null===(t=this.view)||void 0===t||null===(n=t._stage)||void 0===n?void 0:n.renderer.isFeatureEnabled(ui.Y.PhysicalPixelRendering))&&void 0!==e&&e}},{key:"_usePhysicalPixelRenderingAny",get:function(){var e,t,n=null===(e=this.view)||void 0===e||null===(t=e._stage)||void 0===t?void 0:t.renderer;return n&&(n.isFeatureEnabled(ui.Y.PhysicalPixelRendering,Xr.n.IDLE)||n.isFeatureEnabled(ui.Y.PhysicalPixelRendering,Xr.n.INTERACTING)||n.isFeatureEnabled(ui.Y.PhysicalPixelRendering,Xr.n.ANIMATING))}},{key:"initialize",value:function(){var e=this;this._cameraChangeTime=performance.now(),this.addHandles([(0,A.on)((function(){return e.view.state.events}),"before-camera-change",(function(t){return t&&e._updateElevation(t)})),(0,A.YP)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(t,n){return e._cameraChangedHandler(t,n)}),A.Z_)]),(0,A.gx)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.camera}),(function(t){return e._updateElevation(t)}),{once:!0,sync:!0}),this.addHandles([(0,E.A)({prepare:function(){return e._prepareFrame()}}),(0,A.YP)((function(){return e.view.state.cameraController}),(function(){e._cameraSetByUser=!0,e.removeHandles(Sh)})),(0,A.on)((function(){return e.view.state.events}),"camera-projection-changed",(function(){return e.notifyChange("scale")}))])}},{key:"destroy",value:function(){this.exit(),this._propertiesPool=(0,k.SC)(this._propertiesPool)}},{key:"init",value:function(){var e=this;this.constraintsManager=new gu({view:this.view}),this._prepareFrame();var t=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;this.set(a.name,a.value)}}catch(s){r.e(s)}finally{r.f()}if(!this._cameraSetByUser){var o=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;o&&this.isCompatible(o)?this._setInitialView(o):this.view.state.viewingMode===he.JY.Local&&this.addHandles((0,A.gx)((function(){return e.view.basemapTerrain.ready}),(function(){e.removeHandles(Sh),e._setInitialView(e.view.dataExtent)}),{once:!0,initial:!0}),Sh)}}},{key:"exit",value:function(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Sh),this.constraintsManager=(0,k.SC)(this.constraintsManager))}},{key:"goTo",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=(0,r.Z)({animate:!0},n),e.abrupt("return",((0,k.pC)(this._gotoOperation)&&this._gotoOperation.abort(i.animate),this._gotoOperation=new vh(t,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation));case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"debugSetCameraOnContent",value:function(){this.setStateCamera(Ea(this.view),{applyConstraints:!1})}},{key:"step",value:function(e){var t=this.view.state,n=null===t||void 0===t?void 0:t.cameraController;n&&(t.updateCamera((function(t){return n.stepController(e,t)})),n.steppingFinished&&n.finishController())}},{key:"_cancelGoToOperation",value:function(){(0,k.pC)(this._gotoOperation)&&(this._gotoOperation.abort(),this._gotoOperation=null)}},{key:"_getInitialProperties",value:function(){var e,t=new Set,n=[],r=(0,i.Z)(bh);try{for(r.s();!(e=r.n()).done;){var a=e.value,o=a.propertyName,s=a.overrides,l=t.has(o),u=this._isOverridden(o);!l&&u&&n.push({name:o,value:this._get(o)}),this._clearOverride(o),(l||u)&&s.forEach((function(e){return t.add(e)}))}}catch(c){r.e(c)}finally{r.f()}return n}},{key:"_setInitialView",value:function(e){if(!(0,k.Wi)(e)&&!this._cameraSetByUser)if(e instanceof v.Z)this.setStateCamera(nc(this.view,e),{applyConstraints:!1});else if(e instanceof _.Z){if(e.targetGeometry instanceof ou.Z){var t=pc(this.view,e.targetGeometry,0,.5,Gu.LOCKED);return void((0,k.pC)(t)&&this.setStateCamera(nc(this.view,t),{applyConstraints:!0}))}var n={applyConstraints:!e.camera},r=this._viewpointToCamera(e);this.setStateCamera(r,n)}else{var i=pc(this.view,e,0,.5,Gu.LOCKED);(0,k.pC)(i)&&this.setStateCamera(nc(this.view,i),{applyConstraints:!0})}}},{key:"_updatePropertyBeforeReady",value:function(e,t){return!this.ready&&(this._override(e,t),t&&gh.includes(e)&&this._override("hasInitialView",!0),!0)}},{key:"isCompatible",value:function(e){return!(0,k.Wi)(e)&&(e instanceof _.Z?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof v.Z?this.isCompatible(e.position):e.spatialReference&&(0,su.Q8)(e.spatialReference,this.view.spatialReference))}},{key:"_getPreservingHeadingTilt",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:wh;return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}},{key:"_centerPointAtDistanceToCamera",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:xh,r=this._getPreservingHeadingTilt(),i=r.heading,a=r.tilt,o=dc(this.view,i,a,e,t,Gu.ADJUST);return(0,k.Wi)(o)?null:(n.copyFrom(this.view.state.camera),n.eye=o.eye,n.center=o.center,n.up=o.up,n)}},{key:"_centerToCamera",value:function(e){var t=this.view.pointsOfInterest.centerOnContent;t.runTask();var n=t.distance;return this._centerPointAtDistanceToCamera(e,n)}},{key:"_extentToCamera",value:function(e){var t=this._getPreservingHeadingTilt(),n=t.heading,r=t.tilt,i=pc(this.view,e,n,r,Gu.ADJUST,Ch);return i?nc(this.view,i):null}},{key:"_scaleToCamera",value:function(e){if(null==e)return null;var t=this.view.pointsOfInterest.centerOnContent;t.runTask();var n=t.renderLocation,r=t.location.latitude;if(null==r)return null;var i=ac(this.view,e,r);return this._centerPointAtDistanceToCamera(n,i)}},{key:"_zoomToCamera",value:function(e){return this._scaleToCamera(gc(this.view,e))}},{key:"_viewpointToCamera",value:function(e){return nc(this.view,Ec(this.view,e))}},{key:"setStateCamera",value:function(e,t){var n=this;return!((0,k.Wi)(e)||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((function(r){t.positionAndOrientationOnly?(r.eye=e.eye,r.center=e.center,r.up=e.up):r.copyFrom(e),t.applyConstraints&&Do(n.view,r)})),t.applyConstraints||(this.view.state.cameraController=new wu({view:this.view,desiredCamera:e})),!0)}},{key:"_prepareFrame",value:function(){var e=this.view,t=e.surface,n=e.canvas;if(t&&n){this._windowDevicePixelRatio=window.devicePixelRatio;var r=this._pixelRatio,i=Math.round(t.clientWidth*r),a=Math.round(t.clientHeight*r);if(0!==i&&0!==a&&(n.width===i&&n.height===a||(n.width=i,n.height=a),this.view.state)){var o=this.view.state.camera;o.fullWidth===i&&o.fullHeight===a&&o.pixelRatio===r||(xh.copyFrom(o),xh.pixelRatio!==r&&(this._paddingToArray(this.padding,r,Th),xh.padding=Th),xh.fullWidth=i,xh.fullHeight=a,xh.pixelRatio=r,this.view.state.camera=xh),this._updateViewState()}}}},{key:"_updateElevation",value:function(e){var t,n,r=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=null!==(t=null===(n=this.view.renderCoordsHelper)||void 0===n?void 0:n.getAltitude(e.eye))&&void 0!==t?t:0,a=r?Aa(this.view,e.eye):0;e.relativeElevation=i-a}},{key:"_updateViewState",value:function(){(0,k.pC)(this.test.renderState)?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Xr.n.ANIMATING:this.view.interacting?this.view.state.mode=Xr.n.INTERACTING:(this.view.state.mode===Xr.n.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=Ph?this.view.state.mode=Xr.n.INTERACTING:this.view.state.mode=Xr.n.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio,this.view.state.contentPixelRatio=Math.min(this._pixelRatio,this.view.qualitySettings.maximumPixelRatio)}},{key:"_cameraChangedHandler",value:function(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({type:v.Z,dependsOn:["view.state.camera","ready"]})],_h.prototype,"camera",null),(0,p._)([(0,Z.Cb)({type:v.Z,dependsOn:["view.state.contentCamera","ready"]})],_h.prototype,"contentCamera",null),(0,p._)([(0,Z.Cb)({type:_i.Z})],_h.prototype,"center",null),(0,p._)([(0,Z.Cb)({type:ou.Z})],_h.prototype,"extent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_h.prototype,"frustum",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_h.prototype,"hasInitialView",null),(0,p._)([(0,Z.Cb)({readOnly:!0,type:Boolean})],_h.prototype,"ready",void 0),(0,p._)([(0,Z.Cb)({type:Number})],_h.prototype,"scale",null),(0,p._)([(0,Z.Cb)()],_h.prototype,"padding",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_h.prototype,"screenCenter",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],_h.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({type:_.Z})],_h.prototype,"viewpoint",null),(0,p._)([(0,Z.Cb)({type:Number})],_h.prototype,"zoom",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_h.prototype,"_pixelRatio",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_h.prototype,"_rasterPixelRatio",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_h.prototype,"_usePhysicalPixelRendering",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_h.prototype,"_usePhysicalPixelRenderingAny",null),(0,p._)([(0,Z.Cb)()],_h.prototype,"_windowDevicePixelRatio",void 0),(0,p._)([(0,Z.Cb)()],_h.prototype,"_devicePixelRatioOverride",void 0),_h=(0,p._)([(0,L.j)("esri.views.3d.state.ViewStateManager")],_h);var yh,gh=["camera","viewpoint","extent","scale","center","zoom"],bh=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],wh={heading:0,tilt:0},Ch=new v.Z,xh=new Jo.V,Th=(0,Wt.c)(),Sh="pending-initial-view",kh="content-camera-reset",Ph=300,Rh=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).startCamera=new Jo.V,e.currentCamera=new Jo.V,e._lastInteraction=0,e}return(0,l.Z)(n,[{key:"isInteractive",get:function(){return performance.now()-this._lastInteraction<100}},{key:"stepController",value:function(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}},{key:"onControllerStart",value:function(e){this.state=ys.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}},{key:"onControllerEnd",value:function(e){e.copyViewFrom(this.currentCamera)}},{key:"commitCamera",value:function(){var e=this;this._lastInteraction=performance.now(),setTimeout((function(){return e.notifyChange("isInteractive")}),100),this.view.state.updateCamera((function(t){return e.stepController(0,t)})),this.steppingFinished&&this.finishController()}}]),n}(Ts);(0,p._)([(0,Z.Cb)({readOnly:!0})],Rh.prototype,"isInteractive",null),(0,p._)([(0,Z.Cb)()],Rh.prototype,"_lastInteraction",void 0),Rh=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.InteractiveController")],Rh),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(yh||(yh={}));var Ah=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).pivot=yh.CENTER,r._rotScale=0,r._lastPoint=(0,Jt.a)(),r._tmpWorldUp=(0,F.c)(),r._tmpViewDir=(0,F.c)(),r._tmpRotCurPoint=(0,Jt.a)(),r._tmpTransf=(0,Cn.c)(),r._tmpAxis=(0,F.c)(),r._tmpPivotPoint=(0,F.c)(),r._pivotPos=(0,F.c)(),r._constraintOptions={selection:Wi.ALL,interactionType:ji.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:qi.TUMBLE},r}return(0,l.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"initialize",value:function(){this._rotScale=this.pivot===yh.CENTER?3:1.5}},{key:"begin",value:function(e){if(this.active){switch(this.pivot){case yh.EYE:(0,Gt.c)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=ji.LOOK_AROUND,this._constraintOptions.tiltMode=qi.LOOK_AROUND,this._constraintOptions.selection=Wi.NONE;break;case yh.CENTER:var t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?qs:{});t||(0,Gt.c)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=ji.TUMBLE,this._constraintOptions.tiltMode=qi.TUMBLE,this._constraintOptions.selection=Wi.ALL&~Wi.DISTANCE}this._constraintOptions.interactionStartCamera=this.startCamera,Ys(this.startCamera,e,this._lastPoint)}}},{key:"_constrainPivotPoint",value:function(e,t){var n=this.startCamera,r=(0,F.c)();(0,Gt.b)(r,this._pivotPos,n.eye);var i=(0,Gt.l)(r),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(n.eye,Oh);var o=Math.max(Math.min(5,1/Math.abs((0,Gt.e)(Oh,n.viewForward)))*a,10);t&&(o=Math.min(i,o));var s=(0,qt.Iu)(this.view.spatialReference),l=(0,O.s1)(n.width/n.pixelRatio*.5,n.height/n.pixelRatio*.5),u=dl(this.startCamera,l,s),c=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,n.fullWidth/n.pixelRatio*.5,n.fullHeight/n.pixelRatio*.5,n,225,90),h=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],n,90);((0,k.pC)(c)||(0,k.pC)(h))&&(o=(c=(0,k.Pt)(c,h))>(h=(0,k.Wi)(h)||u===el.Horizontal?c:h)?h:c,o=t?Math.min(o,i):o),(0,Gt.n)(r,r),(0,Gt.c)(this._pivotPos,(0,Gt.a)(this._tmpPivotPoint,n.eye,(0,Gt.g)(this._tmpPivotPoint,r,o)))}},{key:"update",value:function(e){if(this.active){switch(this.pivot){case yh.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case yh.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Do(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}},{key:"end",value:function(){this.active&&this.finishController()}},{key:"_applyRotation",value:function(e,t,n,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),Ys(e,t,this._tmpRotCurPoint);var i=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,Gt.b)(this._tmpViewDir,n,r);var o=(0,Gt.l)(this._tmpViewDir),s=(0,Se.ZF)((0,Gt.e)(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===yh.EYE){i*=-.5;var l=.5*Math.PI-s,u=.5*Math.PI*.99;i=l-Math.max(-u,Math.min(u,l+i))}return i=(0,Se.uZ)(i+s,Ee.min,Ee.max)-s,(0,Gt.f)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===yh.CENTER&&(a=-a),(0,wn.d)(this._tmpTransf,a,this._tmpWorldUp),(0,wn.e)(this._tmpTransf,this._tmpTransf,i,this._tmpAxis),(0,Gt.m)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,Gt.m)(Eh,e.up,this._tmpTransf),(0,Gt.a)(Eh,r,this._tmpViewDir),(0,Yt.c)(this._lastPoint,this._tmpRotCurPoint),Eh}}]),n}(Rh);(0,p._)([(0,Z.Cb)()],Ah.prototype,"pivot",void 0),Ah=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.RotateController")],Ah);var Eh=(0,F.c)(),Oh=(0,F.c)(),Mh=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i,a){var o;return(0,s.Z)(this,n),(o=t.call(this,!0))._view=e,o.pointerAction=r,o._pivot=i,o.registerIncoming("drag",a,(function(e){return o._handleDrag(e)})),o}return(0,l.Z)(n,[{key:"_handleDrag",value:function(e){var t=e.data;if(!(t.pointers.size>1)&&(0,iu.b)(e.data,this.pointerAction)){var n=(0,O.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Ah({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(n);break;case"update":this._cameraController&&this._cameraController.update(n);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}}]),n}(ru.a),Zh=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._pickPoint=(0,F.c)(),e._tmpP0=(0,Jt.a)(),e._panAxisAngle=Is(),e._tmpRayDir=(0,F.c)(),e._tmpRayDirPick=(0,F.c)(),e._targetOnSphere=(0,F.c)(),e._navMode=el.Horizontal,e._tmpRay={origin:(0,F.c)(),direction:(0,F.c)()},e.dragBeginPoint=(0,O.s1)(),e._normalizedAnchorPoint=(0,Jt.a)(),e._constraintOptions={selection:Wi.ALL_EXCEPT_COLLISION,interactionType:ji.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:qi.TUMBLE},e._sphere=(0,ea.c)(),e._hasPickPoint=!1,e}return(0,l.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){if(this.active){(0,Yt.c)(this.dragBeginPoint,e),Ys(this.startCamera,e,this._normalizedAnchorPoint);var t=(0,qt.Iu)(this.view.spatialReference),n=hl(this._intersectionHelper,this.startCamera,e,t,zs.Ellipsoid,0===this.view.map.ground.opacity?qs:{});if(this._navMode=dl(this.startCamera,e,t),this._navMode===el.Horizontal)this._hasPickPoint=!!n.scenePickPoint,this._pickPoint=(0,k.Pt)(n.scenePickPoint,this._pickPoint),this._sphere=n.sphere;else{var r;(0,Vs.iE)(this.startCamera,e,this._tmpRay),(0,Gt.n)(this._tmpRay.direction,this._tmpRay.direction),(0,k.pC)(n.scenePickPoint)&&((0,Gt.b)(this._tmpRayDirPick,this.startCamera.eye,n.scenePickPoint),r=(0,Gt.l)(this._tmpRayDirPick));var i=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Dh);var a=(0,Se.uZ)(Math.min(30,1/Math.abs((0,Gt.e)(Dh,this._tmpRay.direction)))*i,Ws[0],Ws[1]),o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);a=(0,k.pC)(o)?o:a,a=null!=r?Math.min(a,r):a,this._hasPickPoint=!0,(0,Gt.g)(this._tmpRay.direction,this._tmpRay.direction,a),(0,Gt.a)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}this._constraintOptions.interactionStartCamera=this.startCamera}}},{key:"update",value:function(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===el.Horizontal){(0,Gt.b)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);var t=(0,Gt.l)(this._tmpRayDir);Ys(this.currentCamera,e,this._tmpP0);var n=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),r=t*Math.pow(2,n),i=this.view.state.constraints.minimumPoiDistance;if(n<0&&r<i&&(r=i),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){var a=1-(1-r/t)*(1-this._sphere[3]/(0,Gt.l)(this.currentCamera.center));this.currentCamera.center=(0,Gt.g)(Ih,this.currentCamera.center,a)}(0,Gt.g)(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=(0,Gt.a)(Ih,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=No((0,Yt.d)(this.dragBeginPoint,e)),Do(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(vl(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Ns(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Qs(this.currentCamera,this._sphere,this._panAxisAngle))}else{var o=(0,Gt.l)(this._tmpRay.direction);Ys(this.currentCamera,e,this._tmpP0);var s=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),l=o*Math.pow(2,s),u=this.view.state.constraints.minimumPoiDistance;if(s<0&&l<u&&(l=u),Math.abs(o-l)<1e-6)return;(0,Gt.g)(this._tmpRayDir,this._tmpRay.direction,1-l/o),this.currentCamera.eye=(0,Gt.a)(Ih,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,Gt.a)(Ih,this.currentCamera.center,this._tmpRayDir)}Fa(this.view,this.currentCamera),this.commitCamera()}}},{key:"end",value:function(){this.active&&this.finishController()}}]),n}(Rh);Zh=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.global.ZoomController")],Zh);var Ih=(0,F.c)(),Dh=(0,F.c)(),Lh=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._tmpP=(0,F.c)(),e._tmpDir=(0,F.c)(),e._tmpN=(0,F.c)(),e._tmpP0=(0,Jt.a)(),e._tmpPoi=(0,F.c)(),e._tmpRayDir=(0,F.c)(),e.dragBeginPoint=(0,O.s1)(),e._normalizedAnchorPoint=(0,Jt.a)(),e._constraintOptions={selection:Wi.ALL,interactionType:ji.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:(0,F.c)(),tiltMode:qi.TUMBLE},e._plane=(0,Us.Ue)(),e}return(0,l.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){if(this.active){(0,Yt.c)(this.dragBeginPoint,e),Ys(this.startCamera,e,this._normalizedAnchorPoint);var t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?qs:{});(0,Gt.b)(this._tmpDir,this._tmpP,this.startCamera.eye);var n=(0,Gt.l)(this._tmpDir);(0,Gt.n)(this._tmpDir,this._tmpDir);var r=Math.abs(this.view.camera.position.z),i=(0,Se.uZ)(Math.min(30,1/Math.abs((0,Gt.e)(Fh,this._tmpDir)))*r,Ws[0],Ws[1]),a=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,80);i=(0,k.pC)(a)?a:i,i=t?Math.min(i,n):i,(0,Gt.g)(this._tmpDir,this._tmpDir,i),(0,Gt.a)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,Gt.b)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,Gt.n)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,Gt.o)(this._tmpN,this._tmpN),(0,Us.Yq)(this._tmpP,this._tmpN,this._plane),this._constraintOptions.interactionStartCamera=this.startCamera}}},{key:"update",value:function(e){if(this.active){(function(e,t,n,r){return(0,Us.BR)(e,(0,Vs.u4)(t,n,Yl),r)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||(0,Gt.c)(this._tmpPoi,this.currentCamera.center),Ys(this.currentCamera,e,this._tmpP0);var t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,Yt.c)(this._normalizedAnchorPoint,this._tmpP0),(0,Gt.b)(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);var n=(0,Gt.l)(this._tmpRayDir),r=n*(1-t);this._constraintOptions.interactionDirection&&((0,Gt.c)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,Gt.g)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/n));var i=this.view.state.constraints.minimumPoiDistance;t>=0&&r<i&&(t=-((r=i)-n)/n),Math.abs(n-r)<1e-6||((0,Gt.g)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,Gt.a)(Nh,this.currentCamera.eye,this._tmpRayDir),(0,Gt.h)(Nh,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Nh[2]=Math.max(this.startCamera.center[2],Nh[2]):Nh[2]=Math.min(this.startCamera.center[2],Nh[2]),this.currentCamera.center=Nh,this._constraintOptions.interactionFactor=No((0,Yt.d)(this.dragBeginPoint,e)),Do(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}}},{key:"end",value:function(){this.active&&this.finishController()}}]),n}(Rh);Lh=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.local.ZoomController")],Lh);var Nh=(0,F.c)(),Fh=(0,F.f)(0,0,1),Uh=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this,!0))._view=e,a.pointerAction=r,a.registerIncoming("drag",i,(function(e){return a._handleDrag(e)})),a}return(0,l.Z)(n,[{key:"_handleDrag",value:function(e){var t=e.data;if(!(t.pointers.size>1)&&(0,iu.b)(e.data,this.pointerAction)){var n=(0,O.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new Zh({view:this._view}):this._cameraController=new Lh({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(n);break;case"update":this._cameraController&&this._cameraController.update(n);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}}]),n}(ru.a),Vh=n(73320),Hh=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._filteredSurfaceElevation=0,r._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},r._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],r._tmpCamera=new Jo.V,r._headingStart=0,r._constraintOptions={selection:Wi.ALL,interactionType:ji.NONE,interactionStartCamera:new Jo.V,interactionFactor:0,interactionDirection:null,tiltMode:qi.LOOK_AROUND},r}return(0,l.Z)(n,[{key:"handleEventGamepad",value:function(e){var t=(0,Vh.CY)(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||(0,Vh._r)(t))&&this.finishController()}},{key:"activateDirection",value:function(e){this._keysButtonState[e]=1,(0,Vh.U_)(this._keysButtonState,this._transformation)}},{key:"deactivateDirection",value:function(e){this._keysButtonState[e]=0;var t=(0,Vh.U_)(this._keysButtonState,this._transformation);(0,Vh._r)(t)&&this.finishController()}},{key:"onControllerStart",value:function(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,(0,c.Z)((0,h.Z)(n.prototype),"onControllerStart",this).call(this,e)}},{key:"_updateFilteredSurfaceElevation",value:function(e){var t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}},{key:"stepController",value:function(e,t){var r;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),null!==(r=this._constraintOptions.interactionStartCamera)&&void 0!==r&&r.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Xh),this._applyDisabledMovementTypes(Xh),this._applyPan(Xh.pan),this._applyRotate(Xh.rotate),this._applyZoom(Xh.zoom),this._applyAscend(Xh.ascend),this._constraintOptions.interactionType=ji.NONE,this._constraintOptions.selection=Wi.COLLISION,Do(this.view,this.currentCamera,this._constraintOptions),(0,c.Z)((0,h.Z)(n.prototype),"stepController",this).call(this,e,t)}},{key:"_updateStartHeading",value:function(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}},{key:"_applyRotate",value:function(e){if(e.enabled){var t=this.currentCamera;(0,Gt.b)(Qh,t.center,t.eye),(0,Gt.m)(Qh,Qh,e.matrix),t.center=(0,Gt.a)(Qh,Qh,t.eye),t.up=(0,Gt.m)(Qh,t.up,e.matrix),this._constraintOptions.interactionType=ji.LOOK_AROUND,this._constraintOptions.selection=Wi.ALL_EXCEPT_COLLISION,Do(this.view,t,this._constraintOptions)}}},{key:"_applyPan",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.currentCamera;e.enabled&&(t.eye=(0,Gt.m)(Qh,t.eye,e.matrix),t.center=(0,Gt.m)(Qh,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,Gt.m)(Qh,t.up,e.matrix)),this._constraintOptions.interactionType=ji.PAN,this._constraintOptions.selection=Wi.ALL,Do(this.view,t,this._constraintOptions))}},{key:"_applyZoom",value:function(e){if(e){var t=this.currentCamera.viewForward;this.currentCamera.eye=(0,Gt.a)(Qh,this.currentCamera.eye,(0,Gt.g)(Zs.WM.get(),t,e)),(0,Gt.c)(Jh,t),(0,Gt.o)(Jh,Jh),this._constraintOptions.interactionDirection=Jh,this._constraintOptions.interactionType=ji.ZOOM,this._constraintOptions.selection=Wi.ALL_EXCEPT_COLLISION,Do(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}}},{key:"_applyAscend",value:function(e){if(e){var t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Zs.WM.get());if(this._constraintOptions.interactionDirection=(0,Gt.c)(Jh,t),this.view.state.isGlobal){var n=(0,Gt.l)(this.currentCamera.eye),r=(n+e)/n;this.currentCamera.eye=(0,Gt.g)(Qh,this.currentCamera.eye,r),this.currentCamera.center=(0,Gt.g)(Qh,this.currentCamera.center,r)}else{var i=(0,Gt.g)(Zs.WM.get(),t,e);this.currentCamera.eye=(0,Gt.a)(Qh,this.currentCamera.eye,i),this.currentCamera.center=(0,Gt.a)(Qh,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=ji.ASCEND,this._constraintOptions.selection=Wi.COLLISION,Do(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Wi.ALL_EXCEPT_COLLISION,Do(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}}},{key:"_calculateControlTransformation",value:function(e,t,n){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,wn.i)(e.pan.matrix),e.rotate.enabled=!1,(0,wn.i)(e.rotate.matrix)}(n);var r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,n):this._calculateControlTransformationGlobal(r,t,n)}},{key:"_updateCameraCenter",value:function(){var e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,n=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(n,e,Qh)}},{key:"_calculateControlTransformationLocal",value:function(e,t,n){var r=t.viewRight,i=t.viewForward,a=this._transformation,o=this.view.navigation.gamepad,s=(0,Gt.s)(Zs.WM.get(),i[0],i[1],0);(0,Gt.n)(s,s);var l=a.translation[0]*e.pan;if(0!==l){var u=(0,Gt.g)(Zs.WM.get(),r,l);(0,wn.w)(n.pan.matrix,n.pan.matrix,u),n.pan.enabled=!0}switch(o.mode){case"pan":var c=-a.translation[1]*e.pan;if(0!==c){var h=(0,Gt.g)(Zs.WM.get(),s,c);(0,wn.w)(n.pan.matrix,n.pan.matrix,h),n.pan.enabled=!0}n.zoom=a.zoom*e.zoom;break;case"zoom":n.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:(0,Ue.Bg)(o.mode)}var d=a.translation[2]*e.ascend;n.ascend=d;var f=-a.heading*e.rotate;0!==f&&((0,wn.e)(n.rotate.matrix,n.rotate.matrix,f,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Zs.WM.get())),n.rotate.enabled=!0);var p=a.tilt*e.rotate,v=Ha(this.view.renderCoordsHelper,t.center,t.eye),m=(0,Se.uZ)(v+p,Ee.min,Ee.max)-v;m&&((0,wn.e)(n.rotate.matrix,n.rotate.matrix,m,r),n.rotate.enabled=!0)}},{key:"_calculateControlTransformationGlobal",value:function(e,t,n){var r=t.eye,i=t.viewRight,a=this._transformation,o=this.view.navigation.gamepad,s=(0,Gt.f)(Zs.WM.get(),i,r);(0,Gt.n)(s,s),(0,Gt.o)(s,s),Rl(this.startCamera,t,a,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,n,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Xh.pan,this._tmpCamera);var l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,u=a.translation[2]*e.ascend;n.ascend=u;var c=-a.heading*e.rotate;0!==c&&((0,wn.e)(n.rotate.matrix,n.rotate.matrix,c,this._tmpCamera.eye),n.rotate.enabled=!0);var h=a.tilt*e.rotate,d=this._clampTiltDeltaGlobalToValidRange(h,t.ray,l);0!==d&&((0,wn.e)(n.rotate.matrix,n.rotate.matrix,d,this._tmpCamera.viewRight),n.rotate.enabled=!0),n.zoom+=a.zoom*e.zoom}},{key:"_clampTiltDeltaGlobalToValidRange",value:function(e,t,n){var r=(0,qt.Iu)(this.view.spatialReference),i=rl(Ee.min,t.origin,n,r),a=0,o=0,s=Zs.WM.get();this.view.renderCoordsHelper.intersectManifold(t,n,s)?(a=rl(Ha(this.view.renderCoordsHelper,s,t.origin),t.origin,n,r),o=rl(Ee.max,t.origin,n,r)):((0,ea.b)((0,ea.e)(ea.t,n+r.radius),t,s),a=il((0,Se.ZF)(-(0,Gt.e)(t.direction,(0,Gt.n)(s,s))),t.origin,n,r),o=il(Ee.max,t.origin,n,r));return(0,Se.uZ)(a+e,i,o)-a}},{key:"_getPointAbsoluteSurfaceElevation",value:function(e,t,n){var r=this.view.renderCoordsHelper,i=r.getAltitude(e),a=t+Math.abs(i-t);return r.setAltitude(n,a,e),a}},{key:"_clampedDistanceToSurface",value:function(e,t){var n=this.view.renderCoordsHelper,r=this.view.state.camera,i=function(e,t,n,r,i){return tc(e).headingTiltToDirectionUp(t,n,r,i)}(this.view,t,0,Bh,Kh),a=i.direction,o=n.intersectManifoldClosestSilhouette((0,ta.re)(t,a),e,Zs.WM.get()),s=(0,Gt.i)(t,o),l=n.intersectManifoldClosestSilhouette((0,ta.re)(t,(0,Gt.r)(Zs.WM.get(),t,r.center)),e,Zs.WM.get()),u=(0,Gt.i)(t,l);return Math.min(s,u)}},{key:"_computeHeadingRotateRadius",value:function(e){var t=this.view,n=t.renderCoordsHelper,r=t.state,i=r.camera,a=r.isGlobal,o=n.intersectManifoldClosestSilhouette(i.ray,this._filteredSurfaceElevation,Zs.WM.get());if(a){var s=(0,Gt.b)(Zs.WM.get(),e,o),l=(0,Gt.l)(s);(0,Gt.g)(s,s,1/l);var u=(0,Gt.n)(Zs.WM.get(),e),c=(0,Se.ZF)((0,Gt.e)(u,s));return l*Math.sin(Math.min(Gh,c))}var h=(0,Gt.c)(Zs.WM.get(),e);return n.setAltitude(h,this._filteredSurfaceElevation),(0,Gt.i)(o,h)}},{key:"_minimumAscendVelocity",value:function(){return this.view.state.constraints.collision.enabled?0:jh}},{key:"_computeVelocities",value:function(e){var t=this._filteredSurfaceElevation,n=t+(0,qt.Iu)(this.view.spatialReference).radius,r=this.view.state,i=r.camera,a=r.isGlobal,o=Zs.WM.get(),s=this._getPointAbsoluteSurfaceElevation(i.eye,t,o),l=this._clampedDistanceToSurface(t,o),u=i.width/2,c=Wh*i.width,h=Wh*i.width,d=l*Math.tan(.5*i.fovX)/u,f=d/n,p=d/this._computeHeadingRotateRadius(o),v=s-t;return{pan:(a?f:d)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,Math.pow(2,c*e/u)*v-v),zoom:Math.pow(2,c*e/u)*l-l,rotate:(0,Se.uZ)(p*h,qh,Yh)*e}}},{key:"_applyDisabledMovementTypes",value:function(e){!(0,k.pC)(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,wn.i)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,wn.i)(e.rotate.matrix))}}],[{key:"activatesFor",value:function(e,t){var n=(0,Vh.CY)(t,e.navigation.gamepad,zh);return!("end"===t.action||(0,Vh._r)(n))}}]),n}(Rh);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Hh.prototype,"gamepadDevice",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Hh.prototype,"disableMovements",void 0),Hh=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.GamepadKeyboardController")],Hh);var zh={translation:[0,0,0],heading:0,tilt:0,zoom:0},Bh=80,Gh=(0,Se.Vl)(Bh),Wh=.75,jh=5,qh=(0,Se.Vl)(30),Yh=(0,Se.Vl)(80),Xh={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,Cn.c)()},rotate:{enabled:!1,matrix:(0,Cn.c)()}},Qh=(0,F.c)(),Jh=(0,F.c)(),Kh=Tu();var $h,ed=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,!0))._view=e,r._watchHandles=new K.Z,r._handle=r.registerIncoming("gamepad",(function(e){return r._handleEventGamepad(e)})),r._handle.pause(),r}return(0,l.Z)(n,[{key:"onInstall",value:function(e){var t=this;(0,c.Z)((0,h.Z)(n.prototype),"onInstall",this).call(this,e),this._watchHandles.add([(0,A.YP)((function(){return t._view.navigation.gamepad.enabled}),(function(e){e?t._handle.resume():(t._handle.pause(),t._cameraControllerGamepad&&(t._cameraControllerGamepad.finishController(),t._cameraControllerGamepad=null))}),A.nn),(0,A.YP)((function(){return t._view.navigation.gamepad.device}),(function(e){t._cameraControllerGamepad&&e&&t._cameraControllerGamepad.gamepadDevice!==e&&(t._cameraControllerGamepad.finishController(),t._cameraControllerGamepad=null)}))])}},{key:"onUninstall",value:function(){this._watchHandles.removeAll(),(0,c.Z)((0,h.Z)(n.prototype),"onUninstall",this).call(this)}},{key:"_handleEventGamepad",value:function(e){var t=this._view.navigation.gamepad.device;if(!t||e.data.device===t){var n=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(n||Hh.activatesFor(this._view,e.data)){if(!n){var r=new Hh({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(r)&&(this._cameraControllerGamepad=r)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}}]),n}(ru.a),td=n(4942);!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}($h||($h={}));var nd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i,a;return(0,s.Z)(this,n),(a=t.call(this,!0))._view=e,a._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:he.JY.Local},a._keyToNumber=(i={},(0,td.Z)(i,r.left,$h.LEFT),(0,td.Z)(i,r.right,$h.RIGHT),(0,td.Z)(i,r.forward,$h.FORWARD),(0,td.Z)(i,r.backward,$h.BACKWARD),(0,td.Z)(i,r.up,$h.UP),(0,td.Z)(i,r.down,$h.DOWN),(0,td.Z)(i,r.headingLeft,$h.HEADINGLEFT),(0,td.Z)(i,r.headingRight,$h.HEADINGRIGHT),(0,td.Z)(i,r.tiltUp,$h.TILTUP),(0,td.Z)(i,r.tiltDown,$h.TILTDOWN),(0,td.Z)(i,r.zoomIn,$h.ZOOMIN),(0,td.Z)(i,r.zoomOut,$h.ZOOMOUT),i),a.registerIncoming("key-down",null,(function(e){return a._handleKeyDown(e)})),a.registerIncoming("key-up",null,(function(e){return a._handleKeyUp(e)})),a.registerIncoming("blur",null,(function(){return a._handleBlur()})),a}return(0,l.Z)(n,[{key:"_handleKeyDown",value:function(e){if(!e.data.native.ctrlKey&&!e.data.native.metaKey){var t=this._keyToNumber[e.data.key];null!=t&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new Hh({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}}},{key:"_handleBlur",value:function(){this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}},{key:"_handleKeyUp",value:function(e){if(!e.data.native.ctrlKey&&!e.data.native.metaKey){var t=this._keyToNumber[e.data.key];null!=t&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}}]),n}(ru.a),rd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this,!0))._view=e,i.registerIncoming("mouse-wheel",r,(function(e){return i._handleMouseWheel(e)})),i}return(0,l.Z)(n,[{key:"_handleMouseWheel",value:function(e){if(this._view.navigation.mouseWheelZoomEnabled){var t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new Ql({view:this._view,mode:"interaction"}):new $l({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,(0,O.s1)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}}]),n}(ru.a),id=function(){function e(t){(0,s.Z)(this,e),this._gain=t}return(0,l.Z)(e,[{key:"reset",value:function(e){this._value=e}},{key:"gain",set:function(e){this._gain=e}},{key:"value",get:function(){return void 0===this._value?0:this._value}},{key:"update",value:function(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}]),e}(),ad=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._beginCamera=new Jo.V,e._elapsedTimeSec=0,e.constraintOptions={selection:Wi.ALL,interactionType:ji.PAN,interactionFactor:0,interactionStartCamera:new Jo.V,interactionDirection:null,tiltMode:qi.TUMBLE},e}return(0,l.Z)(n,[{key:"initialize",value:function(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ce.Z}},{key:"steppingFinished",get:function(){return this.momentum.isFinished(this._elapsedTimeSec)}},{key:"onControllerStart",value:function(e){this._beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this._beginCamera,(0,c.Z)((0,h.Z)(n.prototype),"onControllerStart",this).call(this,e)}},{key:"stepController",value:function(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Do(this.view,t,this.constraintOptions)}}]),n}(Ss),od=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).interactionType=ji.PAN,r._tmpPan=(0,F.c)(),r}return(0,l.Z)(n,[{key:"momentumStep",value:function(e,t){var n=this.momentum.value(e);(0,Gt.g)(this._tmpPan,this.momentum.direction,n),t.eye=(0,Gt.b)(sd,t.eye,this._tmpPan),t.center=(0,Gt.b)(sd,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}}]),n}(ad=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.momentum.MomentumController")],ad));(0,p._)([(0,Z.Cb)({constructOnly:!0})],od.prototype,"momentum",void 0),od=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],od);var sd=(0,F.c)(),ld=(0,F.c)(),ud=(0,F.c)(),cd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).interactionType=ji.PAN,r}return(0,l.Z)(n,[{key:"momentumStep",value:function(e,t){var n=this.momentum.value1(e),r=this.momentum.value2(e);(0,Gt.c)(ud,t.eye),(0,Gt.n)(ud,ud),(0,Gt.f)(this.momentum.axis2,ud,this.momentum.axis1),Tl(t,ld,this.momentum.axis1,n,this.momentum.axis2,r)}}]),n}(ad);(0,p._)([(0,Z.Cb)({constructOnly:!0})],cd.prototype,"momentum",void 0),cd=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],cd);var hd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).interactionType=ji.TUMBLE,r}return(0,l.Z)(n,[{key:"center",set:function(e){this._set("center",(0,F.a)(e))}},{key:"axis",set:function(e){this._set("axis",(0,F.a)(e))}},{key:"momentumStep",value:function(e,t){var n=this.momentum.value(e);Qs(t,this.center,Ds(this.axis,n))}}]),n}(ad);(0,p._)([(0,Z.Cb)({constructOnly:!0})],hd.prototype,"momentum",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hd.prototype,"center",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hd.prototype,"axis",null),hd=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.momentum.MomentumController")],hd);var dd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).interactionType=ji.ZOOM,r.constraintOptions.interactionDirection=(0,F.c)(),r}return(0,l.Z)(n,[{key:"zoomCenter",set:function(e){this._set("zoomCenter",(0,F.a)(e))}},{key:"momentumStep",value:function(e,t){var n=this.constraintOptions.interactionDirection;if(n){(0,Gt.c)(n,t.eye);var r=this.momentum.valueDelta(0,e);Ks(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),(0,Gt.r)(n,t.eye,n)}}}]),n}(ad);(0,p._)([(0,Z.Cb)({constructOnly:!0})],dd.prototype,"momentum",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],dd.prototype,"zoomCenter",null),dd=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],dd);var fd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).interactionType=ji.ZOOM,r.radius=0,r._tmpSceneCenter=(0,F.c)(),r._tmpZoomAxisAngle=Is(),r._sphere=(0,ea.c)(),r}return(0,l.Z)(n,[{key:"screenCenter",set:function(e){this._set("screenCenter",(0,O.s1)(e[0],e[1]))}},{key:"sceneCenter",set:function(e){this._set("sceneCenter",(0,F.a)(e))}},{key:"initialize",value:function(){this._sphere[3]=this.radius}},{key:"momentumStep",value:function(e,t){var n=this.momentum.valueDelta(0,e);$s(this._sphere,t,n),this.constraintOptions.interactionType=ji.ZOOM,Do(this.view,t,this.constraintOptions),vl(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Ns(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Qs(t,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=ji.PAN}}]),n}(ad);(0,p._)([(0,Z.Cb)({constructOnly:!0})],fd.prototype,"momentum",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],fd.prototype,"screenCenter",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],fd.prototype,"sceneCenter",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],fd.prototype,"radius",void 0),fd=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],fd);var pd=n(87022),vd=n(78738),md=function(){function e(t){(0,s.Z)(this,e),this._gain=t}return(0,l.Z)(e,[{key:"update",value:function(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}},{key:"reset",value:function(){this.filteredValue=void 0}},{key:"hasFilteredValue",get:function(){return void 0!==this.filteredValue}}]),e}(),_d=n(99742),yd=1e-5,gd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i,a,o){var l,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6?arguments[6]:void 0;return(0,s.Z)(this,n),(l=t.call(this,e,r,i))._angularVelocity1=a,l.axis1=o,l.angularVelocity2=u,l.axis2=c,l}return(0,l.Z)(n,[{key:"value1",value:function(e){return(0,c.Z)((0,h.Z)(n.prototype),"valueFromInitialVelocity",this).call(this,this._angularVelocity1,e)}},{key:"value2",value:function(e){return(0,c.Z)((0,h.Z)(n.prototype),"valueFromInitialVelocity",this).call(this,this.angularVelocity2,e)}}]),n}(_d.X),bd=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;(0,s.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=n,this._friction=r,this.enabled=!0,this._tmpAxis1=(0,F.c)(),this._tmpAxis2=(0,F.c)(),this._tmpAngles=(0,Jt.a)(),this._time=new vd.J(.3),this._screen=[new vd.J(.4),new vd.J(.4)],this._angle1=new md(.6),this._angle2=new md(.6),this._axis1=(0,F.c)(),this._axis2=(0,F.c)(),this._lastScene=(0,F.c)()}return(0,l.Z)(e,[{key:"addMomentumDirectRotation",value:function(e,t,n,r,i,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(n)<.01)return;var o=gl(this._lastScene,t,this._tmpAxis2,r,i,a);this._angle2.update(0),(0,Gt.p)(this._tmpAxis2)<yd?o=0:(0,Gt.n)(this._axis1,this._tmpAxis2),this._angle1.update(o),(0,Gt.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(n)}}},{key:"addMomentumPreserveHeading",value:function(e,t,n,r,i,a,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(n)<.01)return;Cl(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,i,a,o,!1),(0,Gt.p)(this._tmpAxis2)<yd?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,Gt.n)(this._axis1,this._tmpAxis1),(0,Gt.n)(this._axis2,this._tmpAxis2)),(0,Gt.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(n)}}},{key:"reset",value:function(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;var e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,n=null==e||null==t?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,i=null==n||null==r?0:n/r;return Math.abs(i)<this._minimumInitialVelocity?null:this.createMomentum(i,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,n){var r=this._time.filteredDelta,i=this._angle1.filteredValue,a=this._angle2.filteredValue,o=null==r||null==a?0:a/r;return new gd(e,t,n,null==r||null==i?0:i/r,this._axis1,o,this._axis2)}}]),e}(),wd=n(19475),Cd=n(62124),xd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._smoothRotation=new id(.05),e._rotationAxis=(0,F.c)(),e._beginAngle=0,e._beginHeading=0,e._panningPlane=(0,Us.Ue)(),e._beginRadius=0,e._smoothScaling=new id(.05),e._zoomCenterScreen=(0,O.s1)(),e._zoomMomentumEstimator=new Cd.D,e._rotationMomentumEstimator=new wd.y,e._panSphericalMomentumEstimator=new bd,e._panPlanarMomentumEstimator=new pd.G,e._adjustedSphere=(0,ea.c)(),e._tmp3d=(0,F.c)(),e._tmpScreenPointArray=(0,O.s1)(),e._beginScreenPoint=(0,O.s1)(),e._beginScenePoint=(0,F.c)(),e._screenPickPoint=(0,O.s1)(),e._scenePickPoint=(0,F.c)(),e._mode=el.Horizontal,e._sphere=(0,ea.c)(),e._pointerCount=0,e._tmpInteractionDirection=(0,F.c)(),e._constraintOptions={selection:Wi.ALL,interactionType:ji.NONE,interactionFactor:0,interactionStartCamera:new Jo.V,interactionDirection:null,tiltMode:qi.TUMBLE},e}return(0,l.Z)(n,[{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}},{key:"begin",value:function(e){var t;if(this.active){var n=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=n,this._rotationMomentumEstimator.enabled=n,this._panPlanarMomentumEstimator.enabled=n,this._panSphericalMomentumEstimator.enabled=n,this._beginHeading=-As.Q4.normalize((0,Se.Vl)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,O.md)(e.center,this._screenPickPoint),(0,Yt.c)(this._beginScreenPoint,this._screenPickPoint);var r=(0,qt.Iu)(this.view.spatialReference),i=hl(this._intersectionHelper,this.startCamera,this._screenPickPoint,r,zs.Silhouette,0===this.view.map.ground.opacity?qs:{});(0,k.Wi)(i.scenePickPoint)||(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,(0,Gt.c)(this._beginScenePoint,this._scenePickPoint),this._mode=dl(this.startCamera,this._screenPickPoint,r),this._mode===el.Vertical&&this._preparePlanarPanMode(e,i.hasGeometryIntersection),null===(t=this._constraintOptions.interactionStartCamera)||void 0===t||t.copyFrom(this.startCamera))}}},{key:"update",value:function(e){if(this.active){this.currentCamera.copyFrom(this.startCamera);var t=e.pointers.size>1;this._mode===el.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}}},{key:"end",value:function(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();var t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._mode===el.Horizontal?new fd({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new dd({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});var n=this._rotationMomentumEstimator.evaluateMomentum();if(n)return new hd({view:this.view,momentum:n,center:this._sphere,axis:this._rotationAxis});if(this._mode===el.Horizontal){var r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new cd({view:this.view,momentum:r})}else{var i=this._panPlanarMomentumEstimator.evaluateMomentum();if(i)return new od({view:this.view,momentum:i})}return null}},{key:"_preparePlanarPanMode",value:function(e,t){var n=(0,Gt.o)(this._tmp3d,this.startCamera.viewForward);(0,Us.Yq)(this._scenePickPoint,n,this._panningPlane);var r=(0,O.s1)(this._screenPickPoint[0],0),i=(0,F.c)(),a=(0,Gt.l)(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],vl(this._adjustedSphere,this.startCamera,r,i);var o=(0,O.J$)();this.startCamera.projectToRenderScreen(i,o);var s=(0,F.c)(),l=(0,F.c)(),u=(0,F.c)();(0,Gt.b)(s,this._scenePickPoint,this.currentCamera.eye);var c=(0,Gt.l)(s);(0,Gt.n)(s,s);var h=5*Math.max(Math.abs(this.view.camera.position.z),50),d=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80),f=(0,k.pC)(d)?d:h;f=t?Math.min(f,c):f,(0,Gt.c)(u,(0,Gt.a)(l,this.currentCamera.eye,(0,Gt.g)(l,s,f))),this._panningPlane[3]=-(0,Gt.e)((0,Us.mJ)(this._panningPlane),u),this.startCamera.center=(0,Gt.a)(l,this.startCamera.eye,(0,Gt.g)(l,this.startCamera.viewForward,f));var p=(0,O.md)(e.center,this._tmpScreenPointArray);Js(this._panningPlane,this.startCamera,p,this._beginScenePoint)}},{key:"_zoomSpherical",value:function(e){var t=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=n,this._smoothScaling.update(t),$s(this._sphere,this.currentCamera,this._smoothScaling.value),(0,O.md)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=ji.ZOOM,this._constraintOptions.interactionFactor=No(e.radius-this._beginRadius),Do(this.view,this.currentCamera,this._constraintOptions)}},{key:"_panningSpherical",value:function(e){var t=(0,O.md)(e.center,this._tmpScreenPointArray);vl(this._sphere,this.currentCamera,t,this._tmp3d),Sl(this._beginScenePoint,(0,Gt.e)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(Pl(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(kl(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=ji.PAN,this._constraintOptions.interactionFactor=No((0,Yt.d)(this._screenPickPoint,t)),Do(this.view,this.currentCamera,this._constraintOptions)}},{key:"_rotateSpherical",value:function(e){(0,Gt.n)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,Gt.o)(this._rotationAxis,this._rotationAxis);var t=this._smoothRotation.value,n=t+Xs(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(n);var i=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(i,.001*e.timestamp),Qs(this.currentCamera,this._sphere,Ds(this._rotationAxis,i)),this._constraintOptions.interactionType=ji.TUMBLE,this._constraintOptions.interactionFactor=No(e.radius*n),Do(this.view,this.currentCamera,this._constraintOptions)}},{key:"_panningPlanar",value:function(e){var t=(0,O.md)(e.center,this._tmpScreenPointArray);Js(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(fl(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=ji.PAN,this._constraintOptions.interactionFactor=No((0,Yt.d)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Do(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}},{key:"_zoomPlanar",value:function(e){var t=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=n,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Ks(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=ji.ZOOM,this._constraintOptions.interactionFactor=No(e.radius-this._beginRadius),Do(this.view,this.currentCamera,this._constraintOptions)}},{key:"_rotatePlanar",value:function(e){(0,Gt.c)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,Gt.o)(this._rotationAxis,this._rotationAxis);var t=this._smoothRotation.value,n=e.angle-t,r=t+(n=Xs(n)),i=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=i,this._smoothRotation.update(r);var a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),Qs(this.currentCamera,this._sphere,Ds(this._rotationAxis,a)),this._constraintOptions.interactionType=ji.TUMBLE,this._constraintOptions.interactionFactor=No(e.radius*a),Do(this.view,this.currentCamera,this._constraintOptions)}}]),n}(Rh);xd=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.global.PinchAndPanController")],xd);var Td=(0,F.f)(0,0,1),Sd=16/180*Math.PI,kd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._rotationValueSmooth=new id(.05),e._scalingValueSmooth=new id(.05),e._planeHorizontal=(0,Us.Ue)(),e._planeVertical=(0,Us.Ue)(),e._rotationMomentumEstimator=new wd.y,e._panMomentumEstimator=new pd.G(300,12,.9),e._zoomMomentumEstimator=new Cd.D,e._beginRadius=0,e._beginCenter=(0,F.c)(),e._beginAngle=0,e._tmpPoints=[],e._panMode=el.Horizontal,e._beginCenterScreen=(0,O.s1)(),e._tmpCentroid3d=(0,F.c)(),e._tmpCentroid2d=(0,O.s1)(),e._tmp2d=(0,O.s1)(),e._pointerCount=0,e._constraintOptions={selection:Wi.ALL,interactionType:ji.NONE,interactionFactor:0,interactionStartCamera:new Jo.V,interactionDirection:null,tiltMode:qi.TUMBLE},e}return(0,l.Z)(n,[{key:"begin",value:function(e){var t;if(this.active){var n=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=n,this._rotationMomentumEstimator.enabled=n,this._panMomentumEstimator.enabled=n,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,O.md)(e.center,this._beginCenterScreen),(0,Us.Oy)(Td,0,this._planeHorizontal);var r=(0,F.c)(),i=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,r,0===this.view.map.ground.opacity?qs:{}),a=(0,F.c)();(0,Gt.o)(a,this.startCamera.viewForward);var o=(0,F.c)();(0,Gt.c)(o,Td);var s=(0,Gt.e)(a,o),l=(0,Se.Kt)(s<0?-s:s);this._panMode=l>=Sd?el.Horizontal:el.Vertical;var u=Math.min(5,1/Math.abs((0,Gt.e)(o,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);(0,Us.T5)(this._planeHorizontal,this._planeHorizontal,r),this.startCamera.aboveGround||(0,Us.tk)(this._planeHorizontal,this._planeHorizontal);var c=(0,F.c)(),h=(0,F.c)(),d=(0,F.c)();(0,Gt.b)(c,r,this.currentCamera.eye);var f=(0,Gt.l)(c);if((0,Gt.n)(c,c),this._panMode===el.Vertical){(0,Gt.g)(o,o,s),(0,Gt.b)(this._planeVertical,a,o),(0,Gt.n)(this._planeVertical,this._planeVertical),(0,Us.T5)(this._planeVertical,this._planeVertical,r);var p=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80),v=(0,k.pC)(p)?p:u;v=i?Math.min(v,f):v,(0,Gt.c)(d,(0,Gt.a)(h,this.currentCamera.eye,(0,Gt.g)(h,c,v))),this._planeVertical[3]=-(0,Gt.e)(this._planeVertical,d),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),nl(this._tmpPoints,this._beginCenter)}else{var m=i?f:u;(0,Gt.c)(d,(0,Gt.a)(h,this.currentCamera.eye,(0,Gt.g)(h,c,m))),this._planeHorizontal[3]=-(0,Gt.e)((0,Us.mJ)(this._planeHorizontal),d),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),nl(this._tmpPoints,this._beginCenter)}null===(t=this._constraintOptions.interactionStartCamera)||void 0===t||t.copyFrom(this.startCamera)}}},{key:"update",value:function(e){if(this.active){this.currentCamera.copyFrom(this.startCamera);var t=e.pointers.size>1,n=this._panMode===el.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){var i=this._beginRadius/e.radius,a=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=a,this._scalingValueSmooth.update(i),Ks(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=ji.ZOOM,this._constraintOptions.interactionFactor=No(Math.abs(e.radius-this._beginRadius)),Do(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,n,this.currentCamera,this._tmpPoints),nl(this._tmpPoints,this._tmpCentroid3d),(0,O.md)(e.center,this._tmpCentroid2d),fl(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=ji.PAN,this._constraintOptions.interactionFactor=No((0,Yt.d)(this._beginCenterScreen,this._tmpCentroid2d)),Do(this.view,this.currentCamera,this._constraintOptions),t){var o=this._planeHorizontal,s=r,l=this._rotationValueSmooth.value,u=l+Xs(e.angle-l),c=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=c,this._rotationValueSmooth.update(u);var h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp),Qs(this.currentCamera,s,Ds(o,h)),this._constraintOptions.interactionType=ji.TUMBLE,this._constraintOptions.interactionFactor=No(Math.abs(e.radius*h)),Do(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}}},{key:"end",value:function(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();var t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new dd({view:this.view,momentum:t,zoomCenter:this._beginCenter});var n=this._rotationMomentumEstimator.evaluateMomentum();if(n)return new hd({view:this.view,momentum:n,center:this._beginCenter,axis:(0,Us.mJ)(this._planeHorizontal)});var r=this._panMomentumEstimator.evaluateMomentum();return r?new od({view:this.view,momentum:r}):null}},{key:"_computePlanePoints",value:function(e,t,n,r){r.length=e.size;var i=this._tmp2d,a=0;return e.forEach((function(e){i[0]=e.x,i[1]=e.y,void 0===r[a]&&(r[a]=(0,F.c)()),Js(t,n,i,r[a]),a+=1})),r}},{key:"_intersectionHelper",get:function(){return this.view.sceneIntersectionHelper}}]),n}(Rh);kd=(0,p._)([(0,L.j)("esri.views.3d.state.controllers.local.PinchAndPanController")],kd);var Pd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this,!0))._view=e,a.pointerAction=r,a._lastEndTimestamp=0,a._lastTimestamp=0,a.registerIncoming("drag",i,(function(e){return a._handleDrag(e)})),a}return(0,l.Z)(n,[{key:"_handleDrag",value:function(e){if("mouse"!==e.data.pointerType||(0,iu.b)(e.data,this.pointerAction)){var t=e.timestamp-this._lastEndTimestamp,n=this._momentum&&this._momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(n)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}}},{key:"_endController",value:function(e,t){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;var n=this._controller.end(e.data);t&&n&&(this._momentum=n,this._view.state.switchCameraController(this._momentum))}this._controller=null}},{key:"_startController",value:function(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}},{key:"_createController",value:function(){return this._view.state.isGlobal?new xd({view:this._view}):new kd({view:this._view})}}]),n}(ru.a),Rd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this,!0)).view=e,i.registerIncoming("pointer-down",r,(function(){return i.view.state.stopActiveCameraController()})),i}return(0,l.Z)(n)}(ru.a),Ad=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this,!0)).key=e,i.registerIncoming("key-down",r,(function(e){return i._handleKeyDown(e)})),i}return(0,l.Z)(n,[{key:"_handleKeyDown",value:function(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}]),n}(ru.a),Ed=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this,r,i)).view=e,a}return(0,l.Z)(n,[{key:"activate",value:function(){this.view.goTo({heading:0}).catch((function(){}))}}]),n}(Ad),Od=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this,r,i)).view=e,a}return(0,l.Z)(n,[{key:"activate",value:function(){this.view.goTo({tilt:0}).catch((function(){}))}}]),n}(Ad),Md=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,s.Z)(this,n),(r=t.call(this,!0))._view=e,r._invert=i,r.registerIncoming("vertical-two-finger-drag",(function(e){return r._handleTwoFinger(e)})),r}return(0,l.Z)(n,[{key:"_handleTwoFinger",value:function(e){var t,n,r,i=this._invert?-1:1,a=(0,O.s1)(0,e.data.delta*i);switch(e.data.action){case"begin":null!==(t=this._cameraController)&&void 0!==t&&t.end(),this._cameraController=new Ah({view:this._view,pivot:yh.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(a);break;case"update":null===(n=this._cameraController)||void 0===n||n.update(a);break;case"end":null!==(r=this._cameraController)&&void 0!==r&&r.end(),this._cameraController=null}}}]),n}(ru.a),Zd=n(31822),Id=n(1614),Dd=n(83659),Ld=n(33666),Nd=n(11802),Fd=n(64544),Ud=n(46525),Vd=n(43308),Hd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40;return(0,s.Z)(this,n),(e=t.call(this,!1))._threshold=r,e._maxDelta=i,e._state="ready",e._emittedArtificalEnd2=!1,e._vertical=e.registerOutgoing("vertical-two-finger-drag"),e._artificalDrag=e.registerOutgoing("drag"),e._dragEventSeparator=new Vd.H({start:function(t,n){return e._observeStart(t,n)},update:function(t,n,r){return e._observeUpdate(t,n,r)},end:function(t,n){return e._observeEnd(n)}}),e.registerIncoming("drag",(function(t){return e._dragEventSeparator.handle(t)})),e}return(0,l.Z)(n,[{key:"failed",get:function(){return"failed"===this._state}},{key:"_observeStart",value:function(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}},{key:"_observeUpdate",value:function(e,t,n){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,n.data)?this._checkVerticalThresholdReached(t.data,n.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}},{key:"_observeEnd",value:function(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}},{key:"_checkMovementWithinLimits",value:function(e,t){var n,r=-1/0,a=1/0,o=-1/0,s=1/0,l=(0,i.Z)(t.pointers.values());try{for(l.s();!(n=l.n()).done;){var u=n.value,c=u.x,h=u.y;r=Math.max(r,c),a=Math.min(a,c),o=Math.max(o,h),s=Math.min(s,h)}}catch(S){l.e(S)}finally{l.f()}var d,f=-1/0,p=1/0,v=-1/0,m=1/0,_=(0,i.Z)(e.pointers.values());try{for(_.s();!(d=_.n()).done;){var y=d.value,g=y.x,b=y.y;f=Math.max(f,g),p=Math.min(p,g),v=Math.max(v,b),m=Math.min(m,b)}}catch(S){_.e(S)}finally{_.f()}var w=r-a,C=o-s,x=f-p,T=v-m;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(x-w)<=this._maxDelta&&Math.abs(T-C)<=this._maxDelta}},{key:"_checkVerticalThresholdReached",value:function(e,t){var n=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((function(e,r){var i=t.pointers.get(r);n=Math.min(n,Math.abs(e.y-i.y))})),n>=this._threshold}}]),n}(ru.a),zd=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._handles=new K.Z,e}return(0,l.Z)(n,[{key:"destroy",value:function(){this._handles=(0,k.SC)(this._handles),this.disconnect()}},{key:"primaryDragAction",get:function(){return this._get("primaryDragAction")},set:function(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}},{key:"mode",get:function(){return this._get("mode")},set:function(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}},{key:"hasPendingInputs",get:function(){var e;return!(null===(e=this._inputManager)||void 0===e||!e.hasPendingInputs)}},{key:"latestPointerType",get:function(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerType}},{key:"latestPointerLocation",get:function(){var e;return null===(e=this._inputManager)||void 0===e?void 0:e.latestPointerLocation}},{key:"multiTouchActive",get:function(){var e,t;return null!==(e=null===(t=this._inputManager)||void 0===t?void 0:t.multiTouchActive)&&void 0!==e&&e}},{key:"disconnect",value:function(){this.view.viewEvents.disconnect(),this._inputManager=(0,k.SC)(this._inputManager)}},{key:"connect",value:function(){var e=this,t=this.view;this._source=new Zd.z(this.view.surface,t.input);var n=[new Nd.y,new Fd.e,new Ud.y,new Ld.n(this.view.navigation),new Hd],r=new Id.$({eventSource:this._source,recognizers:n});this._inputManager=r,r.installHandlers("prevent-context-menu",[new Dd.G],Id.f.INTERNAL),this._modeDragPan=new Pd(t,"primary"),this._modeDragRotate=new Mh(t,"secondary",yh.CENTER),this._modeDragZoom=new Uh(t,"tertiary");var i="b",a={left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},o="n",s="p";r.installHandlers("navigation",[new Rd(t),new au(t),new ed(t),new nd(t,a),new rd(t),new Od(t,s),new Ed(t,o),new Mh(t,"primary",yh.EYE,[i]),new Mh(t,"secondary",yh.CENTER,[i]),new Pd(t,"tertiary",[i]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Md(t)],Id.f.INTERNAL),this.view.viewEvents.connect(r),this._updateMode(),this._handles.add((0,A.YP)((function(){var t;return null===(t=e.view.navigation)||void 0===t?void 0:t.browserTouchPanEnabled}),(function(t){e._source.browserTouchPanningEnabled=!t}),A.nn))}},{key:"_updateMode",value:function(){var e,t=this.mode,n=this.primaryDragAction,r=null===(e=Bd.get(t))||void 0===e?void 0:e.get(n);r&&(this._modeDragPan&&(this._modeDragPan.pointerAction=r.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=r.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=r.zoom))}},{key:"test",get:function(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],zd.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({value:"pan"})],zd.prototype,"primaryDragAction",null),(0,p._)([(0,Z.Cb)({value:"default"})],zd.prototype,"mode",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],zd.prototype,"hasPendingInputs",null),(0,p._)([(0,Z.Cb)()],zd.prototype,"latestPointerType",null),(0,p._)([(0,Z.Cb)()],zd.prototype,"latestPointerLocation",null),(0,p._)([(0,Z.Cb)()],zd.prototype,"multiTouchActive",null),(0,p._)([(0,Z.Cb)()],zd.prototype,"_inputManager",void 0),zd=(0,p._)([(0,L.j)("esri.views.3d.input.SceneInputManager")],zd);var Bd=new Map,Gd=new Map,Wd=new Map;Gd.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Gd.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Wd.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Wd.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),Bd.set("default",Gd),Bd.set("pro",Wd);var jd,qd,Yd=zd,Xd=n(77427),Qd=n(27546),Jd=n(94463),Kd=!1,$d=!1,ef=!1,tf=!1,nf=null;function rf(e){ef=Jd.Z.DECONFLICTOR_SHOW_VISIBLE,tf=Jd.Z.DECONFLICTOR_SHOW_INVISIBLE,Kd=ef||tf,$d=Jd.Z.DECONFLICTOR_SHOW_GRID,nf=null,Kd||$d?nf=function(){return function(e){null==jd&&((jd=document.createElement("canvas")).setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(jd));var t=e.state,n=t.camera,r=t.pixelRatio,i=n.width,a=n.height,o=i*r,s=a*r;jd.setAttribute("width","".concat(o,"px")),jd.setAttribute("height","".concat(s,"px")),jd.setAttribute("style","position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:".concat(i,"px;height:").concat(a,"px")),(qd=jd.getContext("2d")).clearRect(0,0,i,a),qd.font="12px Arial"}(e)}:jd&&(jd.parentElement.removeChild(jd),jd=null)}function af(){nf&&(nf(),nf=null)}function of(e,t,n,r,i){af();var a=jd.height,o=qd;o.beginPath(),o.lineWidth=1,o.strokeStyle=i,o.moveTo(e,a-n),o.lineTo(t,a-n),o.stroke(),o.lineTo(t,a-r),o.stroke(),o.lineTo(t,a-n),o.stroke(),o.lineTo(e,a-n),o.stroke(),o.lineTo(e,a-n),o.stroke(),o.closePath()}function sf(e,t){Kd&&(t&&ef||!t&&tf)&&of(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var lf,uf=n(70446),cf=n(65216),hf=n(21400),df=n(21166),ff=(0,a.Z)().mark(Rf),pf=(0,a.Z)().mark(Af),vf=(0,F.c)(),mf=(0,Wt.c)(),_f=(0,Wt.c)(),yf=(0,F.c)(),gf=(0,Cn.c)(),bf=(0,ea.c)(),wf=(0,ta.Ue)(),Cf=(0,F.c)(),xf=(0,z.Ue)(),Tf=(0,l.Z)((function e(){(0,s.Z)(this,e),this.aabr=(0,z.Ue)(),this.distance=0,this.culled=!1,this.visible=!1})),Sf=(0,l.Z)((function e(t,n){(0,s.Z)(this,e),this.graphics3DGraphic=t,this.slicePlaneEnabled=n,this.info={}}));!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(lf||(lf={}));var kf=function(){function e(){(0,s.Z)(this,e),this.camera=new Jo.V,this.slicePlane=(0,B.a)(),this.slicePlaneEnabled=!1}return(0,l.Z)(e,[{key:"copyFrom",value:function(e){this.camera.copyFrom(e.camera),(0,B.c)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}]),e}(),Pf=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._dirty=!1,r._runningViewState=new kf,r._state=lf.Idle,r._active=new Map,r._visible=new Map,r._iterators=new Of,r._accBinsNumX=15,r._accBinsNumY=20,r._accBinsSizeX=0,r._accBinsSizeY=0,r._accBins=null,r.accNumTests=0,r}return(0,l.Z)(n,[{key:"dirty",get:function(){return this._dirty}},{key:"state",get:function(){return this._state}},{key:"destroy",value:function(){this._active.clear(),this._visible.clear(),this._iterators=null}},{key:"setDirty",value:function(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}},{key:"updating",get:function(){return this._state!==lf.Idle||this._dirty}},{key:"updatingProgress",get:function(){if(!this.updating)return 1;var e=this._state/lf.NumStates;return this._dirty?.5*e:e}},{key:"running",get:function(){return this.view.ready&&null!=this.view.state&&this.updating}},{key:"runTask",value:function(e){switch(this._state){case lf.Idle:this._startUpdate(),e.madeProgress();case lf.Process:if(this._state=lf.Process,!this._processActiveGraphics(e))return;case lf.Sort:if(this._state=lf.Sort,!this._sortVisibleGraphics(e))return;case lf.Deconflict:if(this._state=lf.Deconflict,!this._deconflictVisibleGraphics(e))return;default:(function(e,t){if($d&&qd){af();for(var n=qd,r=0,i=0;i<e.accBinsNumX;i++)for(var a=0;a<e.accBinsNumY;a++){var o=e.accBins[i][e.accBinsNumY-1-a];r+=o.length;var s=i*e.accBinsSizeX,l=(i+1)*e.accBinsSizeX,u=a*e.accBinsSizeY,c=(a+1)*e.accBinsSizeY;n.fillText(o.length.toFixed(),s+5,u+15),of(s,l,u,c,"blue")}n.fillText("total totalShownLabels: "+r,70,40),n.fillText("total visible labels: "+t.size,70,50),n.fillText("total numTests: "+e.accNumTests,70,30)}})(this,this._visible),this._state=lf.Idle,this.notifyChange("updating")}}},{key:"modifyGraphics",value:function(e,t){var n=this;t?e.forEach((function(e){return n.addToActiveGraphics(e)})):e.forEach((function(e){return n.removeFromActiveGraphics(e)})),this.setDirty()}},{key:"layerSupportsDeconfliction",value:function(e){if((0,k.Wi)(e)||"object3d"!==e.type)return!1;var t=e.stageObject;if(1!==(t?t.geometries.length:0))return!1;var n=null===t||void 0===t?void 0:t.geometries[0];return(null===n||void 0===n?void 0:n.material)instanceof hf.A}},{key:"_startUpdate",value:function(){rf(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);var e=this._runningViewState.camera,t=e.fullWidth,n=e.fullHeight;this._initBins(t,n),this._resetIterators()}},{key:"addToActiveGraphics",value:function(e){e.info[this.visibilityGroup]=new Tf,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}},{key:"removeFromActiveGraphics",value:function(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),function(e,t){var n=e.graphics3DGraphic;n.destroyed||n.clearVisibilityFlag(uf.P.DECONFLICTION,t)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}},{key:"_processActiveGraphics",value:function(e){var t=this._ensureActiveGraphicsIterator(),n=(0,wn.p)(gf,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?bf:null,i=0;for((0,k.pC)(r)&&((0,Gt.m)(r,F.Z,this._runningViewState.camera.viewMatrix),r[3]=(0,qt.Iu)(this.view.spatialReference).radius,i=(0,ea.d)(r,F.Z));!e.done;){e.madeProgress();var a=t.next();if(!0===a.done)return this._resetActiveGraphicsIterator(),!0;var o=a.value,s=o&&o.info[this.visibilityGroup];s&&(this._collectGraphics3DGraphics(o,n,r,i),s.culled?this._visible.delete(o.graphics3DGraphic.graphic.uid):this._visible.set(o.graphics3DGraphic.graphic.uid,o))}return!1}},{key:"_sortVisibleGraphics",value:function(e){for(var t=this._ensureSortGraphicsIterator();!e.done;){var n=t.next();if(e.madeProgress(),!0===n.done)return this._resetSortGraphicsIterator(),!0}return!1}},{key:"_deconflictVisibleGraphics",value:function(e){for(var t=this._ensureVisibleGraphicsIterator(),n=this.visibilityGroup===uf.E.LABEL;!e.done;){e.madeProgress();var r=t.next();if(!0===r.done)return this._resetVisibleGraphicsIterator(),!0;var i=r.value,a=i.info[this.visibilityGroup];if(a&&!a.culled){var o=i.graphics3DGraphic,s=(!n||o.isVisible())&&!this._isConflicted(i);s&&this._addToBins(i),a.visible=s,this._setGraphicVisibility(i,s),sf(a,s)}}return!1}},{key:"_resetIterators",value:function(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}},{key:"_ensureActiveGraphicsIterator",value:function(){return this._iterators.active||(this._iterators.active=Rf(this._active)),this._iterators.active}},{key:"_resetActiveGraphicsIterator",value:function(){this._iterators.active=null}},{key:"_ensureVisibleGraphicsIterator",value:function(){return this._iterators.visible||(this._iterators.visible=Rf(this._visible)),this._iterators.visible}},{key:"_resetVisibleGraphicsIterator",value:function(){this._iterators.visible=null}},{key:"_ensureSortGraphicsIterator",value:function(){return this._iterators.sort||(this._iterators.sort=Af(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}},{key:"_resetSortGraphicsIterator",value:function(){this._iterators.sort=null}},{key:"_collectGraphics3DGraphics",value:function(e,t,n,r){var a=e.graphics3DGraphic;if(!a.destroyed){var o=e.info[this.visibilityGroup];if(a.isVisible(uf.E.GRAPHIC,uf.P.DECONFLICTION)){var s=this.getGraphicsLayers(a);(0,z.cS)(o.aabr);var l,u=null,c=(0,i.Z)(s);try{for(c.s();!(l=c.n()).done;){var h=l.value;if(this.layerSupportsDeconfliction(h)){var d=h.stageObject.geometries[0].material;if((0,k.Wi)(u)){if(u=If,this._getProjectionInfo(h,t,u),u.isOutsideScreen||this._isCulledBySlice(e,vf)||(0,k.pC)(n)&&this._isCulledByHorizon(u,n,r))return void(o.culled=!0);!Jd.Z.TESTS_DISABLE_OPTIMIZATIONS&&o.visible&&(u.distance*=.7)}this._expandBoundingRect(o,h,d,u)}}}catch(f){c.e(f)}finally{c.f()}(0,k.Wi)(u)?o.culled=!0:(o.distance=u.distance,o.culled=!1)}else o.culled=!0}}},{key:"_getProjectionInfo",value:function(e,t,n){var r=this._runningViewState.camera,i=e.stageObject,a=i.geometries[0],o=a.material,s=(0,ea.g)(i.boundingVolumeWorldSpace.bounds);(0,Gt.m)(vf,s,r.viewMatrix);var l=a.vertexAttributes,u=l.get(tr.T.NORMAL).data,c=l.get(tr.T.AUXPOS1).data;o.applyShaderOffsetsView(vf,u,i.transformation,c,r,n.scaleInfo,vf),(0,Xt.s)(mf,vf[0],vf[1],vf[2],1),(0,Xt.t)(_f,mf,r.projectionMatrix),(0,Gt.g)(n.positionNDC,_f,1/_f[3]),o.applyShaderOffsetsNDC(n.positionNDC,c,r,n.positionNDC,yf),n.distanceWithoutPolygonOffset=r.depthNDCToWorld(yf[2]),n.distance=yf[2]===n.positionNDC[2]?n.distanceWithoutPolygonOffset:r.depthNDCToWorld(n.positionNDC[2]),(0,Xt.s)(_f,n.positionNDC[0],n.positionNDC[1],n.positionNDC[2],1),(0,Xt.t)(mf,_f,t),(0,Xt.b)(mf,mf,1/mf[3]),(0,Gt.s)(n.positionView,vf[0],vf[1],vf[2])}},{key:"_isCulledByHorizon",value:function(e,t,n){return(0,Gt.c)(wf.direction,e.positionView),(0,Gt.s)(wf.origin,0,0,0),!!(0,ea.i)(t,wf,Cf)&&e.distanceWithoutPolygonOffset>n}},{key:"_isCulledBySlice",value:function(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&(0,B.e)(this._runningViewState.slicePlane,t)}},{key:"_expandBoundingRect",value:function(e,t,n,r){var i=r.positionNDC,a=r.scaleInfo,o=this._runningViewState.camera,s=t.getScreenSize(Mf);(0,cf.TU)(s,a.factor,s),s[0]*=o.pixelRatio,s[1]*=o.pixelRatio;var l=(0,z.cv)(n.calculateRelativeScreenBounds(s,a.factorAlignment.scale,xf),(0,Se.t7)(0,o.fullWidth,.5+.5*i[0]),(0,Se.t7)(0,o.fullHeight,.5+.5*i[1])),u=this.iconMarginFactor;if(0!==u){var c=u*Math.min((0,z.bf)(l),(0,z.Cb)(l));l[0]-=c,l[1]-=c,l[2]+=c,l[3]+=c}(0,z.jn)(e.aabr,l,e.aabr)}},{key:"_isConflicted",value:function(e){for(var t=e.graphics3DGraphic.graphic.uid,n=e.info[this.visibilityGroup],r=Math.floor(n.aabr[0]/this._accBinsSizeX);r<=Math.floor(n.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(var i=Math.floor(n.aabr[1]/this._accBinsSizeY);i<=Math.floor(n.aabr[3]/this._accBinsSizeY);i++)if(!(i<0||i>=this._accBinsNumY))for(var a=this._accBins[r][i],o=0;o<a.length;o++){var s=a.data[o],l=s.info[this.visibilityGroup];if(l&&l.visible&&s.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,(0,z.kK)(l.aabr,n.aabr)))return!0}return!1}},{key:"_initBins",value:function(e,t){if(null==this._accBins){this._accBins=[];for(var n=0;n<this._accBinsNumX;n++){this._accBins.push([]);for(var r=this._accBins[this._accBins.length-1],i=0;i<this._accBinsNumY;i++)r.push(new Qd.Z)}}else for(var a=0;a<this._accBinsNumX;a++)for(var o=0;o<this._accBinsNumY;o++)this._accBins[a][o].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}},{key:"_addToBins",value:function(e){for(var t=e.info[this.visibilityGroup],n=Math.floor(t.aabr[0]/this._accBinsSizeX),r=Math.floor(t.aabr[2]/this._accBinsSizeX),i=Math.floor(t.aabr[1]/this._accBinsSizeY),a=Math.floor(t.aabr[3]/this._accBinsSizeY),o=n;o<=r;o++)if(!(o<0||o>=this._accBinsNumX))for(var s=i;s<=a;s++)s<0||s>=this._accBinsNumY||this._accBins[o][s].push(e)}},{key:"_setGraphicVisibility",value:function(e,t){var n=e.graphics3DGraphic;n.destroyed||(n.setVisibilityFlag(uf.P.DECONFLICTION,t,this.visibilityGroup),this.visibilityGroup===uf.E.LABEL&&this.view.labeler.setLabelGraphicVisibility(n,t))}}]),n}(J.Z);function Rf(e){var t,n;return(0,a.Z)().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!Map.prototype.entries){r.next=11;break}t=e.entries(),n=t.next();case 3:if(n.done){r.next=9;break}return r.next=6,n.value[1];case 6:n=t.next(),r.next=3;break;case 9:r.next=12;break;case 11:return r.delegateYield(e.values(),"t0",12);case 12:case"end":return r.stop()}}),ff)}function Af(e,t,n){var r,i;return(0,a.Z)().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return t.clear(),e.forEach((function(e,r){var i=t.pushNew();i.id=r,i.visible=e.graphics3DGraphic.hasVisibilityFlag(uf.P.DECONFLICTION,n),i.prio=e.info?e.info[n].distance:Number.MAX_VALUE})),void(a.next=4);case 4:r=t.iterableSort((function(e,t){return e.visible!==t.visible?e.visible?-1:1:e.prio!==t.prio?e.prio-t.prio:e.id-t.id})),i=r.next();case 6:if(i.done){a.next=12;break}return void(a.next=9);case 9:i=r.next(),a.next=6;break;case 12:t.forAll((function(t){var n=e.get(t.id);n&&(e.delete(t.id),e.set(t.id,n))})),t.clear();case 13:case"end":return a.stop()}}),pf)}(0,p._)([(0,Z.Cb)({constructOnly:!0})],Pf.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({type:Boolean,readOnly:!0})],Pf.prototype,"updating",null),Pf=(0,p._)([(0,L.j)("esri.views.3d.layers.graphics.Deconflictor")],Pf);var Ef=(0,l.Z)((function e(){(0,s.Z)(this,e)})),Of=(0,l.Z)((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,s.Z)(this,e),this.active=t,this.visible=n,this.sort=r,this.sortArray=new Qd.Z({allocator:function(e){return e||new Ef}})})),Mf=(0,Jt.a)(),Zf=function(){function e(){(0,s.Z)(this,e),this.positionView=(0,F.c)(),this.positionNDC=(0,F.c)(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new df.G}return(0,l.Z)(e,[{key:"isOutsideScreen",get:function(){var e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}]),e}(),If=new Zf,Df=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).visibilityGroup=uf.E.LABEL,r.iconMarginFactor=0,r._lastDeconfliction=0,r}return(0,l.Z)(n,[{key:"viewState",get:function(){return this.parent.viewState}},{key:"runTask",value:function(e){if(this.parent.running)return Dn.iQ.YIELD;var t=performance.now();if(e.state!==Xr.n.IDLE&&t-this._lastDeconfliction<2e3)return Dn.iQ.YIELD;(0,c.Z)((0,h.Z)(n.prototype),"runTask",this).call(this,e),this.state===lf.Idle&&(this._lastDeconfliction=t)}},{key:"enabledChanged",value:function(e,t){this.modifyGraphics(t,e.labelsEnabled)}},{key:"getGraphicsLayers",value:function(e){return e.labelLayers}}]),n}(Pf);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Df.prototype,"parent",void 0),Df=(0,p._)([(0,L.j)("esri.views.3d.layers.graphics.LabelDeconflictor")],Df);var Lf=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._handles=new K.Z,e._contexts=new Map,e._viewState=new kf,e.visibilityGroup=uf.E.GRAPHIC,e._iconMarginFactor=-.1,e}return(0,l.Z)(n,[{key:"labels",get:function(){return this._labels}},{key:"viewState",get:function(){return this._viewState}},{key:"initialize",value:function(){var e=this;this._handles.add([(0,A.YP)((function(){var t,n;return null===(t=e.view)||void 0===t||null===(n=t.state)||void 0===n?void 0:n.camera}),(function(){e._updateViewState(),e.setDirty()})),(0,A.YP)((function(){var t,n,r;return null===(t=e.view)||void 0===t||null===(n=t.map)||void 0===n||null===(r=n.ground)||void 0===r?void 0:r.opacity}),(function(t,n){1!==t&&1!==n||e.setDirty()})),(0,A.YP)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.slicePlane}),(function(){e._updateSlicePlane(),e._slicePlaneChanged()}),A.nn)]),this._frameTask=this.view.resourceController.scheduler.registerTask(Dn.T8.GRAPHICS_DECONFLICTOR,this),this._labels=new Df({view:this.view,parent:this})}},{key:"destroy",value:function(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}},{key:"iconMarginFactor",get:function(){return this._iconMarginFactor},set:function(e){this._iconMarginFactor=e,this.setDirty()}},{key:"setDirty",value:function(){this._contexts.size>0&&((0,c.Z)((0,h.Z)(n.prototype),"setDirty",this).call(this),this._labels.setDirty())}},{key:"runTask",value:function(e){(0,c.Z)((0,h.Z)(n.prototype),"runTask",this).call(this,e),this.running||this._labels.setDirty()}},{key:"setInitialIconVisibilityFlag",value:function(e,t){var n=!(this._graphicSupportsDeconfliction(t)&&Nf(e));t.setVisibilityFlag(uf.P.DECONFLICTION,n,uf.E.GRAPHIC)}},{key:"_updateViewState",value:function(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}},{key:"_updateSlicePlane",value:function(){var e=this.view?this.view.slicePlane:null;(0,k.pC)(e)&&(0,B.t)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=(0,k.pC)(e)}},{key:"_slicePlaneChanged",value:function(){(0,Xd.oE)(this._contexts,(function(e,t){return t.symbolCreationContext.slicePlaneEnabled}))&&this.setDirty()}},{key:"addGraphicsOwner",value:function(e){var t=this,n=this._getGraphicsContext(e);return{addGraphic:function(r){return t._addGraphic(e,n,r)},removeGraphic:function(e){return t._removeGraphic(n,e)},labelingInfoChange:function(){return t._labels.enabledChanged(e,n)},featureReductionChange:function(){return t.enabledChanged(e,n)},slicePlaneEnabledChange:function(){return t._slicePlaneEnabledChanged(e,n)},clear:function(){return n.forEach((function(e){return t._removeGraphic(n,e.graphics3DGraphic)}))}}}},{key:"removeGraphicsOwner",value:function(e){var t=this,n=this._contexts.get(e);n&&(n.forEach((function(e){return t._removeGraphic(n,e.graphics3DGraphic)})),this._contexts.delete(e),this.setDirty())}},{key:"_addGraphic",value:function(e,t,n){var r=n.graphic.uid,i=new Sf(n,e.symbolCreationContext.slicePlaneEnabled);t.set(r,i),Nf(e)&&this.addToActiveGraphics(i),e.labelsEnabled&&this._labels.addToActiveGraphics(i)}},{key:"_removeGraphic",value:function(e,t){var n=t.graphic.uid,r=e.get(n);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(n),this.setDirty())}},{key:"enabledChanged",value:function(e,t){var n=Nf(e);n||function(e){var t=e.graphics3DGraphics;t&&t.forEach((function(e){return e.clearVisibilityFlag(uf.P.DECONFLICTION)}))}(e),this.modifyGraphics(t,n)}},{key:"_slicePlaneEnabledChanged",value:function(e,t){var n=e.symbolCreationContext.slicePlaneEnabled;t.forEach((function(e){return e.slicePlaneEnabled=n})),this.setDirty()}},{key:"getGraphicsLayers",value:function(e){return e.layers}},{key:"_graphicSupportsDeconfliction",value:function(e){if(e.isDraped)return!1;var t=e.layers;if(!t||!t.length)return!1;var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(this.layerSupportsDeconfliction(a))return!0}}catch(o){r.e(o)}finally{r.f()}return!1}},{key:"_getGraphicsContext",value:function(e){var t=this._contexts.get(e);if(t)return t;var n=new Map;return this._contexts.set(e,n),this.setDirty(),n}}]),n}(Pf);function Nf(e){var t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}Lf=(0,p._)([(0,L.j)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Lf);var Ff=n(87015),Uf=n(93433),Vf=n(13470),Hf=n(74702),zf=n(13005),Bf=n(57557),Gf=function(){function e(t){(0,s.Z)(this,e),this._renderCoordsHelper=t,this._surfaceElevation=0,this._cache=new Map,this._frustum=new bu.i(t),this._extendedFrustum=new bu.i(t),this._intersector=new Bf.q({renderCoordsHelper:t}),this._renderCoordsHelper=t}return(0,l.Z)(e,[{key:"begin",value:function(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)}},{key:"end",value:function(){this._cache.clear()}},{key:"calculate",value:function(e){if(this._allTilesInvisible)return Vf.E.INVISIBLE;var t=this._renderCoordsHelper.viewingMode===he.JY.Global&&e.lij[0]>=Wf&&e.lij[0]<jf,n=this._getOrCalculateSingleTileVisibility(e,!t);return n!==Vf.E.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):n}},{key:"_shortenFrustumFarPlane",value:function(e){var t,n=bu.i.nearFarLineIndices,r=e.mutablePoints,a=(0,i.Z)(n);try{for(a.s();!(t=a.n()).done;){var o=t.value,s=(0,ns.Z)(o,2),l=s[0],u=s[1],c=r[l],h=r[u];(0,Gt.b)(Qf,h,c),(0,Gt.g)(Qf,Qf,Yf),(0,Gt.a)(r[u],c,Qf)}}catch(d){a.e(d)}finally{a.f()}e.updatePoints(r)}},{key:"_calculateAggregatedChildrenVisibility",value:function(e){var t=Vf.E.INVISIBLE,n=this._cache.get(e.id);if(null!=n)return n;var r=$f.acquire();e.getChildren(r);var a,o=(0,i.Z)(r);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=this.calculate(s);if(l!==Vf.E.INVISIBLE&&(t=l,l===Vf.E.VISIBLE_ON_SURFACE))break}}catch(u){o.e(u)}finally{o.f()}return $f.release(r),this._cache.set(e.id,t),t}},{key:"_getOrCalculateSingleTileVisibility",value:function(e,t){var n=this._cache.get(e.id);if(null!=n)return n;var r=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,r),r}},{key:"_calculateSingleTileVisibility",value:function(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===he.JY.Global&&e.lij[0]<qf?this._calculateSingleTileVisibilitySided(e,!1)===Vf.E.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}},{key:"_calculateSingleTileVisibilitySided",value:function(e,t){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);var n=(0,qt.Iu)(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,n)?this._intersector.isVisibleInFrustum(this._frustum,n,!0)?Vf.E.VISIBLE_ON_SURFACE:Vf.E.VISIBLE_WHEN_EXTENDED:Vf.E.INVISIBLE}},{key:"_updateExtendedFrustum",value:function(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);var t=this._renderCoordsHelper.worldUpAtPosition(e.eye,Qf);this._aboveGround||(0,Gt.o)(t,t);var n=(0,Se.ZF)(-(0,Gt.e)(t,e.viewForward));if(this._allTilesInvisible=n>(Math.PI+e.fovY)/2,!this._allTilesInvisible&&(this._hasExtendedFrustum=n>e.fovY/2,this._hasExtendedFrustum)){for(var r=this._extendedFrustumParameters(),i=this._extendedFrustum.mutablePoints,a=0;a<4;a++){var o=r.pointIndices[a],s=i[o],l=this._renderCoordsHelper.getAltitude(s);if(r.needsAltitudeAdjustment(l)){switch(this._renderCoordsHelper.worldUpAtPosition(s,Qf),o){case Tc.NQ.FAR_BOTTOM_LEFT:case Tc.NQ.FAR_TOP_LEFT:case Tc.NQ.NEAR_BOTTOM_LEFT:case Tc.NQ.NEAR_TOP_LEFT:(0,Us._l)(this._extendedFrustum.planes[Tc.Nu.LEFT],Qf,Qf);break;case Tc.NQ.FAR_BOTTOM_RIGHT:case Tc.NQ.FAR_TOP_RIGHT:case Tc.NQ.NEAR_BOTTOM_RIGHT:case Tc.NQ.NEAR_TOP_RIGHT:(0,Us._l)(this._extendedFrustum.planes[Tc.Nu.RIGHT],Qf,Qf)}(0,Gt.g)(Qf,Qf,r.direction),this._renderCoordsHelper.intersectInfiniteManifold((0,ta.re)(s,Qf),r.zWithMargin,s)}}if(this._extendedFrustum.updatePoints(i),(0,Us.zk)(i[Tc.NQ.NEAR_BOTTOM_LEFT],i[Tc.NQ.NEAR_BOTTOM_RIGHT],i[Tc.NQ.NEAR_TOP_RIGHT],Jf),(0,Us.zk)(i[Tc.NQ.NEAR_BOTTOM_RIGHT],i[Tc.NQ.NEAR_TOP_RIGHT],i[Tc.NQ.NEAR_TOP_LEFT],Kf),(0,Gt.e)((0,Us.mJ)(Jf),(0,Us.mJ)(Kf))<0){var u,c,h=this._extendedFrustum.mutablePoints;this._aboveGround?(u=[h[Tc.NQ.NEAR_BOTTOM_RIGHT],h[Tc.NQ.NEAR_BOTTOM_LEFT]],h[Tc.NQ.NEAR_BOTTOM_LEFT]=u[0],h[Tc.NQ.NEAR_BOTTOM_RIGHT]=u[1]):(c=[h[Tc.NQ.NEAR_TOP_RIGHT],h[Tc.NQ.NEAR_TOP_LEFT]],h[Tc.NQ.NEAR_TOP_LEFT]=c[0],h[Tc.NQ.NEAR_TOP_RIGHT]=c[1]),this._extendedFrustum.updatePoints(h)}}}},{key:"_extendedFrustumParameters",value:function(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}},{key:"_extendedFrustumParametersAboveSurface",value:function(){var e=this._surfaceElevation-Xf;return{zWithMargin:e,pointIndices:bu.i.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:function(t){return t>e}}}},{key:"_extendedFrustumParametersBelowSurface",value:function(){var e=this._surfaceElevation+Xf;return{zWithMargin:e,pointIndices:bu.i.planePointIndices.top,direction:1,needsAltitudeAdjustment:function(t){return t<e}}}}]),e}(),Wf=2,jf=6,qf=12,Yf=.95,Xf=1,Qf=(0,F.c)(),Jf=(0,Us.Ue)(),Kf=(0,Us.Ue)(),$f=new zf.Z(Array,(function(e){4!==e.length&&(e[0]=new Vf.C,e[1]=new Vf.C,e[2]=new Vf.C,e[3]=new Vf.C)}),(function(e){e[0].release(),e[1].release(),e[2].release(),e[3].release()})),ep=function(){function e(t){(0,s.Z)(this,e),this._camera=new Jo.V,this._focusOnMap=[0,0],this._screenRect=(0,z.Ue)(),this._tileSize=t.tileSize,this._renderCoordsHelper=t.renderCoordsHelper,this._tilingScheme=t.tilingScheme,this._visibility=new Gf(t.renderCoordsHelper)}return(0,l.Z)(e,[{key:"begin",value:function(e,t,n){this._camera.copyFrom(e),this._surfaceElevation=n,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,(0,z.al)(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,n)}},{key:"end",value:function(){this._visibility.end()}},{key:"updateTile",value:function(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=(0,z.TE)(e.extent,this._focusOnMap),e.measures.visibility!==Vf.E.INVISIBLE&&this._updateScreenMeasure(e)}},{key:"_updateScreenMeasure",value:function(e){var t=np,n=1<<t,r=e.measures.screenRect;(0,z.cS)(r);for(var i=0,a=e.lij[0]+t,o=e.lij[1]<<t,s=e.lij[2]<<t,l=this._tileSizeWithBias(e),u=l*l,c=0;c<n;c++)for(var h=0;h<n;h++)if((i+=this._computeScreenArea(e,a,o+c,s+h,r))>u)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}},{key:"_tileSizeWithBias",value:function(e){return e.measures.visibility===Vf.E.VISIBLE_WHEN_EXTENDED?this._tileSize*rp:this._tileSize}},{key:"_computeScreenArea",value:function(e,t,n,r,i){var a=e.measures.visibility===Vf.E.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,n,r,a,ip),(0,z.cS)(tp);for(var o=0;o<4;o++)(0,z.Ho)(tp,ip[o]);return(0,z.jn)(i,tp,i),(0,Hf.wu)(ip[0],ip[1],ip[2])+(0,Hf.wu)(ip[0],ip[2],ip[3])}},{key:"_projectToScreen",value:function(e,t,n,r,i){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,t,n,ap),this._toRenderCoords(ap,0,3,sp[0]),this._toRenderCoords(ap,2,3,sp[1]),this._toRenderCoords(ap,2,1,sp[2]),this._toRenderCoords(ap,0,1,sp[3]),r&&(this._projectToPlane(sp,this._camera.frustum[Tc.Nu.NEAR]),this._projectToPlane(sp,this._camera.frustum[Tc.Nu.TOP]),this._projectToPlane(sp,this._camera.frustum[Tc.Nu.BOTTOM]));for(var a=0;a<4;a++)this._camera.projectToRenderScreen(sp[a],up),this._camera.renderToScreen(up,i[a])}},{key:"_projectToPlane",value:function(e,t){for(var n=0;n<4;n++)lp[n]=(0,Us.jH)(t,e[n]);var r=Math.max(lp[0],lp[1],lp[2],lp[3]);if(r>0)for(var i=(0,Gt.g)(op,(0,Us.mJ)(t),-r),a=0;a<4;a++)(0,Gt.a)(e[a],e[a],i)}},{key:"_toRenderCoords",value:function(e,t,n,r){return op[0]=e[t],op[1]=e[n],op[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(op,this._tilingScheme.spatialReference,r),r}}]),e}(),tp=(0,z.Ue)(),np=2,rp=5,ip=[(0,O.s1)(),(0,O.s1)(),(0,O.s1)(),(0,O.s1)()],ap=(0,z.Ue)(),op=(0,F.c)(),sp=[(0,F.c)(),(0,F.c)(),(0,F.c)(),(0,F.c)()],lp=[0,0,0,0],up=(0,O.J$)(),cp=n(65206),hp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).tiles=new y.Z,r.tileSize=512,r._idToTile=new Map,r._handles=new K.Z,r._clients=new Set,r._dirty=!1,r._pendingTiles=null,r._newTiles=new Qd.Z,r}return(0,l.Z)(n,[{key:"tilingScheme",get:function(){var e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}},{key:"filterExtent",set:function(e){if(!(0,k.pC)(e)||e.spatialReference.equals(this.viewState.spatialReference)){var t=this._get("filterExtent");if(!(t===e||(0,k.pC)(t)&&e&&t.equals(e))){var n=(0,k.pC)(e)?e.clone():null;this._set("filterExtent",n),this._setDirty()}}else S.Z.getLogger(this.declaredClass).error("#extent","extent spatial reference needs to be in the same spatial reference as the view")}},{key:"_filterExtentRect",get:function(){if((0,k.Wi)(this.filterExtent))return null;var e=(0,z.Ue)();return(0,cp.G)(this.filterExtent,e,this.tilingScheme.spatialReference),e}},{key:"_rootTileIds",get:function(){var e=this.tilingScheme;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}},{key:"suspended",set:function(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}},{key:"updating",get:function(){return this._dirty||!!this._pendingTiles}},{key:"initialize",value:function(){var e=this;this._handles.add([(0,A.YP)((function(){return[e.tilingScheme,e.tileSize]}),(function(){return e._reset()}),A.Z_),(0,A.YP)((function(){var t,n,r;return[e.tileSize,null===(t=e.cameraOnSurface)||void 0===t?void 0:t.location,e.tilingScheme,null===(n=e.viewState)||void 0===n?void 0:n.contentCamera,null===(r=e.focus)||void 0===r?void 0:r.location]}),(function(){return e._setDirty()}),A.tX)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(Dn.T8.FEATURE_TILE_TREE,this))}},{key:"destroy",value:function(){this._frameWorker=(0,k.hw)(this._frameWorker),this._handles=(0,k.SC)(this._handles)}},{key:"addClient",value:function(){var e=this,t=dp++;return this._clients.add(t),1===this._clients.size&&this._setDirty(),{remove:function(){return e._removeClient(t)}}}},{key:"_removeClient",value:function(e){this._clients.delete(e),this._hasClients||this._clear()}},{key:"_hasClients",get:function(){return this._clients.size>0}},{key:"_setDirty",value:function(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Dn.G5))}},{key:"_clear",value:function(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),(0,k.pC)(this._frameWorker)&&(this._frameWorker.priority=Dn.T8.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&(0,k.pC)(this._frameWorker)&&(this._frameWorker.priority=Dn.T8.FEATURE_TILE_TREE),this.notifyChange("updating")}},{key:"_startUpdate",value:function(){var e;if(!this.suspended)if(this.tilingScheme){this._tileMeasurements||(this._tileMeasurements=new ep({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));var t=this.viewState.contentCamera;this._tileMeasurements.begin(t,this.focus.location,null!==(e=this.cameraOnSurface.location.z)&&void 0!==e?e:0),this._pendingTiles=this._getRootTiles()}else this._clear()}},{key:"_reset",value:function(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}},{key:"_getRootTiles",value:function(){var e=this.tilingScheme;return this._rootTileIds.map((function(t){return new Vf.C(t[0],t[1],t[2],e)}))}},{key:"_purgeHorizonTiles",value:function(e){e.sort((function(e,t){var n=e.measures.screenRect,r=t.measures.screenRect;return n[1]+n[3]-(r[1]+r[3])})),(0,z.cS)(fp);for(var t=0;t<e.length;t++)if((0,z.jn)(fp,e.data[t].measures.screenRect,fp),(0,z.Cb)(fp)>pp)return e.data.slice(t,e.length);return[]}},{key:"_subdivideTilesForView",value:function(e){if(this._pendingTiles){for(var t=this.tilingScheme;this._pendingTiles.length>0&&!e.done;){var n,r=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!(0,z.kK)(this._filterExtentRect,r.extent)||(this._tileMeasurements.updateTile(r),r.measures.visibility!==Vf.E.INVISIBLE&&(r.measures.shouldSplit?(t.ensureMaxLod(r.lij[0]+1),(n=this._pendingTiles).push.apply(n,(0,Uf.Z)(r.getChildren()))):this._newTiles.push(r)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}},{key:"_updateTiles",value:function(e){var t,n=this,r=(0,i.Z)(this.tiles.items);try{for(r.s();!(t=r.n()).done;){t.value.used=!1}}catch(s){r.e(s)}finally{r.f()}var a=e.filter((function(e){var t=n._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):n._idToTile.set(e.id,e),!t})),o=this.tiles.items.filter((function(e){return!e.used&&(n._idToTile.delete(e.id),!0)}));this.tiles.removeMany(o),this.tiles.addMany(a),this._sortTiles()}},{key:"_sortTiles",value:function(){this.viewState.fixedContentCamera||this.tiles.sort((function(e,t){return e.measures.visibility!==t.measures.visibility?e.measures.visibility===Vf.E.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance})),this.tiles.forEach((function(e,t){return e.loadPriority=t}))}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],hp.prototype,"scheduler",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hp.prototype,"renderCoordsHelper",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hp.prototype,"tilingSchemeOwner",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hp.prototype,"cameraOnSurface",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hp.prototype,"focus",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hp.prototype,"viewState",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],hp.prototype,"terrain",void 0),(0,p._)([(0,Z.Cb)()],hp.prototype,"tiles",void 0),(0,p._)([(0,Z.Cb)()],hp.prototype,"tileSize",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],hp.prototype,"tilingScheme",null),(0,p._)([(0,Z.Cb)()],hp.prototype,"filterExtent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],hp.prototype,"_filterExtentRect",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],hp.prototype,"_rootTileIds",null),(0,p._)([(0,Z.Cb)({value:!1})],hp.prototype,"suspended",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],hp.prototype,"updating",null),hp=(0,p._)([(0,L.j)("esri.views.3d.layers.support.FeatureTileTree3D")],hp);var dp=0;var fp=(0,z.Ue)(),pp=10,vp=n(3073),mp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._propertiesPool=new mh.L({camera:Jo.V},(0,u.Z)(e)),e._lastSeenCameraProjectionValues=new Jo.V,e.mode=Xr.n.ANIMATING,e.rasterPixelRatio=1,e.contentPixelRatio=1,e.events=new $.Z,e.viewingMode=he.JY.Global,e._cameraChanged=!1,e._updateQueue=new Array,e._processingUpdates=!1,e}return(0,l.Z)(n,[{key:"init",value:function(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new Re({mode:this.viewingMode}))}},{key:"exit",value:function(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new mh.L({camera:Jo.V},this)}},{key:"createInitialCamera",value:function(){if(this.viewingMode===he.JY.Global){var e=(0,qt.Iu)(this.spatialReference).radius;this.camera=new Jo.V({eye:(0,F.f)(4*e,0,0),center:(0,F.f)(e,0,0),up:(0,F.f)(0,0,1)})}else this.camera=new Jo.V({eye:(0,F.f)(0,0,100),center:(0,F.f)(0,0,0),up:(0,F.f)(0,1,0)})}},{key:"animation",get:function(){return this.cameraController instanceof Ss&&(0,k.pC)(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}},{key:"camera",get:function(){return this._get("camera")},set:function(e){var t=this;e!==gp&&gp.copyFrom(e),gp.computeUp(this.viewingMode),this.events.emit("before-camera-change",gp);var n=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,gp)&&(this._lastSeenCameraProjectionValues.copyFrom(gp),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),(!n||!n.equals(gp))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(gp)),this._cameraChanged=!n||!n.almostEquals(gp),this._cameraChanged))var r=(0,vp.Fs)((function(){t._cameraChanged=!1,r.remove()}))}},{key:"pixelRatio",get:function(){return this.camera.pixelRatio}},{key:"contentCamera",get:function(){return(0,k.Pt)(this._contentCamera,this.camera)},set:function(e){this._contentCamera=(0,k.pC)(e)?e.clone():null}},{key:"fixedContentCamera",get:function(){return(0,k.pC)(this._contentCamera)}},{key:"isGlobal",get:function(){return this.viewingMode===he.JY.Global}},{key:"isLocal",get:function(){return this.viewingMode===he.JY.Local}},{key:"navigating",get:function(){return!(!this.cameraController||!this.cameraController.isInteractive)}},{key:"stationary",get:function(){return!this._cameraChanged&&!this.navigating}},{key:"cameraController",get:function(){return this._get("cameraController")},set:function(e){var t=this;this.stopActiveCameraController()?(e&&(this.removeHandles(bp),this.addHandles((0,A.gx)((function(){return e.state===ys.Finished||e.state===ys.Stopped}),(function(){t._set("cameraController",null),t.updateCamera((function(t){return e.onControllerEnd(t)}))}),{sync:!0,once:!0}),bp),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ys.Rejected)}},{key:"switchCameraController",value:function(e){return this.cameraController=e,e.state!==ys.Rejected}},{key:"stopActiveCameraController",value:function(){return!(this.cameraController&&!this.cameraController.stopController())}},{key:"updateCamera",value:function(e){this._updateQueue.push(e),this._processUpdateQueue()}},{key:"_processUpdateQueue",value:function(){if(0!==this._updateQueue.length&&!this._processingUpdates){this._processingUpdates=!0;var e=this._updateQueue.shift();gp.copyFrom(this._get("camera")),e(gp),this.camera=gp,this._processingUpdates=!1,this._processUpdateQueue()}}},{key:"_cameraProjectionChanged",value:function(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Jo.N.TOP]!==t.padding[Jo.N.TOP]||e.padding[Jo.N.RIGHT]!==t.padding[Jo.N.RIGHT]||e.padding[Jo.N.BOTTOM]!==t.padding[Jo.N.BOTTOM]||e.padding[Jo.N.LEFT]!==t.padding[Jo.N.LEFT]}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],mp.prototype,"mode",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0,type:ce.Z})],mp.prototype,"animation",null),(0,p._)([(0,Z.Cb)({type:Jo.V})],mp.prototype,"camera",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"pixelRatio",null),(0,p._)([(0,Z.Cb)()],mp.prototype,"rasterPixelRatio",void 0),(0,p._)([(0,Z.Cb)()],mp.prototype,"contentPixelRatio",void 0),(0,p._)([(0,Z.Cb)({})],mp.prototype,"_contentCamera",void 0),(0,p._)([(0,Z.Cb)({type:Jo.V})],mp.prototype,"contentCamera",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"fixedContentCamera",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"constraints",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"events",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"isGlobal",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"isLocal",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"viewingMode",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],mp.prototype,"spatialReference",void 0),(0,p._)([(0,Z.Cb)()],mp.prototype,"navigating",null),(0,p._)([(0,Z.Cb)()],mp.prototype,"stationary",null),(0,p._)([(0,Z.Cb)()],mp.prototype,"_cameraChanged",void 0),(0,p._)([(0,Z.Cb)()],mp.prototype,"cameraController",null);var _p,yp=mp=(0,p._)([(0,L.j)("esri.views.3d.state.ViewState")],mp),gp=new Jo.V,bp="ViewStateHandles",wp=n(54463),Cp=n(22178),xp=function(){function e(t,n,r){(0,s.Z)(this,e),this.viewingMode=t,this._forEachLayer=n,this._view=r,this._externalIntersectionHandlers=new Qd.Z,this._tolerance=Pa.vh,this._tmpRay=(0,ta.Ue)(),this._tmpRegion=(0,z.Ue)(),this._validateHUDIntersector=(0,Pa.Z8)(this.viewingMode),this._validateHUDIntersector.options.hud=!1}return(0,l.Z)(e,[{key:"intersectScreen",value:function(e,t,n){return this.intersectRay(this._getPickRay(e,this._tmpRay),Pp(this.viewingMode),t,n)}},{key:"intersectScreenFreePointFallback",value:function(e,t,n){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,n)}},{key:"intersectRayFreePointFallback",value:function(e,t,n){return this.intersectRay(e,Pp(this.viewingMode),t,n)||this._intersectRayFreePointLocal(e,t)}},{key:"intersectRay",value:function(e,t,n,r){return t.options.selectionMode=!1,t.options.store=wp.eC.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(n)}},{key:"getCenterRayWithSubpixelOffset",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.5;return e.getRenderCenter(Op,n,r),Op[0]+=.0466,Op[1]-=.0123,(0,Vs.eW)(e,Op,t)}},{key:"intersectIntersectorScreen",value:function(e,t,n){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,n)}},{key:"intersectToolIntersectorScreen",value:function(e,t,n){var r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,n)}},{key:"intersectToolIntersectorRay",value:function(e,t,n){t.options.selectionMode=!0,this.computeIntersection(e,t,n);var r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,Cp.nn)(r)&&r.intersector!==wp.q7.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,n))}},{key:"setTolerance",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Pa.vh;this._tolerance=e}},{key:"addIntersectionHandler",value:function(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((function(e,t){return e.type===wp.q7.TERRAIN?1:t.type===wp.q7.TERRAIN?-1:0}))}},{key:"removeIntersectionHandler",value:function(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort((function(e,t){return e.type===wp.q7.TERRAIN?1:t.type===wp.q7.TERRAIN?-1:0}))}},{key:"_getPickRay",value:function(e,t){var n=this._view.state.camera;return(0,Vs.u4)(n,e,t)}},{key:"_intersectRayFreePointLocal",value:function(e,t){return this.viewingMode!==he.JY.Local||(0,k.Wi)(e)||(0,Gt.a)(t,e.origin,(0,Gt.n)(Zs.WM.get(),e.direction)),!1}},{key:"intersectElevationFromScreen",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,n,r)}},{key:"_intersectElevation",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if((0,k.Wi)(e))return null;var i=(0,k.pC)(t)?t.mode:"absolute-height",a=(0,k.pC)(t)?(0,k.Pt)(t.offset,0):0,o="on-the-ground"!==i?a+n:0,s=o/this._view.renderCoordsHelper.unitInMeters;if("absolute-height"===i){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,o,Ep)){var l,u=this._view.computeMapPointFromVec3d(Ep);return null!==(l=u.z)&&void 0!==l||(u.z=0),u.z-=a,u}return null}var c=this._view.state.camera,h=(0,O.Wv)(Zs.WM.get());c.projectToRenderScreen(e.origin,h);var d=new Rp(null,this._forEachLayer),f=this._view.slicePlane,p=(0,k.pC)(f)?(0,Cp.e4)(f):null,v=(0,Pa.Z8)(this.viewingMode);v.options.store=wp.eC.MIN,v.options.verticalOffset=s;var m=e.origin,_=(0,Gt.a)(Zs.WM.get(),m,e.direction);v.reset(m,_,c),v.point=h;var y=(0,k.pC)(r)?"type"in r&&"graphics"===r.type?function(e){var t;return(null===(t=e.metadata)||void 0===t?void 0:t.layerUid)!==r.uid}:function(e){var t;return(null===(t=e.metadata)||void 0===t?void 0:t.graphicUid)!==r.uid}:null;switch(i){case"relative-to-scene":var g=function(e){var t;return((0,k.Wi)(y)||y(e))&&!(null===(t=e.metadata)||void 0===t||!t.isElevationSource)};v.intersect(d.layers,h,this._tolerance,null,g),this._externalIntersectionHandlers.forAll((function(e){if(e.type===wp.q7.I3S||e.type===wp.q7.TERRAIN){var t=e.slicePlaneEnabled?p:null;e.intersect(v,t,v.rayBegin,v.rayEnd,h)}}));break;case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((function(e){if(e.isGround){var t=e.slicePlaneEnabled?p:null;e.intersect(v,t,v.rayBegin,v.rayEnd,h)}}))}if(v.results.min.getIntersectionPoint(Ep)){var b=this._view.computeMapPointFromVec3d(Ep);return b.z=n,b}return null}},{key:"computeIntersection",value:function(e,t,n){if(!(0,k.Wi)(e)){var r=this._view.state.camera,a=(0,O.Wv)(Zs.WM.get());r.projectToRenderScreen(e.origin,a);var o=new Rp(n,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!n||!("include"in n||"exclude"in n);var s=e.origin,l=(0,Gt.a)(Zs.WM.get(),e.origin,e.direction);t.reset(s,l,r),t.intersect(o.layers,a,this._tolerance);var u=this._view.slicePlane,c=(0,k.pC)(u)?(0,Cp.e4)(u):null;t.intersect(o.sliceableLayers,a,this._tolerance,c);var h=n&&(n.requiresGroundFeedback||n.enableDraped);this._externalIntersectionHandlers.forAll((function(e){var n=e.layerUid,r=Array.isArray(n),u=r?n:[n];r&&(t.options.filteredLayerUids=[]);var d,f=!1,p=(0,i.Z)(u);try{for(p.s();!(d=p.n()).done;){var v=d.value;o.filterLayerUid(v)?f=!0:r&&t.options.filteredLayerUids.push(v)}}catch(_){p.e(_)}finally{p.f()}if(t.options.isFiltered=!f,e.isGround&&h||!t.options.isFiltered){var m=e.slicePlaneEnabled?c:null;e.intersect(t,m,s,l,a)}}));var d=Zs.WM.get(),f=this._view.basemapTerrain;if(n&&n.enableDraped&&(0,k.pC)(f.spatialReference)&&t.results.ground.getIntersectionPoint(d)){var p,v=f.overlayManager.renderer,m=this._view.renderCoordsHelper.spatialReference,_=Zs.WM.get();this._view.renderCoordsHelper.fromRenderCoords(d,_,f.spatialReference),_[2]=(0,k.Pt)(null===(p=this._view.elevationProvider)||void 0===p?void 0:p.getElevation(d[0],d[1],d[2],m,"ground"),0),v.intersect(t,_,t.results.ground,(function(e){return o.filterRenderGeometry(e)}))}t.sortResults(),this._processHUDResults(t)}}},{key:"_processHUDResults",value:function(e){var t=e.results.hud;(0,z.JG)(this._tmpRegion,z.Gv);var n=this._view.state.camera,r=[],a=this._tmpRegion,o=function(e){var t=new kp(e);n.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),r.push(t),(0,z.Ho)(a,t.screenPoint)};e.sortResults(t.all),(0,k.pC)(t.min.dist)&&o(t.min);var s,l=(0,i.Z)(t.all);try{for(l.s();!(s=l.n()).done;){var u=s.value;t.min.target.object!==u.target.object&&t.max.target.object!==u.target.object&&o(u)}}catch(P){l.e(P)}finally{l.f()}if((0,k.pC)(t.max.dist)&&t.max.target.object!==t.min.target.object&&o(t.max),r.length){a[0]===a[2]&&(a[2]+=1),a[1]===a[3]&&(a[3]+=1);var c=n.fullWidth,h=n.fullHeight,d=Math.max(0,a[0]-Tp),f=Math.max(0,a[1]-Tp),p=Math.min((0,z.bf)(a)+2*Tp,c-d),v=Math.min((0,z.Cb)(a)+2*Tp,h-f),m=new Uint8Array(p*v*4);this._view._stage.renderer.readHUDVisibility(d,f,p,v,m);for(var _=!0,y=(0,k.Wi)(e.results.max.dist),g=0,b=0,w=r;b<w.length;b++){var C,x=w[b],T=(0,i.Z)(Sp);try{for(T.s();!(C=T.n()).done;){var S=C.value;if(m[4*(Math.min(x.screenPoint[0]+S[0],c)-a[0]+(Math.min(x.screenPoint[1]+S[1],h)-a[1])*p)]){_&&(e.results.min.copy(x.result),_=!1),y&&e.results.max.copy(x.result),e.options.store===wp.eC.ALL&&e.results.all.splice(g++,0,x.result);break}}}catch(P){T.e(P)}finally{T.f()}}}}}]),e}(),Tp=1,Sp=function(){for(var e=[],t=Tp,n=-t;n<=t;n++)for(var r=-t;r<=t;r++)e.push([r+t,n+t]);return e}(),kp=(0,l.Z)((function e(t){(0,s.Z)(this,e),this.result=t,this.screenPoint=(0,O.J$)()}));function Pp(e){return _p&&_p.viewingMode===e||(_p=(0,Pa.Z8)(e)),_p}var Rp=function(){function e(t,n){var r=this;(0,s.Z)(this,e),this.layers=new Array,this.sliceableLayers=new Array,this.include=null===t||void 0===t?void 0:t.include,this.exclude=null===t||void 0===t?void 0:t.exclude,n((function(e){e.pickable&&r.filterLayerUid(e.apiLayerUid)&&(e.sliceable?r.sliceableLayers:r.layers).push(e)}))}return(0,l.Z)(e,[{key:"filterLayerUid",value:function(e){var t=this.include,n=this.exclude;return(0,k.Wi)(e)?null==t&&null==n:(null==t||t.has(e))&&(null==n||!n.has(e))}},{key:"filterRenderGeometry",value:function(e){return this.filterLayerUid(e.layerUid)}}]),e}();function Ap(e){return"object"==typeof e&&"intersect"in e}var Ep=(0,F.c)(),Op=(0,O.J$)(),Mp=n(91293),Zp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._im=new Array,r._ground=new Array,r._scene=new Array,r._handles=new Map,r.lastElevationQuery=null,r.elevationCacheEnabled=!1,r}return(0,l.Z)(n,[{key:"spatialReference",get:function(){var e,t;return null===(e=this.view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.spatialReference}},{key:"destroy",value:function(){this._elevationQueryCached=(0,k.SC)(this._elevationQueryCached)}},{key:"_elevationQuery",get:function(){var e=this;return(0,k.Wi)(this._elevationQueryCached)&&(this._elevationQueryCached=new Mp.K(this.view.resourceController.scheduler,this.view.spatialReference,(function(){return e.view.map&&e.view.map.ground}),{maximumAutoTileRequests:4})),this._elevationQueryCached}},{key:"enableElevationCache",value:function(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}},{key:"getElevation",value:function(e,t,n,r,i){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){var a=this.lastElevationQuery;if(e===a.x&&t===a.y&&n===a.z&&(0,jt.fS)(r,a.spatialReference)&&i===a.queryContext)return a.result}var o=null;return o=Ip(o,this._im,e,t,n,r,i),(0,k.Wi)(o)&&(o=Ip(o,this._ground,e,t,n,r,i)),"scene"===i&&(o=Ip(o,this._scene,e,t,n,r,i)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:n,spatialReference:r,queryContext:i,result:o}),o}},{key:"queryElevation",value:function(e,t,n,r,i){var a=this,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=(0,R.hh)();return this._elevationQuery.queryElevation(e,t,o,s).then((function(o){"scene"===i&&(o=Ip(o,a._scene,e,t,n,r,i)),l.resolve(o)})).catch((function(o){(0,R.D_)(o)?l.reject(o):l.resolve(a.getElevation(e,t,n,r,i))})),l.promise}},{key:"register",value:function(e,t){var n=this;this._handles.set(t,t.on("elevation-change",(function(e){return n.emit("elevation-change",e)}))),this._providersFromContext(e).push(t)}},{key:"unregister",value:function(e){var t;this._handles.has(e)&&(null!==(t=this._handles.get(e))&&void 0!==t&&t.remove(),this._handles.delete(e));for(var n=0,r=[this._im,this._ground,this._scene];n<r.length;n++){var i=r[n],a=i.indexOf(e);a>-1&&i.splice(a,1)}}},{key:"_providersFromContext",value:function(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}}]),n}($.Z.EventedMixin(J.Z));function Ip(e,t,n,r,a,o,s){var l,u=(0,i.Z)(t);try{for(u.s();!(l=u.n()).done;){var c=l.value.getElevation(n,r,a,o,s);(0,k.pC)(c)&&(e=(0,k.pC)(e)?Math.max(c,e):c)}}catch(h){u.e(h)}finally{u.f()}return e}(0,p._)([(0,Z.Cb)({constructOnly:!0})],Zp.prototype,"view",void 0),(0,p._)([(0,Z.Cb)()],Zp.prototype,"spatialReference",null),Zp=(0,p._)([(0,L.j)("esri.views.3d.support.CombinedElevationProvider")],Zp);var Dp=function(){function e(){(0,s.Z)(this,e)}return(0,l.Z)(e,null,[{key:"isValidProfile",value:function(t){return t in e.profiles}},{key:"getDefaultProfile",value:function(){return(0,x.Z)("esri-iPhone")?"low":"medium"}},{key:"apply",value:function(t,n){var r=e.profiles[t];n.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,n.graphics3D.maxTotalNumberOfPrimitives=r.graphics3D.maxTotalNumberOfPrimitives,n.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,n.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,n.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable,n.graphics3D.skipHighSymbolLods=r.graphics3D.skipHighSymbolLods;var i=n.sceneService.object,a=r.sceneService.object;i.lodFactor=a.lodFactor,i.lodCrossfadeinDuration=a.lodCrossfadeinDuration,i.lodCrossfadeoutDuration=a.lodCrossfadeoutDuration,i.lodCrossfadeUncoveredDuration=a.lodCrossfadeUncoveredDuration,n.sceneService.point.lodFactor=r.sceneService.point.lodFactor,n.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,n.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,n.sceneService.uncompressedTextureDownsamplingEnabled=r.sceneService.uncompressedTextureDownsamplingEnabled,n.tiledSurface.lodBias=r.tiledSurface.lodBias,n.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,n.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,n.tiledSurface.textureFadeDuration=r.tiledSurface.textureFadeDuration,n.heatmap.pixelRatio=r.heatmap.pixelRatio,n.heatmap.maxTotalNumberOfFeatures=r.heatmap.maxTotalNumberOfFeatures,n.fadeDuration=r.fadeDuration,n.antialiasingEnabled=r.antialiasingEnabled,n.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,n.highQualityTransparency=r.highQualityTransparency,n.memoryLimit=r.memoryLimit,n.additionalCacheMemory=r.additionalCacheMemory,n.frameRate=r.frameRate,n.maximumPixelRatio=r.maximumPixelRatio}}]),e}();function Lp(){var e=!!(0,x.Z)("esri-mobile"),t=!!(0,x.Z)("ios"),n=(0,lr.HA)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{object:{lodFactor:.2,lodCrossfadeinDuration:(0,lr.HA)(0),lodCrossfadeoutDuration:(0,lr.HA)(0),lodCrossfadeUncoveredDuration:(0,lr.HA)(0)},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:(0,lr.HA)(0)},fadeDuration:(0,lr.HA)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:(0,lr.HA)(0),lodCrossfadeoutDuration:(0,lr.HA)(0),lodCrossfadeUncoveredDuration:n},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!(0,x.Z)("disable-feature:reduce-map-tile-levels"),textureFadeDuration:n},fadeDuration:n,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:(0,lr.HA)(0),lodCrossfadeoutDuration:(0,lr.HA)(0),lodCrossfadeUncoveredDuration:n},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!(0,x.Z)("disable-feature:reduce-map-tile-levels"),textureFadeDuration:n},fadeDuration:n,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}Dp.test={reset:function(){var e=Lp();for(var t in e)Dp.profiles[t]=e[t]}},function(e){e.profiles=Lp()}(Dp||(Dp={}));var Np=Dp,Fp=n(151),Up=new Pt.Z([0,255,255]),Vp=new Pt.Z([0,0,0]),Hp=.25,zp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).color=Up.clone(),e.haloColor=null,e.haloOpacity=1,e.fillOpacity=Hp,e.shadowOpacity=.4,e.shadowColor=Vp.clone(),e.shadowDifference=.2,e}return(0,l.Z)(n,null,[{key:"toEngineOptions",value:function(e){var t,n,r,i,a,o,s=Pt.Z.toUnitRGBA(null!==(t=e.color)&&void 0!==t?t:Up),l=(0,k.pC)(e.haloColor)?Pt.Z.toUnitRGBA(e.haloColor):s,u=Pt.Z.toUnitRGBA(null!==(n=e.shadowColor)&&void 0!==n?n:Vp),c=null!==(r=e.haloOpacity)&&void 0!==r?r:1,h=null!==(i=e.fillOpacity)&&void 0!==i?i:Hp,d=null!==(a=e.shadowOpacity)&&void 0!==a?a:.4,f=null!==(o=e.shadowDifference)&&void 0!==o?o:.2;return{color:(0,Fp.f)(s[0],s[1],s[2],s[3]),haloColor:(0,Fp.f)(l[0],l[1],l[2],l[3]),haloOpacity:c,haloOpacityOccluded:.25*c,fillOpacity:h,fillOpacityOccluded:.25*h,shadowOpacity:d,shadowColor:(0,Wt.f)(u[0],u[1],u[2],u[3]),occludedShadowOpacity:d*(1-f)}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({type:Pt.Z})],zp.prototype,"color",void 0),(0,p._)([(0,Z.Cb)({type:Pt.Z})],zp.prototype,"haloColor",void 0),(0,p._)([(0,Z.Cb)()],zp.prototype,"haloOpacity",void 0),(0,p._)([(0,Z.Cb)()],zp.prototype,"fillOpacity",void 0),(0,p._)([(0,Z.Cb)()],zp.prototype,"shadowOpacity",void 0),(0,p._)([(0,Z.Cb)({type:Pt.Z})],zp.prototype,"shadowColor",void 0),(0,p._)([(0,Z.Cb)()],zp.prototype,"shadowDifference",void 0);var Bp=zp=(0,p._)([(0,L.j)("esri.views.3d.support.HighlightOptions")],zp),Gp=n(67387),Wp=n(45362),jp=n(81943),qp=function(){function e(t,n){(0,s.Z)(this,e),this.spatialReference=n,this.unitInMeters=(0,lu.c9)(this.spatialReference,(0,qt.Iu)(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=(0,Gp.getGeometryServiceURL)(t&&t.get("portalItem")).catch((function(){throw new b.Z("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}return(0,l.Z)(e,[{key:"toGeographic",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,i,o,s,l,u=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._geometryServiceURLPromise;case 2:return n=e.sent,i=!0,Array.isArray(t[0])&&"number"!=typeof t[0]?r=t:(r=[t],i=!1),o=r.map((function(e){return e instanceof _i.Z?e:new _i.Z(e,u.spatialReference)})),s=new jp.Z({geometries:o,outSpatialReference:ee.Z.WGS84}),e.next=9,(0,Wp.i)(n,s);case 9:return l=e.sent.map((function(e){return"point"===e.type?[e.x,e.y]:void 0})).filter((function(e){return!!e})),e.abrupt("return",i?l:l[0]);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}(),Yp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).minTotalNumberOfFeatures=2e3,e.maxTotalNumberOfFeatures=5e4,e.maxTotalNumberOfPrimitives=17e5,e.snapshotAvailable=!0,e.polygonLodFactor=1,e.polylineLodFactor=1,e.skipHighSymbolLods=!1,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)()],Yp.prototype,"minTotalNumberOfFeatures",void 0),(0,p._)([(0,Z.Cb)()],Yp.prototype,"maxTotalNumberOfFeatures",void 0),(0,p._)([(0,Z.Cb)()],Yp.prototype,"maxTotalNumberOfPrimitives",void 0),(0,p._)([(0,Z.Cb)()],Yp.prototype,"snapshotAvailable",void 0),(0,p._)([(0,Z.Cb)()],Yp.prototype,"polygonLodFactor",void 0),(0,p._)([(0,Z.Cb)()],Yp.prototype,"polylineLodFactor",void 0),(0,p._)([(0,Z.Cb)()],Yp.prototype,"skipHighSymbolLods",void 0),Yp=(0,p._)([(0,L.j)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Yp);var Xp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).lodFactor=1,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)()],Xp.prototype,"lodFactor",void 0);var Qp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).lodCrossfadeinDuration=(0,lr.HA)(0),e.lodCrossfadeoutDuration=(0,lr.HA)(0),e.lodCrossfadeUncoveredDuration=(0,lr.HA)(0),e}return(0,l.Z)(n)}(Xp=(0,p._)([(0,L.j)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],Xp));Qp=(0,p._)([(0,L.j)("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],Qp);var Jp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).object=new Qp,e.point=new Xp,e.integratedMesh=new Xp,e.pointCloud=new Xp,e.uncompressedTextureDownsamplingEnabled=!1,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)({type:Qp})],Jp.prototype,"object",void 0),(0,p._)([(0,Z.Cb)({type:Xp})],Jp.prototype,"point",void 0),(0,p._)([(0,Z.Cb)({type:Xp})],Jp.prototype,"integratedMesh",void 0),(0,p._)([(0,Z.Cb)({type:Xp})],Jp.prototype,"pointCloud",void 0),(0,p._)([(0,Z.Cb)()],Jp.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Jp=(0,p._)([(0,L.j)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Jp);var Kp=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).lodBias=0,e.angledSplitBias=1,e.reduceTileLevelDifferences=!0,e.textureFadeDuration=(0,lr.HA)(400),e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)()],Kp.prototype,"lodBias",void 0),(0,p._)([(0,Z.Cb)()],Kp.prototype,"angledSplitBias",void 0),(0,p._)([(0,Z.Cb)()],Kp.prototype,"reduceTileLevelDifferences",void 0),(0,p._)([(0,Z.Cb)()],Kp.prototype,"textureFadeDuration",void 0),Kp=(0,p._)([(0,L.j)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Kp);var $p=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).pixelRatio=1,e.maxTotalNumberOfFeatures=5e4,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)()],$p.prototype,"pixelRatio",void 0),(0,p._)([(0,Z.Cb)()],$p.prototype,"maxTotalNumberOfFeatures",void 0),$p=(0,p._)([(0,L.j)("esri.views.3d.support.QualitySettings.HeatmapSettings")],$p);var ev=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).graphics3D=new Yp,e.sceneService=new Jp,e.tiledSurface=new Kp,e.heatmap=new $p,e.fadeDuration=(0,lr.HA)(400),e.antialiasingEnabled=!0,e.physicallyBasedRenderingEnabled=!1,e.highQualityTransparency=!0,e.memoryLimit=void 0,e.additionalCacheMemory=void 0,e.frameRate=void 0,e.maximumPixelRatio=1/0,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)({type:Yp})],ev.prototype,"graphics3D",void 0),(0,p._)([(0,Z.Cb)({type:Jp})],ev.prototype,"sceneService",void 0),(0,p._)([(0,Z.Cb)({type:Kp})],ev.prototype,"tiledSurface",void 0),(0,p._)([(0,Z.Cb)({type:$p})],ev.prototype,"heatmap",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"fadeDuration",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"antialiasingEnabled",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"physicallyBasedRenderingEnabled",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"highQualityTransparency",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"memoryLimit",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"additionalCacheMemory",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"frameRate",void 0),(0,p._)([(0,Z.Cb)()],ev.prototype,"maximumPixelRatio",void 0);var tv=ev=(0,p._)([(0,L.j)("esri.views.3d.support.QualitySettings.QualitySettings")],ev),nv=n(17539),rv=n(45888),iv=n(18759);function av(e){return"function"==typeof e.getUsedMemory}var ov=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._quality=1,r._memoryUsed=0,r._updating=!1,r.minQuality=.1,r._stableQuality=0,r._downscaleMemoryUsed=0,r._canFastRecover=!1,r._memoryPredicted=0,r._cacheStorage=new iv.WJ,r._warnMemoryUsage=null,r._numQualityChanges=0,r._maxMemory=500,r._additionalCacheMemory=100,r}return(0,l.Z)(n,[{key:"destroy",value:function(){this._cacheStorage.destroy()}},{key:"maxMemory",get:function(){return this._maxMemory},set:function(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}},{key:"additionalCacheMemory",get:function(){return this._additionalCacheMemory},set:function(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._memoryUsed}},{key:"newCache",value:function(e,t){return new iv.Xq(e,this._cacheStorage,t)}},{key:"resetStableQuality",value:function(){this._stableQuality=0}},{key:"disableMemCache",value:function(){this.additionalCacheMemory=-4096}},{key:"update",value:function(){if(this._updateMemory(),!(this._memoryPredicted<=0)||this._updating){var e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;e=this._updateQuality(this._quality+.05)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}}},{key:"_updateQuality",value:function(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}},{key:"_layersUpdating",value:function(){return this.view.allLayerViews.some((function(e){return!!e.updating}))}},{key:"_updateMemory",value:function(){var e=this,t=0,n=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(t+=this.view.basemapTerrain.getUsedMemory());var r=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderer.edgeView;(0,k.pC)(r)&&(t+=r.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach((function(r){if(av(r)){var i=r.ignoresMemoryFactor()?e._quality:1;t+=r.getUsedMemory()*i,n+=r.getUnloadedMemory()*i}}));var i=(0,k.Wi)(this._warnMemoryUsage)||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),a=1048576*this.maxMemory;if(t>a&&i){this._warnMemoryUsage=t;var o=function(e){return(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB"},s=Math.round(100*this._quality);S.Z.getLogger(this.declaredClass).warn("Memory Limit exceeded! Limit: ".concat(o(a)," Current: ").concat(o(t)," Projected: ").concat(o(t+n)," Quality: ").concat(s,"%"))}this._memoryUsed=t/a,this._memoryPredicted=(t+n)/a;var l=a-t;this._cacheStorage.maxSize=Math.max(0,l+1048576*this.additionalCacheMemory)}},{key:"test",get:function(){var e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:function(){var t=e._numQualityChanges;return e._numQualityChanges=0,t}}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],ov.prototype,"view",void 0),(0,p._)([(0,Z.Cb)()],ov.prototype,"maxMemory",null),(0,p._)([(0,Z.Cb)()],ov.prototype,"additionalCacheMemory",null),(0,p._)([(0,Z.Cb)()],ov.prototype,"memoryFactor",null),(0,p._)([(0,Z.Cb)()],ov.prototype,"updating",null),(0,p._)([(0,Z.Cb)()],ov.prototype,"usedMemory",null),(0,p._)([(0,Z.Cb)()],ov.prototype,"_quality",void 0),(0,p._)([(0,Z.Cb)()],ov.prototype,"_memoryUsed",void 0),(0,p._)([(0,Z.Cb)()],ov.prototype,"_updating",void 0),(0,p._)([(0,Z.Cb)()],ov.prototype,"_stableQuality",void 0),(0,p._)([(0,Z.Cb)()],ov.prototype,"_maxMemory",void 0),(0,p._)([(0,Z.Cb)()],ov.prototype,"_additionalCacheMemory",void 0),ov=(0,p._)([(0,L.j)("esri.views.3d.support.MemoryController")],ov);var sv=n(95911),lv=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).updating=!1,e}return(0,l.Z)(n)}(J.Z);(0,p._)([(0,Z.Cb)({readOnly:!0})],lv.prototype,"updating",void 0);var uv=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._immediateTask=Dn.sq,e._normalTask=Dn.sq,e._frameTask=null,e}return(0,l.Z)(n,[{key:"immediate",get:function(){return this._immediateTask}},{key:"normal",get:function(){return this._normalTask}},{key:"initialize",value:function(){var e=this;this._scheduler=(0,Dn.z4)(),this._memoryController=function(e){return new ov({view:e})}(this.view),this._streamDataLoader=new sv.wu,this._streamDataLoader.setup(rv.NT,rv.Ty,this._scheduler),this.addHandles([(0,A.YP)((function(){var t;return null===(t=e.view.state)||void 0===t?void 0:t.mode}),(function(t){null!=t&&(e._scheduler.state=t)}),A.Z_),(0,A.YP)((function(){return e.view.stationary}),(function(){return e._stationaryChangedHandler()}))]),this._frameTask=(0,E.A)({update:function(t){return e._frame(t)}}),this._immediateTask=this._scheduler.registerTask(Dn.T8.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(Dn.T8.RESOURCE_CONTROLLER)}},{key:"destroy",value:function(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=(0,k.hw)(this._frameTask),this._streamDataLoader=(0,k.SC)(this._streamDataLoader),this._memoryController=(0,k.SC)(this._memoryController),this._scheduler=(0,k.SC)(this._scheduler)}},{key:"updating",get:function(){var e,t,n;return!!(null!==(e=this._memoryController)&&void 0!==e&&e.updating||null!==(t=this._streamDataLoader)&&void 0!==t&&t.updating||null!==(n=this._immediateTask)&&void 0!==n&&n.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"createStreamDataRequester",value:function(e){var t=this._streamDataLoader;return{request:function(n,r,i){return t.request(n,r,e,i)},get busy(){return!t.hasDownloadSlots(e)}}}},{key:"_frame",value:function(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,lr.D9)(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}},{key:"_stationaryChangedHandler",value:function(){this.memoryController.resetStableQuality()}},{key:"test",get:function(){var e=this;return{getQueueStats:function(t){return e._streamDataLoader.test.loadQueue.getStatsForType(t)}}}}]),n}(lv=(0,p._)([(0,L.j)("esri.views.3d.support.ResourceControllerMain")],lv));(0,p._)([(0,Z.Cb)({constructOnly:!0})],uv.prototype,"view",void 0),(0,p._)([(0,Z.Cb)()],uv.prototype,"_scheduler",void 0),(0,p._)([(0,Z.Cb)()],uv.prototype,"_memoryController",void 0),(0,p._)([(0,Z.Cb)()],uv.prototype,"_streamDataLoader",void 0),(0,p._)([(0,Z.Cb)()],uv.prototype,"_immediateTask",void 0),(0,p._)([(0,Z.Cb)()],uv.prototype,"_normalTask",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],uv.prototype,"updating",null),uv=(0,p._)([(0,L.j)("esri.views.3d.support.ResourceControllerImpl")],uv);var cv=n(59896);var hv=n(53379),dv=(0,l.Z)((function e(t,n){if((0,s.Z)(this,e),this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=(0,hv.wP)(t)?n.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),function(e){return"performanceInfo"in e}(t)){var r=t.performanceInfo;this.displayedNumberOfFeatures=r.displayedNumberOfFeatures,this.maximumNumberOfFeatures=r.maximumNumberOfFeatures,this.totalNumberOfFeatures=r.totalNumberOfFeatures}})),fv=(0,l.Z)((function e(t){var n,r,i=this;if((0,s.Z)(this,e),this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,(0,k.pC)(t.resourceController)){var a,o=t.resourceController.memoryController;this.totalMemory=(null!==(a=o.maxMemory)&&void 0!==a?a:0)*cv.Y8.MEGABYTES,this.usedMemory=Math.round(o.usedMemory*this.totalMemory),this.quality=o.memoryFactor,this.load=t.resourceController.scheduler.load}this.terrainMemory=null!==(n=null===(r=t.basemapTerrain)||void 0===r?void 0:r.getUsedMemory())&&void 0!==n?n:0;var l=t._stage&&t._stage.renderView&&t._stage.renderer.edgeView;this.edgesMemory=(0,k.pC)(l)?l.usedMemory:0,t.allLayerViews.items.forEach((function(e){(av(e)||(0,hv.wP)(e))&&i.layerPerformanceInfos.push(new dv(e,t))})),this.layerPerformanceInfos.sort((function(e,t){return t.memory-e.memory}))})),pv=n(27053),vv=n(57516),mv=n(13041),_v=function(){function e(t){(0,s.Z)(this,e),this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=t("gltf-resources",(function(){})),this._wosrMemCache=t("wosr-resources",(function(){}))}return(0,l.Z)(e,[{key:"destroy",value:function(){this._gltfLoading.forEach((function(e){return e.abortController.abort()})),this._wosrLoading.forEach((function(e){return e.abortController.abort()})),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}},{key:"loadGLTF",value:function(e,t,n){var r=n?"gltfPBR:".concat(e):"gltf:".concat(e),i=this._gltfMemCache.get(r);return(0,k.pC)(i)?Promise.resolve(i):this._loadOnce(this._gltfLoading,this._gltfMemCache,r,(function(t){return(0,vv.Q)(new pv.C(t.streamDataRequester),e,t,n)}),t)}},{key:"loadWOSR",value:function(e,t){var n="wosr:".concat(e,":").concat(t.disableTextures),r=this._wosrMemCache.get(n);return(0,k.pC)(r)?Promise.resolve(r):this._loadOnce(this._wosrLoading,this._wosrMemCache,n,(function(t){return(0,mv.zD)(e,t)}),t)}},{key:"_loadOnce",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,i,o,s){var l,u,c,h,d=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,R.k_)(s),l=(0,R.fu)(s,(function(){return d._abortLoad(t,i)})),(u=t.get(i))?u.refCount++:(c=new AbortController,u={refCount:1,abortController:c,promise:o((0,r.Z)((0,r.Z)({},s),{},{signal:c.signal}))},t.set(i,u)),e.prev=4,e.next=7,u.promise;case 7:return h=e.sent,e.abrupt("return",(n.put(i,h,h.size),t.delete(i),(0,R.k_)(s),h));case 9:return e.prev=9,(0,k.hw)(l),e.finish(9);case 12:case"end":return e.stop()}}),e,null,[[4,,9,12]])})));return function(t,n,r,i,a){return e.apply(this,arguments)}}()},{key:"_abortLoad",value:function(e,t){var n=e.get(t);(0,k.pC)(n)&&--n.refCount>0||(e.delete(t),(0,k.pC)(n)&&n.abortController.abort())}}]),e}(),yv=n(35995),gv=n(84779),bv=n(68401),wv=n(1487),Cv=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i,a){var o;return(0,s.Z)(this,n),(o=t.call(this,r,a))._streamDataRequester=e,o._parameters=i,o}return(0,l.Z)(n,[{key:"fromUrl",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i,s,l,u,c,h,d=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,R.k_)(r),i=(0,k.pC)(r)?r.signal:null,s=this.makeUid(t,n),(l=this._textureRequests.get(s))||(u=new AbortController,c=this._streamDataRequester.request(t,"image",{uid:s,signal:u.signal}),h=l={referenceCount:0,texture:null,textureAsync:null,abortController:u},this._textureRequests.set(s,l),l.textureAsync=c.then(function(){var e=(0,o.Z)((0,a.Z)().mark((function e(r){var i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=d._createTexture(t,r,n),h.texture=i,h.abortController=null,d._stage.add(i),e.next=6,d._stage.load(i);case 6:return e.abrupt("return",{uid:s,texture:i,release:function(){return d._release(s)}});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),(function(e){throw h.abortController=null,e}))),l.referenceCount++,e.prev=5,e.next=8,(0,R.Hl)(l.textureAsync,i);case 8:return e.abrupt("return",e.sent);case 11:throw e.prev=11,e.t0=e.catch(5),this._release(s),e.t0;case 14:case"end":return e.stop()}}),e,this,[[5,11]])})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_createTexture",value:function(e,t,n){var i=(0,r.Z)((0,r.Z)({},this._parameters),{},{powerOfTwoResizeMode:bv.CE.PAD});if((0,yv.zd)(e)){var a;if(n||0===t.width&&0===t.height){var o=t.width?t.height/t.width:1;n=n||64,o>1?(t.width=Math.round(n/o),t.height=n):(t.width=n,t.height=Math.round(n*o))}(null===(a=this._stage.renderView)||void 0===a?void 0:a.renderingContext.driverTest.svgPremultipliesAlpha.result)&&(i.preMultiplyAlpha=!1)}return i.width=t.width,i.height=t.height,new wv.x(t,i)}}]),n}(gv.G),xv=function(){function e(t){(0,s.Z)(this,e),this.textures=null,this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=t.viewState,this._view=t.view,this._pointsOfInterest=t.pointsOfInterest,this.streamDataRequester=t.resourceController.createStreamDataRequester(rv.Bh.SYMBOLOGY),this.objectResourceCache=new _v((function(e,n){return t.resourceController.memoryController.newCache(e,n)})),this.textures=new Cv(this.streamDataRequester,t.view._stage,{preMultiplyAlpha:!0,wrap:{s:an.e8.CLAMP_TO_EDGE,t:an.e8.CLAMP_TO_EDGE}},t.resourceController.scheduler);var n=(0,qt.Iu)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,cf.Gw)(t.viewingMode,n),this.screenSizePerspectiveSettingsLabels=(0,cf.n9)(t.viewingMode,n)}return(0,l.Z)(e,[{key:"destroy",value:function(){(0,k.SC)(this.textures),this.textures=null,this.streamDataRequester=null}},{key:"addGraphicsOwner",value:function(e){var t=this;if(!e)return(0,C.kB)();this._graphicsOwners.push(e);var n=(0,A.YP)((function(){var t;return null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled}),(function(){return t._updateScreenSizePerspectiveEnabled()}));return this._updateScreenSizePerspectiveEnabled(),(0,C.kB)((function(){n.remove(),(0,D.e$)(t._graphicsOwners,e),t._updateScreenSizePerspectiveEnabled()}))}},{key:"_updateScreenSizePerspectiveEnabled",value:function(){var e=this,t=this._graphicsOwners.some((function(e){var t;return!0===(null===(t=e.layer)||void 0===t?void 0:t.screenSizePerspectiveEnabled)}));if(t&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new K.Z;var n=function(){return e._updateScreenSizePerspectiveSettings()};this._screenSizePerspectiveHandles.add([(0,A.YP)((function(){return e._pointsOfInterest.centerOnSurfaceInfrequent.distance}),n,A.Z_),this._viewState.events.on("camera-projection-changed",n)]),this._updateScreenSizePerspectiveSettings()}else t||(this._screenSizePerspectiveHandles=(0,k.SC)(this._screenSizePerspectiveHandles))}},{key:"_updateScreenSizePerspectiveSettings",value:function(){var e=this._pointsOfInterest;Tv.distance=e.centerOnSurfaceInfrequent.distance,Tv.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(Tv),this.screenSizePerspectiveSettingsLabels.update(Tv),this._view._stage.renderView.requestRender()}},{key:"test",get:function(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}}]),e}(),Tv={distance:0,fovY:0},Sv=(n(51508),n(62554)),kv=n(36365),Pv=n(87037),Rv=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";(0,s.Z)(this,e),this.graphics=t,this._symbol=new Sv.Z({symbolLayers:[new kv.Z({material:{color:n},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Pv.Z({text:r,halo:{color:"white",size:1/.75},material:{color:n},size:12})]})}return(0,l.Z)(e,[{key:"show",value:function(e,t){if(!(0,k.Wi)(t)){this.hide();var n=new _i.Z({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new m.Z({geometry:n,symbol:this._symbol}),this.graphics.add(this._graphic)}}},{key:"hide",value:function(){(0,k.pC)(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}]),e}(),Av=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).handles=new K.Z,r}return(0,l.Z)(n,[{key:"destroy",value:function(){this.handles.destroy()}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Av.prototype,"renderCoordsHelper",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Av.prototype,"surface",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Av.prototype,"state",void 0),Av=(0,p._)([(0,L.j)("esri.views.3d.support.PointOfInterest")],Av);var Ev=Array,Ov=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._dirty=!1,r._propertiesPool=new mh.L({location:_i.Z,renderLocation:Ev},(0,u.Z)(r)),r._estimatedSurfaceAltitude=0,r._pendingElevationQueryController=null,r.renderLocation=(0,F.c)(),r._tmpPoint=new _i.Z,r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){var t=function(){return e._setDirty()};this.handles.add((0,A.on)((function(){var t,n;return null===(t=e.map)||void 0===t||null===(n=t.ground)||void 0===n?void 0:n.layers}),"change",t,{onListenerAdd:t,onListenerRemove:t}))}this._updateRenderLocation()}},{key:"destroy",value:function(){this._cancelPendingRequest(),this._propertiesPool=(0,k.SC)(this._propertiesPool)}},{key:"_camera",get:function(){return this.state.contentCamera}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"scale",get:function(){var e=this._camera,t=(0,Gt.i)(e.eye,this.renderLocation);return oc({renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}},t,0)}},{key:"updating",get:function(){return this._dirty||null!=this._pendingElevationQueryController}},{key:"updateRenderLocation",value:function(){this._setDirty(),this._updateRenderLocation()}},{key:"_setDirty",value:function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}},{key:"_cancelPendingRequest",value:function(){var e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}},{key:"running",get:function(){return!this._pendingElevationQueryController&&this._dirty}},{key:"runTask",value:function(){var e,t=this;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return this._updateSurfaceAltitude(0),Dn.iQ.YIELD;var n=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint,n);var r=(null!==(e=this._tmpPoint.z)&&void 0!==e?e:0)>Zv&&this.renderCoordsHelper.viewingMode===he.JY.Global&&(n.isWGS84||n.isWebMercator),i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:r?Iv:0}).then((function(e){var n;return t._updateSurfaceAltitude(null!==(n=e.geometry.z)&&void 0!==n?n:0)})).catch((function(e){(0,R.D_)(e)||t._updateSurfaceAltitude(0)})).catch((function(){})).then((function(){t._pendingElevationQueryController===i&&(t._pendingElevationQueryController=null,t.notifyChange("updating")),i=null})),this._pendingElevationQueryController=i,Dn.iQ.YIELD}},{key:"_updateSurfaceAltitude",value:function(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}},{key:"_updateRenderLocation",value:function(){this.renderCoordsHelper.setAltitude(Mv,this._estimatedSurfaceAltitude,this._camera.eye),(0,Gt.k)(this._get("renderLocation"),Mv)||(this._set("renderLocation",(0,Gt.c)(this._propertiesPool.get("renderLocation"),Mv)),this.notifyChange("renderLocation"))}}]),n}(Av);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ov.prototype,"scheduler",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ov.prototype,"cache",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ov.prototype,"task",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ov.prototype,"location",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ov.prototype,"map",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ov.prototype,"renderLocation",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ov.prototype,"scale",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ov.prototype,"updating",null),Ov=(0,p._)([(0,L.j)("esri.views.3d.support.CameraOnSurface")],Ov);var Mv=(0,F.c)(),Zv=1e5,Iv=1e6,Dv=Array,Lv=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._propertiesPool=new mh.L({location:_i.Z,renderLocation:Dv},(0,u.Z)(r)),r._currentSurfaceAltitude=0,r._latestSurfaceAltitude=0,r.distance=0,r.renderLocation=(0,F.c)(),r.updating=!1,r}return(0,l.Z)(n,[{key:"initialize",value:function(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}},{key:"destroy",value:function(){this._frameWorker=(0,k.hw)(this._frameWorker),this._propertiesPool=(0,k.SC)(this._propertiesPool)}},{key:"_camera",get:function(){return this.state.contentCamera}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"updateRenderLocation",value:function(){this.updating=!0,this._updateRenderLocation()}},{key:"estimatedSurfaceAltitude",get:function(){return this._latestSurfaceAltitude}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Dn.iQ.YIELD}},{key:"_updateRenderLocation",value:function(){var e=Fv,t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e),n=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&n&&((t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e))&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));var r=Uv;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&((0,Gt.c)(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,Gt.i)(this._camera.eye,e):((0,Gt.g)(e,this._camera.viewForward,this._get("distance")),(0,Gt.a)(e,e,this._camera.eye)),(0,Gt.k)(this._get("renderLocation"),e)||this._set("renderLocation",(0,Gt.c)(this._propertiesPool.get("renderLocation"),e))}},{key:"_calculateSurfaceIntersection",value:function(e,t){var n=this._camera;if(!this.renderCoordsHelper.intersectManifold(n.ray,e,t))return!1;if(this.state.isGlobal){var r=(0,qt.Iu)(this.renderCoordsHelper.spatialReference).radius,i=r+e,a=(0,Gt.p)(n.eye),o=a<i*i,s=(0,Gt.i)(n.eye,t);if(o&&s>r/4){var l=i-Math.sqrt(a);return(0,Gt.g)(t,n.viewForward,l),(0,Gt.a)(t,t,n.eye),!0}}else{var u,c,h=null!==(u=this.surface)&&void 0!==u&&u.ready?this.surface.extent:null;(0,k.pC)(h)&&(0,H.dH)(h,null===(c=this.surface)||void 0===c?void 0:c.spatialReference,Vv,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,Se.uZ)(t[0],Vv[0],Vv[2]),t[1]=(0,Se.uZ)(t[1],Vv[1],Vv[3]))}return!0}},{key:"_latestSurfaceAltitudeChangesDistanceSignificantly",value:function(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Jd.Z.TESTS_DISABLE_OPTIMIZATIONS)return!0;var n=this._camera.eye,r=(0,Gt.i)(n,e),i=(0,Gt.i)(n,t);if(Math.abs(i-r)/r>Nv)return!0}return!1}}]),n}(Av);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Lv.prototype,"scheduler",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Lv.prototype,"task",void 0),(0,p._)([(0,Z.Cb)()],Lv.prototype,"distance",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Lv.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Lv.prototype,"location",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Lv.prototype,"renderLocation",void 0),(0,p._)([(0,Z.Cb)()],Lv.prototype,"updating",void 0),Lv=(0,p._)([(0,L.j)("esri.views.3d.support.CenterOnSurface")],Lv);var Nv=.05,Fv=(0,F.c)(),Uv=(0,F.c)(),Vv=(0,z.Ue)(),Hv=function(){function e(t){var n=this;(0,s.Z)(this,e),this._handles=new K.Z,this.events=new $.Z,this._contentLayerViews=t.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(function(e){return n._layerViewsChanged(e)}))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}return(0,l.Z)(e,[{key:"destroy",value:function(){this._handles=(0,k.SC)(this._handles)}},{key:"_layerViewsChanged",value:function(e){var t=this;e.added.forEach((function(e){"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&t._handles.add(e.on("visible-geometry-changed",(function(){return t._contentChanged()})),e.uid)})),e.removed.forEach((function(e){return t._handles.remove(e.uid)}))}},{key:"_contentChanged",value:function(){this.events.emit("request-update",zv)}}]),e}(),zv={},Bv=Array,Gv=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._propertiesPool=new mh.L({location:_i.Z,renderLocation:Bv},(0,u.Z)(r)),r._dirty=!0,r.renderLocation=r._propertiesPool.get("renderLocation"),r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this.handles.add([(0,A.YP)((function(){return e.centerOnSurface.renderLocation}),(function(){return e.updateRenderLocation()})),(0,A.YP)((function(){return e.state.contentCamera}),(function(){return e.updateRenderLocation()}))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(Dn.T8.POINT_OF_INTEREST_FREQUENT,this))}},{key:"destroy",value:function(){this._propertiesPool=(0,k.SC)(this._propertiesPool)}},{key:"updating",get:function(){return this._dirty||this.centerOnSurface.updating}},{key:"location",get:function(){var e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}},{key:"running",get:function(){return this._dirty}},{key:"runTask",value:function(){var e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,n=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,n.worldUpAtPosition(t,Wv);var i=Math.max(0,(Math.acos((0,Gt.e)(Wv,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(i)){if(!e||!(0,Gt.F)(e,t)){var a=this._propertiesPool.get("renderLocation");(0,Gt.c)(a,t),this._set("renderLocation",a)}return Dn.iQ.YIELD}var o=1-(0,Se.uZ)(i/(.5*Math.PI),0,1),s=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(qv);var l=this._propertiesPool.get("renderLocation");return(0,Gt.h)(l,t,qv,s),e&&(0,Gt.F)(e,l)||this._set("renderLocation",l),Dn.iQ.YIELD}},{key:"_calculateScreenHorizontalEdgeOnSurface",value:function(e){var t=this.state.contentCamera,n=t.getRenderCenter((0,O.J$)());if(n[1]=t.aboveGround?t.padding[Jo.N.BOTTOM]:t.fullHeight-t.padding[Jo.N.TOP],this.estimateSurfaceIntersectionAtRenderPoint(n,e))return e;var r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(n,jv)){(0,Gt.b)(jv,jv,t.eye);var i=(0,Gt.n)(jv,jv);if(this.renderCoordsHelper.intersectManifold((0,ta.re)(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}},{key:"updateRenderLocation",value:function(){this._dirty=!0}}]),n}(Av);(0,p._)([(0,Z.Cb)()],Gv.prototype,"_dirty",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Gv.prototype,"scheduler",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Gv.prototype,"centerOnSurface",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Gv.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Gv.prototype,"updating",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Gv.prototype,"location",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Gv.prototype,"renderLocation",void 0),Gv=(0,p._)([(0,L.j)("esri.views.3d.support.pointsOfInterest.Focus")],Gv);var Wv=(0,F.c)(),jv=(0,F.c)(),qv=(0,F.c)(),Yv=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).location=null,r._updateController=null,r._handles=new K.Z,r}return(0,l.Z)(n,[{key:"surface",get:function(){var e;return null===(e=this.view.map)||void 0===e?void 0:e.ground}},{key:"surfaceView",get:function(){return this.view.basemapTerrain}},{key:"renderLocation",get:function(){if(!this.location)return null;var e=(0,F.c)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}},{key:"initialize",value:function(){var e=this;this.view.state.isLocal&&(this._handles.add([(0,A.YP)((function(){var t,n;return[null===(t=e.surfaceView)||void 0===t?void 0:t.spatialReference,null===(n=e.surfaceView)||void 0===n?void 0:n.extent]}),(function(){return e._update()})),(0,A.on)((function(){var t;return null===(t=e.surface)||void 0===t?void 0:t.layers}),"change",(function(){return e._update()}))]),this._update())}},{key:"destroy",value:function(){this._handles.destroy()}},{key:"_update",value:function(){var e=this;if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||(0,k.Wi)(this.surfaceView.extent)||(0,k.Wi)(this.surfaceView.spatialReference))this._set("location",null);else{var t=(0,z.be)(this.surfaceView.extent),n=new _i.Z({x:t[0],y:t[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(n,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((function(t){e._updateController=null,e._set("location",t.geometry)})).catch((function(e){(0,R.D_)(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",n)}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Yv.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Yv.prototype,"cache",void 0),(0,p._)([(0,Z.Cb)()],Yv.prototype,"surface",null),(0,p._)([(0,Z.Cb)()],Yv.prototype,"surfaceView",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Yv.prototype,"location",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Yv.prototype,"renderLocation",null),Yv=(0,p._)([(0,L.j)("esri.views.3d.terrain.StableSurfaceCenter")],Yv);var Xv=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._tileGeometryUpdateExtent=(0,z.cS)(),r._tileGeometryUpdateSpatialReference=null,r.events=new $.Z,r.updating=!1,r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this.addHandles([this.surface.on("elevation-change",(function(t){return e._tileGeometryChanged(t)})),this.scheduler.registerTask(Dn.T8.SURFACE_GEOMETRY_UPDATES,this)])}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Qv),(0,z.cS)(this._tileGeometryUpdateExtent),this._set("updating",!1),Dn.iQ.YIELD):Dn.iQ.YIELD}},{key:"_tileGeometryChanged",value:function(e){this._tileGeometryUpdateSpatialReference=(0,k.Wg)(e.spatialReference),(0,z.jn)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}},{key:"_furthestCenterOnSurface",value:function(){for(var e=this.centerOnSurfaces[0],t=1;t<this.centerOnSurfaces.length;t++){var n=this.centerOnSurfaces[t];n.distance>e.distance&&(e=n)}return e}},{key:"_centerIntersectsExtent",value:function(e,t){var n=this.state.contentCamera.eye,r=$v,i=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(n,Jv,t),this.renderCoordsHelper.fromRenderCoords(i.renderLocation,Kv,t),Jv[0]<Kv[0]?(r[0]=Jv[0],r[2]=Kv[0]):(r[0]=Kv[0],r[2]=Jv[0]),Jv[1]<Kv[1]?(r[1]=Jv[1],r[3]=Kv[1]):(r[1]=Kv[1],r[3]=Jv[1]),(0,z.kK)(r,e)}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Xv.prototype,"state",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Xv.prototype,"centerOnSurfaces",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Xv.prototype,"renderCoordsHelper",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Xv.prototype,"scheduler",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Xv.prototype,"surface",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Xv.prototype,"updating",void 0),Xv=(0,p._)([(0,L.j)("esri.views.3d.support.SurfaceGeometryUpdates")],Xv);var Qv={},Jv=(0,F.c)(),Kv=(0,F.c)(),$v=(0,z.cS)(),em=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r._tmpRay=(0,ta.Ue)(),r._centerRayDirty=!0,r._surfaceAltitudeAtCenter=0,r._surfaceAltitudeAtCenterDirty=!0,r._contentAltitudeAtCenter=0,r._contentAltitudeAtCenterDirty=!0,r._propertiesPool=new mh.L({renderPointOfView:tm},(0,u.Z)(r)),r.renderPointOfView=(0,F.c)(),r._pois=new Array,r._debugCenters=new Map,r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e,t=this,n=this.view,a=n.state,o=n.basemapTerrain,s=n.renderCoordsHelper,l=n.map;this._surfaceIntersector=(0,Pa.Z8)(a.viewingMode),a.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=wp.eC.MIN,this._contentIntersector=(0,Pa.Z8)(a.viewingMode);var u=function(){return t._estimateSurfaceAltitudeAtCenter()},c=this.view.resourceController.scheduler,h=(0,k.Wg)(null===(e=this.view.basemapTerrain)||void 0===e?void 0:e.elevationQueryCache),d={state:a,scheduler:c,surface:o,renderCoordsHelper:s};this._set("centerOnSurfaceInfrequent",new Lv((0,r.Z)((0,r.Z)({},d),{},{task:Dn.T8.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:u}))),this._set("centerOnSurfaceFrequent",new Lv((0,r.Z)((0,r.Z)({},d),{},{task:Dn.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:u}))),this._set("centerOnContent",new Lv((0,r.Z)((0,r.Z)({},d),{},{task:Dn.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:function(){return t._estimateContentAltitudeAtCenter()}}))),this._set("cameraOnSurface",new Ov((0,r.Z)((0,r.Z)({},d),{},{cache:h,task:Dn.T8.POINT_OF_INTEREST_INFREQUENT,map:l}))),this._set("surfaceGeometryUpdates",new Xv((0,r.Z)((0,r.Z)({},d),{},{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new Hv({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:s})),this._set("surfaceOrigin",new Yv({cache:h,view:this.view})),this._set("focus",new Gv({state:a,scheduler:c,surface:o,renderCoordsHelper:s,centerOnSurface:this.centerOnSurfaceInfrequent,estimateSurfaceIntersectionAtRenderPoint:function(e,n){return t._estimateSurfaceIntersectionAtRenderPoint(e,t.view.state.contentCamera,n)}})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);var f=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Rv(f,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Rv(f,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Rv(f,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Rv(f,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new Rv(f,"green","Focus")),this._handles.add([(0,A.YP)((function(){return a.contentCamera}),(function(e){return t._cameraChanged(e)}),A.Z_),(0,A.YP)((function(){return o.extent}),(function(){return t._updateCenterPointsOfInterest()})),(0,A.gx)((function(){return!o.updating}),(function(){return t._updateCenterPointsOfInterest()}),A.Z_),(0,A.on)((function(){return t.surfaceGeometryUpdates.events}),"request-update",(function(){return t._updateCenterPointsOfInterest()})),(0,A.on)((function(){return t.contentGeometryUpdates.events}),"request-update",(function(){return t._updateCenterOnContent()})),(0,A.gx)((function(){return Jd.Z.SHOW_POI}),(function(e){return t._setDebug(e)}),A.nn)]),this._cameraChanged(this.view.state.contentCamera);var p,v=(0,i.Z)(this._pois);try{for(v.s();!(p=v.n()).done;){p.value.runTask()}}catch(m){v.e(m)}finally{v.f()}}},{key:"destroy",value:function(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();var e,t=(0,i.Z)(this._pois);try{for(t.s();!(e=t.n()).done;){e.value.destroy()}}catch(n){t.e(n)}finally{t.f()}this.surfaceOrigin.destroy()}},{key:"updating",get:function(){var e;return!((null===(e=this.surfaceGeometryUpdates)||void 0===e||!e.updating)&&!this._pois.some((function(e){return e.updating})))}},{key:"_centerRay",get:function(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}},{key:"_estimateContentAltitudeAtCenter",value:function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;var e=this._centerRay;return(0,k.Wi)(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,nm,im)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(nm):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}},{key:"_estimateSurfaceAltitudeAtCenter",value:function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;var e=this._centerRay;if((0,k.Wi)(e))return this._surfaceAltitudeAtCenter;var t=e.origin,n=(0,Gt.a)(nm,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,n),this._surfaceIntersector.results.min.getIntersectionPoint(nm)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(nm)),this._surfaceAltitudeAtCenter}},{key:"_estimateSurfaceIntersectionAtRenderPoint",value:function(e,t,n){var r=(0,Vs.eW)(t,e,rm);if((0,k.Wi)(r))return null;var i=r.origin,a=(0,Gt.a)(nm,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,i,a),this._surfaceIntersector.results.min.getIntersectionPoint(n)?n:null}},{key:"_cameraChanged",value:function(e){this._updateCenterPointsOfInterest();var t=e.eye;(0,Gt.k)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,Gt.c)(this._propertiesPool.get("renderPointOfView"),t))}},{key:"_updateCenterPointsOfInterest",value:function(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;var e,t=(0,i.Z)(this._pois);try{for(t.s();!(e=t.n()).done;){e.value.updateRenderLocation()}}catch(n){t.e(n)}finally{t.f()}}},{key:"_updateCenterOnContent",value:function(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}},{key:"_setDebug",value:function(e){var t=this;if(!e)return this._debugCenters.forEach((function(e){return e.hide()})),void this._handles.remove("debug");var n,r=(0,i.Z)(this._pois);try{var a=function(){var e=n.value;t._handles.add((0,A.YP)((function(){return e.renderLocation}),(function(n){var r;return null===(r=t._debugCenters.get(e))||void 0===r?void 0:r.show(n,e.renderCoordsHelper.spatialReference)}),A.nn),"debug")};for(r.s();!(n=r.n()).done;)a()}catch(o){r.e(o)}finally{r.f()}}},{key:"test",get:function(){var e=this;return{update:function(){e.surfaceGeometryUpdates.runTask();var t,n=(0,i.Z)(e._pois);try{for(n.s();!(t=n.n()).done;){t.value.runTask()}}catch(r){n.e(r)}finally{n.f()}},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"centerOnContent",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"centerOnSurfaceFrequent",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"centerOnSurfaceInfrequent",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"cameraOnSurface",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"focus",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"renderPointOfView",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"surfaceOrigin",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"contentGeometryUpdates",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"surfaceGeometryUpdates",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],em.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],em.prototype,"updating",null),em=(0,p._)([(0,L.j)("esri.views.3d.support.PointsOfInterest")],em);var tm=Array,nm=(0,F.c)(),rm=(0,ta.Ue)(),im={exclude:new Set([Gs.cy])},am=n(77178),om=n(71684),sm=function(){function e(t){(0,s.Z)(this,e),this._store=t}return(0,l.Z)(e,[{key:"destroy",value:function(){this._store.destroy()}},{key:"get",value:function(e){return this._store.get(e)}},{key:"put",value:function(e,t){this._store.put(e,t,t.values.byteLength+256)}}]),e}(),lm=n(48932),um=n(41665),cm=n(72291),hm=n(58890),dm=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;(0,s.Z)(this,e),this.min=t,this.max=n,this.level=0,this.hasNoDataValues=!1}return(0,l.Z)(e,[{key:"copyFrom",value:function(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}]),e}(),fm=n(11939),pm=function(){function e(t,n,r){(0,s.Z)(this,e),this.type="elevation",this.level=t[0],this.i=t[1],this.j=t[2],this.extent=n,this.samplerData=new fm.K(r,n)}return(0,l.Z)(e,[{key:"computeMinMaxValue",value:function(e,t,n,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;var i=e-this.level;if(i<=0)return r;var a=Math.pow(2,i);if(Math.floor(t/a)!==this.i||Math.floor(n/a)!==this.j)return r;var o=1/0,s=-1/0,l=this.samplerData.data.width,u=this.samplerData.data.values,c=.5*re.$7,h=(l-1)/a,d=(n-this.j*a)*h,f=(t-this.i*a)*h;if(h<1){var p=Math.floor(d),v=Math.floor(f),m=p+v*l,_=u[m],y=u[m+1],g=u[m+l],b=u[m+l+1];if(_+y+g+b<c){var w=d-p,C=f-v,x=(0,Pe.bX)(_,y,g,b,w,C),T=(0,Pe.bX)(_,y,g,b,w+h,C),S=(0,Pe.bX)(_,y,g,b,w,C+h),k=(0,Pe.bX)(_,y,g,b,w+h,C+h);return r.min=Math.min(x,T,S,k),r.max=Math.max(x,T,S,k),r}d=p,f=v,h=1}else d=Math.floor(d),f=Math.floor(f),h=Math.ceil(h);for(var P=d;P<=d+h;P++)for(var R=f;R<=f+h;R++){var A=u[P+R*l];A<c?(o=Math.min(o,A),s=Math.max(s,A)):r.hasNoDataValues=!0}return r.min=o,r.max=s,r}}]),e}(),vm=.5*re.$7;function mm(e,t,n){if((0,k.Wi)(n))return null;var r,a=(0,i.Z)(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o){var s=o.safeWidth,l=(0,Se.uZ)(o.dy*(o.y1-t),0,s),u=(0,Se.uZ)(o.dx*(e-o.x0),0,s),c=Math.floor(l),h=Math.floor(u),d=o.data.width,f=c*d+h,p=o.data.values,v=p[f],m=p[f+1],_=f+d,y=p[_],g=p[_+1];if(v+y+m+g<vm){var b=v+(m-v)*(u-=h);return b+(y+(g-y)*u-b)*(l-=c)}}}}catch(w){a.e(w)}finally{a.f()}return null}var _m=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this._handles.add([this.layerViews.on("change",(function(){return e.notifyChange("stencilEnabledExtents")}))])}},{key:"destroy",value:function(){this._handles=(0,k.SC)(this._handles)}},{key:"layerViewsExtent",get:function(){return this._computeLayerViewsExtent()}},{key:"tiledLayersExtent",get:function(){return this._computeTiledLayersExtent()}},{key:"stencilEnabledExtents",get:function(){return this._computeStencilEnabledExtents()}},{key:"_computeStencilEnabledExtents",value:function(){var e=this,t=[];return this.layerViews.forEach((function(n){var r=n.layer;if("IntegratedMeshLayer"===r.operationalLayerType&&null!=e.viewSpatialReference){var i=bm(r.fullExtent,e.viewSpatialReference);(0,k.pC)(i)&&t.push((0,z.oJ)(i))}})),t}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({readOnly:!0})],_m.prototype,"layerViewsExtent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_m.prototype,"tiledLayersExtent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],_m.prototype,"stencilEnabledExtents",null),(0,p._)([(0,Z.Cb)()],_m.prototype,"viewSpatialReference",void 0),(0,p._)([(0,Z.Cb)()],_m.prototype,"tilingScheme",void 0),(0,p._)([(0,Z.Cb)()],_m.prototype,"defaultTiledLayersExtent",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],_m.prototype,"layers",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],_m.prototype,"layerViews",void 0);var ym=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"_computeLayerViewsExtent",value:function(){return this._globalExtent}},{key:"_computeTiledLayersExtent",value:function(){return this._globalExtent}},{key:"_globalExtent",get:function(){return this.viewSpatialReference.isWebMercator?re.cy:re.Lz}}]),n}(_m=(0,p._)([(0,L.j)("esri.views.3d.terrain.ExtentHelper")],_m));ym=(0,p._)([(0,L.j)("esri.views.3d.terrain.ExtentHelperGlobal")],ym);var gm=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"_computeLayerViewsExtent",value:function(){var e=(0,z.cS)(),t=this.viewSpatialReference;this.layerViews.forEach((function(n){var r=n.layer;if(n.isResolved()&&("graphics"!==r.type||!r.internal)){var i=bm("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,t);(0,z.jn)(e,i,e)}}));var n=(0,z.sU)(e)?e:null,r=this._get("layerViewsExtent");return(0,z.fS)(n,r)?r:n}},{key:"_computeTiledLayersExtent",value:function(){var e=this.tilingScheme;if(!e)return null;var t=this.viewSpatialReference,n=(0,z.cS)();this.layers.forEach((function(r){if(r.loaded&&(0,q.iC)(r)){var i=(0,hv.E_)(r,t,he.JY.Local);if((0,k.Wi)(i))return;var a=i.tileInfo,o=i.fullExtent;(0,k.pC)(a)&&(0,k.pC)(o)&&((0,hv.x4)(r)||e.compatibleWith(a)&&o.spatialReference.equals(e.spatialReference))&&(0,z.jn)(n,o,n)}})),(0,z.jn)(n,this.defaultTiledLayersExtent,n);var r=(0,z.sU)(n)?n:null,i=this._get("tiledLayersExtent");return(0,z.fS)(r,i)?i:r}}]),n}(_m);function bm(e,t){return(0,k.pC)(e)&&!e.spatialReference.equals(t)?(0,H.fi)(e,e.spatialReference,t):e}gm=(0,p._)([(0,L.j)("esri.views.3d.terrain.ExtentHelperLocal")],gm);var wm,Cm=n(54134);!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(wm||(wm={}));var xm=[wm.ELEVATION,wm.MAP],Tm=n(19384),Sm=n(61403),km=n(56529),Pm=n(81341);function Rm(){var e,t=null===(e=globalThis.require)||void 0===e?void 0:e.modules;if(t)for(var n=0,r=Object.keys(t);n<r.length;n++){var i=r[n];-1!==i.search(".glsl")&&delete t[i]}}var Am,Em=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],Om=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r._spatialReference=null,r._renderSR=null,r._overlaySREqualsRenderSR=!0,r._drapeSources=new Set,r._drapeTargets=new Set,r._placementDirty=!1,r._contentUpdated=!1,r._drawTexturesDirty=!1,r._drawTexturesAnimateDirty=!1,r._hasUnusedRenderTargets=!1,r._longitudeCyclical=null,r._latestOriginId=0,r._maxResolution=(0,x.Z)("esri-mobile")?2048:4096,r._animationTimeLast=0,r}return(0,l.Z)(n,[{key:"running",get:function(){return this._placementDirty&&(this._drapeSources.size>0||this._view.graphics.length>0||Jd.Z.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}},{key:"_isSpherical",get:function(){return this._view.state.isGlobal}},{key:"_worldToPCSRatio",get:function(){return(0,k.pC)(this._spatialReference)&&this._spatialReference.isGeographic&&!this._view.state.isLocal?(0,qt.Iu)(this._spatialReference).metersPerDegree:1}},{key:"_view",get:function(){return this.surface.view}},{key:"suspended",get:function(){return this.surface.suspended}},{key:"updating",get:function(){return this.running||this.renderer.updating||this._contentUpdated}},{key:"hasHighlights",get:function(){return this.renderer.hasHighlights}},{key:"rendersOccluded",get:function(){return this.renderer.rendersOccluded}},{key:"initialize",value:function(){var e,t=this,n=this._view;this.renderer=new Tm.CB({view:n,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=(0,Pa.Z8)(this._view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(function(){t.setDrawTexturesDirty(),t.notifyChange("hasHighlights")})),this.renderer.events.on("has-water",(function(e){var t;return null===(t=n._stage)||void 0===t?void 0:t.renderer.setParameters({hasOverlayWater:e})})),this.renderer.events.on("renders-occluded",(function(){t.setDrawTexturesDirty(),t.notifyChange("rendersOccluded")})),this.renderer.events.on("content-changed",(function(){return t.setDrawTexturesDirty()})),this.renderer.events.on("textures-disposed",(function(){return t.updateOverlayResult()})),(0,A.YP)((function(){var e,t,r;return[null===(e=n.pointsOfInterest)||void 0===e?void 0:e.renderPointOfView,null===(t=n.pointsOfInterest)||void 0===t||null===(r=t.centerOnSurfaceFrequent)||void 0===r?void 0:r.location]}),(function(){return t.setPlacementDirty()})),(0,A.YP)((function(){var e,t;return[null===(e=n.state)||void 0===e?void 0:e.pixelRatio,null===(t=n.state)||void 0===t?void 0:t.contentPixelRatio]}),(function(){return t.setPlacementDirty()}),A.Z_),this.surface.on("elevation-change",(function(){return t.setPlacementDirty()})),n.on("resize",(function(){return t.setPlacementDirty()})),n.resourceController.scheduler.registerTask(Dn.T8.OVERLAY,this),n._stage.renderView.events.on("force-camera-for-screenshot",(function(e){t._updateOverlays(Dn.G5,e,bv.Xx.BACKGROUND),t.renderer.hasOverlays&&t._drawOverlayTextures(t.renderer.overlays,bv.Xx.BACKGROUND,e.pixelRatio)}))]),null===(e=n._stage)||void 0===e||e.renderer.setParameters({renderOverlay:function(e){t._contentUpdated=!1,t.renderer.processSyncDrapeSources(),t.renderer.hasOverlays&&(t._dispatchAnimationUpdate(e),t._drawOverlayTextures(t.renderer.overlays,bv.Xx.UPDATE)),t._hasUnusedRenderTargets&&t._collectUnusedRenderTargetMemory()}})}},{key:"destroy",value:function(){this._handles=(0,k.SC)(this._handles),(0,k.pC)(Am)&&(Am.hide(),Am=null)}},{key:"hasOverlays",get:function(){return this.renderer.hasOverlays}},{key:"setSpatialReference",value:function(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;var t=this._view.renderSpatialReference;(0,k.pC)(e)&&(0,k.pC)(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new As.pE(-20037508.342787,20037508.342787):new As.pE(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}},{key:"gpuMemoryUsage",get:function(){return this.renderer.gpuMemoryUsage}},{key:"registerDrapeSource",value:function(e,t,n){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);var r=this.renderer.createDrapeSourceRenderer(e,t,n);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}},{key:"registerGeometryDrapeSource",value:function(e){return this.registerDrapeSource(e,Pm.S)}},{key:"_updateDrapeSourceExtent",value:function(e){2===this.renderer.overlays.length&&(0,k.pC)(e.setDrapingExtent)&&(0,k.pC)(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}},{key:"unregisterDrapeSource",value:function(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}},{key:"registerDrapeTarget",value:function(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}},{key:"updateOverlayResult",value:function(){var e;null===(e=this._view._stage)||void 0===e||e.renderer.setParameters({overlays:this.renderer.overlays})}},{key:"unregisterDrapeTarget",value:function(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}},{key:"_setContentDirty",value:function(){this.setPlacementDirty(),this.setDrawTexturesDirty()}},{key:"setPlacementDirty",value:function(){this._placementDirty=!0}},{key:"runTask",value:function(e){return this._updateOverlays(e,this._view.state.contentCamera,bv.Xx.UPDATE)}},{key:"_updateOverlays",value:function(e,t,n){var r=this;if(!this._spatialReference)return Dn.iQ.YIELD;var i=this._computeOverlayResolution(t);this._computeOverlayExtents(t,i,Dm);var a=(0,z.bf)(Dm.inner)/(0,z.bf)(Dm.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);var o=this._updateOverlay(Cm.fu.INNER,Dm.inner,i,1*Dm.pixelRatioAdjustment,Dm.mapUnitsPerPixel),s=this._updateOverlay(Cm.fu.OUTER,Dm.outer,i,a*Dm.pixelRatioAdjustment,Dm.mapUnitsPerPixel);o!==Mm.EXTENT&&s!==Mm.EXTENT||(this._drapeSources.forEach((function(e){return r._updateDrapeSourceExtent(e)})),this.surface.updateTileOverlayParams(n)),o===Mm.NONE&&s===Mm.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}},{key:"_computeOverlayResolution",value:function(e){var t=this._view.state.contentPixelRatio,n=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t;return Math.min((0,Se.Sf)(Math.max(n,r)+256),this._maxResolution)}},{key:"_updateOverlay",value:function(e,t,n,r,i){if(0===this.renderer.overlays.length)return Mm.NONE;var a=this.renderer.overlays[e],o=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=i,a.pixelRatio=r,function(e,t){var n=1e-5,r=Jd.Z.TESTS_DISABLE_OPTIMIZATIONS?0:n*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}(t,a.extent)&&n===a.resolution)return o===i?Mm.NONE:Mm.RERENDER_ONLY;(0,z.JG)(a.extent,t),a.resolution=n;var s=(0,z.be)(a.extent);return a.renderLocalOrigin=(0,Sm.a)(s[0],s[1],0,"OV_"+this._latestOriginId++),Mm.EXTENT}},{key:"setTileParameters",value:function(e){var t=e.renderData.overlay;if(this.renderer.overlays.length>0){var n=this.renderer.overlays[Cm.fu.INNER],r=this.renderer.overlays[Cm.fu.OUTER],i=e.extent;this._rectInsideRect(n.extent,i)||this._rectanglesOverlap(i,n.extent)||this._rectanglesOverlap(i,r.extent)?(this._setTileOverlayData(i,Cm.fu.INNER,t),this._setTileOverlayData(i,Cm.fu.OUTER,t)):(this._clearTileOverlayData(Cm.fu.INNER,t),this._clearTileOverlayData(Cm.fu.OUTER,t))}else this._clearTileOverlayData(Cm.fu.INNER,t),this._clearTileOverlayData(Cm.fu.OUTER,t)}},{key:"overlayPixelSizeInMapUnits",value:function(e){if(0===this.renderer.overlays.length)return 0;var t=this.renderer.overlays[Cm.fu.INNER],n=this.renderer.overlays[Cm.fu.OUTER],r=this._pointIsInExtent(e,t.extent)?t:n;return(r.extent[2]-r.extent[0])/r.resolution}},{key:"_setTileOverlayData",value:function(e,t,n){if(0!==this.renderer.overlays.length){var r=this.renderer.overlays[t].extent,i=(0,z.bf)(r),a=(0,z.Cb)(r),o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);var s=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>s&&(o=s-(e[2]-e[0]))}n.setScale(t,(0,z.bf)(e)/i,(0,z.Cb)(e)/a),n.setOffset(t,(o-r[0])/i,(e[1]-r[1])/a)}}},{key:"_clearTileOverlayData",value:function(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}},{key:"reloadShaders",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Rm(),e.next=3,this.renderer.reloadShaders();case 3:this.setDrawTexturesDirty(),this.runTask(Dn.G5);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_dispatchAnimationUpdate",value:function(e){var t=(0,lr.HA)(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||(0,k.pC)(this._view.state.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty){var n=(0,lr.HA)(t/this.surface.view._stage.renderer.animationTimeDilation),r=new km._o(this._view.state.camera,n,this._view.state.forcedAnimationTime);this.renderer.updateAnimation(r)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}},{key:"setDrawTexturesDirty",value:function(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this._view._stage.renderView.requestRender()):this.setPlacementDirty()}},{key:"_intersectGroundFromView",value:function(e,t,n,r){var i=this._view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Fm,t,n);if((0,k.Wi)(i))return!1;var a=i.origin,o=(0,Gt.a)(Im,i.origin,i.direction);return this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this._view.basemapTerrain.intersect(this._groundIntersector,null,a,o),this._groundIntersector.results.min.getIntersectionPoint(r)}},{key:"_findHorizonBasedPointOfInterest",value:function(e,t){var n=.5,r=.55,i=this._view.renderCoordsHelper.getAltitude(e.eye),a=this._view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,s=(0,Se.uZ)(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:i+o,e.aboveGround?i-o:1/0),l=e.aboveGround;if("global"===this._view.viewingMode){var u=Im;(0,ea.b)((0,ea.e)(ea.t,(0,qt.Iu)(this._view.spatialReference).radius+s),(0,ta.re)(e.eye,e.viewForward),u),(0,Gt.b)(u,u,e.eye);var c=As.Q4.normalize((0,Ms.cp)(e.viewForward,u,e.viewRight))/e.fovY+.5,h=c<=0||c>=1?.5:r;n=l?h*c:c+h*(1-c)}else{var d=.5*Math.PI-Math.acos(-e.viewForward[2]),f=Math.tan(d),p=(0,Wt.f)(0,f,1,0),v=(0,Xt.t)(p,p,e.projectionMatrix)[1],m=(0,Se.uZ)(.5+.5*v,0,1);n=1===m||0===m?.5:l?m*r:1-(1-m)*r}return!!this._intersectGroundFromView(e,.5,n,t)&&(0,Gt.E)(t,e.eye)<a.distance*a.distance}},{key:"_computeOverlayExtents",value:function(e,t,n){var r=this._view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i=(0,F.c)();this._findHorizonBasedPointOfInterest(e,i)||(0,Gt.c)(i,r);var a=Math.max(.1,(0,Gt.i)(e.eye,i)),o=Ha(this._view.renderCoordsHelper,r,e.eye),s=Math.PI/2-Math.abs(o-Math.PI/2);Jd.Z.OVERLAY_SHOW_CENTER?((0,k.Wi)(Am)&&(Am=new Rv(this._view.graphics,"red")),Am.show(i,this._renderSR)):(0,k.pC)(Am)&&Am.hide(),this._overlaySREqualsRenderSR||(0,H.SH)(i,this._renderSR,i,this._spatialReference);var l=this.surface.extent,u=!this._isSpherical&&(0,k.pC)(this._spatialReference)&&this._spatialReference.isGeographic,c=u&&(0,k.pC)(this._spatialReference)?1/(0,qt.Iu)(this._spatialReference).metersPerDegree:1,h=this._view.state.contentPixelRatio,d=e.perScreenPixelRatio/h*a*c;n.mapUnitsPerPixel=d/this._worldToPCSRatio;var f=t*d/2,p=!1,v=u?90:1/0;this._isSpherical&&(0,k.pC)(l)&&(0,k.pC)(this._spatialReference)&&(this._spatialReference.isWebMercator?(f/=Math.cos((0,su.mZ)(i[1])),v=l[3]):(p=!0,f/=(0,qt.Iu)(this._spatialReference).metersPerDegree,v=90),f>=v&&(f=v,i[1]=0,this._spatialReference.isWebMercator&&(i[0]=0)));var m=1;p&&(f*(m=1/Math.max(.2,Math.cos(Math.abs((0,Se.Vl)(i[1])))))>180&&(m=180/f),n.mapUnitsPerPixel*=m);var _=Math.log(2)/12,y=(f=Math.exp(Math.round(Math.log(f)/_)*_))*m,g=.5*t/(32*y),b=.5*t/(32*f);i[0]=Math.round(i[0]*g)/g,i[1]=Math.round(i[1]*b)/b;var w=n.inner;w[0]=i[0]-y,w[1]=i[1]-f,w[2]=i[0]+y,w[3]=i[1]+f,this._isSpherical&&this._shiftExtentToFitBounds(w,1/0,v);var C=n.outer;if(6*y>(0,z.bf)(l))(0,z.JG)(C,(0,k.Wg)(l));else if(s<=.25*Math.PI)C[0]=w[0]-y,C[1]=w[1]-f,C[2]=w[2]+y,C[3]=w[3]+f;else{(0,H.SH)(e.eye,this._renderSR,Im,this._spatialReference),(0,Yt.a)(Zm,i,Im);var x=-Math.atan2(Zm[1],Zm[0])+.125*Math.PI;x<0&&(x+=2*Math.PI);var T=Math.floor(x/(.25*Math.PI));(0,Xt.b)(Zm,Em[T],2*f),Zm[0]*=m,Zm[2]*=m,(0,Xt.a)(C,w,Zm)}if(this._isSpherical)C[0]=this._longitudeCyclical.clamp(C[0]),C[2]=this._longitudeCyclical.clamp(C[2]),C[1]=Math.max(C[1],-v),C[3]=Math.min(C[3],v);else{var S=(0,z.jV)(w,l,Lm),P=(0,z.jV)(C,l,Nm);(0,z.r3)(S,P)&&(C[2]=C[0],C[3]=C[1])}var R=Math.abs(w[2]-w[0])/t;n.mapUnitsPerPixel=Math.max(n.mapUnitsPerPixel,R),n.pixelRatioAdjustment=n.mapUnitsPerPixel/R}},{key:"_drawOverlayTextures",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._view.state.contentPixelRatio;if(0!==e.length&&(this._drawTexturesDirty||this._drawTexturesAnimateDirty)){var r=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;var i=this._drawOverlay(e[Cm.fu.INNER],n),a=this._drawOverlay(e[Cm.fu.OUTER],n);i!==bv.Yg.CHANGED&&a!==bv.Yg.CHANGED||this.surface.updateTileOverlayParams(bv.Xx.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),r?(this.surface.requestRender(t),t===bv.Xx.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(bv.Xx.BACKGROUND)}}},{key:"_drawOverlay",value:function(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t)}},{key:"_collectUnusedRenderTargetMemory",value:function(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){var e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}},{key:"_rectanglesOverlap",value:function(e,t){return!(0,k.Wi)(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,z.kK)(e,t))}},{key:"_rectInsideRect",value:function(e,t){return!(0,k.Wi)(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,z.r3)(e,t))}},{key:"_pointIsInExtent",value:function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var n=e.x,r=e.y;return n>t[0]&&n<t[2]&&r>t[1]&&r<t[3]}},{key:"_shiftExtentToFitBounds",value:function(e,t,n){var r=0,i=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-n?i=e[1]+n:e[3]>n&&(i=n-e[3]),(0,z.cv)(e,r,i)}},{key:"test",get:function(){var e=this;return{renderer:this.renderer,update:function(){return e.runTask(Dn.G5)}}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],Om.prototype,"_spatialReference",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Om.prototype,"running",null),(0,p._)([(0,Z.Cb)()],Om.prototype,"_placementDirty",void 0),(0,p._)([(0,Z.Cb)()],Om.prototype,"_contentUpdated",void 0),(0,p._)([(0,Z.Cb)()],Om.prototype,"_isSpherical",null),(0,p._)([(0,Z.Cb)()],Om.prototype,"_worldToPCSRatio",null),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],Om.prototype,"renderer",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Om.prototype,"surface",void 0),(0,p._)([(0,Z.Cb)()],Om.prototype,"suspended",null),(0,p._)([(0,Z.Cb)()],Om.prototype,"updating",null),(0,p._)([(0,Z.Cb)({type:Boolean})],Om.prototype,"hasHighlights",null),(0,p._)([(0,Z.Cb)({type:Boolean})],Om.prototype,"rendersOccluded",null),Om=(0,p._)([(0,L.j)("esri.views.3d.terrain.OverlayManager")],Om);var Mm,Zm=(0,Wt.c)(),Im=(0,F.c)(),Dm={inner:(0,z.Ue)(),outer:(0,z.Ue)(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},Lm=(0,z.Ue)(),Nm=(0,z.Ue)(),Fm=(0,ta.Ue)();!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(Mm||(Mm={}));var Um=function(){function e(t,n){(0,s.Z)(this,e),this._factoryCallback=t,this._lengthCallback=n,this._pool=new Map}return(0,l.Z)(e,[{key:"acquire",value:function(t){if(!e.test.disabled){var n=this._pool.get(t);if(n&&0!==n.length)return n.pop()}try{return this._factoryCallback(t)}catch(a){var r=window.performance&&window.performance.memory,i="";throw r&&(i="\n  totalJSHeapSize: ".concat(r.totalJSHeapSize,", usedJSHeapSize: ").concat(r.usedJSHeapSize,", jsHeapSizeLimit: ").concat(r.jsHeapSizeLimit)),console.log("Array allocation of size "+t+" failed: "+a+i),a}}},{key:"release",value:function(t){if(!e.test.disabled){var n=this._lengthCallback(t),r=this._pool.get(n);r||(r=new Qd.Z({shrink:!0}),this._pool.set(n,r)),r.push(t)}}},{key:"clear",value:function(){this._pool.clear()}},{key:"test",get:function(){return{size:this._pool.size}}}]),e}();Um.test={disabled:!1};var Vm=(0,l.Z)((function e(){(0,s.Z)(this,e),this.indices=null,this.vertexAttributes=null,this.boundingBox=(0,xc.cS)(),this.indexCount=0,this.numVerticesPerSide=0,this.uvRange=[0,0,1,1],this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]})),Hm=function(){function e(t,n,r,i,a){(0,s.Z)(this,e),this.attributes=t,this.localOrigin=n,this.index0=r,this.stride=i,this.count=a}return(0,l.Z)(e,[{key:"getVertexIndex",value:function(e){return this.getAttributeIndex(e)}},{key:"getAttributeIndex",value:function(e){return(0,hv.Fp)(0<=e&&e<this.count),this.index0+this.stride*e}},{key:"_getVertexRaw",value:function(e,t){this.attributes.position.getVec(e,t)}},{key:"_getNormalRaw",value:function(e,t){this.attributes.normalCompressed.getVec(e,t)}},{key:"getVertexPos",value:function(e,t){this._getVertexRaw(this.getAttributeIndex(t),e),(0,Gt.a)(e,e,this.localOrigin)}},{key:"getNormal",value:function(e,t){var n=(0,Jt.a)();this._getNormalRaw(this.getAttributeIndex(t),n),function(e,t){var n=Ym(t[0]),r=Ym(t[1]),i=1-Math.abs(n)-Math.abs(r);e[2]=i,i<0?(e[0]=(n>=0?1:-1)*(1-Math.abs(r)),e[1]=(r>=0?1:-1)*(1-Math.abs(n))):(e[0]=n,e[1]=r),(0,Gt.n)(e,e)}(e,n)}},{key:"_setNormal",value:function(e,t,n,r){Wm(this.attributes.normalCompressed,e,t,n,r)}},{key:"_setUV",value:function(e,t,n){jm(this.attributes.uv0,e,t,n)}},{key:"setNormalFromValues",value:function(e,t,n,r){this._setNormal(this.getAttributeIndex(e),t,n,r)}},{key:"setVertexFromValuesRawPositionUV",value:function(e,t,n,r,i,a){var o=this.getAttributeIndex(e);this.attributes.position.setValues(o,t,n,r),this._setUV(o,i,a)}},{key:"setVertexFromValuesRawPositionUVNormal",value:function(e,t,n,r,i,a,o,s,l){var u=this.getAttributeIndex(e);this.attributes.position.setValues(u,t,n,r),this._setUV(u,i,a),this._setNormal(u,o,s,l)}}]),e}(),zm=(0,Kn.U$)().vec3f(tr.T.POSITION).vec2i16(tr.T.UV0).vec2i16(tr.T.NORMALCOMPRESSED,{glNormalized:!0}),Bm=new Um((function(e){return zm.createBuffer(e)}),(function(e){return e.count}));function Gm(e){return Bm.acquire(e)}function Wm(e,t,n,r,i){var a=1/(Math.abs(n)+Math.abs(r)+Math.abs(i)),o=n*a,s=r*a,l=i<=0?(o>=0?1:-1)*(1-Math.abs(s)):o,u=i<=0?(s>=0?1:-1)*(1-Math.abs(o)):s;e.setValues(t,qm(l),qm(u))}function jm(e,t,n,r){e.setValues(t,16384*n,16384*r)}function qm(e){return(0,Se.uZ)(Math.round(32767*e),-32767,32767)}function Ym(e){return(0,Se.uZ)(e/32767,-1,1)}function Xm(e,t,n,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),n<r[2]?r[2]=n:n>r[5]&&(r[5]=n)}var Qm,Jm=function(){function e(){(0,s.Z)(this,e),this.sinLonLUT=new Array(re.HB+1),this.cosLonLUT=new Array(re.HB+1),this.sinLatLUT=new Array(re.HB+1),this.cosLatLUT=new Array(re.HB+1)}return(0,l.Z)(e,[{key:"update",value:function(e,t,n){for(var r=t[0],i=t[2],a=0;a<=e;a++){var o=a/e,s=r*(1-o)+i*o;this.sinLonLUT[a]=Math.sin(s),this.cosLonLUT[a]=Math.cos(s);var l=n(o);this.sinLatLUT[a]=Math.sin(l),this.cosLatLUT[a]=Math.cos(l)}}}]),e}(),Km=(0,l.Z)((function e(){(0,s.Z)(this,e),this.cornerTiles=[null,null,null,null],this.cornerTileSamplerVersions=[-1,-1,-1,-1]})),$m=(0,l.Z)((function e(){(0,s.Z)(this,e),this.cornerNeighborData=[new Km,new Km,new Km,new Km],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1],this.cornerPeerNeighbors=[null,null,null,null]})),e_=(0,l.Z)((function e(){(0,s.Z)(this,e),this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.shading=!1,this.samplerDataVersion=0,this.neighborData=new $m})),t_=function(){function e(t){(0,s.Z)(this,e),this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}return(0,l.Z)(e,[{key:"clear",value:function(){this._current=(0,k.SC)(this._current),this._next=(0,k.SC)(this._next),this._waiting=(0,k.SC)(this._waiting),this._delayed=(0,k.SC)(this._delayed)}},{key:"current",get:function(){if((0,k.Wi)(this._current))return null;if(!this._isFadingEnabled){var t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}var n=e.test.fadeMoment;if((0,k.pC)(this._delayed)&&((n=n||performance.now())>=this._delayedTime&&(this._push(this._delayed,Qm.Immediate),this._delayed=null)),(0,k.pC)(this._next)){n=n||performance.now();var r=this._fadeDuration,i=(0,k.pC)(this._current)&&this._next.texture===this._current.texture,a=this._next.type!==Cm.Ns.FADING,o=n-this._fadeStart>=r;(i||a||o)&&((0,k.SC)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(n))}return this._current}},{key:"next",get:function(){return this._next}},{key:"fadeFactor",get:function(){if((0,k.Wi)(this._next))return 1;var t=e.test.fadeMoment||performance.now(),n=Math.max(0,t-this._fadeStart),r=this._fadeDuration;return n>r?0:1-n/r}},{key:"isFading",get:function(){return(0,k.pC)(this._next)||(0,k.pC)(this._delayed)}},{key:"push",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qm.Immediate;this._delayed=(0,k.SC)(this._delayed),this._push(e,t)}},{key:"_push",value:function(t,n){if(this._isFadingEnabled||this.clear(),!(0,k.Wi)(this._current)){var r=e.test.fadeMoment||performance.now();return n!==Qm.Immediate?(this._delayed=t,void(this._delayedTime=r+n)):(0,k.Wi)(this._next)?(this._next=t,void(this._fadeStart=this._alignFadeStart(r))):void((0,k.Wi)(t)||((0,k.SC)(this._waiting),this._waiting=t))}this._current=t}},{key:"_fadeDuration",get:function(){return(0,k.Wi)(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}},{key:"_alignFadeStart",value:function(e){var t=this._getFadeDuration();return e+t-e%t}},{key:"_isFadingEnabled",get:function(){return this._getFadeDuration()>0}}]),e}();t_.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(Qm||(Qm={}));var n_=n(5647),r_=n(26277),i_=n(36734),a_=function(){function e(){(0,s.Z)(this,e)}return(0,l.Z)(e,[{key:"updating",get:function(){return!!this._tileRequested}},{key:"init",value:function(e,t,n,r){this.tile=e,this._layerIdx=t,this._layerClass=n,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,n),this._tileRequested=null;var i=this._findAncestorWithData();this._setUpsampleTile(i)}},{key:"startLoading",value:function(){return this._requestNext()}},{key:"dispose",value:function(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}},{key:"setSuspension",value:function(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}},{key:"update",value:function(){var e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}},{key:"dataArrived",value:function(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,Cm.Ns.FADING):this._requestNext()}},{key:"dataMissing",value:function(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}},{key:"_agentDone",value:function(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}},{key:"_requestNext",value:function(){if(this._suspended)return!0;var e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return(0,k.pC)(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}},{key:"_findNextDownload",value:function(){for(var e,t=this._layerIdx,n=this._layerClass,r=this.tile.surface.layerViewByIndex(t,n),i=(0,hv.RB)(r),a=r.dataLevelRange,o=a.minLevel,s=a.maxLevel,l=this._desiredMinLevelDelta,u=this._progressiveLevelModulo+l,c=this._scaleRangeEnabled?i_.yf:function(){return!0},h=this.tile,d=h.level,f=this._tileLayerInfo.upsampleInfo,p=(0,k.pC)(f)?f.tile.level:-1,v=!!(0,k.pC)(f)&&p-d>=l,m=(0,k.U2)(i,"tilemapCache");h&&c(h,i,!1)&&h.level>=o;){var _=h.level,y=d-_,g=h.layerInfo[n][t];if(g.data&&y>=l){(!v||_>p)&&this._setUpsampleTile(h),g.dataInvalidated&&(e=h);break}if(((0,k.Wi)(m)||"unavailable"!==m.getAvailability(h.lij[0],h.lij[1],h.lij[2]))&&_<=s&&!g.data&&!g.dataMissing&&(((0,k.Wi)(e)||h.level===o||_%re.Sx==0||d-e.level<l)&&(e=h),y>=u))break;h=h.parent}return(0,k.pC)(e)&&d-e.level<l&&this._tileLayerInfo.upsampleInfo&&(e=null),e}},{key:"_findAncestorWithData",value:function(){for(var e,t=this.tile.vlevel,n=this._desiredMinLevelDelta,r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(t-r.level>=n)return r;e=r}return e}},{key:"_setUpsampleTile",value:function(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,Cm.Ns.FADING)}},{key:"test",get:function(){var e=this;return{findNextDownload:function(){return e._findNextDownload()},tileLayerInfo:this._tileLayerInfo}}}]),e}(),o_=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"_desiredMinLevelDelta",get:function(){throw s_}},{key:"_progressiveLevelModulo",get:function(){throw s_}},{key:"dispose",value:function(){}}]),n}(a_),s_=new Error("Abstract method called on TileAgent"),l_=new o_,u_=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._scaleRangeEnabled=!1,e}return(0,l.Z)(n,[{key:"_desiredMinLevelDelta",get:function(){return(0,re.L)(this.tile.level)-(this.tile.vlevel-this.tile.level)}},{key:"_progressiveLevelModulo",get:function(){return 0}}]),n}(a_),c_=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.call(this))._scaleRangeEnabled=!0,e}return(0,l.Z)(n,[{key:"_desiredMinLevelDelta",get:function(){return 0}},{key:"_progressiveLevelModulo",get:function(){return re.Sx}}]),n}(a_),h_=n(64153),d_=function(){function e(){(0,s.Z)(this,e),this.waitingAgents=new Qd.Z,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}return(0,l.Z)(e,[{key:"release",value:function(){this.dispose(),p_.delete(this),f_.release(this)}},{key:"dispose",value:function(){this.loadingAgent=(0,k.M2)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=(0,hv.z4)(this._data)}},{key:"_init",value:function(e){this.waitingAgents.clear(),this._data=(0,hv.z4)(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}},{key:"invalidateSourceData",value:function(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}},{key:"abortRequest",value:function(){this.requestAbort=(0,k.IM)(this.requestAbort),this.requestPromise=null}},{key:"upsampleInfo",get:function(){return this._upsampleInfo}},{key:"_unsetUpsampleInfo",value:function(){(0,k.pC)(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}},{key:"setUpsampleInfo",value:function(e,t){if(e===t||(0,k.Wi)(t))this._unsetUpsampleInfo();else{if((0,k.Wi)(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),(0,i_.QT)(e,t,this._upsampleInfo)}}},{key:"data",get:function(){return this._data},set:function(e){(0,hv.z4)(this._data),this._data=e}}],[{key:"acquire",value:function(e){var t=f_.acquire();return t._init(e),t}},{key:"prune",value:function(){f_.prune(0)}}]),e}(),f_=new zf.Z(d_,null,(function(){})),p_=new Map;var v_,m_=function(){function e(t){(0,s.Z)(this,e),this._texture=t,this.type="tile-texture",this._refCount=1}return(0,l.Z)(e,[{key:"retain",value:function(){++this._refCount}},{key:"release",value:function(){--this._refCount,0===this._refCount&&this._texture.dispose()}},{key:"texture",get:function(){return this._texture}},{key:"generateMipmap",value:function(){this._texture.generateMipmap()}},{key:"descriptor",get:function(){return this._texture.descriptor}}]),e}();!function(e){e[e.NONE=0]="NONE",e[e.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",e[e.SPLIT=2]="SPLIT",e[e.VSPLITMERGE=4]="VSPLITMERGE",e[e.MERGE=8]="MERGE",e[e.RENDERDATA=16]="RENDERDATA",e[e.GEOMETRY=32]="GEOMETRY",e[e.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=128]="TEXTURE_FADING"}(v_||(v_={}));var __=(0,F.c)(),y_=(0,F.c)(),g_=(0,F.c)(),b_=function(){function e(){(0,s.Z)(this,e),this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,z.Ue)(),this._elevationBounds=(0,Jt.a)(),this.layerInfo=[[],[]],this.extentInRadians=(0,z.Ue)(),this.centerAtSeaLevel=(0,F.c)(),this._center=[(0,F.c)(),(0,ea.c)(),(0,F.c)()],this.up=(0,F.u)(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=(0,F.c)()}return(0,l.Z)(e,[{key:"_isCached",get:function(){return!this.shouldLoad&&this._mapDataRefCount<=0}},{key:"maxTesselation",get:function(){return this._maxTesselation}},{key:"isWithinClippingArea",get:function(){return this._isWithinClippingArea}},{key:"intersectsClippingArea",get:function(){return this._intersectsClippingArea}},{key:"clippingArea",get:function(){return this._clippingArea}},{key:"parent",get:function(){return this._parent}},{key:"children",get:function(){return this._children}},{key:"surface",get:function(){return this._surface}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"level",get:function(){return this.lij[0]}},{key:"key",get:function(){return"".concat(this.lij[0],"/").concat(this.lij[1],"/").concat(this.lij[2])}},{key:"edgeLen",get:function(){return this._edgeLen}},{key:"radius",get:function(){return this._center[x_.MIDDLE][3]}},{key:"visible",get:function(){return this._dirty&&this.computeVisibility(),this._visible}},{key:"frustumVisibility",get:function(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}},{key:"computeVisibility",value:function(){var e,t;this._dirty=!1;var n=null!==(e=null===(t=this.parent)||void 0===t?void 0:t.frustumVisibility)&&void 0!==e?e:Cm.ir.INTERSECTS;this._frustumVisibility=n===Cm.ir.INSIDE?Cm.ir.INSIDE:n===Cm.ir.OUTSIDE?Cm.ir.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);var r=this._frustumVisibility!==Cm.ir.OUTSIDE&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}},{key:"loadable",get:function(){return this.visible||this._surface.view.state.fixedContentCamera}},{key:"rendered",get:function(){var e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}},{key:"shouldLoad",get:function(){var e=this._surface.snapLevel;if((0,k.pC)(e)){var t=this.level-e;if(0===t)return!0;if(1===t)return!1}return this.isLeaf}},{key:"init",value:function(e,t,n){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=(0,qt.Iu)(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[x_.MIDDLE][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?(0,Yt.c)(this._elevationBounds,t.elevationBounds):(0,Yt.s)(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=n,this.updateVisibility();var r,a=(0,i.Z)(xm);try{for(a.s();!(r=a.n()).done;){var o,s=r.value,l=n.numLayers(s),u=this.layerInfo[s],c=(0,i.Z)(u);try{for(c.s();!(o=c.n()).done;){o.value.release()}}catch(d){c.e(d)}finally{c.f()}u.length=l;for(var h=0;h<l;h++)u[h]=d_.acquire(this._surface.upsampleInfoPool),s===wm.ELEVATION&&this.findElevationBoundsForLayer(h,-1)}}catch(d){a.e(d)}finally{a.f()}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,re.HB)}},{key:"release",value:function(){(0,hv.wu)(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);var e,t=(0,i.Z)(xm);try{for(t.s();!(e=t.n()).done;){var n,r=e.value,a=(0,i.Z)(this.layerInfo[r]);try{for(a.s();!(n=a.n()).done;){n.value.release()}}catch(s){a.e(s)}finally{a.f()}this.layerInfo[r].length=0}}catch(s){t.e(s)}finally{t.f()}this._parent=null;for(var o=0;o<4;++o)this._children[o]=null;this._surface=null,this.setMemoryDirty()}},{key:"refMapData",value:function(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}},{key:"unrefMapData",value:function(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();var e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}},{key:"setMemoryDirty",value:function(){this._usedMemory=null}},{key:"usedMemory",get:function(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}},{key:"_cachedMemory",get:function(){return this._isCached?this._mapTileMemory:0}},{key:"_mapTileMemory",get:function(){return this._ensureUsedMemory(),this.layerInfo[wm.MAP].reduce((function(e,t){return e+(t instanceof cm.i?t.memoryUsage:0)}),this._mapTileMemoryInternal)}},{key:"_cpuImageMemorySize",get:function(){var e=this._surface.tilingScheme.pixelSize;return e*e*4}},{key:"_ensureUsedMemory",value:function(){if((0,k.pC)(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;var e,t=0,n=(0,i.Z)(this.layerInfo[wm.MAP]);try{for(n.s();!(e=n.n()).done;){var r=e.value.data;r instanceof cm.i?t+=this._getTerrainDataMemory(r):this._mapTileMemoryInternal+=this._getTerrainDataMemory(r)}}catch(u){n.e(u)}finally{n.f()}var a,o=this._cpuImageMemorySize,s=(0,i.Z)(this.layerInfo[wm.ELEVATION]);try{for(s.s();!(a=s.n()).done;){var l=a.value;this._usedMemory+=l.data?o:0}}catch(u){s.e(u)}finally{s.f()}return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=(0,ir.un)(this.renderData.textureDescriptor)),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+t),this._usedMemory}},{key:"getUsedMemoryForLayer",value:function(e,t){var n=this.layerInfo[e][t];return null!==n&&void 0!==n&&n.data?e===wm.MAP?this._isCached?0:this._getTerrainDataMemory(n.data):e===wm.ELEVATION?this._cpuImageMemorySize:0:0}},{key:"_getTerrainDataMemory",value:function(e){return e instanceof m_?(0,ir.un)(e.texture):e instanceof HTMLImageElement||e instanceof sv.nN?this._cpuImageMemorySize:e instanceof cm.i||e instanceof h_.H?e.memoryUsage:0}},{key:"updateScreenDepth",value:function(e){var t=this._center[x_.MIDDLE],n=e,r=t[0],i=t[1],a=t[2],o=n[2]*r+n[6]*i+n[10]*a+n[14];this.screenDepth=o<0?0:o/(n[3]*r+n[7]*i+n[11]*a+n[15])}},{key:"shouldSplit",value:function(e,t,n){var r=this;if(!this.visible)return v_.NONE;if((0,k.pC)(e.frustum)&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===Cm.ir.OUTSIDE))return v_.NONE;var i=this.level;(0,Gt.b)(__,this._center[x_.MIDDLE],t);var a=(0,Gt.p)(__),o=x_.MIDDLE;(0,Gt.b)(y_,this._center[x_.TOP],t);var s=(0,Gt.p)(y_);s<a&&(a=s,o=x_.TOP),(0,Gt.b)(y_,this._center[x_.BOTTOM],t);var l=(0,Gt.p)(y_);if(l<a&&(a=l,o=x_.BOTTOM),this._edgeLen2>a&&i<e.maxLod)return v_.SPLIT;var u=Math.sqrt(a),c=e.fovX*u*2,h=this._edgeLen/c,d=function(){var t=i+Math.ceil(-Math.log2(e.relativeWidthLimit/h));return t!==r.vlevel?(r.vlevel=t,v_.VSPLITMERGE):v_.NONE_HIT_MAXLOD};if((0,k.pC)(n)&&1===n-i)return i>=e.maxLod?d():v_.SPLIT;var f=(0,Gt.e)(this.up,__),p=this._elevationBounds[1]-this._elevationBounds[0],v=p/this.edgeLen;if(e.aboveGround&&f>0&&v<.001&&f/u-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-v>0)return v_.NONE;if(h<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,v_.VSPLITMERGE):v_.NONE;if(i>=e.maxLod)return d();if(i>6){(0,Gt.b)(y_,this._center[o],t),(0,Gt.g)(g_,this.up,f),(0,Gt.b)(g_,g_,y_);var m=(0,Gt.p)(g_);if(m>this.radius*this.radius){(0,Gt.g)(g_,g_,this.radius/Math.sqrt(m)),(0,Gt.a)(g_,g_,this._center[o]),(0,Gt.b)(g_,t,g_);var _=Math.min(1,(Math.abs((0,Gt.e)(g_,this.up))+.5*p+this._curvatureHeight)/(0,Gt.l)(g_)),y=.1/e.angledSplitBias,g=e.fovY*u*2;if(_*(this._edgeLen/g)<y*e.relativeHeightLimit)return v_.NONE}}return v_.SPLIT}},{key:"setChildren",value:function(e,t,n,r){(0,hv.wu)(!!(e&&t&&n&&r),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=n,this._children[3]=r}},{key:"unsetChildren",value:function(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}},{key:"isLoaded",get:function(){var e,t;return null!==(e=null===(t=this.renderData)||void 0===t?void 0:t.hasGeometry)&&void 0!==e&&e}},{key:"load",value:function(){this.refMapData();var e,t=(0,i.Z)(xm);try{for(t.s();!(e=t.n()).done;){var n=e.value;this._createOrUpdateAgents(0,n)}}catch(r){t.e(r)}finally{t.f()}this.surface.renderer.loadTile(this)}},{key:"unload",value:function(e){e.unloadTile(this);var t,n=(0,i.Z)(xm);try{for(n.s();!(t=n.n()).done;){var r,a=t.value,o=this.layerInfo[a],s=(0,i.Z)(o);try{for(s.s();!(r=s.n()).done;){var l=r.value;l.loadingAgent&&l.loadingAgent!==l_&&(C_(l.loadingAgent),l.loadingAgent=null),l.pendingUpdates=0}}catch(u){s.e(u)}finally{s.f()}}}catch(u){n.e(u)}finally{n.f()}this.resetPendingUpdate(v_.GEOMETRY),this.resetPendingUpdate(v_.TEXTURE_NOFADING),this.resetPendingUpdate(v_.TEXTURE_FADING),this.unrefMapData()}},{key:"unloadMapData",value:function(){var e,t=this.layerInfo[wm.MAP],n=(0,i.Z)(t);try{for(n.s();!(e=n.n()).done;){var r=e.value;r.loadingAgent&&r.loadingAgent!==l_&&(C_(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}}catch(a){n.e(a)}finally{n.f()}this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}},{key:"updateClippingStatus",value:function(e){if((0,z.fS)(e,this._clippingArea))return!1;var t=this._intersectsClippingArea,n=this._isWithinClippingArea;(0,k.pC)(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();var r=n&&this._isWithinClippingArea,i=!(n||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||i||this.setPendingUpdate(v_.GEOMETRY),!0}},{key:"updateVisibility",value:function(){this._dirty=!0,this._surface.setTileTreeDirty()}},{key:"getLayerInfo",value:function(e,t){return this.layerInfo[t][e]}},{key:"hasLayerData",value:function(e,t){var n=this.layerInfo[t][e];return!(!n||!n.data||n.dataInvalidated)}},{key:"updating",get:function(){if(this.hasPendingUpdates)return!0;var e,t=(0,i.Z)(xm);try{for(t.s();!(e=t.n()).done;){var n,r=e.value,a=this.layerInfo[r],o=(0,i.Z)(a);try{for(o.s();!(n=o.n()).done;){var s=n.value;if(s.loadingAgent&&s.loadingAgent!==l_&&s.loadingAgent.updating)return!0}}catch(l){o.e(l)}finally{o.f()}}}catch(l){t.e(l)}finally{t.f()}return!1}},{key:"_isSuspended",value:function(e){return!!this.hasPendingUpdate(v_.SPLIT)||e!==wm.ELEVATION&&!this.loadable}},{key:"hasPendingUpdates",get:function(){return 0!==this._pendingUpdates}},{key:"hasPendingUpdate",value:function(e){return(this._pendingUpdates&e)===e}},{key:"setPendingUpdate",value:function(e){this._pendingUpdates|=e,e===v_.SPLIT||e===v_.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}},{key:"resetPendingUpdate",value:function(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}},{key:"requestLayerData",value:function(e,t,n){var r=this.layerInfo[t][e];if(r.waitingAgents.has(n))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(n),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),n.dataArrived(this),!0;if(r.requestPromise)return!0;(0,k.IM)(r.requestAbort),r.requestAbort=new AbortController;var i=this._surface.requestTileData(this,e,t,r.requestAbort);if(!i)return r.requestAbort=null,!1;var a=function(){r.requestPromise===i&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=i,i.then(a,a),!0}},{key:"isLeaf",get:function(){return null==this._children[0]}},{key:"hasLij",value:function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}},{key:"findByLij",value:function(e){if(this.hasLij(e))return this;var t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}},{key:"distanceToSquared",value:function(e){return(0,Gt.p)((0,Gt.b)(g_,this._center[x_.MIDDLE],e))}},{key:"containsPoint",value:function(e){var t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}},{key:"containsPointXY",value:function(e,t){var n=this.extent;return e>=n[0]&&t>=n[1]&&e<=n[2]&&t<=n[3]}},{key:"unrequestLayerData",value:function(e,t,n){var r=this.layerInfo[t][e],i=r.waitingAgents,a=null!=i.removeUnordered(n);(0,hv.wu)(a,"agent has not requested this piece of map data"),i.length<1&&(r.abortRequest(),this.setMemoryDirty())}},{key:"dataArrived",value:function(e,t,n){var r=this,i=this.layerInfo[t][e];i.data=n,i.dataInvalidated=!1,i.waitingAgents.forAll((function(e){return e.dataArrived(r)})),i.waitingAgents.clear(),this.setMemoryDirty()}},{key:"dataMissing",value:function(e,t,n){n.notInTilemap||console.error("Tile ".concat(this.lij.toString()," layer ").concat(t,"/").concat(e," error ").concat(n));var r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll((function(e){return e.dataMissing()})),r.waitingAgents.clear(),this.setMemoryDirty()}},{key:"updateRenderData",value:function(e,t){switch(e){case wm.MAP:return this._updateTexture(t);case wm.ELEVATION:return this._updateGeometry()}}},{key:"_updateTexture",value:function(e){this.renderData&&(this.resetPendingUpdate(e===Cm.Ns.FADING?v_.TEXTURE_NOFADING:v_.TEXTURE_FADING),this.setPendingUpdate(e===Cm.Ns.FADING?v_.TEXTURE_FADING:v_.TEXTURE_NOFADING))}},{key:"_updateGeometry",value:function(){this.setPendingUpdate(v_.GEOMETRY);var e,t=(0,i.Z)(this.layerInfo[wm.ELEVATION]);try{for(t.s();!(e=t.n()).done;){e.value.pendingUpdates|=v_.GEOMETRY}}catch(n){t.e(n)}finally{t.f()}}},{key:"invalidateLayerData",value:function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}},{key:"computeElevationBounds",value:function(){var e=this._elevationBounds,t=e[0],n=e[1];(0,Yt.s)(e,1/0,-1/0);var r,a=this.layerInfo[wm.ELEVATION],o=!0,s=(0,i.Z)(a);try{for(s.s();!(r=s.n()).done;){var l=r.value;(0,k.pC)(l.elevationBounds)&&(e[0]=Math.min(e[0],l.elevationBounds.min),e[1]=Math.max(e[1],l.elevationBounds.max),l.elevationBounds.hasNoDataValues||(o=!1))}}catch(u){s.e(u)}finally{s.f()}o&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),t===e[0]&&n===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}},{key:"_updateCenter",value:function(){var e=this._elevationBounds,t=.5*(e[0]+e[1]),n=this._center;(0,Gt.g)(g_,this.up,t),(0,Gt.a)(n[x_.MIDDLE],this.centerAtSeaLevel,g_),(0,Gt.g)(g_,this.up,e[0]),(0,Gt.a)(n[x_.TOP],this.centerAtSeaLevel,g_),(0,Gt.g)(g_,this.up,e[1]),(0,Gt.a)(n[x_.BOTTOM],this.centerAtSeaLevel,g_)}},{key:"findElevationBoundsForLayer",value:function(e,t){var n=this.layerInfo[wm.ELEVATION][e],r=(0,re.L)(this.level),i=Math.max(this.vlevel-r,0),a=n.elevationBounds;if(!((0,k.pC)(a)&&a.level>=t&&a.level<=i)){var o=this._surface.layerViewByIndex(e,wm.ELEVATION),s=(0,hv.RB)(o);if((0,i_.yf)(this,s,!1)){var l=k_,u=!1,c=n.data;if(c&&c.level<=i){var h=n.data;l.min=h.samplerData.data.minValue,l.max=h.samplerData.data.maxValue,l.hasNoDataValues=h.samplerData.data.hasNoDataValues,l.level=this.level,u=!0}else{for(var d,f,p=0,v=this._parent;v&&(!f||p<r)&&(p=this.vlevel-v.level,d=f||d,!(!(f=v.layerInfo[wm.ELEVATION][e].data)&&d&&v.level<=i));v=v.parent);(f=f||d)&&(f.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],l),l.min!==1/0&&(l.level=f.level,u=!0))}u&&((0,k.Wi)(n.elevationBounds)&&(n.elevationBounds=new dm),n.elevationBounds.copyFrom(l))}}}},{key:"modifyLayers",value:function(e,t,n){var r,a=this.layerInfo[n],o=(0,i.Z)(a);try{for(o.s();!(r=o.n()).done;){var s=r.value;s.loadingAgent&&s.loadingAgent!==l_&&(C_(s.loadingAgent),s.loadingAgent=null),s.waitingAgents.clear()}}catch(f){o.e(f)}finally{o.f()}for(var l=0;l<a.length;++l)void 0===e[l]&&a[l].release();var u=(0,n_.Z)(Array,(0,Uf.Z)(a)),c=t.length;a.length=c;for(var h=0;h<c;h++){var d=t[h];a[h]=d>-1?u[d]:d_.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}},{key:"restartAgents",value:function(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,Cm.Ns.FADING))}},{key:"updateAgents",value:function(e){if(this.renderData){var t,n=this.layerInfo[e],r=(0,i.Z)(n);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.loadingAgent===l_&&(a.loadingAgent=null)}}catch(o){r.e(o)}finally{r.f()}this._createOrUpdateAgents(0,e)}}},{key:"updateAgentSuspension",value:function(){var e,t=(0,i.Z)(xm);try{for(t.s();!(e=t.n()).done;){var n,r=e.value,a=this._isSuspended(r),o=(0,i.Z)(this.layerInfo[r]);try{for(o.s();!(n=o.n()).done;){var s=n.value;s.loadingAgent&&s.loadingAgent!==l_&&(s.loadingAgent.setSuspension(a),s.loadingAgent===l_&&this.updateRenderData(r,Cm.Ns.FADING))}}catch(l){o.e(l)}finally{o.f()}}}catch(l){t.e(l)}finally{t.f()}}},{key:"removeLayerAgent",value:function(e,t){var n=this.layerInfo[t][e];n.loadingAgent&&n.loadingAgent!==l_&&n.loadingAgent.dispose(),n.loadingAgent=null}},{key:"agentDone",value:function(e,t){var n=this.layerInfo[t][e];n.loadingAgent=l_,!n.data&&(0,k.Wi)(n.upsampleInfo)&&this._createOrUpdateAgents(e+1,t)}},{key:"_hasBlendableAncestor",value:function(e){return"normal"!==e.blendMode||(0,q.CY)(e.parent)&&this._hasBlendableAncestor(e.parent)}},{key:"_hasBlendModes",value:function(e,t,n){for(var r=e;r<t;++r){var i,a,o,s=this._surface.layerViewByIndex(r,n);if((0,hv.TK)(s)&&"normal"!==(null===s||void 0===s||null===(i=s.layer)||void 0===i?void 0:i.blendMode)||(0,q.CY)(null===s||void 0===s||null===(a=s.layer)||void 0===a?void 0:a.parent)&&this._hasBlendableAncestor(null===s||void 0===s||null===(o=s.layer)||void 0===o?void 0:o.parent))return!0}return!1}},{key:"_createOrUpdateAgents",value:function(e,t){var n=this.layerInfo[t];if(0!==n.length)for(var r=this._isSuspended(t),i=e;i<n.length;++i){var a=n[i],o=!1,s=this._surface.layerViewByIndex(i,t),l=(0,hv.RB)(s);if(a.loadingAgent?(0,i_.yf)(this,l,!1)?(a.loadingAgent!==l_&&a.loadingAgent.setSuspension(r),a.loadingAgent!==l_&&(o=a.loadingAgent.update())):a.dispose():(0,i_.yf)(this,l,!1)&&(a.loadingAgent=w_(this,i,t,r),(o=a.loadingAgent.startLoading())?a.loadingAgent===l_&&this.setPendingUpdate(v_.GEOMETRY):(C_(a.loadingAgent),a.loadingAgent=l_)),a.loadingAgent===l_&&this.updateRenderData(t,Cm.Ns.FADING),!this._hasBlendModes(e,n.length,t)&&o&&s.isOpaque)return}}},{key:"_isWithinExtent",value:function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}},{key:"intersectsExtent",value:function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}},{key:"getElevationVerticesPerSide",value:function(e){var t=this.vlevel-this.level,n=Math.max(this.level-e,(0,re.L)(this.level)-t),r=(0,Se.uZ)(1+(this.maxTesselation>>n),2,this.maxTesselation+1),i=this.getDefaultVerticesPerSide();return Math.max(r,i)}},{key:"test",get:function(){return{cachedMemory:this._cachedMemory}}},{key:"_findLIJ",value:function(e,t){if(!e)return null;var n=this.surface.rootTiles;if((0,k.pC)(n)){var r,a=(0,i.Z)(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(P_(o,e)){for(var s=o,l=e[0]-s.level-1;l>=0&&!s.isLeaf&&!t(s);){var u=e[1]>>l&1,c=e[2]>>l&1;s=s.children[2*u+c],l--}return t(s)?s:null}}}catch(h){a.e(h)}finally{a.f()}}return null}},{key:"findNeighborTile",value:function(e,t){var n=this.lij,r=this.getNeighborLIJ(n,e);return r?function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}(n,r)?t(this)?this:null:this._findLIJ(r,t):null}},{key:"findCorner",value:function(e,t){for(var n=e===Cm.Xo.NORTH_EAST?1:e===Cm.Xo.NORTH_WEST?0:e===Cm.Xo.SOUTH_WEST?2:3,r=this;r.children[0]&&(!t||!t(r));)r=r.children[n];return r}},{key:"findNeighborCornerTileExact",value:function(e,t){var n,r=this;return(null===(n=this.findNeighborTile(e,(function(e){return t(e)||e.level===r.level})))||void 0===n?void 0:n.findCorner((0,hv.$v)(e),t))||null}},{key:"forAllSubtreeOnSide",value:function(e,t){var n=e===Cm.Xo.NORTH?[0,1]:e===Cm.Xo.NORTH_EAST?[1]:e===Cm.Xo.EAST?[1,3]:e===Cm.Xo.SOUTH_EAST?[3]:e===Cm.Xo.SOUTH?[2,3]:e===Cm.Xo.SOUTH_WEST?[2]:e===Cm.Xo.WEST?[0,2]:[0];!function e(r){var i=r.children;!t(r)&&i[0]&&n.forEach((function(t){return e(i[t])}))}(this)}},{key:"forallNeighbors",value:function(e){var t=this;hv.cA.forEach((function(n){return t.findNeighborCornerTileExact(n,e)})),hv.OC.forEach((function(n){var r;return null===(r=t.findNeighborTile(n,(function(n){return n.level===t.level||e(n)})))||void 0===r?void 0:r.forAllSubtreeOnSide((0,hv._F)(n),e)}))}},{key:"getNeighborEdgeStartVertexIndex",value:function(e,t){if(!t)return 0;var n=this.level-t.level;if((0,hv.Fp)(!hv.jt||n>=0),0===n)return 0;var r=Math.pow(2,n),i=1==(1&e),a=i?0:1,o=t.lij[a+1]*r,s=this.lij[a+1],l=s-o,u=i?r-1-l:l;return hv.jt&&((0,hv.Fp)(o<=s&&s<o+r),(0,hv.Fp)(0<=u&&u<r)),u}},{key:"forEachLoadedNeighbor",value:function(e){var t=this,n=this.level,r=function(e){return e.level===n||e.isLoaded};hv.OC.forEach((function(n){var i=t.findNeighborTile(n,r);null!=i&&i!==t&&i.forAllSubtreeOnSide((0,hv._F)(n),(function(t){return!!t.isLoaded&&(e(t,n),!0)}))})),hv.cA.forEach((function(n){var i,a=null===(i=t.findNeighborTile(n,r))||void 0===i?void 0:i.findCorner((0,hv.$v)(n),(function(e){return e.isLoaded}));(0,hv.Fp)(!a||R_(t,a,n)),(null===a||void 0===a?void 0:a.isLoaded)&&e(a,n)}))}},{key:"getNeighborLIJ",value:function(e,t){var n=(0,hv.Mw)(t)?-1:(0,hv.uv)(t)?1:0,r=(0,hv.OD)(t)?-1:(0,hv.Eu)(t)?1:0,i=[e[0],e[1]+n,e[2]+r];return i[1]<0?null:this.surface.isGlobal?this.wrapLIJ(i):i[2]<0?null:i}},{key:"wrapLIJ",value:function(e){return!e||e[1]<0||e[1]>=Math.pow(2,e[0])?null:this.surface.wrapEastWest(e)}},{key:"westNeighborWestExtent",get:function(){return this.extent[0]*(this.isWestEnd?-1:1)}},{key:"eastNeighborEastExtent",get:function(){return this.extent[2]*(this.isEastEnd?-1:1)}},{key:"isEastEnd",get:function(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}},{key:"isWestEnd",get:function(){return 0===this.lij[2]}},{key:"isNorthEnd",get:function(){return 0===this.lij[1]}},{key:"isSouthEnd",get:function(){return this.extent[1]+(0,r_.g)()>=this.surface.extent[1]}},{key:"checkGeometryWaterproofness",value:function(){var e;hv.XJ&&((0,hv.Fp)(this.isLoaded),null===(e=this.renderData)||void 0===e||e.checkGeometryWaterproofness())}},{key:"shouldHaveNeighbor",value:function(e){var t=this.extent,n=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if((0,hv.Mw)(e)&&t[3]+r>=n[3])return!1;if((0,hv.uv)(e)&&t[1]-r<=n[1])return!1;var i=this.surface.isGlobal;return!(!i&&(0,hv.OD)(e)&&t[0]-r<=n[0])&&!(!i&&(0,hv.Eu)(e)&&t[2]+r>=n[2])}},{key:"updateDistanceToPOI",value:function(e){var t=this._lastPOI;if(!(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])){(0,Gt.c)(this._lastPOI,e);var n=this._center[x_.MIDDLE],r=e[0]-n[0],i=e[1]-n[1],a=e[2]-n[2];this.distanceToPOI=r*r+i*i+a*a}}}],[{key:"prune",value:function(){T_.prune(0),S_.prune(0),d_.prune()}}]),e}();function w_(e,t,n,r){var i=n===wm.ELEVATION?S_.acquire():T_.acquire();return i.init(e,t,n,r),i}function C_(e){e.dispose(),e instanceof u_?S_.release(e):e instanceof c_&&T_.release(e)}var x_,T_=new zf.Z(c_),S_=new zf.Z(u_),k_=new dm;function P_(e,t){var n=e.level,r=t[0];if(n>r)return!1;var i=r-n,a=Math.floor(t[1]/Math.pow(2,i)),o=Math.floor(t[2]/Math.pow(2,i));return a===e.lij[1]&&o===e.lij[2]}function R_(e,t,n){return!(0,k.Wi)(e)&&!(0,k.Wi)(t)&&t!==e&&(e.level>=t.level?A_(e,t,n):A_(t,e,(0,hv.$v)(n)))}function A_(e,t,n){(0,hv.Fp)(e.level>=t.level);var r=(0,hv._0)(n),i=(0,hv.wt)(n),a=e.extent,o=t.extent,s=[r?a[0]:a[2],i?a[3]:a[1]],l=[r?o[2]:o[0],i?o[1]:o[3]],u=1e-5*(a[2]-a[0]),c=(0,hv.Wq)(s[0],l[0],u)||e.surface.isGlobal&&(0,hv.Wq)(s[0],-l[0],u),h=(0,hv.Wq)(s[1],l[1],u);if(c&&h)return!0;if(e.level===t.level)return(0,hv.Fp)(!1),!1;if(!c&&!h)return(0,hv.Fp)(!1),!1;var d=c?E_(o[1],o[3],a[1],a[3],u):E_(o[0],o[2],a[0],a[2],u);return(0,hv.Fp)(d),d}function E_(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,r_.g)();return e-i<=n&&n<=r&&r<=t+i}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(x_||(x_={}));var O_=function(){function e(){(0,s.Z)(this,e),this._scales=(0,Wt.f)(-1,-1,-1,-1),this._offsets=(0,Wt.f)(-1,-1,-1,-1)}return(0,l.Z)(e,[{key:"clear",value:function(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}},{key:"setScale",value:function(e,t,n){this._scales[2*e]=t,this._scales[2*e+1]=n}},{key:"setOffset",value:function(e,t,n){this._offsets[2*e]=t,this._offsets[2*e+1]=n}},{key:"scales",get:function(){return this._scales}},{key:"offsets",get:function(){return this._offsets}}]),e}(),M_=n(89438),Z_=n(50411),I_=n(49800),D_=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).useStencil=!1,e}return(0,l.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===I_.zO.WEBGL2,t.spherical=e.viewingMode===he.JY.Global}},{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),L_)}},{key:"initializePipeline",value:function(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}},{key:"_createPipeline",value:function(e){var t=this.configuration,n=t.backfaceCullingEnabled&&!t.renderOccluded;return(0,on.sm)({blending:t.renderOccluded?(0,on.if)(an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA):null,culling:n?on.Rd:null,depthTest:t.renderOccluded?null:{func:an.wb.LESS},depthWrite:t.renderOccluded?null:on.LZ,colorWrite:on.BK,stencilTest:e?(0,Z_.iV)(bv.hU.IntegratedMeshMaskExcluded):null})}},{key:"getPipelineState",value:function(e,t){return this.useStencil?this._stencilPipelineState:(0,c.Z)((0,h.Z)(n.prototype),"getPipelineState",this).call(this,e,t)}}]),n}(tn.A);D_.shader=new en.J(M_.a,(function(){return n.e(28268).then(n.bind(n,28268))}));var L_=new Map([[tr.T.POSITION,0],[tr.T.UV0,1],[tr.T.NORMALCOMPRESSED,2]]),N_=function(){function e(){var t=this;(0,s.Z)(this,e),this.geometryInfo=new Vm,this.intersectionData=null,this.geometryState=null,this._textureRef=new t_((function(){return t.tile.surface.textureFadeDuration})),this.overlay=new O_,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1,this._dirtyEdgeResolutions=15,this._dirtyEdges=15,this._dirtyCorners=15}return(0,l.Z)(e,[{key:"tile",get:function(){return this._tile}},{key:"init",value:function(e){this.clear(),this._tile=e;var t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,(0,xc.cS)(t.boundingBox),t.indexCount=0,t.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new e_,this.localOrigin=null,this.overlay.clear()}},{key:"clear",value:function(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}},{key:"updateGeometryIfNeeded",value:function(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this._wireframeChanged||this._shadingChanged||this._clippingAreaChanged||this._samplerDataChanged||this._numVerticesPerSideChanged||this._dirtyCorners||this._dirtyEdgeResolutions||this._dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),hv.jt&&this.tile.intersectsClippingArea)for(var t=0;t<4;++t)(0,hv.Fp)(this.geometryInfo.outerEdges[t].count===this.geometryState.neighborData.edgeResolutions[t]+1)}},{key:"_calculateEdgeResolution",value:function(e,t){var n,r=this.tile,i=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){var a=r.surface.extent;if((0,k.pC)(a)&&(0===e&&r.extent[3]>a[3]||1===e&&r.extent[2]>a[2]||2===e&&r.extent[1]<a[1]||3===e&&r.extent[0]<a[0]))return i}var o=r.level,s=hv.OC[e];if(!t)return(0,hv.Fp)((0,k.Wi)(null===(n=r.surface)||void 0===n?void 0:n.rootTiles)||r.surface.updatingRootTiles||!r.shouldHaveNeighbor(s)),i;if(t.isLoaded){var l=t,u=l.renderData.geometryState,c=o-l.level;if((0,hv.Fp)(c>=0),0===c){var h=u.numVerticesPerSide-1;return Math.max(h,i)}var d=Math.pow(2,c),f=u.neighborData.edgeResolutions[(e+2)%4]/d;return Math.max(1,f)}(0,hv.Fp)(!t.isLeaf);var p=i;return t.forAllSubtreeOnSide((0,hv._F)(s),(function(e){return e===r||(e.isLoaded?(p=Math.max(p,Math.pow(2,e.level-o)),!0):((0,hv.Fp)(!e.isLeaf),!1))})),p}},{key:"updateNeighborData",value:function(){var e=this,t=this.tile;if(t.intersectsClippingArea){for(var n=t.renderData.geometryState.neighborData,r=function(e){return(e.isLoaded||e.level===t.level)&&(null===e||void 0===e?void 0:e.intersectsClippingArea)},i=n.edgePeerNeighbors,a=n.edgePeerNeighborSamplerVersions,o=0;o<4;++o){var s,l,u=t.findNeighborTile(hv.OC[o],r),c=j_(t,u),h=null!==(s=null===c||void 0===c||null===(l=c.renderData)||void 0===l?void 0:l.geometryState.samplerDataVersion)&&void 0!==s?s:-1,d=i[o],f=c!==j_(t,d),p=a[o]!==h;i[o]=u,(f||p)&&(a[o]=h,this._markEdgeDirty(o));var v=n.edgeResolutions[o],m=this._calculateEdgeResolution(o,u);(0,hv.Fp)((0,Se.wt)(m)),(0,hv.Fp)(m>=1),n.edgeResolutions[o]=m,v!==m&&this._markEdgeResolutionDirty(o)}for(var _=n.cornerPeerNeighbors,y=function(a){var o=t.findNeighborTile(hv.cA[a],r);_[a]=o;var s=j_(t,i[a]),l=j_(t,i[(a+1)%4]),u=j_(t,o);W_[a]=u,W_[(a+1)%4]=l,W_[(a+2)%4]=t,W_[(a+3)%4]=s,(0,hv.Fp)(W_.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})));var c=W_.reduce((function(e,t){var n;return Math.min(e,null!==(n=null===t||void 0===t?void 0:t.level)&&void 0!==n?n:1/0)}),1/0);W_.forEach((function(e,t){e&&(null===e||void 0===e?void 0:e.level)>c&&(W_[t]=null)})),(0,hv.Fp)(W_.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})));for(var h=n.cornerNeighborData[a].cornerTiles,d=n.cornerNeighborData[a].cornerTileSamplerVersions,f=0;f<4;++f){var p,v=W_[f],m=null!==(p=null===v||void 0===v?void 0:v.renderData.geometryState.samplerDataVersion)&&void 0!==p?p:-1,y=h[f]!==v,g=!y&&d[f]!==m;(y||g)&&(h[f]=v,d[f]=m,e._markCornerDirty(a))}(0,hv.Fp)(h.some((function(e){return(null===e||void 0===e?void 0:e.isLoaded)||e===t})))},g=0;g<4;++g)y(g);hv.jt&&(0,hv.Fp)(this.geometryState.neighborData.edgeResolutions.every((function(e){return e>0})));for(var b=0;b<4;++b)W_[b]=null}}},{key:"_updateGeometry",value:function(e){if(this.tile.intersectsClippingArea){hv.jt&&(0,hv.Fp)(!this.tile.intersectsClippingArea||this.geometryState.neighborData.edgeResolutions.every((function(e){return e>0}))),this.intersectionData=null;var t=this.tile,n=this._vao,r=this.geometryInfo.vertexAttributes,i=!n||!r||this._wireframeChanged||this._shadingChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._dirtyEdgeResolutions,a=!i&&(0!==this._dirtyEdges||0!==this._dirtyEdgeResolutions),o=!a&&0!==this._dirtyCorners;i?(this.releaseGeometry(),this._createGeometry(e)):a||o?t.updateEdgeElevations():o?t.updateCornerElevations():console.warn("Update for no reason?"),this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._dirtyEdgeResolutions=0,this._dirtyEdges=0,this._dirtyCorners=0,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1}}},{key:"hasGeometry",get:function(){return this._hasGeometry}},{key:"releaseGeometry",value:function(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao.dispose(),this._vao=null,function(e){Bm.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}(this.geometryInfo),!0)}},{key:"ensureTexture",value:function(e,t){return(0,k.pC)(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),(0,k.Wi)(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}},{key:"releaseTexture",value:function(){(0,k.pC)(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}},{key:"_markCornerDirty",value:function(e){var t=1<<e;this._dirtyCorners|=t}},{key:"_markEdgeDirty",value:function(e){var t=1<<e;this._dirtyEdges|=t}},{key:"_markEdgeResolutionDirty",value:function(e){var t=1<<e;this._dirtyEdgeResolutions|=t,this._dirtyEdges|=t}},{key:"_markAllEdgesAndCornersDirty",value:function(){this._dirtyCorners=15,this._dirtyEdges=15,this._dirtyEdgeResolutions=15}},{key:"updateGeometryState",value:function(){var e=this._getElevationInfo(),t=this.tile,n=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),r=Math.max(n,5),i=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(i=null);var a=this.geometryState,o=!1;a.numVerticesPerSide!==r&&(this._numVerticesPerSideChanged=!0,a.numVerticesPerSide=r,a.samplerDataVersion++,o=!0),e.changed&&(this._samplerDataChanged=!0,a.samplerData=e.samplerData,a.samplerDataVersion++,o=!0),(0,D.fS)(a.clippingArea,i)||(this._clippingAreaChanged=!0,a.clippingArea=i,o=!0);var s=t.surface,l=s.wireframe;a.wireframe!==l&&(this._wireframeChanged=!0,a.wireframe=l,o=!0);var u=s.shading;return a.shading!==u&&(this._shadingChanged=u,a.shading=u,o=u),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}},{key:"_createGeometry",value:function(e){this.tile.createGeometry();var t=this.geometryInfo.vertexAttributes,n=this.geometryInfo.indices,r=e.gl;this._vao=new er.U(e,L_,{geometry:(0,Jn.K)(t.layout)},{geometry:nr.f.createVertex(e,r.STATIC_DRAW,t.buffer)},nr.f.createIndex(e,r.STATIC_DRAW,n)),this._hasGeometry=!0}},{key:"vao",get:function(){return this._vao}},{key:"setTextureReference",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qm.Immediate;(0,k.pC)(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}},{key:"textureReference",get:function(){return this._textureRef.current}},{key:"nextTextureReference",get:function(){return this._textureRef.next}},{key:"textureFadeFactor",get:function(){return this._textureRef.fadeFactor}},{key:"textureIsFading",get:function(){return this._textureRef.isFading}},{key:"_getElevationInfo",value:function(){for(var e=this.geometryState.samplerData,t=this.tile.layerInfo[wm.ELEVATION],n=t.length,r=new Array(n),i=0,a=0,o=!1,s=0;s<n;s++){var l=t[s];if((0,k.pC)(l.upsampleInfo)){var u=l.upsampleInfo.tile,c=u.layerInfo[wm.ELEVATION][s].data,h=c&&c.samplerData;e&&e[i]===h||(o=!0),r[i++]=h,a=Math.max(a,u.lij[0])}else if(l.data){var d=this.tile.surface.layerViewByIndex(s,wm.ELEVATION);if((0,i_.yf)(this.tile,d.layer,!1)){var f=l.data;e&&e[i]===f.samplerData||(o=!0),r[i++]=f.samplerData,a=this.tile.level}}}(0,k.pC)(e)&&e.length!==i&&(o=!0);var p=i>0,v=p?r:null;return p&&(r.length=i),{changed:o,samplerData:v,maxTileLevel:a}}},{key:"estimatedGeometryMemoryUsage",get:function(){var e,t,n,r,i=(0,k.R2)(this.intersectionData,0,(function(e){return e.estimatedMemoryUsage}));return(null!==(e=null===(t=this.geometryInfo.indices)||void 0===t?void 0:t.byteLength)&&void 0!==e?e:0)+(null!==(n=null===(r=this.geometryInfo.vertexAttributes)||void 0===r?void 0:r.byteLength)&&void 0!==n?n:0)+i}},{key:"textureDescriptor",get:function(){return(0,k.pC)(this._texture)?this._texture.descriptor:null}},{key:"test",get:function(){return{hasTexture:null!=this._texture}}},{key:"checkGeometryWaterproofness",value:function(){var e=this;if(hv.jt){var t=this.tile;if((0,hv.Fp)(null===t||void 0===t?void 0:t.isLoaded),t.isLoaded&&t.intersectsClippingArea){var n=t.renderData;if(0!==t.level){var r=t.surface.extent;if(!(0,k.pC)(r)||t.intersectsExtent(r)){var i=hv.OC.map((function(e,n){return!!(0,k.pC)(r)&&(n<2?-1:1)*(t.extent[3-n]-r[3-n])<0})),a=t.level;(0,hv.Fp)(0===this._dirtyCorners),(0,hv.Fp)(0===this._dirtyEdges),(0,hv.Fp)(0===this._dirtyEdgeResolutions),(0,hv.Fp)(!this._numVerticesPerSideChanged),(0,hv.Fp)(!this._samplerDataChanged),(0,hv.Fp)(!this._clippingAreaChanged),(0,hv.Fp)(!this._wireframeChanged);for(var o=hv.cA.map((function(e){var n;return null!==(n=t.findNeighborCornerTileExact(e,(function(e){return!e.intersectsClippingArea||e.isLoaded||e.level===t.level})))&&void 0!==n?n:null})).map((function(e){return null!==e&&void 0!==e&&e.intersectsClippingArea?e:null})),s=this.geometryState.neighborData,l=0;l<4;++l){var u=s.cornerPeerNeighbors[l],c=o[l];(0,hv.Fp)(c===u,"Tile[".concat(t.lij,"].corner[").concat(l,"] out of date: cur=[").concat(null===u||void 0===u?void 0:u.lij,"] exp=[").concat(null===c||void 0===c?void 0:c.lij,"]"))}hv.OC.forEach((function(r,o){if(!i[o]){var s=t.findNeighborTile(r,(function(e){return(e.level===a||(null===e||void 0===e?void 0:e.isLoaded))&&(null===e||void 0===e?void 0:e.intersectsClippingArea)}));if(s){(0,hv.Fp)(s.isLoaded||s.level===t.level),(0,hv.Fp)(s===e.geometryState.neighborData.edgePeerNeighbors[o]);var l=a-s.level;if(!s.isLoaded)return(0,hv.Fp)(!s.isLeaf),void(0,hv.Fp)(0===l);var u=s.renderData;(0,hv.Fp)(function(e,t,n){if((0,k.Wi)(e)||(0,k.Wi)(t))return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&n===Cm.Xo.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&n===Cm.Xo.WEST)return!0}var r=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(n){case Cm.Xo.NORTH:return(0,hv.Wq)(e.extent[3],t.extent[1],r);case Cm.Xo.SOUTH:return(0,hv.Wq)(e.extent[1],t.extent[3],r);case Cm.Xo.EAST:return(0,hv.Wq)(e.extent[2],t.extent[0],r)||(0,hv.Wq)(e.extent[2],-t.extent[0],r);case Cm.Xo.WEST:return(0,hv.Wq)(e.extent[0],t.extent[2],r)||(0,hv.Wq)(e.extent[0],-t.extent[2],r)}}(t,s,r)),(0,hv.Fp)(l>=0);var c=Math.pow(2,l);if(l<0)(0,hv.Fp)(!1);else{var h=n.geometryInfo,d=h.outerEdges[o],f=h.numVerticesPerSide-1,p=u.geometryInfo;if(p){var v=e.geometryState.neighborData.edgePeerNeighbors[o];if(null!==v&&void 0!==v&&v.isLoaded){var m=v.renderData;(0,hv.Fp)(v==v),(0,hv.Fp)(n.geometryState.neighborData.edgePeerNeighborSamplerVersions[o]===m.geometryState.samplerDataVersion),(0,hv.Fp)(e.geometryState.neighborData.edgePeerNeighborSamplerVersions[o]===m.geometryState.samplerDataVersion)}var _=(o+2)%4,y=p.outerEdges[_],g=d.count-1,b=y.count-1;(0,hv.Fp)(g*c===b,"Tile[".concat(t.lij,"]:e").concat(o,",res=").concat(g," edgeRes mismatch with Neighbor[").concat(s.lij,"]:e").concat(_,",res=").concat(b," (expected:").concat(g*c,")"));var w=t.extent,C=r===Cm.Xo.NORTH||r===Cm.Xo.SOUTH,x=y.count-1,T=x/Math.pow(2,l),S=d.count-1;if(T<1)(0,hv.Fp)(1===S);else{(0,hv.Fp)(T===S),(0,hv.Fp)((0,Se.wt)(T));var P=p.numVerticesPerSide-1;(0,hv.Fp)(l>0||T===Math.max(P,f));var R=t.getNeighborEdgeStartVertexIndex(o,s);(0,hv.Fp)(0<=R&&R<c);var A=R*T;(0,hv.Fp)(0<=A&&A<=x-T);var E=0,O=A;d.getVertexPos(F_,0),d.getVertexPos(U_,d.count-1);for(var M=(0,Gt.i)(F_,U_),Z=Math.max(G_,1e-4*M),I=0;I<=T;++I){d.getVertexPos(F_,E),y.getVertexPos(U_,O);var D=I/T,L=C?w[0]+D*(w[2]-w[0]):r===Cm.Xo.WEST?w[0]:w[2],N=C?r===Cm.Xo.SOUTH?w[1]:w[3]:w[1]+D*(w[3]-w[1]),U=t.surface.extent;if((0,k.Wi)(U)||(0,z.jE)(U,L,N)){var V=(0,Gt.j)(F_,U_),H=(0,Gt.u)(F_)-ke.sv.radius,B=(0,Gt.u)(U_)-ke.sv.radius,G=V<Z;if(!G){console.warn("Tile edge vertex position mismatch: between [".concat(t.lij,"].edge").concat(o,"[").concat(E,"/").concat(d.count,"] and [").concat(s.lij,"].edge").concat(_,"[").concat(O,"/").concat(y.count,"]")),(0,k.pC)(U)&&console.warn("  surface extent= ",U," x,y=",L,",",N);var W=(0,F.c)();(0,Gt.b)(W,n.localOrigin,u.localOrigin),(0,Gt.u)(W)>0&&console.warn("   localOrigins: ".concat(n.localOrigin," vs ").concat(u.localOrigin," d=").concat((0,Gt.u)(W)," [").concat(W,"]")),function(){var e=(0,F.a)(F_),n=(0,F.a)(U_);t.updateEdgeElevations(),s.updateEdgeElevations(),d.getVertexPos(F_,E),y.getVertexPos(U_,O);var r=(0,F.c)();(0,Gt.w)(r,F_,e),(0,Gt.u)(r)>0&&console.warn("  XXX Tile[".concat(t.lij,"] edge out of date: ").concat(e," vs ").concat(F_," d=").concat((0,Gt.u)(r)," [").concat(r,"]")),(0,Gt.w)(r,U_,n),(0,Gt.u)(r)>0&&console.warn("  XXX Neighbor[".concat(s.lij,"] edge out of date: ").concat(n," vs ").concat(U_," d=").concat((0,Gt.u)(r)," [").concat(r,"]"))}(),(0,hv.Fp)(G,"Mismatch in tile [".concat(t.lij,"].edge[").concat(o,"][").concat(E,"/").concat(d.count,"] vs neighbor [").concat(s.lij,"].edge[").concat(_,"][").concat(O,"/").concat(y.count,"] ").concat((0,hv.zT)(F_)," vs ").concat((0,hv.zT)(U_),"  dist=").concat(V," h(t|n|d)=").concat(H,"|").concat(B,"|").concat(B-H))}t.surface.shading&&function(){d.getNormal(V_,E),y.getNormal(H_,O),(0,Gt.n)(z_,V_),(0,Gt.n)(B_,H_);var e=(0,Gt.e)(z_,B_),n=1-e<.01||t===s;if(!n){var r=(0,F.c)();(0,Gt.w)(r,V_,H_);var i=function(){return"Mismatch in tile edge normal ".concat((0,hv.sP)(t.lij)," (").concat(E,"/").concat(d.count-1,") edge ").concat(o," vs neighbor ").concat((0,hv.sP)(s.lij),"  (").concat(O,"/").concat(y.count-1,") nedge ").concat(_," :").concat((0,hv.zT)(V_)," vs ").concat((0,hv.zT)(H_),"  dot = ").concat(e," : ").concat((0,hv.zT)(r))};console.warn("Mismatch in tile edge normal: ",i()),t.updateEdgeElevations(),s.updateEdgeElevations();var a=(0,F.c)(),l=(0,F.c)();d.getNormal(a,E),y.getNormal(l,O),(0,Gt.F)(V_,a)||console.warn("Missing update in tile normal: ",(0,hv.zT)(V_)," => ",(0,hv.zT)(a)),(0,Gt.F)(H_,l)||console.warn("Missing update in neighbor normal: ",(0,hv.zT)(H_)," => ",(0,hv.zT)(l)),(0,hv.Fp)(n,i())}}()}E+=1,O+=1}}}else(0,hv.Fp)(!1)}}else{var j=!t.surface.updatingRootTiles&&(0,k.pC)(t.surface.rootTiles)&&t.surface.rootTiles.length>0&&t.shouldHaveNeighbor(r);(0,hv.Fp)(!j)}}}))}}}}}}]),e}(),F_=(0,F.c)(),U_=(0,F.c)(),V_=(0,F.c)(),H_=(0,F.c)(),z_=(0,F.c)(),B_=(0,F.c)(),G_=1,W_=[null,null,null,null];function j_(e,t){return null!==t&&void 0!==t&&t.isLoaded||t===e?t:null}function q_(e,t){var n=e.tile,r=n.extent,i=n.extentInRadians,a=n.surface,o=e.localOrigin,s=e.geometryState,l=a.isWebMercator,u=a.shading||vy,c=s.numVerticesPerSide,h=c-1,d=Math.pow(c-2,2),f=l&&(t===Cm.tk.HAS_SOUTH_POLE||t===Cm.tk.HAS_BOTH_POLES),p=l&&(t===Cm.tk.HAS_NORTH_POLE||t===Cm.tk.HAS_BOTH_POLES),v=6*((f?1:0)+(p?1:0))*(h+1),m=s.neighborData,_=m.edgeResolutions.reduce((function(e,t){return e+t+1}),0),y=Gm(d+v+_),g=e.geometryInfo;g.numVerticesPerSide=s.numVerticesPerSide,g.vertexAttributes=y;var b=g.boundingBox;(0,xc.cS)(b);var w=K_(e);hy.update(h,i,w),function(e){var t=e.tile;t.intersectsClippingArea&&(t.surface.shading||vy?function(e){var t=e.geometryState,n=t.numVerticesPerSide,r=n-2,i=n-1,a=e.geometryInfo,o=a.vertexAttributes,s=o.position,l=o.uv0,u=o.normalCompressed,c=e.tile,h=c.extent,d=h[0],f=h[2],p=h[1],v=h[3],m=c.ellipsoid.radius,_=t.samplerData,y=e.localOrigin,g=y[0],b=y[1],w=y[2],C=s.typedBuffer,x=s.typedBufferStride,T=1/i,S=a.boundingBox,k=0;if(1<=r)for(var P=T,R=p*(1-P)+v*P,A=hy.sinLatLUT[1],E=hy.cosLatLUT[1],O=1;O<=r;O++){var M=O*T,Z=d*(1-M)+f*M,I=hy.sinLonLUT[O],D=hy.cosLonLUT[O],L=m+mm(Z,R,_),N=L*D*E-g,F=L*I*E-b,U=L*A-w;Xm(N,F,U,S);var V=(O-1)*x;C[V]=N,C[V+1]=F,C[V+2]=U,jm(l,O-1,M,P)}for(var H=1;H<=r;H++)for(var z=H*T,B=p*(1-z)+v*z,G=hy.sinLatLUT[H],W=hy.cosLatLUT[H],j=H+1,q=j*T,Y=p*(1-q)+v*q,X=hy.sinLatLUT[j],Q=hy.cosLatLUT[j],J=hy.sinLonLUT[0],K=hy.cosLonLUT[0],$=m+mm(d,B,_),ee=K*W*$-g,te=J*W*$-b,ne=G*$-w,re=k*x,ie=C[re],ae=C[re+1],oe=C[re+2],se=1;se<=r;se++){var le=se*T,ue=d*(1-le)+f*le,ce=hy.sinLonLUT[se],he=hy.cosLonLUT[se],de=he*W,fe=ce*W,pe=G,ve=0,me=0,_e=0,ye=0,ge=0,be=0;if(se<r){var we=(k+1)*x;ye=C[we],ge=C[we+1],be=C[we+2]}else{var Ce=hy.sinLonLUT[i],xe=hy.cosLonLUT[i],Te=m+mm(f,B,_);ye=xe*W*Te-g,ge=Ce*W*Te-b,be=G*Te-w}var Se=ee,ke=te,Pe=ne;ee=ie,te=ae,ne=oe,ie=ye,ae=ge,oe=be,ve=ye-Se,me=ge-ke,_e=be-Pe;var Re=0,Ae=0,Ee=0;if(H>1){var Oe=(k-r)*x;Re=C[Oe],Ae=C[Oe+1],Ee=C[Oe+2]}else{var Me=hy.sinLatLUT[0],Ze=hy.cosLatLUT[0],Ie=m+mm(ue,p,_);Re=he*Ze*Ie-g,Ae=ce*Ze*Ie-b,Ee=Me*Ie-w}var De=m+mm(ue,Y,_),Le=he*Q*De-g,Ne=ce*Q*De-b,Fe=X*De-w;if(H<r){var Ue=k+r,Ve=Ue*x;C[Ve]=Le,C[Ve+1]=Ne,C[Ve+2]=Fe,Xm(Le,Ne,Fe,S),jm(l,Ue,le,q)}var He=Re-Le,ze=Ae-Ne,Be=Ee-Fe;pe*pe<.999&&(de=_e*ze-me*Be,fe=ve*Be-_e*He,pe=me*He-ve*ze);var Ge=1/Math.sqrt(de*de+fe*fe+pe*pe);Wm(u,k,de*Ge,fe*Ge,pe*Ge),++k}}(e):function(e){for(var t=e.geometryState,n=t.numVerticesPerSide,r=n-2,i=n-1,a=e.geometryInfo,o=a.vertexAttributes,s=o.position,l=o.uv0,u=e.tile,c=u.extent,h=c[0],d=c[2],f=c[1],p=c[3],v=u.ellipsoid.radius,m=t.samplerData,_=e.localOrigin,y=_[0],g=_[1],b=_[2],w=a.boundingBox,C=s.typedBuffer,x=s.typedBufferStride,T=0,S=1;S<=r;S++)for(var k=S/i,P=f*(1-k)+p*k,R=hy.sinLatLUT[S],A=hy.cosLatLUT[S],E=1;E<=r;E++){var O=E/i,M=h*(1-O)+d*O,Z=hy.sinLonLUT[E],I=hy.cosLonLUT[E],D=v+mm(M,P,m),L=I*A*D-y,N=Z*A*D-g,F=R*D-b;Xm(L,N,F,w);var U=T*x;C[U]=L,C[U+1]=N,C[U+2]=F,jm(l,T,O,k),++T}}(e))}(e),ay(e,d),Y_(e);var C=[];if(function(){var e=d+_,t=o[0],i=o[1],a=o[2],s=n.ellipsoid.radius,l=r[1],v=r[3],m=function(n,r){var o=r*c;Xm(-t,-i,n*s-a,b),C.push({connectedRowOffset:o,connectedOuterEdgeOffset:1===n?0:2,rowOffset:e,latitudeResolution:6});for(var d=J_(-1===n?l:v,s),f=n*Math.PI/2-d,p=.99*(1===n?1:-1),m=s+0,_=y.position,g=y.uv0,w=y.normalCompressed,x=1;x<=6;++x)for(var T=d+f*(x/6),S=Math.cos(T),k=Math.sin(T),P=0;P<=h;P++){var R=P/h,A=hy.sinLonLUT[P],E=hy.cosLonLUT[P]*S,O=A*S,M=k,Z=E*m-t,I=O*m-i,D=M*m-a;Xm(Z,I,D,b),_.setValues(e,Z,I,D),jm(g,e,R,p),u&&Wm(w,e,E,O,M),++e}};f&&m(-1,0),p&&m(1,h)}(),iy(g,s.numVerticesPerSide,C,[0,c-1],[0,c-1],s.wireframe),e.intersectionData=null,hv.jt)for(var x=0;x<4;++x)(0,hv.Fp)(g.outerEdges[x].count===m.edgeResolutions[x]+1)}function Y_(e){e.tile.intersectsClippingArea&&(Q_(e),X_(e))}function X_(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e.geometryState,r=e.geometryInfo,i=n.neighborData,a=e.tile,o=a.level,s=a.extent,l=a.ellipsoid.radius,u=a.extentInRadians,c=u[0],h=u[2],d=u[1],f=u[3],p=n.samplerData,v=s[0],m=s[2],_=s[1],y=s[3],g=K_(e),b=r.boundingBox,w=e.localOrigin,C=w[0],x=w[1],T=w[2],S=a.surface.shading||vy,P=r.vertexAttributes,R=P.position,A=R.typedBuffer,E=R.typedBufferStride,O=P.uv0,M=function(n){var u=1===n||3===n,w=i.edgeResolutions[n];(0,hv.Fp)((0,Se.wt)(w));var P=w+1,R=j_(a,i.edgePeerNeighbors[n]);if(py(a,R,n))return oy(e,n,R),"continue";var M=(0,k.pC)(R);(0,hv.Fp)(!M||R.level===a.level),(0,hv.Fp)(!M||(0,i_.gl)(a,R)<=0);var Z=null===R||void 0===R?void 0:R.renderData,I=null===Z||void 0===Z?void 0:Z.geometryState;if(hv.jt){var D=a.surface;if(!R&&D&&!D.updatingRootTiles){var L=hv.OC[n],N=a.findNeighborTile(L,(function(e){return e.isLoaded||e.isLeaf||e.level===a.level}));N?N.intersectsClippingArea&&((0,hv.Fp)(!N.isLoaded),(0,hv.Fp)(!N.isLeaf),(0,hv.Fp)(N.level===o)):(0,hv.Fp)((0,k.Wi)(null===D||void 0===D?void 0:D.rootTiles)||!a.shouldHaveNeighbor(L))}}var F=1===n?s[2]:s[0],U=null===R||void 0===R?void 0:R.extent,V=U&&u?1===n?U[0]:U[2]:F,H=0===n?s[3]:s[1],z=1===n?1:0,B=0===n?1:0,G=1===n?h:c,W=0===n?f:d,j=Math.sin(G),q=Math.cos(G),Y=Math.sin(W),X=Math.cos(W),Q=null===I||void 0===I?void 0:I.samplerData,J=M?function(e,t,n){return.5*(mm(e,t,p)+mm(n,t,Q))}:function(e,t,n){return mm(e,t,p)},K=r.outerEdges[n],$=t&&P>3?P-3:1,ee=(0,k.pC)(p)&&p.some((function(e){return null!=e})),te=(0,k.pC)(Q)&&Q.some((function(e){return null!=e})),ne=ee||te,re=1/w,ie=K.index0;S?((0,hv.Fp)(!U||(0,hv.Wq)(U[2]-U[0],s[2]-s[0])),function(){var e=1===n?-1:3===n?1:0,t=0===n?-1:2===n?1:0,r=(s[2]-s[0])*re,i=e*r,a=t*r,o=u?e*((h-c)*re):0,d=u?0:t*re,f=B,w=u?G+o:G,S=u?Math.sin(w):j,k=u?Math.cos(w):q,R=u?G-o:G,Z=u?Math.sin(R):j,I=u?Math.cos(R):q,D=u?W:g(f+d),L=u?Y:Math.sin(D),N=u?X:Math.cos(D),U=u?W:g(f-d),ee=u?Y:Math.sin(U),te=u?X:Math.cos(U),ae=0,oe=0,se=0,le=0*re,ue=u?F:v*(1-le)+m*le,ce=u?V:ue,he=u?_*(1-le)+y*le:H,de=u?G:c*(1-le)+h*le,fe=u?j:Math.sin(de),pe=u?q:Math.cos(de),ve=u?g(le):W,me=u?Math.sin(ve):Y,_e=u?Math.cos(ve):X,ye=l+J(ue,he,ce);ae=pe*_e*ye,oe=fe*_e*ye,se=me*ye;var ge=0,be=0,we=0,Ce=1*re,xe=u?F:v*(1-Ce)+m*Ce,Te=u?V:xe,Se=u?_*(1-Ce)+y*Ce:H,ke=u?G:c*(1-Ce)+h*Ce,Pe=u?j:Math.sin(ke),Re=u?q:Math.cos(ke),Ae=u?g(Ce):W,Ee=u?Math.sin(Ae):Y,Oe=u?Math.cos(Ae):X,Me=l+J(xe,Se,Te);ge=Re*Oe*Me,be=Pe*Oe*Me,we=Ee*Me;for(var Ze=1;Ze<P-1;Ze+=$){var Ie=(Ze+1)*re,De=u?F:v*(1-Ie)+m*Ie,Le=u?V:De,Ne=u?_*(1-Ie)+y*Ie:H,Fe=u?G:c*(1-Ie)+h*Ie,Ue=u?j:Math.sin(Fe),Ve=u?q:Math.cos(Fe),He=u?g(Ie):W,ze=u?Math.sin(He):Y,Be=u?Math.cos(He):X,Ge=l+J(De,Ne,Le),We=Ve*Be*Ge,je=Ue*Be*Ge,qe=ze*Ge,Ye=ge,Xe=be,Qe=we;ge=We,be=je,we=qe;var Je=ie+Ze,Ke=Je*E,$e=Ye-C,et=Xe-x,tt=Qe-T;A[Ke]=$e,A[Ke+1]=et,A[Ke+2]=tt,Xm($e,et,tt,b);var nt=Ze*re;jm(O,Je,u?z:nt,u?nt:B);var rt=ae,it=oe,at=se;ae=Ye,oe=Xe,se=Qe;var ot=Ye,st=Xe,lt=Qe,ut=1/Math.sqrt(ot*ot+st*st+lt*lt),ct=lt*ut,ht=0,dt=0,ft=0;if(ne&&ct*ct<.999){var pt,vt,mt,_t=0===n?-1:1;pt=_t*(We-rt),vt=_t*(je-it),mt=_t*(qe-at);var yt=Ze*re,gt=u?F:v*(1-yt)+m*yt,bt=u?V:gt,wt=u?_*(1-yt)+y*yt:H,Ct=u?G:c*(1-yt)+h*yt,xt=u?j:Math.sin(Ct),Tt=u?q:Math.cos(Ct),St=u?g(yt):W,kt=u?Math.sin(St):Y,Pt=u?Math.cos(St):X,Rt=ot,At=st,Et=lt;if(M){var Ot=l+mm(bt-i,wt-a,Q),Mt=u?Pt:te;Rt=(u?I:Tt)*Mt*Ot,At=(u?Z:xt)*Mt*Ot,Et=(u?kt:ee)*Ot}var Zt=l+mm(gt+i,wt+a,p),It=u?Pt:N,Dt=(u?k:Tt)*It*Zt,Lt=(u?S:xt)*It*Zt,Nt=(u?kt:L)*Zt;M||(Rt=2*ot-Dt,At=2*st-Lt,Et=2*lt-Nt);var Ft=3===n?-1:1,Ut=Ft*(Rt-Dt),Vt=Ft*(At-Lt),Ht=Ft*(Et-Nt);ht=mt*Vt-vt*Ht,dt=pt*Ht-mt*Ut,ft=vt*Ut-pt*Vt;var zt=1/Math.sqrt(ht*ht+dt*dt+ft*ft);ht*=zt,dt*=zt,ft*=zt}else ht=ot*ut,dt=st*ut,ft=lt*ut;K.setNormalFromValues(Ze,ht,dt,ft)}}()):function(){for(var e=1;e<P-1;e+=$){var t=e*re,n=u?z:t,r=u?t:B,i=u?F:v*(1-t)+m*t,a=u?_*(1-t)+y*t:H,o=u?V:i,s=u?G:c*(1-t)+h*t,d=u?j:Math.sin(s),f=u?q:Math.cos(s),p=u?g(t):W,w=u?Math.sin(p):Y,S=u?Math.cos(p):X,k=J(i,a,o),R=l+k,M=f*S*R-C,Z=d*S*R-x,I=w*R-T;Xm(M,Z,I,b);var D=ie+e,L=D*E;A[L]=M,A[L+1]=Z,A[L+2]=I,jm(O,D,n,r)}}()},Z=0;Z<4;++Z)M(Z)}function Q_(e){sy(e)}function J_(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function K_(e){var t=e.tile;if(t.surface.isWebMercator){var n=t.extent,r=t.ellipsoid.radius;return function(e){return function(e,t,n,r){return J_(e*(1-r)+t*r,n)}(n[1],n[3],r,e)}}var i=t.extentInRadians;return function(e){return function(e,t,n){return e*(1-n)+t*n}(i[1],i[3],e)}}function $_(e,t){var n=e.tile.extent,r=e.geometryState,i=n[0],a=n[1],o=n[2]-i,s=n[3]-a,l=r.clippingArea,u=(0,k.pC)(l)?Math.max(0,(l[0]-i)/o):0,c=(0,k.pC)(l)?Math.max(0,(l[1]-a)/s):0,h=(0,k.pC)(l)?Math.min(1,(l[2]-i)/o):1,d=(0,k.pC)(l)?Math.min(1,(l[3]-a)/s):1,f=r.numVerticesPerSide,p=Math.pow(f-2,2),v=r.neighborData.edgeResolutions.reduce((function(e,t){return e+t+1}),0),m=Gm(p+v),_=e.geometryInfo,y=_.boundingBox;(0,xc.cS)(y),_.numVerticesPerSide=r.numVerticesPerSide,_.vertexAttributes=m,(0,Xt.s)(_.uvRange,u,c,h,d),function(e){var t=e.tile;t.intersectsClippingArea&&(t.surface.shading?function(e){var t=e.tile,n=t.surface;if(!n.shading&&!vy)return;for(var r=e.geometryState,i=r.samplerData,a=e.localOrigin,o=n.isWebMercatorOnPlateeCarree,s=r.clippingArea,l=(0,k.pC)(s)?s:dy,u=t.extent,c=u[0],h=u[1],d=u[2],f=u[3],p=Math.max(c,l[0]),v=Math.min(d,l[2]),m=Math.max(h,l[1]),_=Math.min(f,l[3]),y=t.ellipsoid.radius,g=t.horizontalScale,b=r.numVerticesPerSide,w=b-1,C=b-2,x=e.geometryInfo,T=x.vertexAttributes,S=T.position,P=T.uv0,R=T.normalCompressed,A=x.uvRange,E=A[0],O=A[1],M=A[2],Z=A[3],I=x.boundingBox,D=a[0],L=a[1],N=a[2],F=S.typedBuffer,U=S.typedBufferStride,V=0,H=(0,Se.uZ)(h,m,_),z=o?(Math.PI/2-2*Math.atan(Math.exp(-H/y)))*y:H*g,B=1/w,G=(0,Se.uZ)(h*(1-B)+f*B,m,_),W=z,j=o?(Math.PI/2-2*Math.atan(Math.exp(-G/y)))*y:G*g,q=1;q<=C;q++){var Y=q/w,X=(0,Se.uZ)(h*(1-Y)+f*Y,m,_),Q=(0,Se.uZ)(Y,O,Z),J=j,K=(q-1)/w,$=(0,Se.uZ)(h*(1-K)+f*K,m,_),ee=W,te=(q+1)/w,ne=(0,Se.uZ)(h*(1-te)+f*te,m,_),re=o?(Math.PI/2-2*Math.atan(Math.exp(-ne/y)))*y:ne*g,ie=(0,Se.uZ)(te,O,Z);W=j,j=re;var ae=(0,Se.uZ)(c,p,v),oe=ae*g,se=mm(ae,X,i),le=1/w,ue=(0,Se.uZ)(le,E,M),ce=(0,Se.uZ)(c*(1-ue)+d*ue,p,v),he=ue,de=ce,fe=ce*g,pe=mm(ce,X,i);if(1===q){var ve=fe-D,me=W-L,_e=pe-N,ye=0*U;F[ye]=ve,F[ye+1]=me,F[ye+2]=_e,Xm(ve,me,_e,I),jm(P,V,(0,Se.uZ)(le,E,M),Q)}for(var ge=1;ge<=C;ge++){var be=fe,we=pe,Ce=(ge+1)/w,xe=(0,Se.uZ)(Ce,E,M),Te=(0,Se.uZ)(c*(1-Ce)+d*Ce,p,v),ke=de;de=Te;var Pe=V+1,Re=Pe*U;if(1===q||ge===C){var Ae=Te*g,Ee=mm(Te,X,i);if(1===q&&ge<C){var Oe=Ae-D,Me=J-L,Ze=Ee-N;F[Re]=Oe,F[Re+1]=Me,F[Re+2]=Ze,Xm(Oe,Me,Ze,I),jm(P,Pe,xe,Q)}fe=Ae,pe=Ee}else fe=F[Re]+D,pe=F[Re+2]+N;var Ie=fe,De=pe,Le=oe,Ne=se;oe=be,se=we;var Fe=(V-C)*U,Ue=1===q?mm(ke,$,i):F[Fe+2]+N,Ve=mm(ke,ne,i);if(q<C){var He=V+C,ze=He*U,Be=be-D,Ge=re-L,We=Ve-N;F[ze]=Be,F[ze+1]=Ge,F[ze+2]=We,Xm(Be,Ge,We,I);var je=he;he=xe,jm(P,He,je,ie)}var qe=Ie-Le,Ye=ee-re,Xe=Ye*(De-Ne),Qe=qe*(Ue-Ve),Je=-Ye*qe,Ke=Xe*Xe+Qe*Qe+Je*Je;if(0===Ke)Wm(R,V,0,0,1);else{var $e=1/Math.sqrt(Ke);Wm(R,V,Xe*$e,Qe*$e,Je*$e)}++V}}}(e):function(e){for(var t=e.geometryState,n=t.samplerData,r=e.tile,i=r.surface,a=e.localOrigin,o=i.isWebMercatorOnPlateeCarree,s=t.clippingArea,l=(0,k.pC)(s)?s:dy,u=r.extent,c=u[0],h=u[1],d=u[2],f=u[3],p=Math.max(c,l[0]),v=Math.min(d,l[2]),m=Math.max(h,l[1]),_=Math.min(f,l[3]),y=a[0],g=a[1],b=a[2],w=r.ellipsoid.radius,C=r.horizontalScale,x=ry(o,w,C),T=t.numVerticesPerSide,S=T-1,P=T-2,R=e.geometryInfo,A=R.uvRange,E=A[0],O=A[1],M=A[2],Z=A[3],I=R.boundingBox,D=R.vertexAttributes,L=D.position,N=D.uv0,F=0,U=1;U<=P;U++)for(var V=U/S,H=(0,Se.uZ)(h*(1-V)+f*V,m,_),z=(0,Se.uZ)(V,O,Z),B=x(H)-g,G=1;G<=P;G++){var W=G/S,j=(0,Se.uZ)(c*(1-W)+d*W,p,v),q=(0,Se.uZ)(W,E,M),Y=j*C-y,X=mm(j,H,n)-b;Xm(Y,B,X,I),L.setValues(F,Y,B,X),jm(N,F,q,z),++F}}(e))}(e),ay(e,p),ey(e),iy(_,r.numVerticesPerSide,[],[0,f-1],[0,f-1],r.wireframe),e.intersectionData=null}function ey(e,t){e.tile.intersectsClippingArea&&(ny(e),ty(e,!1))}function ty(e,t){for(var n=e.geometryState,r=n.neighborData,i=e.tile,a=i.surface,o=a.shading||vy,s=i.extent,l=n.clippingArea,u=(0,k.pC)(l)?l:dy,c=s[0],h=s[2],d=s[1],f=s[3],p=[f>u[3],h>u[2],d<u[1],c<u[0]],v=e.geometryInfo,m=i.horizontalScale,_=ry(a.isWebMercatorOnPlateeCarree,i.ellipsoid.radius,m),y=v.boundingBox,g=v.uvRange[0],b=v.uvRange[1],w=v.uvRange[2],C=v.uvRange[3],x=Math.max(c,u[0]),T=Math.min(h,u[2]),S=Math.max(d,u[1]),P=Math.min(f,u[3]),R=e.localOrigin,A=R[0],E=R[1],O=R[2],M=n.samplerData,Z=function(n){var s=1===n||3===n,l=r.edgeResolutions[n];(0,hv.Fp)((0,Se.wt)(l));var u=l+1,R=p[n],Z=j_(i,r.edgePeerNeighbors[n]);if(!R&&py(i,Z,n))return oy(e,n,Z),"continue";var I=(0,k.pC)(Z)&&!R,D=null===Z||void 0===Z?void 0:Z.renderData,L=null===D||void 0===D?void 0:D.geometryState;if(hv.jt&&((0,hv.Fp)(!I||Z.level===i.level),(0,hv.Fp)(!I||(0,i_.gl)(i,Z)<=0),i&&!Z&&!a.updatingRootTiles)){var N=hv.OC[n],F=i.findNeighborTile(N,(function(e){return e.isLoaded||e.isLeaf||e.level===i.level}));a.updatingRootTiles||(F?F.intersectsClippingArea&&((0,hv.Fp)(!F.isLoaded),(0,hv.Fp)(!F.isLeaf),(0,hv.Fp)(F.level===i.level)):(0,hv.Fp)((0,k.Wi)(null===a||void 0===a?void 0:a.rootTiles)||!i.shouldHaveNeighbor(N)))}var U=(0,Se.uZ)(1===n?h:c,x,T),V=(0,Se.uZ)(0===n?f:d,S,P),H=null===L||void 0===L?void 0:L.samplerData,z=v.outerEdges[n],B=t&&u>3?u-3:1,G=(0,Se.uZ)(1===n?1:0,g,w),W=(0,Se.uZ)(0===n?1:0,b,C),j=I?function(e,t){return.5*(mm(e,t,H)+mm(e,t,M))}:function(e,t){return mm(e,t,M)};if(o){var q=(h-c)/l,Y=s?1===n?q:-q:0,X=s?0:0===n?q:-q,Q=-Y,J=-X,K=0,$=0,ee=0,te=0/l,ne=s?U:(0,Se.uZ)(c*(1-te)+h*te,x,T),re=s?(0,Se.uZ)(d*(1-te)+f*te,S,P):V,ie=j(ne,re);K=ne*m,$=_(re),ee=ie;var ae=0,oe=0,se=0,le=1/l,ue=s?U:(0,Se.uZ)(c*(1-le)+h*le,x,T),ce=s?(0,Se.uZ)(d*(1-le)+f*le,S,P):V,he=j(ue,ce);ae=ue*m,oe=_(ce),se=he;for(var de=1;de<u-1;de+=B){var fe=de/l,pe=ae,ve=oe,me=se,_e=s?G:(0,Se.uZ)(fe,g,w),ye=s?(0,Se.uZ)(fe,b,C):W,ge=pe-A,be=ve-E,we=me-O;Xm(pe,be,we,y),z.setVertexFromValuesRawPositionUV(de,ge,be,we,_e,ye);var Ce=(de+1)/l,xe=s?U:(0,Se.uZ)(c*(1-Ce)+h*Ce,x,T),Te=s?(0,Se.uZ)(d*(1-Ce)+f*Ce,S,P):V,ke=j(xe,Te);ae=xe*m,oe=_(Te);var Pe=ae,Re=se=ke,Ae=K,Ee=$,Oe=ee;K=pe,$=ve,ee=me;var Me=0,Ze=0,Ie=0;if(s){var De=oe-ve,Le=Re-me,Ne=Ee-ve,Fe=Oe-me,Ue=(0,Se.uZ)(d*(1-fe)+f*fe,S,P),Ve=U+Q,He=Ve*m-pe,ze=mm(Ve,Ue,M)-me,Be=3===n?-1:1;if(Me=Be*(-Ne+De)*ze,Ze=Be*He*(-Fe+Le),Ie=-Be*He*(-Ne+De),I){var Ge=U+Y,We=Ge*m-pe;Me=(-Ne+De)*(ze-(mm(Ge,Ue,H)-me)),Ze=(He-We)*(-Fe+Le),Ie=-(He-We)*(-Ne+De)}}else{var je=Pe-pe,qe=Re-me,Ye=Ae-pe,Xe=Oe-me,Qe=(0,Se.uZ)(c*(1-fe)+h*fe,x,T),Je=V+J,Ke=mm(Qe,Je,M)-me,$e=_(Je)-ve,et=2===n?-1:1;if(Me=et*$e*(-Xe+qe),Ze=et*(-Ye+je)*Ke,Ie=-et*$e*(-Ye+je),I){var tt=Qe,nt=V+X,rt=_(nt)-ve;Me=(-$e+rt)*(-Xe+qe),Ze=(-Ye+je)*(-Ke+(mm(tt,nt,H)-me)),Ie=-(-$e+rt)*(-Ye+je)}}var it=1/Math.sqrt(Me*Me+Ze*Ze+Ie*Ie);z.setNormalFromValues(de,Me*it,Ze*it,Ie*it)}}else for(var at=1;at<u-1;at+=B){var ot=at/l,st=s?U:(0,Se.uZ)(c*(1-ot)+h*ot,x,T),lt=s?(0,Se.uZ)(d*(1-ot)+f*ot,S,P):V,ut=s?G:(0,Se.uZ)(ot,g,w),ct=s?(0,Se.uZ)(ot,b,C):W,ht=j(st,lt),dt=st*m-A,ft=_(lt)-E,pt=ht-O;Xm(dt,ft,pt,y),z.setVertexFromValuesRawPositionUV(at,dt,ft,pt,ut,ct)}},I=0;I<4;++I)Z(I)}function ny(e,t){sy(e)}function ry(e,t,n){return e?function(e){return function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t)}:function(e){return function(e,t){return e*t}(e,n)}}function iy(e,t,n,r,i,a){var o=t-1,s=e.vertexAttributes.count,l=2*(Math.min(t-2,r[1])-Math.max(1,r[0]))*(Math.min(t-2,i[1])-Math.max(1,i[0])),u=hv.OC.map((function(e,n){return 0===n&&i[1]<t-2||1===n&&r[1]<t-2||2===n&&i[0]>1||3===n&&r[0]>1})),c=e.outerEdges.reduce((function(e,t,n){return e+(u[n]?0:o-2+t.count-1)}),0),h=n.reduce((function(e,t){return e+o*(2*(t.latitudeResolution-1)+1)}),0),d=a?2:1,f=3*(l+c+h)*d,p=s>=65536?new Uint32Array(f):new Uint16Array(f),v=0,m=t-2,_=o-2;(0,hv.Fp)(_>=0);var y=function(e,t,n,r,i,a){var o=e*i,s=a[o],l=a[o+1],u=a[o+2],c=t*i,h=a[c],d=a[c+1],f=a[c+2],p=n*i,v=a[p],m=a[p+1],_=a[p+2],y=r*i,g=a[y],b=a[y+1],w=a[y+2];return(h-g)*(h-g)+(d-b)*(d-b)+(f-w)*(f-w)>(s-v)*(s-v)+(l-m)*(l-m)+(u-_)*(u-_)};if(a){var g=function(e,t,n){p[v++]=e,p[v++]=t,p[v++]=t,p[v++]=n,p[v++]=n,p[v++]=e,hv.jt&&((0,hv.Fp)(e<s),(0,hv.Fp)(t<s),(0,hv.Fp)(n<s),(0,hv.Fp)(v<=f))};(function(){for(var n=Math.max(i[0],1)-1;n<Math.min(i[1],t-2)-1;++n)for(var a=n*m,o=Math.max(r[0],1)-1;o<Math.min(r[1],t-2)-1;++o){var s=n*m+o,l=s+1,u=l+m,c=u-1,h=a+o,d=h+1,f=d+m,p=f-1,v=e.vertexAttributes.position.typedBuffer,_=e.vertexAttributes.position.typedBufferStride;y(h,d,f,p,_,v)?(g(s,l,u),g(u,c,s)):(g(s,l,c),g(c,u,l))}})(),(0,hv.Fp)(v===3*l*d),function(){for(var t=0;t<4;++t){var n=v;if(!u[t]){var r=e.outerEdges[t],i=e.innerEdges[t],a=0,s=0,l=r.count,c=i.count;(0,hv.Fp)(c===o-1);for(var h=0,f=1===t||2===t?function(e,t,n){return g(e,t,n)}:function(e,t,n){return g(e,n,t)};a<l-1||s<c-1;){var p=i.getVertexIndex(s),m=r.getVertexIndex(a),y=a<l-1,b=s<c-1;y&&(!b||(y?0+o*(a+.5)/(l-1):0)<=(b?1+_*(s+.5)/(c-1):0))?(++a,hv.jt&&(0,hv.Fp)(a<l),f(p,m,r.getVertexIndex(a)),h++):(++s,hv.jt&&(0,hv.Fp)(s<c),f(p,m,i.getVertexIndex(s)),h++)}hv.jt&&((0,hv.Fp)(a===l-1),(0,hv.Fp)(s===c-1),(0,hv.Fp)(h===l+c-2),(0,hv.Fp)(h===o-2+r.count-1),(0,hv.Fp)(v===n+3*h*d))}}}(),(0,hv.Fp)(v===3*(l+c)*d);var b=function(n){for(var r=e.outerEdges[n.connectedOuterEdgeOffset],i=r.getVertexIndex(0),a=r.stride,s=0;s<n.latitudeResolution;++s){for(var l=0===s?n.rowOffset:i+t,u=0;u<o;u++)g(i,i+1,l+u),s<n.latitudeResolution-1&&g(i+1,l+u+1,l+u),i+=a;i=l,a=1}};n.forEach(b)}else{(function(){for(var n=Math.max(i[0],1)-1,a=Math.min(i[1],t-2)-1,o=Math.max(r[0],1)-1,s=Math.min(r[1],t-2)-1,l=n;l<a;++l)for(var u=l*m,c=o;c<s;++c){var h=u+c,d=h+1,f=d+m,_=f-1,g=e.vertexAttributes.position.typedBuffer,b=e.vertexAttributes.position.typedBufferStride;y(h,d,f,_,b,g)?(p[v]=h,p[v+1]=d,p[v+2]=f,p[v+3]=f,p[v+4]=_,p[v+5]=h):(p[v]=h,p[v+1]=d,p[v+2]=_,p[v+3]=_,p[v+4]=d,p[v+5]=f),v+=6}})(),(0,hv.Fp)(v===3*l*d),function(){for(var t=0;t<4;++t)if(!u[t]){var n=e.outerEdges[t],r=e.innerEdges[t],i=0,a=0,s=n.count,l=r.count;(0,hv.Fp)(l===o-1);for(var c=1===t||2===t,h=c?1:2,d=c?2:1,f=n.index0,m=n.stride,y=r.index0,g=r.stride;i<s-1||a<l-1;){var b=y+a*g,w=f+i*m,C=i<s-1,x=a<l-1,T=C&&(!x||(C?0+o*(i+.5)/(s-1):0)<=(x?1+_*(a+.5)/(l-1):0));T?++i:++a;var S=T?w+m:b+g;p[v]=b,p[v+h]=w,p[v+d]=S,v+=3}}}(),(0,hv.Fp)(v===3*(l+c)*d);var w=function(n){for(var r=e.outerEdges[n.connectedOuterEdgeOffset],i=r.getVertexIndex(0),a=r.stride,s=0;s<n.latitudeResolution;++s){for(var l=0===s?n.rowOffset:i+t,u=0;u<o;u++){var c=l+u;p[v]=i,p[v+1]=i+1,p[v+2]=c,s<n.latitudeResolution-1?(p[v+3]=i+1,p[v+4]=c+1,p[v+5]=c,v+=6):v+=3,i+=a}i=l,a=1}};n.forEach(w)}(0,hv.Fp)(v===f),e.indices=p,e.indexCount=f}function ay(e,t){for(var n=e.localOrigin,r=e.geometryInfo,i=e.geometryState.neighborData.edgeResolutions,a=r.numVerticesPerSide-2,o=r.vertexAttributes,s=t,l=0;l<4;++l){var u=0===l||2===l,c=(0===l?a-1:0)*a+(1===l?a-1:0),h=(u?0:1)*a+(u?1:0);r.innerEdges[l]=new Hm(o,n,c,h,a);var d=s,f=i[l]+1;r.outerEdges[l]=new Hm(o,n,d,1,f),s+=f}}function oy(e,t,n){var r=(t+2)%4,i=e.geometryState,a=e.tile,o=i.neighborData,s=a.level-n.level,l=1===t||3===t,u=o.edgeResolutions[t];(0,hv.Fp)((0,Se.wt)(u));var c=u+1,h=e.geometryInfo,d=h.boundingBox,f=h.outerEdges[t],p=h.uvRange[0],v=h.uvRange[1],m=h.uvRange[2],_=h.uvRange[3],y=(0,Se.uZ)(1===t?1:0,p,m),g=(0,Se.uZ)(0===t?1:0,v,_),b=n.renderData,w=b.geometryState,C=b.geometryInfo.outerEdges[r],x=a.getNeighborEdgeStartVertexIndex(t,n)*u,T=u*Math.pow(2,s);(0,hv.Fp)(w.neighborData.edgeResolutions[r]===T),(0,hv.Fp)(C.count-1===T);for(var S=b.localOrigin[0]-e.localOrigin[0],k=b.localOrigin[1]-e.localOrigin[1],P=b.localOrigin[2]-e.localOrigin[2],R=f.attributes,A=f.index0,E=f.stride,O=R.position.typedBuffer,M=R.position.typedBufferStride,Z=R.normalCompressed.typedBuffer,I=R.normalCompressed.typedBufferStride,D=R.uv0,L=C.attributes,N=C.index0,F=C.stride,U=L.position.typedBuffer,V=L.position.typedBufferStride,H=L.normalCompressed.typedBuffer,z=L.normalCompressed.typedBufferStride,B=1;B<c-1;++B){var G=A+E*B,W=N+F*(x+B),j=G*M,q=W*V,Y=U[q]+S,X=U[q+1]+k,Q=U[q+2]+P;O[j]=Y,O[j+1]=X,O[j+2]=Q,Xm(Y,X,Q,d);var J=G*I,K=W*z;Z[J]=H[K],Z[J+1]=H[K+1];var $=B/u;jm(D,G,l?y:(0,Se.uZ)($,p,m),l?(0,Se.uZ)($,v,_):g)}}function sy(e){for(var t,n=e.geometryState,r=n.neighborData,i=e.localOrigin,a=r.cornerNeighborData,o=e.geometryInfo,s=o.outerEdges,l=o.boundingBox,u=e.tile,c="local"===(null===(t=e.tile.surface.view)||void 0===t?void 0:t.viewingMode),h=u.ellipsoid.radius,d=u.extentInRadians,f=u.horizontalScale,p=0,v=0,m=0,_=c?function(){var t=e.geometryState.clippingArea,n=u.extent,r=(0,k.pC)(t)&&(n[3]>t[3]||n[2]>t[2]||n[1]<t[1]||n[0]<t[0]),i=ry(u.surface.isWebMercatorOnPlateeCarree,u.ellipsoid.radius,f);return function(e,n,a){var o=0===e?E[0]:E[2],s=0===n?E[1]:E[3],l=r?(0,Se.uZ)(o,t[0],t[2]):o,u=r?(0,Se.uZ)(s,t[1],t[3]):s,c=a;p=l*f,v=i(u),m=c}}():function(e,t,n){var r=d[0===t?1:3],i=d[0===e?0:2],a=Math.cos(r),o=Math.sin(r),s=Math.sin(i),l=Math.cos(i),u=h+n;p=l*a*u,v=s*a*u,m=o*u},y=0,g=0,b=0,w=0,C=0,x=0,T=0,S=0,P=0,R=c&&e.tile.surface.isWebMercatorOnPlateeCarree,A=function(e,t,n,r,i){var a=0,o=0,s=0;if(c){var l=t*f,u=R?(Math.PI/2-2*Math.atan(Math.exp(-n/h)))*h:n*f;a=l-p,o=u-v,s=r-m}else{var d=K_(e),_=e.tile,y=_.extent,g=_.extentInRadians,b=(t-y[0])/(y[2]-y[0]),k=(n-y[1])/(y[3]-y[1]),A=g[0]*(1-b)+g[2]*b,E=d(k),O=Math.cos(E),M=Math.sin(E),Z=Math.sin(A),I=Math.cos(A),D=h+r;a=I*O*D-p,o=Z*O*D-v,s=M*D-m}switch(i){case 0:T+=a,S+=o,P+=s;break;case 1:w-=a,C-=o,x-=s;break;case 2:T-=a,S-=o,P-=s;break;case 3:w+=a,C+=o,x+=s}},E=u.extent,O=n.clippingArea,M=(0,k.pC)(O)?O:dy,Z=E[0],I=E[2],D=E[1],L=E[3],N=[L>M[3],I>M[2],D<M[1],Z<M[0]],F=Math.max(Z,M[0]),U=Math.min(I,M[2]),V=Math.max(D,M[1]),H=Math.min(L,M[3]),z=o.uvRange[0],B=o.uvRange[1],G=o.uvRange[2],W=o.uvRange[3],j=u.surface.shading||vy,q=function(e){var t=a[e].cornerTiles;y=0,g=0,b=1;for(var n=1/0,r=0;r<4;++r){var i,o;n=Math.min(n,null!==(i=null===(o=t[r])||void 0===o?void 0:o.level)&&void 0!==i?i:1/0)}for(var s=0;s<4;++s){var l=t[s];fy[s]=(null===l||void 0===l?void 0:l.level)===n?l:null}for(var u=1,h=0,d=0;d<4;++d){var f=fy[d];f&&(u=Math.max(u,null===f||void 0===f?void 0:f.renderData.geometryState.numVerticesPerSide),h=f.extent[2]-f.extent[0])}var _=h,k=u;(0,hv.Fp)(k>1);for(var R=_/k,E=0;E<4;++E){var O=fy[(E+3)%4],M=fy[E%4];if(O||M){var Z=0===E?1:1===E?2:2===E?3:0,I=0===E?2:1===E?3:2===E?0:1;if(O&&M){var D=cy[E][0]*R,L=cy[E][1]*R,N=O.extent,F=N[0===Z||1===Z?2:0]+D,U=N[0===Z||3===Z?3:1]+L,V=M.extent,H=V[0===I||1===I?2:0]+D,z=V[0===I||3===I?3:1]+L,B=O.renderData,G=M.renderData,W=mm(F,U,B.geometryState.samplerData),j=mm(H,z,G.geometryState.samplerData);A(B,F,U,.5*(W+j),E)}else{var q=null!==O&&void 0!==O?O:M,Y=O?Z:I,X=q.extent,Q=cy[E],J=X[0===Y||1===Y?2:0]+Q[0]*R,K=X[0===Y||3===Y?3:1]+Q[1]*R,$=q.renderData,ee=mm(J,K,$.geometryState.samplerData);A($,J,K,ee,E)}}}if(!c){var te=Math.sqrt(p*p+v*v+m*m);y=p/te,g=v/te,b=m/te}var ne=Math.sqrt(w*w+C*C+x*x);w/=ne,C/=ne,x/=ne;var re=Math.sqrt(T*T+S*S+P*P);if(T/=re,S/=re,P/=re,c||b*b<.999){y=x*S-C*P,g=w*P-x*T,b=C*T-w*S;var ie=1/Math.sqrt(y*y+g*g+b*b);y*=ie,g*=ie,b*=ie}},Y=0;Y<4;++Y){for(var X=Y,Q=(Y+1)%4,J=0===Y||1===Y?1:0,K=0===Y||3===Y?1:0,$=(0,Se.uZ)(J,z,G),ee=(0,Se.uZ)(K,B,W),te=s[X],ne=0===Y||3===Y?te.count-1:0,re=s[Q],ie=0===Y||1===Y?re.count-1:0,ae=a[Y].cornerTiles,oe=-1,se=0;se<4;++se){var le=ae[se];le&&(-1===oe||(0,i_.gl)(ae[oe],le)>0)&&(oe=se)}var ue=oe,ce=ae[ue];if(y=0,g=0,b=1,ce!==u){var he=u.level-ce.level,de=Math.pow(2,he),fe=[ce.lij[0]+he,ce.lij[1]*de,ce.lij[2]*de],pe=[fe[1]+de===u.lij[1],0===Y&&(1===ue||0===ue&&ce!==ae[3])||1===Y&&(0===ue||1===ue&&ce!==ae[2]),fe[1]===u.lij[1]+1,2===Y&&(3===ue||2===ue&&ce!==ae[1])||3===Y&&(2===ue||3===ue&&ce!==ae[0])],ve=pe.reduce((function(e,t){return e+(t?1:0)}),0);(0,hv.Fp)(1===ve||2===ve);var me=-1,_e=-1,ye=ce.renderData;if(1===ve){var ge=pe.findIndex((function(e){return e}));(0,hv.Fp)(0<=ge&&ge<=3),me=(ge+2)%4;var be=e.geometryState.neighborData.edgeResolutions[ge];_e=u.getNeighborEdgeStartVertexIndex(ge,ce)*be+be*(0===ge&&0===Y||1===ge&&0===Y||2===ge&&1===Y||3===ge&&3===Y?1:0)}else{(0,hv.Fp)(pe[1]||pe[3]),me=pe[1]?3:1;var we=ye.geometryState.neighborData.edgeResolutions[me];_e=0===Y||3===Y?0:we}var Ce=ye.geometryInfo.outerEdges[me],xe=te.index0+ne*te.stride,Te=re.index0+ie*re.stride,ke=Ce.index0+_e*Ce.stride,Pe=Ce.attributes.position,Re=Pe.typedBuffer,Ae=ke*Pe.typedBufferStride,Ee=e.localOrigin,Oe=Ce.localOrigin,Me=Re[Ae]+Oe[0]-Ee[0],Ze=Re[Ae+1]+Oe[1]-Ee[1],Ie=Re[Ae+2]+Oe[2]-Ee[2];Xm(Me,Ze,Ie,l);var De=te.attributes.position,Le=De.typedBuffer,Ne=xe*De.typedBufferStride;Le[Ne]=Me,Le[Ne+1]=Ze,Le[Ne+2]=Ie;var Fe=re.attributes.position,Ue=Fe.typedBuffer,Ve=Te*Fe.typedBufferStride;Ue[Ve]=Me,Ue[Ve+1]=Ze,Ue[Ve+2]=Ie,jm(te.attributes.uv0,xe,$,ee),jm(re.attributes.uv0,Te,$,ee);var He=Ce.attributes.normalCompressed.typedBuffer,ze=ke*Ce.attributes.normalCompressed.typedBufferStride,Be=te.attributes.normalCompressed,Ge=Be.typedBuffer,We=xe*Be.typedBufferStride;Ge[We]=He[ze],Ge[We+1]=He[ze+1];var je=re.attributes.normalCompressed,qe=je.typedBuffer,Ye=Te*je.typedBufferStride;qe[Ye]=He[ze],qe[Ye+1]=He[ze+1]}else{var Xe=void 0;if(N[X]||N[Q])Xe=mm((0,Se.uZ)(Z*(1-J)+I*J,F,U),(0,Se.uZ)(D*(1-K)+L*K,V,H),n.samplerData);else Xe=ly(ae);_(J,K,Xe),(j||vy)&&q(Y);var Qe=p-i[0],Je=v-i[1],Ke=m-i[2];Xm(Qe,Je,Ke,l),te.setVertexFromValuesRawPositionUVNormal(ne,Qe,Je,Ke,$,ee,y,g,b),re.setVertexFromValuesRawPositionUVNormal(ie,Qe,Je,Ke,$,ee,y,g,b)}}for(var $e=0;$e<4;++$e)fy[$e]=null}function ly(e){var t=e.reduce((function(e,t){var n;return Math.min(e,null!==(n=null===t||void 0===t?void 0:t.level)&&void 0!==n?n:1/0)}),1/0);hv.jt&&((0,hv.Fp)(!e[0]||!e[2]||R_(e[0],e[2],Cm.Xo.SOUTH_WEST)),(0,hv.Fp)(!e[1]||!e[3]||R_(e[1],e[3],Cm.Xo.NORTH_WEST)));for(var n=0,r=0,i=0;i<4;++i){var a=e[i];if(a&&a.level===t){var o,s,l=0===i||1===i,u=0===i||3===i,c=a.extent;r+=mm(c[l?0:2],c[u?1:3],null===(o=a.renderData)||void 0===o||null===(s=o.geometryState)||void 0===s?void 0:s.samplerData),n++}}var h=n?r/n:0;return(0,hv.Fp)(null!=h),h}function uy(e){var t=e.vao,n=e.geometryInfo.vertexAttributes.position.typedBuffer;t.vertexBuffers.geometry.setSubData(n,0,0,n.length)}var cy=[[0,1],[1,0],[0,-1],[-1,0]],hy=new Jm,dy=(0,z.al)(-1/0,-1/0,1/0,1/0),fy=[null,null,null,null];function py(e,t,n){if(!t)return!1;var r=(0,i_.gl)(e,t);return r>0||0===r&&n>=2}var vy=!0,my=n(22909),_y=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this))._horizontalScaleFactor=1,a._extentInRenderSR=(0,z.Ue)(),void 0!==e&&a.init(e,r,i),a}return(0,l.Z)(n,[{key:"horizontalScale",get:function(){return this._horizontalScaleFactor}},{key:"init",value:function(e,t,r){(0,c.Z)((0,h.Z)(n.prototype),"init",this).call(this,e,t,r);var i=r.view.renderSpatialReference,a=r.spatialReference,o=(0,k.pC)(i)&&(0,jt.QM)(i)&&(0,k.pC)(a)&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;var s=this.surface.isWebMercatorOnPlateeCarree,l=this._extentInRenderSR,u=this.extent;if(s){var d=(0,F.f)(u[0],u[1],0);(0,H.SH)(d,ee.Z.WebMercator,d,ee.Z.PlateCarree);var f=(0,F.f)(u[2],u[3],0);(0,H.SH)(f,ee.Z.WebMercator,f,ee.Z.PlateCarree),l[0]=d[0],l[1]=d[1],l[2]=f[0],l[3]=f[1]}else for(var p=0;p<4;++p)l[p]=u[p]*o;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}},{key:"updateRadiusAndCenter",value:function(){this._updateCenter();var e=this._extentInRenderSR,t=.5*(e[2]-e[0]),n=.5*(e[3]-e[1]),r=Math.sqrt(t*t+n*n),i=.5*(this.elevationBounds[0]-this.elevationBounds[1]),a=Math.max(r,i);this._center[x_.MIDDLE][3]=a}},{key:"_calculateFrustumVisibilityStatus",value:function(e){for(var t=this._aabb(),n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=!0,u=0;u<6;u++){var c=e[u],h=c[0],d=c[1],f=c[2],p=c[3];if(h*(h>0?n:a)+d*(d>0?r:o)+f*(f>0?i:s)+p>=0)return Cm.ir.OUTSIDE;l=l&&h*(h<0?n:a)+d*(d<0?r:o)+f*(f<0?i:s)+p<=0}return l?Cm.ir.INSIDE:Cm.ir.INTERSECTS}},{key:"_aabb",value:function(){var e=this._extentInRenderSR;return(0,xc.re)(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}},{key:"intersectsRay",value:function(e,t,n,r){return yy[0]=1/t[0],yy[1]=1/t[1],yy[2]=1/t[2],(0,my.Fw)(this._aabb(),e,yy,n,r)}},{key:"createGeometry",value:function(){$_(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}},{key:"getDefaultVerticesPerSide",value:function(){return this.level<9?3:2}},{key:"updateCornerElevations",value:function(){!function(e,t){e.tile.intersectsClippingArea&&(ny(e),ty(e,!0),uy(e))}(this.renderData,this._horizontalScaleFactor)}},{key:"updateEdgeElevations",value:function(){!function(e,t){e.tile.intersectsClippingArea&&(ey(e),uy(e))}(this.renderData,this._horizontalScaleFactor)}}]),n}(b_),yy=(0,F.c)(),gy=n(82394),by=(0,l.Z)((function e(){(0,s.Z)(this,e),this.extent=(0,Wt.c)(),this.minLevel=0,this.maxLevel=0,this.callback=null})),wy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._queries=new Qd.Z({initialSize:10}),e._queriesInvPtr=0,e._queryQueue=new Qd.Z({initialSize:30}),e._queryPool=new zf.Z(by),e}return(0,l.Z)(n,[{key:"queryVisibleLevelRange",value:function(e,t,n,r){var i=this._queryPool.acquire();(0,Xt.c)(i.extent,e),i.minLevel=null!==t&&void 0!==t?t:-Number.MAX_VALUE,i.maxLevel=null!==n&&void 0!==n?n:Number.MAX_VALUE,i.callback=r,this._queryQueue.push(i),this.notifyChange("updating")}},{key:"updating",get:function(){return 0!==this._queryQueue.length}},{key:"prepare",value:function(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){var e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}},{key:"process",value:function(){for(var e=0;e<this._queries.length;e++){var t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}},{key:"queriesForTile",value:function(e){for(var t=e.level,n=0;n<this._queriesInvPtr;){var r=this._queries.data[n],i=r.extent;t>=r.minLevel&&t<=r.maxLevel&&i[0]<=e.extent[2]&&i[2]>=e.extent[0]&&i[1]<=e.extent[3]&&i[3]>=e.extent[1]?(this._queries.swapElements(n,this._queriesInvPtr-1),this._queriesInvPtr--):n++}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],wy.prototype,"updating",null),wy=(0,p._)([(0,L.j)("esri.views.3d.terrain.ScaleRangeQueries")],wy);var Cy=n(88699),xy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this))._convexHull=new Array(24),a._boundingSphere=(0,ea.c)(),void 0!==e&&a.init(e,r,i),a}return(0,l.Z)(n,[{key:"convexHull",get:function(){return this._convexHull}},{key:"init",value:function(e,t,r){(0,c.Z)((0,h.Z)(n.prototype),"init",this).call(this,e,t,r);var i=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],s=this.extentInRadians[2],l=this.extentInRadians[3],u=e[0],d=(0,Se.t7)(o,l,.5),f=(0,Se.t7)(a,s,.5),p=0===u?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(s-a)*Math.cos(p)*i,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=i-Math.sqrt(i*i-this._edgeLen2/4),(0,H.zP)(this.centerAtSeaLevel,f,d,this.ellipsoid.radius);var v=(0,F.d)(this.centerAtSeaLevel);(0,Gt.n)(v,v),this.up=v,this.updateRadiusAndCenter()}},{key:"updateRadiusAndCenter",value:function(){this._updateBoundingVolumes();var e=this._center;if(0===this.lij[0])(0,Gt.s)(e[x_.MIDDLE],0,0,0),(0,Gt.s)(e[x_.TOP],0,0,0),(0,Gt.s)(e[x_.BOTTOM],0,0,0),e[x_.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();for(var t=e[x_.MIDDLE],n=this.convexHull,r=0,i=0;i<8;++i)r=Math.max(r,Sy(t,n,3*i));e[x_.MIDDLE][3]=Math.sqrt(r)}}},{key:"_calculateFrustumVisibilityStatus",value:function(e){if(!(0,Tc.hr)(e,this._boundingSphere))return Cm.ir.OUTSIDE;if(this.lij[0]<10)return Cm.ir.INTERSECTS;for(var t=this.convexHull,n=this.surface.view.state.camera.near,r=!0,i=0;i<Tc.tc.NUM;i++){for(var a=i===Tc.Nu.NEAR,o=e[i],s=o[0],l=o[1],u=o[2],c=o[3]-(a?n:0),h=!1,d=0;d<8;++d){var f=3*d;if(s*t[f+0]+l*t[f+1]+u*t[f+2]+c<0){if(h=!0,!r)break}else r=!1}if(!h)return Cm.ir.OUTSIDE}return r?Cm.ir.INSIDE:Cm.ir.INTERSECTS}},{key:"computeElevationBounds",value:function(){(0,c.Z)((0,h.Z)(n.prototype),"computeElevationBounds",this).call(this),this._updateBoundingVolumes()}},{key:"createGeometry",value:function(){q_(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}},{key:"_updateBoundingVolumes",value:function(){this._updateConvexHull(),this._updateBoundingSphere(),hv.jt&&this._checkBVs()}},{key:"_updateBoundingSphere",value:function(){var e=this._boundingSphere,t=e,n=this.elevationBounds,r=this.ellipsoid.radius,i=n[1];if(0===this.level)(0,Gt.s)(t,0,0,0),e[3]=r+i;else{var a=this.extentInRadians,o=.5*(a[0]+a[2]),s=a[1],l=a[3];Py(Ay,o,s,r),Py(Ey,o,l,r),(0,Gt.a)(t,Ay,Ey);var u=.5*(n[0]+n[1]);(0,Gt.g)(t,t,(r+u)/(0,Gt.u)(t));for(var c=this.convexHull,h=0,d=function(e,t){var n=e[0]-c[3*t+0],r=e[1]-c[3*t+1],i=e[2]-c[3*t+2];return Math.sqrt(n*n+r*r+i*i)},f=0;f<8;++f){var p=d(t,f);h=Math.max(h,p)}var v=h;e[3]=v+2}}},{key:"_updateConvexHull",value:function(){var e=this,t=this.extentInRadians,n=this.ellipsoid.radius;if(0!==this.level){var r=this.elevationBounds,i=this._getPatchType(),a=this.surface.isWebMercator,o=a&&i===Cm.tk.HAS_NORTH_POLE,s=a&&i===Cm.tk.HAS_SOUTH_POLE,l=s||o,u=Math.PI/2,c=t[0],h=t[2],d=s?-u:t[1],f=o?u:t[3],p=.5*(c+h),v=r[0],m=n+(l?Math.min(0,v-1):v),_=function(e,t,n){return Py(e,t,n,m)},y=(0,F.c)(),g=(0,F.c)(),b=(0,F.c)(),w=(0,F.c)();_(y,c,d),_(g,c,f),_(b,h,f),_(w,h,d);var C=function(t,n){for(var r=0;r<3;++r)e._convexHull[3*n+r]=t[r]};C(y,0),C(g,1),C(b,2),C(w,3);var x=r[1],T=n+(l?Math.max(0,x+1):x),S=(0,F.c)(),k=(0,F.c)(),P=(0,F.c)();Py(k,p,f,m),Py(P,p,d,m),(0,Gt.a)(S,k,P),(0,Gt.n)(S,S);var R=(0,F.c)(),A=(0,F.c)(),E=function(e,t){(0,Gt.w)(A,e,t),(0,Gt.n)(A,A);var n=-(0,Gt.e)(e,R)/(0,Gt.e)(A,R);(0,hv.Fp)(n>=0),(0,Gt.g)(A,A,n),(0,Gt.a)(e,e,A)};if(Math.pow(2,this.lij[0])>2*this.lij[1]){var O=P,M=(0,F.c)();(0,Gt.f)(M,Ry,O),(0,Gt.n)(M,M),(0,Gt.f)(R,O,M),(0,Gt.n)(R,R),(0,hv.Fp)((0,hv.Wq)((0,Gt.e)(R,O)/(0,Gt.u)(O),0)),E(y,g),E(w,b),C(y,0),C(w,3)}else if(Math.pow(2,this.lij[0])!==2*this.lij[1]){var Z=k,I=(0,F.c)();(0,Gt.f)(I,Ry,Z),(0,Gt.n)(I,I),(0,Gt.f)(R,I,Z),(0,Gt.n)(R,R),E(g,y),E(b,w),C(g,1),C(b,2)}var D=function(t,n){for(var r=T/(0,Gt.e)(n,S),i=0;i<3;++i)e._convexHull[3*t+i]=n[i]*r};D(4,y),D(5,g),D(6,b),D(7,w)}}},{key:"_getPatchType",value:function(){var e=this.lij[1],t=0===e,n=e===(1<<this.level)-1;return t?n?Cm.tk.HAS_BOTH_POLES:Cm.tk.HAS_NORTH_POLE:n?Cm.tk.HAS_SOUTH_POLE:Cm.tk.REGULAR}},{key:"intersectsRay",value:function(e,t,n,r){var i=this._boundingSphere,a=i[3]+n,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=i[0]-e[0],l=i[1]-e[1],u=i[2]-e[2],c=(s*t[0]+l*t[1]+u*t[2])/o,h=t[0]*c-s,d=t[1]*c-l,f=t[2]*c-u;return h*h+d*d+f*f<a*a}},{key:"getDefaultVerticesPerSide",value:function(){return this.level<Ty.length?Ty[this.level]+1:2}},{key:"updateCornerElevations",value:function(){(function(e){e.tile.intersectsClippingArea&&(Q_(e),X_(e,!0),uy(e))})(this.renderData),this._updateBoundingVolumes()}},{key:"updateEdgeElevations",value:function(){(function(e){e.tile.intersectsClippingArea&&(Y_(e),uy(e))})(this.renderData),this._updateBoundingVolumes()}},{key:"_checkBVs",value:function(){if(hv.jt&&!(this.level<=2)){var e=this._boundingSphere,t=e[3],n=e,r=(0,F.c)(),i=this.ellipsoid.radius,a=this.elevationBounds;a[1],a[0];var o=i+a[0],s=this._center[x_.MIDDLE][3],l=this.convexHull,u=function(e,t){for(var n=0;n<3;++n)e[n]=l[3*t+n]},c=(0,F.c)(),h=(0,F.c)(),d=(0,F.c)(),f=(0,F.c)(),p=(0,F.c)(),v=function(e,t,n,r){u(h,e),u(d,t),u(f,n),(0,Gt.w)(h,h,d),(0,Gt.w)(f,f,d),(0,Gt.f)(c,h,f),(0,Gt.n)(c,c);var i=(0,Gt.e)(c,d);u(p,r);var a=(0,Gt.e)(c,p),o=Math.abs(a-i);(0,hv.Fp)((0,hv.Wq)(o,0),"Non coplanar ".concat(e,",").concat(t,",").concat(n,",").concat(r," diff = ").concat(o))};v(0,1,2,3),v(4,5,6,7),v(0,1,4,5),v(1,2,5,6),v(2,3,6,7),v(3,0,7,4);var m=(0,Cy.bg)(24),_=(0,F.c)(),y=(0,F.c)(),g=(0,F.c)(),b=(0,F.c)(),w=function(e,t,n,r){u(_,t),u(y,n),u(g,r),(0,Gt.w)(_,_,y),(0,Gt.n)(_,_),(0,Gt.w)(g,g,y),(0,Gt.n)(g,g),(0,Gt.f)(b,_,g),(0,Gt.n)(b,b);var i=(0,Gt.e)(b,y);!function(e,t,n){for(var r=4*e,i=0;i<3;++i)m[r+i]=t[i];m[r+3]=n}(e,b,i)};w(0,0,1,2),w(1,1,0,4),w(2,1,5,2),w(3,3,2,6),w(4,4,0,3),w(5,4,6,5);var C=function(e,t,n,r){var i=4*e;return m[i+0]*t+m[i+1]*n+m[i+2]*r-m[i+3]},x=function(e,t,n,r){return C(e,t,n,r)>=-1},T=function(e,t){return x(e,t[0],t[1],t[2])},S=Math.pow(2,this.lij[0])>2*this.lij[1],k=function(e,r,i){return Math.sqrt(ky(e,r,i,n[0],n[1],n[2]))<t},P=function(e){return k(e[0],e[1],e[2])},R=function(e,t){return k(e[t+0],e[t+1],e[t+2])},A=this.extentInRadians,E=.5*(A[0]+A[2]),O=A[1],M=A[3],Z=(0,F.c)(),I=(0,F.c)();Py(Z,E,M,o),Py(I,E,O,o);for(var D=S?"Upper":"Lower",L=!0,N=0;N<6;++N){for(var U=0;U<8;++U){var V=3*U,H=x(N,l[V+0],l[V+1],l[V+2]);L&&(L=H),(0,hv.Fp)(H,"Tile[".concat(this.lij,"] Convex hull point ").concat(U," outside of plane ").concat(N))}(0,hv.Fp)(T(N,I),"Tile[".concat(this.lij,"] (").concat(D,") bottom mid outside of plane ").concat(N)),(0,hv.Fp)(T(N,Z),"Tile[".concat(this.lij,"] (").concat(D,") top mid outside of plane ").concat(N))}(0,hv.Fp)(L,"Not all convex hull points are inside  convex hull polyhedron"),(0,hv.Fp)(P(I),"Tile[".concat(this.lij,"] (").concat(D,") bottom mid outside of bounding sphere")),(0,hv.Fp)(P(Z),"Tile[".concat(this.lij,"] (").concat(D,") top mid outside of bounding sphere"));for(var z=0;z<8;++z){var B=R(l,3*z);(0,hv.Fp)(B,"Tile[".concat(this.lij,"] Convex hull point ").concat(z," outside of bounding sphere"))}for(var G=0;G<6;++G)for(var W=0;W<8;++W){var j=3*W;x(G,l[j+0],l[j+1],l[j+2])||console.error("Tile[".concat(this.lij,"] Convex hull point ").concat(W," outside of plane ").concat(G))}var q=this.extentInRadians,Y=Math.max(q[2]-q[0],q[3]-q[1]),X=Math.round(Y*i),Q=this.renderData;if(Q){var J,K=Q.geometryInfo,$=Q.localOrigin,ee=null===(J=K.vertexAttributes)||void 0===J?void 0:J.position;if(!ee)return;for(var te=ee.count,ne=(0,F.c)(),re=K.numVerticesPerSide-2,ie=re*re,ae=Q.geometryState.neighborData,oe=ae.edgeResolutions.reduce((function(e,t){return e+t+1}),0),se=0;se<te;++se){var le=se<ie,ue=!le&&se<ie+oe,ce=!1,he=-1;if(ue)for(var de=ie,fe=0;fe<4;++fe){var pe=ae.edgeResolutions[fe];if(se===de||se===de+pe-1){ce=!0;break}if(se<(de+=pe)){he=fe;break}}var ve=he,me=ce,_e=ue&&!me,ye=ue?ae.edgePeerNeighbors[ve]:null,ge=ue&&ye&&(0,i_.gl)(this,ye)>0,be=le?"internal":_e?"edge":me?"corner":"pole";ee.getVec(se,r),(0,Gt.a)(ne,r,$);var we=(0,Gt.u)(ne)-i,Ce=0,xe=!1,Te=a[0]-we,Se=we-a[1],ke=Te>1,Pe=Se>1,Re=ke||Pe,Ae="Tile[".concat(this.lij,"].vertex[").concat(se,"]:").concat(be)+(ke?"(below)":Pe?"(above)":"")+(ge?"(Neighbor)":""),Ee=(0,Gt.j)(ne,n);if(Ee>=t+0){var Oe=Ee-t;Re||(console.error("".concat(Ae," is out of the bounding sphere by ").concat(Oe.toFixed(0)," / ").concat(t.toFixed(0),"[tol=").concat(0,"] h=").concat(we.toFixed(0)," / [").concat(a[0].toFixed(0),"..").concat(a[1].toFixed(0),"] (").concat((Oe/t).toFixed(0),")")),xe=!0)}for(var Me=0;Me<6;++Me)if(!x(Me,ne[0],ne[1],ne[2])){var Ze=C(Me,ne[0],ne[1],ne[2]),Ie=se%re,De=(se-Ie)/re;0===Me&&Te||5===Me&&Se||(console.error("".concat(Ae," (").concat(Ie,",").concat(De,")|").concat(re,"] is out of the bounding trapezoid plane ").concat(Me," h=").concat(Math.round(we)," / [").concat(Math.round(a[0]),"..").concat(Math.round(a[1]),"] dist=").concat(Math.round(Ze)," radii = ").concat(Math.round(t),"/").concat(Math.round(s),"} : maxL = ").concat(X)),++Ce)}if(xe||Ce>0)break}}}}}]),n}(b_),Ty=[128,64,64,32,16,8,8,4];function Sy(e,t,n){return ky(e[0],e[1],e[2],t[n+0],t[n+1],t[n+2])}function ky(e,t,n,r,i,a){var o=r-e,s=i-t,l=a-n;return o*o+s*s+l*l}var Py=function(e,t,n,r){var i=Math.cos(t),a=Math.sin(t),o=Math.cos(n),s=Math.sin(n);e[0]=r*o*i,e[1]=r*o*a,e[2]=r*s},Ry=[0,0,1],Ay=(0,F.c)(),Ey=(0,F.c)(),Oy=(0,l.Z)((function e(){(0,s.Z)(this,e),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0})),My=n(25158),Zy=n(1883),Iy=n(35600),Dy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).blendMode=Iy.iM.Normal,e}return(0,l.Z)(n)}(un.m);(0,p._)([(0,un.o)({count:Iy.iM.COUNT})],Dy.prototype,"blendMode",void 0);var Ly=n(63434),Ny=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).output=Ly.lG.Composite,e.baseOpacityMode=Ly.Iu.NotRequired,e.premultipliedSource=Ly.m9.Off,e.hasWebGL2Context=!1,e}return(0,l.Z)(n)}(Dy);(0,p._)([(0,un.o)({count:Ly.lG.COUNT})],Ny.prototype,"output",void 0),(0,p._)([(0,un.o)({count:Ly.Iu.COUNT})],Ny.prototype,"baseOpacityMode",void 0),(0,p._)([(0,un.o)()],Ny.prototype,"premultipliedSource",void 0),(0,p._)([(0,un.o)()],Ny.prototype,"hasWebGL2Context",void 0);var Fy=n(32426),Uy=n(86868),Vy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).opacity=1,e.baseOpacity=1,e.texture=null,e.fboTexture=null,e.backgroundColor=F.Z,e}return(0,l.Z)(n)}(Fy.R),Hy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===I_.zO.WEBGL2}},{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.if)(an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK})}}]),n}(tn.A);Hy.shader=new en.J(Uy.B,(function(){return n.e(96654).then(n.bind(n,96654))}));var zy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).background=Uy.a.BelowLayer,e}return(0,l.Z)(n)}(Ny);(0,p._)([(0,un.o)()],zy.prototype,"background",void 0);var By=function(){function e(t,n,r,i,a,o){(0,s.Z)(this,e),this.texture=t,this.type=n,t.retain(),this.offsetAndScale=(0,Wt.f)(r.offset[0],r.offset[1],r.scale,r.scale),this.opacities=(0,F.f)(i,a,o)}return(0,l.Z)(e,[{key:"destroy",value:function(){this.texture.release()}}]),e}(),Gy=n(39395),Wy=n(29931),jy=function(){function e(){(0,s.Z)(this,e),this._renderParams={context:null,drawPhase:1,state:new Wy.Z({viewpoint:new _.Z({targetGeometry:new _i.Z(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null}}return(0,l.Z)(e,[{key:"dispose",value:function(){this._renderParams=null}},{key:"render",value:function(e,t,n,r,i,a,o,s,l,u){var c=a.adjustLevel(t[0]),h=this._renderParams;h.context=e,h.painter=r,h.glyphMosaic=r.glyphMosaic,h.spriteMosaic=r.spriteMosaic,h.pixelRatio=u,h.displayLevel=c,h.requiredLevel=c;var d=a.getScale(t[0]),f=a.getShift(t,o*d),p=(0,ns.Z)(f,2),v=p[0],m=p[1],_=.125*o*d/l,y=n.transforms.dvs;y[0]=_,y[4]=-_,y[6]=-1-v-s[0]*o*2,y[7]=1+m+(1-s[1])*o*2-2,h.state.size[0]=l,h.state.size[1]=l,n.stage||n.attachWithContext(e),n.triangleCount=0,r.drawTile(h,n,i)}}]),e}(),qy=n(87016),Yy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===I_.zO.WEBGL2}},{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.if)(an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK})}}]),n}(tn.A);Yy.shader=new en.J(qy.R,(function(){return n.e(11454).then(n.bind(n,11454))}));var Xy=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).colorizerType=Gy.U.Stretch,e.stretchType=Gy.H.Noop,e.applyColormap=!0,e}return(0,l.Z)(n)}(Ny);(0,p._)([(0,un.o)({count:Gy.U.COUNT})],Xy.prototype,"colorizerType",void 0),(0,p._)([(0,un.o)({count:Gy.H.COUNT})],Xy.prototype,"stretchType",void 0),(0,p._)([(0,un.o)()],Xy.prototype,"applyColormap",void 0);var Qy=function(){function e(t){(0,s.Z)(this,e),this._rctx=t,this._fbos=new Map}return(0,l.Z)(e,[{key:"get",value:function(e){return this._getPool(e)}},{key:"dispose",value:function(){this._fbos.forEach((function(e){return e.dispose()})),this._fbos.clear()}},{key:"_getPool",value:function(e){var t=this._fbos.get(e);if(t)return t;var n=new Mn.X(this._rctx,{colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.DEPTH_RENDER_BUFFER,width:e,height:e});return this._fbos.set(e,n),n}}]),e}(),Jy=S.Z.getLogger("esri.views.3d.terrain"),Ky=function(){function e(t,n){(0,s.Z)(this,e),this._rctx=t,this._techniqueRepository=n,this._fbos=[],this._vectorTileHelper=new jy,this._bindParameters=new In.p(null,null,null),this._blendLayersTechniqueConfig=new zy,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,dn.ow)(this._rctx,hn.Bn)}return(0,l.Z)(e,[{key:"dispose",value:function(){this._fbos.forEach(k.M2),this._fbos=null,this._vtFBO=(0,k.M2)(this._vtFBO),this._vaoQuad=(0,k.M2)(this._vaoQuad),this._vectorTileHelper=(0,k.M2)(this._vectorTileHelper),this._backgroundTechnique=(0,k.RY)(this._backgroundTechnique),this._applyOpacityTechnique=(0,k.RY)(this._applyOpacityTechnique),this._blendLayersTechnique=(0,k.RY)(this._blendLayersTechnique)}},{key:"_getBlendLayersTechnique",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ly.m9.Off,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Uy.a.BelowLayer;return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=n,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechniqueConfig.background=i,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(Hy,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}},{key:"drawBackground",value:function(e,t){var n=this._getBlendLayersTechnique(Iy.iM.Normal,t?Ly.lG.ColorComposite:Ly.lG.GridComposite,Ly.Iu.NotRequired,Ly.m9.Off,Uy.a.Only),r=this._rctx.bindTechnique(n,e,this._bindParameters);this._render(r)}},{key:"_render",value:function(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(an.MX.TRIANGLE_STRIP,0,(0,ir._V)(this._vaoQuad,"geometry"))}},{key:"drawGroup",value:function(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ly.m9.On;t===Ly.lG.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(n).colorTexture),e.texture=this.currentFBO(n).colorTexture,this.closeGroup(n);var o=this._getBlendLayersTechnique(r,t,i,a),s=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(s)}},{key:"drawRasterData",value:function(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:Ly.m9.Off;if(!(0,k.Wi)(e.texture)){e.fboTexture=t===Ly.lG.GroupBackgroundComposite||r===Iy.iM.Normal&&i===Ly.Iu.NotRequired&&a===Ly.m9.Off?null:this.switch(n).colorTexture;var o=this._getBlendLayersTechnique(r,t,i,a),s=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(s)}}},{key:"drawImageryTileData",value:function(e,t,n,r,i,a){var o=a.sourceLayerInfo.data;if(o.source&&(a.tile.surface.layerViewByIndex(a.layerIndex,wm.MAP).ensureSymbolizerParameters(o),o.bind(this._rctx))){e.fboTexture=r===Iy.iM.Normal&&i===Ly.Iu.NotRequired?null:this.switch(n).colorTexture;var s=this._getRasterColorizerTechnique(o,t,r,i);o.opacity=e.opacity;var l=o.getUniforms();l.scale=a.scale,l.offset=a.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;var u=this._rctx.bindTechnique(s,l,null);this._render(u)}}},{key:"_getRasterColorizerTechnique",value:function(e,t,n,r){var i=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(i.type);return(0,k.Wi)(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new Xy,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=n,this._rasterColorizerConfig.baseOpacityMode=r,this._rasterColorizerConfig.colorizerType=a,this._rasterColorizerConfig.applyColormap=!!i.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?Gy.H.Noop:Gy.H.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(Yy,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}},{key:"drawVectorData",value:function(e,t,n,r,i,a,o,s,l){var u=this._rctx,c=a.sourceLayerInfo.data,h=a.tile.surface.layerViewByIndex(a.layerIndex,wm.MAP),d=i===Ly.Iu.Required||e.opacity<1||r!==Iy.iM.Normal||t!==Ly.lG.Composite,f=d?Ly.m9.On:Ly.m9.Off;this._getBlendLayersTechnique(r,t,i,f).bindPipelineState(u);var p=null,v=null;d?(v=this.currentFBO(n),(0,k.Wi)(this._vtFBO)&&(this._vtFBO=new Qy(this._rctx)),p=this._vtFBO.get(n),u.bindFramebuffer(p),this._clearCurrentFBO()):l&&u.clearSafe(an.lk.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(u,a.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/a.scale),a.offset,s,o)}catch(Br){Jy.warnOnce("A render call containing vector tiles did not resolve correctly.",Br)}return!(0,k.pC)(p)||(u.bindFramebuffer(v),e.texture=p.colorTexture,e.offset=Jt.Z,e.scale=1,this.drawRasterData(e,t,n,r,i,f),l)}},{key:"copyFBOToTexture",value:function(e){var t=this._rctx,n=t.bindTexture(e.texture,rr.x.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(an.No.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(n,rr.x.TEXTURE_UNIT_FOR_UPDATES)}},{key:"_clearCurrentFBO",value:function(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(an.lk.COLOR_BUFFER_BIT|an.lk.DEPTH_BUFFER_BIT)}},{key:"_initFBO",value:function(e,t,n){this._rctx.bindFramebuffer(e),n&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}},{key:"ensureBuffer",value:function(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}},{key:"bind",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(this._current=t,t>=this._fbos.length)for(var r=this._fbos.length;r<=t;r++)this._fbos.push(new Qy(this._rctx));this._initFBO(this._fbos[t].get(e),e,n)}},{key:"_bindNextFreeBuffer",value:function(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}},{key:"openGroup",value:function(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}},{key:"switch",value:function(e){var t=this.currentFBO(e),n=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(n),t}},{key:"getLastOnHoldId",value:function(){return this._onHoldIds[this._onHoldIds.length-1]}},{key:"closeGroup",value:function(e){var t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}},{key:"unbind",value:function(){this._rctx.bindFramebuffer(null)}},{key:"currentFBO",value:function(e){return this._fbos[this._current].get(e)}}]),e}(),$y=(0,l.Z)((function e(t,n,r,i){(0,s.Z)(this,e),this.start=t,this.end=n,this.blendMode=r,this.opacity=i})),eg=function(){function e(t,n,r){(0,s.Z)(this,e),this._rctx=t,this.tileSize=n,this._techniqueRepository=r,this._passParameters=new Vy,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new Ky(this._rctx,this._techniqueRepository),this._blackTex=new m_((0,dn.YO)(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}return(0,l.Z)(e,[{key:"dispose",value:function(){this._composition=(0,k.M2)(this._composition),this._backgroundTexture=(0,k.RY)(this._backgroundTexture),this._blackTex=(0,k.RY)(this._blackTex)}},{key:"backgroundIsGrid",get:function(){return(0,k.Wi)(this._backgroundColor)}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"updateTileTexture",value:function(e,t){if(e.renderData){var n=e.surface,r=n.baseOpacity,i=0,a=0,o=this.tileSize,s=!1,l=n.view.state.contentPixelRatio,u=!1;lg.clear(),ug.length=0;for(var c=e.layerInfo[wm.MAP],h=c.length,d=0;d<c.length;d++){var f=n.layerViewByIndex(d,wm.MAP),p=f.layer.opacity;ag[d]=p;var v=f.fullOpacity;if(og[d]=v,(0,q.sy)(f.layer)&&h>=c.length&&(h=d),(0,hv.TK)(f)){sg[d]=f.layer.blendMode;var m="normal"!==f.layer.blendMode;if((0,q.CY)(f.layer.parent)){var _=ng(f.layer.parent);(0,k.pC)(_)&&""!==_&&(m=rg(f.layer.parent)||m)}m&&(u=m,s=!1)}if(0!==p||u){++a;var y=tg(e,d);if(y){if(c[d].pendingUpdates&=~(v_.TEXTURE_NOFADING&v_.TEXTURE_FADING),(0,q.CY)(f.layer.parent)){var g=ng(f.layer.parent);(0,k.pC)(g)&&""!==g&&ig(f.layer.parent,d)}(0,hv.Q)(f)?o=Math.max(o,this.tileSize*l):1===r&&1===v&&(f.isOpaque||this._dataToTexture(y)&&y.sourceLayerInfo.data.descriptor.isOpaque)&&(s=!0),++i}}else c[d].pendingUpdates&=~(v_.TEXTURE_NOFADING&v_.TEXTURE_FADING)}this._rctx.type===I_.zO.WEBGL1&&(o=function(e){var t=(0,Se.Sf)(e),n=t*t,r=e*e;if(n===r)return e;var i=t/2;return n-r<r-i*i?t:i}(o));var b=o/this.tileSize,w=d-1;this._ensureBackgroundTexture(this.tileSize),0!==i?1===i&&!u&&this._useLayerTexture(e,w,h,og[w])||this._composeMapLayers(e,t,w,h,ag,sg,o,b,!s||u,lg,u):this._useBackgroundTexture(e,a)}}},{key:"_ensureBackgroundTexture",value:function(e){(0,k.Wi)(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=Jt.Z,this._passParameters.scale=1,this._passParameters.opacity=1,(0,k.pC)(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,(0,k.pC)(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}},{key:"_useBackgroundTexture",value:function(e,t){var n=Qm.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(n=Qm.Delayed);var r=e.renderData;this._backgroundTexture&&(0,k.Wi)(r.textureReference)&&(n=Qm.Immediate),r.setTextureReference((0,k.pC)(this._backgroundTexture)?new By(this._backgroundTexture,Cm.Ns.FADING,hg,e.surface.baseOpacity,0,1):null,n)}},{key:"_useLayerTexture",value:function(e,t,n,r){var i=t<n,a=i?1:e.surface.baseOpacity,o=i?e.surface.baseOpacity:1,s=tg(e,t);return!!this._dataToTexture(s)&&(e.renderData.setTextureReference(new By(s.sourceLayerInfo.data,Cm.Ns.FADING,s,a,o,r)),!0)}},{key:"_composeMapLayers",value:function(e,t,n,r,i,a,o,s,l,u,c){var h=this;this._composition.ensureBuffer(o);for(var d=e.surface.baseOpacity,f=!1,p=an.cw.LINEAR_MIPMAP_LINEAR,v=!1,m=0,_=function(t){var n=tg(e,t);if(!n)return"continue";if(0===i[t]&&!c)return"continue";var _=t<r&&d<1&&!f;h._passParameters.baseOpacity=_?d:1;var y=h._passParameters.baseOpacity<1?Ly.Iu.Required:Ly.Iu.NotRequired;_&&(f=!0);var g=!1;u.forEach((function(e){e.start===t&&(ug.push(e),h._composition.openGroup(o),g=!0)}));var b=0===m,w=g?Ly.lG.GroupBackgroundComposite:l&&b?h.backgroundIsGrid?Ly.lG.GridComposite:Ly.lG.ColorComposite:Ly.lG.Composite,C=Iy.pU[a[t]];for((0,hv.Ke)(n)?(h._passParameters.opacity=i[t],v=h._composition.drawVectorData(h._passParameters,w,o,C,y,n,s,h.tileSize,v)):(0,hv.Ay)(n)?(h._passParameters.opacity=i[t],h._composition.drawImageryTileData(h._passParameters,w,o,C,y,n),h._hasNearestInterpolation(n)&&(p=an.cw.NEAREST)):h._dataToTexture(n)&&(h._passParameters.texture=n.sourceLayerInfo.data.texture,h._passParameters.offset=n.offset,h._passParameters.scale=n.scale,h._passParameters.opacity=i[t],h._composition.drawRasterData(h._passParameters,w,o,C,y));ug.length>0&&ug[ug.length-1].end===t;){var x=ug.pop();h._passParameters.opacity=x.opacity,h._passParameters.offset=Jt.Z,h._passParameters.scale=1;var T=l&&b?h.backgroundIsGrid?Ly.lG.GridComposite:Ly.lG.ColorComposite:Ly.lG.Composite;h._composition.drawGroup(h._passParameters,T,o,Iy.pU[x.blendMode],y)}m++},y=n;y>=0;y--)_(y);var g=e.renderData,b=g.ensureTexture(o,(function(){return h._buildTexture(o,p)}));this._composition.copyFBOToTexture(b),this._composition.unbind(),g.setTextureReference(new By(b,t,hg,f?1:d,0,1))}},{key:"_hasNearestInterpolation",value:function(e){var t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}},{key:"_dataToTexture",value:function(e){if((0,hv.L4)(e)){var t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return(0,hv.z7)(e)}},{key:"setBackground",value:function(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}},{key:"_buildTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:an.cw.LINEAR_MIPMAP_LINEAR;if((0,k.Wi)(e))return null;var n,r={target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,preMultiplyAlpha:!0,flipped:!0,hasMipmap:!0},i=this._rctx;if("number"==typeof e)r.width=r.height=e,n=new m_(new rr.x(i,r));else if(e instanceof sv.nN)r.isOpaque=e.isOpaque,n=new m_(new rr.x(i,r,e.image)),e.release();else try{r.width=e.width,r.height=e.height,n=new m_(new rr.x(i,r,e))}catch(o){n=new m_((0,dn.l_)(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}var a=i.bindTexture(n.texture,rr.x.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),i.bindTexture(a,rr.x.TEXTURE_UNIT_FOR_UPDATES),n}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]),e}();function tg(e,t){cg.layerIndex=t;var n=e.layerInfo[wm.MAP][t];if((0,k.pC)(n.data))return(0,Yt.s)(cg.offset,0,0),cg.tile=e,cg.scale=1,cg.sourceLod=e.lij,cg.sourceLayerInfo=n,cg;var r=n.upsampleInfo;if((0,k.pC)(r)){var i=r.tile.layerInfo[wm.MAP][t];return cg.tile=r.tile,(0,Yt.c)(cg.offset,r.offset),cg.scale=r.scale,cg.sourceLod=r.tile.lij,cg.sourceLayerInfo=i,cg}return null}function ng(e){return e.get("uid")}function rg(e){var t="normal"!==e.blendMode;return(0,q.CY)(e.parent)&&(t=rg(e.parent)||t),t}function ig(e,t){(0,q.CY)(e.parent)&&ig(e.parent,t);var n=ng(e);if((0,k.pC)(n)&&""!==n){var r=lg.get(n);r?r.start=t:lg.set(n,new $y(t,t,e.blendMode,e.opacity))}}var ag=new Array,og=new Array,sg=new Array,lg=new Map,ug=new Array,cg={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},hg={offset:[0,0],scale:1},dg=1e-6;var fg=(0,l.Z)((function e(t,n,r,i,a){(0,s.Z)(this,e),this.aabb=t,this.axis=n,this.d=r,this.midStartIndex=i,this.rightStartIndex=a})),pg=function(){function e(t,n,r,i){var a=this;(0,s.Z)(this,e),this.globalTriangleVertexIndices=t,this.firstTriangleIndex=n,this.positionAttribute=i,this._rayDirection=(0,F.c)(),this.bspNodeTree=new Array;var o=r-n,l=o<=yg?new Uint16Array(o):new Uint32Array(o);this.indices=l;for(var u=0;u<o;++u)l[u]=u;var c=function(e,t,n,r,i){for(var a=n-t,o=new Float32Array(6*a),s=0;s<a;++s)for(var l=3*(s+t),u=e[l+0]*i,c=e[l+1]*i,h=e[l+2]*i,d=0;d<3;++d){var f=r[u+d],p=r[c+d],v=r[h+d];o[6*s+d]=Math.min(f,p,v),o[6*s+3+d]=Math.max(f,p,v)}return o}(t,n,r,i.data,i.stride),h=(0,Se.uZ)(Math.log2(o/40),2,10);(function e(t,n,r){var i=function(e,t,n,r){if(r<=n)return(0,xc.al)(NaN,NaN,NaN,NaN,NaN,NaN);for(var i=6*e[n],a=0;a<3;++a)mg[a]=t[i+0+a],_g[a]=t[i+3+a];for(var o=n+1;o<r;++o)for(var s=6*e[o],l=0;l<3;++l)mg[l]=Math.min(mg[l],t[s+0+l]),_g[l]=Math.max(_g[l],t[s+3+l]);return(0,xc.al)(mg[0],mg[1],mg[2],_g[0],_g[1],_g[2])}(l,c,t,n),o=n-t;if(o<=40){var s=new fg(i,void 0,0,t,n);return a.bspNodeTree.push(s),s}var u=function(e){var t=e[3]-e[0],n=e[4]-e[1],r=e[5]-e[2],i=t>n?t>r?0:n>r?1:2:n>r?1:r>t?2:0;return{axis:i,midValue:(e[i]+e[i+3])/2}}(i),d=u.axis,f=u.midValue,p=function(e,t,n,r,i,a){for(var o=n,s=r;o<s;){var l=e[o];t[6*l+i+3]<=a?++o:(--s,e[o]=e[s],e[s]=l)}var u=o;for(s=r;u<s;){var c=e[s-1];t[6*c+i]>=a?--s:(e[s-1]=e[u],e[u]=c,++u)}return{next:o,mid:u}}(l,c,t,n,d,f),v=function(t,n){if(!(r>h)){var i=n-t;return i<40||i>=.8*o?void 0:e(t,n,r+1)}},m=new fg(i,d,f,p.next,p.mid);return a.bspNodeTree.push(m),m.leftNode=v(t,p.next),m.rightNode=v(p.mid,n),m})(0,o,0),this.triangleVertexIndices=function(e,t,n,r){for(var i=r-n,a=0,o=n;o<r;++o)for(var s=0;s<3;++s)a=Math.max(t[3*o+s],a);for(var l=a<=yg?new Uint16Array(3*i):new Uint32Array(3*i),u=0;u<i;++u)for(var c=3*(e[u]+n),h=0;h<3;++h){var d=t[c+h];l[3*u+h]=d}return l}(l,t,n,r)}return(0,l.Z)(e,[{key:"intersectRayTriangleRange",value:function(t,n){if(!(t>=n)){for(var r=this.triangleVertexIndices,i=this.positionAttribute.data,a=this.positionAttribute.stride,o=this._rayOrigin,s=o[0],l=o[1],u=o[2],c=this._rayDirection,h=c[0],d=c[1],f=c[2],p=t,v=3*t;p<n;++p){var m=r[v++]*a,_=i[m++],y=i[m++],g=i[m];m=r[v++]*a;var b=i[m++],w=i[m++],C=i[m];m=r[v++]*a;var x=b-_,T=w-y,S=C-g,k=i[m++]-_,P=i[m++]-y,R=i[m]-g,A=d*R-P*f,E=f*k-R*h,O=h*P-k*d,M=x*A+T*E+S*O;if(!(Math.abs(M)<=Number.EPSILON)){var Z=s-_,I=l-y,D=u-g,L=Z*A+I*E+D*O;if(M>0){if(L<0||L>M)continue}else if(L>0||L<M)continue;var N=I*S-T*D,F=D*x-S*Z,U=Z*T-x*I,V=h*N+d*F+f*U;if(M>0){if(V<0||L+V>M)continue}else if(V>0||L+V<M)continue;var H=(k*N+P*F+R*U)/M;if(H>=0){var z=this.indices[p]+this.firstTriangleIndex,B=(0,my.Mw)(x,T,S,k,P,R,vg);this._callback(H,B,z,!1)}}}e.numFacesTested+=n-t}}},{key:"intersectRay",value:function(t,n){e.numFacesTested=0;var r=(0,F.f)(t.r0[0],t.r0[1],t.r0[2]),i=(0,F.f)(t.r1[0],t.r1[1],t.r1[2]),a=i[0]-r[0],o=i[1]-r[1],s=i[2]-r[2];if(!(a*a+o*o+s*s<dg)){this._rayOrigin=r;var l=this._rayDirection;l[0]=a,l[1]=o,l[2]=s;var u=this.triangleVertexIndices.length/3;this._callback=n;var c=this.bspNodeTree[0];this.intersectRayBSP(c,0,u)}}},{key:"intersectRayBSP",value:function(e,t,n){var r=this._rayOrigin,i=this._rayDirection;if(function(e,t,n){for(var r=t,i=n,a=0,o=1/0,s=0;s<3;++s){var l=e[s];if(r[s]<l){if(i[s]<=dg)return!1;var u=(l-r[s])/i[s];a=Math.max(a,u)}else if(i[s]<=-1e-6){var c=(l-r[s])/i[s];o=Math.min(o,c)}if(a>o)return!1;var h=e[s+3];if(r[s]>h){if(i[s]>=-1e-6)return!1;var d=(h-r[s])/i[s];a=Math.max(a,d)}else if(i[s]>=dg){var f=(h-r[s])/i[s];o=Math.min(o,f)}if(a>o)return!1}return!0}(e.aabb,r,i)){var a=e.axis,o=e.d;if(r[a]<o||i[a]<0){var s=t,l=e.midStartIndex;if(s<l){var u=e.leftNode;void 0!==u?this.intersectRayBSP(u,s,l):this.intersectRayTriangleRange(s,l)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[a]>o||i[a]>0){var c=e.rightStartIndex,h=n;if(c<h){var d=e.rightNode;void 0!==d?this.intersectRayBSP(d,c,h):this.intersectRayTriangleRange(c,h)}}}}},{key:"estimatedMemoryUsage",get:function(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}]),e}();pg.numFacesTested=0;var vg=(0,F.c)(),mg=[1/0,1/0,1/0],_g=[-1/0,-1/0,-1/0];var yg=65535,gg=n(22702),bg=n(55375),wg=n(91526),Cg=n(73059),xg=n(73782),Tg=n(60113),Sg=n(41481),kg=n(8883),Pg=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).output=li.H.Color,e.overlayMode=gg.gT.Disabled,e.tileBlendInput=bg.R.LayerOnly,e.spherical=!1,e.doublePrecisionRequiresObfuscation=!1,e.atmosphere=!1,e.receiveShadows=!1,e.hasSlicePlane=!1,e.backfaceCullingEnabled=!1,e.stencilEnabled=!1,e.textureFadingEnabled=!1,e.renderOccluded=!1,e.hasScreenSpaceReflections=!1,e.hasCloudsReflections=!1,e.shading=!Jd.Z.TERRAIN_USE_LEGACY_SHADING,e.useLegacyTerrainShading=Jd.Z.TERRAIN_USE_LEGACY_SHADING,e.invisible=!1,e.tileBorders=!1,e.visualizeNormals=!1,e.screenSizePerspective=!1,e.receiveAmbientOcclusion=!1,e.pbrMode=Sg.f7.Terrain,e}return(0,l.Z)(n)}(kg.W);(0,p._)([(0,un.o)({count:li.H.COUNT})],Pg.prototype,"output",void 0),(0,p._)([(0,un.o)({count:gg.gT.COUNT})],Pg.prototype,"overlayMode",void 0),(0,p._)([(0,un.o)({count:bg.R.COUNT})],Pg.prototype,"tileBlendInput",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"spherical",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"atmosphere",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"receiveShadows",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"hasSlicePlane",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"backfaceCullingEnabled",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"stencilEnabled",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"textureFadingEnabled",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"renderOccluded",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"hasScreenSpaceReflections",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"hasCloudsReflections",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"shading",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"useLegacyTerrainShading",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"invisible",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"tileBorders",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"visualizeNormals",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"screenSizePerspective",void 0),(0,p._)([(0,un.o)()],Pg.prototype,"receiveAmbientOcclusion",void 0),(0,p._)([(0,un.o)({count:Sg.f7.COUNT})],Pg.prototype,"pbrMode",void 0),(0,p._)([(0,un.o)({constValue:xg.h.CompressedAttribute})],Pg.prototype,"normalType",void 0),(0,p._)([(0,un.o)({constValue:Tg.N.Compressed})],Pg.prototype,"textureCoordinateType",void 0),(0,p._)([(0,un.o)({constValue:!1})],Pg.prototype,"highStepCount",void 0),(0,p._)([(0,un.o)({constValue:!1})],Pg.prototype,"useCustomDTRExponentForWater",void 0),(0,p._)([(0,un.o)({constValue:!1})],Pg.prototype,"useFillLights",void 0);var Rg,Ag=(0,xc.Ue)();!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.TransparentWithDraped=2]="TransparentWithDraped",e[e.Empty=3]="Empty"}(Rg||(Rg={}));var Eg=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).type=wp.q7.TERRAIN,r.isGround=!0,r._tileSize=256,r._techniqueConfiguration=new Pg,r._passParameters=new M_.T,r._rctx=null,r._renderDataPool=new zf.Z(N_),r._patchGroups=new Map,r._patchGroupsDirty=!0,r._patchSortingDirty=!0,r._tileIterator=new i_.AA,r._highestVisibleLODTile=null,r._visible=!0,r._transparencyState=Rg.Opaque,r._velvetOverground=!0,r._castShadows=!0,r._emptyTex=null,r._tileRenderer=null,r._stencilEnabledLayerExtents=new Array,r._numTilesRendered=0,r._numTilesCulled=0,r._numOriginsRendered=0,r.needsHighlight=!1,r.renderOccludedFlags=km.yD.Occlude,r}return(0,l.Z)(n,[{key:"_isGlobal",get:function(){return this._stage.viewingMode===he.JY.Global}},{key:"shading",get:function(){return this._techniqueConfiguration.shading},set:function(e){this._techniqueConfiguration.shading=e}},{key:"initialize",value:function(){var e=[ci.r.OPAQUE_TERRAIN,ci.r.TRANSPARENT_TERRAIN,ci.r.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}},{key:"destroy",value:function(){this._stage.removeRenderPlugin(this),Bm.clear()}},{key:"canRender",get:function(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}},{key:"renderingDisabled",set:function(e){this._set("renderingDisabled",!!e),this.setDirty()}},{key:"transparency",get:function(){return this._transparencyState},set:function(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===Rg.TransparentWithDraped||e===Rg.Empty,this._transparencyState=e,this.setNeedsRender())}},{key:"needsLinearDepth",get:function(){return this._overlayRenderer.hasWater}},{key:"renderPatchBorders",get:function(){return!!this._techniqueConfiguration.tileBorders},set:function(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}},{key:"visualizeNormals",get:function(){return!!this._techniqueConfiguration.visualizeNormals},set:function(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}},{key:"cullBackFaces",get:function(){return this._techniqueConfiguration.backfaceCullingEnabled},set:function(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}},{key:"renderOrder",set:function(e){this._set("renderOrder",e),this._setSortingDirty()}},{key:"velvetOverground",set:function(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}},{key:"layerUid",get:function(){return Gs.cy}},{key:"slicePlaneEnabled",get:function(){return this._techniqueConfiguration.hasSlicePlane},set:function(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}},{key:"textureFadingEnabled",set:function(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}},{key:"pbrMode",set:function(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}},{key:"setDebugScreenSizePerspective",value:function(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}},{key:"setRootTiles",value:function(e){this._rootTiles=e,this.setDirty()}},{key:"setNeedsHighlight",value:function(e){this.needsHighlight=e,this.setNeedsRender()}},{key:"setRenderOccludedOverlay",value:function(e){this.renderOccludedFlags=e?Tm.Qi:km.yD.Occlude,this.setNeedsRender()}},{key:"setStencilEnabledLayerExtents",value:function(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}},{key:"setTileSize",value:function(e){this._tileSize=e,(0,k.pC)(this._tileRenderer)&&(this._tileRenderer.tileSize=e),this.setDirty()}},{key:"_prepareTileForLoading",value:function(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}},{key:"loadTile",value:function(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,v_.TEXTURE_FADING)}},{key:"updateTileTexture",value:function(e,t){(0,k.pC)(this._tileRenderer)&&(this._tileRenderer.updateTileTexture(e,t===v_.TEXTURE_FADING?Cm.Ns.FADING:Cm.Ns.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}},{key:"updateTileGeometryState",value:function(e){var t,n=(0,i.Z)(e.layerInfo[wm.ELEVATION]);try{for(n.s();!(t=n.n()).done;){t.value.pendingUpdates&=~v_.GEOMETRY}}catch(a){n.e(a)}finally{n.f()}e.resetPendingUpdate(v_.GEOMETRY);var r=e.renderData.updateGeometryState();return r&&this.setDirty(),r}},{key:"updateGeometryIfNeeded",value:function(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}},{key:"unloadTile",value:function(e){var t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}},{key:"_getLocalOriginOfTile",value:function(e){var t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return F.Z;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}},{key:"setVisibility",value:function(e){this._visible=e,this.setDirty()}},{key:"getStats",value:function(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}},{key:"wireframe",set:function(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}},{key:"setDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bv.Xx.UPDATE;this._patchGroupsDirty=!0,this._context.requestRender(e)}},{key:"_setSortingDirty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bv.Xx.UPDATE;this._patchSortingDirty=!0,this._context.requestRender(e)}},{key:"setNeedsRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bv.Xx.UPDATE;this._context.requestRender(e)}},{key:"initializeRenderContext",value:function(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.techniqueRepository,this._tileRenderer=new eg(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=(0,dn.l_)(this._rctx)}},{key:"uninitializeRenderContext",value:function(){this._emptyTex=(0,k.M2)(this._emptyTex),this._tileRenderer=(0,k.M2)(this._tileRenderer)}},{key:"intersect",value:function(e,t,n,r){var i=this;if(!(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==Rg.Opaque)){var a=Og,o=Mg;(0,Gt.b)(a,r,n),(0,Gt.s)(o,1/a[0],1/a[1],1/a[2]);var s,l=e.results.min,u=e.results.max,c=e.results.ground,h=e.options.store===wp.eC.MIN,d=!!e.results.ground.target,f=(0,Gs.lV)(e.verticalOffset),p=e.tolerance,v=h&&(0,k.pC)(l.dist)?l.dist:1/0,m=function(d){var m=d.renderData;if(null!==m&&void 0!==m&&m.vao){var _=m.geometryInfo;(0,xc.t8)(Ag,_.boundingBox);var y=m.localOrigin;(0,k.pC)(f)&&(f.localOrigin=y,f.applyToAabb(Ag));var g=Ag;if(Zg[0]=n[0]-y[0],Zg[1]=n[1]-y[1],Zg[2]=n[2]-y[2],(0,my.Fw)(g,Zg,o,p,v)){var b=function(e,t,n){e.set(i.type,d,t,n,Cn.I),v=h&&(0,k.pC)(l.dist)?l.dist:1/0},w=function(i,o){if((0,k.pC)(o)&&i>=0&&(e.options.backfacesTerrain||(0,Gt.e)(o,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(n,r,i))){if((null==c.dist||i<c.dist)&&b(c,i,o),e.options.isFiltered)return;e.options.store===wp.eC.ALL&&((0,k.Wi)(s)?(s=(0,Pa.LP)(e.ray),b(s,i,o),e.results.all.push(s)):i<s.dist&&b(s,i,o)),(null==l.dist||i<l.dist)&&b(l,i,o),e.options.store!==wp.eC.MIN&&(null==u.dist||i>u.dist)&&b(u,i,o)}},C=Ig;(0,Gt.b)(C,r,y);var x=_.indices,T=_.vertexAttributes,S=T.getField(tr.T.POSITION,My.ct),P=new wg.a(S.typedBuffer,3,!1,T.stride/4),R=_.indexCount/3;if((0,k.Wi)(f)&&R>200){var A=d.renderData;(0,k.Wi)(A.intersectionData)&&(A.intersectionData=new pg(x,0,R,P)),A.intersectionData.intersectRay({r0:Zg,r1:C},w)}else(0,my.CN)(Zg,C,0,R,x,P,null,f,w)}}},_=this._rootTiles;(0,k.pC)(_)&&function(){var t=i._tileIterator;t.reset(_);for(var r=e.options.invisibleTerrain,o=t.next();o;o=t.next())!(o.visible||r&&o.intersectsClippingArea)||!(0,k.pC)(f)&&!o.intersectsRay(n,a,p,v)||d&&i._useStencilForTile(o)?t.skipSubtree():m(o)}()}}},{key:"processScaleRangeQueries",value:function(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();var n,r=(0,i.Z)(this._patchGroups.values());try{for(r.s();!(n=r.n()).done;){var a,o=n.value,s=(0,i.Z)(o);try{for(s.s();!(a=s.n()).done;){var l,u=a.value;(0,k.pC)(null===(l=u.renderData)||void 0===l?void 0:l.textureReference)&&e.queriesForTile(u)}}catch(c){s.e(c)}finally{s.f()}}}catch(c){r.e(c)}finally{r.f()}e.process(),t.madeProgress()}}},{key:"prepareTechnique",value:function(e){if(e.bindParameters.slot===ci.r.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&Tm.Qi))return null}else{var t=this.transparency===Rg.Opaque?ci.r.OPAQUE_TERRAIN:ci.r.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.output){case li.H.Color:return this.transparency===Rg.Empty?null:(this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=(0,k.pC)(e.bindParameters.cloudsFade.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.active,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty?gg.gT.Disabled:this._overlayRenderer.hasWater?gg.gT.EnabledWithWater:gg.gT.Enabled,this._updateTechnique(li.H.Color,e.bindParameters.slot===ci.r.OCCLUDED_TERRAIN));case li.H.Shadow:case li.H.ShadowExcludeHighlight:return this._castShadows&&1===e.bindParameters.lighting.globalFactor?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(li.H.Shadow,!1)):null;case li.H.Depth:return this.transparency===Rg.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(li.H.Depth,!1));case li.H.Normal:return this.transparency===Rg.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(li.H.Normal,!1));case li.H.ObjectAndLayerIdColor:return this.transparency===Rg.Empty?null:this._updateTechnique(li.H.ObjectAndLayerIdColor,!1);case li.H.Highlight:return this.transparency!==Rg.Empty&&this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(li.H.Highlight,!1)):null}return null}},{key:"render",value:function(e,t){var n=this,r=1===e.bindParameters.lighting.globalFactor;switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case li.H.Color:var i=e.bindParameters.slot===ci.r.OCCLUDED_TERRAIN?Zy.$.Occluded:Zy.$.ColorAndWater;this.transparency===Rg.Opaque?this._renderMaterialPass(e,t,i):e.offscreenRenderingHelper.renderToTargets((function(){return n._renderMaterialPass(e,t,i)}),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break;case li.H.Depth:case li.H.Normal:this._renderAuxiliaryPass(e,t,Zy.$.None);break;case li.H.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,t,Zy.$.Highlight);break;case li.H.Shadow:case li.H.ShadowExcludeHighlight:this._castShadows&&r&&this._renderAuxiliaryPass(e,t,Zy.$.None);break;case li.H.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,Zy.$.ObjectAndLayerIdColor)}}},{key:"_renderMaterialPass",value:function(e,t,n){var r=e.rctx;this._passParameters.overlaySource=n,r.bindTechnique(t,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._renderPatchGroups(e,t,n)}},{key:"_renderAuxiliaryPass",value:function(e,t,n){var r=e.rctx;this._passParameters.overlaySource=n,r.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,n)}},{key:"updateTileBackground",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!(0,k.Wi)(this._tileRenderer)){var t=this._tileRenderer,n=null;if((0,k.pC)(e)){var r=Pt.Z.toUnitRGBA(e);n=(0,F.f)(r[0]||0,r[1]||0,r[2]||0)}t.setBackground(n),this._allTiles.forAll((function(e){return t.updateTileTexture(e,Cm.Ns.FADING)})),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?bg.R.GridComposite:(0,k.pC)(t.backgroundColor)?bg.R.ColorComposite:bg.R.LayerOnly,this.setNeedsRender()}}},{key:"_updatePatchGroups",value:function(){var e=this;if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==gy.z.NONE){for(var t=Array.from(this._patchGroups.values()),n=this._stencilEnabledLayerExtents,r=0,i=t;r<i.length;r++){var a=i[r];(0,i_.zW)(this.renderOrder,a,n)}t.sort((function(t,n){return(0,i_.dF)(t[0],n[0],e.renderOrder)})),this._patchGroups=new Map(t.map((function(e){return[e[0].renderData.localOrigin,e]}))),this._patchSortingDirty=!1}}},{key:"_rebuildPatchGroups",value:function(){var e=this._rootTiles;if(!(0,k.Wi)(e)){var t;null!==(t=e[0])&&void 0!==t&&t.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();var n,r=(0,i.Z)(e);try{for(r.s();!(n=r.n()).done;){var a=n.value;this._rebuildPatchGroupsForRootTile(a)}}catch(o){r.e(o)}finally{r.f()}}}},{key:"_rebuildPatchGroupsForRootTile",value:function(e){var t=this._tileIterator;for(t.resetOne(e);!t.done;){var n=t.next(),r=n.renderData;if(r)if(n.visible){var i=r.localOrigin,a=this._patchGroups.get(i);a||(a=new Array,this._patchGroups.set(i,a)),a.push(n),(!this._highestVisibleLODTile||n.vlevel>this._highestVisibleLODTile.vlevel)&&(this._highestVisibleLODTile=n),t.skipSubtree()}else this._numTilesCulled++,t.skipSubtree();else this._numTilesCulled++}}},{key:"_useStencilForTile",value:function(e){var t,n=(0,i.Z)(this._stencilEnabledLayerExtents);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(e.intersectsExtent(r))return!0}}catch(a){n.e(a)}finally{n.f()}return!1}},{key:"_renderPatchGroupsAuxiliary",value:function(e,t,n){var r=this,i=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach((function(a){var o=a[0].renderData.localOrigin;t.program.bindDraw(new Cg.w(o),e.bindParameters,r._passParameters);for(var s=0;s<a.length;s++)r._renderPatch(e,t,a[s],an.MX.TRIANGLES,i,n)})),e.rctx.bindVAO(null)}},{key:"_renderPatchGroups",value:function(e,t,n){var r=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){var o=(0,cf.Gw)(this._stage.viewingMode,this._ellipsoidRadius),s=this.pointsOfInterest.centerOnSurfaceFrequent.distance;o.update({distance:s,fovY:r.fovY})}var l=this._stencilEnabledLayerExtents.length>0,u=n===Zy.$.Occluded;u&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",F.Z),a.setUniform4fv("texOffsetAndScale",Wt.Z));var c=(0,k.pC)(this._tileRenderer)&&(0,k.pC)(this._tileRenderer.backgroundColor)?this._tileRenderer.backgroundColor:F.Z;this._techniqueConfiguration.tileBlendInput===bg.R.ColorComposite&&a.setUniform3fv("backgroundColor",c);var h=this.wireframe?an.MX.LINES:an.MX.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);var d,f=this._patchGroups,p=(0,i.Z)(f.values());try{for(p.s();!(d=p.n()).done;){var v=d.value,m=v[0].renderData.localOrigin;t.program.bindDraw(new Cg.w(m),e.bindParameters,this._passParameters),this._numOriginsRendered++;var _,y=(0,i.Z)(v);try{for(y.s();!(_=y.n()).done;){var g=_.value,b=g.renderData,w=b.textureReference;if(!(0,k.Wi)(w)){if(!u){a.setUniform4fv("texOffsetAndScale",w.offsetAndScale),a.bindTexture("tex",w.texture.texture);var C=b.textureFadeFactor,x=C<1?b.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&(0,k.pC)(x)&&C<1?(a.setUniform1f("fadeFactor",C),a.setUniform4fv("nextTexOffsetAndScale",x.offsetAndScale),a.setUniform3fv("nextTexOpacities",x.opacities),a.bindTexture("texNext",x.texture.texture)):a.setUniform1f("fadeFactor",1),b.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",w.opacities)}this._renderPatch(e,t,g,h,l,n),g.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}catch(T){y.e(T)}finally{y.f()}}}catch(T){p.e(T)}finally{p.f()}e.rctx.bindVAO(null)}},{key:"_renderPatch",value:function(e,t,n,r,i,a){var o=n.renderData,s=o.vao,l=s.indexBuffer;if((0,k.Wi)(l))hv.jt&&console.error("Rendered tile with no indices: ",n.lij," : ",o);else{var u=t.program;a===Zy.$.None||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(u,o.overlay),i&&(t.useStencil=this._useStencilForTile(n),t.bindPipelineState(e.rctx,e.bindParameters.slot));var c=o.geometryInfo.indexCount;e.rctx.bindVAO(s),u.assertCompatibleVertexAttributeLocations(s),e.rctx.drawElements(r,c,l.indexType,0)}}},{key:"_bindOverlayPatchData",value:function(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}},{key:"_updateTechnique",value:function(e,t){return this._techniqueConfiguration.output=e,e===li.H.Color&&(this._techniqueConfiguration.atmosphere=this._isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(D_,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}},{key:"test",get:function(){return{tileRenderer:this._tileRenderer}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],Eg.prototype,"_overlayRenderer",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Eg.prototype,"_stage",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Eg.prototype,"_isGlobal",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Eg.prototype,"_allTiles",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Eg.prototype,"_ellipsoidRadius",void 0),(0,p._)([(0,Z.Cb)({value:!1})],Eg.prototype,"renderingDisabled",null),(0,p._)([(0,Z.Cb)()],Eg.prototype,"renderPatchBorders",null),(0,p._)([(0,Z.Cb)()],Eg.prototype,"visualizeNormals",null),(0,p._)([(0,Z.Cb)()],Eg.prototype,"cullBackFaces",null),(0,p._)([(0,Z.Cb)({value:gy.z.FRONT_TO_BACK})],Eg.prototype,"renderOrder",null),(0,p._)([(0,Z.Cb)()],Eg.prototype,"wireframe",null),Eg=(0,p._)([(0,L.j)("esri.views.3d.terrain.TerrainRenderer")],Eg);var Og=(0,F.c)(),Mg=(0,F.c)(),Zg=(0,F.c)(),Ig=(0,F.c)(),Dg=(0,l.Z)((function e(){(0,s.Z)(this,e),this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array})),Lg=n(62140),Ng=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r}return(0,l.Z)(n,[{key:"initialize",value:function(){var e=this;this._handles.add(this.layers.on("change",(function(){return e._update()}))),this._handles.add((0,A.YP)((function(){return e.extentHelper.layerViewsExtent}),(function(){return e._setAdHocTilingScheme()}))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}},{key:"destroy",value:function(){this._handles=(0,k.SC)(this._handles),this._waitTask=null}},{key:"_update",value:function(){var e,t=this;if((this._waitTask=null,!this.tilingSchemeLocked)&&(this.layers.some((function(n){return!(!(0,q.iC)(n)||n.isRejected())&&!(n.isFulfilled()&&!function(e,t,n){return(0,k.pC)((0,hv.E_)(e,t,n))}(n,t.viewSpatialReference,t.viewingMode))&&(e=n,!("vector-tile"===(null===n||void 0===n?void 0:n.type)||(0,hv.x4)(n)))})),e))if(e.isResolved()){var n=(0,hv.E_)(e,this.viewSpatialReference,this.viewingMode);if((0,k.pC)(n)){var r=new Lg.t(n.tileInfo);this._lockTilingScheme(r)}}else this._updateWhen(e)}},{key:"_updateWhen",value:function(e){var t=this,n=e.when().catch((function(){})).then((function(){n!==t._waitTask||t.destroyed||t._update()}));this._waitTask=n}},{key:"_lockTilingScheme",value:function(e){var t=this;if(this.viewingMode===he.JY.Global){var n=e.levels.length-1;e.spatialReference.isWebMercator?e=Lg.t.makeWebMercatorAuxiliarySphere(n):(0,H.jF)(e.spatialReference)&&(e=Lg.t.makeGCSWithTileSize(e.spatialReference,e.pixelSize,n))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add((0,A.YP)((function(){return t.extentHelper.tiledLayersExtent}),(function(){return t._updateTiledLayerExtent()})))}},{key:"_updateTiledLayerExtent",value:function(){this._set("extent",this.extentHelper.tiledLayersExtent)}},{key:"_setAdHocTilingScheme",value:function(){if(this.viewingMode===he.JY.Global){var e=this.extentHelper.viewSpatialReference,t=(0,H.jF)(e)||(0,jt.BZ)(e)||(0,jt.V2)(e);e.isWebMercator?this.tilingScheme=Lg.t.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Lg.t.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{var n=this.extentHelper.layerViewsExtent;(0,k.pC)(n)&&!(0,z.fS)(n,this.extent)&&(this.tilingScheme=Lg.t.fromExtent(n,this.extentHelper.viewSpatialReference),this._set("extent",n))}}},{key:"test",get:function(){var e=this;return{lockTilingScheme:function(t){return e._lockTilingScheme(t)},done:!this._waitTask}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],Ng.prototype,"tilingScheme",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ng.prototype,"extent",void 0),(0,p._)([(0,Z.Cb)({value:!1})],Ng.prototype,"tilingSchemeLocked",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ng.prototype,"viewSpatialReference",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ng.prototype,"layers",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ng.prototype,"extentHelper",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ng.prototype,"viewingMode",void 0),Ng=(0,p._)([(0,L.j)("esri.views.3d.terrain.TilingSchemeLogic")],Ng);var Fg=function(){function e(){(0,s.Z)(this,e),this.offset=(0,Jt.a)(),this.scale=0,this.tile=null}return(0,l.Z)(e,[{key:"init",value:function(e,t,n,r){this.tile=e,this.offset[0]=t,this.offset[1]=n,this.scale=r}},{key:"dispose",value:function(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}]),e}(),Ug=function(e){(0,d.Z)(a,e);var t=(0,f.Z)(a);function a(e){var n,r,i;return(0,s.Z)(this,a),(i=t.call(this,e))._scaleRangeQueries=new wy,i._iteratorPool=new zf.Z(i_.AA,(function(e){return e.remove=function(){return i._iteratorPool.release(e)}})),i._postorderIterator=new i_.rv,i._hasPendingUpdates=!1,i._pendingUpdates=0,i._asyncWorkItems=0,i._allTilesDirty=!0,i._allTilesSorted=!0,i._visibleCached=!1,i._usedMemory=null,i._performanceInfo=new Dg,i._viewChanged=!1,i._inFrameTask=!1,i._viewChangeUpdateDirty=!1,i._eyePosRenderSR=(0,F.c)(),i._eyePosSurfaceSR=(0,F.c)(),i._splitLimits=new Oy,i._frustum=(0,Tc.Ue)(),i._viewProjectionMatrix=(0,Cn.c)(),i._layerViews=[new Array,new Array],i._layerIndexByUid=[new Map,new Map],i._basemapLayerViewHandles=new Map,i._handles=new K.Z,i._watchUpdatingTracking=new ur.t,i._frameTask=Dn.sq,i._allTiles=new Qd.Z,i._upsampleInfoPool=new zf.Z(Fg),i._rootTilesExtent=(0,z.Ue)(),i.updatingProgress=0,i._maxNumUpdating=1,i.maxTextureScale=1.2,i._spatialReference=ee.Z.WebMercator,i.visibleElevationBounds=new dm(1/0,-1/0),i.rootTileElevationBounds=new dm(1/0,-1/0),i._updatingRootTiles=!1,i._pendingTilesForElevationUpdateEvent=new Set,i._pendingTilesToUpdate=new Set,i.totalGeometryUpdates=0,i.totalTileUpdates=0,i.oneBatchPerFrameTask=!0,i._layerViewsDirty=!1,i._shading=!0,i._isWebMercator=!1,i._isWebMercatorOnPlateeCarree=!1,i._isGlobal=!(null!==(n=e.view)&&void 0!==n&&null!==(r=n.state)&&void 0!==r&&r.isLocal),i}return(0,l.Z)(a,[{key:"initialize",value:function(){var e=this;this._lercDecoder=(0,um.w)(this.view.resourceController),this._tilePool=this.view.state.isLocal?new zf.Z(_y):new zf.Z(xy);var t=this.view.resourceController.memoryController;this._upsampleMapCache=t.newCache("esri.views.3d.terrain.upsample",(function(e){return e.unloadMapData()})),this._elevationQueryCache=new sm(t.newCache("elevation-query")),this._set("overlayManager",new Om({surface:this})),this._handles.add([(0,A.YP)((function(){return e.overlayManager.hasHighlights}),(function(t){return e._renderer.setNeedsHighlight(t)})),(0,A.YP)((function(){return e.overlayManager.rendersOccluded}),(function(t){return e._renderer.setRenderOccludedOverlay(t)})),(0,A.YP)((function(){return e.overlayManager.renderer.isEmpty}),(function(){return e._evaluateTransparency()}))],"overlayManager"),this._renderer=new Eg({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:(0,qt.Iu)(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([(0,A.YP)((function(){return e.baseOpacity}),(function(){e._handleLayerViewChanges(),e._updateTileTextures(e._evaluateTransparency()?Cm.Ns.UNFADED:Cm.Ns.IMMEDIATE)}),A.tX),(0,A.YP)((function(){return e.hasCompositeBlendMode}),(function(){return e._updateTileTextures(e._evaluateTransparency()?Cm.Ns.UNFADED:Cm.Ns.IMMEDIATE)}),A.tX),(0,A.YP)((function(){return e.renderingDisabled}),(function(){var t,n;return null===(t=e.view)||void 0===t||null===(n=t._stage)||void 0===n?void 0:n.renderer.setParameters({terrainRenderingEnabled:!e.renderingDisabled})}),A.Z_),(0,A.YP)((function(){return e.backgroundColor}),(function(t){e._handleLayerViewChanges(),e._renderer.updateTileBackground(t)}),A.tX),(0,A.YP)((function(){return e.snapLevel}),(function(){return e._viewChanged=!0}),A.Z_),(0,A.YP)((function(){return e.view.pointsOfInterest}),(function(t){e._renderer.pointsOfInterest=t,e._watchUpdatingTracking.removeAll(),t&&e._watchUpdatingTracking.add((function(){return t.focus.renderLocation}),(function(){return e._allTilesSorted=!1}))})),(0,A.YP)((function(){return Jd.Z.TERRAIN_TILE_TREE_SHOW_TILES}),(function(t){t&&!e._treeDebugger?n.e(62782).then(n.bind(n,62782)).then((function(t){var n=t.TerrainTileTree3DDebugger;!e._treeDebugger&&Jd.Z.TERRAIN_TILE_TREE_SHOW_TILES&&(e._treeDebugger=new n({view:e.view}))})):t||(e._treeDebugger=(0,k.SC)(e._treeDebugger))}),A.nn)]);var r=this.view.spatialReference;this._extentHelper=function(e,t){return e===he.JY.Global?new ym(t):new gm(t)}(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:r});var i=new am.Z({getCollections:function(){var t,n,r;return null===(t=e.view)||void 0===t||null===(n=t.defaultsFromMap)||void 0===n||null===(r=n.mapCollections)||void 0===r?void 0:r.map((function(e){return e.layers}))},getChildrenFunction:function(e){return e&&"layers"in e?e.layers:null}}),a=new Ng({layers:i,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",a),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(rv.Bh.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(rv.Bh.BASEMAP);var o=this.view.resourceController.scheduler;this._frameTask=o.registerTask(Dn.T8.TERRAIN_SURFACE,this),this._handles.add([(0,A.YP)((function(){return e._extentHelper.stencilEnabledExtents}),(function(t){return e._renderer.setStencilEnabledLayerExtents(t)}),A.nn),(0,A.YP)((function(){return e.tilingSchemeLogic.tilingScheme}),(function(){return e._updateTilingScheme()}),A.Z_),(0,A.YP)((function(){return e.extent}),(function(){return e._updateRootTiles()}),A.nn),this.view.on("resize",(function(){return e._viewChangeUpdate()})),(0,A.YP)((function(){var t,n,r=e.view,i=r.state;return[e._lodBias,e.lodSnapping,null===(t=r.resourceController)||void 0===t||null===(n=t.memoryController)||void 0===n?void 0:n.memoryFactor,i.camera,i.contentCamera,i.fixedContentCamera]}),(function(){return e._viewChangeUpdate()}),A.tX),(0,A.YP)((function(){var t,n;return null===(t=e.view.qualitySettings)||void 0===t||null===(n=t.tiledSurface)||void 0===n?void 0:n.textureFadeDuration}),(function(t){return e._renderer.textureFadingEnabled=t>0}),A.nn),(0,A.YP)((function(){var t;return null===(t=e.view.qualitySettings)||void 0===t?void 0:t.physicallyBasedRenderingEnabled}),(function(t){return e._renderer.pbrMode=t?Sg.f7.Terrain:Sg.f7.Disabled}),A.nn),(0,A.YP)((function(){return e._userClippingExtent}),(function(){return e._updateClippingExtent()}),A.Z_)]),this._handles.add(this.view.allLayerViews.on("after-changes",(function(){return e._layerViewsDirty=!0}))),this._handles.add([(0,A.YP)((function(){var t;return null===(t=e.view)||void 0===t?void 0:t.map.ground.shading}),(function(){e._updateShadingIfChanged()}))]),this._updateShading(),this._layerViewsDirty=!0,this._handleLayerViewChanges()}},{key:"destroy",value:function(){var e=this;this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=(0,k.RY)(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=(0,k.SC)(this._upsampleMapCache),this._elevationQueryCache=(0,k.SC)(this._elevationQueryCache);var t=this.tilingSchemeLogic.layers;this._set("tilingSchemeLogic",(0,k.SC)(this.tilingSchemeLogic)),t.destroy(),this._basemapLayerViewHandles.forEach((function(t,n){return e._unregisterTiledLayerView(n)})),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,k.SC)(this.overlayManager)),this._tilePool=(0,k.SC)(this._tilePool),b_.prune(),this._treeDebugger=(0,k.SC)(this._treeDebugger),this._renderer=(0,k.SC)(this._renderer),this._iteratorPool=(0,k.SC)(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=(0,k.SC)(this._upsampleInfoPool),(0,cm.K)(),p_.size>0&&(console.log("".concat(p_.size," live TilePerLayerInfo allocations:")),p_.forEach((function(e){return console.log(e,"\n")})))}},{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){if(this.lodSnapping===Cm.VB.ON){var e,t,n=this.view,r=this.tilingScheme,i=null===(e=n.pointsOfInterest)||void 0===e||null===(t=e.cameraOnSurface)||void 0===t?void 0:t.scale;if(i&&r){var a=n.state.contentCamera,o=uc(n,a.eye,a.viewForward,a.up).tilt;o>90&&(o=180-o);var s=2*Math.pow(o/90,2),l=r.levelAtScale(i)-s;return Math.round(l)}}return null}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Cm.VB.ON:Cm.VB.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){var e=this.spatialReference,t=this.view.clippingArea;if((0,k.Wi)(t)||(0,k.Wi)(e))return null;var n=(0,z.Ue)(),r=(0,cp.G)(t,n,e)?n:null,i=this._get("extent");return(0,z.fS)(r,i)?i:r}},{key:"rootTilesExtent",get:function(){return this._rootTilesExtent}},{key:"extent",get:function(){var e=(0,z.jV)(this.groundExtent,this._userClippingExtent,(0,z.Ue)()),t=this._get("extent");return(0,z.fS)(e,t)?t:e}},{key:"groundExtent",get:function(){return(0,k.pC)(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){var e;return null===(e=this.tilingSchemeLogic)||void 0===e?void 0:e.extent}},{key:"updating",get:function(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager.updating)}},{key:"running",get:function(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}},{key:"updatingProgressValue",get:function(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}},{key:"baseOpacity",get:function(){return this.view.map.ground.opacity},set:function(e){this.view.map.ground.opacity=e}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return(0,k.pC)(this._rootTiles)}},{key:"renderOrder",set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}},{key:"rootTiles",get:function(){return this._rootTiles}},{key:"spatialReference",get:function(){var e,t;return null!==(e=null===(t=this.tilingScheme)||void 0===t?void 0:t.spatialReference)&&void 0!==e?e:null}},{key:"backgroundColor",get:function(){return this.view.map.ground.surfaceColor},set:function(e){this.view.map.ground.surfaceColor=e}},{key:"slicePlaneEnabled",set:function(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}},{key:"tilingSchemeLocked",get:function(){var e,t;return null!==(e=null===(t=this.tilingSchemeLogic)||void 0===t?void 0:t.tilingSchemeLocked)&&void 0!==e&&e}},{key:"velvetOverground",set:function(e){this._renderer.velvetOverground=e,this._set("velvetOverground",e)}},{key:"wireframe",get:function(){return this._renderer.wireframe},set:function(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}},{key:"_visible",set:function(e){e!==this._visibleCached&&(this._visibleCached=e,this._renderer.setVisibility(e),this.suspended=!e)}},{key:"opaque",get:function(){return this._renderer.transparency===Rg.Opaque}},{key:"suspended",set:function(e){this._set("suspended",e),this._viewChangeUpdate()}},{key:"textureFadeDuration",get:function(){var e;return null!==(e=this.view.qualitySettings.tiledSurface.textureFadeDuration)&&void 0!==e?e:0}},{key:"intersect",value:function(e,t,n,r){this._renderer.intersect(e,t,n,r)}},{key:"getElevation",value:function(e,t,n,r){var i=this._rootTiles;if((0,k.Wi)(i)||!i.length)return null;if(0===i[0].layerInfo[wm.ELEVATION].length)return null;var a=Bg;return a[0]=e,a[1]=t,a[2]=n,(0,H.SH)(a,r,a,this._spatialReference)?Xg(i,a[0],a[1]):(S.Z.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)}},{key:"getElevations",value:function(e,t,n){var r=this._rootTiles,i=r?r[0].layerInfo[wm.ELEVATION].length:0;if(!(0,k.Wi)(r)&&r.length&&0!==i)for(var a=0;a<t;++a){var o=3*a;n(a,Xg(r,e[o+0],e[o+1]))}else for(var s=0;s<t;++s)n(s,null)}},{key:"getScale",value:function(e){if(!this.tilingScheme)return null;if(!(0,H.KC)(e,Bg,this.spatialReference))return S.Z.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;var t=this._rootTiles;if((0,k.pC)(t)){var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(null!==a&&void 0!==a&&a.containsPoint(Bg)){for(var o=a;o.children[0]&&!o.rendered;){var s=o.children[0].extent,l=0;Bg[0]>s[2]&&(l+=1),Bg[1]<s[1]&&(l+=2),o=o.children[l]}return this._getLodBiasCorrectedScale(o.level)}}}catch(u){r.e(u)}finally{r.f()}}return 1/0}},{key:"getSphereElevationBounds",value:function(e,t,n,r,a){var o;if(Bg[0]=e,Bg[1]=t,Bg[2]=n,Bg[3]=r,!(0,H.SH)(Bg,a,Bg,null===(o=this.tilingScheme)||void 0===o?void 0:o.spatialReference))return S.Z.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;var s=1/0,l=-1/0,u=function e(t){if(t&&(0,z.hr)(t.extent,Bg))if(t.isLeaf||t.rendered)s=Math.min(s,t.elevationBounds[0]),l=Math.max(l,t.elevationBounds[1]);else{var n,r=(0,i.Z)(t.children);try{for(r.s();!(n=r.n()).done;){e(n.value)}}catch(a){r.e(a)}finally{r.f()}}},c=this._rootTiles;if((0,k.pC)(c)){var h,d=(0,i.Z)(c);try{for(d.s();!(h=d.n()).done;){u(h.value)}}catch(f){d.e(f)}finally{d.f()}}return{min:s,max:l}}},{key:"getSphereScale",value:function(e,t){var n=this;if(!this.tilingScheme)return null;if(!(0,H.KC)(e,Bg,this.spatialReference))return S.Z.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Bg[3]=t;var r=null,a=function e(t){if(t&&(0,z.hr)(t.extent,Bg)){var a=t.children;if(a[0]&&!t.rendered){var o,s=(0,i.Z)(a);try{for(s.s();!(o=s.n()).done;){e(o.value)}}catch(u){s.e(u)}finally{s.f()}}else{var l=n._getLodBiasCorrectedScale(t.level);r=null==r?l:Math.min(r,l)}}},o=this._rootTiles;if((0,k.pC)(o)){var s,l=(0,i.Z)(o);try{for(l.s();!(s=l.n()).done;){a(s.value)}}catch(u){l.e(u)}finally{l.f()}}return r}},{key:"queryVisibleScaleRange",value:function(e,t,n,r){var i=t?this.tilingScheme.levelAtScale(t):0,a=n?this.tilingScheme.levelAtScale(n):1/0,o=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,i+o,a+o,r)}},{key:"_evaluateTransparency",value:function(){var e,t,n=this.baseOpacity,r=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,a=this._allSurfaceLayersTransparent()?r?Rg.Empty:Rg.TransparentWithDraped:n>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Rg.Opaque:Rg.Semitransparent,o=i!==a;return o&&(this._renderer.transparency=a,null!==(e=this.view)&&void 0!==e&&null!==(t=e._stage)&&void 0!==t&&t.renderer.setParameters({terrainTransparency:this._renderer.transparency})),o}},{key:"_updateTilingScheme",value:function(){var e,t,n,r,i=this.tilingSchemeLogic.tilingScheme;if(i!==this.tilingScheme){(0,hv.wu)(!!i,"tiling scheme cannot be reset to undefined"),this._isGlobal=!(null!==(e=this.view)&&void 0!==e&&null!==(t=e.state)&&void 0!==t&&t.isLocal),this.tilingScheme&&this._removeAllTiles();var a=null!==(n=null===i||void 0===i?void 0:i.spatialReference)&&void 0!==n?n:ee.Z.WebMercator;this._spatialReference=a,this._isWebMercator=!(null===a||void 0===a||!a.isWebMercator),this._isWebMercatorOnPlateeCarree=this._isWebMercator&&(0,jt.QM)(null===(r=this.view)||void 0===r?void 0:r.renderSpatialReference),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference),this._updateRootTiles())}}},{key:"_acquireTile",value:function(e,t,n,r){var i=this._tilePool.acquire();return Wg[0]=e,Wg[1]=t,Wg[2]=n,i.init(Wg,r,this),i}},{key:"updatingRootTiles",get:function(){return this._updatingRootTiles}},{key:"_updateRootTiles",value:function(){var e=this,t=this.extent,n=this.tilingScheme;if(n){var r=Gg,i=n.rootTilesInExtent(t,r,5*re.$r);if((0,k.pC)(this._rootTiles)){if(i.length>re.$r)return void S.Z.getLogger(this.declaredClass).warn(re.Tg);var a=this._rootTiles.map((function(e){return e.lij})),o=(0,D.e5)(a,i,Hg);if(this._updatingRootTiles=!0,o.removed.length>0||o.added.length>0){var s=this._rootTiles.filter((function(t){return!(o.removed.findIndex((function(e){return Hg(e,t.lij)}))>-1)||(e._purgeTile(t),!1)}));o.added.forEach((function(t){return s.push(e._newRootTile(t))})),this._setRootTiles(s)}}else this._updatingRootTiles=!0,i.length>re.$r&&(S.Z.getLogger(this.declaredClass).warn(re.iU),i=n.rootTilesInExtent(t,r,re.$r)),this._setRootTiles(i.map((function(t){return e._newRootTile(t)})));(0,z.fS)(r,this._rootTilesExtent)||(this._rootTilesExtent=(0,z.Ue)(r)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}}},{key:"_updateAllTileGeometries",value:function(){var e=this,t=this._allTiles.filter((function(e){return e.isLoaded&&e.intersectsClippingArea}));t.forEach((function(t){return e._renderer.updateTileGeometryState(t)})),t.forEach((function(e){return e.renderData.updateNeighborData()})),this._updateTilesGeometries(t),this._pendingTilesToUpdate.clear()}},{key:"_updateTilesGeometries",value:function(e){var t=this;if(0!==e.length){e.sort(i_.gl);var n=this.renderer;e.forEach((function(e){return n.updateGeometryIfNeeded(e)})),e.forEach((function(e){return t._pendingTilesForElevationUpdateEvent.add(e)}))}}},{key:"_shouldSplit",value:function(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===v_.SPLIT}},{key:"_newRootTile",value:function(e){var t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(v_.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}},{key:"_setRootTiles",value:function(e){if(this._rootTiles=e,this._allTiles.clear(),(0,k.pC)(e)){var t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}},{key:"_runViewChangeUpdateIfDirty",value:function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}},{key:"_viewChangeUpdate",value:function(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}},{key:"_updateClippingStatus",value:function(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(v_.GEOMETRY)&&this._updateTileGeometryState(e)}},{key:"_updateTilesVisibility",value:function(e){if(!(0,k.Wi)(e)){var t=(0,i_.t8)(e),n=this.visibleElevationBounds,r=t?n.min:1/0,i=t?n.max:-1/0,a=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();var s=this._iteratorPool.acquire();for(s.reset(e);!s.done;){var l=s.next();l.updateClippingStatus(a)&&l.resetPendingUpdate(v_.GEOMETRY)&&this._updateTileGeometryState(l),l.setPendingUpdate(v_.RENDERDATA),l.computeVisibility(),l.updateScreenDepth(o),l.renderData&&(r=Math.min(l.elevationBounds[0],r),i=Math.max(l.elevationBounds[1],i))}s.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(r)&&isFinite(i)&&(n.min!==r||n.max!==i)&&(this.visibleElevationBounds=new dm(r,i))}}},{key:"_updateRootTileElevationBounds",value:function(){var e=1/0,t=-1/0,n=this._rootTiles;(0,k.pC)(n)&&n.forEach((function(n){var r=n.elevationBounds;e=Math.min(e,r[0]),t=Math.max(t,r[1])}));var r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new dm(e,t))}},{key:"_updateViewDependentParameters",value:function(){var e=this.view.state,t=e.camera,n=e.contentCamera,r=Math.tan(.5*n.fovX),i=Math.tan(.5*n.fovY),a=this.tilingScheme.pixelSize,o=Math.pow(2,-this._lodBias)*t.pixelRatio;this._splitLimits.aboveGround=t.aboveGround,this._splitLimits.fovX=r,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=a/t.width*this.maxTextureScale*o,this._splitLimits.relativeHeightLimit=a/t.height*this.maxTextureScale*o,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?((0,k.Wi)(this._splitLimits.frustum)&&(this._splitLimits.frustum=(0,Tc.Ue)()),(0,Tc.JG)(this._splitLimits.frustum,n.frustum)):this._splitLimits.frustum=null,(0,Tc.JG)(this._frustum,t.frustum),(0,wn.m)(this._viewProjectionMatrix,n.projectionMatrix,n.viewMatrix),(0,Gt.c)(this._eyePosRenderSR,n.eye),(0,H.SH)(t.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}},{key:"_updateRenderData",value:function(e){e.rendered&&!e.shouldLoad&&(zg(e)?this._loadChildren(e):function(e){var t,n;return e.isLeaf&&null!==(t=null===(n=e.parent)||void 0===n?void 0:n.shouldLoad)&&void 0!==t&&t}(e)&&this._loadParent(e))}},{key:"_updateTileGeometryState",value:function(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}},{key:"_markAllTileNeighborsForGeometryUpdate",value:function(e){var t=this._pendingTilesToUpdate;e.forEachLoadedNeighbor((function(e){t.add(e)}))}},{key:"_updateTileTexture",value:function(e,t){var n=e.resetPendingUpdate(v_.TEXTURE_FADING)?v_.TEXTURE_FADING:!!e.resetPendingUpdate(v_.TEXTURE_NOFADING)&&v_.TEXTURE_NOFADING;n&&(this._renderer.updateTileTexture(e,n),this._usedMemory=null,t.madeProgress())}},{key:"_emitElevationUpdateEventForTiles",value:function(){var e=qg.extent;(0,z.cS)(e),this._pendingTilesForElevationUpdateEvent.forEach((function(t){return(0,z.jn)(e,t.extent,e)})),this._pendingTilesForElevationUpdateEvent.clear(),qg.spatialReference=this.spatialReference,this.emit("elevation-change",qg)}},{key:"runTask",value:function(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);var t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed?this.requestUpdate():this.getUsedMemory(),this.notifyChange("updatingProgressValue")}},{key:"_updateAllTilesStatus",value:function(e){if(this._viewChanged&&this._rootTiles&&!e.done){this._viewChanged=!1;var t=this._iteratorPool.acquire();t.reset(this._rootTiles);for(var n=this.snapLevel,r=this._splitLimits,i=this._eyePosRenderSR;!t.done;){var a=t.next(),o=a.shouldSplit(r,i,n);if(o!==v_.SPLIT){if(a.resetPendingUpdate(v_.SPLIT)&&a.updateAgentSuspension(),o===v_.VSPLITMERGE&&a.updateAgents(wm.ELEVATION),t.skipSubtree(),!a.isLeaf){a.setPendingUpdate(v_.MERGE),a.resetPendingUpdate(v_.SPLIT);var s=this._iteratorPool.acquire();s.resetOne(a);for(var l=this._viewProjectionMatrix,u=s.next();!s.done;u=s.next())this._updateClippingStatus(u),u.updateVisibility(),u.updateScreenDepth(l);s.remove()}}else a.resetPendingUpdate(v_.MERGE),a.isLeaf&&(a.setPendingUpdate(v_.SPLIT),t.skipSubtree()),a.rendered&&a.setPendingUpdate(v_.RENDERDATA)}t.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),e.madeProgress()}}},{key:"_sortTiles",value:function(e){e.done||this._allTilesSorted||((0,i_.b)(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}},{key:"_markTileToUpdate",value:function(e){(0,hv.Fp)(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForGeometryUpdate(e))}},{key:"_batchUpdatePendingTileGeometries",value:function(){var e=this._pendingTilesToUpdate;if(0!==e.size){var t=Array.from(this._pendingTilesToUpdate.keys()).filter((function(e){return e.isLoaded&&e.intersectsClippingArea})),n=function(n,r){null===r||void 0===r||!r.isLoaded||!r.intersectsClippingArea||r.level<n.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(i_.gl);for(var r=t.length,i=function(r){var i=t[r];(0,hv.Fp)(i.isLoaded),(0,hv.Fp)(i.intersectsClippingArea);var a=i.renderData;a.updateNeighborData();for(var o=a._dirtyEdgeResolutions,s=a.geometryState.neighborData,l=0;l<4;++l)if(o&1<<l){var u=a.geometryState.neighborData.edgePeerNeighbors[l];u&&(null===u||void 0===u?void 0:u.level)>=i.level&&u.forAllSubtreeOnSide((0,hv._F)(hv.OC[l]),(function(t){return!(!t.isLoaded||!t.intersectsClippingArea)&&((0,hv.Fp)(e.has(t)||(0,i_.gl)(i,t)<0),n(i,t),!0)})),n(i,s.cornerPeerNeighbors[l]),n(i,s.cornerPeerNeighbors[(l+1)%4])}},a=0;a<r;++a)i(a);e.clear(),this._updateTilesGeometries(t),hv.jt&&hv.XJ&&this.checkAllTilesWaterproofness()}}},{key:"_mergeAndSplit",value:function(e,t){var n=this;if(!this.suspended&&!e.done&&this._allTilesDirty){this._allTilesDirty=!1,this.requestUpdate();for(var r=!1,i=this.view.state.fixedContentCamera,a=!1;!e.done;){a=!0;var o=!1,s=!this._allTiles.some((function(a){if(!r&&!i&&!a.visible)return e.done;var s=a;if(a.resetPendingUpdate(v_.MERGE)){if(!t)return a.setPendingUpdate(v_.MERGE),e.done;for(;null!==(l=s.parent)&&void 0!==l&&l.resetPendingUpdate(v_.MERGE);){var l;s=s.parent}n._mergeTile(s),o=!0,e.madeProgress()}else a.resetPendingUpdate(v_.SPLIT)&&(n._splitTile(a),o=!0,e.madeProgress());return!e.done&&s===a&&a.resetPendingUpdate(v_.RENDERDATA)&&(n._updateRenderData(a),e.madeProgress()),e.done}));if(o&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(!r){r=!0;continue}if(!o)break}else this._allTilesDirty=!0}a?e.madeProgress():this._allTilesDirty=!0,!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(e)}}},{key:"_updateElevation",value:function(e){var t=this;e.done||(this._allTiles.some((function(n){return n.resetPendingUpdate(v_.GEOMETRY)&&(t._updateTileGeometryState(n),t._updateTileTexture(n,e),t.shortBatches&&t._batchUpdatePendingTileGeometries(),e.madeProgress()),e.done})),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())}},{key:"_updateTextures",value:function(e){var t=this;e.done||this._allTiles.some((function(n){return t._updateTileTexture(n,e),e.done}))}},{key:"_updateClippingExtent",value:function(){this.spatialReference&&(this.updateTileOverlayParams(bv.Xx.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}},{key:"_lodBias",get:function(){var e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*re.DR}},{key:"_getLodBiasCorrectedScale",value:function(e){var t=this.tilingScheme.levels,n=(0,Se.uZ)(e-this._lodBias,0,t.length-1),r=n-Math.floor(n);return t[Math.floor(n)].scale*(1-r)+t[Math.ceil(n)].scale*r}},{key:"_removeAllTiles",value:function(){var e=this;(0,k.pC)(this._rootTiles)&&(this._rootTiles.forEach((function(t){return e._purgeTile(t)})),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1}},{key:"_purgeDescendantTiles",value:function(e){if(!e.children[0])return!1;for(var t=!1,n=0;n<4;++n)t=this._purgeTile(e.children[n])||t;return e.unsetChildren(),t}},{key:"_purgeTile",value:function(e){var t=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),this._tilePool.release(e),t}},{key:"_unloadTile",value:function(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}},{key:"_splitTile",value:function(e){(0,hv.wu)(e.isLeaf,"tile that is already split should not be split again!");var t=e.level+1,n=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,n,r,e),this._createTile(t,n,r+1,e),this._createTile(t,n+1,r,e),this._createTile(t,n+1,r+1,e)),e.setPendingUpdate(v_.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit}},{key:"_emitTileScaleChange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.level;Yg.spatialReference=this.spatialReference,Yg.extent=e.extent,Yg.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Yg)}},{key:"_createTile",value:function(e,t,n,r){(0,hv.wu)(!!r,"_createTile sanity check");var i=this._acquireTile(e,t,n,r);return i.updateClippingStatus(this.extent),i.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(i)&&i.setPendingUpdate(v_.SPLIT),i}},{key:"shortBatches",get:function(){return this.view.state.mode!==Xr.n.IDLE}},{key:"_mergeTile",value:function(e){(0,hv.wu)(!e.hasPendingUpdate(v_.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&((0,hv.wu)(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged}},{key:"_loadChildren",value:function(e){var t=this;(0,hv.wu)(e.rendered,"parent should be rendered"),this._unloadTile(e);var n=e.children;n.forEach((function(e){return t._loadTile(e)})),n.forEach((function(e){return t._pendingTilesToUpdate.add(e)})),this._markAllTileNeighborsForGeometryUpdate(e),this._emitTileScaleChange(e,e.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()}},{key:"_loadParent",value:function(e){var t=e.parent;this._unloadChildren(t),this._loadTile(t),this._markTileToUpdate(t),this._emitTileScaleChange(t,t.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()}},{key:"_unloadChildren",value:function(e){var t=e.children;if(t[0])for(var n=0;n<4;++n){var r=t[n];this._unloadChildren(r),this._unloadTile(r)}}},{key:"_loadTile",value:function(e){e.load(),e.setPendingUpdate(v_.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}},{key:"_elevationDataArrived",value:function(e,t,n){var r=new pm(e.lij,e.extent,n);e.dataArrived(t,wm.ELEVATION,r);var i=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(i);!o.done;){var s=o.next();s.findElevationBoundsForLayer(t,a),s.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(i)}},{key:"_handleLayerViewChanges",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Dn.G5;if(this._layerViewsDirty){this._layerViewsDirty=!1;var n,r=!1,a=new Set,o=-1,s=(0,i.Z)(this.view.allLayerViews.items);try{for(s.s();!(n=s.n()).done;){var l=n.value;if(a.add(l.uid),(0,hv.wP)(l)||(0,hv.a_)(l))if(this._basemapLayerViewHandles.has(l.uid)&&!(0,hv.a_)(l)){var u=this._layerClassFromLayerView(l),c=this._getLayerIdxByUID(u,l.uid);(0,k.pC)(c)&&((c<o||(0,k.Wi)(o))&&(r=!0),o=c)}else this._registerTiledLayerView(l),l.layer.loaded&&(r=!0)}}catch(h){s.e(h)}finally{s.f()}this._basemapLayerViewHandles.forEach((function(t,n){a.has(n)||(e._unregisterTiledLayerView(n),r=!0)})),r&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),t.madeProgress()}}},{key:"_allSurfaceLayersTransparent",value:function(){var e,t,n,r=0===(null===(e=this.view.map)||void 0===e||null===(t=e.ground)||void 0===t?void 0:t.opacity),a=(0,i.Z)(this.view.allLayerViews.items);try{for(a.s();!(n=a.n()).done;){var o=n.value;if((0,hv.GL)(o)&&!(0,q.sy)(o.layer)&&0!==o.fullOpacity)return r=!1}}catch(s){a.e(s)}finally{a.f()}return r}},{key:"_hasCompositeBlendMode",value:function(){var e,t=(0,i.Z)(this.view.allLayerViews.items);try{for(t.s();!(e=t.n()).done;){var n=e.value;if(((0,hv.TK)(n)||(0,hv.a_)(n))&&(0,Iy.MV)(Iy.pU[n.layer.blendMode]))return!0}}catch(r){t.e(r)}finally{t.f()}return!1}},{key:"_layerClassFromLayerView",value:function(e){return(0,hv._1)(e)?wm.ELEVATION:wm.MAP}},{key:"_registerTiledLayerView",value:function(e){var t=this,n=[];if(((0,hv.TK)(e)||(0,hv.a_)(e))&&n.push((0,A.YP)((function(){return e.layer.blendMode}),(function(){t.hasCompositeBlendMode=t._hasCompositeBlendMode(),t._updateTileTextures(Cm.Ns.UNFADED)}))),!(0,hv.a_)(e)){var r=this._layerClassFromLayerView(e);n.push((0,A.YP)((function(){return e.suspended}),(function(){return t._updateTiledLayers()}))),n.push((0,A.YP)((function(){return e.fullOpacity}),(function(){return t._updateTileTextures(Cm.Ns.UNFADED)}))),n.push((0,A.YP)((function(){return"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null}),(function(){return t._restartAllAgents(r)}))),e.on("data-changed",(function(){var n=t._getLayerIdxByUID(r,e.uid);(0,k.pC)(n)&&t._invalidateLayerData(n,r)})),this._basemapLayerViewHandles.set(e.uid,n)}}},{key:"_unregisterTiledLayerView",value:function(e){var t=this._basemapLayerViewHandles.get(e);if(t){for(var n=0;n<t.length;n++)t[n].remove();this._basemapLayerViewHandles.delete(e)}}},{key:"_updateTiledLayers",value:function(){var e=this;if(this.tilingScheme&&!this.view.suspended){var t=this.view.allLayerViews,n=[[],[]],r=null;t.forEach((function(t){if(t.layer&&!t.suspended&&(0,hv.wP)(t)&&t.fullExtent){var i=e._layerClassFromLayerView(t);if(i===wm.MAP){var a=t.displayLevelRange.maxLevel;a!==1/0&&(null===r||a>r)&&(r=a)}n[i].push(t)}}));var a,o=(0,i.Z)(xm);try{for(o.s();!(a=o.n()).done;){var s=a.value,l=this._layerViews[s],u=n[s];u.reverse();var c=u.length,h=l.length!==c,d=new Array(c),f=new Array(l.length);this._layerIndexByUid[s].clear();for(var p=0;p<c;p++){var v=u[p].uid;this._layerIndexByUid[s].set(v,p);var m=l.indexOf(u[p]);d[p]=m,p!==m&&(h=!0),m>-1&&(f[m]=p)}if(h){var _=this._postorderIterator;for(_.reset(this._rootTiles);!_.done;)_.next().modifyLayers(f,d,s);this._layerViews[s]=u,this._restartAllAgents(s),this._updateTilesVisibility(this._rootTiles)}}}catch(y){o.e(y)}finally{o.f()}this.tilingScheme.ensureMaxLod(r)&&this._viewChangeUpdate()}}},{key:"_restartAllAgents",value:function(e){var t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){var n=t.next();n.restartAgents(e),e===wm.ELEVATION&&n.computeElevationBounds()}this._updateRootTileElevationBounds()}},{key:"layerViewByIndex",value:function(e,t){return this._layerViews[t][e]}},{key:"numLayers",value:function(e){return this._layerViews[e].length}},{key:"_updateTileTextures",value:function(e){var t=this;this._allTiles.forAll((function(n){n.updateAgents(wm.MAP),e===Cm.Ns.IMMEDIATE?t.renderer.updateTileTexture(n,v_.TEXTURE_NOFADING):n.updateRenderData(wm.MAP,e)})),this._evaluateTransparency()}},{key:"_invalidateLayerData",value:function(e,t){this._allTiles.forAll((function(n){return n.removeLayerAgent(e,t)})),this._allTiles.forAll((function(n){return n.invalidateLayerData(e,t)}))}},{key:"setTileTreeDirty",value:function(){this._allTilesDirty=!0}},{key:"requestRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bv.Xx.UPDATE;this.renderer.setNeedsRender(e)}},{key:"requestUpdate",value:function(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}},{key:"requestTileData",value:function(e,t,n,i){var a=this,o=this.layerViewByIndex(t,n),s=o.layer;return!s.tilemapCache||(0,hv.Q)(o)?this._requestTileData(e,n,o,i):(++this._asyncWorkItems,s.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],(0,r.Z)((0,r.Z)({},i),{},{timeout:6e3})).then((function(){return--a._asyncWorkItems})).catch((function(t){throw--a._asyncWorkItems,(0,R.k_)(i),(0,R.D_)(t)||a._dataMissing(e,n,o,{notInTilemap:!0}),t})).then((function(){return a._frameTask.schedule((function(){return a._requestTileData(e,n,o,i)}),i.signal)})))}},{key:"_requestTileData",value:function(e,t,n,r){return t===wm.ELEVATION?(0,hv._1)(n)?this._requestElevationTileData(e,n,r):Promise.reject():(0,hv.GL)(n)?this._requestMapTileData(e,n,r):Promise.reject()}},{key:"_requestElevationTileData",value:function(e,t,n){var r=this;++this._asyncWorkItems;var i=function(i){if(!(0,R.Hc)(n)){var a=r._layerIndexByUid[wm.ELEVATION].get(t.uid);null!=a?(r._usedMemory=null,r.requestUpdate(),r._elevationDataArrived(e,a,i)):S.Z.getLogger(r.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",wm.ELEVATION,e.lij.toString())}},a=function(n){(0,R.D_)(n)||(r._dataMissing(e,wm.ELEVATION,t,n),r.requestUpdate())};if((0,hv.FZ)(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:re.$7,signal:n.signal}).then((function(e){if(!(0,R.Hc)(n))return r._frameTask.schedule((function(){return i(e)}),n.signal,a);S.Z.getLogger(r.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")}),a).finally((function(){--r._asyncWorkItems}));var o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(o,"binary",n).then((function(e){return r._lercDecoder.decode(e,{noDataValue:re.$7},n.signal)})).then((function(e){e?i(new lm.v(e)):a(new Error("LERC decoding failed"))}),a).finally((function(){--r._asyncWorkItems}))}},{key:"_requestMapTileData",value:function(e,t,n){var r=this;++this._asyncWorkItems;var i=function(i,a){--r._asyncWorkItems,(0,hv.z4)(a),(0,R.Hc)(n)||(r._dataMissing(e,wm.MAP,t,i),r.requestUpdate())},a=function(e){return function(t){return i(t,e)}},o=function(i){return r._frameTask.schedule((function(){--r._asyncWorkItems,r.requestUpdate(),(0,R.Hc)(n)?(0,hv.z4)(i):r._mapTileDataArrived(e,t,i)}),n.signal,a(i)).catch(a(i))},s=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return r._frameTask.schedule((function(){return i(e,t)}))};if((0,hv.Q)(t)){var l=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(l[0],l[1],l[2],n).then(o,s)}if((0,hv.sR)(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],n).then(o,s);if((0,hv.FH)(t)&&(0,hv.FZ)(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],n).then((function(e){if((0,R.Hc)(n))return S.Z.getLogger(r.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s((0,R.zE)());o(e)}),s);var u=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);(0,om.d)(t.layer)&&t.layer.refreshTimestamp&&(u+="".concat(u.includes("?")?"&":"?","_ts=").concat(t.layer.refreshTimestamp));var c=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(u,c,n).then(o,s)}},{key:"_mapTileDataArrived",value:function(e,t,n){var r=this._getLayerIdxByUID(wm.MAP,t.uid);(0,k.pC)(r)?e.dataArrived(r,wm.MAP,n):((0,hv.z4)(n),S.Z.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))}},{key:"_getLayerIdxByUID",value:function(e,t){return this._layerIndexByUid[e].get(t)}},{key:"_dataMissing",value:function(e,t,n,r){var i=this._getLayerIdxByUID(t,n.uid);(0,k.pC)(i)?e.dataMissing(i,t,r):S.Z.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")}},{key:"updateTileOverlayParams",value:function(e){var t=this;this._rootTiles&&this.overlayManager&&(this._allTiles.forAll((function(e){e.renderData&&t.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}},{key:"performanceInfo",get:function(){var e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((function(t){t.isLeaf&&e.numLeaves++;var n=t.level;t.renderData&&(e.numLoadedPerLevel[n]=(e.numLoadedPerLevel[n]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[n]=(e.numRenderedPerLevel[n]||0)+1,e.numRendered++))})),e}},{key:"getUsedMemory",value:function(){return this.tilingScheme?((0,k.Wi)(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),(0,k.pC)(this._usedMemory)?this._usedMemory:0):0}},{key:"_recalculateUsedMemory",value:function(){return this.tilingScheme?this._allTiles.reduce((function(e,t){return e+t.usedMemory}),0):null}},{key:"getUsedMemoryForLayerView",value:function(e){var t=0,n=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(n,e.uid);return(0,k.pC)(r)&&this._allTiles.forAll((function(e){return t+=e.getUsedMemoryForLayer(n,r)})),t}},{key:"getTile",value:function(e){if((0,k.Wi)(e)||(0,k.Wi)(this._rootTiles))return null;var t=e.split("/").map((function(e){return+e}));if(0===t[0])return this._rootTiles.find((function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]}));var n,r=Math.pow(2,t[0]),i=Math.floor(t[1]/r),a=Math.floor(t[2]/r);if(this._rootTiles.some((function(e){return e.lij[1]===i&&e.lij[2]===a&&(n=e,!0)})),n){for(var o=1<<t[0]-1;n.lij[0]<t[0];){var s=t[1]&o?2:0;if((t[2]&o)>0&&s++,!n.children[s])return null;n=n.children[s],o>>=1}return(0,hv.wu)(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}},{key:"renderPatchBorders",get:function(){return this._renderer.renderPatchBorders},set:function(e){this._renderer.renderPatchBorders=e}},{key:"visualizeNormals",get:function(){return this._renderer.visualizeNormals},set:function(e){this._renderer.visualizeNormals=e}},{key:"renderingDisabled",get:function(){return this._renderer.renderingDisabled},set:function(e){this._renderer.renderingDisabled=e}},{key:"test",get:function(){var e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:function(){(0,k.pC)(e._rootTiles)&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:function(){return e._allTiles.toArray()},getRenderedTiles:function(){jg.clear(),e._allTiles.forAll((function(e){e.visible&&e.rendered&&jg.push(e)}));var t=jg.toArray();return(0,i_.zW)(e.renderOrder,t),t},lockTilingScheme:function(t,n){e._extentHelper.defaultTiledLayersExtent=n,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}},{key:"checkAllTilesWaterproofness",value:function(){if(hv.XJ){var e=this._rootTiles;if(!(0,k.Wi)(e)){var t,n=function(e){var t,n,r;return(null===e||void 0===e||null===(t=e.renderData)||void 0===t||null===(n=t.geometryInfo)||void 0===n||null===(r=n.indices)||void 0===r?void 0:r.length)>0},r=function(e,t){n(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",t.lij,"] has geom")},a=function e(t){var a,o,s;if(t.intersectsClippingArea)if(t.renderData&&!t.renderData.geometryState&&console.error("Tile[",t.lij,"] has renderData but not geometryState"),t.renderData&&!t.renderData.geometryInfo&&console.error("Tile[",t.lij,"] has renderData but not geometryInfo"),!(null!==(a=t.renderData)&&void 0!==a&&a.geometryInfo)||(null!==(o=null===(s=t.renderData.geometryInfo.indices)||void 0===s?void 0:s.length)&&void 0!==o?o:0)>0||console.error("Tile[",t.lij,"] has renderData but no indices - geometryInfo: ",t.renderData.geometryInfo),n(t)){t.checkGeometryWaterproofness();var l,u=(0,i.Z)(t.children);try{for(u.s();!(l=u.n()).done;){var c=l.value;r(c,t)}}catch(f){u.e(f)}finally{u.f()}}else if(t.isLeaf)console.error("Tile[",t.lij,"] has no geometry and no children, from root to leaf");else{var h,d=(0,i.Z)(t.children);try{for(d.s();!(h=d.n()).done;){e(h.value)}}catch(f){d.e(f)}finally{d.f()}}},o=function e(t){var n,r,a=null===(n=null===(r=t.parent)||void 0===r?void 0:r.visible)||void 0===n||n,o=t.visible;t.computeVisibility();var s=t.visible;if(o!==s&&a&&console.error(" Tile[",t.lij,"] has out of date visibility: ",o," instead of ",s),!t.isLeaf){var l,u=(0,i.Z)(t.children);try{for(u.s();!(l=u.n()).done;){e(l.value)}}catch(c){u.e(c)}finally{u.f()}}},s=(0,i.Z)(e);try{for(s.s();!(t=s.n()).done;){var l=t.value;a(l),o(l)}}catch(u){s.e(u)}finally{s.f()}}}}},{key:"isGlobal",get:function(){return this._isGlobal}},{key:"shading",get:function(){return this._shading}},{key:"_updateShadingIfChanged",value:function(){var e,t,n;(null===(e=this.view)||void 0===e||null===(t=e.map)||void 0===t||null===(n=t.ground)||void 0===n?void 0:n.shading)!==this._shading&&this._updateShading()}},{key:"_updateShading",value:function(){var e,t,n,r=null===(e=this.view)||void 0===e||null===(t=e.map)||void 0===t||null===(n=t.ground)||void 0===n?void 0:n.shading;this._shading=r,this.renderer&&(this.renderer.shading=r,this.renderer.setNeedsRender()),this._updateAllTileGeometries()}},{key:"isWebMercator",get:function(){return this._isWebMercator}},{key:"isWebMercatorOnPlateeCarree",get:function(){return this._isWebMercatorOnPlateeCarree}},{key:"isEastEndWrap",value:function(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}},{key:"isWestEndWrap",value:function(e){return this.isGlobal&&0===e[2]}},{key:"lijEastEnd",value:function(e){return Math.pow(2,e+((0,k.pC)(this.spatialReference)&&this.spatialReference.isGeographic?1:0))}},{key:"wrapEastWest",value:function(e){var t=this.lijEastEnd(e[0]),n=e[2];if(0<=n&&n<t)return e;if(!this.isGlobal)return null;var r=(n+(n<0?t:0))%t;return[e[0],e[1],r]}},{key:"enableInternalChecks",value:function(e){(0,hv.T9)(e)}},{key:"enableWaterproofnessChecks",value:function(e){(0,hv.b5)(e)}}]),a}($.Z.EventedMixin(J.Z));(0,p._)([(0,Z.Cb)()],Ug.prototype,"_renderer",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ug.prototype,"_scaleRangeQueries",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_hasPendingUpdates",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_asyncWorkItems",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_allTilesDirty",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_allTilesSorted",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_viewChanged",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"_watchUpdatingTracking",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_frameTask",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"snapLevel",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"lodSnapping",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],Ug.prototype,"view",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_userClippingExtent",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_rootTilesExtent",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"extent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"groundExtent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"_tilingSchemeExtent",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"updating",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"running",null),(0,p._)([(0,Z.Cb)(hm.q)],Ug.prototype,"updatingProgress",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"updatingProgressValue",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_maxNumUpdating",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"baseOpacity",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"hasCompositeBlendMode",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"overlayManager",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"viewingMode",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"maxTextureScale",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"ready",null),(0,p._)([(0,Z.Cb)({value:gy.z.FRONT_TO_BACK})],Ug.prototype,"renderOrder",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"rootTiles",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_rootTiles",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"spatialReference",null),(0,p._)([(0,Z.Cb)({type:Pt.Z})],Ug.prototype,"backgroundColor",null),(0,p._)([(0,Z.Cb)({value:!1})],Ug.prototype,"slicePlaneEnabled",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"tilingScheme",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"tilingSchemeLocked",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],Ug.prototype,"tilingSchemeLogic",void 0),(0,p._)([(0,Z.Cb)({value:!0})],Ug.prototype,"velvetOverground",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"wireframe",null),(0,p._)([(0,Z.Cb)({value:!1})],Ug.prototype,"suspended",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"textureFadeDuration",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"visibleElevationBounds",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"rootTileElevationBounds",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"_layerViewsDirty",void 0),(0,p._)([(0,Z.Cb)()],Ug.prototype,"renderPatchBorders",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"visualizeNormals",null),(0,p._)([(0,Z.Cb)()],Ug.prototype,"renderingDisabled",null);var Vg=Ug=(0,p._)([(0,L.j)("esri.views.3d.terrain.TerrainSurface")],Ug);function Hg(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function zg(e){var t=e.children;if(!t[0])return!1;var n,r=(0,i.Z)(t);try{for(r.s();!(n=r.n()).done;){if(n.value.shouldLoad)return!0}}catch(s){r.e(s)}finally{r.f()}var a,o=(0,i.Z)(t);try{for(o.s();!(a=o.n()).done;){if(zg(a.value))return!0}}catch(s){o.e(s)}finally{o.f()}return!1}var Bg=(0,Wt.c)(),Gg=(0,z.Ue)(),Wg=[0,0,0],jg=new Qd.Z,qg={spatialReference:null,extent:(0,z.Ue)(),context:"ground"},Yg={spatialReference:null,extent:null,scale:0};function Xg(e,t,n){var r,a=(0,i.Z)(e);try{for(a.s();!(r=a.n()).done;){var o,s,l,u=r.value;if(u.containsPointXY(t,n)){for(var c=u;c&&!c.renderData;){var h=(t>c.extentMidX?1:0)+(n<c.extentMidY?2:0);c=c.children[h]}return mm(t,n,null!==(o=null===(s=c)||void 0===s||null===(l=s.renderData)||void 0===l?void 0:l.geometryState.samplerData)&&void 0!==o?o:null)}}}catch(d){a.e(d)}finally{a.f()}return null}var Qg=n(78976),Jg=n(78485),Kg=n(97882),$g=n(79100),eb=n(19962),tb=n(95439),nb=n(78289),rb=(0,l.Z)((function e(t,n,r){(0,s.Z)(this,e),this.operation=t,this.geometry=n,this.states=r})),ib=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._residentGeomRecords=new Map,r._dirtyGeomRecords=new Map,r.dirty=!1,r}return(0,l.Z)(n,[{key:"commitLayer",value:function(e,t){var n=this,r=this._dirtyGeomRecords.get(e);r&&(r.forEach((function(r,i){var a=n._ensureGeomRecord(e,i);r.forEach((function(e,r){var o=e.geometry,s=e.operation,l=e.states,u=!1;if(s===nb.T.UPDATE){var c=a.get(r);if(c){if(l&nb.$.TRANSFORMATION){var h=n.model.getObject(i);n.model.updateRenderGeometryTransformation(h,o,c)&&(u=!0)}u||t.updates.push({renderGeometry:c,updateType:l})}else(0,wr.hu)(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(s===nb.T.REMOVE||u){var d=a.get(r);d?(t.removes.push(d),a.delete(r)):s===nb.T.REMOVE&&(0,wr.hu)(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(s===nb.T.ADD||u){var f=n.model.getObject(i);if((0,k.pC)(f)){var p=n.model.getRenderGeometry(f,o);t.adds.push(p),a.set(r,p)}}})),0===a.size&&n._residentGeomRecords.get(e).delete(i)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}},{key:"getResidentRenderGeometries",value:function(e,t){var n=this._residentGeomRecords.get(e);n&&n.forEach((function(e){return e.forEach((function(e){return t.push(e)}))}))}},{key:"_objectStateChanged",value:function(e,t){var n,r=(0,i.Z)(t.geometries);try{for(r.s();!(n=r.n()).done;){var a=n.value;this._updateOrCreateDirtyRecord(t,a,null,nb.T.UPDATE,e)}}catch(o){r.e(o)}finally{r.f()}}},{key:"visibilityChanged",value:function(e){this._objectStateChanged(nb.$.VISIBILITY,e)}},{key:"highlightChanged",value:function(e){this._objectStateChanged(nb.$.HIGHLIGHT,e)}},{key:"occlusionChanged",value:function(e){this._objectStateChanged(nb.$.OCCLUDEE,e)}},{key:"objectGeometryUpdated",value:function(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,nb.T.UPDATE,nb.$.GEOMETRY)}},{key:"layerAdded",value:function(e){var t=this;e.objects.forAll((function(n){return t._layerObjectAdded(e,n)}))}},{key:"layerRemoved",value:function(e){var t=this;e.objects.forAll((function(n){return t._layerObjectRemoved(e,n)}))}},{key:"layerObjectAdded",value:function(e){this._layerObjectAdded(e.layer,e.object)}},{key:"_layerObjectAdded",value:function(e,t){var n,r=e.id,a=(0,i.Z)(t.geometries);try{for(a.s();!(n=a.n()).done;){var o=n.value;this._objectGeometryAdded(t,o,r)}}catch(s){a.e(s)}finally{a.f()}}},{key:"layerObjectRemoved",value:function(e){this._layerObjectRemoved(e.layer,e.object)}},{key:"layerObjectsAdded",value:function(e){var t,n=(0,i.Z)(e.objects);try{for(n.s();!(t=n.n()).done;){var r=t.value;this._layerObjectAdded(e.layer,r)}}catch(a){n.e(a)}finally{n.f()}}},{key:"layerObjectsRemoved",value:function(e){var t,n=(0,i.Z)(e.objects);try{for(n.s();!(t=n.n()).done;){var r=t.value;this._layerObjectRemoved(e.layer,r)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_layerObjectRemoved",value:function(e,t){var n,r=e.id,a=(0,i.Z)(t.geometries);try{for(a.s();!(n=a.n()).done;){var o=n.value;this._objectGeometryRemoved(t,o,r)}}catch(s){a.e(s)}finally{a.f()}}},{key:"shaderTransformationChanged",value:function(e){var t=this,n=this._residentGeomRecords.get(e.id);n&&n.forEach((function(e,n){var r=t.model.getObject(n);r&&r.hasVolativeTransformation()&&e.forEach((function(e){return e.shaderTransformationChanged()}))}))}},{key:"objectTransformation",value:function(e){var t=this,n=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(n,r).forEach((function(r){t._updateOrCreateDirtyRecord(e,r.geometry,n,nb.T.UPDATE,nb.$.TRANSFORMATION)}))}},{key:"objectGeometryAdded",value:function(e){this._objectGeometryAdded(e.object,e.geometry)}},{key:"_objectGeometryAdded",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,n,nb.T.ADD)}},{key:"objectGeometryRemoved",value:function(e){this._objectGeometryRemoved(e.object,e.geometry)}},{key:"_objectGeometryRemoved",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._updateOrCreateDirtyRecord(e,t,n,nb.T.REMOVE)}},{key:"_updateOrCreateDirtyRecord",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:nb.$.NONE;n=(0,k.Pt)(n,this._getParentLayerId(e));var a=e.id,o=t.id,s=this._ensureDirtyRecord(n,a),l=s.get(o);if(l){var u=l.operation;u===nb.T.REMOVE&&r===nb.T.ADD&&l.states!==nb.$.NONE?l.operation=nb.T.UPDATE:u===nb.T.REMOVE&&r===nb.T.ADD||u===nb.T.ADD&&r===nb.T.REMOVE?s.delete(o):u!==nb.T.UPDATE||r!==nb.T.REMOVE&&r!==nb.T.UPDATE?((0,wr.hu)((u===nb.T.REMOVE||u===nb.T.ADD)&&r===nb.T.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),l.states|=i):(l.operation=r,l.states|=i)}else s.set(o,new rb(r,t,i));this.dirty=this._hasDirtyGeometryRecords}},{key:"_ensureGeomRecord",value:function(e,t){var n=this._residentGeomRecords.get(e);n||(n=new Map,this._residentGeomRecords.set(e,n));var r=n.get(t);return r||(r=new Map,n.set(t,r)),r}},{key:"_hasDirtyGeometryRecords",get:function(){return(0,Xd.oE)(this._dirtyGeomRecords,(function(e){return(0,Xd.oE)(e,(function(e){return e&&e.size>0}))}))}},{key:"_ensureDirtyRecord",value:function(e,t){var n=this._dirtyGeomRecords.get(e);n||(n=new Map,this._dirtyGeomRecords.set(e,n));var r=n.get(t);return r||(r=new Map,n.set(t,r)),r}},{key:"_getParentLayerId",value:function(e){return(0,k.pC)(e.parentLayer)?e.parentLayer.id:tb.u}},{key:"formatDebugInfo",value:function(){var e=["ADD","UPD",void 0,"REM"],t="";return this._dirtyGeomRecords.forEach((function(n,r){n.forEach((function(n,i){t.length>0&&(t+="\n"),t+=r+"."+i;var a=[];n.forEach((function(e){var t=e.operation;a[t]||(a[t]=[]),a[t].push(e.geometry.id)}));for(var o=0;o<a.length;o++)if(a[o]){t+=" "+e[o-1]+": ";for(var s=0;s<a[o].length;s++)t+=a[o][s]+", "}}))})),t}},{key:"test",get:function(){var e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((function(e,t){return e+t.size}),0)},commit:function(t){return e._dirtyGeomRecords.forEach((function(n,r){return e.commitLayer(r,t)}))}}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],ib.prototype,"model",void 0),(0,p._)([(0,Z.Cb)()],ib.prototype,"dirty",void 0);var ab=ib=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],ib),ob=n(39077),sb=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).dirtySet=new ab({model:(0,u.Z)(e)}),e._content=new Map,e._originFactory=new eb.C(null),e}return(0,l.Z)(n,[{key:"getObject",value:function(e){return this._content.get(e)}},{key:"add",value:function(e){var t=e.id;(0,wr.hu)(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),(0,Kg.e)(e)&&this.dirtySet.layerAdded(e)}},{key:"remove",value:function(e){(0,wr.hu)(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),(0,Kg.e)(e)&&this.dirtySet.layerRemoved(e)}},{key:"addMany",value:function(e){var t,n=(0,i.Z)(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;(0,k.pC)(r)&&((0,wr.hu)(!this._content.has(r.id),"Model/Stage already contains object to be added"),this._content.set(r.id,r))}}catch(a){n.e(a)}finally{n.f()}}},{key:"removeMany",value:function(e){var t,n=(0,i.Z)(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;(0,wr.hu)(this._content.has(r.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(r.id),r.unload()}}catch(a){n.e(a)}finally{n.f()}}},{key:"has",value:function(e){return this._content.has(e.id)}},{key:"forEachOfType",value:function(e,t){this._content.forEach((function(n){n.type===e&&t(n)}))}},{key:"getRenderGeometry",value:function(e,t){var n=t.shaderTransformer,r=t.localOrigin,i=new ob.z(t,{boundingInfo:t.boundingInfo,shaderTransformer:n,castShadow:e.castShadow});return i.updateTransformation((function(n){return e.getCombinedStaticTransformation(t,n)})),i.localOrigin=(0,k.pC)(r)?r:this._originFactory.getOrigin(i.boundingSphere),i}},{key:"updateRenderGeometryTransformation",value:function(e,t,n){if((0,k.Wi)(e))return!1;n.updateTransformation((function(n){return e.getCombinedStaticTransformation(t,n)}));var r=this._originFactory.getOrigin(n.boundingSphere);return n.localOrigin!==r}},{key:"getStats",value:function(){for(var e={},t=Array.from(this._content.values()),n=function(n){e[n]=t.filter((function(e){return e.type===n})).length},r=0;r<$g.U.COUNT;++r)n(r);return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}},{key:"test",get:function(){return{content:Array.from(this._content.values())}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({constructOnly:!0})],sb.prototype,"dirtySet",void 0),sb=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.parts.Model")],sb);var lb=n(23588),ub=n(32035),cb=n(92770),hb=n(49420),db=n(89414),fb=function(){function e(t){(0,s.Z)(this,e),this._totalCount=t,this._indexRanges=[0,t]}return(0,l.Z)(e,[{key:"allVisible",value:function(){return this.componentCount()===this._totalCount}},{key:"allInvisible",value:function(){return 0===this._indexRanges.length}},{key:"componentCount",value:function(){for(var e=this._indexRanges,t=0,n=0;n<e.length;n+=2)t+=e[n+1];return t}},{key:"reset",value:function(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){var t=new Array;if(0===e.length)return t;for(var n=e[0],r=1,i=1;i<e.length;i++){var a=e[i];n+r===a?r+=1:(t.push(n),t.push(r),n=a,r=1)}return t.push(n),t.push(r),t}(e)}},{key:"forEachComponent",value:function(e){for(var t=this._indexRanges,n=0;n<t.length;n+=2)for(var r=t[n],i=r+t[n+1],a=r;a<i;a++)if(!e(a))return!1;return!0}},{key:"forEachComponentRange",value:function(e){for(var t=this._indexRanges,n=0;n<t.length;n+=2){var r=t[n];if(!e(r,r+t[n+1]))return!1}return!0}},{key:"computeOffsetRanges",value:function(e){for(var t=new Array(this._indexRanges.length),n=this._indexRanges,r=0;r<n.length;r+=2){var i=n[r],a=i+n[r+1],o=e[i],s=e[a];t[r]=o,t[r+1]=s-o}return t}}]),e}();var pb=function(){function e(t,n){(0,s.Z)(this,e),this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=n.slice();var r=this.count;this.visibility=new fb(r),this.materialDataBuffer=t.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(var i=0;i<r;i++)this.materialDataIndices[i]=this.materialDataBuffer.acquireIndex()}return(0,l.Z)(e,[{key:"destroy",value:function(){for(var e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}},{key:"count",get:function(){return this.offsets.length-1}},{key:"geometryRanges",get:function(){return(0,k.Wi)(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}},{key:"highlightRanges",get:function(){return(0,k.Wi)(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}},{key:"defaultShadowMapRanges",get:function(){return(0,k.Wi)(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}},{key:"highlightsDirty",value:function(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}},{key:"visibilityDirty",value:function(){this.cachedGeometryRanges=null,this.highlightsDirty()}},{key:"_updateCachedHighlightRanges",value:function(){if(((0,k.Wi)(this.cachedHighlightRanges)||(0,k.Wi)(this.cachedDefaultRanges))&&(0,k.pC)(this.highlightCounts)){var e=function(e,t,n){var r=[],i=[],a=n.length,o=n.length;return t.forEachComponent((function(t){return e[t]>0?(a!==t-1&&(r.length&&r.push(n[a+1]-r[r.length-1]),r.push(n[t])),a=t):(o!==t-1&&(i.length&&i.push(n[o+1]-i[i.length-1]),i.push(n[t])),o=t),!0})),r.length&&r.push(n[a+1]-r[r.length-1]),i.length&&i.push(n[o+1]-i[i.length-1]),{highlightRanges:r,defaultRanges:i}}(this.highlightCounts,this.visibility,this.offsets),t=e.highlightRanges,n=e.defaultRanges;this.cachedHighlightRanges=t,this.cachedDefaultRanges=n}}}]),e}();var vb=n(64630);function mb(e,t,n,r){if(n>=t)return e;null==e&&(e=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return{isVisibleBit:!e,data:new Uint32Array(0)}}());var i=e.isVisibleBit,a=e.data,o=yb(a),s=n/o|0,l=n-o*s,u=(t-1)/o|0,c=a,h=r===i;if(!(n<c.length*o)&&h){var d=s+1,f=Math.ceil(1.5*c.length),p=u+1,v=Math.max(d,f);v=Math.min(v,p),(a=new Uint32Array(v)).set(c)}return s<a.length&&(a[s]=function(e,t,n){return e&~(1<<t)|(n?1:0)<<t}(a[s],l,h)),e.data=a,e}function _b(e,t){if(null==e)return!0;var n=e.isVisibleBit,r=e.data,i=yb(r);return t<r.length*i?function(e,t,n,r){var i=n/r|0,a=n-i*r;return function(e,t){return 0!=(e&1<<t)}(t[i],a)===e}(n,r,t,i):!e.isVisibleBit}function yb(e){return 8*e.BYTES_PER_ELEMENT}var gb=n(72838),bb=function(){function e(t,n){(0,s.Z)(this,e),this._indices=(0,k.pC)(t.indices)?t.indices:(0,gb.p)(t.positions.length/3),this._positions=new My.ct(t.positions),this._components=n,this._componentIntersectionData=new Array(n.count)}return(0,l.Z)(e,[{key:"getComponentAabb",value:function(e,t){if((0,k.pC)(this._perComponentAabbs)){for(var n=0;n<6;n++)t[n]=this._perComponentAabbs[6*e+n];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}},{key:"getComponentPositions",value:function(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}},{key:"intersect",value:function(e,t,n,r,i,a,o){var s=this,l=new wg.a(this._positions.typedBuffer,3,!1,this._positions.typedBufferStride),u=this._indices,c=this._components.offsets,h=(0,my.Ue)(e,t,wb),d=e[2],f=t[2];this._components.visibility.forEachComponent((function(p){if(!_b(s._components.pickability,p))return!0;var v=s.getComponentAabb(p,Cb);if((0,k.pC)(a)){var m=a[p];(0,k.pC)(i)?i.componentOffset=m:(e[2]=d-m,t[2]=f-m)}if((0,k.pC)(i)&&i.applyToAabb(v),!(0,my.Tw)(v,e,h,n))return!0;var _=c[p]/3,y=c[p+1]/3,g=y-_,b=function(e,t,n){return o(p,e,(0,Gt.t)(t,t,r),n)};return(0,k.Wi)(i)&&g>200?(null==s._componentIntersectionData[p]&&(s._componentIntersectionData[p]=new pg(s._indices,_,y,l)),s._componentIntersectionData[p].intersectRay({r0:e,r1:t},b)):(0,my.CN)(e,t,_,y,u,l,void 0,i,b),!0}))}},{key:"_computePerComponentAabbs",value:function(){var e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);for(var t=this._indices,n=this._positions.typedBuffer,r=this._positions.typedBufferStride,i=this._components.offsets,a=0,o=0;o<e;o++){for(var s=i[o],l=i[o+1],u=1/0,c=1/0,h=1/0,d=-1/0,f=-1/0,p=-1/0,v=s;v<l;v++){var m=t[v]*r,_=n[m],y=n[m+1],g=n[m+2];u=Math.min(u,_),c=Math.min(c,y),h=Math.min(h,g),d=Math.max(d,_),f=Math.max(f,y),p=Math.max(p,g)}this._perComponentAabbs[a++]=u,this._perComponentAabbs[a++]=c,this._perComponentAabbs[a++]=h,this._perComponentAabbs[a++]=d,this._perComponentAabbs[a++]=f,this._perComponentAabbs[a++]=p}}},{key:"positions",get:function(){return this._positions}},{key:"indices",get:function(){return this._indices}}]),e}(),wb=(0,F.c)(),Cb=(0,xc.Ue)(),xb=function(){function e(t,n,r){(0,s.Z)(this,e),this.material=t,this.geometry=n,this.meta=r}return(0,l.Z)(e,[{key:"destroy",value:function(){this.material.dispose(),this.geometry.dispose()}}]),e}(),Tb=function(){function e(t,n,r,i){(0,s.Z)(this,e),this.vao=t,this.primitiveType=n,this.parameters=r,this.indexed=i}return(0,l.Z)(e,[{key:"dispose",value:function(){this.vao.dispose()}}]),e}(),Sb=(0,l.Z)((function e(){(0,s.Z)(this,e),this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}));function kb(e){return e?Pb(e,1/0,-1/0):function(e,t){return{near:e,far:t}}(1/0,-1/0)}function Pb(e,t,n){return e.near=t,e.far=n,e}function Rb(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;return null!=t&&(n.near=Math.min(e.near,t.near),n.far=Math.max(e.far,t.far)),n}function Ab(e,t){return e.near<=t&&t<=e.far}var Eb={near:0,far:0};function Ob(e,t){var n=kb(),r=e.eye,i=e.frustum,a=e.viewForward;t.forAll((function(e){var t=(0,k.pC)(e.offsetObb)?e.offsetObb:e.obb,o=(0,Gt.e)((0,Gt.w)(Wb,t.center,r),a),s=(0,db.xz)(t,a);if(!Ab(n,o-s)||!Ab(n,o+s)){var l=function(e,t){for(var n=0,r=0;r<zb;r++){var i=(0,db.hZ)(e,t[r]);if(i>0)return-1;0===i&&(n|=1<<r)}return n}(t,i);if(-1!==l){if(0===l)return Zb.far=o+s,Zb.near=o-s,void Rb(n,Zb);var u=Mb.pushNew();u.near=o-s,u.far=o+s,u.mask=l,u.object=e}}}));for(var o=function(e){var t=Mb.data[e];if(Ab(n,t.near)&&Ab(n,t.far))return"continue";Zb.far=t.far,Zb.near=1/0;var o=function(e,t,n,r){(0,Es.c)(Gb,e.quaternion),(0,Gt.w)(Wb,t,e.center),(0,Gt.q)(Wb,Wb,Gb);var i=8*((Wb[0]<-e.halfSize[0]?-1:Wb[0]>e.halfSize[0]?1:0)+3*(Wb[1]<-e.halfSize[1]?-1:Wb[1]>e.halfSize[1]?1:0)+9*(Wb[2]<-e.halfSize[2]?-1:Wb[2]>e.halfSize[2]?1:0)+13),a=Hb[i];if(0===a)return a;(0,bn.c)(Bb,e.quaternion),(0,bn.d)(Bb,Bb,e.halfSize);var o=function(t,n){var r=Hb[i+n+1];return(0,Gt.s)(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),(0,Gt.t)(t,t,Bb),(0,Gt.a)(t,e.center,t)};return n.length=0,Vb(n,o(jb,0)),Vb(n,o(qb,1)),Vb(n,o(Wb,2)),Vb(n,o(Yb,3)),r(n),1===a||(n.length=0,Vb(n,jb),Vb(n,Yb),Vb(n,o(Wb,4)),Vb(n,o(Xb,5)),r(n),2===a||(n.length=0,Vb(n,jb),Vb(n,Xb),Vb(n,o(Wb,6)),Vb(n,qb),r(n))),a}((0,k.pC)(t.object.offsetObb)?t.object.offsetObb:t.object.obb,r,Lb,(function(e){for(var n=Nb,o=0;o<zb&&e.length>0;o++)if(0!=(t.mask&1<<o)){Fb(i[o],e,n);var s=e;e=n,n=s}for(var l=0;l<e.length;l+=3){(0,Gt.s)(Ib,e.data[l+0],e.data[l+1],e.data[l+2]);var u=(0,Gt.e)((0,Gt.w)(Ib,Ib,r),a);Zb.near=Math.min(Zb.near,u)}}));0===o&&(Zb.near=0),Rb(n,Zb)},s=0;s<Mb.length;s++)o(s);return Mb.length=0,n}var Mb=new Qd.Z({allocator:function(e){return e||{near:1/0,far:-1/0,mask:0,object:null}},deallocator:function(e){return e.object=(0,k.wN)(e.object),e}}),Zb=kb(),Ib=(0,F.c)(),Db=(0,F.c)(),Lb=new Qd.Z({deallocator:null}),Nb=new Qd.Z({deallocator:null});function Fb(e,t,n){n.length=0;var r=t.length-3;Ub(Ib,t,r);var i=(0,Us.jH)(e,Ib);i<=0&&(n.push(Ib[0]),n.push(Ib[1]),n.push(Ib[2]));for(var a=0,o=i;a<r;a+=3){Ub(Db,t,a);var s=(0,Us.jH)(e,Db);o*s<0&&((0,Gt.h)(Ib,Db,Ib,s/(s-o)),Vb(n,Ib)),s<=0&&Vb(n,Db),o=s,(0,Gt.c)(Ib,Db)}o*i<0&&(Ub(Db,t,r),(0,Gt.h)(Ib,Db,Ib,i/(i-o)),Vb(n,Ib))}function Ub(e,t,n){return(0,Gt.s)(e,t.data[n+0],t.data[n+1],t.data[n+2])}function Vb(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}var Hb=function(){var e=new Int8Array(216),t=0,n=function(n){for(var r=0;r<n.length;r++)e[t+r]=n[r];t+=8};return n([3,0,6,2,3,1,5,4]),n([2,0,2,3,1,5,4,0]),n([3,1,0,2,3,7,5,4]),n([2,0,1,3,2,6,4,0]),n([1,0,1,3,2,0,0,0]),n([2,1,5,7,3,2,0,0]),n([3,2,0,1,3,7,6,4]),n([2,2,0,1,3,7,6,0]),n([3,3,0,1,5,7,6,2]),n([2,0,1,5,4,6,2,0]),n([1,0,1,5,4,0,0,0]),n([2,1,3,7,5,4,0,0]),n([1,0,2,6,4,0,0,0]),n([0,0,0,0,0,0,0,0]),n([1,1,3,7,5,0,0,0]),n([2,2,3,7,6,4,0,0]),n([1,2,3,7,6,0,0,0]),n([2,3,1,5,7,6,2,0]),n([3,4,0,1,5,7,6,2]),n([2,5,7,6,4,0,1,0]),n([3,5,0,1,3,7,6,4]),n([2,4,5,7,6,2,0,0]),n([1,4,5,7,6,0,0,0]),n([2,5,1,3,7,6,4,0]),n([3,6,0,2,3,7,5,4]),n([2,6,2,3,7,5,4,0]),n([3,7,6,2,3,1,5,4]),e}(),zb=4;var Bb=(0,Ho.c)(),Gb=(0,Os.a)(),Wb=(0,F.c)(),jb=(0,F.c)(),qb=(0,F.c)(),Yb=(0,F.c)(),Xb=(0,F.c)(),Qb=function(){function e(t){(0,s.Z)(this,e),this._objects=t}return(0,l.Z)(e,[{key:"submit",value:function(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((function(n){return n.renderable.material.submit(e,t,n)}))}},{key:"queryShadowCasterDepthRange",value:function(e){return this._objects.visibleObjects.length?Ob(e,this._objects.visibleObjects):null}}]),e}(),Jb=n(92911),Kb=(0,l.Z)((function e(){(0,s.Z)(this,e),this.externalColor=(0,Wt.c)(),this.externalColorMixMode=hb.a9.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0})),$b=n(7564),ew=n(34659),tw=n(78041),nw=n(25920),rw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===I_.zO.WEBGL2,t.spherical=e.viewingMode===he.JY.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}},{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),iw)}},{key:"_setPipelineState",value:function(e){var t=this.configuration,n=t.integratedMeshMode!==$b.O.None,r=e===nw.A.NONE,i=e===nw.A.FrontFace;return(0,on.sm)({blending:t.output!==li.H.Color&&t.output!==li.H.Alpha||!t.blendingEnabled?null:r?tw.wu:(0,tw.j7)(e),culling:(0,on.zp)(t.cullFace),depthTest:{func:(0,tw.Bh)(e)},depthWrite:r||i?on.LZ:null,colorWrite:on.BK,stencilWrite:n||t.hasOccludees?Z_.s3:null,stencilTest:n?(0,Z_.ec)(bv.hU.IntegratedMeshMaskExcluded):t.hasOccludees?Z_.RY:null,polygonOffset:r||i?t.hasPolygonOffset?{factor:2,units:2}:null:tw.E0})}},{key:"initializePipeline",value:function(){return this._setPipelineState(this.configuration.transparencyPassType)}}]),n}(tn.A);rw.shader=new en.J(ew.C,(function(){return n.e(86940).then(n.bind(n,86940))}));var iw=new Map([[tr.T.POSITION,0],[tr.T.NORMAL,1],[tr.T.NORMALCOMPRESSED,1],[tr.T.COLOR,2],[tr.T.UV0,3],[tr.T.UVREGION,4],[tr.T.COMPONENTINDEX,5]]),aw=n(37107),ow=n(91871),sw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._dirty=!0,e}return(0,l.Z)(n,[{key:"_setDirty",value:function(){this._dirty=!0}},{key:"_setClean",value:function(){if(this._dirty=!1,null!=this._parameterBlocks){var e,t=(0,i.Z)(this._parameterBlocks);try{for(t.s();!(e=t.n()).done;){this[e.value]._setClean()}}catch(n){t.e(n)}finally{t.f()}}}},{key:"dirty",get:function(){return this._dirty||this._checkParameterBlocksDirty()}},{key:"_checkParameterBlocksDirty",value:function(){if(null==this._parameterBlocks)return!1;var e,t=(0,i.Z)(this._parameterBlocks);try{for(t.s();!(e=t.n()).done;){if(this[e.value].dirty)return!0}}catch(n){t.e(n)}finally{t.f()}return!1}}]),n}($t.K),lw=function(){function e(){(0,s.Z)(this,e),this._dirty=!0}return(0,l.Z)(e,[{key:"_setDirty",value:function(){this._dirty=!0}},{key:"_setClean",value:function(){this._dirty=!1}},{key:"dirty",get:function(){return this._dirty}}]),e}();function uw(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,n){var r,i=null!==(r=t._parameterCount)&&void 0!==r?r:0;if(t._parameterCount=i+1,e.vectorOps){var a=e.vectorOps;Object.defineProperty(t,n,{get:function(){return this[i]},set:function(e){var t=this[i];if(null==t)this[i]=e;else{if(a.equals(t,e))return;a.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,n,{get:function(){return this[i]},set:function(t){this[i]!==t&&(e.dispose&&this[i]&&this[i].dispose(),this[i]=t,this._setDirty())}})}}function cw(){return function(e,t){var n,r=null!==(n=e._parameterCount)&&void 0!==n?n:0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get:function(){return this[r]},set:function(e){this[r]!==e&&(this[r]=e,this._setDirty())}})}}var hw,dw,fw=n(74779),pw=n(96658),vw=n(26461),mw=n(86097),_w=function(){function e(t){(0,s.Z)(this,e),this._low=(0,xn.c)(),this._high=(0,xn.c)(),t&&this.set(t)}return(0,l.Z)(e,[{key:"low",get:function(){return this._low}},{key:"high",get:function(){return this._high}},{key:"set",value:function(e){var t=this._low,n=this._high;(0,Gt.c)(t,e),(0,Gt.w)(n,e,t)}},{key:"setElements",value:function(e,t,n){(0,Gt.s)(yw,e,t,n),this.set(yw)}},{key:"get",value:function(e){return(0,Gt.a)(e,this._low,this._high)}},{key:"getLowScaled",value:function(e){return(0,Gt.g)(e,this._low,1)}}]),e}(),yw=(0,F.c)(),gw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;(0,s.Z)(this,n),(i=t.call(this)).toMapSpace=r,i.baseColor=(0,Fp.f)(1,1,1,1),i.usePBR=!1,i.hasParametersFromSource=!1,i.mrrFactors=(0,xn.f)(1,1,.5),i.emissiveFactor=(0,xn.f)(0,0,0),i.baseColorTexture=null,i.metallicRoughnessTexture=null,i.emissionTexture=null,i.occlusionTexture=null,i.normalTexture=null,i.objectOpacity=1,i.commonMaterialParameters=new bw,i.componentParameters=new ww,i.textureAlphaCutoff=vw.F,i.alphaDiscardMode=bv.JJ.Opaque,i.isIntegratedMesh=!1,i.polygonOffsetEnabled=!1,i.ellipsoidMode=mw.U.Earth,i.hasOccludees=!1,i._techniqueConfiguration=new $b._;var a=new _w(e.position),o=(0,lb.a)(e.rotationScale);return(0,bn.e)(o,o),i.transformNormalGlobalFromModel=(0,bn.t)(o,o),i.transformWorldFromModelTL=a.low,i.transformWorldFromModelTH=a.high,i.transformWorldFromModelRS=e.rotationScale,i}return(0,l.Z)(n,[{key:"dispose",value:function(){this._technique=(0,k.RY)(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}},{key:"texture",get:function(){return(0,k.pC)(this.baseColorTexture)?this.baseColorTexture.glTexture:null}},{key:"textureMetallicRoughness",get:function(){return(0,k.pC)(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}},{key:"textureEmissive",get:function(){return(0,k.pC)(this.emissionTexture)?this.emissionTexture.glTexture:null}},{key:"textureOcclusion",get:function(){return(0,k.pC)(this.occlusionTexture)?this.occlusionTexture.glTexture:null}},{key:"textureNormal",get:function(){return(0,k.pC)(this.normalTexture)?this.normalTexture.glTexture:null}},{key:"prepareTechnique",value:function(e,t,n,r){var i=this._techniqueConfiguration;i.hasVertexColors=r.colors,i.hasNormals=r.normals,i.textureCoordinateType=r.textureCoordinates,i.hasMetallicRoughnessTexture=(0,k.pC)(this.metallicRoughnessTexture),i.hasEmissionTexture=(0,k.pC)(this.emissionTexture),i.hasOcclusionTexture=(0,k.pC)(this.occlusionTexture),i.hasNormalTexture=(0,k.pC)(this.normalTexture),i.transparencyPassType=t.identifier===fw.o9.Material&&null!=n.transparencyPassType?n.transparencyPassType:nw.A.NONE,i.hasMultipassTerrain=t.identifier===fw.o9.Material&&null!=n.multipassTerrain&&n.multipassTerrain.enabled,i.cullAboveGround=t.identifier===fw.o9.Material&&null!=n.multipassTerrain&&n.multipassTerrain.cullAboveGround,i.ellipsoidMode=this.ellipsoidMode,i.componentData=this.componentParameters.type,i.cullFace=this.commonMaterialParameters.cullFace,i.doubleSidedMode=this.commonMaterialParameters.doubleSided?pw.q.View:pw.q.None,i.hasBaseColorTexture=(0,k.pC)(this.baseColorTexture);var a=this._computeWhichMaterialPass();i.blendingEnabled=a===hw.Transparent||a===hw.OpaqueAndTransparent,i.alphaDiscardMode=this.alphaDiscardMode,i.integratedMeshMode=this.isIntegratedMesh?function(e){return 0!==e.overlays.length&&(0,k.pC)(e.overlays[Cm.fu.INNER].getColorTextureNoRasterImage())}(n)?(0,ew.g)(n)?$b.O.ColorOverlayWithWater:$b.O.ColorOverlay:$b.O.NoOverlay:$b.O.None,i.useLegacyTerrainShading=this.isIntegratedMesh&&Jd.Z.TERRAIN_USE_LEGACY_SHADING,i.hasPolygonOffset=this.polygonOffsetEnabled;var o=this.hasParametersFromSource&&(0,k.Wi)(this.baseColorTexture);if(i.pbrMode=i.integratedMeshMode===$b.O.ColorOverlayWithWater?Sg.f7.WaterOnIntegratedMesh:this.usePBR?o?Sg.f7.Schematic:Sg.f7.Normal:Sg.f7.Disabled,i.normalType=i.integratedMeshMode===$b.O.None?i.hasNormals?xg.h.CompressedAttribute:xg.h.ScreenDerivative:xg.h.Ground,i.hasSlicePlane=(0,k.pC)(n.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,t.identifier===fw.o9.ShadowMap)i.output=li.H.Shadow,i.vertexDiscardMode=ow.a.None;else if(t.identifier===fw.o9.Highlight)i.output=li.H.Highlight,i.vertexDiscardMode=ow.a.None;else{switch(this._computeWhichMaterialPass()===hw.OpaqueAndTransparent?i.vertexDiscardMode=t.transparent?ow.a.Opaque:ow.a.Transparent:i.vertexDiscardMode=ow.a.None,i.output=t.output,i.receiveAmbientOcclusion=!1,i.receiveShadows=!1,t.output){case li.H.Color:i.receiveAmbientOcclusion=n.ssaoHelper.active,i.hasOccludees=n.hasOccludees,i.receiveShadows=n.shadowMap.ready,i.hasScreenSpaceReflections=n.ssr.enabled,i.hasCloudsReflections=(0,k.pC)(n.cloudsFade.data);break;case li.H.Alpha:i.hasOccludees=n.hasOccludees;break;case li.H.ObjectAndLayerIdColor:i.objectAndLayerIdColor=!0}i.snowCover=this.hasSnowCover(n)}return this._technique=e.releaseAndAcquire(rw,i,this._technique),this._setClean(),this._technique}},{key:"hasSnowCover",value:function(e){return(0,k.pC)(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}},{key:"submit",value:function(e,t,n){if(0!==this.objectOpacity){var r=n.renderable.geometry,i=n.components,a=n.renderable.meta.cameraDepthSquared,o=i.geometryRanges,s=i.highlightRanges,l=i.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case hw.Opaque:e.materialOpaque.submitDraw(this,r,o,a);break;case hw.Transparent:e.materialTransparent.submitDraw(this,r,o,a);break;case hw.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,r,o,a),e.materialTransparent.submitDraw(this,r,o,a);break;case hw.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,r,o,a),function(e){return 0!==e.overlays.length&&(0,k.pC)(e.overlays[Cm.fu.INNER].getValidTexture(Cm.NH.Highlight))}(t)&&e.highlightIntegratedMesh.submitDraw(this,r,o,a)}var u=this.componentParameters.castShadows!==dw.None;u&&e.shadowMap.submitDraw(this,r,o,a),(0,k.pC)(s)&&(e.highlight.submitDraw(this,r,s,a),u&&e.highlightShadowMap.submitDraw(this,r,s,a)),u&&(0,k.pC)(l)&&e.defaultShadowMap.submitDraw(this,r,l,a)}}},{key:"_computeWhichMaterialPass",value:function(){return this.isIntegratedMesh?hw.IntegratedMesh:this.objectOpacity<1?hw.Transparent:this.componentParameters.opaqueOverride===dw.All?hw.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===bv.JJ.Blend||this.alphaDiscardMode===bv.JJ.MaskBlend?hw.Transparent:this.componentParameters.transparent===dw.None?hw.Opaque:this.componentParameters.transparent===dw.All?hw.Transparent:hw.OpaqueAndTransparent}}]),n}(sw);(0,p._)([uw({vectorOps:Xt.v})],gw.prototype,"baseColor",void 0),(0,p._)([uw()],gw.prototype,"usePBR",void 0),(0,p._)([uw()],gw.prototype,"hasParametersFromSource",void 0),(0,p._)([uw({vectorOps:Gt.G})],gw.prototype,"mrrFactors",void 0),(0,p._)([uw({vectorOps:Gt.G})],gw.prototype,"emissiveFactor",void 0),(0,p._)([uw({dispose:!0})],gw.prototype,"baseColorTexture",void 0),(0,p._)([uw({dispose:!0})],gw.prototype,"metallicRoughnessTexture",void 0),(0,p._)([uw({dispose:!0})],gw.prototype,"emissionTexture",void 0),(0,p._)([uw({dispose:!0})],gw.prototype,"occlusionTexture",void 0),(0,p._)([uw({dispose:!0})],gw.prototype,"normalTexture",void 0),(0,p._)([uw()],gw.prototype,"objectOpacity",void 0),(0,p._)([cw()],gw.prototype,"commonMaterialParameters",void 0),(0,p._)([cw()],gw.prototype,"componentParameters",void 0),(0,p._)([uw()],gw.prototype,"textureAlphaCutoff",void 0),(0,p._)([uw()],gw.prototype,"alphaDiscardMode",void 0),(0,p._)([uw()],gw.prototype,"isIntegratedMesh",void 0),(0,p._)([uw()],gw.prototype,"polygonOffsetEnabled",void 0),(0,p._)([uw()],gw.prototype,"ellipsoidMode",void 0),(0,p._)([uw()],gw.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(hw||(hw={}));var bw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).doubleSided=!1,e.cullFace=bv.Vr.Back,e.hasSlicePlane=!0,e}return(0,l.Z)(n)}(lw);(0,p._)([uw()],bw.prototype,"doubleSided",void 0),(0,p._)([uw()],bw.prototype,"cullFace",void 0),(0,p._)([uw()],bw.prototype,"hasSlicePlane",void 0);var ww=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).externalColor=(0,Wt.f)(1,1,1,1),e.externalColorMixMode=hb.a9.Multiply,e.castShadows=dw.All,e}return(0,l.Z)(n,[{key:"transparent",get:function(){return this.externalColor[3]<1?dw.All:dw.None}},{key:"opaqueOverride",get:function(){return this.externalColorMixMode===hb.a9.Replace&&1===this.externalColor[3]?dw.All:dw.None}},{key:"visible",get:function(){return this.externalColor[3]>0?dw.All:dw.None}},{key:"type",get:function(){return aw._N.Uniform}}]),n}(lw);(0,p._)([uw({vectorOps:Xt.v})],ww.prototype,"externalColor",void 0),(0,p._)([uw()],ww.prototype,"externalColorMixMode",void 0),(0,p._)([uw()],ww.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(dw||(dw={}));var Cw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).texture=null,e.transparent=dw.None,e.opaqueOverride=dw.None,e.castShadows=dw.None,e}return(0,l.Z)(n,[{key:"type",get:function(){return aw._N.Varying}}]),n}(lw);(0,p._)([uw()],Cw.prototype,"texture",void 0),(0,p._)([uw()],Cw.prototype,"transparent",void 0),(0,p._)([uw()],Cw.prototype,"opaqueOverride",void 0),(0,p._)([uw()],Cw.prototype,"castShadows",void 0);var xw=n(67009),Tw=n(79762),Sw=function(){function e(t){(0,s.Z)(this,e),this._maxCount=t,this._nextIndex=0,this._recycledIndices=[]}return(0,l.Z)(e,[{key:"activeCount",get:function(){return this._nextIndex-this._recycledIndices.length}},{key:"availableCount",get:function(){return this._recycledIndices.length+this._maxCount-this._nextIndex}},{key:"acquire",value:function(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}},{key:"release",value:function(e){this._recycledIndices.push(e)}}]),e}(),kw=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,s.Z)(this,e),this._rctx=t,this._fieldCount=n,this.textureWidth=4096,this._dirty=!0,this._texture=new rr.x(this._rctx,{target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,samplingMode:an.cw.NEAREST,wrapMode:an.e8.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this._data=new My.mc(new ArrayBuffer(4*this.textureWidth))}return(0,l.Z)(e,[{key:"dispose",value:function(){this._texture.dispose(),this._texture=void 0,this._data=void 0}},{key:"setData",value:function(e,t,n,r,i,a){var o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,n),this._data.set(o,1,r),this._data.set(o,2,i),this._data.set(o,3,a)}},{key:"setDataElement",value:function(e,t,n,r){var i=e*this._fieldCount+t;this._dirty=!0,this._data.set(i,n,r)}},{key:"resizeToFit",value:function(e){var t=e*this._fieldCount;if(t>=this._data.count){var n=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,r=new My.mc(new ArrayBuffer(4*n));r.typedBuffer.set(this._data.typedBuffer),this._data=r}}},{key:"updateTexture",value:function(){if(this._dirty){var e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}}},{key:"texture",get:function(){return this._texture}}]),e}(),Pw=65536,Rw=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,s.Z)(this,e),this.textureBuffer=new kw(t,n),this._indexManager=new Sw(Pw)}return(0,l.Z)(e,[{key:"dispose",value:function(){this.textureBuffer.dispose(),this.textureBuffer=void 0}},{key:"availableCount",get:function(){return this._indexManager.availableCount}},{key:"activeCount",get:function(){return this._indexManager.activeCount}},{key:"acquireIndex",value:function(){var e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}},{key:"releaseIndex",value:function(e){this._indexManager.release(e)}}]),e}(),Aw=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;(0,s.Z)(this,e),this._rctx=t,this._fieldCount=n,this._buffers=[]}return(0,l.Z)(e,[{key:"garbageCollect",value:function(){this._buffers=this._buffers.filter((function(e){return 0!==e.activeCount||(e.dispose(),!1)}))}},{key:"destroy",value:function(){this._buffers.forEach((function(e){return e.dispose()})),this._buffers=[]}},{key:"getBuffer",value:function(e){var t,n=(0,i.Z)(this._buffers);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.availableCount>=e)return r}}catch(o){n.e(o)}finally{n.f()}if(e>Pw)return null;var a=new Rw(this._rctx,this._fieldCount);return this._buffers.push(a),a}},{key:"updateTextures",value:function(){var e,t=(0,i.Z)(this._buffers);try{for(t.s();!(e=t.n()).done;){e.value.textureBuffer.updateTexture()}}catch(n){t.e(n)}finally{t.f()}}}]),e}(),Ew=n(45412),Ow=S.Z.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection"),Mw=function(){function e(t,n){(0,s.Z)(this,e),this._renderManager=t,this._viewingMode=n,this._objects=[new Qd.Z,new Qd.Z],this._renderSubmit=new Qb(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=(0,x.Z)("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new Aw(t.rctx,2+(this._hasObjectAndLayerId?1:0))}return(0,l.Z)(e,[{key:"destroy",value:function(){(0,wr.hu)(0===this._objects[vb.Z.Hidden].length&&0===this._objects[vb.Z.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}},{key:"createObject",value:function(e){var t=new vb.c;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=(0,db.d9)(e.obb),t.components=new pb(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new bb(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t}},{key:"destroyObject",value:function(e){var t=e;this._objects[t.visible].removeUnordered(t),t.destroy(),this._notifyDirty()}},{key:"setObjectVisibility",value:function(e,t){var n=e;t!==n.visible&&(this._objects[n.visible].removeUnordered(n),this._objects[t].push(n),n.visible=t,this._notifyDirty())}},{key:"preSubmit",value:function(e){var t=e.camera.eye;this.visibleObjects.forAll((function(e){return e.renderable.meta.cameraDepthSquared=(0,Gt.d)(t,e.obb.center)}))}},{key:"getMaterial",value:function(e){return e.renderable.material}},{key:"updateMaterial",value:function(e,t){var n=e.renderable.material;t(n),n.dirty&&this._notifyDirty()}},{key:"setAllComponentVisibilities",value:function(e,t){var n=e;n.components.visibility.reset(t),n.components.visibilityDirty(),this._notifyDirty()}},{key:"forEachVisibleComponent",value:function(e,t){return e.components.visibility.forEachComponent(t)}},{key:"getComponentCount",value:function(e){var t=e,n=t.components.visibility.componentCount();return{visible:n,invisible:t.components.count-n}}},{key:"setComponentData",value:function(e,t){for(var n=e,r=n.renderable.material,i=n.components,a=i.materialDataBuffer,o=i.materialDataIndices,s=new Kb,l=a.textureBuffer,u=new Uint8Array(4),c=new Uint32Array(u.buffer),h=0,d=0,f=0,p=i.verticalOffsets,v=1/0,m=-1/0,_=!1,y=!1,g=0,b=0;b<i.count;b++){t(b,s),h+=+(s.externalColor[3]<1),d+=+(s.externalColorMixMode===hb.a9.Replace&&1===s.externalColor[3]),f+=+s.castShadows,(0,hb.HB)(s.externalColor,s.externalColorMixMode,u),u[2]=254&u[2]|+s.castShadows,l.setData(o[b],0,u[0],u[1],u[2],u[3]),_||(_=b>0&&g!==c[0]),g=c[0],y||(y=0!==s.elevationOffset),y&&(0,k.Wi)(p)&&(p=new Array(b).fill(0)),(0,k.pC)(p)&&(p[b]=s.elevationOffset),v=Math.min(v,s.elevationOffset),m=Math.max(m,s.elevationOffset),(0,aw.nO)(s.elevationOffset,u),l.setData(o[b],1,u[0],u[1],u[2],u[3]);var w=s.objectAndLayerIdColor;(0,k.pC)(w)&&l.setData(o[b],2,w[0],w[1],w[2],w[3]),s.pickable!==_b(i.pickability,b)&&(i.pickability=mb(i.pickability,i.count,b,s.pickable))}i.verticalOffsets=y?p:null,n.offsetObb=y?(0,db.gI)(n.obb,v,m,this._viewingMode,(0,k.pC)(n.offsetObb)?n.offsetObb:(0,db.d9)(n.obb)):null,_||y||this._hasObjectAndLayerId?(r.componentParameters=new Cw,r.componentParameters.castShadows=Iw(f,i.count),r.componentParameters.transparent=Iw(h,i.count),r.componentParameters.opaqueOverride=Iw(d,i.count),r.componentParameters.texture=l,l.updateTexture()):(r.componentParameters=new ww,r.componentParameters.castShadows=s.castShadows?dw.All:dw.None,r.componentParameters.externalColor=s.externalColor,r.componentParameters.externalColorMixMode=s.externalColorMixMode),this._notifyDirty()}},{key:"getComponentAabb",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e.intersectionGeometry.getComponentAabb(t,n);var i=e,a=i.components.verticalOffsets;if(r||(0,k.Wi)(a))return n;var o=a[t];if(this._viewingMode===he.JY.Local||0===o)return n[2]+=o,n[5]+=o,n;var s=(0,k.Wg)((0,Gs.iO)(o));return s.localOrigin=i.transform.position,s.applyToAabb(n)}},{key:"getComponentObb",value:function(e){return e.obb}},{key:"getObjectTransform",value:function(e){return e.transform}},{key:"getComponentPositions",value:function(e,t,n){return e.intersectionGeometry.getComponentPositions(t,n)}},{key:"intersect",value:function(e,t,n,r,i,a){var o=e;(0,k.pC)(i)&&(i.localOrigin=o.transform.position);var s=(0,bn.e)(Lw,o.transform.rotationScale);(0,Gt.w)(Nw,t,o.transform.position),(0,Gt.w)(Fw,n,o.transform.position),(0,Gt.t)(Nw,Nw,s),(0,Gt.t)(Fw,Fw,s);var l=(0,bn.t)(Lw,s);return o.intersectionGeometry.intersect(Nw,Fw,r,l,i,o.components.verticalOffsets,a)}},{key:"addEdges",value:function(e,t,n,r){var i=e,a=i.intersectionGeometry,o=a.indices,s=a.positions,l=i.components.offsets;return t.addComponentObject(e,i.transform,{center:i.obb.center,radius:(0,db.q0)(i.obb)},s,o,l,n,r)}},{key:"extractEdgeInformation",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r){var i,o,s,l,u,c,h,d,f;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o=(i=t).components.visibility).allInvisible()){e.next=3;break}return e.abrupt("return",{buffer:Tw.n_.createBuffer(0),origin:[0,0,0]});case 3:return s=i.intersectionGeometry,l=s.indices,u=s.positions,c=i.components.offsets,h=xw.tf.createBuffer(u.count),(0,cb.c)(h.position,u),(0,ub.a)(h.position,h.position,i.transform.rotationScale),this._setComponentIndices(h.componentIndex,l,c),d=h.count,f=this._computeVisibilityIndices(l,o,c,d),e.t0=(0,F.a)(i.transform.position),e.next=9,n.extractComponentsEdgeLocations({indices:f,indicesLength:f.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},r);case 9:return e.t1=e.sent,e.abrupt("return",{origin:e.t0,buffer:e.t1});case 11:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_setComponentIndices",value:function(e,t,n){for(var r=0,i=0;i<n.length-1;i++){for(var a=n[i],o=n[i+1],s=a;s<o;s++){var l=t?t[s]:s;e.set(l,r)}r++}}},{key:"_computeVisibilityIndices",value:function(e,t,n,r){if(e&&t.allVisible())return e;var i=0;t.forEachComponentRange((function(e,t){return i+=n[t]-n[e],!0}));var a=Array.isArray(e)?new Array(i):2===(null===e||void 0===e?void 0:e.BYTES_PER_ELEMENT)||r<=65536?new Uint16Array(i):new Uint32Array(i),o=0;return t.forEachComponentRange((function(t,r){for(var i=n[t],s=n[r],l=i;l<s;l++)a[o++]=e?e[l]:l;return!0})),a}},{key:"addComponentHighlight",value:function(e,t){var n=e.components;(0,k.Wi)(n.highlightCounts)&&(n.highlightCounts=new Uint32Array(n.count+1)),0===n.highlightCounts[t]++&&(n.highlightsDirty(),this._notifyDirty()),n.highlightCounts[n.count]++}},{key:"removeComponentHighlight",value:function(e,t){var n=e.components;if((0,k.Wi)(n.highlightCounts))Ow.warn("Removing non-existing highlight.");else{var r=n.highlightCounts[t],i=n.highlightCounts[n.count];if(0!==r){if(r>1)return n.highlightCounts[t]=r-1,void(n.highlightCounts[n.count]=i-1);n.highlightCounts[t]=0,n.highlightsDirty(),this._notifyDirty(),1===i?n.highlightCounts=null:n.highlightCounts[n.count]=i-1}else Ow.warn("Removing non-existing highlight.")}}},{key:"clearHighlights",value:function(e){var t=e.components;(0,k.pC)(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}},{key:"getObjectGPUMemoryUsage",value:function(e){return e.renderable.meta.gpuMemoryEstimate}},{key:"visibleObjects",get:function(){return this._objects[vb.Z.Visible]}},{key:"_createRenderable",value:function(e,t){for(var n=this._renderManager.rctx,r=e.geometry,i=r.vertices.layoutParameters,a=nr.f.createVertex(n,an.l1.STATIC_DRAW,r.vertices.data),o=(0,k.yw)(r.indices,(function(e){return nr.f.createIndex(n,an.l1.STATIC_DRAW,e)})),s=(0,Jn.K)((0,Jb.N)(i)),l=new Uint16Array(r.vertices.count),u=0;u<t.count;u++){var c=t.offsets[u],h=t.offsets[u+1],d=t.materialDataIndices[u];if((0,k.pC)(r.indices))for(var f=c;f<h;f++)l[r.indices[f]]=d;else for(var p=c;p<h;p++)l[p]=d}var v=nr.f.createVertex(n,an.l1.STATIC_DRAW,l.buffer),m=new gw(e.transform,e.toMapSpace),_=new Ew.U(n,iw,{data:s,componentIndices:Zw},{data:a,componentIndices:v},(0,k.Wg)(o)),y=new Tb(_,an.MX.TRIANGLES,i,(0,k.pC)(o)),g={cameraDepthSquared:.5,gpuMemoryEstimate:a.byteSize+v.byteSize+((0,k.pC)(o)?o.byteSize:0)};return new xb(m,y,g)}},{key:"_notifyDirty",value:function(){this._renderManager.notifyDirty()}}]),e}(),Zw=(0,Jn.K)((0,Kn.U$)().u16(tr.T.COMPONENTINDEX));function Iw(e,t){return e===t?dw.All:0===e?dw.None:dw.Some}var Dw,Lw=(0,lb.c)(),Nw=(0,F.c)(),Fw=(0,F.c)(),Uw=n(51992),Vw=n(4170);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(Dw||(Dw={}));var Hw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).alphaMode=Dw.None,e.hasOpacityFactor=!1,e}return(0,l.Z)(n)}(un.m);(0,p._)([(0,un.o)({count:Dw.COUNT})],Hw.prototype,"alphaMode",void 0),(0,p._)([(0,un.o)()],Hw.prototype,"hasOpacityFactor",void 0);var zw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){switch(this.configuration.alphaMode){case Dw.None:return(0,on.sm)({colorWrite:on.BK});case Dw.Alpha:return(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK});case Dw.PremultipliedAlpha:case Dw.COUNT:return(0,on.sm)({blending:(0,on.if)(an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK})}}}]),n}(tn.A);zw.shader=new en.J(Vw.a,(function(){return n.e(44016).then(n.bind(n,44016))}));var Bw=n(67273),Gw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}]),n}(tn.A);Gw.shader=new en.J(Bw.a,(function(){return n.e(58323).then(n.bind(n,58323))}));var Ww=n(90829),jw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK})}}]),n}(tn.A);jw.shader=new en.J(Ww.a,(function(){return n.e(19409).then(n.bind(n,19409))}));var qw=n(38365),Yw=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.if)(an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK})}}]),n}(tn.A);Yw.shader=new en.J(qw.a,(function(){return n.e(46487).then(n.bind(n,46487))}));var Xw=function(){function e(t,n){(0,s.Z)(this,e),this._rctx=t,this._techniqueRepository=n,this._configuration=new Hw,this._passParameters=new Vw.C,this._oitParameters=new Ww.O,this._hudParameters=new Bw.H,this._overlayParameters=new qw.O}return(0,l.Z)(e,[{key:"destroy",value:function(){this._vao=(0,k.M2)(this._vao)}},{key:"compositeOIT",value:function(e,t,n,r){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=n,this._oitParameters.frontFaceTexture=r;var i=this._rctx,a=this._techniqueRepository.acquire(jw);i.bindTechnique(a,this._oitParameters,e);var o=this._ensureVAO();i.bindVAO(o),i.drawArrays(an.MX.TRIANGLE_STRIP,0,(0,ir._V)(o,"geometry")),a.release()}},{key:"compositeHUD",value:function(e,t){this._hudParameters.texture=t;var n=this._rctx,r=this._techniqueRepository.acquire(Gw);n.bindTechnique(r,this._hudParameters,e);var i=this._ensureVAO();n.bindVAO(i),n.drawArrays(an.MX.TRIANGLE_STRIP,0,(0,ir._V)(i,"geometry")),r.release()}},{key:"compositeOverlay",value:function(e,t,n,r){this._overlayParameters.texture=t,this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=r;var i=this._rctx,a=this._techniqueRepository.acquire(Yw);i.bindTechnique(a,this._overlayParameters,e);var o=this._ensureVAO();i.bindVAO(o),i.drawArrays(an.MX.TRIANGLE_STRIP,0,(0,ir._V)(o,"geometry")),a.release()}},{key:"composite",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Dw.None,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=this._rctx;this._configuration.alphaMode=n,this._configuration.hasOpacityFactor=1!==r,this._passParameters.texture=t,this._passParameters.opacity=r;var a=this._techniqueRepository.acquire(zw,this._configuration);i.bindTechnique(a,this._passParameters,e);var o=this._ensureVAO();i.bindVAO(o),i.drawArrays(an.MX.TRIANGLE_STRIP,0,(0,ir._V)(o,"geometry")),a.release()}},{key:"_ensureVAO",value:function(){return(0,k.Wi)(this._vao)&&(this._vao=(0,dn.ow)(this._rctx)),this._vao}}]),e}(),Qw=n(46228),Jw=n(78329);function Kw(e,t,n){return(0,Qw.v)(t,e)*(n[1]-n[0])+n[0]}function $w(e,t,n){var r=0;if(!t.some((function(e){return(r+=e.numGeometries)>=1e4})))return fC.compute(e,t);var i=kb();return n.forAll((function(t){t.visible&&Rb(i,function(e,t){if(!t.visible)return;var n=kb(),r=t.getSpatialQueryAccelerator();return(0,k.pC)(r)?function(e,t,n){var r=t.eye,i=t.viewForward,a=t.frustum,o=function(e){return e.visible},s=n.objectCount;if(s<500)Pb(hC,t.near,Math.min(e.near,t.far)),n.forEachInDepthRange(r,i,Jw.Z.DepthOrder.FRONT_TO_BACK,hC,(function(n,r){eC(e,t,n),hC.far=e.near,r.setRange(hC)}),a,o),Pb(hC,Math.max(e.far,t.near),t.far),n.forEachInDepthRange(r,i,Jw.Z.DepthOrder.BACK_TO_FRONT,hC,(function(n,r){eC(e,t,n),hC.near=e.far,r.setRange(hC)}),a,o);else{var l=Math.max(Math.min(s,500),Math.ceil(.1*s)),u=n.findClosest(i,Jw.Z.DepthOrder.FRONT_TO_BACK,a,o,l),c=n.findClosest(i,Jw.Z.DepthOrder.BACK_TO_FRONT,a,o,l);u&&c&&(nC(e,t,u.boundingVolumeWorldSpace.bounds),nC(e,t,c.boundingVolumeWorldSpace.bounds))}}(n,e,r):function(e,t,n){dC.clear(),n.forAll((function(e){e.visible&&0!==e.geometries.length&&dC.add(e)})),dC.empty||(dC.sort(t),Pb(hC,t.near,Math.min(e.near,t.far)),dC.forEachInDepthRange(hC,Jw.Z.DepthOrder.FRONT_TO_BACK,(function(n,r){r<e.near&&eC(e,t,n)})),Pb(hC,Math.max(e.far,t.near),t.far),dC.forEachInDepthRange(hC,Jw.Z.DepthOrder.BACK_TO_FRONT,(function(t,n,r){e.far=Math.max(e.far,r)})))}(n,e,t.objects),n}(e,t))})),i}function eC(e,t,n){if(n.visible&&(0,Tc.hr)(t.frustum,n.boundingVolumeWorldSpace.bounds)){var r=n.transformation,i=cC;n.geometries.forEach((function(n){(0,wn.m)(i,r,n.shaderTransformation);var a=(0,Pe.u1)(i);tC(e,t,n.boundingInfo,i,a)}))}}function tC(e,t,n,r,a){if(!(0,k.Wi)(n)){(0,Gt.m)(uC,n.center,r);var o=t.eye,s=t.viewForward,l=s[0]*(uC[0]-o[0])+s[1]*(uC[1]-o[1])+s[2]*(uC[2]-o[2]);if(uC[3]=n.radius*a,!(l-uC[3]>e.near&&l+uC[3]<e.far)&&(0,Tc.hr)(t.frustum,uC))if(n.radius>100&&n.getChildren()){var u,c=(0,i.Z)(n.getChildren());try{for(c.s();!(u=c.n()).done;){tC(e,t,u.value,r,a)}}catch(h){c.e(h)}finally{c.f()}}else pC.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,n.bbMin,n.bbMax)}}function nC(e,t,n){var r=t.eye,i=t.viewForward,a=(n[0]-r[0])*i[0]+(n[1]-r[1])*i[1]+(n[2]-r[2])*i[2];e.near=Math.min(e.near,a-n[3]),e.far=Math.max(e.far,a+n[3])}var rC,iC,aC=function(){function e(){(0,s.Z)(this,e),this._items=new Qd.Z({allocator:function(e){return e||{obj:null,distance:0,near:0,far:0}},deallocator:function(e){return e.obj=null,e.distance=0,e.near=0,e.far=0,e}})}return(0,l.Z)(e,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}},{key:"clear",value:function(){this._items.clear()}},{key:"add",value:function(e){this._items.pushNew().obj=e}},{key:"sort",value:function(e){var t=e.eye,n=e.viewForward;this._items.forAll((function(e){var r=e.obj.boundingVolumeWorldSpace.bounds,i=(r[0]-t[0])*n[0]+(r[1]-t[1])*n[1]+(r[2]-t[2])*n[2];e.distance=i,e.near=i-r[3],e.far=i+r[3]})),this._items.sort((function(e,t){return e.distance-t.distance}))}},{key:"forEachInDepthRange",value:function(e,t,n){if(t===Jw.Z.DepthOrder.FRONT_TO_BACK)for(var r=0;r<this._items.length;++r){var i=this._items.data[r];i.far<e.near||i.near>e.far||n(i.obj,i.near,i.far)}else for(var a=this._items.length-1;a>=0;--a){var o=this._items.data[a];o.far<e.near||o.near>e.far||n(o.obj,o.near,o.far)}}}]),e}(),oC=function(){function e(){(0,s.Z)(this,e),this._view=(0,Cn.c)(),this._viewProj=(0,Cn.c)(),this._frustum=(0,Tc.Ue)(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}return(0,l.Z)(e,[{key:"compute",value:function(e,t){var n=this;this._reset(),(0,wn.c)(this._view,e.viewMatrix),(0,wn.m)(this._viewProj,e.projectionMatrix,this._view),(0,Tc.JG)(this._frustum,e.frustum);var r=this._view,i=r[2],a=r[6],o=r[10],s=r[14];t.forAll((function(e){return e.forEachGeometry((function(e){if(e.visible&&e.castShadow){var t;e.hasShaderTransformation?(e.computeBoundingSphere(e.shaderTransformation,uC,1),t=uC):t=e.boundingSphere;var r=i*t[0]+a*t[1]+o*t[2]+s,l=r-t[3],u=r+t[3];n._geometries.push(e),n._near.push(-u),n._far.push(-l)}}))}));var l=new Sb;if(0===this._geometries.length)return l;for(var u=0;u<this._geometries.length;++u)this._near[u]>l.far&&(l.far=this._near[u]),this._near[u]>2&&this._far[u]<l.near&&(l.near=this._far[u]);var c=this._looseRange;c.near=Math.max(.5*l.near,2),c.far=2*l.far;for(var h=0,d=0,f=0;f<this._geometries.length;++f)this._near[f]<l.near&&(this._near[f]>=c.near?l.near=this._near[f]:this._nearCandidates[h++]=f),this._far[f]>l.far&&(this._far[f]<=c.far?l.far=this._far[f]:this._farCandidates[d++]=f);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return l;this._nearCandidates.sort((function(e,t){return n._near[e]<n._near[t]?-1:n._near[e]>n._near[t]?1:0})),this._farCandidates.sort((function(e,t){return n._far[e]<n._far[t]?1:n._far[e]>n._far[t]?-1:0}));for(var p=0;p<this._nearCandidates.length;++p){var v=this._nearCandidates[p];if(this._near[v]<l.near){var m=this._geometries[v],_=m.boundingInfo;this._includeNearBoundingInfoRec(_,m.shaderTransformation,l)}}for(var y=0;y<this._farCandidates.length;++y){var g=this._farCandidates[y];if(this._far[g]>l.far){var b=this._geometries[g],w=b.boundingInfo;this._includeFarBoundingInfoRec(w,b.shaderTransformation,l)}}return this._reset(),l}},{key:"_reset",value:function(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}},{key:"_includeNearBoundingInfoRec",value:function(e,t,n){if(!(0,k.Wi)(e)){var r=e.center;(0,Gt.m)(uC,r,t);var a=(0,Pe.u1)(t),o=uC[0],s=uC[1],l=uC[2],u=e.radius*a,c=this._frustum;if(!(c[0][0]*o+c[0][1]*s+c[0][2]*l+c[0][3]>u||c[1][0]*o+c[1][1]*s+c[1][2]*l+c[1][3]>u||c[2][0]*o+c[2][1]*s+c[2][2]*l+c[2][3]>u||c[3][0]*o+c[3][1]*s+c[3][2]*l+c[3][3]>u)){var h=this._view[2]*o+this._view[6]*s+this._view[10]*l+this._view[14],d=h+u;if(!(-(h-u)<2||-d>=n.near))if(-d>this._looseRange.near)n.near=-d;else{if(u>100){var f=e.getChildren();if(void 0!==f){var p,v=(0,i.Z)(f);try{for(v.s();!(p=v.n()).done;){var m=p.value;this._includeNearBoundingInfoRec(m,t,n)}}catch(_){v.e(_)}finally{v.f()}return}}pC.unionDepthRangeWithAABB(n,this._viewProj,t,e.bbMin,e.bbMax)}}}}},{key:"_includeFarBoundingInfoRec",value:function(e,t,n){if(!(0,k.Wi)(e)){var r=e.radius,a=e.center;(0,Gt.m)(uC,a,t);var o=(0,Pe.u1)(t),s=uC[0],l=uC[1],u=uC[2];r*=o;var c=this._frustum;if(!(c[0][0]*s+c[0][1]*l+c[0][2]*u+c[0][3]>r||c[1][0]*s+c[1][1]*l+c[1][2]*u+c[1][3]>r||c[2][0]*s+c[2][1]*l+c[2][2]*u+c[2][3]>r||c[3][0]*s+c[3][1]*l+c[3][2]*u+c[3][3]>r)){var h=this._view[2]*s+this._view[6]*l+this._view[10]*u+this._view[14]-r;if(!(-h<=n.far))if(-h<this._looseRange.far)n.far=-h;else{if(r>100){var d=e.getChildren();if(void 0!==d){var f,p=(0,i.Z)(d);try{for(p.s();!(f=p.n()).done;){var v=f.value;this._includeFarBoundingInfoRec(v,t,n)}}catch(m){p.e(m)}finally{p.f()}return}}pC.unionDepthRangeWithAABB(n,this._viewProj,t,e.bbMin,e.bbMax)}}}}}]),e}(),sC=function(){function e(){(0,s.Z)(this,e),this._modelViewProj=(0,Cn.c)(),this._clipPosition=[(0,Wt.c)(),(0,Wt.c)(),(0,Wt.c)(),(0,Wt.c)(),(0,Wt.c)(),(0,Wt.c)(),(0,Wt.c)(),(0,Wt.c)()]}return(0,l.Z)(e,[{key:"unionDepthRangeWithAABB",value:function(e,t,n,r,i){var a=this._modelViewProj;(0,wn.m)(a,t,n);for(var o=!1,s=0;s<8;++s){var l=this._clipPosition[s],u=0===s||3===s||4===s||7===s?r[0]:i[0],c=0===s||1===s||4===s||5===s?r[1]:i[1],h=s<4?r[2]:i[2];l[0]=a[0]*u+a[4]*c+a[8]*h+a[12],l[1]=a[1]*u+a[5]*c+a[9]*h+a[13],l[2]=a[2]*u+a[6]*c+a[10]*h+a[14],l[3]=a[3]*u+a[7]*c+a[11]*h+a[15]}for(var d=0;d<12;++d){for(var f=this._clipPosition[lC[d][0]],p=this._clipPosition[lC[d][1]],v=this._clipPosition[lC[d][2]],m=this._clipTriangle(f,p,v),_=!0,y=0;y<m.length;++y)if(m[y][3]>=2){_=!1;break}if(!_){o=!0;for(var g=0;g<m.length;++g){var b=m[g][3];Number.isFinite(b)&&(e.near=Math.min(b,e.near),e.far=Math.max(b,e.far))}}}return o}},{key:"_inside",value:function(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,wr.hu)(!1)}},{key:"_intersect",value:function(e,t,n){var r=0;return 0===n?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===n?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===n?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===n&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,Xt.l)((0,Wt.c)(),e,t,r)}},{key:"_clipTriangle",value:function(e,t,n){for(var r=[e,t,n],i=0;i<4;++i){var a=r;r=[];for(var o=0;o<a.length;++o){var s=a[o],l=a[(o+1)%a.length];this._inside(l,i)?(this._inside(s,i)||r.push(this._intersect(s,l,i)),r.push(l)):this._inside(s,i)&&r.push(this._intersect(s,l,i))}}return r}}]),e}(),lC=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],uC=(0,ea.c)(),cC=(0,Cn.c)(),hC=kb(),dC=new aC,fC=new oC,pC=new sC,vC=n(53252),mC=n(38330),_C=n(30168),yC=n(13773),gC=n(95276),bC=n(64201),wC=n(19253),CC=(0,l.Z)((function e(){(0,s.Z)(this,e)})),xC=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).textures=new CC,e}return(0,l.Z)(n)}($t.K);function TC(){var e=new bC.kG;return e.attributes.add(tr.T.POSITION,"vec2"),e.vertex.uniforms.add(new gC.N("drawPosition",(function(e,t){return function(e,t){var n=t.camera.pixelRatio,r=e.magnifier.offset.x*n,i=e.magnifier.offset.y*n;(0,O.md)(e.magnifier.position,SC);var a=t.camera.screenToRender(SC,kC),o=Math.ceil(n*e.magnifier.size),s=t.camera.fullWidth,l=t.camera.fullHeight;return(0,Xt.s)(PC,(a[0]+r)/s*2-1,(a[1]-i)/l*2-1,o/s*2,o/l*2)}(e,t)}))),e.varyings.add("vUV","vec2"),e.vertex.code.add((0,$t.H)(rC||(rC=(0,_C.Z)(["void main(void) {\nvUV = position;\ngl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);\n}"])))),e.fragment.uniforms.add(new wC.A("textureInput",(function(e){return e.textures.input}))),e.fragment.uniforms.add(new wC.A("textureMask",(function(e){return e.textures.mask}))),e.fragment.uniforms.add(new wC.A("textureOverlay",(function(e){return e.textures.overlay}))),e.fragment.uniforms.add(new yC.U("maskEnabled",(function(e){return e.magnifier.maskEnabled}))),e.fragment.uniforms.add(new yC.U("overlayEnabled",(function(e){return e.magnifier.overlayEnabled}))),e.fragment.code.add((0,$t.H)(iC||(iC=(0,_C.Z)(["const float barrelFactor = 1.1;\nvec2 barrel(vec2 uv) {\nvec2 uvn = uv * 2.0 - 1.0;\nif (uvn.x == 0.0 && uvn.y == 0.0) {\nreturn vec2(0.5, 0.5);\n}\nfloat theta = atan(uvn.y, uvn.x);\nfloat r = pow(length(uvn), barrelFactor);\nreturn r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;\n}\nvoid main() {\nfloat mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;\nvec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;\nvec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);\ngl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;\n}"])))),e}var SC=(0,O.s1)(),kC=(0,O.gX)(),PC=(0,Wt.c)(),RC=n(4583),AC=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._handles=new K.Z,e._magnifier=null,e._imageSources=null,e._imageLoadTask=null,e._resources=null,e._passParameters=new xC,e.events=new $.Z,e.attributeLocations=new Map([[tr.T.POSITION,0]]),e._tmpScreenPoint=(0,O.s1)(),e._tmpRenderPoint=(0,O.gX)(),e}return(0,l.Z)(n,[{key:"updating",get:function(){return(0,k.Wi)(this._imageSources)&&(0,k.pC)(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;if(e!==this._magnifier){this._handles.removeAll(),this._magnifier=e;var n=function(){t._updateResourceLoading(),t.events.emit("request-render")};(0,k.pC)(this._magnifier)&&this._handles.add((0,A.YP)((function(){return(0,k.yw)(t._magnifier,(function(e){return e.version}))}),n)),n()}}},{key:"enabled",get:function(){return(0,k.pC)(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return(0,k.pC)(this._magnifier)&&this._magnifier.visible&&(0,k.pC)(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}},{key:"_factor",get:function(){return(0,k.pC)(this._magnifier)&&this._magnifier.factor||1}},{key:"destroy",value:function(){this._magnifier=null,this._handles.destroy(),(0,k.pC)(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}},{key:"render",value:function(e,t){var n=this._validMagnifier;if(!(0,k.Wi)(n)){var r=t.camera.pixelRatio,i=Math.ceil(r*n.size);if(this._updateResources(e,i),!(0,k.Wi)(this._resources)){var a=this._passParameters.textures,o=Math.ceil(1/this._factor*i);a.input.resize(o,o),(0,O.md)(n.position,this._tmpScreenPoint);var s=t.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),l=t.camera.fullWidth,u=t.camera.fullHeight,c=.5*o,h=.5*o;s[0]=(0,Se.uZ)(s[0],c,l-c-1),s[1]=(0,Se.uZ)(s[1],h,u-h-1);var d=Math.floor(s[0]-c),f=Math.floor(s[1]-h),p=this._resources.program;p.bindTexture("textureInput",a.input),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,d,f,o,o,0),this._passParameters.magnifier=n,e.useProgram(p),p.bindPass(this._passParameters,t),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(an.MX.TRIANGLE_STRIP,0,4)}}}},{key:"_updateResourceLoading",value:function(){var e=this,t=this._validMagnifier;if(!(0,k.Wi)(t)){var n=t.maskUrl,r=t.overlayUrl;!(0,k.pC)(this._imageLoadTask)||this._imageLoadTask.maskUrl===n&&this._imageLoadTask.overlayUrl===r||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),(0,k.pC)(this._imageSources)||(0,k.pC)(this._imageLoadTask)||(this._imageLoadTask={maskUrl:n,overlayUrl:r,task:(0,ge.vr)(function(){var t=(0,o.Z)((0,a.Z)().mark((function t(i){var o,s,l;return(0,a.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return o=(0,k.Wi)(n)||(0,k.Wi)(r)?(0,RC.e)(i):null,s=(0,k.pC)(n)?(0,mC.t)(n,{signal:i}):o.then((function(e){return e.mask})),l=(0,k.pC)(r)?(0,mC.t)(r,{signal:i}):o.then((function(e){return e.overlay})),t.next=3,s;case 3:return t.t0=t.sent,t.next=6,l;case 6:t.t1=t.sent,e._imageSources={mask:t.t0,overlay:t.t1},e._disposeResources(),e.events.emit("request-render");case 10:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then((function(){return e.notifyChange("updating")}),(function(){return e.notifyChange("updating")})))}}},{key:"_updateResources",value:function(e,t){if(this.enabled)if((0,k.pC)(this._resources)){if(this._passParameters.textures.size!==t){var n=this._createTextureResources(e,t);if((0,k.Wi)(n))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=n}}else{var r=this._createTextureResources(e,t);(0,k.Wi)(r)||(this._resources={program:this._createProgram(e),vao:(0,dn.ow)(e,hn.QI,this.attributeLocations,0,1),pipelineState:(0,on.sm)({blending:(0,on.if)(an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:on.BK})},this._passParameters.textures=r)}else this._disposeResources()}},{key:"_disposeResources",value:function(){(0,k.Wi)(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}},{key:"_disposeTextureResources",value:function(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}},{key:"_createTextureResources",value:function(e,t){if((0,k.Wi)(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;var n=new rr.x(e,{target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,internalFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:an.cw.LINEAR,flipped:!0,preMultiplyAlpha:!(0,yv.zd)(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result},this._imageSources.overlay),r=new rr.x(e,{target:an.No.TEXTURE_2D,pixelFormat:an.VI.ALPHA,internalFormat:an.VI.ALPHA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:an.cw.LINEAR,flipped:!0},this._imageSources.mask);return{input:new rr.x(e,{target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,internalFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,samplingMode:an.cw.LINEAR,flipped:!1}),mask:r,overlay:n,size:t}}},{key:"_createProgram",value:function(e){return new rn.$(e,TC(),this.attributeLocations)}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],AC.prototype,"_imageSources",void 0),(0,p._)([(0,Z.Cb)()],AC.prototype,"_imageLoadTask",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],AC.prototype,"updating",null),AC=(0,p._)([(0,L.j)("esri/views/3d/webgl-engine/lib/MagnifierHelper")],AC);var EC,OC=function(){function e(){(0,s.Z)(this,e),this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new My.mc(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}return(0,l.Z)(e,[{key:"setUidToObjectAndLayerId",value:function(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(e&&t&&n&&r&&(this._layerUidToId.set(r,n),this._layerUidToPopupEnabled.set(r,i),i)){var l=this._layerUidToGraphicsUidToObjectId.get(r);l||(l=new Map,this._layerUidToGraphicsUidToObjectId.set(r,l)),l.set(t,{objectId:e,attributeNodeId:a,attributeIndex:o,subLayerId:s})}}},{key:"getObjectAndLayerIdColor",value:function(e){var t=this.getObjectAndLayerIdColorArray(e);return(0,Wt.f)(t.get(0,1),t.get(0,2),t.get(0,3),255)}},{key:"getObjectAndLayerIdColorArray",value:function(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;var t=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===t)return S.Z.getLogger(this.declaredClass).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(!1===t)return this.colorZero;var n=this._uidToRenderColor.get(e.layerUid);n||(n=new Map,this._uidToRenderColor.set(e.layerUid,n));var r=n.get(e.graphicUid);if(!r){for(;!r;){var i=Math.floor(16777214*Math.random())+1;this._colorToUID.has(i)||(r=i)}if(r>16777215)throw new Error("Object ID Overflow");n.set(e.graphicUid,r),this._colorToUID.set(r,e)}var a=new ArrayBuffer(4);return new DataView(a).setUint32(0,r,!1),new My.mc(a)}},{key:"getColorToObjectAndLayerIdMapping",value:function(){var e,t=new Map,n=(0,i.Z)(this._colorToUID.entries());try{for(n.s();!(e=n.n()).done;){var r=(0,ns.Z)(e.value,2),a=r[0],o=r[1],s=this._layerUidToGraphicsUidToObjectId.get(o.layerUid),l=null;s?(l=s.get(o.graphicUid))||S.Z.getLogger(this.declaredClass).warn("getColorMapping: no entry found for graphicsId "+o.graphicUid):S.Z.getLogger(this.declaredClass).warn("getColorMapping: no entry found for layerUid "+o.layerUid);var u=this._layerUidToId.get(o.layerUid);u||S.Z.getLogger(this.declaredClass).warn("no layerId found for uid "+o.layerUid),l&&u&&t.set(a,l.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:l.objectId,lid:u,attrId:l.attributeNodeId,attrIdx:l.attributeIndex,subLayerId:l.subLayerId}:{type:"object-and-layer-id",oid:l.objectId,lid:u})}}catch(c){n.e(c)}finally{n.f()}return t}}]),e}();!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(EC||(EC={}));var MC=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:EC.FrontToBack;(0,s.Z)(this,e),this._rctx=t,this._techniqueRepository=n,this._sorting=r,this._draws=new Qd.Z({initialSize:32,allocator:function(e){return e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}}),this._previouslyBoundDraw=new Map}return(0,l.Z)(e,[{key:"submitDraw",value:function(e,t,n,r){var i,a=this._draws.pushNew();a.geometry=t,a.geometryRanges=n,a.material=e,a.depthSquaredHint=r,a.indexType=null!==(i=t.indexed?(0,k.Wg)(t.vao.indexBuffer).indexType:null)&&void 0!==i?i:0}},{key:"dispatch",value:function(e,t){var n=this,r=this._rctx;this._previouslyBoundDraw.clear();for(var i=null,a=this._draws.map((function(r){return r.material.prepareTechnique(n._techniqueRepository,e,t,r.geometry.parameters)})),o=this._draws.length,s=0;s<o;s++){var l=a[s];l===i&&l.configuration.transparencyPassType===nw.A.NONE||(r.bindTechnique(l,e,t),i=l);var u=this._draws.data[s],c=u.geometry;r.bindVAO(c.vao),this._previouslyBoundDraw.get(l)!==u.material&&(l.program.bindDraw(u.material,t,e),this._previouslyBoundDraw.set(l,u.material));var h=u.geometryRanges,d=h.length;if(0!==u.indexType)for(var f=ZC.get(u.indexType),p=0;p<d;p+=2){var v=h[p],m=h[p+1];r.drawElements(c.primitiveType,m,u.indexType,v*f)}else for(var _=0;_<d;_+=2){var y=h[_],g=h[_+1];r.drawArrays(c.primitiveType,y,g)}}}},{key:"prepareSubmit",value:function(){this._draws.clear()}},{key:"finishSubmit",value:function(){var e=this._sorting===EC.FrontToBack?1:-1;this._draws.sort((function(t,n){var r=e*(t.depthSquaredHint-n.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-n.geometry.vao.size}))}},{key:"count",get:function(){return this._draws.length}}]),e}(),ZC=new Map;ZC.set(an.g.UNSIGNED_BYTE,1),ZC.set(an.g.UNSIGNED_SHORT,2),ZC.set(an.g.UNSIGNED_INT,4);var IC=function(){function e(t,n){(0,s.Z)(this,e),this.rctx=t,this.shaderTechniqueRepository=n,this.canRender=!0,this._materialPassParameters=new fw.SP,this._shadowPassParameters=new fw.kF,this._highlightPassParameters=new fw.T5,this._systems=new Set,this._passes={materialOpaque:new MC(t,n),materialTransparent:new MC(t,n,EC.BackToFront),materialIntegratedMesh:new MC(t,n),shadowMap:new MC(t,n),highlight:new MC(t,n),highlightIntegratedMesh:new MC(t,n),highlightShadowMap:new MC(t,n),defaultShadowMap:new MC(t,n)}}return(0,l.Z)(e,[{key:"register",value:function(e){this._systems.add(e)}},{key:"prepareRender",value:function(e){var t=this;if(0!==this._systems.size){for(var n=0,r=Object.values(this._passes);n<r.length;n++){r[n].prepareSubmit()}this._systems.forEach((function(n){return n.submit(t._passes,e.bindParameters)}));for(var i=0,a=Object.values(this._passes);i<a.length;i++){a[i].finishSubmit()}this.shaderTechniqueRepository.frameUpdate()}}},{key:"render",value:function(e){if(0!==this._systems.size)switch(this._configure(e),this._materialPassParameters.output=e.output,e.bindParameters.slot){case ci.r.OPAQUE_MATERIAL:switch(e.output){case li.H.Color:case li.H.Depth:case li.H.Normal:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case li.H.Highlight:return this._passes.highlight.dispatch(this._highlightPassParameters,e.bindParameters);case li.H.Shadow:return this._passes.shadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case li.H.ShadowHighlight:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case li.H.ShadowExcludeHighlight:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case li.H.ObjectAndLayerIdColor:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters)}return;case ci.r.TRANSPARENT_MATERIAL:switch(e.output){case li.H.Color:case li.H.Alpha:case li.H.Depth:case li.H.Normal:case li.H.ObjectAndLayerIdColor:return this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters)}return;case ci.r.INTEGRATED_MESH:switch(e.output){case li.H.Color:case li.H.Depth:case li.H.Normal:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case li.H.Highlight:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,e.bindParameters);case li.H.ObjectAndLayerIdColor:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters)}return}}},{key:"notifyDirty",value:function(){this._context.requestRender()}},{key:"slots",value:function(){return[ci.r.OPAQUE_MATERIAL,ci.r.TRANSPARENT_MATERIAL,ci.r.INTEGRATED_MESH]}},{key:"initializeRenderContext",value:function(e){this._context=e}},{key:"uninitializeRenderContext",value:function(){}},{key:"queryDepthRange",value:function(e){var t={near:1/0,far:-1/0};return this._systems.forEach((function(n){var r=n.queryShadowCasterDepthRange(e);(0,k.pC)(r)&&Rb(t,r,t)})),t}},{key:"_configure",value:function(e){var t=e.output===li.H.Shadow||e.output===li.H.ShadowHighlight||e.output===li.H.ShadowExcludeHighlight?this._shadowPassParameters:e.output===li.H.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,t)}},{key:"_updateParameters",value:function(e,t){var n=e.bindParameters.camera,r=n.viewInverseTransposeMatrix;(0,Gt.s)(DC,r[3],r[7],r[11]),NC.set(DC),(0,Gt.c)(t.transformWorldFromViewTH,NC.high),(0,Gt.c)(t.transformWorldFromViewTL,NC.low),(0,Gt.c)(t.slicePlaneLocalOrigin,DC),(0,bn.f)(t.transformViewFromCameraRelativeRS,n.viewMatrix),(0,wn.c)(t.transformProjFromView,n.projectionMatrix),t.identifier===fw.o9.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===ci.r.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===ci.r.INTEGRATED_MESH,(0,bn.t)(LC,t.transformViewFromCameraRelativeRS),(0,bn.e)(t.transformNormalViewFromGlobal,LC))}},{key:"needsHighlight",get:function(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}},{key:"needsTransparentPass",get:function(){return this._passes.materialTransparent.count>0}}]),e}(),DC=(0,F.c)(),LC=(0,Ho.c)(),NC=new _w,FC=n(80733),UC=function(){function e(){(0,s.Z)(this,e),this._step=WC,this._dilation=1,this._firstIdleTime=(0,lr.HA)(0)}return(0,l.Z)(e,[{key:"frame",value:function(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=(0,lr.HA)(performance.now())):this._firstIdleTime=(0,lr.HA)(0),(0,x.Z)("enable-feature:high-quality-idle")){var n=t?performance.now()-this._firstIdleTime:0;if(n>=HC+zC)return this._step=(0,lr.HA)(1/0),void(this._dilation=1);this._dilation=n>=HC?BC:1}else this._dilation=1;var r=(0,Se.uZ)(e/VC,WC,jC);this._step===1/0?this._step=(0,lr.HA)(r):this._step=(0,lr.HA)(this._step*GC+r*(1-GC))}},{key:"value",get:function(){return this._step}},{key:"timeDilation",get:function(){return this._dilation}},{key:"clear",value:function(){this._step=this._firstIdleTime=(0,lr.HA)(0)}}]),e}(),VC=.5,HC=(0,lr.HA)(6e4),zC=(0,lr.HA)(5e3),BC=10,GC=.9,WC=(0,lr.HA)(1e3),jC=(0,lr.HA)(1e3/30),qC=n(47180),YC=n(90765),XC=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK})}}]),n}(tn.A);XC.shader=new en.J(YC.H,(function(){return n.e(14958).then(n.bind(n,14958))}));var QC=n(56384),JC=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({colorWrite:on.BK})}}]),n}(tn.A);JC.shader=new en.J(QC.a,(function(){return n.e(61507).then(n.bind(n,61507))}));var KC=n(69012),$C=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({colorWrite:on.BK})}}]),n}(tn.A);$C.shader=new en.J(KC.a,(function(){return n.e(72771).then(n.bind(n,72771))}));var ex=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).color=(0,Fp.f)(1,0,1,1),e.haloColor=(0,Fp.f)(1,0,1,1),e.haloOpacity=1,e.haloOpacityOccluded=.25,e.fillOpacity=.2,e.fillOpacityOccluded=.05,e.shadowColor=(0,Wt.f)(1,0,1,1),e.shadowOpacity=.15,e.occludedShadowOpacity=.075,e}return(0,l.Z)(n)}($t.K),tx=function(){function e(t,n){(0,s.Z)(this,e),this._techniqueRep=t,this._rctx=n,this._viewportToRestore=(0,Wt.c)(),this._passParameters=new ex,this._downsampleDrawParameters=new KC.H,this._blurDrawParameters=new QC.H,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}return(0,l.Z)(e,[{key:"_assertResources",value:function(){if(!this._quadVAO){this._quadVAO=(0,dn.ow)(this._rctx);var e={colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.NONE,width:0,height:0},t={target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,samplingMode:an.cw.LINEAR,wrapMode:an.e8.CLAMP_TO_EDGE,width:0,height:0};this._blur0Fbo=new Mn.X(this._rctx,e,t),this._blur1Fbo=new Mn.X(this._rctx,e,t),this._blurTechnique=this._techniqueRep.acquire(JC),this._downsampleTechnique=this._techniqueRep.acquire($C),this._applyTechnique=this._techniqueRep.acquire(XC)}}},{key:"dispose",value:function(){if(this._blurTechnique=(0,k.RY)(this._blurTechnique),this._downsampleTechnique=(0,k.RY)(this._downsampleTechnique),this._applyTechnique=(0,k.RY)(this._applyTechnique),this._grid.coverageMipmap)for(var e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this._quadVAO&&(this._quadVAO.dispose(!0),this._quadVAO=null),this._blur0Fbo=(0,k.M2)(this._blur0Fbo),this._blur1Fbo=(0,k.M2)(this._blur1Fbo)}},{key:"setDefaultOptions",value:function(e){this._passParameters=(0,r.Z)((0,r.Z)({},new ex),e)}},{key:"render",value:function(e,t,n){this._passParameters.highlightColorTexture=t.colorTexture,this._assertResources();var r=e.camera;(0,Xt.c)(this._viewportToRestore,r.fullViewport);var i=r.fullWidth,a=r.fullHeight,o=r.pixelRatio,s=Math.ceil(i/o),l=Math.ceil(a/o);this._blur0Fbo.resize(s,l),this._blur1Fbo.resize(s,l);var u=this._rctx;u.bindVAO(this._quadVAO);var c;this._gridUpdateResources(t,32),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,c=this._grid.vao;var h=u.bindTechnique(this._blurTechnique,this._passParameters,e);u.bindVAO(c),u.bindFramebuffer(this._blur0Fbo),u.setViewport(0,0,s,l),u.setClearColor(0,0,0,0),u.clear(an.lk.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=t.colorTexture,(0,Yt.s)(this._blurDrawParameters.blurSize,1/s,0),h.bindDraw(this._blurDrawParameters,e,this._passParameters),u.drawArrays(this._blurTechnique.primitiveType,0,(0,ir._V)(c,"geometry")),u.bindFramebuffer(this._blur1Fbo),u.clear(an.lk.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this._blur0Fbo.colorTexture,(0,Yt.s)(this._blurDrawParameters.blurSize,0,1/l),h.bindDraw(this._blurDrawParameters,e,this._passParameters),u.drawArrays(this._blurTechnique.primitiveType,0,(0,ir._V)(c,"geometry")),u.bindFramebuffer(n),u.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]),this._passParameters.blurColorTexture=this._blur1Fbo.colorTexture,u.bindTechnique(this._applyTechnique,this._passParameters,e),u.drawArrays(this._applyTechnique.primitiveType,0,(0,ir._V)(c,"geometry")),u.bindVAO(null)}},{key:"_gridUpdateResources",value:function(e,t){var n=this._rctx,r=this._grid,i=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],i=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(i=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,i=!0),i){for(var a=1;a<r.coverageMipmap.length;a++)r.coverageMipmap[a].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(var o=0;o<r.mipmapLevels;o++){var s=r.coverageMipmap[o],l={target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGB,dataType:an.Br.UNSIGNED_SHORT_5_6_5,samplingMode:an.cw.LINEAR,wrapMode:an.e8.CLAMP_TO_EDGE,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)},u={colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.NONE,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)};r.coverageMipmap[o+1]=new Mn.X(n,u,l)}}var c=Math.ceil(e.height/r.cellPixelSize),h=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==c||r.horizontalCellCount!==h){r.verticalCellCount=c,r.horizontalCellCount=h;for(var d=c+1,f=h+1,p=1/c,v=1/h,m=new Float32Array(24*d*f),_=0,y=0;y<d;y++)for(var g=0;g<f;g++)m[_+0]=(g-.5)*v*2-1,m[_+1]=(y-.5)*p*2-1,m[_+2]=g*v,m[_+3]=y*p,m[_+4]=(g+.5)*v*2-1,m[_+5]=(y-.5)*p*2-1,m[_+6]=g*v,m[_+7]=y*p,m[_+8]=(g-.5)*v*2-1,m[_+9]=(y+.5)*p*2-1,m[_+10]=g*v,m[_+11]=y*p,m[_+12]=(g-.5)*v*2-1,m[_+13]=(y+.5)*p*2-1,m[_+14]=g*v,m[_+15]=y*p,m[_+16]=(g+.5)*v*2-1,m[_+17]=(y-.5)*p*2-1,m[_+18]=g*v,m[_+19]=y*p,m[_+20]=(g+.5)*v*2-1,m[_+21]=(y+.5)*p*2-1,m[_+22]=g*v,m[_+23]=y*p,_+=24;r.vao&&r.vao.dispose(!0),r.vao=new er.U(n,nn.i,{geometry:hn.Bn},{geometry:nr.f.createVertex(n,an.l1.STATIC_DRAW,m)})}}},{key:"_gridComputeMipmap",value:function(e){var t=this._rctx,n=this._grid,r=t.bindTechnique(this._downsampleTechnique,this._passParameters,e);t.bindVAO(this._quadVAO);for(var i=0;i<n.mipmapLevels;i++){t.bindFramebuffer(n.coverageMipmap[i+1]);var a=n.coverageMipmap[i+1].width,o=n.coverageMipmap[i+1].height;this._downsampleDrawParameters.inputTexture=n.coverageMipmap[i].colorTexture,(0,Yt.s)(this._downsampleDrawParameters.invFramebufferDim,1/a,1/o),r.bindDraw(this._downsampleDrawParameters,e,this._passParameters),t.setViewport(0,0,a,o),t.drawArrays(an.MX.TRIANGLE_STRIP,0,(0,ir._V)(this._quadVAO,"geometry"))}}},{key:"gpuMemoryUsage",get:function(){var e=((0,k.pC)(this._blur0Fbo)?this._blur0Fbo.gpuMemoryUsage:0)+((0,k.pC)(this._blur1Fbo)?this._blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap){var t,n=(0,i.Z)(this._grid.coverageMipmap);try{for(n.s();!(t=n.n()).done;){e+=t.value.gpuMemoryUsage}}catch(r){n.e(r)}finally{n.f()}}return e}},{key:"test",get:function(){return{coverage:this._grid.coverageMipmap,blur:[this._blur0Fbo,this._blur1Fbo]}}}]),e}(),nx=n(15880),rx={dataType:an.Br.UNSIGNED_BYTE,internalFormat:an.VI.RGBA},ix={},ax=function(){function e(t){(0,s.Z)(this,e),this._rctx=t,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=t.capabilities.depthTexture}return(0,l.Z)(e,[{key:"dispose",value:function(){this._depthBuffers.forEach((function(e){return e.dispose()})),this._depthBuffers.clear(),this._depthTextures.forEach((function(e){return e.dispose()})),this._depthTextures.clear(),this._colorTextures.forEach((function(e){return e.dispose()})),this._colorTextures.clear(),this._framebuffers.forEach((function(e){return e.dispose()})),this._framebuffers.clear(),this._activeTargets.clear()}},{key:"disposeTargetResource",value:function(e){var t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._disposeWithFramebuffers(this._depthTextures,t),this._disposeWithFramebuffers(this._depthBuffers,t),this._disposeWithFramebuffers(this._colorTextures,t))}},{key:"_disposeWithFramebuffers",value:function(e,t){var n=this,r=e.get(t);r&&(this._framebuffers.forEach((function(e,t){e.colorAttachment!==r&&e.depthStencilAttachment!==r||(e.detachAll(),e.dispose(),n._framebuffers.delete(t))})),r.dispose(),e.delete(t))}},{key:"getDepthTexture",value:function(e,t){if(!this.depthTextureSupported)return null;var n=this._depthTextures.get(e.id);return!n||n.descriptor.width===t.width&&n.descriptor.height===t.height||(n.dispose(),n=(0,k.wN)()),n||(n=new rr.x(this._rctx,{target:an.No.TEXTURE_2D,pixelFormat:an.VI.DEPTH_STENCIL,dataType:an.Br.UNSIGNED_INT_24_8,samplingMode:an.cw.NEAREST,wrapMode:an.e8.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._depthTextures.set(e.id,n),this._activeTargets.add(e.id)),n}},{key:"getAllocatedDepthTexture",value:function(e){return this._depthTextures.get(e.id)}},{key:"getDepthBuffer",value:function(e,t){if(this.depthTextureSupported)return null;var n=this._depthBuffers.get(e.id);return n?n.descriptor.width===t.width&&n.descriptor.height===t.height||n.resize(t.width,t.height):(n=new nx.r(this._rctx,(0,r.Z)({internalFormat:an.Tg.DEPTH_STENCIL},t)),this._depthBuffers.set(e.id,n),this._activeTargets.add(e.id)),n}},{key:"getColorTexture",value:function(e,t){var n=this._colorTextures.get(e.id);return n&&(n.descriptor.width===t.width&&n.descriptor.height===t.height||(n.dispose(),n=(0,k.wN)())),n||(n=new rr.x(this._rctx,{target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:an.cw.LINEAR,wrapMode:an.e8.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._colorTextures.set(e.id,n),this._activeTargets.add(e.id)),n}},{key:"getAllocatedColorTexture",value:function(e){return this._colorTextures.get(e.id)}},{key:"registerDepthTarget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,r.Z)((0,r.Z)({id:(0,tb.D)()},ix),e)}},{key:"registerColorTarget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,r.Z)((0,r.Z)({id:(0,tb.D)()},rx),e)}},{key:"getFramebuffer",value:function(e,t,n){var r=this._getKey(t,n),i=this._framebuffers.get(r),a=this.getColorTexture(t,e);if(this.depthTextureSupported){var o=n?this.getDepthTexture(n,e):void 0;return i?((i.width!==e.width||i.height!==e.height||i.colorTexture!==a||i.depthStencilTexture!==o)&&(i.detachAll(),i.resize(e.width,e.height),i.attachColorTexture(a),i.attachDepthStencilTexture(o)),i):(i=(0,k.pC)(n)?new Mn.X(this._rctx,{colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.DEPTH_STENCIL_TEXTURE},a,o):new Mn.X(this._rctx,{colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.NONE},a),this._framebuffers.set(r,i),i)}var s=n?this.getDepthBuffer(n,e):void 0;return i?((i.width!==e.width||i.height!==e.height||i.colorTexture!==a)&&(i.detachAll(),i.resize(e.width,e.height),i.attachColorTexture(a),i.attachDepthStencilBuffer(s)),i):(i=new Mn.X(this._rctx,{colorTarget:an.Lm.TEXTURE,depthStencilTarget:n?an.OU.DEPTH_STENCIL_RENDER_BUFFER:an.OU.NONE},a,s),this._framebuffers.set(r,i),i)}},{key:"_getKey",value:function(e,t){return"".concat(e.id,"_").concat(t?t.id:"X","_").concat(e.name).concat(t?"_"+t.name:"")}},{key:"gpuMemoryUsage",get:function(){var e=0,t=new Set,n=function(n){t.has(n)||(t.add(n),e+=(0,ir.un)(n))};return this._depthTextures.forEach(n),this._colorTextures.forEach(n),this._depthBuffers.forEach(n),e}}]),e}(),ox=function(){function e(t,n){(0,s.Z)(this,e),this._rctx=t,this._compositingHelper=n,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._background={type:"color",color:[0,0,0,1]};var r=t.type===I_.zO.WEBGL2;this._renderTargetHelper=new ax(t);var i=this._renderTargetHelper;this._mainColorTargets=[i.registerColorTarget({name:"mainColorTarget0"}),i.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=i.registerColorTarget({name:"frontFaceTarget"});var a=function(e){return i.registerColorTarget({name:e,dataType:an.Br.FLOAT,internalFormat:r?an.lP.RGBA32F:an.VI.RGBA,samplingMode:an.cw.NEAREST})};this.colorFloatTarget=a("colorFloatTarget"),this.alphaFloatTarget=a("alphaFloatTarget"),this.mainDepth=i.registerDepthTarget({name:"mainDepth"}),this.linearDepth=i.registerColorTarget({name:"linearDepth",samplingMode:an.cw.NEAREST}),this.terrainLinearDepth=i.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=i.registerColorTarget({name:"geometryLinearDepth"}),this.normal=i.registerColorTarget({name:"normal"}),this.highlight=i.registerColorTarget({name:"highlight",internalFormat:r?an.lP.RGBA4:an.VI.RGBA,dataType:an.Br.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=i.registerColorTarget({name:"hudVisibility",internalFormat:r?an.lP.RGBA4:an.VI.RGBA,dataType:an.Br.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=i.registerColorTarget({name:"tmpColor"}),this.tmpDepth=i.registerDepthTarget({name:"tmpDepth"}),this.hudColor=i.registerColorTarget({name:"hudColor"})}return(0,l.Z)(e,[{key:"dispose",value:function(){this._renderTargetHelper.dispose()}},{key:"width",get:function(){return this._dimensions.width}},{key:"height",get:function(){return this._dimensions.height}},{key:"background",get:function(){return this._background},set:function(e){this._background=e}},{key:"currentColorTarget",get:function(){return this._mainColorTargets[this._mainColorTarget]}},{key:"previousColorTarget",get:function(){return this._mainColorTargets[1-this._mainColorTarget]}},{key:"framebuffer",get:function(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}},{key:"getFramebuffer",value:function(e,t){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,t)}},{key:"colorTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}},{key:"depthTexture",get:function(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}},{key:"linearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}},{key:"terrainLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}},{key:"geometryLinearDepthTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}},{key:"lastFrameColorTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}},{key:"normalTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}},{key:"highlightTexture",get:function(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}},{key:"hudVisibilityTexture",get:function(){return this._getColorTexture(this.hudVisibility)}},{key:"tmpColorTexture",get:function(){return this._getColorTexture(this.tmpColor)}},{key:"hudColorTexture",get:function(){return this._getColorTexture(this.hudColor)}},{key:"mainColorTexture",get:function(){return this._getColorTexture(this.currentColorTarget)}},{key:"setupRenderTarget",value:function(e){e||(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1])),this._mainColorTarget=0===this._mainColorTarget&&e?1:0}},{key:"initializeFrame",value:function(e){var t=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);var n=this._background.color;t.setClearColor(n[0]*n[3],n[1]*n[3],n[2]*n[3],n[3]),t.clearSafe(an.lk.COLOR_BUFFER_BIT|an.lk.DEPTH_BUFFER_BIT|an.lk.STENCIL_BUFFER_BIT)}},{key:"composite",value:function(e){(0,k.pC)(this.colorTexture)&&this._compositingHelper.composite(e,this.colorTexture,Dw.None)}},{key:"renderTmpAndCompositeToMain",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.renderToTargets(e,this.tmpColor,r?this.tmpDepth:this.mainDepth,sx),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),n)}},{key:"renderHUDVisibility",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,lx)}},{key:"compositeTransparentTerrainOntoHUDVisibility",value:function(e){var t=this;this.renderToTargets((function(){return t._compositingHelper.compositeHUD(e,t._getColorTexture(t.tmpColor))}),this.hudVisibility,this.tmpDepth)}},{key:"renderOITPass",value:function(e,t,n){var r,i;switch(t){case nw.A.Color:r=this.colorFloatTarget,i=[0,0,0,0];break;case nw.A.Alpha:r=this.alphaFloatTarget,i=[1,1,1,1];break;case nw.A.FrontFace:r=this.frontFaceTarget,i=[0,0,0,0]}n?this.renderToTargets(e,r,this.tmpDepth,i,!0,!0):this.renderToTargets(e,r,this.mainDepth,i,!1)}},{key:"compositeTransparentTerrainOntoMain",value:function(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),Dw.PremultipliedAlpha)}},{key:"compositeOccludedOntoMain",value:function(e,t){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),Dw.PremultipliedAlpha,t)}},{key:"compositeTransparentOntoOpaque",value:function(e,t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(an.lk.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}},{key:"bindFramebuffer",value:function(){this._rctx.bindFramebuffer(this.framebuffer)}},{key:"renderDepthDetached",value:function(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}},{key:"disposeTarget",value:function(e){this._renderTargetHelper.disposeTargetResource(e)}},{key:"renderToFBO",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=this._rctx,a=0;if(t){var o=1e-13,s=Math.max(o,t[3]);i.setClearColor(t[0],t[1],t[2],s),a|=an.lk.COLOR_BUFFER_BIT}n&&(a|=an.lk.DEPTH_BUFFER_BIT),!1===r?r=0:(!0===r&&(r=255),a|=an.lk.STENCIL_BUFFER_BIT),a&&i.clearSafe(a,r),e(),i.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}},{key:"renderToTargets",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=this.bindTarget(t,n);return this.renderToFBO(e,r,i,a),o}},{key:"bindTarget",value:function(e,t){var n=this._renderTargetHelper.getFramebuffer(this._dimensions,e,t);return this._rctx.bindFramebuffer(n),n}},{key:"_getColorTexture",value:function(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}},{key:"gpuMemoryUsage",get:function(){var e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}]),e}(),sx=[0,0,0,0],lx=[0,1,0,1],ux=n(46293),cx=n(41947),hx=function(){function e(t){(0,s.Z)(this,e),this._context=t,this._renderPlugins=new Qd.Z,this._slots=[];for(var n=0;n<ci.r.MAX_SLOTS;++n)this._slots[n]=[]}return(0,l.Z)(e,[{key:"add",value:function(e,t,n){var r=this,a=function(){if(null!==n&&void 0!==n&&n.aborted)throw t.uninitializeRenderContext(),(0,R.zE)();r._renderPlugins.push(t);var a,o=(0,i.Z)(e);try{for(o.s();!(a=o.n()).done;){var s=a.value;r._slots[s].push(t)}}catch(l){o.e(l)}finally{o.f()}r._context.requestRender()},o=t.initializeRenderContext(this._context,n);if((0,R.y8)(o))return o.then(a);a()}},{key:"remove",value:function(e){if(null!=this._renderPlugins.removeUnordered(e)){for(var t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((function(t){return t!==e}));e.uninitializeRenderContext(),this._context.requestRender()}}},{key:"prepareRender",value:function(){var e=this;this._renderPlugins.forAll((function(t){t.prepareRender&&t.prepareRender(e._context.renderContext)}))}},{key:"updateAnimation",value:function(e){var t=!1;return this._renderPlugins.forAll((function(n){n.updateAnimation&&(t=n.updateAnimation(e)||t)})),t}},{key:"render",value:function(){var e=this,t=this._slots[this._context.renderContext.bindParameters.slot],n=new Array;t.filter((function(t){if(!t.canRender)return!1;if(function(e){return"prepareTechnique"in e}(t)){var r=t.prepareTechnique(e._context.renderContext);return!!r&&(n.push(r),!0)}return n.push(null),!0})).forEach((function(t,r){return t.render(e._context.renderContext,n[r])}))}},{key:"queryDepthRange",value:function(e){var t=dx;return t.near=1/0,t.far=-1/0,this._renderPlugins.forAll((function(n){if(n.queryDepthRange){var r=n.queryDepthRange(e);r&&Rb(t,r,t)}})),t}},{key:"needsTransparentPass",get:function(){return this._renderPlugins.some((function(e){return!!e.needsTransparentPass}))}},{key:"needsHighlight",get:function(){return this._renderPlugins.some((function(e){return!!e.needsHighlight}))}},{key:"needsLinearDepth",get:function(){return this._renderPlugins.some((function(e){return!!e.needsLinearDepth}))}},{key:"needsLaserlineWithContrastControl",get:function(){var e=this._slots[ci.r.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}},{key:"renderOccludedFlags",get:function(){return this._renderPlugins.reduce((function(e,t){return e|t.renderOccludedFlags}),0)}}]),e}();var dx={near:0,far:0},fx=n(89822),px=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),i=t.call(this,e,r,(function(){return i.destroy()}))}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:tw.wu,colorWrite:on.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return an.MX.TRIANGLE_STRIP}}]),n}(tn.A);px.shader=new en.J(fx.a,(function(){return n.e(87075).then(n.bind(n,87075))}));var vx=n(79485),mx=1/512,_x=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i,a){var o;return(0,s.Z)(this,n),(o=t.call(this,{}))._techniqueRepository=e,o._rctx=r,o._data=i,o._requestRender=a,o._passParameters=new fx.S(o._data.shadowCastTexture),o._techniqueConfig=new vx.l,o._enabled=!1,o._vao=(0,dn.ow)(r),o._techniqueConfig.visualization=vx.w.Gradient,o}return(0,l.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._stop(),this._vao=(0,k.M2)(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}},{key:"_visualizeShadowCastTechnique",get:function(){return this._technique=this._techniqueRepository.releaseAndAcquire(px,this._techniqueConfig,this._technique),this._technique}},{key:"render",value:function(e){if(this._showVisualization){this._passParameters.sampleScale=1/this._data.computedSamples;var t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,this._passParameters,e),this._rctx.drawArrays(t.primitiveType,0,(0,ir._V)(this._vao,"geometry"))}}},{key:"setOptions",value:function(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}},{key:"opacityFromElevation",get:function(){return this._passParameters.opacityFromElevation},set:function(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}},{key:"_showVisualization",get:function(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>mx}},{key:"_threshold",get:function(){return this._passParameters.threshold},set:function(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}},{key:"_visualization",get:function(){return this._techniqueConfig.visualization},set:function(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}},{key:"_bandSize",get:function(){return this._passParameters.bandSize},set:function(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}},{key:"_bandsEnabled",get:function(){return this._techniqueConfig.bandsEnabled},set:function(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}},{key:"_setColor",value:function(e){var t=this._passParameters.color;(0,Xt.g)(e,t)||((0,Xt.c)(this._passParameters.color,e),this._requestRenderIfRunning())}},{key:"_setEnabled",value:function(e){e!==this._enabled&&(e?this._start():this._stop())}},{key:"_requestRenderIfRunning",value:function(){this._enabled&&this._requestRender()}},{key:"_start",value:function(){this._enabled=!0,this._requestRender()}},{key:"_stop",value:function(){this._enabled=!1,this._requestRender()}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],_x.prototype,"opacityFromElevation",null),_x=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],_x);var yx=n(471),gx=n(13378),bx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).receiveShadows=!0,e.hasWebGL2Context=!1,e}return(0,l.Z)(n)}(un.m);(0,p._)([(0,un.o)()],bx.prototype,"receiveShadows",void 0),(0,p._)([(0,un.o)()],bx.prototype,"hasWebGL2Context",void 0);var wx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),r=t.call(this,e,new bx,(function(){return r.destroy()}))}return(0,l.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===I_.zO.WEBGL2}},{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.ONE,an.zi.ONE,an.zi.ONE,an.zi.ONE),colorWrite:on.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return an.MX.TRIANGLE_STRIP}}]),n}(tn.A);wx.shader=new en.J(gx.b,(function(){return n.e(85383).then(n.bind(n,85383))}));var Cx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i,a,o,l){var c;(0,s.Z)(this,n),(c=t.call(this,{}))._rctx=e,c._stage=i,c._prepareForShadowMapPass=a,c._renderToShadowMap=o,c._requestRender=l,c._progress=0,c._sampleCount=0,c._passParameters=new gx.S,c._enabledInternal=!1,c._cachedLightDirections=[],c._depthRange=Eb,c._previewing=!1,c._handles=new K.Z,c._cameraForcedForScreenshot=!1,c._bindParameters=new In.p(new yx.l(e,i.viewingMode),null,null),c._bindParameters.shadowMap.enabled=!0,c._vao=(0,dn.ow)(e);var h={colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.NONE,width:0,height:0},d={target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,samplingMode:an.cw.LINEAR,wrapMode:an.e8.CLAMP_TO_EDGE,width:0,height:0};c._fbo=new Mn.X(e,h,d),c._accumulationRenderer=new _x(r,e,(0,u.Z)(c),l);var f=c._stage.view.resourceController.scheduler;return c._handles.add([f.registerTask(Dn.T8.SHADOW_ACCUMULATOR,(0,u.Z)(c)),(0,A.YP)((function(){return i.renderView}),(function(e){c._handles.remove(Tx),(0,k.pC)(e)&&c._handles.add(e.events.on("force-camera-for-screenshot",(function(){return c._cameraForcedForScreenshot=!0})),Tx)}),A.tX),(0,A.YP)((function(){return c._previewing}),(function(){return c._requestRenderIfEnabled()}),A.Z_)]),c}return(0,l.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){if((0,k.Wi)(this._accumulationTechniqueCached)){var e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new wx(e)}return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return this._enabledInternal&&this._sampleCount>0}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==Eb&&this._opacityFromElevation>mx}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(e){var t=this._cachedLightDirections;if(!(0,D.fS)(t,e,Gt.F)){var n=Math.min(gx.a,e.length);t.length=n,this._sampleCount=n;for(var r=0;r<n;++r){var i;t[r]=(0,Gt.c)(null!==(i=t[r])&&void 0!==i?i:(0,F.c)(),e[r])}this._invalidate()}}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(e){this._accumulationRenderer.opacityFromElevation=e}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&this._progress>0}},{key:"runTask",value:function(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}},{key:"renderAccumulation",value:function(e,t,n,r){if(this._depthRange=t,this._updateCamera(n),this._bindParameters.contentCamera=r,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),this.isAccumulating&&this.canAccumulate){(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();for(var i=this._cameraForcedForScreenshot?this._sampleCount:Math.min(xx,this._sampleCount-this._progress),a=0;a<i;++a)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}}},{key:"render",value:function(e){this._accumulationRenderer.render(e)}},{key:"dispose",value:function(){this._stop(),this._handles.destroy(),this._accumulationRenderer=(0,k.M2)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,k.M2)(this._fbo),this._vao=(0,k.M2)(this._vao),this._accumulationTechniqueCached=(0,k.RY)(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}},{key:"setOptions",value:function(e){void 0!==e.enabled&&(this._enabled=e.enabled),void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}},{key:"readAccumulatedShadow",value:function(e,t){return!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,an.VI.RGBA,an.Br.UNSIGNED_BYTE,kx),kx[0]/this._progress)}},{key:"_start",value:function(){this._progress=0,this._enabledInternal=!0}},{key:"_stop",value:function(){this._enabledInternal=!1}},{key:"_invalidate",value:function(){this._progress=0,this._requestRenderIfEnabled()}},{key:"_clear",value:function(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(an.lk.COLOR_BUFFER_BIT),this._progress=0}},{key:"_accumulateShadow",value:function(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);var e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,(0,ir._V)(this._vao,"geometry"))}},{key:"_sampleLightDirection",value:function(){return this._progress++,this._lightDirections[this._progress*Sx%this._lightDirections.length]}},{key:"_updateCamera",value:function(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,Se.CW)(4e4,5e4,e.relativeElevation))}},{key:"_enabled",set:function(e){e!==this._enabledInternal&&(e?this._start():this._stop())}},{key:"_requestRenderIfEnabled",value:function(){this._enabledInternal&&this._requestRender()}},{key:"test",get:function(){var e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],Cx.prototype,"_progress",void 0),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_sampleCount",void 0),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_enabledInternal",void 0),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_depthRange",void 0),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_previewing",void 0),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_accumulationRenderer",void 0),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_isRefining",null),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_isActive",null),(0,p._)([(0,Z.Cb)()],Cx.prototype,"canAccumulate",null),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_isDoneAccumulating",null),(0,p._)([(0,Z.Cb)()],Cx.prototype,"_opacityFromElevation",null),(0,p._)([(0,Z.Cb)()],Cx.prototype,"running",null),Cx=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Cx);var xx=6,Tx="renderView",Sx=104729,kx=new Uint8Array(4),Px=n(58335),Rx=n(38727),Ax=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).shadowColor=(0,Wt.f)(1,0,1,1),e.shadowOpacity=.2,e.occludedShadowOpacity=.1,e.opacityElevation=1,e.dayNightTerminator=1,e}return(0,l.Z)(n)}($t.K),Ex=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),r=t.call(this,e,new bx,(function(){return r.destroy()}))}return(0,l.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===I_.zO.WEBGL2}},{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({blending:(0,on.wK)(an.zi.SRC_ALPHA,an.zi.ONE,an.zi.ONE_MINUS_SRC_ALPHA,an.zi.ONE_MINUS_SRC_ALPHA),colorWrite:on.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return an.MX.TRIANGLE_STRIP}}]),n}(tn.A);Ex.shader=new en.J(Rx.S,(function(){return n.e(39245).then(n.bind(n,39245))}));var Ox=function(){function e(t,n){(0,s.Z)(this,e),this._rctx=t,this._viewingMode=n,this._maxOpacity=1,this._passParameters=new Ax,this._drawParameters=new Px.ry,this._vao=(0,dn.ow)(this._rctx)}return(0,l.Z)(e,[{key:"_technique",get:function(){return(0,k.Wi)(this._techniqueCached)&&(this._techniqueCached=new Ex({rctx:this._rctx,viewingMode:this._viewingMode})),this._techniqueCached}},{key:"render",value:function(e,t){if(e.shadowMap.enabled&&e.linearDepthTexture&&this.isVisible){var n=this._technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(t),this._rctx.bindTechnique(n,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(n.primitiveType,0,(0,ir._V)(this._vao,"geometry"))}}},{key:"gpuMemoryUsage",get:function(){var e,t;return null!==(e=null===(t=this._vao)||void 0===t?void 0:t.size)&&void 0!==e?e:0}},{key:"setDefaultOptions",value:function(e){this._passParameters=(0,r.Z)((0,r.Z)({},this._passParameters),e),this._updateMaxOpacity()}},{key:"updateParameters",value:function(e,t){this._passParameters.opacityElevation=1-(0,Se.CW)(4e4,5e4,e.relativeElevation);var n=this._viewingMode===he.JY.Global?(0,Gt.n)(Mx,e.center):(0,Gt.s)(Mx,0,0,1),r=(0,Gt.e)(n,t);this._passParameters.dayNightTerminator=(0,Se.CW)(0,1,(0,Se.uZ)(30*r,0,1))}},{key:"dispose",value:function(){this._vao=(0,k.M2)(this._vao),this._techniqueCached=(0,k.RY)(this._techniqueCached)}},{key:"isVisible",get:function(){var e=this._passParameters,t=e.opacityElevation,n=e.dayNightTerminator;return this._maxOpacity*t*n>=.001953125}},{key:"_updateMaxOpacity",value:function(){var e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}}]),e}(),Mx=(0,F.c)(),Zx=(0,B.a)(),Ix=function(){function e(){(0,s.Z)(this,e),this._plane=(0,B.a)()}return(0,l.Z)(e,[{key:"isEnabled",get:function(){return!(0,B.d)(this.plane,Zx)}},{key:"plane",get:function(){return this._plane},set:function(e){(0,B.c)(e||Zx,this._plane)}}]),e}(),Dx=n(98757),Lx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({colorWrite:on.BK})}}]),n}(tn.A);Lx.shader=new en.J(Dx.B,(function(){return n.e(61738).then(n.bind(n,61738))}));var Nx=n(40051),Fx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({colorWrite:on.BK})}}]),n}(tn.A);Fx.shader=new en.J(Nx.B,(function(){return n.e(79063).then(n.bind(n,79063))}));var Ux=n(82396),Vx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(),nn.i)}},{key:"initializePipeline",value:function(){return(0,on.sm)({colorWrite:on.BK})}}]),n}(tn.A);Vx.shader=new en.J(Ux.E,(function(){return n.e(53953).then(n.bind(n,53953))}));var Hx=n(90541),zx=function(e){(0,d.Z)(r,e);var t=(0,f.Z)(r);function r(e,n){var i;return(0,s.Z)(this,r),(i=t.call(this,{}))._rctx=e,i._techniqueRep=n,i._passParameters=new Hx.PR,i._isEnabled=!1,i}return(0,l.Z)(r,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"dispose",value:function(){this._abortController=(0,k.IM)(this._abortController),this.disable()}},{key:"_loadResources",value:function(e){var t=this;if((0,k.pC)(this._abortController))return!1;if((0,k.pC)(this._passParameters.searchTexture))return!0;this._abortController=new AbortController;var r=this._abortController.signal;return n.e(57221).then(n.bind(n,57221)).then((function(e){return t._loadTextures(e,r)})).then((function(){return e()})).finally((function(){return t._abortController=null})),!1}},{key:"_loadTextures",value:function(e,t){var n=this;return(0,R.k_)(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,an.cw.LINEAR,an.VI.RGB),this._loadTextureFromBase64(e.searchTexure,an.cw.NEAREST,an.VI.LUMINANCE)]).then((function(e){var r=(0,ns.Z)(e,2),i=r[0],a=r[1];(0,R.Hc)(t)?(i.dispose(),a.dispose(),(0,R.k_)(t)):(n._passParameters.areaTexture=i,n._passParameters.searchTexture=a)}))}},{key:"updating",get:function(){return(0,k.pC)(this._abortController)}},{key:"enable",value:function(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){var t=new un.m;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(Vx,t,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(Lx,t,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(Fx,t,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=(0,dn.E9)(this._rctx),this._passParameters.edges=new Mn.X(this._rctx,{colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.NONE},{target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGB,dataType:an.Br.UNSIGNED_BYTE,samplingMode:an.cw.LINEAR,wrapMode:an.e8.CLAMP_TO_EDGE,width:4,height:4}),this._passParameters.blend=new Mn.X(this._rctx,{colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.NONE},{target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,samplingMode:an.cw.LINEAR,wrapMode:an.e8.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}},{key:"disable",value:function(){this._isEnabled&&(this._vao=(0,k.M2)(this._vao),this._passParameters.areaTexture=(0,k.M2)(this._passParameters.areaTexture),this._passParameters.searchTexture=(0,k.M2)(this._passParameters.searchTexture),this._passParameters.blend=(0,k.M2)(this._passParameters.blend),this._passParameters.edges=(0,k.M2)(this._passParameters.edges),this._isEnabled=!1)}},{key:"_validPassParameters",get:function(){return this._isEnabled?this._passParameters:null}},{key:"render",value:function(e){var t=this._validPassParameters;if(!(0,k.Wi)(t)){t.colorTexture=e;var n=this._rctx,r=n.getBoundFramebufferObject(),i=e.descriptor.width,a=e.descriptor.height;n.bindVAO(this._vao),n.setViewport(0,0,i,a),t.edges.resize(i,a),n.bindFramebuffer(t.edges),n.setClearColor(0,0,0,1),n.clear(an.lk.COLOR_BUFFER_BIT),n.bindTechnique(this._edgeDetectTechnique,t,null),n.drawArrays(an.MX.TRIANGLES,0,3),t.blend.resize(i,a),n.bindFramebuffer(t.blend),n.setClearColor(0,0,1,1),n.clear(an.lk.COLOR_BUFFER_BIT),n.bindTechnique(this._blendWeightsTechnique,t,null),n.drawArrays(an.MX.TRIANGLES,0,3),n.bindFramebuffer(r),n.setClearColor(0,1,0,1),n.clear(an.lk.COLOR_BUFFER_BIT),n.bindTechnique(this._blurTechnique,t,null),n.drawArrays(an.MX.TRIANGLES,0,3)}}},{key:"_loadTextureFromBase64",value:function(e,t,n){var r=this;return(0,mC.t)(e).then((function(e){return new rr.x(r._rctx,{pixelFormat:n,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.CLAMP_TO_EDGE,width:e.width,height:e.height,samplingMode:t},e)}))}}]),r}(J.Z);(0,p._)([(0,Z.Cb)()],zx.prototype,"_abortController",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],zx.prototype,"updating",null),zx=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],zx);var Bx=n(71568);var Gx=function(){function e(t){(0,s.Z)(this,e),this._factory=t,this._originData=new Map}return(0,l.Z)(e,[{key:"acquire",value:function(e){return this.register(this._factory.getOrigin(e))}},{key:"register",value:function(e){var t=this._originData.get(e.id)||new Wx(e);return t.refCount++,this._originData.has(t.origin.id)||this._originData.set(t.origin.id,t),t}},{key:"release",value:function(e){e.refCount--,0===e.refCount&&this._originData.delete(e.origin.id)}},{key:"updateViewMatrices",value:function(e){this._originData.forEach((function(t){(0,wn.c)(t.viewMatrix,e),function(e,t){var n=e[0],r=e[1],i=e[2];t[12]+=n*t[0]+r*t[4]+i*t[8],t[13]+=n*t[1]+r*t[5]+i*t[9],t[14]+=n*t[2]+r*t[6]+i*t[10],t[14]+=n*t[3]+r*t[7]+i*t[11]}(t.origin.vec3,t.viewMatrix)}))}}]),e}(),Wx=(0,l.Z)((function e(t){(0,s.Z)(this,e),this.origin=t,this.refCount=0,this.viewMatrix=(0,Cn.c)()})),jx=n(66327),qx=n(41371),Yx=n(10662),Xx=n(74058),Qx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this)).distanceFalloffFactor=e,i.transparency=r,i.transformNormalViewFromGlobal=(0,Ho.c)(),i}return(0,l.Z)(n)}(Xx.su),Jx=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).transformNormalViewFromGlobal=(0,Ho.c)(),e.slicePlaneLocalOrigin=(0,F.c)(),e.transformNormalGlobalFromModel=(0,Ho.c)(),e}return(0,l.Z)(n)}(Xx.OU),Kx=n(32602),$x=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n,[{key:"initializeConfiguration",value:function(e,t){t.hasWebGL2Context=e.rctx.type===I_.zO.WEBGL2}},{key:"initializeProgram",value:function(e){return new rn.$(e.rctx,n.shader.get().build(this.configuration),xw.so)}},{key:"initializePipeline",value:function(e){return e.blendMinMax?(0,on.sm)({blending:(0,on.wK)(an.zi.ONE,an.zi.ONE,an.zi.ZERO,an.zi.ONE,an.db.ADD,e.blendMinMax.MAX),depthTest:{func:an.wb.LEQUAL},colorWrite:on.BK}):(0,on.sm)({depthTest:{func:an.wb.LEQUAL},depthWrite:on.LZ,colorWrite:on.BK})}}]),n}(tn.A);$x.shader=new en.J(Kx.E,(function(){return n.e(5824).then(n.bind(n,5824))}));var eT=n(34016),tT=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments)).mode=eT.Jb.SOLID,e.hasSlicePlane=!1,e.silhouette=!1,e.legacy=!1,e.antialiasing=!1,e.doublePrecisionRequiresObfuscation=!1,e.hasMultipassTerrain=!1,e.cullAboveGround=!1,e.spherical=!1,e}return(0,l.Z)(n)}(kg.W);(0,p._)([(0,un.o)({count:eT.Jb.COUNT})],tT.prototype,"mode",void 0),(0,p._)([(0,un.o)()],tT.prototype,"hasSlicePlane",void 0),(0,p._)([(0,un.o)()],tT.prototype,"silhouette",void 0),(0,p._)([(0,un.o)()],tT.prototype,"legacy",void 0),(0,p._)([(0,un.o)()],tT.prototype,"antialiasing",void 0),(0,p._)([(0,un.o)()],tT.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,p._)([(0,un.o)()],tT.prototype,"hasMultipassTerrain",void 0),(0,p._)([(0,un.o)()],tT.prototype,"cullAboveGround",void 0),(0,p._)([(0,un.o)()],tT.prototype,"spherical",void 0);var nT,rT=n(77958),iT={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},aT={solid:eT.Jb.SOLID,sketch:eT.Jb.SKETCH,uber:eT.Jb.MIXED},oT=function(){function e(t,n,i){var a,o,l;(0,s.Z)(this,e),this._rctx=t,this._shaderTechniqueRepository=n,this._configuration=new tT,this.refCount=0,this._renderables=new Set,this._sortedRenderables=(l={},(0,td.Z)(l,rT.i.TRANSPARENT,(a={},(0,td.Z)(a,rT.i.TRANSPARENT,new Qd.Z),(0,td.Z)(a,rT.i.OPAQUE,new Qd.Z),a)),(0,td.Z)(l,rT.i.OPAQUE,(o={},(0,td.Z)(o,rT.i.TRANSPARENT,new Qd.Z),(0,td.Z)(o,rT.i.OPAQUE,new Qd.Z),o)),l),this._renderablesDirty=!1,this._drawParameters=new Jx,this._settings=(0,r.Z)((0,r.Z)({},iT),i),this.key=e.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);var u=this._settings.strokesTexture.variants;this.writerSettings={variants:u,reducedPrecision:Jd.Z.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=aT[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=t.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}return(0,l.Z)(e,[{key:"dispose",value:function(){this._technique=(0,k.RY)(this._technique)}},{key:"addRenderable",value:function(e){this._renderables.add(e),this._renderablesDirty=!0}},{key:"removeRenderable",value:function(e){this._renderables.delete(e),this._renderablesDirty=!0}},{key:"setRenderablesDirty",value:function(){this._renderablesDirty=!0}},{key:"forEachRenderable",value:function(e,t){this._renderablesDirty&&this._sortRenderables(),this._sortedRenderables[t][rT.i.TRANSPARENT].forAll(e),this._sortedRenderables[t][rT.i.OPAQUE].forAll(e)}},{key:"updateTechnique",value:function(e,t){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this._shaderTechniqueRepository.releaseAndAcquire($x,this._configuration,this._technique),this._technique}},{key:"bindRegularEdges",value:function(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!1),e,t)}},{key:"bindSilhouetteEdges",value:function(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!0),e,t)}},{key:"renderRegularEdges",value:function(e,t,n,r,i){this._render(e,t,t.regular.vao,n,r,i)}},{key:"renderSilhouetteEdges",value:function(e,t,n,r,i){this._render(e,t,t.silhouette.vao,n,r,i)}},{key:"_render",value:function(e,t,n,r,i,a){a>0&&(this._bindDraw(e,t,r,i),this._rctx.bindVAO(n),this._rctx.capabilities.instancing.drawArraysInstanced(an.MX.TRIANGLE_FAN,0,4,a))}},{key:"_bindDraw",value:function(e,t,n,r){if(this._drawParameters.componentDataTexture=t.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in t.transform)this._lastOriginId!==t.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",t.transform.origin.viewMatrix),this._lastOriginId=t.transform.origin.origin.id),e.setUniformMatrix4fv("model",t.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=t.transform.origin.origin.vec3;else{var i=new _w(t.transform.position),a=(0,bn.t)(sT,(0,bn.e)(sT,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=i.low,this._drawParameters.transformWorldFromModelTH=i.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=a;var o=r.camera.viewInverseTransposeMatrix;(0,Gt.s)(this._drawParameters.slicePlaneLocalOrigin,o[3],o[7],o[11])}e.bindDraw(this._drawParameters,r,n)}},{key:"_sortRenderables",value:function(){var e=this;this._renderablesDirty=!1,this._sortedRenderables[rT.i.TRANSPARENT][rT.i.TRANSPARENT].clear(),this._sortedRenderables[rT.i.TRANSPARENT][rT.i.OPAQUE].clear(),this._sortedRenderables[rT.i.OPAQUE][rT.i.TRANSPARENT].clear(),this._sortedRenderables[rT.i.OPAQUE][rT.i.OPAQUE].clear(),this._renderables.forEach((function(t){t.objectTransparency!==rT.i.INVISIBLE&&t.edgeTransparency!==rT.i.INVISIBLE&&e._sortedRenderables[t.objectTransparency][t.edgeTransparency].push(t)}));var t=function(e,t){return"origin"in e.transform?"origin"in t.transform?e.transform.origin.origin.id<t.transform.origin.origin.id?-1:e.transform.origin.origin.id>t.transform.origin.origin.id?1:0:1:0};this._sortedRenderables[rT.i.TRANSPARENT][rT.i.TRANSPARENT].sort(t),this._sortedRenderables[rT.i.TRANSPARENT][rT.i.OPAQUE].sort(t),this._sortedRenderables[rT.i.OPAQUE][rT.i.TRANSPARENT].sort(t),this._sortedRenderables[rT.i.OPAQUE][rT.i.OPAQUE].sort(t)}}],[{key:"getKey",value:function(e,t,n){return"edges-t:".concat(e,":").concat(t,":").concat(n)}}]),e}(),sT=(0,lb.c)(),lT=n(7494);function uT(e,t){if(!e)return null;for(var n=e.length/2,r=cT*n,i=new Array(n),a=0,o=t===nT.PRESSURE,s=0;s<e.length;s+=2){var l=(e[s]+e[s+1])/2;i[a++]=o?Math.min(r,1-(1-l)*hT):Math.min(r,l*hT)}return i}!function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"}(nT||(nT={}));var cT=.1,hT=.5,dT=function(){function e(t,n,r,i,a){(0,s.Z)(this,e),this.resolution=t,this.normalizationScale=n,this.amplitude=r,this.variants=i,this.texture=a}return(0,l.Z)(e,[{key:"dispose",value:function(){this.texture=(0,k.M2)(this.texture)}}]),e}(),fT={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function pT(e){var t,n=null,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=a.type;if(yT(a))if((0,k.Wi)(n))n=o;else if(n!==o)return"uber"}}catch(s){r.e(s)}finally{r.f()}return(0,k.pC)(n)?n:"uber"}function vT(e){var t,n=rT.i.INVISIBLE,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value.material;if(_T(a)){if(a.color[3]*a.opacity<1)return rT.i.TRANSPARENT;n=rT.i.OPAQUE}}}catch(o){r.e(o)}finally{r.f()}return n}function mT(e){var t,n=rT.i.INVISIBLE,r=(0,i.Z)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value.material;if(_T(a)){switch(a.objectTransparency){case rT.i.TRANSPARENT:case rT.i.INVISIBLE:return rT.i.TRANSPARENT;case rT.i.OPAQUE:if(a.opacity<1)return rT.i.TRANSPARENT}n=rT.i.OPAQUE}}}catch(o){r.e(o)}finally{r.f()}return n}function _T(e){return e.size*e.color[3]*e.opacity>0}function yT(e){return e.size*e.color[3]>0}function gT(e,t,n,r){for(var i=0;i<e.length;i++){var a=e[i].index,o=t[i],s=t[i+1];if(r)for(var l=o;l<s;l++){var u=r[l];n.set(u,a)}else for(var c=o;c<s;c++)n.set(c,a)}}var bT=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._updatingHandles=new ur.t,r._perObjectData=new Map,r._perObjectDataEvictionCache=new Set,r._renderers=new Map,r._gpuMemoryUsage=0,r._workerAbort=new AbortController,r._tmpModelPosition=(0,F.c)(),r._localOrigins=new Gx(new eb.C(e.renderSR)),r}return(0,l.Z)(n,[{key:"initialize",value:function(){this._worker=new lT.D(this.schedule),this._componentColorManager=new Aw(this.rctx,3);for(var e=xw.rD.createBuffer(4),t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=nr.f.createVertex(this.rctx,an.l1.STATIC_DRAW,e.buffer)}},{key:"destroy",value:function(){var e=this;this.destroyed||(this._perObjectData.forEach((function(t){return e._discardObjectEntry(t)})),this._perObjectData.clear(),this._strokesTexture=(0,k.M2)(this._strokesTexture),this._componentColorManager=(0,k.SC)(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=(0,k.M2)(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())}},{key:"updating",get:function(){return this._updatingHandles.updating}},{key:"usedMemory",get:function(){return this._gpuMemoryUsage}},{key:"shouldRender",value:function(){return this._renderers.size>0}},{key:"addComponentObject",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o,s,l,u){var c,h,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.hasObject(t)){e.next=2;break}return e.abrupt("return",this.getObjectMemoryUsage(t));case 2:return h=new xT(new Promise((function(e){return c=e})),r.center,r.radius),this._perObjectData.set(t,h),e.next=6,this._updatingHandles.addPromise(this._addComponentGeometry(n,h,i,o,s,l,u));case 6:return d=e.sent,e.abrupt("return",(this.setNeedsRender(),c(),d));case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i,a,o,s,l){return e.apply(this,arguments)}}()},{key:"addOrUpdateObject3D",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i){var o,s,l,u,c,h,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.destroyed){e.next=2;break}return e.abrupt("return",void S.Z.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance"));case 2:if((null===(o=this._perObjectData.get(t))||void 0===o?void 0:o.renderables.length)>0&&this._perObjectDataEvictionCache.add(o),l=t.boundingVolumeWorldSpace.bounds,u=new xT(new Promise((function(e){return s=e})),(0,ea.g)(l),(0,ea.a)(l)),this._perObjectData.set(t,u),c=new Array,r.mergeGeometries&&t.geometries.length>1&&CT(t))c.push(this._addObjectMergedGeometries(t,u,n,r,i));else for(h=0;h<t.geometries.length;h++)(d=t.geometries[h]).material.supportsEdges&&c.push(this._addGeometry(t,u,d,n[0],r,i));return e.next=10,this._updatingHandles.addPromise(Promise.all(c));case 10:this._perObjectDataEvictionCache.delete(u),this._discardObjectEntry(o),this.setNeedsRender(),s();case 14:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"_discardObjectEntry",value:function(e){var t=this;e&&(e.renderables.length&&(e.renderables.forEach((function(e){return t._removeRenderable(e)})),this.setNeedsRender()),e.loaded=null)}},{key:"hasObject",value:function(e){return this._perObjectData.has(e)}},{key:"updateAllComponentOpacities",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,i,o=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._updatingHandles.addPromise(this._getObjectEntry(t));case 2:if(r=e.sent,!(0,k.Wi)(r)){e.next=5;break}return e.abrupt("return");case 5:i=n instanceof Array?function(e){return n[e]}:function(){return n},r.renderables.forEach((function(e){for(var t=e.components.meta.length,n=0;n<t;n++){var r=i(n),a=e.components.meta[n],s=a.index;a.material.opacity=r,e.components.buffer.textureBuffer.setDataElement(s,1,3,255*r)}o._updateTransparency(e)})),this.setNeedsRender();case 7:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"getObjectMemoryUsage",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getObjectEntry(t);case 2:return n=e.sent,e.abrupt("return",(0,k.pC)(n)?n.renderables.reduce((function(e,t){return e+t.statistics.gpuMemoryUsage}),0):0);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateAllComponentMaterials",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i){var o,s,l,u,c,h=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t instanceof jx.T,s=!!r.hasSlicePlane,l=pT(n),u=oT.getKey(l,s,o),e.next=6,this._updatingHandles.addPromise(this._getObjectEntry(t));case 6:c=e.sent,(0,k.Wi)(c)||(c.renderables.forEach((function(e){if(u!==e.rendererKey){var t=h._renderers.get(e.rendererKey),r=h._acquireRenderer(l,s,o);t.removeRenderable(e),--t.refCount,e.rendererKey=u,r.addRenderable(e)}for(var a=0;a<n.length;a++)e.components.meta[a].material=n[a];i&&h._updateComponentBuffer(e.components),h._updateTransparency(e)})),this.setNeedsRender());case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"updateAllVerticalOffsets",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r,i=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._updatingHandles.addPromise(this._getObjectEntry(t));case 2:r=e.sent,(0,k.Wi)(r)||(r.renderables.forEach((function(e){for(var t=e.components.meta,r=0;r<t.length;r++){var a;e.components.meta[r].verticalOffset=null!==(a=null===n||void 0===n?void 0:n[r])&&void 0!==a?a:0}i._updateComponentBuffer(e.components)})),this.setNeedsRender());case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"updateObjectVisibility",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._updatingHandles.addPromise(this._getObjectEntry(t));case 2:r=e.sent,(0,k.pC)(r)&&(r.renderables.forEach((function(e){return e.visible=n})),this.setNeedsRender());case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"removeObject",value:function(e){var t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))}},{key:"_getObjectEntry",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._perObjectData.get(t)){e.next=3;break}throw new Error("no object");case 3:return e.next=5,n.loaded;case 5:return e.abrupt("return",null==n.loaded?null:n);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"render",value:function(e,t){var n=this;if(!(0,k.Wi)(this._componentColorManager)){this._localOrigins.updateViewMatrices(e.camera.viewMatrix);var r=e.camera.viewInverseTransposeMatrix,i=(0,F.c)(),a=new _w,o=0,s=0;if(this._renderers.forEach((function(r){if(0===r.refCount)n._renderers.delete(r.key),r.dispose();else{var i=!0,a=!0;r.forEachRenderable((function(t){t.visible&&(o+=t.statistics.averageEdgeLength,s++,i&&t.regular&&(r.updateTechnique(e,!1),i=!1),a&&t.silhouette&&(r.updateTechnique(e,!0),a=!1))}),t)}})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0!==s){var l=new Qx(40*o/s,t);(0,Gt.s)(i,r[3],r[7],r[11]),a.set(i),(0,Gt.c)(l.transformWorldFromViewTH,a.high),(0,Gt.c)(l.transformWorldFromViewTL,a.low),(0,bn.f)(l.transformViewFromCameraRelativeRS,e.camera.viewMatrix),(0,bn.t)(MT,l.transformViewFromCameraRelativeRS),(0,bn.e)(l.transformNormalViewFromGlobal,MT),l.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((function(t){n._renderRegularEdges(t,e,l),n._renderSilhouetteEdges(t,e,l)}))}}}},{key:"_updateTransparency",value:function(e){var t=vT(e.components.meta),n=mT(e.components.meta);t===e.edgeTransparency&&n===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=n,this._renderers.get(e.rendererKey).setRenderablesDirty())}},{key:"_computeModelTransformWithLocalOrigin",value:function(e,t,n){e.getCombinedStaticTransformation(t,n);var r=(0,k.pC)(t.localOrigin)?this._localOrigins.register(t.localOrigin):this._localOrigins.acquire((0,Gt.s)(this._tmpModelPosition,n[12],n[13],n[14]));return t.localOrigin=r.origin,function(e,t){var n=-e[0],r=-e[1],i=-e[2],a=t[3],o=t[7],s=t[11],l=t[15];t[0]+=a*n,t[1]+=a*r,t[2]+=a*i,t[4]+=o*n,t[5]+=o*r,t[6]+=o*i,t[8]+=s*n,t[9]+=s*r,t[10]+=s*i,t[12]+=l*n,t[13]+=l*r,t[14]+=l*i}(r.origin.vec3,n),r}},{key:"_updateComponentBuffer",value:function(e){for(var t=e.meta,n=e.buffer,r=new Uint8Array(4),i=0;i<t.length;i++){var a=t[i].material,o=t[i].index,s=(0,Se.uZ)(Math.round(8*a.size),0,255),l=(0,Se.uZ)(a.extensionLength,-128,127)+128,u="solid"===a.type?Yx.P.SOLID:Yx.P.SKETCH,c=255*a.opacity,h=a.color,d=255*h[0],f=255*h[1],p=255*h[2],v=255*h[3];n.textureBuffer.setData(o,0,d,f,p,v),n.textureBuffer.setData(o,1,s,l,u,c),(0,aw.nO)(t[i].verticalOffset,r),n.textureBuffer.setData(o,2,r[0],r[1],r[2],r[3])}}},{key:"_createComponentBuffers",value:function(e){if((0,k.Wi)(this._componentColorManager))return null;for(var t=new Array,n=this._componentColorManager.getBuffer(e.length),r=0;r<e.length;r++){var i=e[r],a=n.acquireIndex();t.push({index:a,verticalOffset:0,material:i})}var o=new TT(n,t);return this._updateComponentBuffer(o),o}},{key:"_extractEdges",value:function(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:i.length;return this._worker.process({data:t,indices:i,indicesLength:a,writerSettings:e,skipDeduplicate:n},this._workerAbort.signal,r)}},{key:"_createRenderable",value:function(e,t,n,r,i){var a=this,o=function(t){return(0,k.pC)(a._verticesBufferObject)?new ST(new er.U(a.rctx,xw.so,{vertices:xw.dx,instances:t===eT.G7.REGULAR?qx.D9.glLayout:qx.qE.glLayout},{vertices:a._verticesBufferObject,instances:nr.f.createVertex(a.rctx,an.l1.STATIC_DRAW,t===eT.G7.REGULAR?e.regular.instancesData.buffer:e.silhouette.instancesData.buffer)}),t===eT.G7.REGULAR?e.regular.lodInfo:e.silhouette.lodInfo):null},s=e.regular.lodInfo.lengths.length>0?o(eT.G7.REGULAR):null,l=e.silhouette.lodInfo.lengths.length>0?o(eT.G7.SILHOUETTE):null,u=((0,k.pC)(s)?s.vao.size:0)+((0,k.pC)(l)?l.vao.size:0);return new PT(s,l,{gpuMemoryUsage:u,externalMemoryUsage:i,averageEdgeLength:e.averageEdgeLength},n,vT(t.meta),mT(t.meta),t,r)}},{key:"_addGeometry",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o,s){var l,u,c,h,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l=r.vertexAttributes.get(tr.T.POSITION),u=r.indices.get(tr.T.POSITION),c=(0,Cn.c)(),h=this._computeModelTransformWithLocalOrigin(t,r,c),d=new OT(l,u,c,h),e.abrupt("return",this._addPositionData(n,d,r.edgeIndicesLength,i,o,s));case 2:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i,a,o){return e.apply(this,arguments)}}()},{key:"_addPositionData",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o){var s,l,u,c,h,d,f,p,v,m,_,y,g=arguments;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=g.length>5&&void 0!==g[5]&&g[5],null!=t.loaded){e.next=3;break}return e.abrupt("return");case 3:if(l=this._createComponentBuffers([i]),!((0,k.Wi)(l)||r<=0)){e.next=6;break}return e.abrupt("return");case 6:for(u=this._acquireRenderer(i.type,!!o.hasSlicePlane,!0),c=n.modelTransform,h=n.origin,d=n.indices,f=n.position,p=f.data.length/f.size,v=xw.tf.createBuffer(p),m=0;m<p;m++)v.position.set(m,0,f.data[m*f.size+0]),v.position.set(m,1,f.data[m*f.size+1]),v.position.set(m,2,f.data[m*f.size+2]);return gT(l.meta,[0,v.componentIndex.count],v.componentIndex),e.next=11,this._updatingHandles.addPromise(this._extractEdges(u.writerSettings,v,!1,s,d,r));case 11:if(_=e.sent,null!=t.loaded){e.next=14;break}return e.abrupt("return");case 14:y=this._createRenderable(_,l,new kT(c,h),u.key,!1),t.renderables.push(y),u.addRenderable(y),this._gpuMemoryUsage+=y.statistics.gpuMemoryUsage;case 16:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i,a){return e.apply(this,arguments)}}()},{key:"_addComponentGeometry",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o,s,l){var u,c,h,d,f,p,v;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=n.loaded){e.next=2;break}return e.abrupt("return",0);case 2:if(u=this._createComponentBuffers(s),!(0,k.Wi)(u)){e.next=5;break}return e.abrupt("return",0);case 5:return c=pT(s),h=this._acquireRenderer(c,l.hasSlicePlane||!1,!1),d=xw.tf.createBuffer(r.count),(0,cb.c)(d.position,r),gT(u.meta,o,d.componentIndex,i),!0,f=h.writerSettings,e.next=11,this._updatingHandles.addPromise(this._extractEdges(f,d,true,!1,i));case 11:if(p=e.sent,null!=n.loaded){e.next=14;break}return e.abrupt("return",0);case 14:return v=this._createRenderable(p,u,t,h.key,!0),e.abrupt("return",(n.renderables.push(v),h.addRenderable(v),v.statistics.gpuMemoryUsage));case 16:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i,a,o,s){return e.apply(this,arguments)}}()},{key:"_addObjectMergedGeometries",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n,r,i,o){var s,l,u,c,h,d,f,p,v,m,_,y,g,b,w,C,x,T,S,k,P,R,A;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=new Map,l=0,u=null,c=0,h=0;case 3:if(!(h<t.geometries.length)){e.next=13;break}if((d=t.geometries[h]).material.supportsEdges){e.next=7;break}return e.abrupt("continue",10);case 7:!u&&d.localOrigin&&(u=d),f=d.vertexAttributes.get(tr.T.POSITION),c+=f.data.length/f.size,l+=d.edgeIndicesLength;case 10:h++,e.next=3;break;case 13:p=c>=65536?Uint32Array:Uint16Array,v=l?new p(l):null,m=[],_=0,y=0;case 16:if(!(y<t.geometries.length)){e.next=27;break}if((g=t.geometries[y]).material.supportsEdges){e.next=20;break}return e.abrupt("continue",24);case 20:if(b=g.vertexAttributes.get(tr.T.POSITION),w=g.indices.get(tr.T.POSITION),null==(C=s.get(b.data))){for(C=m.length/3,x=0;x<b.data.length;x+=b.size)m.push(b.data[x+0]),m.push(b.data[x+1]),m.push(b.data[x+2]);s.set(b.data,C)}if(w)for(T=0;T<g.edgeIndicesLength;T++)v[_++]=C+w[T];case 24:y++,e.next=16;break;case 27:for(S=u||t.geometries[0],k=(0,Cn.c)(),P=this._computeModelTransformWithLocalOrigin(t,S,k),R=0;R<t.geometries.length;R++)t.geometries[R].localOrigin=P.origin;return A=new OT({data:m,size:3},v,k,P),e.next=32,this._updatingHandles.addPromise(this._addPositionData(n,A,v.length,r[0],i,o));case 32:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i,a){return e.apply(this,arguments)}}()},{key:"_acquireRenderer",value:function(e,t,n){var r=oT.getKey(e,t,n),a=this._renderers.get(r);return(0,k.Wi)(this._strokesTexture)&&(this._strokesTexture=function(e){var t,n=fT.resolution,r=n/2,a=new Uint8Array(4*n*n),o=4*n*r,s=fT.amplitude,l=2*s,u=4*n,c=Math.log2(n)+1,h=fT.strokes.length,d=(c-1)*h*u,f=(0,i.Z)(fT.strokes);try{for(f.s();!(t=f.n()).done;){for(var p=t.value,v=p.distance,m=p.pressure,_=v,y=m,g=d,b=0;b<c;b++){0!==b&&(_=uT(_,nT.DISTANCE),y=uT(y,nT.PRESSURE));for(var w=0;w<fT.resolution;w++){var C=.5+(_?_[w%_.length]/l:0),x=y?y[w%y.length]:1;(0,Qw.I)(C,a,g),(0,Qw.I)(x,a,g+o),g+=4}g-=u*(h+1)}d+=u}}catch(S){f.e(S)}finally{f.f()}var T=new rr.x(e,{pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:an.cw.LINEAR,width:n,height:n,wrapMode:an.e8.REPEAT},a);return new dT(n,l,s,h,T)}(this.rctx)),a||(a=new oT(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:n,spherical:this.viewingMode===he.JY.Global}),this._renderers.set(r,a)),++a.refCount,a}},{key:"_removeRenderable",value:function(e){wT(e.regular),wT(e.silhouette);var t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;var n,r=(0,i.Z)(e.components.meta);try{for(r.s();!(n=r.n()).done;){var a=n.value;e.components.buffer.releaseIndex(a.index)}}catch(o){r.e(o)}finally{r.f()}}}},{key:"_updateObjectCameraDistances",value:function(e){var t=e.camera.eye,n=e.camera.viewForward,r=(0,F.c)(),i=function(e){(0,Gt.w)(r,e.center,t);var i=(0,Gt.e)(r,n),a=e.radius,o=i<-a?1/0:i<a?0:i-a;e.renderables.forEach((function(e){return e.distanceToCamera=o}))};this._perObjectData.forEach(i),this._perObjectDataEvictionCache.forEach(i)}},{key:"_renderRegularEdges",value:function(e,t,n){var r=e.bindRegularEdges(n,t),i=n.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((function(i){if(RT(i)&&i.visible){var o=ET(i.regular.lod.lengths,i.distanceToCamera,a);e.renderRegularEdges(r,i,n,t,o)}}),i)}},{key:"_renderSilhouetteEdges",value:function(e,t,n){var r=e.bindSilhouetteEdges(n,t),i=n.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((function(i){if(AT(i)&&i.visible){var o=ET(i.silhouette.lod.lengths,i.distanceToCamera,a);e.renderSilhouetteEdges(r,i,n,t,o)}}),i)}},{key:"test",get:function(){var e=this;return{hasRenderedPrimitives:function(t){var n=!1,r=t.perScreenPixelRatio,i=function(e,t){return e.forEachRenderable((function(e){e.visible&&!n&&(RT(e)&&(n=ET(e.regular.lod.lengths,e.distanceToCamera,r)>0),!n&&AT(e)&&(n=ET(e.silhouette.lod.lengths,e.distanceToCamera,r)>0))}),t)};return e._renderers.forEach((function(e){n||(i(e,rT.i.OPAQUE),i(e,rT.i.TRANSPARENT))})),n}}}}]),n}(J.Z);function wT(e){(0,k.pC)(e)&&(e.vao.vertexBuffers.instances.dispose(),e.vao.dispose(!1),e.vao=null)}function CT(e){for(var t=null,n=null,r=0;r<e.geometries.length;r++){var i=e.geometries[r];if(i.material.supportsEdges){if(t){if(!(0,D.fS)(t,i.transformation))return!1}else t=i.transformation;if(!n&&(0,k.pC)(i.localOrigin))n=i;else if(n&&(0,k.pC)(n.localOrigin)&&(0,k.pC)(i.localOrigin)&&n.localOrigin.id!==i.localOrigin.id)return!1}}return!0}(0,p._)([(0,Z.Cb)({constructOnly:!0})],bT.prototype,"rctx",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],bT.prototype,"renderSR",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],bT.prototype,"viewingMode",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],bT.prototype,"techniqueRepository",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],bT.prototype,"setNeedsRender",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],bT.prototype,"schedule",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],bT.prototype,"_updatingHandles",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],bT.prototype,"updating",null),bT=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],bT);var xT=(0,l.Z)((function e(t,n,r){var i=this;(0,s.Z)(this,e),this.center=n,this.radius=r,this.renderables=new Array,this.loaded=t,this.loaded.then((function(){null!=i.loaded&&(i.loaded=!0)}))})),TT=(0,l.Z)((function e(t,n){(0,s.Z)(this,e),this.buffer=t,this.meta=n})),ST=(0,l.Z)((function e(t,n){(0,s.Z)(this,e),this.vao=t,this.lod=n})),kT=(0,l.Z)((function e(t,n){(0,s.Z)(this,e),this.modelMatrix=t,this.origin=n})),PT=(0,l.Z)((function e(t,n,r,i,a,o,l,u){(0,s.Z)(this,e),this.regular=t,this.silhouette=n,this.statistics=r,this.transform=i,this.edgeTransparency=a,this.objectTransparency=o,this.components=l,this.rendererKey=u,this.distanceToCamera=0,this.visible=!0}));function RT(e){return(0,k.pC)(e.regular)}function AT(e){return(0,k.pC)(e.silhouette)}function ET(e,t,n){var r=t*n,i=(0,D.$A)(e,r,!0);return-1===i?r<e[0]?e.length:0:e.length-i}var OT=(0,l.Z)((function e(t,n,r,i){(0,s.Z)(this,e),this.position=t,this.indices=n,this.modelTransform=r,this.origin=i})),MT=(0,Ho.c)(),ZT=n(80903),IT=n(90941),DT=n(23879),LT=n(40235);var NT,FT=function(){function e(t,n){var r=this;(0,s.Z)(this,e),this._timer=t,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,n.forEach((function(e){var t=r._timer.createQuery(),n=r._timer.createQuery();r._queryPool.push(t,n),r._queryResults.set(e,null)}))}return(0,l.Z)(e,[{key:"start",value:function(){LT.P9||(this._currentQuery=this._queryPool.pop(),(0,k.Wi)(this._currentQuery)||(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}},{key:"stop",value:function(e){if(this._timer.disjoint()||(0,k.Wi)(this._currentQuery)||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();var t=this._queryResults.get(e);if((0,k.Wi)(t))return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;var n=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,n}},{key:"abort",value:function(){(0,k.pC)(this._currentQuery)&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}},{key:"dispose",value:function(){var e=this;(0,k.pC)(this._currentQuery)&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((function(t){e._timer.deleteQuery(t)})),this._queryResults.forEach((function(t){(0,k.Wi)(t)||e._timer.deleteQuery(t)}))}}]),e}();!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.LINEAR_DEPTH="linear depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.NORMALS="normals",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.SSAO="SSAO",e.OPAQUE="opaque",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.ENVIRONMENT="environment",e.LASER_LINE="laser line",e.OCCLUDED="occluded",e.ANTIALIASING="antialiasing",e.HIGHLIGHTS="highlights",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish"}(NT||(NT={}));var UT,VT="Total",HT=function(){function e(t){(0,s.Z)(this,e),this._rctx=t,this._startTimeStampCPU=(0,lr.HA)(0),this._lastTimeStampCPU=(0,lr.HA)(0),this._totalCPUTime=new IT.Z(VT),this._cpuTimeSamplers=new Map(Object.values(NT).map((function(e){return[e,new IT.Z(e)]}))),this._enableGPUTimer=0,this._totalGPUTime=new IT.Z("GPU"),this._gpuTimeSamplers=new Map(Object.values(NT).map((function(e){return[e,new IT.Z(e)]}))),this._totalTime=(0,lr.HA)(0),this._totalFrameCount=0}return(0,l.Z)(e,[{key:"totalCPUTimeSampler",get:function(){return this._totalCPUTime}},{key:"cpuTimeSamplers",get:function(){return Array.from(this._cpuTimeSamplers.values())}},{key:"totalGPUTimeSampler",get:function(){return this._totalGPUTime}},{key:"gpuTimeSamplers",get:function(){return Array.from(this._gpuTimeSamplers.values())}},{key:"gpuSamplingEnabled",get:function(){return(0,k.pC)(this._gpuTimerPool)}},{key:"totalTime",get:function(){return this._totalTime}},{key:"totalFrameCount",get:function(){return this._totalFrameCount}},{key:"elapsedTime",get:function(){return(0,lr.HA)(performance.now()-this._startTimeStampCPU)}},{key:"enableGPUPerformanceInfo",value:function(){var e=this;if((0,k.Wi)(this._gpuTimerPool)){var t=[].concat((0,Uf.Z)(Object.values(NT)),[VT]);this._gpuTimerPool=function(e,t){var n=e.capabilities.disjointTimerQuery;return(0,k.Wi)(n)?null:new FT(n,t)}(this._rctx,t)}return(0,k.Wi)(this._gpuTimerPool)?{hasGPUTimerSupport:!1,remove:function(){}}:(++this._enableGPUTimer,{hasGPUTimerSupport:!0,remove:(0,DT.IH)((function(){--e._enableGPUTimer,0===e._enableGPUTimer&&(e._gpuTimerPool=(0,k.M2)(e._gpuTimerPool))}))})}},{key:"startFrame",value:function(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,lr.HA)(performance.now()),(0,k.pC)(this._gpuTimerPool)&&this._gpuTimerPool.start()}},{key:"advance",value:function(e){var t=(0,lr.HA)(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,(0,k.pC)(this._gpuTimerPool)){var n=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(n),this._gpuTimerPool.start()}}},{key:"finishFrame",value:function(){if((0,k.pC)(this._gpuTimerPool)){var e=this._gpuTimerPool.stop(NT.FINISH);this._gpuTimeSamplers.get(NT.FINISH).record(e)}var t=(0,lr.HA)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,lr.HA)(this._totalTime+t),this._totalCPUTime.record(t),(0,k.pC)(this._gpuTimerPool)&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((function(e,t){return e+(t.last||0)}),0)),++this._totalFrameCount}}]),e}(),zT=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i,a,o,l,u,c){var h;return(0,s.Z)(this,n),(h=t.call(this,{}))._stage=e,h._materialRepository=r,h._shaderTechniqueRepository=a,h._rctx=o,h._compositingHelper=l,h._magnifierHelper=u,h._requestRender=c,h._materialRenderers=new Qd.Z,h._needsTransparentPass=!1,h._hasHUDElements=!1,h._hasHighlights=!1,h._hasWater=!1,h._hasOverlayWater=!1,h._renderOverlay=function(e){},h._isRendering=!1,h._fallbackDepthStencilTexture=null,h._sliceHelper=new Ix,h._state=Xr.n.IDLE,h._renderStateFeatures=(0,ui.n)(),h._antialiasingEnabled=!0,h._highQualityTransparencyEnabled=!0,h._terrainRenderingEnabled=!0,h._terrainTransparency=Rg.Opaque,h._waterReflectionEnabled=!1,h._ssaoEnabled=!1,h._hasAnimations=!1,h._animationTimestep=new UC,h._handles=new K.Z,h._renderHiddenTransparentEdges=function(){},h._oitUsed=!1,h._smaaPass=new zx(h._rctx,a),c(),h._offscreen=new ox(h._rctx,h._compositingHelper),h.performanceInfo=new HT(h._rctx),h._shadowMap=new yx.l(h._rctx,e.viewingMode),h._ssaoHelper=new Bx.L(e.view,a,h._rctx,c),h._highlight=new tx(a,h._rctx),h._shadowHighlight=new Ox(h._rctx,e.viewingMode),h._shadowAccumulator=new Cx(h._rctx,a,e,(function(e){var t=h.shadowsEnabled;h._shadowMap.enabled=!0,h._prepare(e.camera,e.contentCamera),h._renderPlugins.prepareRender(),h._shadowMap.enabled=t}),(function(e,t,n){e.shadowMap.start(e.camera,t,n),h._renderShadowCascades(li.H.Shadow,e.shadowMap),e.camera.setGLViewport(h._rctx),h._prepare(e.camera,e.contentCamera)}),c),h._renderContext=new ux.V(h._rctx,h._offscreen,h._shadowMap,h._ssaoHelper,h._sliceHelper),h._renderPlugins=new hx({renderContext:h._renderContext,techniqueRepository:a,textureRepository:i,materialRepository:h._materialRepository,requestRender:c,controller:e}),h.renderPassManager=new IC(h._rctx,h._shaderTechniqueRepository),h._renderPlugins.add(h.renderPassManager.slots(),h.renderPassManager),h._handles.add([(0,A.YP)((function(){return h._stage.view.state.camera}),(function(){return c()}),A.tX),(0,A.YP)((function(){return Jd.Z.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES}),(function(e){h._renderHiddenTransparentEdges=e?function(){return h._renderEdges(rT.i.TRANSPARENT)}:function(){},c()}),A.nn),(0,A.YP)((function(){return h._ssaoEnabled||h.isFeatureEnabled(ui.Y.SSAO)}),(function(e){return h._ssaoHelper.enabled=e}),A.tX)]),h}return(0,l.Z)(n,[{key:"_bindParameters",get:function(){return this._renderContext.bindParameters}},{key:"isFeatureEnabled",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._state;return(0,k.Pt)(this._renderStateFeatures.get(t,e),!1)}},{key:"setFeatureEnabled",value:function(e,t,n){this._renderStateFeatures.set(t,e,n),this.notifyChange("_renderStateFeatures"),this._requestRender()}},{key:"_antialiasing",get:function(){return this._antialiasingEnabled||this.isFeatureEnabled(ui.Y.Antialiasing)}},{key:"_highQualityTransparency",get:function(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(ui.Y.HighQualityTransparency)}},{key:"hasWaterReflection",get:function(){return this.hasWater&&(this._waterReflectionEnabled||this.isFeatureEnabled(ui.Y.WaterReflection))}},{key:"hasWater",get:function(){return this._hasWater||this._hasOverlayWater}},{key:"normalizeCtorArgs",value:function(){return{}}},{key:"destroy",value:function(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=(0,k.hw)(this._gpuTimerHandle),this._materialRenderers.forAll((function(e){return e.dispose()})),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=(0,k.M2)(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),qC.j.prune()}},{key:"disposeOffscreenBuffers",value:function(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}},{key:"updating",get:function(){return this._antialiasing&&this._smaaPass.updating||(0,k.pC)(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}},{key:"ensureEdgeView",value:function(){var e=this;return(0,k.Wi)(this._edgeView)&&(this._edgeView=new bT({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:function(){return e._requestRender()},schedule:function(t){return e._stage.view.resourceController.immediate.schedule(t)}}),this._handles.add((0,A.YP)((function(){return(0,k.yw)(e._edgeView,(function(e){return e.updating}))}),(function(){return e._requestRender()}),A.Z_)),this._requestRender()),this._edgeView}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return(0,wn.h)(this._bindParameters.ssr.reprojectionMatrix,Cn.I)}},{key:"_reprojectionMatrix",set:function(e){(0,D.Vx)(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}},{key:"shadowsEnabled",get:function(){var e;return!(null===(e=this._shadowMap)||void 0===e||!e.enabled)}},{key:"setParameters",value:function(e){var t=this._shadowMap,n=this._bindParameters;if(void 0!==e.screenSpaceReflectionsEnabled&&n.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(n.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),(0,k.pC)(e.environment)){(0,k.pC)(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible),void 0!==e.environment.lighting.ambientOcclusionEnabled&&this._ssaoEnabled!==e.environment.lighting.ambientOcclusionEnabled&&(this._ssaoEnabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),void 0!==e.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());var r="virtual"!==e.environment.lighting.type;n.enableFillLights!==r&&(n.enableFillLights=r,this._requestRender())}e.background&&this._offscreen.background!==e.background&&(this._offscreen.background=e.background,this._requestRender()),void 0!==e.antialiasingEnabled&&this._antialiasingEnabled!==e.antialiasingEnabled&&(this._antialiasingEnabled=e.antialiasingEnabled,this._requestRender()),void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.renderOverlay&&this._renderOverlay!==e.renderOverlay&&(this._renderOverlay=e.renderOverlay,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=(0,k.Wg)(e.slicePlane),this._requestRender()),void 0!==e.terrainRenderingEnabled&&this._terrainRenderingEnabled!==e.terrainRenderingEnabled&&(this._terrainRenderingEnabled=e.terrainRenderingEnabled,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"_hasOITSupport",get:function(){return this._rctx.driverTest.floatBufferBlend.result}},{key:"_oitEnabled",get:function(){return this._highQualityTransparency&&this._hasOITSupport}},{key:"modify",value:function(e,t){var n=this;this._isRendering&&console.warn("Renderer.modify called while rendering");var r=e.adds,i=e.removes,a=e.updates;if(0!==r.length||0!==i.length||0!==a.length){var o=(0,cx.q)(e),s=!1;o.forEach((function(r,i){if(!t.done){var a=n._materialRenderers.find((function(e){return e.material===i}));(0,k.Wi)(a)&&r.adds.length>0&&(a=new ZT.A(n._rctx,n._materialRepository,i),n._materialRenderers.push(a)),a&&(a.modify(r),a.isEmpty&&(s=!0)),r.removes.forEach((function(t){return e.removes.removeUnordered(t)})),r.adds.forEach((function(t){return e.adds.removeUnordered(t)})),r.updates.forEach((function(t){return e.updates.removeUnordered(t)})),t.madeProgress()}})),s&&this._materialRenderers.filterInPlace((function(e){return!e.isEmpty||(e.dispose(),!1)})),this._hasHighlights=this._materialRenderers.some((function(e){return e.hasHighlights})),this._bindParameters.hasOccludees=this._materialRenderers.some((function(e){return e.hasOccludees})),this._hasWater=this._materialRenderers.some((function(e){return e.hasWater})),this._hasHUDElements=this._materialRenderers.some((function(e){return e.requiresSlot(ci.r.LINE_CALLOUTS_HUD_DEPTH,li.H.Color)||e.requiresSlot(ci.r.HUD_MATERIAL,li.H.Color)||e.requiresSlot(ci.r.LABEL_MATERIAL,li.H.Color)})),this._requestRender()}}},{key:"updateAnimation",value:function(e){var t=this,n=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll((function(n){return t._hasAnimations=n.updateAnimation(e)||t._hasAnimations})),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations!==n&&(this._gpuTimerHandle=n?(0,k.hw)(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}},{key:"animationTimestep",get:function(){return this._animationTimestep.value}},{key:"animationTimeDilation",get:function(){return this._animationTimestep.timeDilation}},{key:"resetAnimation",value:function(){this._animationTimestep.clear()}},{key:"render",value:function(e,t,n,r,i){var a=this;this._isRendering=!0,this.performanceInfo.startFrame();var o=n.camera,s=n.contentCamera,l=n.mode;this._state=l,this._renderOverlay(i),this.performanceInfo.advance(NT.OVERLAY),this._renderContext.time=i,this._bindParameters.transparencyPassType=nw.A.NONE;var u=this._offscreen;u.setupRenderTarget(this.hasWaterReflection);var c=(0,B.a)(this._sliceHelper.plane);r===bv.Iq.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),o.setGLViewport(this._rctx),this._prepare(o,s),this._renderPlugins.prepareRender(),this.performanceInfo.advance(NT.PREPARE);var h=this._computeDepthRange(o);this._renderShadowMap(e,o,this._bindParameters.lighting.mainLight.direction,h),this.performanceInfo.advance(NT.SHADOW_MAP),u.initializeFrame(o),this._ensureBindParameters(o,s),this._renderLinearDepth(),this.performanceInfo.advance(NT.LINEAR_DEPTH),this._accumulateShadows(h,o,s),this.performanceInfo.advance(NT.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(NT.NORMALS),this._ensureBindParametersSSR(i),this._renderSSAO(i),this.performanceInfo.advance(NT.SSAO),this._renderContext.output=li.H.Color,u.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(NT.OPAQUE);var d=this._terrainRenderingEnabled&&(this._terrainTransparency===Rg.Semitransparent||this._terrainTransparency===Rg.TransparentWithDraped),f=this._highQualityTransparency&&d;this._renderTerrainLinearDepth(f),this._setMultipassEnabled(f),this._setTerrainCulling(f),this._renderEdges(rT.i.OPAQUE),this.performanceInfo.advance(NT.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(ci.r.VOXEL),this.performanceInfo.advance(NT.VOXEL),this._renderHiddenTransparentEdges();var p=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;p&&(this._oitEnabled?this._renderOrderIndependentTransparency((function(){return a._renderTransparentGeometry()}),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(NT.TRANSPARENT),this._renderGeometryLinearDepth(f);var v=this._renderHUDVisibility(f);f||this._renderInternalSlot(ci.r.LINE_CALLOUTS),this.performanceInfo.advance(NT.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(t),this.performanceInfo.advance(NT.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(rT.i.TRANSPARENT,f),this.performanceInfo.advance(NT.TRANSPARENT_EDGES),this._renderTransparentTerrain(),d&&v&&(f?this._renderLineCallouts(FC.v.Occluded):u.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(FC.v.Occluded,u.framebuffer),this.performanceInfo.advance(NT.HUD_OCCLUDED)),this.performanceInfo.advance(NT.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),d&&(u.compositeTransparentTerrainOntoMain(this._bindParameters),f&&(this._renderEdges(rT.i.OPAQUE),this.performanceInfo.advance(NT.OPAQUE_EDGES),p&&(this._oitEnabled?this._renderOrderIndependentTransparency((function(){return a._renderTransparentGeometry()}),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(NT.TRANSPARENT),this._renderEdges(rT.i.TRANSPARENT),this.performanceInfo.advance(NT.TRANSPARENT_EDGES))),f&&this._renderLineCallouts(FC.v.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),u.renderToTargets((function(){a._renderInternalSlot(ci.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),a._renderSlot(ci.r.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),a._renderSlot(ci.r.LASERLINES)}),u.currentColorTarget,u.mainDepth),this.performanceInfo.advance(NT.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&u.renderTmpAndCompositeToMain((function(){return a._renderSlot(ci.r.LASERLINES_CONTRAST_CONTROL)}),this._bindParameters,Dw.PremultipliedAlpha),this.performanceInfo.advance(NT.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(NT.OCCLUDED);var m=r===bv.Iq.ON&&this._magnifierHelper.enabled,_=m&&(0,k.Wi)(e)?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):e;this._rctx.bindFramebuffer(_);var y=this._offscreen.colorTexture;!this._renderAntiAliasing(y)&&(0,k.pC)(y)&&this._compositingHelper.composite(this._bindParameters,y,Dw.None),this.performanceInfo.advance(NT.ANTIALIASING),this._renderHUD(FC.v.NotOccluded,_),this.performanceInfo.advance(NT.HUD),this._renderHighlights(_,this._bindParameters),this.performanceInfo.advance(NT.HIGHLIGHTS),m&&this._magnifierHelper.render(this._rctx,this._bindParameters),_!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,Dw.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=c,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}},{key:"_renderObjectAndLayerIdColor",value:function(e){var t=this;if((0,k.pC)(e)&&(0,x.Z)("enable-feature:objectAndLayerId-rendering")){var n=this._renderContext.output;this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((function(){return t._renderGeometryAndTransparentTerrainPass(li.H.ObjectAndLayerIdColor)}),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((function(){t._bindParameters.renderTransparentlyOccludedHUD=FC.v.NotOccluded,t._renderInternalSlot(ci.r.HUD_MATERIAL)}),void 0,!0,!0),this._renderContext.output=n}}},{key:"finish",value:function(e){this._hasAnimations||this._animationTimestep.clear();var t=this.performanceInfo.gpuSamplingEnabled,n=e===bv.Xx.BACKGROUND;if(n||t){var r=n?this.performanceInfo.elapsedTime:0,i=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),a=Math.max(r,i);this._animationTimestep.frame(a,n)}}},{key:"readDepthPixels",value:function(e,t,n){var r=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);var i=an.lk.COLOR_BUFFER_BIT|an.lk.DEPTH_BUFFER_BIT|an.lk.STENCIL_BUFFER_BIT;this._rctx.clearSafe(i),this._renderGeometryAndTransparentTerrainPass(li.H.Depth)}r.readPixels(t[0],t[1],t[2],t[3],an.VI.RGBA,an.Br.UNSIGNED_BYTE,n)}},{key:"readHUDVisibility",value:function(e,t,n,r,i){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(e,t,n,r,an.VI.RGBA,an.Br.UNSIGNED_BYTE,i)}},{key:"readAccumulatedShadow",value:function(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}},{key:"_setMultipassEnabled",value:function(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e}},{key:"_setTerrainCulling",value:function(e){this._bindParameters.multipassTerrain.cullAboveGround=e}},{key:"_renderSlot",value:function(e){this._bindParameters.slot=e,this._renderPlugins.render()}},{key:"_renderEdges",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._edgeView;(0,k.pC)(r)&&r.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain((function(){return r.render(t._bindParameters,e)}),this._bindParameters,Dw.Alpha,n)}},{key:"_renderShadowMap",value:function(e,t,n,r){var i=this,a=this._shadowMap;a.enabled&&this.isFeatureEnabled(ui.Y.ShadowMapUpdate)&&(a.start(t,n,r),this._shadowHighlight.updateParameters(t,n),this._needsShadowHighlight?(this._renderShadowCascades(li.H.ShadowHighlight,this._shadowMap,(function(e){return a.takeCascadeSnapshotTo(e,yx.i.Highlight)})),a.clear(),this._renderShadowCascades(li.H.ShadowExcludeHighlight,this._shadowMap,(function(e){a.takeCascadeSnapshotTo(e,yx.i.Default),i._renderGeometryAndTransparentTerrainPass(li.H.ShadowHighlight)}))):this._renderShadowCascades(li.H.Shadow),a.finish(e),t.setGLViewport(this._rctx))}},{key:"_renderShadowCascades",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._shadowMap,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){},a=(0,i.Z)(n.cascades);try{for(a.s();!(t=a.n()).done;){var o=t.value;o.camera.setGLViewport(this._rctx),this._prepare(o.camera,o.camera),this._renderGeometryAndTransparentTerrainPass(e),r(o)}}catch(s){a.e(s)}finally{a.f()}}},{key:"_needsLinearDepth",get:function(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasWaterReflection||this._needsShadowHighlight||this._needsShadowCast}},{key:"_renderLinearDepth",value:function(){var e=this;this._needsLinearDepth?this._offscreen.renderToTargets((function(){return e._renderGeometryAndTransparentTerrainPass(li.H.Depth)}),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture}},{key:"_renderTerrainLinearDepth",value:function(e){var t=this;if(e){var n=this._renderContext.output;this._renderContext.output=li.H.Depth,this._offscreen.renderToTargets((function(){return t._renderTransparentTerrain()}),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=n}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture}},{key:"_renderGeometryLinearDepth",value:function(e){var t=this;if(e){var n=this._renderContext.output;this._offscreen.renderToTargets((function(){return t._renderGeometryPass(li.H.Depth)}),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=n}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture}},{key:"_needsNormal",get:function(){return this._ssaoHelper.active}},{key:"_renderNormal",value:function(){var e=this;this._needsNormal?this._offscreen.renderToTargets((function(){e._renderGeometryAndTransparentTerrainPass(li.H.Normal)}),this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)}},{key:"_needsDepthRange",get:function(){return this._shadowMap.enabled||this._needsShadowCast}},{key:"_computeDepthRange",value:function(e){if(!this._needsDepthRange)return Eb;var t=$w(e,this._materialRenderers,this._stage.layers);return Rb(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}},{key:"_renderGeometryAndTransparentTerrainPass",value:function(e){this._renderContext.output=e,this._renderGeometryPass(e),this._renderTransparentTerrain()}},{key:"_renderGeometryPass",value:function(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}},{key:"_renderSSAO",value:function(e){this._ssaoHelper.render(this._bindParameters,e,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)}},{key:"_renderOpaqueGeometry",value:function(){this._renderSlot(ci.r.INTEGRATED_MESH),this._renderSlot(ci.r.OPAQUE_TERRAIN),this._renderInternalSlot(ci.r.OPAQUE_MATERIAL),this._renderSlot(ci.r.OPAQUE_MATERIAL),this._renderSlot(ci.r.POSTPROCESSING_ENVIRONMENT_OPAQUE)}},{key:"_renderTransparentGeometry",value:function(){this._renderInternalSlot(ci.r.TRANSPARENT_MATERIAL),this._renderSlot(ci.r.TRANSPARENT_MATERIAL)}},{key:"_renderTransparentTerrain",value:function(){this._renderSlot(ci.r.TRANSPARENT_TERRAIN)}},{key:"_renderHUDVisibility",value:function(e){var t=this,n=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((function(){t._bindParameters.hudVisibilityTexture=t._renderContext.offscreenRenderingHelper.hudVisibilityTexture,n=t._renderInternalSlot(ci.r.OCCLUSION_PIXELS)}),e),n}},{key:"_renderLineCallouts",value:function(e){var t=this;this._bindParameters.renderTransparentlyOccludedHUD=e,e===FC.v.Occluded?this._offscreen.renderToTargets((function(){return t._renderInternalSlot(ci.r.LINE_CALLOUTS)}),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(ci.r.LINE_CALLOUTS)}},{key:"_renderHUD",value:function(e,t){var n=this;this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency((function(){return n._renderHUDElements(e)}),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,Dw.PremultipliedAlpha)):e===FC.v.Occluded?this._offscreen.renderToTargets((function(){return n._renderHUDElements(FC.v.Occluded)}),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}},{key:"_renderHUDElements",value:function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(ci.r.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(ci.r.HUD_MATERIAL),this._renderInternalSlot(ci.r.LABEL_MATERIAL)}},{key:"_needsHighlight",get:function(){return this._hasHighlights||this._renderPlugins.needsHighlight}},{key:"_needsShadowHighlight",get:function(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}},{key:"_renderHighlights",value:function(e,t){var n=this;if(this._needsHighlight){var r=this._highlight,i=this._offscreen.renderToTargets((function(){n._renderGeometryAndTransparentTerrainPass(li.H.Highlight),n._rctx.clearSafe(an.lk.DEPTH_BUFFER_BIT),n._renderHUDElements(FC.v.Both)}),this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=i.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(t,e),r.render(this._bindParameters,i,e)}else this._offscreen.disposeTarget(this._offscreen.highlight)}},{key:"_needsShadowCast",get:function(){return this._shadowAccumulator.isAccumulating}},{key:"_accumulateShadows",value:function(e,t,n){this._needsShadowCast&&(0,k.pC)(this._offscreen.linearDepthTexture)&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,e,t,n)}},{key:"_renderOrderIndependentTransparency",value:function(e,t){var n=this,r=function(r){n._bindParameters.transparencyPassType=r,n._offscreen.renderOITPass((function(){return e()}),r,t)},i=this._renderContext.output;this._renderContext.output=li.H.Alpha,r(nw.A.Alpha),this._renderContext.output=li.H.Color,r(nw.A.Color),r(nw.A.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,t),this._bindParameters.transparencyPassType=nw.A.NONE,this._renderContext.output=i,this._oitUsed=!0}},{key:"_disposeOITBuffers",value:function(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget)),this._oitUsed=!1}},{key:"_renderOccluded",value:function(){var e=this,t=0;BT.clear(),this._materialRenderers.forAll((function(e){e.material&&e.material.isVisible()&&e.material.renderOccluded===km.yD.OccludeAndTransparentStencil&&(t|=e.material.renderOccluded,BT.push(e))}));var n=this._offscreen,r=function(r,i,a,o,s){0!=(t&i)&&(n.renderToTargets(a,n.tmpColor,n.mainDepth,[0,0,0,0],o,s),n.compositeOccludedOntoMain(e._bindParameters,r))};0!==BT.length&&(this._renderInternalSlot(ci.r.OCCLUDER_MATERIAL,BT),r(.5,km.yD.OccludeAndTransparentStencil,(function(){return e._renderInternalSlot(ci.r.TRANSPARENT_OCCLUDER_MATERIAL,BT)}),!1,!1)),BT.clear(),this._materialRenderers.forAll((function(e){e.material&&e.material.isVisible()&&(e.material.renderOccluded===km.yD.OccludeAndTransparent||e.material.renderOccluded===km.yD.Transparent||e.material.renderOccluded===km.yD.Opaque)&&(t|=e.material.renderOccluded,BT.push(e))}));var i=this._renderPlugins.renderOccludedFlags;if(t|=i){var a=function(t){e._renderContext.renderOccludedMask=t,i>km.yD.Occlude&&e._renderSlot(ci.r.OCCLUDED_TERRAIN),e._renderInternalSlot(ci.r.OPAQUE_MATERIAL,BT),e._renderInternalSlot(ci.r.TRANSPARENT_MATERIAL,BT),e._renderInternalSlot(ci.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,BT),e._renderContext.resetRenderOccludedMask()};this._renderContext.output=li.H.Color,r(.5,km.yD.OccludeAndTransparent,(function(){return a(km.yD.OccludeAndTransparent)}),!0,bv.hU.OutlineVisualElementMask),r(.5,km.yD.Transparent,(function(){return a(km.yD.Transparent)}),!0,bv.hU.OutlineVisualElementMask),r(1,km.yD.Opaque,(function(){return a(km.yD.Opaque)}),!0,bv.hU.OutlineVisualElementMask),BT.clear()}}},{key:"_renderAntiAliasing",value:function(e){var t=this;if(this._antialiasing){if(this._smaaPass.enable((function(){return t._requestRender()}))&&(0,k.pC)(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1}},{key:"_prepare",value:function(e,t){this._needsTransparentPass=this._materialRenderers.some((function(e){return e.requiresSlot(ci.r.TRANSPARENT_MATERIAL,li.H.Color)})),this._bindParameters.camera=e,this._bindParameters.contentCamera=t}},{key:"_ensureBindParameters",value:function(e,t){var n;this._bindParameters.camera=e,this._bindParameters.contentCamera=t;var r=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=r.hudVisibilityTexture,this._bindParameters.mainColorTexture=r.mainColorTexture,this._bindParameters.highlightDepthTexture=null!==(n=r.depthTexture)&&void 0!==n?n:this._getFallbackDepthTexture()}},{key:"_ensureBindParametersSSR",value:function(e){if(this._bindParameters.ssr.enabled=this.hasWaterReflection,this._bindParameters.ssr.enabled){(0,k.Wi)(this._waterReflectionEnableTime)&&(this._waterReflectionEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Cn.I:((0,wn.a)(WT,this._bindParameters.camera.viewMatrix),(0,wn.a)(GT,this._bindParameters.camera.projectionMatrix),(0,wn.m)(jT,WT,GT),(0,wn.m)(jT,this._renderContext.lastFrameCamera.viewMatrix,jT),(0,wn.m)(jT,this._renderContext.lastFrameCamera.projectionMatrix,jT),this._reprojectionMatrix=jT),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;var t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._waterReflectionEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._bindParameters.ssr.lastFrameColorTexture=null,this._waterReflectionEnableTime=null}},{key:"_renderInternalSlot",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._materialRenderers,r=!1;return this._bindParameters.slot=e,n.forAll((function(e){e.material.shouldRender(t._renderContext)&&e.render(t._renderContext.output,t._bindParameters)&&(r=!0)})),r}},{key:"_getFallbackDepthTexture",value:function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=(0,dn.hf)(this._rctx)),this._fallbackDepthStencilTexture}},{key:"gpuMemoryUsage",get:function(){var e,t,n,r,i,a,o,s,l,u;return{offscreen:null!==(e=null===(t=this._offscreen)||void 0===t?void 0:t.gpuMemoryUsage)&&void 0!==e?e:0,highlights:(null!==(n=null===(r=this._highlight)||void 0===r?void 0:r.gpuMemoryUsage)&&void 0!==n?n:0)+(null!==(i=null===(a=this._shadowHighlight)||void 0===a?void 0:a.gpuMemoryUsage)&&void 0!==i?i:0),shadows:null!==(o=null===(s=this._shadowMap)||void 0===s?void 0:s.gpuMemoryUsage)&&void 0!==o?o:0,ssao:null!==(l=null===(u=this._ssaoHelper)||void 0===u?void 0:u.gpuMemoryUsage)&&void 0!==l?l:0}}},{key:"test",get:function(){var e=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:function(){e._renderStateFeatures=(0,ui.n)()},getFramebufferTexture:function(t){switch(t){case UT.Color:return e._offscreen.colorTexture;case UT.LinearDepth:return e._offscreen.linearDepthTexture;case UT.Normals:return e._offscreen.normalTexture;case UT.ShadowMap:return e._shadowMap.depthTexture;case UT.HudVisibility:return e._offscreen.hudVisibilityTexture;case UT.Highlight:return e._offscreen.highlightTexture}}}}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],zT.prototype,"_shadowAccumulator",void 0),(0,p._)([(0,Z.Cb)()],zT.prototype,"_state",void 0),(0,p._)([(0,Z.Cb)()],zT.prototype,"_renderStateFeatures",void 0),(0,p._)([(0,Z.Cb)()],zT.prototype,"_antialiasingEnabled",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],zT.prototype,"_antialiasing",null),(0,p._)([(0,Z.Cb)()],zT.prototype,"_ssaoEnabled",void 0),(0,p._)([(0,Z.Cb)()],zT.prototype,"_smaaPass",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],zT.prototype,"_edgeView",void 0),(0,p._)([(0,Z.Cb)()],zT.prototype,"updating",null),(0,p._)([(0,Z.Cb)()],zT.prototype,"isCameraFinal",null),zT=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.lib.Renderer")],zT),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(UT||(UT={}));var BT=new Qd.Z,GT=(0,Cn.c)(),WT=(0,Cn.c)(),jT=(0,Cn.c)(),qT=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this,e,r)).newCache=i,a._refCount=1,a}return(0,l.Z)(n,[{key:"destroy",value:function(){--this._refCount>0||this.dispose()}},{key:"ref",value:function(){++this._refCount}},{key:"bindTechnique",value:function(e,t,n,r){return this.useProgram(e.program),e.bindPipelineState(this,null===n||void 0===n?void 0:n.slot,!!r),e.program.bindPass(t,n),e.program}},{key:"test",get:function(){return this.programCache.test}}]),n}(n(86401).x),YT=n(5195),XT=n(25049),QT=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e,r,i){var a;return(0,s.Z)(this,n),(a=t.call(this,{}))._stage=e,a._techniqueRepository=r,a._rctx=i,a._textures=new Map,a._loadingCount=0,a._frameUpdates=new Map,a.events=new $.Z,a._frameTask=e.view.resourceController.scheduler.registerTask(Dn.T8.TEXTURE_UNLOAD),a}return(0,l.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"destroy",value:function(){this._frameTask.remove(),this._stage.forEachOfType($g.U.Texture,(function(e){return e.unload()}))}},{key:"updating",get:function(){return this._loadingCount>0||this._frameTask.updating}},{key:"textureTechnique",get:function(){return(0,k.Wi)(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(YT.K,new XT.V)),this._textureTechnique}},{key:"acquire",value:function(e){var t=this._textures.get(e);return t?(t.ref(),(0,k.Pt)(t.loadingPromise,t)):this._createNewRef(e)}},{key:"update",value:function(){var e=this,t=!1;this._frameUpdates.forEach((function(n){var r=n.texture.frameUpdate(e._rctx,e.textureTechnique,n.previousToken);r>=0&&r!==n.previousToken&&(n.previousToken=r,t=!0)})),t&&this.events.emit("changed",bv.Xx.BACKGROUND)}},{key:"_createNewRef",value:function(e){var t=this,n=this._stage.getObject(e);if((0,k.Wi)(n))return(0,wr.hu)(void 0!==n),null;var r=n.events.on("unloaded",(function(){r.remove(),t._onTextureUnloaded(e)})),i=new JT(e,(function(){t._frameTask.schedule((function(){i.isUnreferenced&&n.unload()}))}));return this._textures.set(e,i),i.ref(),(0,k.pC)(n.glTexture)?(this._updateGLTexture(i,n.glTexture),n.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:n,previousToken:-1}),i):(this._loadingCount++,i.loadingPromise=this._stage.schedule((function(){var r=n.load(t._rctx,(function(){return t.textureTechnique})),a=function(r){return t._loadingCount--,i.loadingPromise=null,t._updateGLTexture(i,r),n.requiresFrameUpdates&&t._frameUpdates.set(e,{texture:n,previousToken:-1}),i};return(0,R.y8)(r)?r.then(a,(function(e){return t._loadingCount--,i.loadingPromise=null,(0,R.D_)(e)||S.Z.getLogger(t.declaredClass).error(e),null})):a(r)})),i.loadingPromise)}},{key:"_updateGLTexture",value:function(e,t){e.glTexture=t,this.events.emit("changed",bv.Xx.UPDATE)}},{key:"_onTextureUnloaded",value:function(e){this._textures.delete(e),this._frameUpdates.delete(e)}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],QT.prototype,"_loadingCount",void 0),(0,p._)([(0,Z.Cb)()],QT.prototype,"_frameTask",void 0),(0,p._)([(0,Z.Cb)()],QT.prototype,"updating",null),QT=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.lib.TextureRepository")],QT);var JT=function(){function e(t,n){(0,s.Z)(this,e),this.id=t,this._release=n,this._refCount=0}return(0,l.Z)(e,[{key:"isUnreferenced",get:function(){return 0===this._refCount}},{key:"ref",value:function(){++this._refCount}},{key:"release",value:function(){--this._refCount,this._refCount>0||(0!==this._refCount?(S.Z.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}]),e}(),KT=n(82031),$T=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){var e;return(0,s.Z)(this,n),(e=t.apply(this,arguments))._passParameters=new eS,e._loading=0,e}return(0,l.Z)(n,[{key:"passParameters",get:function(){return this._passParameters}},{key:"destroy",value:function(){this._passParameters.waveNormal=(0,k.M2)(this._passParameters.waveNormal),this._passParameters.wavePertubation=(0,k.M2)(this._passParameters.wavePertubation)}},{key:"updating",get:function(){return this._loading>0}},{key:"ensureResources",value:function(e){var t=this;if(this._loading>0)return bv.Rw.LOADING;if((0,k.pC)(this._passParameters.waveNormal)&&(0,k.pC)(this._passParameters.wavePertubation))return bv.Rw.LOADED;var n={target:an.No.TEXTURE_2D,pixelFormat:an.VI.RGBA,dataType:an.Br.UNSIGNED_BYTE,wrapMode:an.e8.REPEAT,samplingMode:an.cw.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8};return++this._loading,(0,mC.t)((0,Nr.V)("esri/images/materials/water/normals.jpg")).then((function(i){return t._passParameters.waveNormal=new rr.x(e,(0,r.Z)((0,r.Z)({},n),{},{width:i.width,height:i.height}),i)})).catch((function(e){return S.Z.getLogger(t.declaredClass).error("Failed to load water material normal texture.",e)})).finally((function(){return--t._loading})),++this._loading,(0,mC.t)((0,Nr.V)("esri/images/materials/water/perturbation.jpg")).then((function(i){return t._passParameters.wavePertubation=new rr.x(e,(0,r.Z)((0,r.Z)({},n),{},{width:i.width,height:i.height}),i)})).catch((function(e){return S.Z.getLogger(t.declaredClass).error("Failed to load water material pertubation texture.",e)})).finally((function(){return--t._loading})),bv.Rw.LOADING}}]),n}(J.Z);(0,p._)([(0,Z.Cb)()],$T.prototype,"_loading",void 0),(0,p._)([(0,Z.Cb)({type:Boolean,readOnly:!0})],$T.prototype,"updating",null),$T=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],$T);var eS=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(){return(0,s.Z)(this,n),t.apply(this,arguments)}return(0,l.Z)(n)}($t.K),tS=new Map;function nS(){return tS}var rS=n(7796),iS=n(51e3),aS=(0,l.Z)((function e(t,n){(0,s.Z)(this,e),this.viewCamera=t,this.frameHasDecorations=n})),oS=function(){function e(t,n,r,i){(0,s.Z)(this,e),this._rctx=t,this._renderFunctions=n,this._forceCameraHook=r,this._disposeOffscreenBuffers=i,this.supersample=!0,this._screenshotQueue=new Array}return(0,l.Z)(e,[{key:"destroy",value:function(){this._rctx=null}},{key:"takeScreenshot",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._renderFunctions.prepareOverlay();case 2:return this._renderFunctions.requestRenderScene(bv.Xx.BACKGROUND),n=(0,R.hh)(),e.abrupt("return",(this._screenshotQueue.push({settings:t,resolver:n}),n.promise));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(e,t){var n,a=(0,i.Z)(this._screenshotQueue);try{for(a.s();!(n=a.n()).done;){var o=n.value;if(null!=this._rctx){var s=(0,r.Z)((0,r.Z)({},o.settings),{},{pixelRatio:o.settings.pixelRatio*e.viewCamera.pixelRatio}),l=this._renderScreenshot(e,s,t);o.resolver(l)}else o.resolver.reject()}}catch(u){a.e(u)}finally{a.f()}this._screenshotQueue.length=0}},{key:"_renderScreenshotOverlay",value:function(e,t,n){e.width=t.width,e.height=t.height;var r=e.getContext("2d"),i=n.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),n.region&&r.translate(-n.region.x,-n.region.y),r.scale(i,i),t=this._renderFunctions.renderOverlay(e,t),r.restore(),t}},{key:"_readbackScreenshot",value:function(e,t){return e.resample?this._readbackScreenshotResampled((0,r.Z)((0,r.Z)({},e),{},{resample:e.resample}),t):this._readbackScreenshotImmediate(e,t)}},{key:"_readbackScreenshotResampled",value:function(e,t){var n=e.framebufferWidth,i=e.framebufferHeight,a=e.region,o=e.resample,s=this._ensureScreenshotEncodeCanvas(),l=(0,iS.r)(n,i,s);this._rctx.gl.readPixels(0,0,n,i,an.VI.RGBA,an.g.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(s,l,(0,r.Z)((0,r.Z)({},e),{},{region:void 0}));var u=(0,iS.r)(a.width,a.height,s);return(0,rS.TT)(l,u,!0,o.region.x,i-(o.region.y+o.region.height),o.region.width,o.region.height)}},{key:"_readbackScreenshotImmediate",value:function(e,t){var n=e.framebufferHeight,r=e.region,i=this._ensureScreenshotEncodeCanvas(),a=(0,iS.r)(r.width,r.height,i);return this._rctx.gl.readPixels(r.x,n-(r.y+r.height),r.width,r.height,an.VI.RGBA,an.g.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(i,a,e)}},{key:"_renderScreenshot",value:function(e,t,n){var r=this,i=null,a=null,o=e.viewCamera,s=t.framebufferWidth,l=t.framebufferHeight,u=!1,c=t.disableDecorations&&e.frameHasDecorations,h=s!==o.fullWidth||l!==o.fullHeight,d=t.ignorePadding&&o.pixelRatio!==t.pixelRatio,f=h||c||d||t.objectAndLayerIdColor;if(t.objectAndLayerIdColor&&(a=new Mn.X(this._rctx,{width:s,height:l,colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.DEPTH_STENCIL_RENDER_BUFFER})),f){var p=o.clone();if(t.ignorePadding){for(var v=(0,Wt.d)(p.padding),m=0;m<4;m++)v[m]=Math.round(v[m]/p.pixelRatio*t.pixelRatio);p.padding=v}p.fullWidth=s,p.fullHeight=l,p.pixelRatio=t.pixelRatio;var _=o.fovX-p.fovX,y=o.fovY-p.fovY;_<0&&_<y?p.fovX=o.fovX:y<0&&y<_&&(p.fovY=o.fovY),this._forceCameraHook(p),u=!0,i=new Mn.X(this._rctx,{width:p.fullWidth,height:p.fullHeight,colorTarget:an.Lm.TEXTURE,depthStencilTarget:an.OU.DEPTH_STENCIL_RENDER_BUFFER}),this._renderFunctions.renderScene(i,a,p,t.disableDecorations?bv.Iq.OFF:bv.Iq.ON,n),this._disposeOffscreenBuffers()}var g=function(){r._rctx.bindFramebuffer(null),(0,k.M2)(i)},b=this._readbackScreenshot(t,g);g();var w=null;if(t.objectAndLayerIdColor){var C=function(){r._rctx.bindFramebuffer(null),(0,k.M2)(a)};this._rctx.bindFramebuffer(a),w=this._readbackScreenshot(t,C),this._rctx.bindFramebuffer(null),C()}if(f&&!this._rctx.contextAttributes.alpha)for(var x=3;x<b.data.length;x+=4)b.data[x]=255;if(w&&!this._rctx.contextAttributes.alpha)for(var T=3;T<w.data.length;T+=4)w.data[T]=255;return u&&this._forceCameraHook(o),[b,w]}},{key:"_ensureScreenshotEncodeCanvas",value:function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}]),e}(),sS=!1,lS=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;(0,s.Z)(this,n),(r=t.call(this,{})).events=new $.Z,r.waterTextureRepository=new $T,r._magnifierHelper=new AC,r.objectAndLayerIdRenderHelper=(0,x.Z)("enable-feature:objectAndLayerId-rendering")?new OC:null,r._needsUpdate=!0,r._needsRender=!0,r._idleSuspend=!0,r._needsWaterReflectionUpdate=!1,r._lastAnimationUpdate=0,r._container=e.container,r._viewingMode=e.viewingMode,r._initializeContext(e),(0,A.YP)((function(){var e;return null===(e=r.waterTextureRepository)||void 0===e?void 0:e.updating}),(function(){return r.requestRender()}),A.nn),r._magnifierHelper.events.on("request-render",(function(){return r.requestRender()})),r._stippleTextureRepository=new KT.h0(r._rctx),r._shaderTechniqueRepository=new Uw.M({rctx:r._rctx,viewingMode:e.viewingMode,stippleTextureRepository:r._stippleTextureRepository,waterTextureRepository:r.waterTextureRepository}),r._textureRepository=new QT(e,r._shaderTechniqueRepository,r._rctx),r._textureRepository.events.on("changed",(function(e){return r.requestRender(e)})),r._materialRepository=new vC.h(r._textureRepository,r._shaderTechniqueRepository,(function(){return r.requestRender()}),(function(){return r.requestRender()})),r._compositingHelper=new Xw(r._rctx,r._shaderTechniqueRepository),r.renderer=new zT(e,r._materialRepository,r._textureRepository,r._shaderTechniqueRepository,r._rctx,r._compositingHelper,r._magnifierHelper,(function(e){return r.requestRender(e)}));var i={renderScene:function(e,t,n,i,a){return r.renderer.render(e,t,{camera:n,contentCamera:n,mode:Xr.n.IDLE},i,a)},requestRenderScene:function(e){return r.requestRender(e)},prepareOverlay:function(){return e.options.screenshot.prepareOverlay()},renderOverlay:function(t,n){return e.options.screenshot.renderOverlay(t,n)}};return r._screenshotManager=new oS(r._rctx,i,(function(e){return r.events.emit("force-camera-for-screenshot",e)}),(function(){return r.renderer.disposeOffscreenBuffers()})),r._registerFrameTask(e),r}return(0,l.Z)(n,[{key:"normalizeCtorArgs",value:function(){return{}}},{key:"destroy",value:function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=(0,k.hw)(this._frameTask),this._shaderTechniqueRepository=(0,k.SC)(this._shaderTechniqueRepository)}},{key:"performanceInfo",get:function(){var e=this._rctx.gl;return{renderer:this.renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}},{key:"requestRender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bv.Xx.UPDATE;this._needsRender=!0,e===bv.Xx.UPDATE&&(this._needsUpdate=!0)}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(e){this._magnifierHelper.magnifier=e}},{key:"setIdleSuspend",value:function(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"takeScreenshot",value:function(e){return this._screenshotManager.takeScreenshot(e).then((function(e){return e[0]}))}},{key:"takeScreenshotWithOID",value:function(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}},{key:"getAlpha",value:function(){return!!this._rctx.contextAttributes.alpha}},{key:"getMinimalDepthForArea",value:function(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:i,o=r.constrainWindowSize(t,n,i*r.pixelRatio,a*r.pixelRatio),s=this._ensureDepthBuffer(o);this.renderer.readDepthPixels(r,o,s);for(var l=Number.MAX_VALUE,u=0;u<o[2]*o[3];u++){var c=Kw(4*u,s,r.nearFar);l>c&&c!==r.nearFar[0]&&c!==r.nearFar[1]&&(l=c)}if((0,k.pC)(e)){var h=e.pickDepth(t*r.pixelRatio,n*r.pixelRatio,r);(0,k.pC)(h)&&l>h&&h!==r.nearFar[0]&&h!==r.nearFar[1]&&(l=h)}return l===Number.MAX_VALUE?void 0:l}},{key:"_ensureDepthBuffer",value:function(e){var t=4*e[2]*e[3];return((0,k.Wi)(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}},{key:"reloadShaders",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Rm(),e.next=3,this._shaderTechniqueRepository.reloadAll();case 3:this.requestRender();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_registerFrameTask",value:function(e){var t=this,n=e.view.state,r=!1,i=bv.Xx.BACKGROUND,a=!1,o={preRender:function(a){var o=a.time;r=t.updating,i=t._needsUpdate?bv.Xx.UPDATE:bv.Xx.BACKGROUND,e.commitSyncLayers();var s=(0,lr.HA)(o-t._lastAnimationUpdate);if(s>t.renderer.animationTimestep||(0,k.pC)(n.forcedAnimationTime)||r||t._needsRender){var l=(0,lr.HA)(s/t.renderer.animationTimeDilation),u=new km._o(n.camera,l,n.forcedAnimationTime);t.renderer.updateAnimation(u)&&t.requestRender(bv.Xx.BACKGROUND),t._lastAnimationUpdate=o}},render:function(e){var r=e.time;if((t._needsRender||!t._idleSuspend||!t.renderer.isCameraFinal||t._needsWaterReflectionUpdate)&&n.camera.fullWidth>0&&n.camera.fullHeight>0){var i=t._needsUpdate&&t._idleSuspend&&t.renderer.isCameraFinal;t._needsRender=!1,t._needsUpdate=!1,t._needsWaterReflectionUpdate=!1,t.renderer.render(null,null,n,bv.Iq.ON,r),a=!0,i&&t.renderer.hasWaterReflection&&(t.requestRender(bv.Xx.BACKGROUND),t._needsWaterReflectionUpdate=!0)}},update:function(e){var r=e.time,i=new aS(n.camera,t.renderer.hasSlicePlane||t._magnifierHelper.enabled);t._textureRepository.update(),t._screenshotManager.update(i,r)},finish:function(){a&&(t.renderer.finish(n.mode===Xr.n.IDLE?i:bv.Xx.UPDATE),a=!1)}};this._frameTask=(0,E.A)(o)}},{key:"_initializeContext",value:function(e){var t,n=e.options;this._canvas=n.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var r={alpha:n.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==n.stencil||n.stencil,powerPreference:"high-performance",preserveDrawingBuffer:null!==(t=n.preserveDrawingBuffer)&&void 0!==t&&t},i=(0,I_.sj)("3d",this._canvas,r);if((0,k.Wi)(i)){var a=(0,x.Z)("esri-force-webgl");S.Z.getLogger(this.declaredClass).error(a)}else this._rctx=this._newRenderingContext(i,e),this._loadShaderOnlyExtensions(),!n.alpha&&this._rctx.contextAttributes.alpha&&S.Z.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&(0,x.Z)("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}},{key:"_newRenderingContext",value:function(e,t){var n={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},r=function(e,n){return t.view.resourceController.memoryController.newCache(e,n)};if(sS){var i=uS.get(e);return i?(i.configure(n),i.newCache=r,i.ref(),i):(i=new qT(e,n,r),uS.set(e,i),i.ref(),i)}return new qT(e,n,r)}},{key:"_loadShaderOnlyExtensions",value:function(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}},{key:"getObjectAndLayerIdColor",value:function(e){return(0,k.pC)(this.objectAndLayerIdRenderHelper)?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}},{key:"componentObjectCollection",get:function(){return(0,k.Wi)(this._componentObjectCollection)&&(this._componentObjectCollection=new Mw(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection},set:function(e){this._componentObjectCollection=e}}]),n}(J.Z);(0,p._)([(0,Z.Cb)({type:Boolean,readOnly:!0})],lS.prototype,"updating",null),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_rctx",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_container",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_canvas",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_stippleTextureRepository",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"waterTextureRepository",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_magnifierHelper",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],lS.prototype,"objectAndLayerIdRenderHelper",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_textureRepository",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_compositingHelper",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0,readOnly:!0})],lS.prototype,"renderer",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_screenshotManager",void 0),(0,p._)([(0,Z.Cb)()],lS.prototype,"componentObjectCollection",null),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],lS.prototype,"_componentObjectCollection",void 0),(0,p._)([(0,Z.Cb)()],lS.prototype,"_needsUpdate",void 0),(0,p._)([(0,Z.Cb)()],lS.prototype,"_needsWaterReflectionUpdate",void 0),lS=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.parts.RenderView")],lS);var uS=nS(),cS=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e))._handles=new K.Z,r._model=new sb,r._layers=new Qd.Z,r._asyncChangeSet=new Qg.as,r._syncChangeSet=new Qg.as,r._layerSyncSet=new Set,r}return(0,l.Z)(n,[{key:"initialize",value:function(){this._set("renderView",new lS(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(Dn.T8.STAGE,this),this._handles.add(this._frameTask)}},{key:"destroy",value:function(){this._handles.destroy()}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"updating",get:function(){return this.running||this.renderView.updating||this._frameTask.updating}},{key:"renderer",get:function(){var e;return null===(e=this.renderView)||void 0===e?void 0:e.renderer}},{key:"add",value:function(e){this._model.add(e),(0,Kg.e)(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}},{key:"remove",value:function(e){(0,k.Wi)(e)||(this.renderView.requestRender(),this._model.remove(e),(0,Kg.e)(e)&&(this._removeLayer(e),e.detachStage()))}},{key:"addMany",value:function(e){(0,k.pC)(e)&&(this._model.addMany(e),this.renderView.requestRender())}},{key:"removeMany",value:function(e){(0,k.pC)(e)&&(this._model.removeMany(e),this.renderView.requestRender())}},{key:"load",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=(0,k.Wi)(t),e.t0){e.next=5;break}return Array.isArray(t)||(t=[t]),e.next=5,Promise.all(t.filter((function(e){return(0,k.Wi)(e.glTexture)})).map((function(e){return r.schedule((function(){return r._model.has(e)?e.load(r.renderView.renderingContext,(function(){return r.renderView.textureRepository.textureTechnique})):null}))}),n));case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"loadImmediate",value:function(e){var t=this;return e.load(this.renderView.renderingContext,(function(){return t.renderView.textureRepository.textureTechnique}))}},{key:"forEachOfType",value:function(e,t){this._model.forEachOfType(e,t)}},{key:"handleEvent",value:function(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}},{key:"running",get:function(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}},{key:"runTask",value:function(e){this._frameTask.processQueue(e),this._commit(e)}},{key:"_commit",value:function(e){var t=this,n=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((function(r){if(!e.done){var i=t._layerSyncSet.has(r.id)||r.updatePolicy===Jg.j.SYNC,a=i?t._syncChangeSet:t._asyncChangeSet;n.commitLayer(r.id,a),t._layerSyncSet.delete(r.id),a.empty||(t.renderer.modify(a,i?Dn.G5:e),t.renderView.requestRender(),e.madeProgress())}})),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Dn.G5),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((function(r){e.done||t._layerSyncSet.has(r.id)||r.updatePolicy!==Jg.j.ASYNC||(n.commitLayer(r.id,t._asyncChangeSet),t._asyncChangeSet.empty||(t.renderer.modify(t._asyncChangeSet,e),t.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}},{key:"commitSyncLayers",value:function(){var e=this,t=this._model.dirtySet;this._layers.forAll((function(n){(e._layerSyncSet.has(n.id)||n.updatePolicy===Jg.j.SYNC)&&(t.commitLayer(n.id,e._syncChangeSet),e._layerSyncSet.delete(n.id))}));var n,r=(0,i.Z)(this._layerSyncSet);try{for(r.s();!(n=r.n()).done;){var a=n.value;t.commitLayer(a,this._syncChangeSet)}}catch(o){r.e(o)}finally{r.f()}this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Dn.G5),this.renderView.requestRender())}},{key:"_commitLayer",value:function(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Dn.G5),this.renderView.requestRender())}},{key:"schedule",value:function(e,t){return this._frameTask.schedule(e,t)}},{key:"reschedule",value:function(e,t){return this._frameTask.reschedule(e,t)}},{key:"syncLayer",value:function(e){this._layerSyncSet.add(e),this.renderView.requestRender()}},{key:"getObject",value:function(e){return this._model.getObject(e)}},{key:"layers",get:function(){return this._layers}},{key:"_addLayer",value:function(e){this._layers.includes(e)||this._layers.push(e)}},{key:"_removeLayer",value:function(e){this._commitLayer(e),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Dn.G5))}},{key:"addRenderPlugin",value:function(e,t,n){var r=this,i=this.renderer.renderPlugins.add(e,t,n),a=function(){Ap(t)&&r.view.sceneIntersectionHelper.addIntersectionHandler(t)};if((0,R.y8)(i))return i.then(a);a()}},{key:"removeRenderPlugin",value:function(e){Ap(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.renderPlugins.remove(e)}},{key:"performanceInfo",get:function(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}},{key:"test",get:function(){var e=this;return{getCount:function(t){return e._model.test.content.filter((function(e){return e.type===t})).length},model:e._model}}}]),n}(J.Z);cS.DebugSettings={endFrameContentValidation:!1},(0,p._)([(0,Z.Cb)({constructOnly:!0})],cS.prototype,"view",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],cS.prototype,"options",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],cS.prototype,"viewingMode",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],cS.prototype,"container",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],cS.prototype,"_handles",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],cS.prototype,"updating",null),(0,p._)([(0,Z.Cb)({constructOnly:!0})],cS.prototype,"_model",void 0),(0,p._)([(0,Z.Cb)({autoDestroy:!0})],cS.prototype,"renderView",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],cS.prototype,"renderer",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],cS.prototype,"running",null),cS=(0,p._)([(0,L.j)("esri.views.3d.webgl-engine.Stage")],cS);var hS=n(41781),dS=n(74923),fS=n(69787),pS=n(72612),vS=n(87770),mS=function(e){(0,d.Z)(n,e);var t=(0,f.Z)(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this,e)).components=["attribution","zoom","navigation-toggle","compass"],r}return(0,l.Z)(n)}(n(41356).Z);(0,p._)([(0,Z.Cb)()],mS.prototype,"components",void 0);var _S,yS=mS=(0,p._)([(0,L.j)("esri.views.ui.3d.DefaultUI3D")],mS),gS=function(e){(0,d.Z)(p,e);var t=(0,f.Z)(p);function p(e){var n;(0,s.Z)(this,p),(n=t.call(this,e))._userClippingArea=null,n._clippingArea=null,n._initialDefaultSpatialReference=null,n._defaults={},n._externallySet={environment:!1},n._createGraphicsViewController=null,n._lostWebGLContextHandle=null,n._resolveWhenReady=[],n._propertiesPool=new mh.L({slicePlane:B.B},(0,u.Z)(n)),n._resourceController=function(e){return new uv({view:e})}((0,u.Z)(n)),n._defaultToMapOptions={include:new Set},n._defaultHitTestOptions={exclude:new Set},n.deconflictor=new Lf({view:(0,u.Z)(n)}),n.labeler=new Ff.S({view:(0,u.Z)(n),deconflictor:n.deconflictor.labels}),n.sharedSymbolResources=null,n.analyses=new Y.J,n.basemapTerrain=null,n.elevationProvider=null,n.canvas=null,n.constraints=new Ne,n.environmentManager=new Gi,n.floors=new y.Z,n.fullOpacity=1,n.graphicsView=null,n.analysisViewManager=new Te({view:(0,u.Z)(n)}),n.groundView=null,n.map=null,n.screenSizePerspectiveEnabled=!0,n.state=new yp,n.spatialReference=null,n.alphaCompositingEnabled=!1,n.preserveDrawingBufferEnabled=!1,n.supersampleScreenshotsEnabled=!0,n.type="3d",n.ui=new yS,n._numUpdating=0,n._lastUpdateTime=0,n.updatingProgress=.5,n.highlightOptions=new Bp,n.voxelWasm=null,n.voxelWasmPromise=null,(0,M.j2)(),e&&e.environment||(n._defaults.environment=new Bt,n.environment=n._defaults.environment);var r=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(0,k.pC)(e)&&e.type===P.y.MOVE||(n._updatingChanged(),n.map&&n.map.allLayers.forEach(function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:n._updatingChanged();case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()))};return n.handles.add([(0,A.on)((function(){var e;return null===(e=n.map)||void 0===e?void 0:e.allLayers}),"after-changes",(function(e){return r(e)}),{onListenerAdd:function(){return r()},onListenerRemove:function(){return r()},sync:!0}),n.allLayerViews.on("after-changes",(function(e){return n._updateUpdatingMonitors(e)})),(0,A.YP)((function(){return n.map}),(function(e){e&&"load"in e&&e.load&&e.load().catch((function(){}))}))]),n.inputManager=new Yd({view:(0,u.Z)(n)}),n.stateManager=new _h({view:(0,u.Z)(n)}),n}return(0,l.Z)(p,[{key:"initialize",value:function(){var e=this;this.groundView=new se({view:this}),this._updateUpdatingMonitors();var t=function(){return e._updateDefaultToMapOptions()};this.handles.add((0,A.on)((function(){var t;return null===(t=e.map)||void 0===t?void 0:t.allLayers}),"after-changes",t,{onListenerAdd:t,onListenerRemove:t})),this.updatingHandles.add((function(){return e.qualitySettings.memoryLimit}),(function(t){e.resourceController&&(e.resourceController.memoryController.maxMemory=t)}),A.nn),this.updatingHandles.add((function(){return e.qualitySettings.additionalCacheMemory}),(function(t){e.resourceController&&(e.resourceController.memoryController.additionalCacheMemory=t)}),A.nn),this.updatingHandles.add((function(){var t;return null!==(t=e.qualitySettings.frameRate)&&void 0!==t?t:0}),(function(e){return(0,E.bP)(e>0?1e3/Math.ceil(e):0)}),A.nn),this.updatingHandles.add((function(){var t;return null===(t=e.map)||void 0===t?void 0:t.ground}),t,A.tX),this.updatingHandles.add((function(){var t,n;return null===(t=e.map)||void 0===t||null===(n=t.ground)||void 0===n?void 0:n.opacity}),(function(){return e._updateDefaultHitTestOptions()}),A.tX),this.handles.add((0,A.YP)((function(){return e.spatialReference}),(function(){return e.notifyChange("clippingArea")}),A.Z_))}},{key:"destroy",value:function(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=(0,k.SC)(this.sharedSymbolResources),this._set("labeler",(0,k.SC)(this.labeler)),this._set("deconflictor",(0,k.SC)(this.deconflictor)),this._resourceController=(0,k.SC)(this._resourceController),this._set("stateManager",(0,k.SC)(this.stateManager)),this._set("inputManager",(0,k.SC)(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this._set("environmentManager",(0,k.SC)(this.environmentManager)),this.groundView=(0,k.SC)(this.groundView))}},{key:"renderSpatialReference",get:function(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}},{key:"basemapSpatialReference",get:function(){var e;return null===(e=this.basemapTerrain)||void 0===e?void 0:e.spatialReference}},{key:"animation",get:function(){var e;return null===(e=this.state)||void 0===e?void 0:e.animation}},{key:"camera",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.camera},set:function(e){this.stateManager&&(this.stateManager.camera=e)}},{key:"contentCamera",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.contentCamera},set:function(e){this.stateManager&&(this.stateManager.contentCamera=e)}},{key:"installContentCameraReset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{sticky:!1};return this.stateManager.installContentCameraReset(e)}},{key:"center",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.center},set:function(e){this.stateManager&&(this.stateManager.center=e)}},{key:"clippingArea",get:function(){var e;if("global"===this.viewingMode)return null;var t=this._userClippingArea||("clippingArea"in this.map?null===(e=this.map)||void 0===e?void 0:e.clippingArea:void 0);return!this._userClippingArea&&!this.get("map.clippingEnabled")||(0,k.Wi)(t)?(this._clippingArea=null,null):t instanceof ou.Z?this.spatialReference&&(t=CS(t,this.spatialReference),(0,k.Wi)(t))?(S.Z.getLogger(this.declaredClass).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),(0,k.Wi)(t.intersection(this._groundAndLayersExtent))&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(S.Z.getLogger(this.declaredClass).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)},set:function(e){this.ready&&"global"===this.viewingMode&&(0,k.pC)(e)?S.Z.getLogger(this.declaredClass).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}},{key:"renderDataExtent",get:function(){if(this.state.viewingMode===he.JY.Global)return null;var e=this.renderSpatialReference,t=this.dataExtent;return(0,k.Wi)(t)||(0,k.Wi)(e)||t.spatialReference.equals(e)?t:CS(t,e)}},{key:"dataExtent",get:function(){var e=this._groundAndLayersExtent,t=this.spatialReference||ee.Z.WGS84,n=CS(this.clippingArea,t);(0,k.pC)(n)&&(e=(0,k.pC)(e)?e.intersection(n):n);var r=this._get("dataExtent");return(0,k.pC)(e)&&e.equals(r)?r:e}},{key:"_groundAndLayersExtent",get:function(){var e,t,n,r=this.spatialReference||ee.Z.WGS84,i=function(e){var t=CS(e,r);(0,k.Wi)(t)||((0,k.pC)(n)?n.union(t):n=t.clone())},a=this.basemapTerrain;if(null!==a&&void 0!==a&&a.spatialReference){var o=a.groundExtent;i(new ou.Z({xmin:o[0],ymin:o[1],zmin:0,xmax:o[2],ymax:o[3],zmax:0,spatialReference:a.spatialReference}))}if(this.map){this.map.allLayers.forEach((function(e){return function(e){!(0,k.pC)(e.fullExtent)||"graphics"===e.type&&e.internal||i(e.fullExtent)}(e)}))}if((0,k.Wi)(n))return null;n.hasZ?(n.zmin=Math.min(0,null!==(e=n.zmin)&&void 0!==e?e:0),n.zmax=Math.max(0,null!==(t=n.zmax)&&void 0!==t?t:0)):(n.zmin=0,n.zmax=0);var s=this._get("_groundAndLayersExtent");return n.equals(s)?s:n}},{key:"environment",set:function(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}},{key:"castEnvironment",value:function(e){return e?e instanceof Bt?e:e instanceof Vt?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):Bt.fromWebsceneEnvironment(e):(0,N.se)(Bt,e):new Bt}},{key:"extent",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.extent},set:function(e){this.stateManager&&(this.stateManager.extent=e)}},{key:"screenCenter",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.screenCenter}},{key:"frustum",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.frustum}},{key:"initialExtentRequired",get:function(){return this.stateManager&&!this.stateManager.hasInitialView}},{key:"_defaultsFromMapSettings",get:function(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}},{key:"interacting",get:function(){return this.navigating||(0,k.pC)(this.activeTool)&&this.activeTool.visible}},{key:"stationary",get:function(){return!this.animation&&!this.resizing&&((0,k.Wi)(this.state)||this.state.stationary)}},{key:"navigating",get:function(){var e,t;return null!==(e=null===(t=this.state)||void 0===t?void 0:t.navigating)&&void 0!==e&&e}},{key:"padding",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.padding},set:function(e){this.stateManager&&(this.stateManager.padding=e)}},{key:"qualityProfile",get:function(){return this._get("qualityProfile")||Np.getDefaultProfile()},set:function(e){Np.isValidProfile(e)&&(Np.apply(e,this.qualitySettings),this._set("qualityProfile",e))}},{key:"slicePlane",set:function(e){if((0,k.pC)(this._stage)&&this._stage.renderer.setParameters({slicePlane:e}),(0,k.Wi)(e))this._set("slicePlane",null);else{var t=this._propertiesPool.get("slicePlane");(0,B.c)(e,t),this._set("slicePlane",t)}}},{key:"typeSpecificPreconditionsReady",get:function(){return!!this.viewingMode}},{key:"resolution",get:function(){return null!=this.spatialReference?(0,W.dp)(this.scale,this.spatialReference):0}},{key:"scale",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.scale},set:function(e){this.stateManager&&(this.stateManager.scale=e)}},{key:"heightModelInfo",get:function(){var e=this.getDefaultHeightModelInfo();return null!=e?V.Z.deriveUnitFromSR(e,this.spatialReference):null}},{key:"updating",get:function(){var e,t,n;if(this.destroyed)return!1;var r=0,i=this.layerViewManager.updating,a=i?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((function(e){if(e.isFulfilled()){if(e.updating){if(i=!0,e.suspended||(0,hv.wP)(e))return;++a,r+=e.updatingProgress}}else++a}));for(var o=0,s=[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager];o<s.length;o++){var l=s[o];if((0,k.pC)(l)&&l.updating){a+=.1,r+=.05}}for(var u=0,c=[this.deconflictor,this.labeler,this.basemapTerrain];u<c.length;u++){var h=c[u];(0,k.pC)(h)&&h.updating&&(++a,r+=h.updatingProgress)}var d=this.stateManager.test.updatingIgnoreRenderState?Xr.n.IDLE:this.state.mode;if(i=!!(i||a>0||this.updatingHandles.updating||!this.ready||!this.stationary||d!==Xr.n.IDLE||this._createGraphicsViewController||null!==(e=this.inputManager)&&void 0!==e&&e.hasPendingInputs||null!==(t=this.map)&&void 0!==t&&null!==(n=t.allLayers)&&void 0!==n&&n.some((function(e){return!e.isFulfilled()}))),i?(this._numUpdating=Math.max(a,this._numUpdating),r+=this._numUpdating-a):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=i?0:1,this._get("updatingProgress")!==r){var f=performance.now();if(r<1){var p=Math.min((f-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-p)+r*p}this._set("updatingProgress",r),this._lastUpdateTime=i&&r<1?f:0}return i}},{key:"viewingMode",get:function(){var e,t=this._predeterminedViewingMode;if((0,k.pC)(t))return(0,he.M7)(t);var n=this.spatialReference;return n?(0,k.pC)(null===(e=this.defaultsFromMap)||void 0===e?void 0:e.viewingMode)&&n.equals(this.defaultsFromMap.spatialReference)?(0,he.M7)(this.defaultsFromMap.viewingMode):(0,qu.D)(n,he.JY.Global)?"global":"local":"global"},set:function(e){this.ready?S.Z.getLogger(this.declaredClass).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}},{key:"viewpoint",get:function(){var e;return null===(e=this.stateManager)||void 0===e?void 0:e.viewpoint},set:function(e){this.stateManager&&(this.stateManager.viewpoint=e)}},{key:"zoom",get:function(){return this.stateManager.zoom},set:function(e){this.stateManager&&(this.stateManager.zoom=e)}},{key:"resourceController",get:function(){return this._resourceController}},{key:"performanceInfo",get:function(){return new fv(this)}},{key:"on",value:function(e,t,n,r){return this.viewEvents.on(e,t,n,r)||(0,c.Z)((0,h.Z)(p.prototype),"on",this).call(this,e,t)}},{key:"hasEventListener",value:function(e){return(0,c.Z)((0,h.Z)(p.prototype),"hasEventListener",this).call(this,e)||this.viewEvents.hasHandler(e)}},{key:"toMap",value:function(e,t){if(!this.ready)return S.Z.getLogger(this.declaredClass).error("#toMap()","Scene view cannot be used before it is ready"),null;var n=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=(0,k.pC)(n.graphics)&&((0,k.pC)(n.graphics.include)||(0,k.pC)(n.graphics.exclude)),a=(0,pS.Rw)(e)?(0,pS.s6)(this,e):e,o=(0,O.md)(a);n.enableDraped=n.include&&!n.include.has(Gs.cy)||n.exclude&&n.exclude.has(Gs.cy);var s=this.sceneIntersectionHelper,l=(0,Pa.Z8)(this.state.viewingMode);if(l.options.selectionMode=!0,l.options.store=r?wp.eC.ALL:wp.eC.MIN,s.intersectIntersectorScreen(o,l,n),r){var u,c=(0,i.Z)(l.results.all);try{for(c.s();!(u=c.n()).done;){var h=u.value,d=(0,hS.bK)(h,this);if((0,k.Wi)(d))return this._intersectResultToMapPoint(h);if("graphic"!==d.type||this._testGraphicUidFilter(n.graphics,d.graphic))return this._intersectResultToMapPoint(h)}}catch(f){c.e(f)}finally{c.f()}return null}return this._intersectResultToMapPoint(l.results.min)}},{key:"toScreen",value:function(e){if(!this.ready)return S.Z.getLogger(this.declaredClass).error("#toScreen()","Scene view cannot be used before it is ready"),null;var t=(0,k.Pt)(null==e.z?(0,ju.KO)(this.elevationProvider,e):null,0);return(0,H.KC)(e,xS,this.renderSpatialReference,t),this.state.camera.projectToScreen(xS,TS),(0,O.vW)(TS[0],TS[1])}},{key:"pixelSizeAt",value:function(e){return this.ready?e?((0,H.KC)(e,xS,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(xS)):0:(S.Z.getLogger(this.declaredClass).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}},{key:"overlayPixelSizeInMapUnits",value:function(e){var t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}},{key:"hitTest",value:function(e,t){if(!this.ready)return S.Z.getLogger(this.declaredClass).error("#hitTest()","Scene view cannot be used before it is ready"),null;var n=(0,pS.Rw)(e)?(0,pS.s6)(this,e):e,r=(0,O.s1)(n.x,n.y),i=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;i.requiresGroundFeedback=!0,i.enableDraped=!0;var a=(0,Pa.Z8)(this.state.viewingMode);a.options.selectionMode=!0,a.options.store=wp.eC.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(r,a,i);var o=this._intersectResultsToHits(a.results.all,i.graphics),s=a.results.ground,l=(0,hS.J4)(s,this),u=(0,k.pC)(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,c={screenPoint:n,results:o,ground:{mapPoint:this._intersectResultToMapPoint(s),distance:(0,Cp.nn)(s)?s.distanceInRenderSpace:0,layer:u}};return Jd.Z.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(c.intersector=a),Promise.resolve(c)}},{key:"popupHitTest",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,dS.ZV)(this,t);case 2:return n=e.sent,r=n.results,i=n.ground,o=null,e.abrupt("return",(!(0===r.length||Math.abs((0,k.Pt)(r[0].distance,0)-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(o=i.mapPoint),{results:r,screenPoint:t,mapPoint:o}));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"goTo",value:function(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}},{key:"whenAnalysisView",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,k.Wi)(t.parent)){e.next=2;break}throw new b.Z("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});case 2:e.t0=t.parent.type,e.next="line-of-sight"===e.t0||"dimension"===e.t0?5:8;break;case 5:return e.next=7,this.whenLayerView(t.parent);case 7:return e.abrupt("return",e.sent.whenAnalysisView());case 8:return e.abrupt("return",this.analysisViewManager.whenAnalysisView(t));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"whenLayerView",value:function(e){return(0,c.Z)((0,h.Z)(p.prototype),"whenLayerView",this).call(this,e)}},{key:"takeScreenshot",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshot(n);case 5:return r=e.sent,e.abrupt("return",(0,rS.cv)(r,n,this._pixelFormat()));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_takeScreenshot",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshot(n);case 5:return r=e.sent,e.abrupt("return",(0,rS.v8)(r,this._pixelFormat()));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_takeScreenshotWithObjectAndLayerId",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._completeSettings(t),e.next=3,this.whenReady();case 3:return e.next=5,this._stage.renderView.takeScreenshotWithOID(n);case 5:return r=e.sent,e.abrupt("return",[(0,rS.v8)(r[0],this._pixelFormat()),(0,rS.v8)(r[1],this._pixelFormat())]);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_completeSettings",value:function(e){var t=(0,rS.uz)(e,this);return t.pixelRatio/=this.state.pixelRatio,(0,rS.$3)(t,this.supersampleScreenshotsEnabled,this.padding)}},{key:"_pixelFormat",value:function(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}},{key:"test",get:function(){var e=this;return{takeScreenshot:function(t){return e._takeScreenshot(t)},takeScreenshotWithObjectAndLayerId:function(t){return e._takeScreenshotWithObjectAndLayerId(t)}}}},{key:"takeScreenshotWithObjectAndLayerId",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var n,r,i,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,x.Z)("enable-feature:objectAndLayerId-rendering")){e.next=2;break}throw new Error("has enable-feature:objectAndLayerId-rendering must be true");case 2:return n=this._completeSettings(t),e.next=5,this.whenReady();case 5:return e.next=7,this._stage.renderView.takeScreenshotWithOID(n);case 7:return r=e.sent,i=(0,rS.cv)(r[0],n,this._pixelFormat()),(o=this._completeSettings(t)).format="png",e.abrupt("return",[i,(0,rS.cv)(r[1],o,this._pixelFormat())]);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getColorToObjectAndLayerIdMapping",value:function(){if((0,k.Wi)(this._stage.renderView.objectAndLayerIdRenderHelper))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}},{key:"addUpdatingPromise",value:function(e){return this.updatingHandles.addPromise(e)}},{key:"importLayerView",value:function(e){return ye(e)}},{key:"hasLayerViewModule",value:function(e){return _e(e)}},{key:"forceDOMReadyCycle",value:function(){this.forceReadyCycle()}},{key:"getDefaultSpatialReference",value:function(){var e,t,n,r;return this.map&&"initialViewProperties"in this.map&&(null===(e=this.map)||void 0===e||null===(t=e.initialViewProperties)||void 0===t?void 0:t.spatialReference)||(null===(n=this.defaultsFromMap)||void 0===n?void 0:n.spatialReference)||(null===(r=this.defaultsFromMap)||void 0===r?void 0:r.ready)&&this._initialDefaultSpatialReference||null}},{key:"validate",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){var t,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,vS.B)(this.type),(n=(0,x.Z)("safari"))&&n<9&&(t=new b.Z("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:n})),!(0,k.pC)(t)){e.next=4;break}throw S.Z.getLogger(this.declaredClass).warn("#validate()",t.message),t;case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_predeterminedViewingMode",get:function(){var e,t,n=this._isOverridden("viewingMode")?this._get("viewingMode"):null!==(e=this.map&&"initialViewProperties"in this.map?null===(t=this.map.initialViewProperties)||void 0===t?void 0:t.viewingMode:null)&&void 0!==e?e:null;return(0,k.pC)(n)?(0,he.wg)(n):null}},{key:"getSpatialReferenceSupport",value:function(e){var t=e.spatialReference,n=e.layer,r=this._predeterminedViewingMode;if((0,k.pC)(r))return this._validateSpatialReferenceForViewingMode(t,n,r)?{constraints:this._makeSpatialReferenceConstraints(t,n,r)}:null;var i=this._validateSpatialReferenceForViewingMode(t,n,he.JY.Local),a=this._validateSpatialReferenceForViewingMode(t,n,he.JY.Global);return i||a?i&&a?{constraints:this._makeSpatialReferenceConstraints(t,n,null)}:i?{constraints:this._makeSpatialReferenceConstraints(t,n,he.JY.Local)}:{constraints:this._makeSpatialReferenceConstraints(t,n,he.JY.Global)}:null}},{key:"_validateSpatialReferenceForViewingMode",value:function(e,t,n){return!!(0,qu.D)(e,n)&&(!!(0,k.Wi)(t)||!!(0,q.Am)(t)||(!(0,q.iC)(t)||!(0,k.Wi)((0,hv.E_)(t,e,n)))&&(!(0,q.Tv)(t)||n!==he.JY.Global))}},{key:"_makeSpatialReferenceConstraints",value:function(e,t,n){if((0,k.Wi)(t))return[{spatialReference:e,viewingMode:n}];var r=e.isWebMercator,i=e.isWGS84;return(0,q.Am)(t)&&(r||i)?i&&n!==he.JY.Local&&null!==(0,hv.er)(t.tileInfo,t.fullExtent,e,he.JY.Global)?[{spatialReference:r?ee.Z.WGS84:ee.Z.WebMercator,viewingMode:n}]:[{spatialReference:e,viewingMode:n},{spatialReference:ee.Z.WebMercator,viewingMode:n}]:(0,q.iC)(t)||(0,q.Tv)(t)||!r&&!i?(0,q.iC)(t)&&r&&n!==he.JY.Global?[{spatialReference:e,viewingMode:n},{spatialReference:ee.Z.WGS84,viewingMode:he.JY.Local}]:[{spatialReference:e,viewingMode:n}]:[{spatialReference:e,viewingMode:n},{spatialReference:r?ee.Z.WGS84:ee.Z.WebMercator,viewingMode:n}]}},{key:"_validateSpatialReference",value:function(e){var t=(0,k.pC)(this.getSpatialReferenceSupport({spatialReference:e})),n=this._predeterminedViewingMode;return t||((0,k.pC)(n)?S.Z.getLogger(this.declaredClass).warnOnce("Spatial reference defined on view not supported in ".concat((0,he.M7)(n)," viewing mode.")):e.isGeographic&&S.Z.getLogger(this.declaredClass).warnOnce("Spatial reference is geographic but not supported.")),t}},{key:"whenReady",value:function(){var e=this;return new Promise((function(t){e.ready?t(e):e._resolveWhenReady.push(t)}))}},{key:"computeMapPointFromVec3d",value:function(e,t){var n=this.spatialReference||ee.Z.WGS84;return(0,H.SH)(e,this.renderSpatialReference,e,n)||(n=ee.Z.WGS84,(0,H.SH)(e,this.renderSpatialReference,e,n)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=n):t=new _i.Z(e,n),t}},{key:"trackGraphicState",value:function(e){if(!e.graphic)return S.Z.getLogger(this.declaredClass).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;var t=this.getViewForGraphic(e.graphic),n=null,r=!1,i=function(t){var i;!r&&(0,k.pC)(t)&&"processor"in t&&"graphics-3d"===(null===(i=t.processor)||void 0===i?void 0:i.type)&&t.processor.graphicsCore&&(n=t.processor.graphicsCore.trackGraphicState(e))};return(0,k.pC)(t)?i(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((function(e){return i(e)}),(function(){})).catch((function(){})),{remove:function(){r=!0,(0,k.pC)(n)&&(n.remove(),n=null)}}}},{key:"highlight",value:function(e){var t=this;if(Array.isArray(e))return(0,C.AL)(e.map((function(e){return t.highlight(e)})));if(y.Z.isCollection(e))return(0,C.AL)(e.toArray().map((function(e){return t.highlight(e)})));var n=this.getViewForGraphic(e);return n&&"highlight"in n?n.highlight(e):(0,C.kB)()}},{key:"maskOccludee",value:function(e){if(!e)return S.Z.getLogger(this.declaredClass).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;var t=this.getViewForGraphic(e),n=null,r=!1,i=function(t){!r&&(0,k.pC)(t)&&(0,fS._1)(t)&&(n=t.maskOccludee(e))};return(0,k.pC)(t)?i(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((function(e){return i(e)}),(function(){})).catch((function(){})),{remove:function(){r=!0,(0,k.pC)(n)&&(n.remove(),n=null)}}}},{key:"getViewForGraphic",value:function(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((function(t){return t.layer===e.layer})):null}},{key:"graphicChanged",value:function(e){(0,k.pC)(this.graphicsView)&&this.graphicsView.graphicChanged(e)}},{key:"whenViewForGraphic",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t,n){var r=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.layer!==this){e.next=4;break}return e.next=3,(0,A.N1)((function(){return r.graphicsView}));case 3:return e.abrupt("return",this.graphicsView);case 4:if(t.layer&&this.map){e.next=6;break}throw new b.Z("no-view-for-graphic");case 6:return e.abrupt("return",n&&n.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((function(e,n){var i=r.map.allLayers.on("change",(function(a){a.added.includes(t.layer)&&(i.remove(),r.whenLayerView(t.layer).then(e,n))}))})):this.whenLayerView(t.layer));case 7:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"externalToInternalIntersectOptions",value:function(e){var t=this._externalToInternalRenderItems(e.include,_S.INCLUDE),n=this._externalToInternalRenderItems(e.exclude,_S.EXCLUDE);return{include:t.layerUids,exclude:n.layerUids,graphics:{include:t.graphicUids,exclude:n.graphicUids}}}},{key:"_intersectResultToMapPoint",value:function(e,t){return e.getIntersectionPoint(xS)?(t=this.computeMapPointFromVec3d(xS,t),e.intersector===wp.q7.TERRAIN&&this.basemapTerrain&&(t.z=(0,k.Pt)((0,ju.KO)(this.basemapTerrain,t),0)),t):null}},{key:"_intersectResultsToHits",value:function(e,t){for(var n=new Array,i=null,a=0;a<e.length;a++){var o=e[a],s=(0,hS.J4)(o,this);if((0,k.pC)(s)&&(s===this.map.ground||"type"in s&&"integrated-mesh"===s.type))break;var l=(0,hS.bK)(o,this);if(!(0,k.Wi)(l)){if("graphic"===l.type){if((0,k.Wi)(i)&&a!==e.length-1&&(i=new Set),(0,k.pC)(i)){var u=this._getGraphicFilterUid(l.graphic);if(i.has(u))continue;i.add(u)}if(!this._testGraphicUidFilter(t,l.graphic))continue}var c=this._intersectResultToMapPoint(o),h=o.distanceInRenderSpace;n.push((0,r.Z)((0,r.Z)({},l),{},{mapPoint:c,distance:h}))}}return n}},{key:"_getGraphicFilterUid",value:function(e){var t=e.sourceLayer,n=e.layer,r=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(r){var i,a,o=null!==(i=r.objectIdField)&&void 0!==i?i:j.d,s=null===(a=e.attributes)||void 0===a?void 0:a[o];if(s)return"o-".concat(r.id,"-").concat(s)}return"u-".concat(e.uid)}},{key:"_testGraphicUidFilter",value:function(e,t){var n=this._getGraphicFilterUid(t);return(0,k.Wi)(e)||((0,k.Wi)(e.include)||e.include.has(n))&&((0,k.Wi)(e.exclude)||!e.exclude.has(n))}},{key:"_externalToInternalRenderItems",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{layerUids:void 0,graphicUids:void 0};if(!e)return n;if(e instanceof m.Z)wS(n,this._getGraphicFilterUid(e)),t===_S.INCLUDE&&((0,k.pC)(this.graphicsView)&&e.layer===this?bS(n,this.graphicsView.processor.layer.id):e.layer&&bS(n,e.layer.uid));else if((0,T.TW)(e)){var r,a=(0,i.Z)(e);try{for(a.s();!(r=a.n()).done;){var o=r.value;o===this.graphics&&(0,k.pC)(this.graphicsView)?bS(n,this.graphicsView.processor.layer.id):o===this.map.ground?bS(n,Gs.cy):this._externalToInternalRenderItems(o,t,n)}}catch(s){a.e(s)}finally{a.f()}}else"uid"in e&&bS(n,e.uid);return n}},{key:"_initBasemapTerrain",value:function(){this._set("basemapTerrain",new Vg({view:this})),this._set("elevationProvider",new Zp({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}},{key:"_exitBasemapTerrain",value:function(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}},{key:"_initGlobe",value:function(){var e=this;this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new em({view:this})),this._set("featureTiles",new hp({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));var t=function(){var t,n=null===(t=e.basemapTerrain)||void 0===t?void 0:t.extent;if(e.clippingArea||n)if(n&&e.basemapTerrain.spatialReference){var r=(0,k.pC)(e.basemapTerrain.extent)&&(0,k.pC)(e.basemapTerrain.spatialReference)?(0,H.iV)((0,z.HH)(e.basemapTerrain.extent,e.basemapTerrain.spatialReference),e.spatialReference):null;(0,k.pC)(e.clippingArea)?e.featureTiles.filterExtent=e.clippingArea.intersection(r):e.featureTiles.filterExtent=r}else e.featureTiles.filterExtent=e.clippingArea;else e.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add((function(){return Jd.Z.FEATURE_TILE_TREE_SHOW_TILES}),(function(t){t&&e.featureTiles&&!e._featureTreeDebugger?e.updatingHandles.addPromise(n.e(76077).then(n.bind(n,76077))).then((function(t){var n=t.FeatureTileTree3DDebugger;!e._featureTreeDebugger&&Jd.Z.FEATURE_TILE_TREE_SHOW_TILES&&(e._featureTreeDebugger=new n({view:e}))})):t||!e._featureTreeDebugger||Jd.Z.FEATURE_TILE_TREE_SHOW_TILES||(e._featureTreeDebugger.destroy(),e._featureTreeDebugger=null)}),A.tX),this.updatingHandles.add((function(){return e.clippingArea}),t,A.tX),this.updatingHandles.add((function(){return e.basemapTerrain.extent}),t,A.tX)],"feature-tiles"),this.stateManager.init()}},{key:"_exitGlobe",value:function(){this.state&&(this.stateManager.exit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}},{key:"_initCoordinateSystem",value:function(){var e=this;if(this.spatialReference){var t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new qp(this.map,t));var n=this.state.isGlobal,r=(0,G.E2)(n,t);r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",nv.Z.create(this.state.viewingMode,r)),n||this.handles.add((0,A.YP)((function(){var t;return null===(t=e.basemapTerrain)||void 0===t?void 0:t.extent}),(function(t){var n=e.renderCoordsHelper.spatialReference;(0,k.pC)(t)&&(0!==t[0]||0!==t[1]||0!==t[2]||0!==t[3])&&(0,H.dH)(t,e.basemapTerrain.spatialReference,SS,n)&&(e.renderCoordsHelper.extent=SS)}),A.Z_),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Pa.vh/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}},{key:"_exitCoordinateSystem",value:function(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}},{key:"_updatingChanged",value:function(){this.notifyChange("updating")}},{key:"_updateUpdatingMonitors",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(0,k.pC)(t)&&t.type===P.y.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((function(t){t.destroyed||(e.handles.add((0,A.YP)((function(){return[t.updating,t.updatingProgress]}),(function(){return e._updatingChanged()}),A.Z_),"updatingMonitors"),t.when((function(){return e._updatingChanged()}),(function(){return e._updatingChanged()})))})),this._updatingChanged())}},{key:"_prepareScreenshotOverlay",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.overlay,!e.t0){e.next=4;break}return e.next=4,this.overlay.prepare();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_renderScreenshotOverlay",value:function(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;var n=e.getContext("2d");return n.putImageData(t,0,0),this.overlay.renderCanvas(e),n.getImageData(0,0,t.width,t.height)}},{key:"_initStage",value:function(){var e=this,t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:function(){return e._prepareScreenshotOverlay()},renderOverlay:function(t,n){return e._renderScreenshotOverlay(t,n)}}},n=new xp(this.state.viewingMode,(function(t){return e._stage.layers.forAll(t)}),this);this._set("sceneIntersectionHelper",n);var r=(0,g.L7)(this.surface);this._stage=new cS({view:this,options:t,container:r}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=(0,w.on)(this._stage.renderView.canvas,"webglcontextlost",(function(){return e.fatalError=new b.Z("webgl-context-lost")})),this.handles.add([this.updatingHandles.add((function(){return e.qualitySettings.antialiasingEnabled}),(function(){return e._stage.renderer.setParameters({antialiasingEnabled:e.qualitySettings.antialiasingEnabled})}),A.nn),this.updatingHandles.add((function(){return e.qualitySettings.highQualityTransparency}),(function(t){return e._stage.renderer.setParameters({highQualityTransparency:t})}),A.nn),(0,A.YP)((function(){return e.magnifier}),(function(t){return e._stage.renderView.magnifier=t}),A.tX),this.on("pointer-move",(function(){var t;return null===(t=e._stage)||void 0===t?void 0:t.renderer.resetAnimation()}))],"stage");var i=function(){e._stage.renderer.setParameters({defaultHighlightOptions:Bp.toEngineOptions(e.highlightOptions)})};this.handles.add(this.updatingHandles.add((function(){return[e.highlightOptions.color,e.highlightOptions.haloColor,e.highlightOptions.haloOpacity,e.highlightOptions.fillOpacity,e.highlightOptions.shadowOpacity,e.highlightOptions.shadowColor,e.highlightOptions.shadowDifference]}),i),"stage"),i(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Pa.vh/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}},{key:"_exitStage",value:function(){this._set("sceneIntersectionHelper",null),this._stage=(0,k.SC)(this._stage),this._lostWebGLContextHandle=(0,k.hw)(this._lostWebGLContextHandle),this.handles.remove("stage"),this._set("canvas",null)}},{key:"_initSurface",value:function(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new xv({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}},{key:"_exitSurface",value:function(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}},{key:"_createGraphicsViewIfNeeded",value:function(){var e=this;if(!this.graphicsView&&!this._createGraphicsViewController&&0!==this.graphics.length){this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;var t=function(){e._createGraphicsViewController=null,e._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this._updatingChanged()}}},{key:"_createGraphicsViewAsync",value:function(){var e=(0,o.Z)((0,a.Z)().mark((function e(t){var r,i=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([n.e(56717),n.e(80143),n.e(73364)]).then(n.bind(n,73364));case 2:return r=e.sent.default,(0,R.k_)(t),e.next=6,(0,A.N1)((function(){var e;return null===(e=i.basemapTerrain)||void 0===e?void 0:e.ready}),t);case 6:this._set("graphicsView",new r({view:this}));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_disposeGraphicsView",value:function(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),(0,k.pC)(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}},{key:"_startup",value:function(){var e=this,t=(0,he.wg)(this.viewingMode);if(t===he.JY.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.handles.add((0,A.on)((function(){return e.graphics}),"after-changes",(function(){return e._createGraphicsViewIfNeeded()})),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){var n=this.get("map.initialViewProperties.environment");n&&(this.environment=n)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();var r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach((function(t){return t(e)}))}},{key:"_teardown",value:function(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}},{key:"_updateDefaultToMapOptions",value:function(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Gs.cy);var e,t=(0,i.Z)(this.map.allLayers.items);try{for(t.s();!(e=t.n()).done;){var n=e.value;"integrated-mesh"===n.type&&this._defaultToMapOptions.include.add(n.uid)}}catch(r){t.e(r)}finally{t.f()}}}},{key:"_updateDefaultHitTestOptions",value:function(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Gs.cy);var e,t=(0,i.Z)(this.map.allLayers.items);try{for(t.s();!(e=t.n()).done;){var n=e.value;"integrated-mesh"===n.type&&n.opacity<1&&this._defaultHitTestOptions.exclude.add(n.uid)}}catch(r){t.e(r)}finally{t.f()}}}},{key:"addVoxelLayerViewToWasm",value:function(e){var t=this;return(0,k.Wi)(this.voxelWasm)?((0,k.Wi)(this.voxelWasmPromise)&&(this.voxelWasmPromise=n.e(7199).then(n.bind(n,7199)).then((function(e){return t.voxelWasm=new e.default(t),t.voxelWasm}))),this.voxelWasmPromise.then((function(t){return t.addVoxelLayer(e)}))):this.voxelWasm.addVoxelLayer(e)}},{key:"removeVoxelLayerViewFromWasm",value:function(e){(0,k.pC)(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(e)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}}]),p}((0,X.g)((0,Q.f)((0,le.u)(ue.Z))));function bS(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function wS(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function CS(e,t){return(0,k.pC)(e)&&(0,H.Up)(e.spatialReference,t)?(0,H.iV)(e,t):null}gS.type="3d",(0,p._)([(0,Z.Cb)()],gS.prototype,"_userClippingArea",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"_resourceController",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"_stage",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"deconflictor",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"labeler",void 0),(0,p._)([(0,Z.Cb)((0,U.z)(Y.J,"analyses"))],gS.prototype,"analyses",void 0),(0,p._)([(0,Z.Cb)({type:ce.Z,readOnly:!0})],gS.prototype,"animation",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"basemapTerrain",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"elevationProvider",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"camera",null),(0,p._)([(0,Z.Cb)({type:v.Z})],gS.prototype,"contentCamera",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"canvas",void 0),(0,p._)([(0,Z.Cb)({type:_i.Z})],gS.prototype,"center",null),(0,p._)([(0,Z.Cb)({type:ou.Z})],gS.prototype,"clippingArea",null),(0,p._)([(0,Z.Cb)({type:Ne})],gS.prototype,"constraints",void 0),(0,p._)([(0,Z.Cb)({type:ou.Z,readOnly:!0})],gS.prototype,"renderDataExtent",null),(0,p._)([(0,Z.Cb)({type:ou.Z,readOnly:!0})],gS.prototype,"dataExtent",null),(0,p._)([(0,Z.Cb)({type:ou.Z,readOnly:!0})],gS.prototype,"_groundAndLayersExtent",null),(0,p._)([(0,Z.Cb)({value:null,type:Bt})],gS.prototype,"environment",null),(0,p._)([(0,I.p)("environment")],gS.prototype,"castEnvironment",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"environmentManager",void 0),(0,p._)([(0,Z.Cb)({type:ou.Z})],gS.prototype,"extent",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"floors",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"screenCenter",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"frustum",null),(0,p._)([(0,Z.Cb)({type:Number,readOnly:!0})],gS.prototype,"fullOpacity",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"graphicsView",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"analysisViewManager",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"groundView",void 0),(0,p._)([(0,Z.Cb)({type:Boolean})],gS.prototype,"initialExtentRequired",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"_defaultsFromMapSettings",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"interacting",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"stationary",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"navigating",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"map",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"mapCoordsHelper",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"padding",null),(0,p._)([(0,Z.Cb)({type:em,readOnly:!0})],gS.prototype,"pointsOfInterest",void 0),(0,p._)([(0,Z.Cb)({type:hp,readOnly:!0})],gS.prototype,"featureTiles",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"_featureTreeDebugger",void 0),(0,p._)([(0,Z.Cb)({type:Boolean})],gS.prototype,"screenSizePerspectiveEnabled",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],gS.prototype,"deactivatedWebGLExtensions",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],gS.prototype,"debugWebGLExtensions",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],gS.prototype,"renderCanvas",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],gS.prototype,"state",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"inputManager",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"stateManager",void 0),(0,p._)([(0,Z.Cb)({type:["low","medium","high"]})],gS.prototype,"qualityProfile",null),(0,p._)([(0,Z.Cb)({type:tv,get:function(){var e=this._get("qualitySettings");return e||(e=new tv,Np.apply(this.qualityProfile,e)),e}})],gS.prototype,"qualitySettings",void 0),(0,p._)([(0,Z.Cb)()],gS.prototype,"slicePlane",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"typeSpecificPreconditionsReady",null),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"renderCoordsHelper",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"sceneIntersectionHelper",void 0),(0,p._)([(0,Z.Cb)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],gS.prototype,"resolution",null),(0,p._)([(0,Z.Cb)({type:Number})],gS.prototype,"scale",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"heightModelInfo",null),(0,p._)([(0,Z.Cb)()],gS.prototype,"spatialReference",void 0),(0,p._)([(0,Z.Cb)({type:Boolean,constructOnly:!0})],gS.prototype,"alphaCompositingEnabled",void 0),(0,p._)([(0,Z.Cb)({constructOnly:!0})],gS.prototype,"preserveDrawingBufferEnabled",void 0),(0,p._)([(0,Z.Cb)({type:Boolean})],gS.prototype,"supersampleScreenshotsEnabled",void 0),(0,p._)([(0,Z.Cb)({readOnly:!0})],gS.prototype,"type",void 0),(0,p._)([(0,Z.Cb)({type:yS})],gS.prototype,"ui",void 0),(0,p._)([(0,Z.Cb)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating","state.mode"]})],gS.prototype,"updating",null),(0,p._)([(0,Z.Cb)({type:Number,readOnly:!0,dependsOn:["updating"]})],gS.prototype,"updatingProgress",void 0),(0,p._)([(0,Z.Cb)({type:["global","local"]})],gS.prototype,"viewingMode",null),(0,p._)([(0,Z.Cb)({type:_.Z})],gS.prototype,"viewpoint",null),(0,p._)([(0,Z.Cb)({type:Number})],gS.prototype,"zoom",null),(0,p._)([(0,Z.Cb)({type:Bp})],gS.prototype,"highlightOptions",void 0),gS=(0,p._)([(0,L.j)("esri.views.SceneView")],gS),function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(_S||(_S={}));var xS=(0,F.c)(),TS=(0,O.s1)(),SS=(0,z.Ue)(),kS=gS},4583:function(e,t,n){n.d(t,{e:function(){return s}});var r=n(74165),i=n(15861),a=n(66978),o=n(38330);function s(e){return l.apply(this,arguments)}function l(){return l=(0,i.Z)((0,r.Z)().mark((function e(t){var i,s,l,u,c;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.e(83581).then(n.bind(n,83581)),s=n.e(78938).then(n.bind(n,78938)),e.t0=o.t,e.next=5,i;case 5:return e.t1=e.sent.default,e.t2={signal:t},l=(0,e.t0)(e.t1,e.t2),e.t3=o.t,e.next=11,s;case 11:return e.t4=e.sent.default,e.t5={signal:t},u=(0,e.t3)(e.t4,e.t5),e.next=16,l;case 16:return e.t6=e.sent,e.next=19,u;case 19:return e.t7=e.sent,c={mask:e.t6,overlay:e.t7},e.abrupt("return",((0,a.k_)(t),c));case 22:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}},78738:function(e,t,n){n.d(t,{J:function(){return a}});var r=n(15671),i=n(43144),a=function(){function e(t){(0,r.Z)(this,e),this._gain=t,this.lastValue=void 0,this.filteredDelta=void 0}return(0,i.Z)(e,[{key:"update",value:function(e){if(this.hasLastValue()){var t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}},{key:"reset",value:function(){this.lastValue=void 0,this.filteredDelta=void 0}},{key:"hasLastValue",value:function(){return void 0!==this.lastValue}},{key:"hasFilteredDelta",value:function(){return void 0!==this.filteredDelta}},{key:"computeDelta",value:function(e){return void 0===this.lastValue?NaN:e-this.lastValue}},{key:"_updateDelta",value:function(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}]),e}()},99742:function(e,t,n){n.d(t,{X:function(){return a}});var r=n(15671),i=n(43144),a=function(){function e(t,n,i){(0,r.Z)(this,e),this._initialVelocity=t,this._stopVelocity=n,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}return(0,i.Z)(e,[{key:"duration",get:function(){return this._duration}},{key:"isFinished",value:function(e){return e>this.duration}},{key:"friction",get:function(){return this._friction}},{key:"value",value:function(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}},{key:"valueDelta",value:function(e,t){var n=this.value(e);return this.value(e+t)-n}},{key:"valueFromInitialVelocity",value:function(e,t){t=Math.min(t,this.duration);var n=1-this.friction;return e*(Math.pow(n,t)-1)/Math.log(n)}}]),e}()},29660:function(e,t,n){n.d(t,{s:function(){return l}});var r=n(15671),i=n(43144),a=n(16889),o=n(78738),s=n(99742),l=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;(0,r.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=n,this._friction=i,this._maxVelocity=a,this.enabled=!0,this.value=new o.J(.8),this.time=new o.J(.3)}return(0,i.Z)(e,[{key:"add",value:function(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){var n=this.value.computeDelta(e);this.value.filteredDelta*n<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}},{key:"reset",value:function(){this.value.reset(),this.time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;var e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,a.uZ)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,n){return new s.X(e,t,n)}}]),e}()},87022:function(e,t,n){n.d(t,{G:function(){return f}});var r=n(15671),i=n(43144),a=n(11752),o=n(61120),s=n(60136),l=n(92572),u=n(11186),c=n(71353),h=n(78738),d=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,i,a,o,s){var l;return(0,r.Z)(this,n),(l=t.call(this,e,i,a))._sceneVelocity=o,l.direction=s,l}return(0,i.Z)(n,[{key:"value",value:function(e){return(0,a.Z)((0,o.Z)(n.prototype),"valueFromInitialVelocity",this).call(this,this._sceneVelocity,e)}}]),n}(n(99742).X),f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;(0,r.Z)(this,e),this._minimumInitialVelocity=t,this._stopVelocity=n,this._friction=i,this.enabled=!0,this._time=new h.J(.6),this._screen=[new h.J(.4),new h.J(.4)],this._scene=[new h.J(.6),new h.J(.6),new h.J(.6)],this._tmpDirection=(0,c.c)()}return(0,i.Z)(e,[{key:"add",value:function(e,t,n){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(n)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(n)}}},{key:"reset",value:function(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;var e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,n=null==e||null==t?0:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,i=null==r||null==n?0:n/r;return Math.abs(i)<this._minimumInitialVelocity?null:this.createMomentum(i,this._stopVelocity,this._friction)}},{key:"createMomentum",value:function(e,t,n){var r,i,a;(0,u.s)(this._tmpDirection,null!==(r=this._scene[0].filteredDelta)&&void 0!==r?r:0,null!==(i=this._scene[1].filteredDelta)&&void 0!==i?i:0,null!==(a=this._scene[2].filteredDelta)&&void 0!==a?a:0);var o=(0,u.l)(this._tmpDirection);o>0&&(0,u.g)(this._tmpDirection,this._tmpDirection,1/o);var s=this._time.filteredDelta;return new d(e,t,n,null==s?0:o/s,this._tmpDirection)}}]),e}()},19475:function(e,t,n){n.d(t,{y:function(){return u}});var r=n(15671),i=n(43144),a=n(11752),o=n(61120),s=n(60136),l=n(92572),u=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,r.Z)(this,n),t.call(this,e,i,a,o)}return(0,i.Z)(n,[{key:"add",value:function(e,t){var r=this.value.lastValue;if(null!=r){for(var i=e-r;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;e=r+i}(0,a.Z)((0,o.Z)(n.prototype),"add",this).call(this,e,t)}}]),n}(n(29660).s)},62124:function(e,t,n){n.d(t,{D:function(){return d}});var r=n(15671),i=n(43144),a=n(11752),o=n(61120),s=n(60136),l=n(92572),u=n(99742),c=n(29660),h=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(e,i,a){return(0,r.Z)(this,n),t.call(this,e,i,a)}return(0,i.Z)(n,[{key:"value",value:function(e){var t=(0,a.Z)((0,o.Z)(n.prototype),"value",this).call(this,e);return Math.exp(t)}},{key:"valueDelta",value:function(e,t){var r=(0,a.Z)((0,o.Z)(n.prototype),"value",this).call(this,e),i=(0,a.Z)((0,o.Z)(n.prototype),"value",this).call(this,e+t)-r;return Math.exp(i)}}]),n}(u.X),d=function(e){(0,s.Z)(n,e);var t=(0,l.Z)(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return(0,r.Z)(this,n),t.call(this,e,i,a,o)}return(0,i.Z)(n,[{key:"add",value:function(e,t){(0,a.Z)((0,o.Z)(n.prototype),"add",this).call(this,Math.log(e),t)}},{key:"createMomentum",value:function(e,t,n){return new h(e,t,n)}}]),n}(c.s)},74923:function(e,t,n){n.d(t,{ZV:function(){return o},qm:function(){return c}});var r=n(74165),i=n(15861),a=n(92026);function o(e,t){return s.apply(this,arguments)}function s(){return s=(0,i.Z)((0,r.Z)().mark((function e(t,n){var i,o,s,u,c;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("2d"!==t.type){e.next=2;break}return e.abrupt("return",t.hitTest(n));case 2:return e.next=4,t.hitTest(n);case 4:if(0!==(o=e.sent).results.length){e.next=7;break}return e.abrupt("return",o);case 7:return s=o.results[0],u=(null!==(i=(0,a.Wg)(s.distance))&&void 0!==i?i:0)*(1+l),c=o.results.findIndex((function(e){var t;return(null!==(t=e.distance)&&void 0!==t?t:0)>u})),e.abrupt("return",(-1!==c&&(o.results=o.results.slice(0,c)),o));case 9:case"end":return e.stop()}}),e)}))),s.apply(this,arguments)}var l=.05;function u(e){return(0,a.pC)(e)&&"graphic"===e.type}function c(e){var t;return null!==(t=e.find(u))&&void 0!==t?t:null}},92028:function(e,t,n){n.d(t,{D:function(){return a}});var r=n(72619),i=n(50951);function a(e,t){return null!=e&&(null==t||(t===i.JY.Local?!e.isGeographic||e.isWGS84||e.wkid===r.W.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===r.W.CGCS2000||e.wkid===r.W.GCSMARS2000||e.wkid===r.W.GCSMARS2000_SPHERE||e.wkid===r.W.GCSMOON2000))}},40235:function(e,t,n){n.d(t,{P9:function(){return s},mO:function(){return l}});var r=n(43144),i=n(15671),a=n(30308),o=(0,r.Z)((function e(t,n,r,a,o,s,l,u,c){(0,i.Z)(this,e),this.createQuery=t,this.deleteQuery=n,this.resultAvailable=r,this.getResult=a,this.disjoint=o,this.beginTimeElapsed=s,this.endTimeElapsed=l,this.createTimestamp=u,this.timestampBits=c})),s=!1;function l(e,t){if(t.disjointTimerQuery)return null;var n=e.getExtension("EXT_disjoint_timer_query_webgl2");return n&&(0,a.Z)(e)?new o((function(){return e.createQuery()}),(function(t){e.deleteQuery(t),s=!1}),(function(t){return e.getQueryParameter(t,e.QUERY_RESULT_AVAILABLE)}),(function(t){return e.getQueryParameter(t,e.QUERY_RESULT)}),(function(){return e.getParameter(n.GPU_DISJOINT_EXT)}),(function(t){s||(s=!0,e.beginQuery(n.TIME_ELAPSED_EXT,t))}),(function(){e.endQuery(n.TIME_ELAPSED_EXT),s=!1}),(function(e){return n.queryCounterEXT(e,n.TIMESTAMP_EXT)}),(function(){return e.getQuery(n.TIMESTAMP_EXT,n.QUERY_COUNTER_BITS_EXT)})):(n=e.getExtension("EXT_disjoint_timer_query"))?new o((function(){return n.createQueryEXT()}),(function(e){n.deleteQueryEXT(e),s=!1}),(function(e){return n.getQueryObjectEXT(e,n.QUERY_RESULT_AVAILABLE_EXT)}),(function(e){return n.getQueryObjectEXT(e,n.QUERY_RESULT_EXT)}),(function(){return e.getParameter(n.GPU_DISJOINT_EXT)}),(function(e){s||(s=!0,n.beginQueryEXT(n.TIME_ELAPSED_EXT,e))}),(function(){n.endQueryEXT(n.TIME_ELAPSED_EXT),s=!1}),(function(e){return n.queryCounterEXT(e,n.TIMESTAMP_EXT)}),(function(){return n.getQueryEXT(n.TIMESTAMP_EXT,n.QUERY_COUNTER_BITS_EXT)})):null}},30308:function(e,t,n){function r(e){return window.WebGL2RenderingContext&&e instanceof window.WebGL2RenderingContext}n.d(t,{Z:function(){return r}})},48673:function(e,t,n){n.d(t,{Br:function(){return c},Fm:function(){return m},N9:function(){return y},RA:function(){return g},Tc:function(){return d},Ue:function(){return f},iC:function(){return h},s9:function(){return u},v:function(){return _},xW:function(){return v},zS:function(){return p}});var r=n(29439),i=n(92026),a=n(6394),o=n(49800),s=n(8548),l=n(371);function u(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"nearest",i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=!(i&&"u8"===t.pixelType),u=a?s.Br.FLOAT:s.Br.UNSIGNED_BYTE,c=null==t.pixels||0===t.pixels.length?null:a?t.getAsRGBAFloat():t.getAsRGBA(),h=null===(n=e.capabilities.textureFloat)||void 0===n?void 0:n.textureFloatLinear,d={width:t.width,height:t.height,target:s.No.TEXTURE_2D,pixelFormat:s.VI.RGBA,internalFormat:e.type===o.zO.WEBGL2&&a?s.lP.RGBA32F:s.VI.RGBA,samplingMode:!h||"bilinear"!==r&&"cubic"!==r?s.cw.NEAREST:s.cw.LINEAR,dataType:u,wrapMode:s.e8.CLAMP_TO_EDGE,flipped:!1};return new l.x(e,d,c)}function c(e,t){var n=t.spacing,i=t.offsets,a=t.coefficients,u=(0,r.Z)(t.size,2),c=u[0],h=u[1],d=n[0]>1,f={width:d?4*c:c,height:h,target:s.No.TEXTURE_2D,pixelFormat:s.VI.RGBA,internalFormat:e.type===o.zO.WEBGL2?s.lP.RGBA32F:s.VI.RGBA,dataType:s.Br.FLOAT,samplingMode:s.cw.NEAREST,wrapMode:s.e8.CLAMP_TO_EDGE,flipped:!1},p=new Float32Array(d?c*h*16:2*i.length);if(d&&null!=a)for(var v=0,m=0;v<a.length;v++)p[m++]=a[v],v%3==2&&(p[m++]=1);else for(var _=0;_<h;_++)for(var y=0;y<c;y++){var g=4*(_*c+y),b=2*(y*h+_);p[g]=i[b],p[g+1]=i[b+1],p[g+3]=-1===i[b]?0:1}return new l.x(e,f,p)}function h(e,t){var n={width:t.length/4,height:1,target:s.No.TEXTURE_2D,pixelFormat:s.VI.RGBA,internalFormat:s.VI.RGBA,dataType:s.Br.UNSIGNED_BYTE,samplingMode:s.cw.NEAREST,wrapMode:s.e8.CLAMP_TO_EDGE,flipped:!1};return new l.x(e,n,t)}function d(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];return{u_flipY:i,u_applyTransform:!!e,u_opacity:r,u_transformSpacing:e?e.spacing:a.Z,u_transformGridSize:e?e.size:a.Z,u_targetImageSize:t,u_srcImageSize:n}}function f(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}function p(e,t){return{u_scale:e,u_offset:t}}function v(e){return{u_bandCount:e.bandCount,u_minOutput:e.outMin,u_maxOutput:e.outMax,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function m(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}function _(e,t){var n=e.gl,r=t.glName,a=new Map;if((0,i.Wi)(r))return a;for(var o,s=n.getProgramParameter(r,n.ACTIVE_UNIFORMS),l=0;l<s;l++)(o=n.getActiveUniform(r,l))&&a.set(o.name,{location:n.getUniformLocation(r,o.name),info:o});return a}function y(e,t,n){Object.keys(n).forEach((function(r){var i=t.get(r)||t.get(r+"[0]");i&&function(e,t,n,r){if(null===r||null==n)return!1;var i=r.info;switch(i.type){case s.Se.FLOAT:i.size>1?e.setUniform1fv(t,n):e.setUniform1f(t,n);break;case s.Se.FLOAT_VEC2:e.setUniform2fv(t,n);break;case s.Se.FLOAT_VEC3:e.setUniform3fv(t,n);break;case s.Se.FLOAT_VEC4:e.setUniform4fv(t,n);break;case s.Se.FLOAT_MAT3:e.setUniformMatrix3fv(t,n);break;case s.Se.FLOAT_MAT4:e.setUniformMatrix4fv(t,n);break;case s.Se.INT:i.size>1?e.setUniform1iv(t,n):e.setUniform1i(t,n);break;case s.Se.BOOL:e.setUniform1i(t,n?1:0);break;case s.Se.INT_VEC2:case s.Se.BOOL_VEC2:e.setUniform2iv(t,n);break;case s.Se.INT_VEC3:case s.Se.BOOL_VEC3:e.setUniform3iv(t,n);break;case s.Se.INT_VEC4:case s.Se.BOOL_VEC4:e.setUniform4iv(t,n);break;default:return!1}}(e,r,n[r],i)}))}function g(e,t,n,r){n.length===r.length&&(r.some((function(e){return null==e}))||n.some((function(e){return null==e}))||n.forEach((function(n,i){t.setUniform1i(n,i),e.bindTexture(r[i],i)})))}}}]);
//# sourceMappingURL=82111.318efc18.chunk.js.map