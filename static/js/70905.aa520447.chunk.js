"use strict";(self.webpackChunkhub_layout_versioning=self.webpackChunkhub_layout_versioning||[]).push([[70905],{62044:function(e,t,r){r.d(t,{Z:function(){return x}});var n,i=r(15671),a=r(43144),s=r(60136),o=r(92572),l=r(27366),u=r(46784),c=r(92026),f=r(86710),d=r(49861),h=(r(25243),r(63780),r(38511)),p=r(69912),m=r(31201),v=n=function(e){(0,s.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this,e)).end=null,n.start=null,n}return(0,a.Z)(r,[{key:"readEnd",value:function(e,t){return null!=t.end?new Date(t.end):null}},{key:"writeEnd",value:function(e,t){t.end=e?e.getTime():null}},{key:"isAllTime",get:function(){return this.equals(n.allTime)}},{key:"isEmpty",get:function(){return this.equals(n.empty)}},{key:"readStart",value:function(e,t){return null!=t.start?new Date(t.start):null}},{key:"writeStart",value:function(e,t){t.start=e?e.getTime():null}},{key:"clone",value:function(){return new n({end:this.end,start:this.start})}},{key:"equals",value:function(e){if(!e)return!1;var t=(0,c.pC)(this.start)?this.start.getTime():this.start,r=(0,c.pC)(this.end)?this.end.getTime():this.end,n=(0,c.pC)(e.start)?e.start.getTime():e.start,i=(0,c.pC)(e.end)?e.end.getTime():e.end;return t===n&&r===i}},{key:"expandTo",value:function(e){if(this.isEmpty||this.isAllTime)return this.clone();var t=(0,c.yw)(this.start,(function(t){return(0,f.JE)(t,e)})),r=(0,c.yw)(this.end,(function(t){var r=(0,f.JE)(t,e);return t.getTime()===r.getTime()?r:(0,f.Nm)(r,1,e)}));return new n({start:t,end:r})}},{key:"intersection",value:function(e){if(!e)return this.clone();if(this.isEmpty||e.isEmpty)return n.empty;if(this.isAllTime)return e.clone();if(e.isAllTime)return this.clone();var t,r,i=(0,c.R2)(this.start,-1/0,(function(e){return e.getTime()})),a=(0,c.R2)(this.end,1/0,(function(e){return e.getTime()})),s=(0,c.R2)(e.start,-1/0,(function(e){return e.getTime()})),o=(0,c.R2)(e.end,1/0,(function(e){return e.getTime()}));if(s>=i&&s<=a?t=s:i>=s&&i<=o&&(t=i),a>=s&&a<=o?r=a:o>=i&&o<=a&&(r=o),null!=t&&null!=r&&!isNaN(t)&&!isNaN(r)){var l=new n;return l.start=t===-1/0?null:new Date(t),l.end=r===1/0?null:new Date(r),l}return n.empty}},{key:"offset",value:function(e,t){if(this.isEmpty||this.isAllTime)return this.clone();var r=new n,i=this.start,a=this.end;return(0,c.pC)(i)&&(r.start=(0,f.Nm)(i,e,t)),(0,c.pC)(a)&&(r.end=(0,f.Nm)(a,e,t)),r}},{key:"union",value:function(e){if(!e||e.isEmpty)return this.clone();if(this.isEmpty)return e.clone();if(this.isAllTime||e.isAllTime)return y.clone();var t=(0,c.pC)(this.start)&&(0,c.pC)(e.start)?new Date(Math.min(this.start.getTime(),e.start.getTime())):null,r=(0,c.pC)(this.end)&&(0,c.pC)(e.end)?new Date(Math.max(this.end.getTime(),e.end.getTime())):null;return new n({start:t,end:r})}}],[{key:"allTime",get:function(){return y}},{key:"empty",get:function(){return g}}]),r}(u.wq);(0,l._)([(0,d.Cb)({type:Date,json:{write:{allowNull:!0}}})],v.prototype,"end",void 0),(0,l._)([(0,h.r)("end")],v.prototype,"readEnd",null),(0,l._)([(0,m.c)("end")],v.prototype,"writeEnd",null),(0,l._)([(0,d.Cb)({readOnly:!0,json:{read:!1}})],v.prototype,"isAllTime",null),(0,l._)([(0,d.Cb)({readOnly:!0,json:{read:!1}})],v.prototype,"isEmpty",null),(0,l._)([(0,d.Cb)({type:Date,json:{write:{allowNull:!0}}})],v.prototype,"start",void 0),(0,l._)([(0,h.r)("start")],v.prototype,"readStart",null),(0,l._)([(0,m.c)("start")],v.prototype,"writeStart",null);var y=new(v=n=(0,l._)([(0,p.j)("esri.TimeExtent")],v)),g=new v({start:void 0,end:void 0}),x=v},41691:function(e,t,r){r.d(t,{p:function(){return h},r:function(){return p}});var n=r(15671),i=r(43144),a=r(60136),s=r(92572),o=r(27366),l=r(85015),u=r(100),c=r(49861),f=r(69912),d=r(61826),h=function(e){var t=function(e){(0,a.Z)(r,e);var t=(0,s.Z)(r);function r(){return(0,n.Z)(this,r),t.apply(this,arguments)}return(0,i.Z)(r,[{key:"destroy",value:function(){var e,t;this.destroyed||(null!==(e=this._get("handles"))&&void 0!==e&&e.destroy(),null===(t=this._get("updatingHandles"))||void 0===t||t.destroy())}},{key:"handles",get:function(){return this._get("handles")||new u.Z}},{key:"updatingHandles",get:function(){return this._get("updatingHandles")||new d.t}}]),r}(e);return(0,o._)([(0,c.Cb)({readOnly:!0})],t.prototype,"handles",null),(0,o._)([(0,c.Cb)({readOnly:!0})],t.prototype,"updatingHandles",null),t=(0,o._)([(0,f.j)("esri.core.HandleOwner")],t),t},p=function(e){(0,a.Z)(r,e);var t=(0,s.Z)(r);function r(){return(0,n.Z)(this,r),t.apply(this,arguments)}return(0,i.Z)(r)}(h(l.Z));p=(0,o._)([(0,f.j)("esri.core.HandleOwner")],p)},16054:function(e,t,r){r.d(t,{Z:function(){return s}});var n=r(15671),i=r(43144),a=r(18759),s=function(){function e(t,r){(0,n.Z)(this,e),this._storage=new a.WJ,this._storage.maxSize=t,r&&this._storage.registerRemoveFunc("",r)}return(0,i.Z)(e,[{key:"put",value:function(e,t,r){this._storage.put(e,t,r,1)}},{key:"pop",value:function(e){return this._storage.pop(e)}},{key:"get",value:function(e){return this._storage.get(e)}},{key:"clear",value:function(){this._storage.clearAll()}},{key:"destroy",value:function(){this._storage.destroy()}},{key:"maxSize",get:function(){return this._storage.maxSize},set:function(e){this._storage.maxSize=e}}]),e}()},61826:function(e,t,r){r.d(t,{t:function(){return m}});var n=r(15671),i=r(43144),a=r(60136),s=r(92572),o=r(27366),l=r(85015),u=r(100),c=r(92026),f=r(94172),d=r(99346),h=r(49861),p=r(69912),m=function(e){(0,a.Z)(r,e);var t=(0,s.Z)(r);function r(){var e;return(0,n.Z)(this,r),(e=t.apply(this,arguments)).updating=!1,e._handleId=0,e._handles=new u.Z,e._scheduleHandleId=0,e._pendingPromises=new Set,e}return(0,i.Z)(r,[{key:"destroy",value:function(){this.removeAll(),this._handles.destroy()}},{key:"add",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._installWatch(e,t,r,f.YP)}},{key:"addWhen",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._installWatch(e,t,r,f.gx)}},{key:"addOnCollectionChange",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=n.initial,a=void 0!==i&&i,s=n.final,o=void 0!==s&&s,l=++this._handleId;return this._handles.add([(0,f.on)(e,"after-changes",this._createSyncUpdatingCallback(),f.Z_),(0,f.on)(e,"change",t,{onListenerAdd:a?function(e){return t({added:e.toArray(),removed:[]})}:void 0,onListenerRemove:o?function(e){return t({added:[],removed:e.toArray()})}:void 0})],l),{remove:function(){return r._handles.remove(l)}}}},{key:"addPromise",value:function(e){var t=this;if((0,c.Wi)(e))return e;var r=++this._handleId;this._handles.add({remove:function(){t._pendingPromises.delete(e)&&(0!==t._pendingPromises.size||t._handles.has(v)||t._set("updating",!1))}},r),this._pendingPromises.add(e),this._set("updating",!0);var n=function(){return t._handles.remove(r)};return e.then(n,n),e}},{key:"removeAll",value:function(){this._pendingPromises.clear(),this._handles.removeAll(),this._set("updating",!1)}},{key:"_installWatch",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,a=++this._handleId;n.sync||this._installSyncUpdatingWatch(e,a);var s=i(e,t,n);return this._handles.add(s,a),{remove:function(){return r._handles.remove(a)}}}},{key:"_installSyncUpdatingWatch",value:function(e,t){var r=this._createSyncUpdatingCallback(),n=(0,f.YP)(e,r,{sync:!0,equals:function(){return!1}});return this._handles.add(n,t),n}},{key:"_createSyncUpdatingCallback",value:function(){var e=this;return function(){e._handles.remove(v),++e._scheduleHandleId;var t=e._scheduleHandleId;e._get("updating")||e._set("updating",!0),e._handles.add((0,d.Os)((function(){t===e._scheduleHandleId&&(e._set("updating",e._pendingPromises.size>0),e._handles.remove(v))})),v)}}}]),r}(l.Z);(0,o._)([(0,h.Cb)({readOnly:!0})],m.prototype,"updating",void 0),m=(0,o._)([(0,p.j)("esri.core.support.WatchUpdatingTracking")],m);var v=-42},86710:function(e,t,r){r.d(t,{JE:function(){return s},Nm:function(){return a},rJ:function(){return o}});r(93169);var n={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},i={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function a(e,t,r){var n=new Date(e.getTime());if(t&&r){var a=i[r],s=a.getter,o=a.setter,l=a.multiplier;if("months"===r){var u=function(e,t){var r=new Date(e,t+1,1);return r.setDate(0),r.getDate()}(n.getFullYear(),n.getMonth()+t);n.getDate()>u&&n.setDate(u)}n[o](n[s]()+t*l)}return n}function s(e,t){switch(t){case"milliseconds":return new Date(e.getTime());case"seconds":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds());case"minutes":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes());case"hours":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours());case"days":return new Date(e.getFullYear(),e.getMonth(),e.getDate());case"weeks":return new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay());case"months":return new Date(e.getFullYear(),e.getMonth(),1);case"years":return new Date(e.getFullYear(),0,1);case"decades":return new Date(e.getFullYear()-e.getFullYear()%10,0,1);case"centuries":return new Date(e.getFullYear()-e.getFullYear()%100,0,1);default:return new Date}}function o(e,t,r){return 0===e?0:e*n[t]/n[r]}},83938:function(e,t,r){r.r(t),r.d(t,{default:function(){return dt}});var n=r(74165),i=r(15861),a=r(1413),s=r(15671),o=r(43144),l=r(11752),u=r(61120),c=r(60136),f=r(92572),d=r(27366),h=r(44055),p=r(45918),m=r(10064),v=r(32718),y=r(92026),g=r(97642),x=r(66978),b=r(94172),k=r(49861),w=r(25243),I=(r(63780),r(27135)),_=r(38511),Z=r(69912),S=r(30651),R=r(11936),C=r(6693),T=r(46671),F=r(29439),M=(r(59486),r(76200)),P=r(92975),D=r(25899),O=r(70361),B=r(86591),E=r(22678),z=r(1650),H=r(79586),N=r(22824),J=r(93433),W=r(46784),A=r(67426),L=r(59068),q=r(32014),j=r(21969),G=r(55635),U=r(92089),V=r(45502),Y=r(17314),X=r(80394),Q=r(64145),K=r(53866),$=r(585),ee=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.hasUniqueSourceStorageInfo=!0,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}return(0,o.Z)(r,[{key:"init",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(){var t;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,X.zD)(),this.addResolvingPromise(t),e.next=4,this.when();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"normalizeCtorArgs",value:function(e){return e&&e.ioConfig&&(e=(0,a.Z)((0,a.Z)({},e),{},{ioConfig:(0,a.Z)({resolution:null,bandIds:null,sampling:"closest",tileInfo:N.Z.create()},e.ioConfig)})),e}},{key:"_isGlobalWrappableSource",get:function(){var e=this.rasterInfo,t=(0,X.ut)(e.spatialReference);return(0,y.pC)(t)&&e.extent.width>=t/2}},{key:"url",set:function(e){this._set("url",(0,D.Nm)(e,v.Z.getLogger(this.declaredClass)))}},{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new m.Z("BaseRaster:open-not-implemented","open() is not implemented");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=l.length>3&&void 0!==l[3]?l[3]:{},s=a.tileInfo||this.rasterInfo.storageInfo.tileInfo,o=this.getTileExtentFromTileInfo(t,r,i,s),e.abrupt("return",this.fetchPixels(o,s.size[0],s.size[1],a));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,I,_,Z,S,R,C,T,F,M,P,D,O,B,E,z,H,N,J,W,A,L,q,U,V,Y,Q,ee,te,re=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=re.length>1&&void 0!==re[1]?re[1]:{},t=(0,w.TJ)($.Z,t).clone().normalize(),l=(o=s).multidimensionalDefinition,u=o.timeExtent,c=this.rasterInfo,f=c.hasMultidimensionalTranspose,d=c.multidimensionalInfo,h=s.transposedVariableName,(p=(0,y.pC)(d)&&f&&(null!=u||(0,j.WU)(l)))&&!h&&(h=(0,y.pC)(l)&&l.length>0?null!==(m=l[0].variableName)&&void 0!==m?m:void 0:d.variables[0].name,s=(0,a.Z)((0,a.Z)({},s),{},{transposedVariableName:h})),s=this._getRequestOptionsWithSliceId(s),v=c.spatialReference,g=c.extent,x=s.datumTransformation,b=(0,X.nF)(t,v,x),g.intersects(b)){e.next=11;break}return e.abrupt("return",{location:b,value:null});case 11:if(!(0,y.pC)(c.transform)){e.next=16;break}if(k=c.transform.inverseTransform(b),c.nativeExtent.intersects(k)){e.next=15;break}return e.abrupt("return",{location:k,value:null});case 15:b=k;case 16:if(I=0,_=(0,y.pC)(h)&&(0,y.pC)(d)&&c.hasMultidimensionalTranspose,"Function"!==this.datasetFormat){e.next=40;break}if(Z=this.primaryRasters.rasters[0],!_){e.next=22;break}return e.abrupt("return",Z.identify(b,s));case 22:return S=c.pixelSize,R=3,C=S.x*R/2,T=S.y*R/2,F=new K.Z({xmin:b.x-C,xmax:b.x+C,ymin:b.y-T,ymax:b.y+T,spatialReference:v}),M={interpolation:"nearest"},e.next=30,Z.fetchPixels(F,R,R,M);case 30:return P=e.sent,D=P.pixelBlock,e.next=34,this.fetchPixels(F,R,R,M);case 34:if(O=e.sent,B=O.pixelBlock,!(0,y.Wi)(D)){e.next=38;break}return e.abrupt("return",{location:b,value:null});case 38:return E=Math.floor(R*R*.5),z=!D.mask||D.mask[E]?D.pixels.map((function(e){return e[E]})):null,e.abrupt("return",((0,y.pC)(B)&&(H=!B.mask||B.mask[E]?B.pixels.map((function(e){return e[E]})):void 0),{location:b,value:z,processedValue:H,pyramidLevel:0}));case 40:if(_){e.next=50;break}if(!s.srcResolution){e.next=45;break}I=(0,X.kr)(s.srcResolution,c,this.ioConfig.sampling).pyramidLevel,e.next=50;break;case 45:return e.next=47,this.computeBestPyramidLevelForLocation(t,s);case 47:if(null!=(I=e.sent)){e.next=50;break}return e.abrupt("return",{location:b,value:null});case 50:if(null!==(N=this.identifyPixelLocation(b,I,null,_))){e.next=53;break}return e.abrupt("return",{location:b,value:null});case 53:return J=N.row,W=N.col,A=N.rowOffset,L=N.colOffset,q=N.blockWidth,U=null!==(r=h)&&void 0!==r?r:(0,y.Wg)(s.sliceId),V=(0,G.Rq)(this.url,U),Y="".concat(I,"/").concat(J,"/").concat(W),Q=(0,G.Qg)(V,null,Y),(0,y.Wi)(Q)&&(Q=this.fetchRawTile(I,J,W,s),(0,G.gX)(V,null,Y,Q)),e.next=58,Q;case 58:if(ee=e.sent,!(0,y.Wi)(ee)&&null!==(i=ee.pixels)&&void 0!==i&&i.length){e.next=61;break}return e.abrupt("return",{location:b,value:null});case 61:return te=A*q+L,e.abrupt("return",this._processIdentifyResult(ee,{srcLocation:b,position:te,pyramidLevel:I,useTransposedTile:!!_,requestSomeSlices:p,identifyOptions:s}));case 63:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w,I,_=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=_.length>3&&void 0!==_[3]?_[3]:{},t=(0,X.kZ)(t),!(a=this._getRequestOptionsWithSliceId(a)).requestRawData){e.next=3;break}return e.abrupt("return",this._fetchPixels(t,r,i,a));case 3:if(s=(0,X.ut)(t.spatialReference),o=(0,X.Hq)(t),!((0,y.Wi)(s)||0===o||1===o&&this._isGlobalWrappableSource)){e.next=6;break}return e.abrupt("return",this._fetchPixels(t,r,i,a));case 6:if(!(o>=3)){e.next=8;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 8:for(l=[],c=(u=t).xmin,f=u.xmax,d=Math.round(s/(f-c)*r),h=d-Math.round((s/2-c)/(f-c)*r),p=0,m=[],v=0;v<=o;v++)g=new K.Z({xmin:0===v?c:-s/2,xmax:v===o?f-s*v:s/2,ymin:t.ymin,ymax:t.ymax,spatialReference:t.spatialReference}),p+=x=0===v?d-h:v===o?r-p:d,m.push(x),b=a.disableWrapAround&&v>0?null:this._fetchPixels(g,x,i,a),l.push(b);return e.next=14,Promise.all(l);case 14:if(k=e.sent.map((function(e){return null===e||void 0===e?void 0:e.pixelBlock})),w=null,I={width:r,height:i},!this.rasterJobHandler){e.next=23;break}return e.next=20,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:k,srcMosaicSize:I,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:m},a);case 20:w=e.sent.pixelBlock,e.next=24;break;case 23:w=(0,Y.us)(k,I,{blockWidths:m});case 24:return e.abrupt("return",{extent:t,srcExtent:(0,X.tB)(t,this.rasterInfo.spatialReference,a.datumTransformation),pixelBlock:w});case 25:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawPixels",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=w.length>3&&void 0!==w[3]?w[3]:{},r={x:Math.floor(r.x),y:Math.floor(r.y)},e.next=4,this._fetchRawTiles(t,r,i,a);case 4:if(s=e.sent,o=this.rasterInfo,l=o.nativeExtent,u=o.nativePixelSize,c=o.storageInfo,f=Math.pow(2,t),d=u.x*f,h=u.y*f,p=new K.Z({xmin:l.xmin+d*r.x,xmax:l.xmin+d*(r.x+i.width-1),ymin:l.ymax-h*(r.y+i.height-1),ymax:l.ymax-h*r.y,spatialReference:l.spatialReference}),s){e.next=15;break}return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:null});case 15:if(m=s.pixelBlocks,v=s.mosaicSize,1!==m.length||!(0,y.pC)(m[0])||m[0].width!==i.width||m[0].height!==i.height){e.next=18;break}return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:s.pixelBlocks[0]});case 18:if(g=t>0?c.pyramidBlockWidth:c.blockWidth,x=t>0?c.pyramidBlockHeight:c.blockHeight,b={x:r.x%g,y:r.y%x},!this.rasterJobHandler){e.next=25;break}return e.next=22,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:m,srcMosaicSize:v,destDimension:i,clipOffset:b,clipSize:i,coefs:null,sampleSpacing:null,interpolation:a.interpolation,alignmentInfo:null,blockWidths:null},a);case 22:k=e.sent.pixelBlock,e.next=26;break;case 25:k=(0,Y.us)(m,v,{clipOffset:b,clipSize:i});case 26:return e.abrupt("return",{extent:p,srcExtent:p,pixelBlock:k});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r,n){throw new m.Z("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}},{key:"computeExtent",value:function(e){return(0,X.tB)(this.rasterInfo.extent,e)}},{key:"decodePixelBlock",value:function(e,t){return!this.rasterJobHandler||t.useCanvas?(0,V.J)(e,t):this.rasterJobHandler.decode({data:e,options:t})}},{key:"request",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,s,o,l,u,c,f,d,h=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=h.length>2&&void 0!==h[2]?h[2]:0,l=this.ioConfig.customFetchParameters,u=r.range,c=r.query,f=r.headers,o=null!==(i=null!==(s=o)&&void 0!==s?s:r.retryCount)&&void 0!==i?i:this.ioConfig.retryCount,d=u?{Range:"bytes=".concat(u.from,"-").concat(u.to)}:null,e.prev=4,e.next=7,(0,M.default)(t,(0,a.Z)((0,a.Z)({},r),{},{query:(0,a.Z)((0,a.Z)({},c),l),headers:(0,a.Z)((0,a.Z)({},f),d)}));case 7:return e.abrupt("return",e.sent);case 10:if(e.prev=10,e.t0=e.catch(4),!(o>0)){e.next=14;break}return e.abrupt("return",(o--,this.request(t,r,o)));case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){var t=this.rasterInfo.multidimensionalInfo;return(0,y.Wi)(t)||(0,y.Wi)(e)||0===e.length?null:(0,j.gk)(e,t)}},{key:"getTileExtentFromTileInfo",value:function(e,t,r,n){var i=(0,y.s3)(n.lodAt(e));return this.getTileExtent({x:i.resolution,y:i.resolution},t,r,n.origin,n.spatialReference,n.size)}},{key:"updateTileInfo",value:function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.extent,i=e.pixelSize;if(!t.tileInfo){for(var a=[],s=t.maximumPyramidLevel||0,o=Math.max(i.x,i.y),l=1/.0254*96*o,u=0;u<=s;u++)a.push(new L.Z({level:s-u,resolution:o,scale:l})),o*=2,l*=2;var c=new $.Z({x:n.xmin,y:n.ymax,spatialReference:r});t.tileInfo=new N.Z({origin:c,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:a}),t.isVirtualTileInfo=!0}}},{key:"createRemoteDatasetStorageInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0,i=e.width,a=e.height,s=e.nativeExtent,o=e.pixelSize,l=e.spatialReference,u=new $.Z({x:s.xmin,y:s.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(i,a))/Math.LN2-8)));var c=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[o],n);e.storageInfo=new q.Z({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:c})}},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>1&&void 0!==r[1]?r[1]:{},e.abrupt("return",0);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"computeBlockBoundary",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:2;if(1===i.length&&a>0)for(var o=(i=(0,J.Z)(i))[0],l=o.x,u=o.y,c=0;c<a;c++)l*=s,u*=s,i.push({x:l,y:u});for(var f=[],d=n.x,h=n.y,p=0;p<i.length;p++){var m=i[p],v=m.x,y=m.y;f.push({minCol:Math.floor((e.xmin-d+.1*v)/t/v),maxCol:Math.floor((e.xmax-d-.1*v)/t/v),minRow:Math.floor((h-e.ymax+.1*y)/r/y),maxRow:Math.floor((h-e.ymin-.1*y)/r/y)})}return f}},{key:"getPyramidPixelSize",value:function(e){var t=this.rasterInfo.nativePixelSize,r=this.rasterInfo.storageInfo,n=r.pyramidResolutions,i=r.pyramidScalingFactor;if(0===e)return t;if((0,y.pC)(n)&&n.length)return n[e-1];var a=Math.pow(i,e);return{x:t.x*a,y:t.y*a}}},{key:"identifyPixelLocation",value:function(e,t,r,n){var i=this.rasterInfo,a=i.spatialReference,s=i.nativeExtent,o=i.storageInfo,l=o.maximumPyramidLevel,u=o.origin,c=o.transposeInfo,f=n&&(0,y.pC)(c)?c.tileSize[0]:o.blockWidth,d=n&&(0,y.pC)(c)?c.tileSize[1]:o.blockHeight,h=(0,X.nF)(e,a,r);if(!s.intersects(h))return null;if(t<0||t>l)return null;var p=this.getPyramidPixelSize(t),m=p.x,v=p.y,g=(u.y-h.y)/v/d,x=(h.x-u.x)/m/f,b=Math.min(d-1,Math.floor((g-Math.floor(g))*d)),k=Math.min(f-1,Math.floor((x-Math.floor(x))*f));return{pyramidLevel:t,row:Math.floor(g),col:Math.floor(x),rowOffset:b,colOffset:k,blockWidth:f,srcLocation:h}}},{key:"getTileExtent",value:function(e,t,r,n,i,a){var s=(0,F.Z)(a,2),o=s[0],l=s[1],u=n.x+r*o*e.x,c=u+o*e.x,f=n.y-t*l*e.y,d=f-l*e.y;return new K.Z({xmin:u,xmax:c,ymin:d,ymax:f,spatialReference:i})}},{key:"getBlockWidthHeight",value:function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}},{key:"isBlockOutside",value:function(e,t,r){var n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}},{key:"_fetchPixels",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w,I,_,Z,S,R,C,T,F,M,P,D,O,B,E,z,H,N,J=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=J.length>3&&void 0!==J[3]?J[3]:{},!((s=(0,X.Hq)(t))>=2)){e.next=4;break}return e.abrupt("return",{extent:t,pixelBlock:null});case 4:if(o=this._getSourceDataInfo(t,r,i,a),l=o.pyramidLevel,u=o.pyramidResolution,c=o.srcResolution,f=o.srcExtent,d=o.srcWidth,h=o.srcHeight,0!==d&&0!==h){e.next=7;break}return e.abrupt("return",{extent:t,srcExtent:f,pixelBlock:null});case 7:return p=(0,y.Wg)(this.rasterInfo.transform),m="gcs-shift"===(null===p||void 0===p?void 0:p.type),v=(0,y.pC)((0,X.ut)(t.spatialReference)),!m&&v||(s=(0,X.Hq)(o.srcExtent,m)),g=this.rasterInfo.storageInfo,x={x:Math.floor((f.xmin-g.origin.x)/u.x+.1),y:Math.floor((g.origin.y-f.ymax)/u.y+.1)},e.next=13,this._fetchRawTiles(l,x,{width:d,height:h,wrapCount:s},a);case 13:if(b=e.sent){e.next=16;break}return e.abrupt("return",{extent:t,srcExtent:f,pixelBlock:null});case 16:if(k=l>0?g.pyramidBlockWidth:g.blockWidth,w=l>0?g.pyramidBlockHeight:g.blockHeight,I=k===d&&w===h&&x.x%k==0&&x.y%w==0,_=new $.Z({x:(t.xmax-t.xmin)/r,y:(t.ymax-t.ymin)/i,spatialReference:t.spatialReference}),Z=!t.spatialReference.equals(this.rasterInfo.spatialReference),S=a.datumTransformation,Z||!I||1!==b.pixelBlocks.length||k!==r||w!==i||c.x!==_.x||c.y!==_.y){e.next=19;break}return e.abrupt("return",{extent:t,srcExtent:f,pixelBlock:b.pixelBlocks[0]});case 19:if(R=v&&(0,y.pC)((0,X.ut)(f.spatialReference)),C=a.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector"),e.t0=C&&!this.rasterJobHandler,!e.t0){e.next=24;break}return e.next=24,(0,X.zD)();case 24:if(!this.rasterJobHandler){e.next=30;break}return e.next=27,this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:t,srcBufferExtent:b.extent,pixelSize:_.toJSON(),datumTransformation:S,rasterTransform:p,hasWrapAround:s>0||R,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:C},a);case 27:e.t1=e.sent,e.next=31;break;case 30:e.t1=(0,X.Qp)({projectedExtent:t,srcBufferExtent:b.extent,pixelSize:_,datumTransformation:S,rasterTransform:p,hasWrapAround:s>0||R,isAdaptive:!1,includeGCSGrid:C});case 31:if(T=e.t1,M=!a.requestRawData,P={rows:T.spacing[0],cols:T.spacing[1]},D=(0,y.Wg)(this._getRasterTileAlignmentInfo(l,b.extent.xmin)),O=b.pixelBlocks,B=b.mosaicSize,E=b.isPartiallyFilled,z=null,!this.rasterJobHandler){e.next=42;break}return e.next=37,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:O,srcMosaicSize:B,destDimension:M?{width:r,height:i}:null,coefs:M?T.coefficients:null,sampleSpacing:M?P:null,projectDirections:C,gcsGrid:C?T.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:a.interpolation,alignmentInfo:D,blockWidths:null},a);case 37:H=e.sent,F=H.pixelBlock,z=H.localNorthDirections,e.next=44;break;case 42:N=(0,Y.us)(O,B,{alignmentInfo:D}),F=M?(0,Y.Uk)(N,{width:r,height:i},T.coefficients,P,a.interpolation):N,C&&T.gcsGrid&&(z=(0,Y.Qh)({width:r,height:i},T.gcsGrid),F=(0,Q.xQ)(F,this.rasterInfo.dataType,z));case 44:return e.abrupt("return",a.requestRawData||C?{srcExtent:f,pixelBlock:F,transformGrid:T,localNorthDirections:z,extent:t,isPartiallyFilled:E}:{srcExtent:f,extent:t,pixelBlock:F});case 45:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_fetchRawTiles",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,a){var s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w,I,_,Z,S,R,C,T,F,M,P,D,O,B,E,z,H,N,J,W,A,L=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this.rasterInfo.storageInfo,o=s.origin,l=s.blockBoundary,u=this.getBlockWidthHeight(t),c=u.blockWidth,f=u.blockHeight,d=r.x,h=r.y,p=i.width,m=i.height,v=i.wrapCount,g=this._getRasterTileAlignmentInfo(t,0),a.buffer&&(d-=a.buffer.cols,h-=a.buffer.rows,p+=2*a.buffer.cols,m+=2*a.buffer.rows),x=0,b=0,k=0,v&&(0,y.pC)(g)&&(b=g.worldColumnCountFromOrigin,k=g.originColumnOffset,x=g.rightPadding,b*g.blockWidth-x>=d+p&&(x=0)),w=Math.floor(d/c),I=Math.floor(h/f),_=Math.floor((d+p+x-1)/c),Z=Math.floor((h+m+x-1)/f),S=l[t]){e.next=9;break}return e.abrupt("return",null);case 9:if(R=S.minRow,C=S.minCol,T=S.maxCol,F=S.maxRow,0!==v||!(Z<R||_<C||I>F||w>T)){e.next=12;break}return e.abrupt("return",null);case 12:for(M=new Array,P=!1,D=null==this.ioConfig.allowPartialFill?a.allowPartialFill:this.ioConfig.allowPartialFill,O=I;O<=Z;O++)for(B=w;B<=_;B++)E=B,!a.disableWrapAround&&v&&(0,y.pC)(g)&&b<=B&&(E=B-b-k),O>=R&&E>=C&&F>=O&&T>=E?function(){var e=L._fetchRawTile(t,O,E,a);D?M.push(new Promise((function(t){e.then((function(e){return t(e)})).catch((function(){P=!0,t(null)}))}))):M.push(e)}():M.push(Promise.resolve(null));if(0!==M.length){e.next=18;break}return e.abrupt("return",null);case 18:return e.next=20,Promise.all(M);case 20:return z=e.sent,H={height:(Z-I+1)*f,width:(_-w+1)*c},N=this.rasterInfo.spatialReference,J=this.getPyramidPixelSize(t),W=J.x,A=J.y,e.abrupt("return",{extent:new K.Z({xmin:o.x+w*c*W,xmax:o.x+(_+1)*c*W,ymin:o.y-(Z+1)*f*A,ymax:o.y-I*f*A,spatialReference:N}),pixelBlocks:z,mosaicSize:H,isPartiallyFilled:P});case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_fetchRawTile",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);var s=i.minRow,o=i.minCol,l=i.maxCol,u=i.maxRow;if(t<s||r<o||t>u||r>l)return Promise.resolve(null);var c=(0,G.Rq)(this.url,n.sliceId),f="".concat(e,"/").concat(t,"/").concat(r),d=(0,G.Qg)(c,n.registryId,f);if((0,y.Wi)(d)){var h=new AbortController;d=this.fetchRawTile(e,t,r,(0,a.Z)((0,a.Z)({},n),{},{signal:h.signal})),(0,G.gX)(c,n.registryId,f,d,h),d.catch((function(){return(0,G.Gc)(c,n.registryId,f)}))}return n.signal&&(0,x.fu)(n,(function(){(0,G.OE)(c,n.registryId,f)})),d}},{key:"_computeMagDirValues",value:function(e){var t,r=this.rasterInfo,n=r.bandCount,i=r.dataType;if((2!==n||"vector-magdir"!==i)&&"vector-uv"!==i||2!==(null===e||void 0===e?void 0:e.length)||null===(t=e[0])||void 0===t||!t.length)return null;var a=e[0].length;if("vector-magdir"===i){var s=e[1].map((function(e){return(e+360)%360}));return[e[0],s]}for(var o=(0,F.Z)(e,2),l=o[0],u=o[1],c=[],f=[],d=0;d<a;d++){var h=(0,Q.Tg)([l[d],u[d]]),p=(0,F.Z)(h,2),m=p[0],v=p[1];c.push(m),f.push(v)}return[c,f]}},{key:"_getRasterTileAlignmentInfo",value:function(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=(0,X.P_)(this.rasterInfo)),(0,y.Wi)(this._rasterTileAlighmentInfo.pyramidsInfo)?null:(0,a.Z)({startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform},this._rasterTileAlighmentInfo.pyramidsInfo[e])}},{key:"_getSourceDataInfo",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i={datumTransformation:n.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0};n.srcResolution&&(i.srcResolution=n.srcResolution,this._updateSourceDataInfo(e,i));var a=this.rasterInfo.storageInfo.maximumPyramidLevel||0,s=i.srcWidth,o=i.srcHeight,l=i.pyramidLevel,u=s/t,c=o/r,f=l<a&&u*c>=16,d=l===a&&this._requireTooManySrcTiles(s,o,t,r);if(f||d||0===s||0===o){var h=new $.Z({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/r,spatialReference:e.spatialReference}),p=(0,X.VO)(h,this.rasterInfo.spatialReference,e,i.datumTransformation),m=!p||n.srcResolution&&p.x+p.y<n.srcResolution.x+n.srcResolution.y;if(f&&n.srcResolution&&m){var v=Math.round(Math.log(Math.max(u,c))/Math.LN2)-1;if(a-l+3>=v){var y=Math.pow(2,v);p={x:n.srcResolution.x*y,y:n.srcResolution.y*y}}}p&&(i.srcResolution=p,this._updateSourceDataInfo(e,i))}return this._requireTooManySrcTiles(i.srcWidth,i.srcHeight,t,r)&&(i.srcWidth=0,i.srcHeight=0),i}},{key:"_requireTooManySrcTiles",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.tileInfo;return Math.ceil(e/i.size[0])*Math.ceil(t/i.size[1])>=256||e/r>8||t/n>8}},{key:"_updateSourceDataInfo",value:function(e,t){t.srcWidth=0,t.srcHeight=0;var r=this.rasterInfo.spatialReference,n=t.srcResolution,i=t.datumTransformation,a=(0,X.kr)(n,this.rasterInfo,this.ioConfig.sampling),s=a.pyramidLevel,o=a.pyramidResolution;if(!a.excessiveReading){var l=t.srcExtent||(0,X.tB)(e,r,i);if(null!=l){var u=(0,y.Wg)(this.rasterInfo.transform);u&&(l=u.inverseTransform(l)),t.srcExtent=l;var c=Math.ceil((l.xmax-l.xmin)/o.x-.1),f=Math.ceil((l.ymax-l.ymin)/o.y-.1);t.pyramidLevel=s,t.pyramidResolution=o,t.srcWidth=c,t.srcHeight=f}}}},{key:"_getRequestOptionsWithSliceId",value:function(e){return(0,y.pC)(this.rasterInfo.multidimensionalInfo)&&null==e.sliceId&&(e=(0,a.Z)((0,a.Z)({},e),{},{sliceId:this.getSliceIndex(e.multidimensionalDefinition)})),e}},{key:"_processIdentifyResult",value:function(e,t){var r=t.srcLocation,n=t.position,i=t.pyramidLevel,s=t.useTransposedTile,o=e.pixels[0].length/e.width/e.height;if(e.mask&&!e.mask[n])return{location:r,value:null};var l=this.rasterInfo.multidimensionalInfo;if((0,y.Wi)(l)||!s){var u=e.pixels.map((function(e){return e[n]})),c={location:r,value:u,pyramidLevel:i},f=this._computeMagDirValues(u.map((function(e){return[e]})));return null!==f&&void 0!==f&&f.length&&(c.magdirValue=f.map((function(e){return e[0]}))),c}var d=e.pixels.map((function(e){return e.slice(n*o,n*o+o)})),h=this._computeMagDirValues(d),p=t.requestSomeSlices,m=t.identifyOptions,v=(0,j.MO)(l,m.transposedVariableName);if(p){var g,x=(0,j.Ur)(v,(0,y.Wg)(m.multidimensionalDefinition),(0,y.Wg)(m.timeExtent));d=d.map((function(e){return x.map((function(t){return e[t]}))})),h=null===(g=h)||void 0===g?void 0:g.map((function(e){return x.map((function(t){return e[t]}))})),v=x.map((function(e){return v[e]}))}var b,k=e.noDataValues||this.rasterInfo.noDataValue,w={pixels:d,pixelType:e.pixelType};return(0,y.pC)(k)&&((0,U.A)(w,k),b=w.mask),{location:r,value:null,dataSeries:v.map((function(e,t){var r,n,i={value:0===(null===(r=b)||void 0===r?void 0:r[t])?null:d.map((function(e){return e[t]})),multidimensionalDefinition:e.multidimensionalDefinition.map((function(e){return new B.Z((0,a.Z)((0,a.Z)({},e),{},{isSlice:!0}))}))};return null!==(n=h)&&void 0!==n&&n.length&&(i.magdirValue=[h[0][t],h[1][t]]),i})),pyramidLevel:i}}}]),r}((0,A.v)(W.wq));(0,d._)([(0,k.Cb)()],ee.prototype,"_rasterTileAlighmentInfo",void 0),(0,d._)([(0,k.Cb)({readOnly:!0})],ee.prototype,"_isGlobalWrappableSource",null),(0,d._)([(0,k.Cb)(O.HQ)],ee.prototype,"url",null),(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],ee.prototype,"datasetName",void 0),(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],ee.prototype,"datasetFormat",void 0),(0,d._)([(0,k.Cb)()],ee.prototype,"hasUniqueSourceStorageInfo",void 0),(0,d._)([(0,k.Cb)()],ee.prototype,"rasterInfo",void 0),(0,d._)([(0,k.Cb)()],ee.prototype,"ioConfig",void 0),(0,d._)([(0,k.Cb)()],ee.prototype,"sourceJSON",void 0);var te=ee=(0,d._)([(0,Z.j)("esri.layers.support.rasterDatasets.BaseRaster")],ee),re=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="Function",e.tileType="Raster",e.rasterFunction=null,e}return(0,o.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d,h,p=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return s=this.rasterFunction,null!==(r=this.primaryRasters)&&void 0!==r&&null!==(i=r.rasters)&&void 0!==i&&i.length?s.sourceRasters=this.primaryRasters.rasters:this.primaryRasters=s.getPrimaryRasters(),o=this.primaryRasters,l=o.rasters,u=o.rasterIds,c=l.map((function(e){return e.rasterInfo?void 0:e.open(t)})),e.next=7,Promise.all(c);case 7:if(f=l.map((function(e){return e.rasterInfo})),(d=s.bind({rasterInfos:f,rasterIds:u})).success&&0!==f.length){e.next=10;break}throw new m.Z("raster-function:open","cannot bind the function: ".concat(null!==(a=d.error)&&void 0!==a?a:""));case 10:return e.next=12,this.syncJobHandler();case 12:h=f[0],this.hasUniqueSourceStorageInfo=1===f.length||f.slice(1).every((function(e){return p._hasSameStorageInfo(e,h)})),this.set("sourceJSON",l[0].sourceJSON),this.set("rasterInfo",s.rasterInfo);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"syncJobHandler",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(){var t;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null===(t=this.rasterJobHandler)||void 0===t?void 0:t.updateRasterFunction(this.rasterFunction));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var s,o,l,u,c,f,d,h,p,m,v,g=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l=g.length>3&&void 0!==g[3]?g[3]:{},u=this.primaryRasters,c=u.rasters,f=u.rasterIds,d=c.map((function(e){return e.fetchPixels(t,r,i,l)})),e.next=7,Promise.all(d);case 7:if(h=e.sent,p=h.map((function(e){return e.pixelBlock})),!l.skipRasterFunction&&!p.every((function(e){return(0,y.Wi)(e)}))){e.next=11;break}return e.abrupt("return",h[0]);case 11:if(m=null!==(s=null===(o=h.find((function(e){return(0,y.pC)(e.pixelBlock)})))||void 0===o?void 0:o.extent)&&void 0!==s?s:t,!this.rasterJobHandler){e.next=18;break}return e.next=15,this.rasterJobHandler.process({extent:m,primaryPixelBlocks:p,primaryRasterIds:f});case 15:e.t0=e.sent,e.next=19;break;case 18:e.t0=this.rasterFunction.process({extent:m,primaryPixelBlocks:p,primaryRasterIds:f});case 19:return v=e.t0,e.abrupt("return",(0,a.Z)((0,a.Z)({},h[0]),{},{pixelBlock:v}));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_hasSameStorageInfo",value:function(e,t){var r=e.storageInfo,n=e.pixelSize,i=e.spatialReference,a=e.extent,s=t.storageInfo,o=t.pixelSize,l=t.spatialReference,u=t.extent;return n.x===o.x&&n.y===o.y&&i.equals(l)&&a.equals(u)&&r.blockHeight===s.blockHeight&&r.blockWidth===s.blockWidth&&r.maximumPyramidLevel===s.maximumPyramidLevel}}]),r}(te);(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],re.prototype,"datasetFormat",void 0),(0,d._)([(0,k.Cb)()],re.prototype,"tileType",void 0),(0,d._)([(0,k.Cb)()],re.prototype,"rasterFunction",void 0),(0,d._)([(0,k.Cb)()],re.prototype,"primaryRasters",void 0);var ne=re=(0,d._)([(0,Z.j)("esri.layers.support.rasterDatasets.FunctionRaster")],re),ie=r(68312),ae=r(73425),se=r(43238),oe=r(55185),le=r(78952),ue=v.Z.getLogger("esri.layers.mixins.ImageryTileMixin"),ce=r(6061),fe=r(29598),de=r(71684),he=r(56811),pe=r(99063),me=r(83040),ve=r(60117),ye=r(86200),ge=r(17061);function xe(e){var t=e.fields,r=e.records,n=t.some((function(e){return"oid"===e.name.toLowerCase()}))?"OBJECTID":"OID",i=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((function(e){return{name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}}))),a=i.map((function(e){return e.name})),s=[],o=0,l=0;return r.forEach((function(e){var t={};for(t[n]=o++,l=1;l<a.length;l++)t[a[l]]=e[l-1];s.push({attributes:t})})),{displayFieldName:"",fields:i,features:s}}var be=function(){function e(){(0,s.Z)(this,e)}return(0,o.Z)(e,null,[{key:"supportedVersions",get:function(){return[5]}},{key:"parse",value:function(e){var t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};var n,i=t.getUint32(4,!0),a=t.getUint16(8,!0),s=t.getUint16(10,!0),o={version:r,recordCount:i,headerByteCount:a,recordByteCount:s},l=32,u=[],c=[];if(3===r){for(;13!==t.getUint8(l);)n=String.fromCharCode(t.getUint8(l+11)).trim(),u.push({name:(0,ge.f)(new Uint8Array(e,l,11)),type:n,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(n)],length:t.getUint8(l+16)}),l+=32;if(l+=1,u.length>0)for(var f=function(){var r=[];32===t.getUint8(l)?(l+=1,u.forEach((function(t){if("C"===t.type)r.push((0,ge.f)(new Uint8Array(e,l,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim()));else if("D"===t.type){var n=String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}l+=t.length})),c.push(r)):l+=s};c.length<i&&e.byteLength-l>s;)f()}return{header:o,fields:u,records:c,recordSet:xe({fields:u,records:c})}}}]),e}(),ke=r(77960),we=r(49818),Ie=new Map;Ie.set("int16","esriFieldTypeSmallInteger"),Ie.set("int32","esriFieldTypeInteger"),Ie.set("int64","esriFieldTypeInteger"),Ie.set("float32","esriFieldTypeSingle"),Ie.set("float64","esriFieldTypeDouble"),Ie.set("text","esriFieldTypeString");var _e=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).storageInfo=null,e.datasetFormat="CRF",e}return(0,o.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this.request(this.url+"/conf.json",{signal:null===t||void 0===t?void 0:t.signal});case 4:if(r=e.sent,i=r.data,this._validateHeader(i)){e.next=8;break}throw new m.Z("cloudraster:open","Invalid or unsupported conf.json.");case 8:if(this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),a=this._parseHeader(i),s=a.storageInfo,"thematic"!==(o=a.rasterInfo).dataType){e.next=15;break}return e.next=13,this._fetchAuxiliaryInformation();case 13:l=e.sent,o.attributeTable=l;case 15:this._set("storageInfo",s),this._set("rasterInfo",o),this.ioConfig.retryCount=this.ioConfig.retryCount||0;case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,d,h,p,m,v,y,g,x,b=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=b.length>3&&void 0!==b[3]?b[3]:{},s=this.rasterInfo.storageInfo.transposeInfo,o=a.transposedVariableName,!((u=(l=!(!s||!o))?0:this.rasterInfo.storageInfo.maximumPyramidLevel-t)<0)){e.next=4;break}return e.abrupt("return",null);case 4:return c=this._buildCacheFilePath(u,r,i,a.multidimensionalDefinition,o),f=this._getIndexRecordFromBundle(r,i,l),e.next=8,this.request(c,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:a.signal});case 8:if(d=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:if(h=new Uint8Array(d.data),0!==(p=this._getTileEndAndContentType(h,f)).recordSize){e.next=14;break}return e.abrupt("return",null);case 14:return e.next=16,this.request(c,{range:{from:p.position,to:p.position+p.recordSize},responseType:"array-buffer",signal:a.signal});case 16:if(m=e.sent){e.next=19;break}return e.abrupt("return",null);case 19:return v=this._getTileSize(l),y=(0,F.Z)(v,2),g=y[0],x=y[1],e.abrupt("return",this.decodePixelBlock(m.data,{width:g,height:x,planes:null,pixelType:null,returnInterleaved:l}));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_validateHeader",value:function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))}},{key:"_parseHeader",value:function(e){var t,r,n=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],i=e.bandCount,a=e.histograms,s=e.colormap,o=e.blockWidth,l=e.blockHeight,u=e.firstPyramidLevel,c=e.maximumPyramidLevel,f=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),d=e.extent.spatialReference,h=null===(t=e.geodataXform)||void 0===t?void 0:t.spatialReference,p=new le.Z(null!==d&&void 0!==d&&d.wkid||null!==d&&void 0!==d&&d.wkt?d:h),m=new K.Z({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:p}),v=new $.Z({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:p}),y=Math.round((m.xmax-m.xmin)/v.x),g=Math.round((m.ymax-m.ymin)/v.y),x=this._parseTransform(e.geodataXform),b=x?m:null;x&&(m=x.forwardTransform(m),v.x=(m.xmax-m.xmin)/y,v.y=(m.ymax-m.ymin)/g);var k,w,I,_,Z=null!==(r=e.properties)&&void 0!==r?r:{},S=e.format.toLowerCase().replace("cache/",""),R=new $.Z(e.origin.x,e.origin.y,p);if(s&&s.colors)for(k=[],w=0;w<s.colors.length;w++)I=s.colors[w],_=s.values?s.values[w]:w,k.push([_,255&I,I<<16>>>24,I<<8>>>24,I>>>24]);var C=e.LODInfos,T=[];for(w=0;w<C.levels.length;w++)T.push(new L.Z({level:C.levels[w],resolution:C.resolutions[w],scale:96/.0254*C.resolutions[w]}));var F=new N.Z({dpi:96,lods:T,format:S,origin:R,size:[o,l],spatialReference:p}),M={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},P=[{maxCol:Math.ceil(y/o)-1,maxRow:Math.ceil(g/l)-1,minCol:0,minRow:0}],D=2;if(c>0)for(w=0;w<c;w++)P.push({maxCol:Math.ceil(y/D/o)-1,maxRow:Math.ceil(g/D/l)-1,minCol:0,minRow:0}),D*=2;var O=e.mdInfo,B=null;if(O&&Z._yxs){var E=Z._yxs;B={packetSize:E.PacketSize,tileSize:[E.TileXSize,E.TileYSize]}}return{storageInfo:M,rasterInfo:new ye.Z({width:y,height:g,pixelType:n,bandCount:i,extent:m,nativeExtent:b,transform:x,spatialReference:p,pixelSize:v,keyProperties:Z,statistics:f,histograms:a,multidimensionalInfo:O,colormap:k,storageInfo:new q.Z({blockWidth:o,blockHeight:l,pyramidBlockWidth:o,pyramidBlockHeight:l,origin:R,tileInfo:F,transposeInfo:B,firstPyramidLevel:u,maximumPyramidLevel:c,blockBoundary:P})})}}},{key:"_parseTransform",value:function(e){var t,r;if(!(0,ke.j)(e))throw new m.Z("cloudraster:open","the data contains unsupported geodata transform types");var n=(0,ke.c)(e);if("identity"===n.type)return null;if("polynomial"!==n.type||null===(t=n.forwardCoefficients)||void 0===t||!t.length||null===(r=n.inverseCoefficients)||void 0===r||!r.length)throw new m.Z("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return n}},{key:"_fetchAuxiliaryInformation",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.request(this.url+"/conf.vat.json",{signal:t}).then((function(e){return e.data})).catch((function(){return null})),i=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:t}).then((function(e){return e.data})).catch((function(){return null})),e.next=4,Promise.all([r,i]);case 4:return(a=e.sent)[0]&&(o=a[0].fields,l=a[0].values,o&&l&&(o=o.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":Ie.get(e.type),name:e.name,alias:e.alias||e.name}})),u=l.map((function(e){return{attributes:e}})),o&&l&&(s={fields:o,features:u}))),!s&&a[1]&&(s=be.parse(a[1]).recordSet),e.abrupt("return",we.Z.fromJSON(s));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_buildCacheFilePath",value:function(e,t,r,n,i){var a=this._getPackageSize(!!i),s=Math.floor(t/a)*a,o=Math.floor(r/a)*a,l="R"+this._toHexString4(s)+"C"+this._toHexString4(o),u="L";u+=e>=10?e.toString():"0"+e.toString();var c=this.rasterInfo.multidimensionalInfo,f=null===n||void 0===n?void 0:n[0];if((0,y.Wi)(c)||!f)return"".concat(this.url,"/_alllayers/").concat(u,"/").concat(l,".bundle");var d="_yxs";if(!i){d=c.variables.find((function(e){return e.name===f.variableName})).dimensions[0].values.indexOf(f.values[0]).toString(16);for(var h=4-d.length,p=0;p<h;p++)d="0"+d;d="S"+d}var m=this._getVariableFolderName(i||f.variableName);return"".concat(this.url,"/_alllayers/").concat(m,"/").concat(d,"/").concat(u,"/").concat(l,".bundle")}},{key:"_getPackageSize",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=this.rasterInfo.storageInfo.transposeInfo;return t&&(0,y.pC)(r)?null!==(e=r.packetSize)&&void 0!==e?e:0:this.storageInfo.packetSize}},{key:"_getTileSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.rasterInfo.storageInfo,r=t.transposeInfo;return e&&(0,y.pC)(r)?r.tileSize:t.tileInfo.size}},{key:"_getVariableFolderName",value:function(e){return""===(e=e.trim())?"_v":e.replace(/[\{|\}\-]/g,"_").replace("\\*","_v")}},{key:"_getIndexRecordFromBundle",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._getPackageSize(r),i=n*(e%n)+t%n;if(i<0)throw new Error("Invalid level / row / col");return 20+i*this.storageInfo.recordSize+44}},{key:"_getTileEndAndContentType",value:function(e,t){var r,n=e.subarray(t,t+8),i=0;for(r=0;r<5;r++)i|=(255&n[r])<<8*r;var a=0xffffffffff&i;for(i=0,r=5;r<8;r++)i|=(255&n[r])<<8*(r-5);return{position:a,recordSize:0xffffffffff&i}}},{key:"_toHexString4",value:function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t}}]),r}(te);(0,d._)([(0,k.Cb)({readOnly:!0})],_e.prototype,"storageInfo",void 0),(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],_e.prototype,"datasetFormat",void 0);var Ze=_e=(0,d._)([(0,Z.j)("esri.layers.support.rasterDatasets.CloudRaster")],_e),Se=r(93169),Re=r(21449),Ce=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).datasetFormat="MEMORY",e.data=null,e}return(0,o.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d,h,p,m,v,y,g,x,b;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return a=this.data,s=this.data,o=s.pixelBlock,l=s.statistics,u=s.histograms,c=s.name,f=s.keyProperties,d=s.nativeExtent,h=s.transform,p=o.width,m=o.height,v=o.pixelType,y=null!==(r=a.extent)&&void 0!==r?r:new K.Z({xmin:-.5,ymin:.5,xmax:p-.5,ymax:m-.5,spatialReference:new le.Z({wkid:3857})}),g=null!==(i=a.isPseudoSpatialReference)&&void 0!==i?i:!a.extent,x={x:y.width/p,y:y.height/m},b=new ye.Z({width:p,height:m,pixelType:v,extent:y,nativeExtent:d,transform:h,pixelSize:x,spatialReference:y.spatialReference,bandCount:o.pixels.length,keyProperties:f||{},statistics:l,isPseudoSpatialReference:g,histograms:u}),this.createRemoteDatasetStorageInfo(b,512,512),this._set("rasterInfo",b),this.updateTileInfo(),e.next=8,this._buildInMemoryRaster(o,{width:512,height:512},t);case 8:this.datasetName=c,this.url="/InMemory/"+c;case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=this._pixelBlockTiles.get("".concat(e,"/").concat(t,"/").concat(r));return Promise.resolve(n)}},{key:"_buildInMemoryRaster",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,d;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.rasterInfo.storageInfo.maximumPyramidLevel,l=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:t,tileSize:r,maximumPyramidLevel:o},i):Promise.resolve((0,Y.Vl)(t,r,o)),u=(0,y.pC)(this.rasterInfo.statistics),c=(0,y.pC)(this.rasterInfo.histograms),f=u?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},i):Promise.resolve((0,Re.Hv)(t)),e.next=7,(0,x.as)([l,f]);case 7:if((d=e.sent)[0].value||!d[1].value){e.next=10;break}throw new m.Z("inmemory-raster:open","failed to build in memory raster");case 10:this._pixelBlockTiles=d[0].value,u||(this.rasterInfo.statistics=null===(a=d[1].value)||void 0===a?void 0:a.statistics),c||(this.rasterInfo.histograms=null===(s=d[1].value)||void 0===s?void 0:s.histograms);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(te);(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],Ce.prototype,"datasetFormat",void 0),(0,d._)([(0,k.Cb)()],Ce.prototype,"data",void 0);var Te=Ce=(0,d._)([(0,Z.j)("esri.layers.support.rasterDatasets.InMemoryRaster")],Ce);function Fe(e,t){if(!e||!t)return[];var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=[];if(t){for(var i=Fe(e,r),a=0;a<i.length;a++)Fe(i[a],t).forEach((function(e){return n.push(e)}));return n}var s=e.getElementsByTagNameNS("*",r);if(!s||0===s.length)return[];for(var o=0;o<s.length;o++)n.push(s[o]||s.item[o]);return n}function Me(e,t){if(!e||!t)return null;var r=t;t.includes("/")?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=Fe(e,r);return n.length>0?t?Me(n[0],t):n[0]:null}function Pe(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=r?Me(e,r):e;return n?(t=n.textContent||n.nodeValue)?t.trim():null:null}function De(e,t){return function(e,t){for(var r,n=Fe(e,t),i=[],a=0;a<n.length;a++)(r=n[a].textContent||n[a].nodeValue)&&""!==(r=r.trim())&&i.push(r);return i}(e,t).map((function(e){return Number(e)}))}function Oe(e,t){var r=Pe(e,t);return Number(r)}function Be(e,t){var r,n=null===e||void 0===e||null===(r=e.nodeName)||void 0===r?void 0:r.toLowerCase(),i=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===i}var Ee=r(69405);function ze(e,t){if(!e||!t)return null;for(var r=[],n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function He(e){if(!e)return null;var t=Number(e);if(!isNaN(t)&&0!==t)return new le.Z({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;var r=e.indexOf("VERTCS"),n=e.indexOf("PROJCS"),i=n>-1?n:e.indexOf("GEOGCS");if(-1===i)return null;var a=e.slice(i,e.lastIndexOf("]",r)+1).trim(),s=e.slice(r,e.lastIndexOf("]")).trim();t=Ne(a);var o=new le.Z(t?{wkid:t}:{wkt:a}),l=Ne(s);return l&&(o.vcsWkid=l),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=Ne(e),new le.Z(0!==t?{wkid:t}:{wkt:e})):null}function Ne(e){var t,r=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((function(e){return e.trim()})).filter((function(e){return""!==e})),n=r[r.length-1].split(","),i=null===(t=n[0])||void 0===t?void 0:t.toLowerCase();if(("epsg"===i||"esri"===i)&&e.endsWith('"]]')){var a=Number(n[1]);if(!isNaN(a)&&0!==a)return a}return 0}function Je(e){var t;if("pamdataset"!==(null===e||void 0===e||null===(t=e.documentElement.tagName)||void 0===t?void 0:t.toLowerCase()))return{};var r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((function(e){if(1===e.nodeType)if(Be(e,"SRS")){if(!r.spatialReference){var t=Pe(e);r.spatialReference=He(t)}}else if(Be(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){var n=function(e){var t,r=Me(e,"GeodataXform"),n=He(Oe(r,"SpatialReference/WKID")||Pe(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};var i=null!==(t=Oe(r,"PolynomialOrder"))&&void 0!==t?t:1,a=De(r,"CoeffX/Double"),s=De(r,"CoeffY/Double"),o=De(r,"InverseCoeffX/Double"),l=De(r,"InverseCoeffY/Double"),u=ze(a,s),c=ze(o,l);return{spatialReference:n,transform:u&&c&&u.length&&c.length?new Ee.Z({spatialReference:n,polynomialOrder:i,forwardCoefficients:u,inverseCoefficients:c}):null}}(e),i=n.spatialReference,a=n.transform;r.transform=a,r.spatialReference||(r.spatialReference=i)}else Fe(e,"MDI").forEach((function(e){return r.metadata[e.getAttribute("key")]=Pe(e)}));else if(Be(e,"PAMRasterBand")){var s=function(e){var t,r,n,i,a,s=Oe(e,"NoDataValue"),o=Me(e,"Histograms/HistItem"),l=Oe(o,"HistMin"),u=Oe(o,"HistMax"),c=Oe(o,"BucketCount"),f=null===(t=Pe(o,"HistCounts"))||void 0===t?void 0:t.split("|").map((function(e){return Number(e)}));Fe(e,"Metadata/MDI").forEach((function(e){var t,s=Number(null!==(t=e.textContent)&&void 0!==t?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":r=s;break;case"STATISTICS_MAXIMUM":n=s;break;case"STATISTICS_MEAN":i=s;break;case"STATISTICS_STDDEV":a=s}}));var d=Oe(e,"Metadata/SourceBandIndex");return{noDataValue:s,histogram:null!==f&&void 0!==f&&f.length&&null!=l&&null!=u?{min:l,max:u,size:c||f.length,counts:f}:null,sourceBandIndex:d,statistics:null!=r&&null!=n?{min:r,max:n,avg:i,stddev:a}:null}}(e);null!=s.sourceBandIndex&&null==r.rasterBands[s.sourceBandIndex]?r.rasterBands[s.sourceBandIndex]=s:r.rasterBands.push(s)}}));var n=r.rasterBands;if(n.length){var i=!!n[0].statistics;r.statistics=i?n.map((function(e){return e.statistics})).filter(y.pC):null;var a=!!n[0].histogram;r.histograms=a?n.map((function(e){return e.histogram})).filter(y.pC):null}return r}var We=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){return(0,s.Z)(this,r),t.apply(this,arguments)}return(0,o.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d,h,p,m;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,e.next=7,this._fetchAuxiliaryData(t);case 7:return i=e.sent,a=i.spatialReference,s=i.statistics,o=i.histograms,l=i.transform,(u=!a)&&(a=new le.Z({wkid:3857})),(null===o||void 0===o?void 0:o.length)&&null==s&&(s=(0,Re.Oh)(o)),c=r.width,f=r.height,d=new K.Z({xmin:-.5,ymin:.5-f,xmax:c-.5,ymax:.5,spatialReference:a}),h=l?l.forwardTransform(d):d,!0,l&&(p=l.forwardCoefficients,p&&0===p[1]&&0===p[2]&&(l=null,d=h)),m=new Te({data:{extent:h,nativeExtent:d,transform:l,pixelBlock:r,statistics:s,histograms:o,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:u}}),e.next=22,m.open();case 22:m.data=null,this._set("rasterInfo",m.rasterInfo),this._inMemoryRaster=m;case 25:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url,{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 2:if(r=e.sent,i=r.data,"JPG"===(a=(0,V.y)(i).toUpperCase())||"PNG"===a||"GIF"===a||"BMP"===a){e.next=7;break}throw new m.Z("image-aux-raster:open","the data is not a supported format");case 7:return this._set("datasetFormat",a),s=a.toLowerCase(),o="gif"===s||"bmp"===s||!(0,Se.Z)("ios"),e.next=12,this.decodePixelBlock(i,{format:s,useCanvas:o,hasNoZlibMask:!0});case 12:if(null!=(l=e.sent)){e.next=15;break}throw new m.Z("image-aux-raster:open","the data cannot be decoded");case 15:return e.abrupt("return",l);case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d,h;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(0,y.Wg)(null===t||void 0===t?void 0:t.signal),s=null!==(r=this.ioConfig.skipExtensions)&&void 0!==r?r:[],o=s.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:a}),l=this.datasetFormat,c=(u="JPG"===l?"jgw":"PNG"===l?"pgw":"BMP"===l?"bpw":null)&&s.includes(u)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+u,{responseType:"text",signal:a}),e.next=8,(0,x.as)([o,c]);case 8:if(f=e.sent,null===a||void 0===a||!a.aborted){e.next=11;break}throw(0,x.zE)();case 11:return(d=Je(null===(i=f[0].value)||void 0===i?void 0:i.data)).transform||(h=f[1].value?f[1].value.data.split("\n").slice(0,6).map((function(e){return Number(e)})):null,d.transform=6===(null===h||void 0===h?void 0:h.length)?new Ee.Z({forwardCoefficients:[h[4],h[5],h[0],-h[1],h[2],-h[3]]}):null),e.abrupt("return",d);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(te);(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],We.prototype,"datasetFormat",void 0);var Ae=We=(0,d._)([(0,Z.j)("esri.layers.support.rasterDatasets.ImageAuxRaster")],We),Le=r(35995),qe=r(71466),je=r(23638),Ge=r(3089),Ue=r(38045),Ve=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments))._levelOffset=0,e._tilemapCache=null,e._slices=null,e.datasetFormat="RasterTileServer",e.tileType=null,e}return(0,o.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d,h,p,v,g,x,b,k,w,I,_,Z,S,R,C,T,M,P,D,O,B,E;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(l=t&&t.signal,!this.sourceJSON){e.next=7;break}e.t0={data:this.sourceJSON},e.next=10;break;case 7:return e.next=9,this.request(this.url,{query:{f:"json"},signal:l});case 9:e.t0=e.sent;case 10:if((u=e.t0).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),c=u.data,this.sourceJSON=c,c){e.next=15;break}throw new m.Z("imageserverraster:open","cannot initialize tiled image service, missing service info");case 15:if(c.tileInfo){e.next=17;break}throw new m.Z("imageserverraster:open","use ImageryLayer to open non-tiled image services");case 17:return this._fixScaleInServiceInfo(),f=["jpg","jpeg","png","png8","png24","png32","mixed"],this.tileType=c.cacheType,null==this.tileType&&(f.includes(c.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===c.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=null!==(r=null===(i=c.name)||void 0===i?void 0:i.slice(c.name.indexOf("/")+1))&&void 0!==r?r:"",e.next=22,this._fetchRasterInfo({signal:l});case 22:if(d=e.sent,!(0,y.Wi)(d)){e.next=25;break}throw new m.Z("image-server-raster:open","cannot initialize image service");case 25:h="Map"===this.tileType?(0,qe.d)(c.tileInfo,c):N.Z.fromJSON(c.tileInfo),(0,y.O3)(h),p=this._computeMinMaxLOD(d,h),v=(0,F.Z)(p,2),g=v[0],x=v[1],b=d.extent,k=d.pixelSize,w=.5/d.width*k.x,I=Math.max(k.x,k.y),_=h.lods,("Map"!==this.tileType&&0!==c.maxScale||Math.abs(k.x-k.y)>w||!_.some((function(e){return Math.abs(e.resolution-I)<w})))&&(k.x=k.y=g.resolution,d.width=Math.ceil((b.xmax-b.xmin)/k.x-.1),d.height=Math.ceil((b.ymax-b.ymin)/k.y-.1)),Z=g.level-x.level,S=(0,F.Z)(h.size,2),R=S[0],C=S[1],T=[],M=[],_.forEach((function(e,t){e.level>=x.level&&e.level<=g.level&&T.push({x:e.resolution,y:e.resolution}),t<_.length-1&&M.push(Math.round(10*e.resolution/_[t+1].resolution)/10)})),T.sort((function(e,t){return e.x-t.x})),P=this.computeBlockBoundary(b,R,C,h.origin,T,Z),D=T.length>1?T.slice(1):null,c.transposeInfo&&(O={tileSize:[c.transposeInfo.rows,c.transposeInfo.cols],packetSize:null!==(a=null===(s=d.keyProperties)||void 0===s?void 0:s._yxs.PacketSize)&&void 0!==a?a:0}),B=M.length<=1||M.length>=3&&M.slice(0,M.length-1).every((function(e){return e===M[0]}))?null!==(o=M[0])&&void 0!==o?o:2:Math.round(10/Math.pow(x.resolution/g.resolution,-1/Z))/10,d.storageInfo=new q.Z({blockWidth:h.size[0],blockHeight:h.size[1],pyramidBlockWidth:h.size[0],pyramidBlockHeight:h.size[1],pyramidResolutions:D,pyramidScalingFactor:B,compression:h.format,origin:h.origin,firstPyramidLevel:1,maximumPyramidLevel:Z,tileInfo:h,transposeInfo:O,blockBoundary:P}),this._fixGCSShift(d),this._set("rasterInfo",d),c.capabilities.toLowerCase().includes("tilemap")&&(E={tileInfo:d.storageInfo.tileInfo,parsedUrl:(0,Le.mN)(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new je.y({layer:E}));case 35:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w,I,_,Z,S,R,C,T,F,M,P,D,O=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=O.length>3&&void 0!==O[3]?O[3]:{},s=this.rasterInfo,o=s.storageInfo,l=s.extent,u=o.transposeInfo,c=(0,y.pC)(u)&&!!a.transposedVariableName,!this._slices||c||null!=a.sliceId){e.next=4;break}return e.abrupt("return",null);case 4:return f=c?0:o.maximumPyramidLevel-t+this._levelOffset,d="".concat(this.url,"/tile/").concat(f,"/").concat(r,"/").concat(i),h=this._slices?c?{variable:a.transposedVariableName}:{sliceId:a.sliceId||0}:null,e.next=9,this.request(d,{query:h,responseType:"array-buffer",signal:a.signal});case 9:if(p=e.sent,m=p.data){e.next=13;break}return e.abrupt("return",null);case 13:return v=c?u.tileSize:o.tileInfo.size,e.next=16,this.decodePixelBlock(m,{width:v[0],height:v[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType,returnInterleaved:c,noDataValue:(0,y.Wg)(this.rasterInfo.noDataValue)});case 16:if(null!=(g=e.sent)){e.next=19;break}return e.abrupt("return",null);case 19:if(x=o.blockBoundary[t],!("jpg"!==o.compression||i>x.minCol&&i<x.maxCol&&r>x.minRow&&r<x.maxRow)){e.next=22;break}return e.abrupt("return",g);case 22:return b=o.origin,k=o.blockWidth,w=o.blockHeight,I=this.getPyramidPixelSize(t),_=I.x,Z=I.y,S=Math.round((l.xmin-b.x)/_)%k,R=Math.round((l.xmax-b.x)/_)%k||k,C=Math.round((b.y-l.ymax)/Z)%w,T=Math.round((b.y-l.ymin)/Z)%w||w,F=i===x.minCol?S:0,M=r===x.minRow?C:0,P=i===x.maxCol?R:k,D=r===x.maxRow?T:w,e.abrupt("return",((0,Y.pW)(g,{x:F,y:M},{width:P-F,height:D-M}),g));case 24:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getSliceIndex",value:function(e){if(!this._slices||(0,y.Wi)(e)||0===e.length)return null;for(var t=e,r=0;r<this._slices.length;r++){var n=this._slices[r].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var r=t.find((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}));return!r||(Array.isArray(e.values[0])?"".concat(e.values[0][0],"-").concat(e.values[0][1]):e.values[0])!==(Array.isArray(r.values[0])?"".concat(r.values[0][0],"-").concat(r.values[0][1]):r.values[0])})))return r}return null}},{key:"fetchVariableStatisticsHistograms",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,a,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.request(this.url+"/statistics",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.statistics})),a=this.request(this.url+"/histograms",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),e.next=4,Promise.all([i,a]);case 4:return s=e.sent,e.abrupt("return",(s[0]&&s[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:s[0]||null,histograms:s[1]||null}));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"computeBestPyramidLevelForLocation",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]?u[1]:{},this._tilemapCache){e.next=3;break}return e.abrupt("return",0);case 3:if(null!==(i=this.identifyPixelLocation(t,0,(0,y.Wg)(r.datumTransformation)))){e.next=6;break}return e.abrupt("return",null);case 6:a=0,s=this.rasterInfo.storageInfo.maximumPyramidLevel,o=s-a+this._levelOffset,l=i.srcLocation;case 10:if(!(o>=0)){e.next=25;break}return e.prev=11,e.next=14,this._tilemapCache.fetchAvailability(o,i.row,i.col,r);case 14:if(e.t0=e.sent,"available"!==e.t0){e.next=17;break}return e.abrupt("break",25);case 17:e.next=21;break;case 19:e.prev=19,e.t1=e.catch(11);case 21:if(o--,a++,null!==(i=this.identifyPixelLocation(l,a,(0,y.Wg)(r.datumTransformation)))){e.next=23;break}return e.abrupt("return",null);case 23:e.next=10;break;case 25:return e.abrupt("return",-1===o||null==i?null:a);case 26:case"end":return e.stop()}}),e,this,[[11,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchRasterInfo",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.sourceJSON,"Map"!==this.tileType){e.next=4;break}return i=r.fullExtent||r.extent,a=Math.ceil((i.xmax-i.xmin)/r.pixelSizeX-.1),s=Math.ceil((i.ymax-i.ymin)/r.pixelSizeY-.1),o=le.Z.fromJSON(r.spatialReference||i.spatialReference),l=new $.Z({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:o}),e.abrupt("return",new ye.Z({width:a,height:s,bandCount:3,extent:K.Z.fromJSON(i),spatialReference:o,pixelSize:l,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}}));case 4:return u=t.signal,c=(0,Ue.g)(this.url,this.sourceJSON,{signal:u,query:this.ioConfig.customFetchParameters}),f=r.hasMultidimensions?this.request("".concat(this.url,"/slices"),{query:{f:"json"},signal:u}).then((function(e){return e.data&&e.data.slices})).catch((function(){return null})):null,e.next=9,Promise.all([c,f]);case 9:return d=e.sent,e.abrupt("return",(this._slices=d[1],d[0]));case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fixScaleInServiceInfo",value:function(){var e=this.sourceJSON;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}},{key:"_fixGCSShift",value:function(e){var t=e.extent,r=e.spatialReference;t.xmin>-1&&t.xmax>181&&(null===r||void 0===r?void 0:r.wkid)&&r.isGeographic&&(e.nativeExtent=e.extent,e.transform=new Ge.Z,e.extent=e.transform.forwardTransform(t))}},{key:"_computeMinMaxLOD",value:function(e,t){var r,n,i,a=e.pixelSize,s=.5/e.width*a.x,o=t.lods,l=t.lodAt(Math.max.apply(null,o.map((function(e){return e.level})))),u=t.lodAt(Math.min.apply(null,o.map((function(e){return e.level})))),c=this.tileType;if("Map"===c)return this._levelOffset=o[0].level,[l,u];if("Raster"===c)return[null!==(i=o.find((function(e){return e.resolution===a.x})))&&void 0!==i?i:l,u];var f=this.sourceJSON,d=f.minScale,h=f.maxScale,p=l;h>0&&(p=o.find((function(e){return Math.abs(e.scale-h)<s})),p||(p=null!==(r=o.filter((function(e){return e.scale>h})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0])&&void 0!==r?r:l));var m=u;return d>0&&(m=null!==(n=o.find((function(e){return Math.abs(e.scale-d)<s})))&&void 0!==n?n:u,this._levelOffset=m.level-u.level),[p,m]}}]),r}(te);(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],Ve.prototype,"datasetFormat",void 0),(0,d._)([(0,k.Cb)()],Ve.prototype,"tileType",void 0);var Ye=Ve=(0,d._)([(0,Z.j)("esri.layers.support.rasterDatasets.ImageServerRaster")],Ve),Xe=r(96212),Qe=r(60263),Ke=new Map;Ke.set("Int8","s8"),Ke.set("UInt8","u8"),Ke.set("Int16","s16"),Ke.set("UInt16","u16"),Ke.set("Int32","s32"),Ke.set("UInt32","u32"),Ke.set("Float32","f32"),Ke.set("Float64","f32"),Ke.set("Double64","f32");var $e=new Map;$e.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),$e.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),$e.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),$e.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});var et=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._storageIndex=null,e.datasetFormat="MRF",e}return(0,o.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w,I,_,Z;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),i=t?(0,y.Wg)(t.signal):null,e.next=6,this.request(this.url,{responseType:"xml",signal:i});case 6:if(a=e.sent,s=this._parseHeader(a.data),o=s.rasterInfo,l=s.files,-1!==(null===(r=this.ioConfig.skipExtensions)||void 0===r?void 0:r.indexOf("aux.xml"))){e.next=15;break}return e.next=13,this._fetchAuxiliaryData(t);case 13:null!=(c=e.sent)&&(o.statistics=null!==(u=c.statistics)&&void 0!==u?u:o.statistics,o.histograms=c.histograms,c.histograms&&(0,y.Wi)(o.statistics)&&(o.statistics=(0,Re.Oh)(c.histograms)));case 15:return this._set("rasterInfo",o),this._files=l,e.next=18,this.request(l.index,{responseType:"array-buffer",signal:i});case 18:for(f=e.sent,this._storageIndex=this._parseIndex(f.data),d=this.rasterInfo.storageInfo,h=d.blockWidth,p=d.blockHeight,m=this.rasterInfo.storageInfo.pyramidScalingFactor,v=this.rasterInfo,g=v.width,x=v.height,b=[],k=this._getBandSegmentCount(),w=0,I=-1;w<this._storageIndex.length;)I++,_=Math.ceil(g/h/Math.pow(m,I))-1,Z=Math.ceil(x/p/Math.pow(m,I))-1,w+=(_+1)*(Z+1)*k*4,b.push({maxRow:Z,maxCol:_,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=b,I>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=I),this.updateTileInfo();case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w,I,_,Z,S,R,C,T,F,M,P,D,O,B,E=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=E.length>3&&void 0!==E[3]?E[3]:{},s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.blockBoundary,!(!(c=u[t])||c.maxRow<r||c.maxCol<i||c.minRow>r||c.minCol>i)){e.next=4;break}return e.abrupt("return",null);case 4:if(f=this.rasterInfo,d=f.bandCount,h=f.pixelType,p=this._getTileLocation(t,r,i),m=p.ranges,v=p.actualTileWidth,g=p.actualTileHeight,m&&0!==m.length){e.next=7;break}return e.abrupt("return",null);case 7:if(0!==m[0].from||0!==m[0].to){e.next=10;break}return x=new Uint8Array(o*l),e.abrupt("return",new Xe.Z({width:o,height:l,pixels:null,mask:x,validPixelCount:0}));case 10:for(b=this.ioConfig.bandIds,k=this._getBandSegmentCount(),w=[],I=0,I=0;I<k;I++)(!b||b.indexOf[I]>-1)&&w.push(this.request(this._files.data,{range:{from:m[I].from,to:m[I].to},responseType:"array-buffer",signal:a.signal}));return e.next=15,Promise.all(w);case 15:for(_=e.sent,Z=_.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),S=new Uint8Array(Z),R=0,I=0;I<k;I++)S.set(new Uint8Array(_[I].data),R),R+=_[I].data.byteLength;return C=$e.get(this.rasterInfo.storageInfo.compression).decoderFormat,e.next=23,this.decodePixelBlock(S.buffer,{width:o,height:l,format:C,planes:(null===b||void 0===b?void 0:b.length)||d,pixelType:h});case 23:if(null!=(T=e.sent)){e.next=26;break}return e.abrupt("return",null);case 26:if((0,y.pC)(this.rasterInfo.noDataValue)&&"lerc"!==C&&!T.mask&&null!=(F=this.rasterInfo.noDataValue[0])){if(M=T.width*T.height,P=new Uint8Array(M),Math.abs(F)>1e24)for(I=0;I<M;I++)Math.abs((T.pixels[0][I]-F)/F)>1e-6&&(P[I]=1);else for(I=0;I<M;I++)T.pixels[0][I]!==F&&(P[I]=1);T.mask=P}if(D=0,O=0,v!==o||g!==l)if(B=T.mask)for(I=0;I<l;I++)if(O=I*o,I<g)for(D=v;D<o;D++)B[O+D]=0;else for(D=0;D<o;D++)B[O+D]=0;else for(B=new Uint8Array(o*l),T.mask=B,I=0;I<g;I++)for(O=I*o,D=0;D<v;D++)B[O+D]=1;return e.abrupt("return",T);case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIndex",value:function(e){if(e.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");var t,r,n,i,a,s;if(Qe.f){for(r=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),n=new Uint8Array(i),a=0;a<e.byteLength/4;a++)for(s=0;s<4;s++)n[4*a+s]=r[4*a+3-s];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}},{key:"_getBandSegmentCount",value:function(){return $e.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}},{key:"_getTileLocation",value:function(e,t,r){var n,i,a,s=this.rasterInfo.storageInfo,o=s.blockWidth,l=s.blockHeight,u=s.pyramidScalingFactor,c=this.rasterInfo,f=c.width,d=c.height,h=this._getBandSegmentCount(),p=0,m=0;for(a=0;a<e;a++)m=Math.pow(u,a),p+=(n=Math.ceil(f/o/m))*(i=Math.ceil(d/l/m));m=Math.pow(u,e),n=Math.ceil(f/o/m),i=Math.ceil(d/l/m),p+=t*n+r,p*=4*h;for(var v=this._storageIndex.subarray(p,p+4*h),y=0,g=0,x=[],b=0;b<h;b++)g=(y=v[4*b+0]*Math.pow(2,32)+v[4*b+1])+v[4*b+2]*Math.pow(2,32)+v[4*b+3],x.push({from:y,to:g});return{ranges:x,actualTileWidth:r<n-1?o:Math.ceil(f/m)-o*(n-1),actualTileHeight:t<i-1?l:Math.ceil(d/m)-l*(i-1)}}},{key:"_parseHeader",value:function(e){var t=Me(e,"MRF_META/Raster");if(!t)throw new m.Z("mrf:open","not a valid MRF format");var r=Me(t,"Size"),n=parseInt(r.getAttribute("x"),10),i=parseInt(r.getAttribute("y"),10),a=parseInt(r.getAttribute("c"),10),s=(Pe(t,"Compression")||"none").toLowerCase();if(!$e.has(s))throw new m.Z("mrf:open","currently does not support compression "+s);var o=Pe(t,"DataType")||"UInt8",l=Ke.get(o);if(null==l)throw new m.Z("mrf:open","currently does not support pixel type "+o);var u,c,f=Me(t,"PageSize"),d=parseInt(f.getAttribute("x"),10),h=parseInt(f.getAttribute("y"),10),p=Me(t,"DataValues");if(p&&(null!=(c=p.getAttribute("NoData"))&&(u=c.trim().split(" ").map((function(e){return parseFloat(e)})))),Me(e,"MRF_META/CachedSource"))throw new m.Z("mrf:open","currently does not support MRF referencing other data files");var v,y=Me(e,"MRF_META/GeoTags"),g=Me(y,"BoundingBox"),x=!1;if(null!=g){var b,k=parseFloat(g.getAttribute("minx")),w=parseFloat(g.getAttribute("miny")),I=parseFloat(g.getAttribute("maxx")),_=parseFloat(g.getAttribute("maxy")),Z=Pe(y,"Projection")||"",S=le.Z.WGS84;if("LOCAL_CS[]"!==Z)if(Z.toLowerCase().startsWith("epsg:")){var R=Number(Z.slice(5));isNaN(R)||0===R||(S=new le.Z({wkid:R}))}else S=null!==(b=He(Z))&&void 0!==b?b:le.Z.WGS84;else x=!0,S=new le.Z({wkid:3857});(v=new K.Z(k,w,I,_)).spatialReference=S}else x=!0,v=new K.Z({xmin:-.5,ymin:.5-i,xmax:n-.5,ymax:.5,spatialReference:new le.Z({wkid:3857})});var C=Me(e,"MRF_META/Rsets"),T=parseInt(C&&C.getAttribute("scale")||"2",10),F=v.spatialReference,M=new q.Z({origin:new $.Z({x:v.xmin,y:v.ymax,spatialReference:F}),blockWidth:d,blockHeight:h,pyramidBlockWidth:d,pyramidBlockHeight:h,compression:s,pyramidScalingFactor:T}),P=new $.Z({x:v.width/n,y:v.height/i,spatialReference:F}),D=new ye.Z({width:n,height:i,extent:v,isPseudoSpatialReference:x,spatialReference:F,bandCount:a,pixelType:l,pixelSize:P,noDataValue:u,storageInfo:M}),O=Pe(e,"datafile"),B=Pe(e,"IndexFile");return{rasterInfo:D,files:{mrf:this.url,index:B||this.url.replace(".mrf",".idx"),data:O||this.url.replace(".mrf",$e.get(s).blobExtension)}}}},{key:"_fetchAuxiliaryData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,i=r.data,e.abrupt("return",Je(i));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(te);(0,d._)([(0,k.Cb)()],et.prototype,"_files",void 0),(0,d._)([(0,k.Cb)()],et.prototype,"_storageIndex",void 0),(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],et.prototype,"datasetFormat",void 0);var tt=et=(0,d._)([(0,Z.j)("esri.layers.support.rasterIO.MRFRaster")],et),rt=r(58424),nt=r(92217),it=function(e,t){var r;return null===(r=e.get(t))||void 0===r?void 0:r.values},at=function(e,t){var r,n;return null===(r=e.get(t))||void 0===r||null===(n=r.values)||void 0===n?void 0:n[0]},st=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments))._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}return(0,o.Z)(r,[{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,s,o,l,u,c,f,d,h,p,v,g,x,b,k;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return r=t?(0,y.Wg)(t.signal):null,e.next=5,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:r});case 5:if(i=e.sent,s=i.data){e.next=9;break}throw new m.Z("tiffraster:open","failed to open url "+this.url);case 9:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf(".")),o=(0,rt.cK)(s),l=o.littleEndian,u=o.firstIFDPos,c=o.isBigTiff,f=[],e.next=13,this._readIFDs(f,s,l,u,0,c?8:4,r);case 13:if(d=this._parseIFDs(f),h=d.imageInfo,p=d.rasterInfo,v=(0,rt.ee)(f),g=(0,rt.I7)(f),this._headerInfo=(0,a.Z)({littleEndian:l,isBigTiff:c,ifds:f,pyramidIFDs:v,maskIFDs:g},h),this._set("rasterInfo",p),h.isSupported){e.next=16;break}throw new m.Z("tiffraster:open","this tiff is not supported: "+h.message);case 16:if(h.tileWidth){e.next=18;break}throw new m.Z("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");case 18:if(x=this.ioConfig.skipExtensions,(b=void 0===x?[]:x).includes("aux.xml")){e.next=24;break}return e.next=22,this._fetchAuxiliaryMetaData(t);case 22:null!=(k=e.sent)&&this._processPAMInfo(k,p);case 24:if(e.t0=b.includes("vat.dbf")||1!==p.bandCount||"u8"!==p.pixelType,e.t0){e.next=30;break}return e.next=28,this._fetchAuxiliaryTable(t);case 28:p.attributeTable=e.sent,(0,y.pC)(p.attributeTable)&&(p.keyProperties.DataType="thematic");case 30:this.updateTileInfo();case 31:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchRawTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s,o,l,u=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=u.length>3&&void 0!==u[3]?u[3]:{},null!==(a=this._headerInfo)&&void 0!==a&&a.isSupported&&!this.isBlockOutside(t,r,i)){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this._fetchRawTiffTile(t,r,i,!1,s);case 5:if(o=e.sent,!(0,y.pC)(o)||!this._headerInfo.hasMaskBand){e.next=11;break}return e.next=9,this._fetchRawTiffTile(t,r,i,!0,s);case 9:l=e.sent,(0,y.pC)(l)&&l.pixels[0]instanceof Uint8Array&&(o.mask=l.pixels[0]);case 11:return e.abrupt("return",o);case 12:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_parseIFDs",value:function(e){var t,r,n=(0,rt.FI)(e),i=n.width,s=n.height,o=n.tileWidth,l=n.tileHeight,u=n.planes,c=n.pixelType,f=n.compression,d=n.firstPyramidLevel,h=n.maximumPyramidLevel,p=n.pyramidBlockWidth,m=n.pyramidBlockHeight,v=n.tileBoundary,y=n.affine,g=n.metadata,x=He((null===(t=n.extent.spatialReference)||void 0===t?void 0:t.wkt)||(null===(r=n.extent.spatialReference)||void 0===r?void 0:r.wkid)),b=!!n.isPseudoGeographic;null==x&&(b=!0,x=new le.Z({wkid:3857}));var k=new K.Z((0,a.Z)((0,a.Z)({},n.extent),{},{spatialReference:x})),w=new $.Z(k?{x:k.xmin,y:k.ymax,spatialReference:x}:{x:0,y:0}),I=new q.Z({blockWidth:o,blockHeight:l,pyramidBlockWidth:p,pyramidBlockHeight:m,compression:f,origin:w,firstPyramidLevel:d,maximumPyramidLevel:h,blockBoundary:v}),_=new $.Z({x:(k.xmax-k.xmin)/i,y:(k.ymax-k.ymin)/s,spatialReference:x}),Z=g?{BandProperties:g.bandProperties,DataType:g.dataType}:{},S=null,R=at(e[0],"PHOTOMETRICINTERPRETATION"),C=it(e[0],"COLORMAP");if(R<=3&&(null===C||void 0===C?void 0:C.length)>3&&C.length%3==0){S=[];for(var T=C.length/3,F=0;F<T;F++)S.push([F,C[F]>>>8,C[F+T]>>>8,C[F+2*T]>>>8])}var M=new ye.Z({width:i,height:s,bandCount:u,pixelType:c,pixelSize:_,storageInfo:I,spatialReference:x,isPseudoSpatialReference:b,keyProperties:Z,extent:k,colormap:S,statistics:g?g.statistics:null});return null!==y&&void 0!==y&&y.length&&(M.nativeExtent=new K.Z({xmin:-.5,ymin:.5-s,xmax:i-.5,ymax:.5,spatialReference:x}),M.transform=new Ee.Z({polynomialOrder:1,forwardCoefficients:[y[2]+y[0]/2,y[5]-y[3]/2,y[0],y[3],-y[1],-y[4]]}),M.extent=M.transform.forwardTransform(M.nativeExtent),M.pixelSize=new $.Z({x:(k.xmax-k.xmin)/i,y:(k.ymax-k.ymin)/s,spatialReference:x}),I.origin.x=-.5,I.origin.y=.5),{imageInfo:n,rasterInfo:M}}},{key:"_processPAMInfo",value:function(e,t){var r;if(t.statistics=null!==(r=e.statistics)&&void 0!==r?r:t.statistics,t.histograms=e.histograms,e.histograms&&(0,y.Wi)(t.statistics)&&(t.statistics=(0,Re.Oh)(e.histograms)),e.transform&&(0,y.Wi)(t.transform)){t.transform=e.transform,t.nativeExtent=t.extent;var n=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new $.Z({x:(n.xmax-n.xmin)/t.width,y:(n.ymax-n.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=n}t.isPseudoSpatialReference&&e.spatialReference&&(t.spatialReference=e.spatialReference)}},{key:"_readIFDs",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,a,s){var o,l,u,c=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=c.length>5&&void 0!==c[5]?c[5]:4,l=c.length>6?c[6]:void 0,a){e.next=4;break}return e.abrupt("return",null);case 4:if(!(a>=r.byteLength||a<0)){e.next=10;break}return e.next=7,this.request(this.url,{range:{from:a+s,to:a+s+this._bufferSize},responseType:"array-buffer",signal:l});case 7:r=e.sent.data,s=a+s,a=0;case 10:return e.next=12,this._readIFD(r,i,a,s,nt.Z.TIFF_TAGS,o,l);case 12:if(u=e.sent,t.push(u.ifd),u.nextIFD){e.next=15;break}return e.abrupt("return",null);case 15:return e.next=17,this._readIFDs(t,r,i,u.nextIFD-s,s,o,l);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}()},{key:"_readIFD",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,a){var s,o,l,u,c,f,d,h,p,m,v,g,x,b,k,w,I=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=I.length>4&&void 0!==I[4]?I[4]:nt.Z.TIFF_TAGS,o=I.length>5&&void 0!==I[5]?I[5]:4,l=I.length>6?I[6]:void 0,t){e.next=5;break}return e.abrupt("return",null);case 5:if(!(u=(0,rt.vr)(t,r,i,a,s,o)).success){e.next=25;break}if(d=[],null!==(c=u.ifd)&&void 0!==c&&c.forEach((function(e){e.values||d.push(e)})),!(d.length>0)){e.next=16;break}if(h=d.map((function(e){return e.offlineOffsetSize})).filter(y.pC),p=Math.min.apply(null,h.map((function(e){return e[0]}))),!(Math.min.apply(null,h.map((function(e){return e[0]+e[1]})))-p<=this._bufferSize)){e.next=16;break}return e.next=13,this.request(this.url,{range:{from:p,to:p+this._bufferSize},responseType:"array-buffer",signal:l});case 13:m=e.sent,v=m.data,t=v,a=p,d.forEach((function(e){return(0,rt.Dq)(t,r,e,a)}));case 16:if(null===(f=u.ifd)||void 0===f||!f.has("GEOKEYDIRECTORY")){e.next=24;break}if(g=u.ifd.get("GEOKEYDIRECTORY"),!((x=null===g||void 0===g?void 0:g.values)&&x.length>4)){e.next=24;break}return b=x[0]+"."+x[1]+"."+x[2],e.next=22,this._readIFD(t,r,g.valueOffset+6-a,a,nt.Z.GEO_KEYS,2,l);case 22:k=e.sent,g.data=k.ifd,g.data&&g.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[b]});case 24:return e.abrupt("return",u);case 25:if(!u.requiredBufferSize||u.requiredBufferSize===t.byteLength){e.next=30;break}return e.next=28,this.request(this.url,{range:{from:a,to:a+u.requiredBufferSize+4},responseType:"array-buffer",signal:l});case 28:return w=e.sent,e.abrupt("return",(t=w.data).byteLength<u.requiredBufferSize?null:this._readIFD(t,r,0,a,nt.Z.TIFF_TAGS,4,l));case 30:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_fetchRawTiffTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i,a){var s,o,l,u,c,f,d,h,p,m,v,y,g,x,b,k,w,I,_,Z,S,R,C,T,F=this,M=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=M.length>4&&void 0!==M[4]?M[4]:{},o=this._getTileLocation(t,r,i,a)){e.next=4;break}return e.abrupt("return",null);case 4:return l=o.ranges,u=o.actualTileWidth,c=o.actualTileHeight,f=o.ifd,d=l.map((function(e){return F.request(F.url,{range:e,responseType:"array-buffer",signal:s.signal})})),e.next=11,Promise.all(d);case 11:if(h=e.sent,p=h.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),m=1===h.length?h[0].data:new ArrayBuffer(p),v=[0],y=[0],h.length>1)for(g=new Uint8Array(m),x=0,b=0;x<h.length;x++)k=h[x].data,g.set(new Uint8Array(k),b),v[x]=b,b+=k.byteLength,y[x]=k.byteLength;return w=this.getBlockWidthHeight(t),I=w.blockWidth,_=w.blockHeight,e.next=22,this.decodePixelBlock(m,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:f,offsets:v,sizes:y},width:I,height:_,planes:null,pixelType:null});case 22:if(null!=(Z=e.sent)){e.next=25;break}return e.abrupt("return",null);case 25:if(u!==I||c!==_)if(T=Z.mask)for(S=0;S<_;S++)if(C=S*I,S<c)for(R=u;R<I;R++)T[C+R]=0;else for(R=0;R<I;R++)T[C+R]=0;else for(T=new Uint8Array(I*_),Z.mask=T,S=0;S<c;S++)for(C=S*I,R=0;R<u;R++)T[C+R]=1;return e.abrupt("return",Z);case 27:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_getTileLocation",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=this.rasterInfo.storageInfo,a=i.firstPyramidLevel,s=i.blockBoundary,o=0===e?0:e-(a-1),l=this._headerInfo;if(!l)return null;var u=n?l.maskIFDs[o]:0===o?null===l||void 0===l?void 0:l.ifds[0]:null===l||void 0===l?void 0:l.pyramidIFDs[o-1];if(!u)return null;var c=(0,rt.If)(u,l),f=it(u,"TILEOFFSETS");if(void 0===f)return null;var d=it(u,"TILEBYTECOUNTS"),h=s[o],p=h.minRow,m=h.minCol,v=h.maxRow,y=h.maxCol;if(t>v||r>y||t<p||r<m)return null;var g=at(u,"IMAGEWIDTH"),x=at(u,"IMAGELENGTH"),b=at(u,"TILEWIDTH"),k=at(u,"TILELENGTH"),w=c?this.rasterInfo.bandCount:1,I=w*t*(y+1)+r,_=[{from:f[I],to:f[I+w-1]+d[I+w-1]-1}];if(c){for(var Z=!0,S=0;S<w;S++)if(f[I+S]+d[I+S]!==f[I+S+1]){Z=!1;break}if(!Z)for(var R=0;R<w;R++)_[R]={from:f[I+R],to:f[I+R]+d[I+R]-1}}var C=f[I],T=d[I];return null==C||null==T?null:{ranges:_,ifd:u,actualTileWidth:r===y&&g%b||b,actualTileHeight:t===v&&x%k||k}}},{key:"_fetchAuxiliaryMetaData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,i=r.data,e.abrupt("return",Je(i));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchAuxiliaryTable",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:null===t||void 0===t?void 0:t.signal});case 3:return r=e.sent,i=r.data,a=be.parse(i),e.abrupt("return",null!==a&&void 0!==a&&a.recordSet?we.Z.fromJSON(a.recordSet):null);case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(t){return e.apply(this,arguments)}}()}]),r}(te);(0,d._)([(0,k.Cb)()],st.prototype,"_files",void 0),(0,d._)([(0,k.Cb)()],st.prototype,"_headerInfo",void 0),(0,d._)([(0,k.Cb)()],st.prototype,"_bufferSize",void 0),(0,d._)([(0,k.Cb)({type:String,json:{write:!0}})],st.prototype,"datasetFormat",void 0);var ot=st=(0,d._)([(0,Z.j)("esri.layers.support.rasterDatasets.TIFFRaster")],st),lt=new Map;lt.set("CRF",{desc:"Cloud Raster Format",constructor:Ze}),lt.set("MRF",{desc:"Meta Raster Format",constructor:tt}),lt.set("TIFF",{desc:"GeoTIFF",constructor:ot}),lt.set("RasterTileServer",{desc:"Raster Tile Server",constructor:Ye}),lt.set("JPG",{desc:"JPG Raster Format",constructor:Ae}),lt.set("PNG",{desc:"PNG Raster Format",constructor:Ae}),lt.set("GIF",{desc:"GIF Raster Format",constructor:Ae}),lt.set("BMP",{desc:"BMP Raster Format",constructor:Ae});var ut=function(){function e(){(0,s.Z)(this,e)}return(0,o.Z)(e,null,[{key:"supportedFormats",get:function(){var e=new Set;return lt.forEach((function(t,r){return e.add(r)})),e}},{key:"open",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l,u,c,f,d;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.url,i=t.ioConfig,a=t.sourceJSON,null==(s=t.datasetFormat)&&r.lastIndexOf(".")&&(s=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===s||"TIF"===s?s="TIFF":"JPG"!==s&&"JPEG"!==s&&"JFIF"!==s||(s="JPG"),r.toLowerCase().includes("/imageserver")&&!r.toLowerCase().includes("/wcsserver")&&(s="RasterTileServer"),o={url:r,sourceJSON:a,datasetFormat:s,ioConfig:null!==i&&void 0!==i?i:{bandIds:null,sampling:null}},!s||!this.supportedFormats.has(s)){e.next=12;break}if("CRF"!==s||null!==i&&void 0!==i&&i.enableCRF){e.next=7;break}throw new m.Z("rasterfactory:open","cannot open raster: ".concat(r));case 7:return l=lt.get(s).constructor,u=new l(o),e.next=11,u.open({signal:t.signal});case 11:return e.abrupt("return",u);case 12:if(!s){e.next=14;break}throw new m.Z("rasterfactory:open","not a supported format "+s);case 14:return c=Array.from(lt.keys()),f=0,d=function e(){return(s=c[f++])&&("CRF"!==s||null!==i&&void 0!==i&&i.enableCRF)?(l=lt.get(s).constructor,(u=new l(o)).open({signal:t.signal}).then((function(){return u})).catch((function(){return e()}))):null},e.abrupt("return",d());case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"register",value:function(e,t,r){lt.has(e.toUpperCase())||lt.set(e.toUpperCase(),{desc:t,constructor:r})}}]),e}(),ct=r(81085),ft=function(e){(0,c.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;(0,s.Z)(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(e=t.call.apply(t,[this].concat(i)))._primaryRasters=null,e.bandIds=null,e.interpolation=null,e.legendEnabled=!0,e.isReference=null,e.listMode="show",e.sourceJSON=null,e.version=null,e.type="imagery-tile",e.operationalLayerType="ArcGISTiledImageServiceLayer",e.popupEnabled=!0,e.popupTemplate=null,e.fields=null,e}return(0,o.Z)(r,[{key:"normalizeCtorArgs",value:function(e,t){return"string"==typeof e?(0,a.Z)({url:e},t):e}},{key:"load",value:function(e){var t=this,r=(0,y.pC)(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(x.r9).then((function(){return t._openRaster(r)}))),Promise.resolve(this)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"rasterFields",get:function(){var e=[new me.Z({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})],t=this.rasterInfo,r=null===t||void 0===t?void 0:t.attributeTable,n=(0,y.pC)(r)?r.fields:null;if(n){var i=n.filter((function(e){return"oid"!==e.type&&"value"!==e.name.toLowerCase()})).map((function(e){var t=e.clone();return t.name="Raster."+e.name,t}));e=e.concat(i)}var a=null===t||void 0===t?void 0:t.dataType,s=null===t||void 0===t?void 0:t.multidimensionalInfo;if(("vector-magdir"===a||"vector-uv"===a)&&(0,y.pC)(s)){var o,l=null===(o=s.variables[0].unit)||void 0===o?void 0:o.trim(),u="Magnitude"+(l?" (".concat(l,")"):"");e.push(new me.Z({name:"Raster.Magnitude",alias:u,domain:null,editable:!1,type:"double"})),e.push(new me.Z({name:"Raster.Direction",alias:"Direction (\xb0)",domain:null,editable:!1,type:"double"}))}return e}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"readRenderer",value:function(e,t,r){var n=t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,i=(0,p.ij)(n,r)||void 0;if(null!=i)return i}},{key:"createPopupTemplate",value:function(e){return(0,ct.eZ)({fields:this.rasterFields,title:this.title},e)}},{key:"generateRasterInfo",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,a,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,w.TJ)(z.Z,t)){e.next=2;break}return e.abrupt("return",this._primaryRasters[0].rasterInfo);case 2:return e.prev=2,i={raster:this._primaryRasters[0]},this._primaryRasters.length>1&&this._primaryRasters.forEach((function(e){return i[e.url]=e})),a=(0,ie.Ue)(t.toJSON(),i),s=new ne({rasterFunction:a}),e.next=8,s.open(r);case 8:return e.abrupt("return",s.rasterInfo);case 11:return e.prev=11,e.t0=e.catch(2),e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,this,[[2,11]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"write",value:function(e,t){var n=this.raster;if(this.loaded?"RasterTileServer"===n.datasetFormat&&("Raster"===n.tileType||"Map"===n.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return(0,l.Z)((0,u.Z)(r.prototype),"write",this).call(this,e,t);if(t&&t.messages){var i="".concat(t.origin,"/").concat(t.layerContainerType||"operational-layers");t.messages.push(new m.Z("layer:unsupported","Layers (".concat(this.title,", ").concat(this.id,") of type '").concat(this.declaredClass,"' are not supported in the context of '").concat(i,"'"),{layer:this}))}return null}},{key:"_openRaster",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,s,o,l,u,c,f,d,h,p,y,g=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=!1,!this.raster){e.next=10;break}if(e.t0=this.raster.rasterInfo,e.t0){e.next=6;break}return e.next=6,this.raster.open();case 6:"Function"===this.raster.datasetFormat?(r=!0,this._primaryRasters=this.raster.primaryRasters.rasters):this._primaryRasters=[this.raster],this.url=this.raster.url,e.next=35;break;case 10:return i=this.rasterFunction,s=[this.url],i&&(0,ie.G8)(i.toJSON(),s),e.next=14,Promise.all(s.map((function(e){return ut.open({url:e,sourceJSON:g.sourceJSON,ioConfig:(0,a.Z)((0,a.Z)({sampling:"closest"},g.ioConfig),{},{customFetchParameters:g.customParameters}),signal:t})})));case 14:if(o=e.sent,l=o.findIndex((function(e){return null==e})),!(l>-1)){e.next=18;break}throw new m.Z("imagery-tile-layer:open","cannot open raster: ".concat(s[l]));case 18:if(this._primaryRasters=o,!i){e.next=34;break}return c={raster:this._primaryRasters[0]},this._primaryRasters.length>1&&this._primaryRasters.forEach((function(e){return c[e.url]=e})),f=(0,ie.Ue)(null!==(u=i.rasterFunctionDefinition)&&void 0!==u?u:i.toJSON(),c),d=new ne({rasterFunction:f}),e.prev=22,e.next=25,d.open();case 25:this.raster=d,e.next=32;break;case 28:e.prev=28,e.t1=e.catch(22),h=v.Z.getLogger(this.declaredClass),e.t1 instanceof m.Z&&h.error("imagery-tile-layer:open",e.t1.message),h.warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),this._set("rasterFunction",null),this.raster=o[0];case 32:e.next=35;break;case 34:this.raster=o[0];case 35:if(p=this.raster.rasterInfo){e.next=38;break}throw new m.Z("imagery-tile-layer:load","cannot load resources on "+this.url);case 38:this._set("rasterInfo",r?p:this._primaryRasters[0].rasterInfo),this._set("spatialReference",p.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON&&(y="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:(0,a.Z)((0,a.Z)({},this.sourceJSON),{},{minScale:0,maxScale:0}),this.read(y,{origin:"service"})),this.title||(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles((0,b.YP)((function(){return g.customParameters}),(function(e){g.raster&&(g.raster.ioConfig.customFetchParameters=e)})));case 40:case"end":return e.stop()}}),e,this,[[22,28]])})));return function(t){return e.apply(this,arguments)}}()}]),r}((0,C.h)((0,he.M)((0,ce.q)((0,fe.I)((0,T.N)(function(e){var t=function(e){(0,c.Z)(l,e);var t=(0,f.Z)(l);function l(){var e,r,n;(0,s.Z)(this,l);for(var i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return(n=t.call.apply(t,[this].concat(a)))._isConstructedFromFunctionRaster=!1,n._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},n.bandIds=null,n.copyright=null,n.interpolation="nearest",n.multidimensionalSubset=null,n.raster=null,n.rasterFunction=null,n.rasterInfo=null,n.sourceJSON=null,n.spatialReference=null,n.symbolizer=null,n._isConstructedFromFunctionRaster="Function"===(null===(e=a[0])||void 0===e||null===(r=e.raster)||void 0===r?void 0:r.datasetFormat),n}return(0,o.Z)(l,[{key:"fullExtent",get:function(){var e;return null===(e=this.rasterInfo)||void 0===e?void 0:e.extent}},{key:"multidimensionalDefinition",set:function(e){this._set("multidimensionalDefinition",e),this.updateRenderer()}},{key:"tileInfo",get:function(){var e;return null===(e=this.rasterInfo)||void 0===e?void 0:e.storageInfo.tileInfo}},{key:"url",set:function(e){this._set("url",(0,D.Nm)(e,ue))}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"convertVectorFieldData",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,a;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,y.Wi)(t)&&this.rasterInfo){e.next=2;break}return e.abrupt("return",null);case 2:return i=this._rasterJobHandler.instance,a=this.rasterInfo.dataType,e.abrupt("return",i?i.convertVectorFieldData({pixelBlock:t,dataType:a},r):(0,Q.KC)(t,a));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"createFlowMesh",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._rasterJobHandler.instance,e.abrupt("return",i?i.createFlowMesh(t,r):(0,oe.GE)(t.meshType,t.simulationSettings,t.flowData,(0,y.pC)(r.signal)?r.signal:(new AbortController).signal));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"normalizeRasterFetchOptions",value:function(e){var t,r=(null!==(t=this.rasterInfo)&&void 0!==t?t:{}).multidimensionalInfo;if((0,y.Wi)(r))return e;var n=e.multidimensionalDefinition||this.multidimensionalDefinition;!(0,y.Wi)(n)&&n.length||(n=(0,j.Tj)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));var i=e.timeExtent||this.timeExtent;if((0,y.pC)(n)&&(0,y.pC)(i)&&((0,y.pC)(i.start)||(0,y.pC)(i.end))){var s,o;n=n.map((function(e){return e.clone()}));var l=null===(s=r.variables.find((function(e){return e.name===n[0].variableName})))||void 0===s||null===(o=s.dimensions)||void 0===o?void 0:o.find((function(e){return"StdTime"===e.name})),u=n.find((function(e){return"StdTime"===e.dimensionName}));if(!l||!u)return(0,a.Z)((0,a.Z)({},e),{},{multidimensionalDefinition:null});var c=i.start,f=i.end,d=(0,y.Wi)(c)?null:c.getTime(),h=(0,y.Wi)(f)?null:f.getTime(),p=null!==d&&void 0!==d?d:h,m=null!==h&&void 0!==h?h:d;if((0,y.pC)(l.values)){var v=l.values.filter((function(e){if(Array.isArray(e)){if(p===m)return e[0]<=p&&e[1]>=p;var t=e[0]<=p&&e[1]>p||e[0]<m&&e[1]>=m,r=e[0]>=p&&e[1]<=m||e[0]<p&&e[1]>m;return t||r}return p===m?e===p:e>=p&&e<=m}));if(v.length){var g=v.sort((function(e,t){var r,n,i,a;return p===m?(null!==(r=e[0])&&void 0!==r?r:e)-(null!==(n=t[0])&&void 0!==n?n:t):Math.abs((null!==(i=e[1])&&void 0!==i?i:e)-m)-Math.abs((null!==(a=t[1])&&void 0!==a?a:t)-m)}))[0];u.values=[g]}else n=null}else if(l.hasRegularIntervals&&l.extent){var x=(0,F.Z)(l.extent,2),b=x[0],k=x[1];p>k||m<b?n=null:u.values=p===m?[p]:[Math.max(b,p),Math.min(k,m)]}}return(0,y.pC)(n)&&(0,j.nb)(n,this.multidimensionalSubset)?(0,a.Z)((0,a.Z)({},e),{},{multidimensionalDefinition:null}):(0,a.Z)((0,a.Z)({},e),{},{multidimensionalDefinition:n})}},{key:"updateRasterFunction",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(){var t,r,i,a,s,o,l,u,c,f,d,h,p,m;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("imagery-tile"===this.type&&(this.rasterFunction||this._cachedRasterFunctionJson)&&JSON.stringify(this.rasterFunction)!==JSON.stringify(this._cachedRasterFunctionJson)){e.next=2;break}return e.abrupt("return");case 2:if(!this._isConstructedFromFunctionRaster||"Function"!==this.raster.datasetFormat){e.next=5;break}return r=this.raster.rasterFunction.toJSON(),e.abrupt("return",(!this.rasterFunction&&r&&this._set("rasterFunction",z.Z.fromJSON(r)),void(this._cachedRasterFunctionJson=null===(t=this.rasterFunction)||void 0===t?void 0:t.toJSON())));case 5:if(a=this.raster,s=!1,"Function"===a.datasetFormat?(i=a.primaryRasters.rasters,a=i[0],s=!0):i=[a],!(o=this.rasterFunction)){e.next=19;break}return c={raster:a},i.length>1&&i.forEach((function(e){return c[e.url]=e})),f=(0,ie.Ue)(null!==(l=o.rasterFunctionDefinition)&&void 0!==l?l:o.toJSON(),c),(d=new ne({rasterFunction:f})).rasterJobHandler=this._rasterJobHandler.instance,e.next=15,d.open();case 15:this._cachedRasterFunctionJson=null===(u=this.rasterFunction)||void 0===u?void 0:u.toJSON(),this.raster=d,e.next=20;break;case 19:this.raster=a,this._cachedRasterFunctionJson=null;case 20:if(this._cachedRendererJson=null,s||o){e.next=22;break}return e.abrupt("return");case 22:h=this.bandIds,p=this.raster.rasterInfo.bandCount,m=null!==h&&void 0!==h&&h.length?h.some((function(e){return e>=p})):p>=3,h&&(m||"raster-stretch"!==this.renderer.type)&&this._set("bandIds",null),this._configDefaultRenderer("auto");case 24:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateRenderer",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(){var t,r,i,s,o,l,u;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.loaded,i=this.symbolizer,r&&i){e.next=3;break}return e.abrupt("return");case 3:if(s=this.raster.rasterInfo,o=null===(t=(0,j.WY)(s,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}))||void 0===t?void 0:t.name,l=(0,ae.ol)((0,a.Z)((0,a.Z)({},this.renderer.toJSON()),{},{variableName:o})),JSON.stringify(this._cachedRendererJson)!==JSON.stringify(l)){e.next=6;break}return e.abrupt("return");case 6:if(u=this._rasterJobHandler.instance,e.t0=u,!e.t0){e.next=15;break}return i.rasterInfo=(0,ae.FI)(s,o),i.rendererJSON=l,i.bind(),e.next=14,u.updateSymbolizer(i);case 14:this._cachedRendererJson=l;case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"applyRenderer",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,s,o,l,u;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t&&t.pixelBlock,(0,y.pC)(s)&&s.pixels&&s.pixels.length>0){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,this.updateRenderer();case 5:if(l=this._rasterJobHandler.instance,u=null!==(i=this.bandIds)&&void 0!==i?i:[],!l){e.next=12;break}return e.next=9,l.symbolize((0,a.Z)((0,a.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=this.symbolizer.symbolize((0,a.Z)((0,a.Z)({},t),{},{simpleStretchParams:r,bandIds:u}));case 13:return o=e.t0,e.abrupt("return",o);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getTileUrl",value:function(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(r):""}},{key:"getCompatibleTileInfo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.loaded||(0,y.Wi)(t))return null;if(r&&e.equals(this.spatialReference))return this.tileInfo;var n=(0,P.C5)(e);return N.Z.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}},{key:"getCompatibleFullExtent",value:function(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}},{key:"fetchTile",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,i,s){var o,l,u,c,f=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=f.length>3&&void 0!==f[3]?f[3]:{},r(this),!o.requestAsImageElement){e.next=4;break}return l=this.getTileUrl(t,i,s),e.abrupt("return",(0,M.default)(l,{responseType:"image",query:(0,a.Z)((0,a.Z)({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:o.signal}).then((function(e){return e.data})));case 4:if(u=this.rasterInfo,!(0,y.pC)(u.multidimensionalInfo)||(o=this.normalizeRasterFetchOptions(o),!(0,y.Wi)(o.multidimensionalDefinition))){e.next=8;break}return c=o.tileInfo||u.storageInfo.tileInfo,e.abrupt("return",{extent:this.raster.getTileExtentFromTileInfo(t,i,s,c),pixelBlock:null});case 8:return e.next=10,this._initJobHandler();case 10:return e.next=12,this.updateRasterFunction();case 12:return"raster-shaded-relief"===this.renderer.type&&(o=(0,a.Z)((0,a.Z)({},o),{},{buffer:{cols:1,rows:1}})),e.abrupt("return",this.raster.fetchTile(t,i,s,o));case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"fetchPixels",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r,i){var a,s=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=s.length>3&&void 0!==s[3]?s[3]:{},!(0,y.pC)(this.rasterInfo.multidimensionalInfo)||(a=this.normalizeRasterFetchOptions(a),!(0,y.Wi)(a.multidimensionalDefinition))){e.next=5;break}e.t0={extent:t,pixelBlock:null},e.next=10;break;case 5:return e.next=7,this._initJobHandler();case 7:return e.next=9,this.updateRasterFunction();case 9:e.t0=this.raster.fetchPixels(t,r,i,a);case 10:return e.abrupt("return",e.t0);case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"identify",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,o,l=arguments;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=l.length>1&&void 0!==l[1]?l[1]:{},a=this.raster,s=this.rasterInfo,!(0,y.pC)(s.multidimensionalInfo)){e.next=5;break}if(s.hasMultidimensionalTranspose&&((0,j.WU)(i.multidimensionalDefinition)||i.transposedVariableName||i.timeExtent)||(i=this.normalizeRasterFetchOptions(i),!(0,y.Wi)(i.multidimensionalDefinition))){e.next=5;break}return e.abrupt("return",{location:t,value:null});case 5:if(!(o=null===(r=this.multidimensionalSubset)||void 0===r?void 0:r.areaOfInterest)||o.contains(t)){e.next=8;break}throw new m.Z("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");case 8:return e.abrupt("return",a.identify(t,i));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"increaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount++}},{key:"decreaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}},{key:"hasStandardTime",value:function(){var e,t,r,n=null===(e=this.rasterInfo)||void 0===e?void 0:e.multidimensionalInfo;if((0,y.Wi)(n)||"standard-time"!==(null===(t=this.rasterInfo)||void 0===t?void 0:t.dataType))return!1;var i=this.multidimensionalDefinition,a=null===i||void 0===i||null===(r=i[0])||void 0===r?void 0:r.variableName;return n.variables.some((function(e){return e.name===a&&(!(null!==i&&void 0!==i&&i[0].dimensionName)||e.dimensions.some((function(e){return"StdTime"===e.name})))}))}},{key:"getStandardTimeValue",value:function(e){return new Date(24*(e-25569)*3600*1e3).toString()}},{key:"getMultidimensionalSubsetVariables",value:function(e){var t,r=null!==e&&void 0!==e?e:null===(t=this.rasterInfo)||void 0===t?void 0:t.multidimensionalInfo;return(0,j.jj)(this.multidimensionalSubset,r)}},{key:"_configDefaultSettings",value:function(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=(0,j.Tj)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this._configDefaultRenderer()}},{key:"_initJobHandler",value:function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new H.Z;return this._rasterJobHandler.connectionPromise=t.initialize().then((function(){r(e),e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,e.renderer&&e.updateRenderer(),"Function"===e.raster.datasetFormat&&e.raster.syncJobHandler()})).catch((function(){})),this._rasterJobHandler.connectionPromise}},{key:"_shutdownJobHandler",value:function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}},{key:"_configDefaultInterpolation",value:function(){if(null==this.interpolation){var e;r(this);var t=this.raster,n=(0,ae.In)(t.rasterInfo,t.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",n)}}},{key:"_configDefaultRenderer",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no";r(this);var n=this.raster.rasterInfo;!this.bandIds&&n.bandCount>1&&(this.bandIds=(0,ae.YD)(n));var i=null===(e=(0,j.WY)(n,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}))||void 0===e?void 0:e.name;if(!this.renderer||"override"===t){var s,o,l,u,c=(0,ae.Ob)(n,{bandIds:this.bandIds,variableName:i});"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===c.type&&((null!==(s=null===(o=n.statistics)||void 0===o?void 0:o[0].max)&&void 0!==s?s:0)>1e24||(null!==(l=null===(u=n.statistics)||void 0===u?void 0:u[0].min)&&void 0!==l?l:0)<-1e24)&&(c.dynamicRangeAdjustment=!0,c.statistics=null,"none"===c.stretchType&&(c.stretchType="min-max")),this.renderer=c}var f=(0,ae.ol)((0,a.Z)((0,a.Z)({},this.renderer.toJSON()),{},{variableName:i})),d=(0,ae.FI)(n,i);this.symbolizer?(this.symbolizer.rendererJSON=f,this.symbolizer.rasterInfo=d):this.symbolizer=new se.Z({rendererJSON:f,rasterInfo:d});var h=this.symbolizer.bind();if(h.success){if("auto"===t){var p=this.raster.rasterInfo.colormap,m=this.renderer;if((0,y.pC)(p))if("raster-colormap"!==m.type)this._configDefaultRenderer("override");else{var v=(0,ae.Ob)(this.raster.rasterInfo);JSON.stringify(v)!==JSON.stringify(m)&&this._configDefaultRenderer("override")}else if("raster-stretch"===m.type){var g,x,b=null===(g=this.bandIds)||void 0===g?void 0:g.length,k=null===(x=m.statistics)||void 0===x?void 0:x.length;!m.dynamicRangeAdjustment&&k&&b&&k!==b&&this._configDefaultRenderer("override")}}}else ue.warn("imagery-tile-mixin",h.error||"The given renderer is not supported by the layer."),"auto"===t&&this._configDefaultRenderer("override")}}]),l}(e);function r(e){if(!e.raster||!e.rasterInfo)throw new m.Z("imagery-tile","no raster")}return(0,d._)([(0,k.Cb)()],t.prototype,"_cachedRendererJson",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"_cachedRasterFunctionJson",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"_compatibleFullExtent",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"_isConstructedFromFunctionRaster",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"_rasterJobHandler",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"bandIds",void 0),(0,d._)([(0,k.Cb)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],t.prototype,"copyright",void 0),(0,d._)([(0,k.Cb)({json:{read:!1}})],t.prototype,"fullExtent",null),(0,d._)([(0,k.Cb)()],t.prototype,"interpolation",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"ioConfig",void 0),(0,d._)([(0,k.Cb)({type:[B.Z],json:{write:!0}})],t.prototype,"multidimensionalDefinition",null),(0,d._)([(0,k.Cb)({type:E.Z,json:{write:!0}})],t.prototype,"multidimensionalSubset",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"raster",void 0),(0,d._)([(0,k.Cb)({type:z.Z})],t.prototype,"rasterFunction",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"rasterInfo",void 0),(0,d._)([(0,k.Cb)()],t.prototype,"sourceJSON",void 0),(0,d._)([(0,k.Cb)({readOnly:!0,type:le.Z,json:{read:!1}})],t.prototype,"spatialReference",void 0),(0,d._)([(0,k.Cb)({json:{read:!1}})],t.prototype,"tileInfo",null),(0,d._)([(0,k.Cb)(O.HQ)],t.prototype,"url",null),(0,d._)([(0,k.Cb)({types:p.dr})],t.prototype,"renderer",null),(0,d._)([(0,k.Cb)()],t.prototype,"symbolizer",void 0),t=(0,d._)([(0,Z.j)("esri.layers.ImageryTileMixin")],t),t}((0,pe.n)((0,R.Y)((0,de.Q)((0,g.R)(S.Z)))))))))));(0,d._)([(0,k.Cb)()],ft.prototype,"_primaryRasters",void 0),(0,d._)([(0,k.Cb)({type:[w.z8],json:{write:{overridePolicy:function(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(e=this.bandIds)||void 0===e?void 0:e.join(","))}}}}})],ft.prototype,"bandIds",void 0),(0,d._)([(0,k.Cb)({json:{write:{overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,I.J)(ve.c)],ft.prototype,"interpolation",void 0),(0,d._)([(0,k.Cb)(O.rn)],ft.prototype,"legendEnabled",void 0),(0,d._)([(0,k.Cb)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],ft.prototype,"isReference",void 0),(0,d._)([(0,k.Cb)({type:["show","hide"]})],ft.prototype,"listMode",void 0),(0,d._)([(0,k.Cb)({json:{read:!0,write:!0}})],ft.prototype,"blendMode",void 0),(0,d._)([(0,k.Cb)()],ft.prototype,"sourceJSON",void 0),(0,d._)([(0,k.Cb)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],ft.prototype,"version",void 0),(0,d._)([(0,k.Cb)({readOnly:!0,json:{read:!1}})],ft.prototype,"type",void 0),(0,d._)([(0,k.Cb)({type:["ArcGISTiledImageServiceLayer"]})],ft.prototype,"operationalLayerType",void 0),(0,d._)([(0,k.Cb)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(e,t){return!t.disablePopup}},write:{target:"disablePopup",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer:function(e,t,r){t[r]=!e}}}})],ft.prototype,"popupEnabled",void 0),(0,d._)([(0,k.Cb)({type:h.Z,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:function(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],ft.prototype,"popupTemplate",void 0),(0,d._)([(0,k.Cb)({readOnly:!0})],ft.prototype,"defaultPopupTemplate",null),(0,d._)([(0,k.Cb)({readOnly:!0,type:[me.Z]})],ft.prototype,"fields",void 0),(0,d._)([(0,k.Cb)({readOnly:!0,type:[me.Z]})],ft.prototype,"rasterFields",null),(0,d._)([(0,k.Cb)({types:p.dr,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(){var e,t="raster-stretch"===(null===(e=this.renderer)||void 0===e?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:p.FK,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(e){return{enabled:e&&"vector-field"!==e.type&&"flow"!==e.type}}}}}}})],ft.prototype,"renderer",null),(0,d._)([(0,_.r)("renderer")],ft.prototype,"readRenderer",null);var dt=ft=(0,d._)([(0,Z.j)("esri.layers.ImageryTileLayer")],ft)},55635:function(e,t,r){r.d(t,{OE:function(){return p},Gc:function(){return y},Qg:function(){return m},Rq:function(){return f},gX:function(){return v},z2:function(){return d},ET:function(){return h},Vx:function(){return x}});r(59486);var n=r(92026),i=r(15671),a=r(43144),s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;(0,i.Z)(this,e),this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,r)}return(0,a.Z)(e,[{key:"decreaseRefCount",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.refCount--,i.refCount<=0&&(n.delete(r),i.controller&&i.controller.abort()),i.refCount}return 0}},{key:"getBlock",value:function(e,t){var r=e+"/"+t,n=this._cachedBlocks;if(n.has(r)){var i=n.get(r);return i.ts=Date.now(),i.refCount++,n.delete(r),n.set(r,i),i.block}return null}},{key:"putBlock",value:function(e,t,r,n){var i=this._cachedBlocks,a=e+"/"+t;if(i.has(a)){var s=i.get(a);s.ts=Date.now(),s.refCount++}else i.set(a,{block:r,ts:Date.now(),refCount:1,controller:n});this._trim(),this._updateTimer()}},{key:"deleteBlock",value:function(e,t){var r=this._cachedBlocks,n=e+"/"+t;r.has(n)&&r.delete(n)}},{key:"updateMaxSize",value:function(e){this._size=e,this._trim()}},{key:"empty",value:function(){this._cachedBlocks.clear(),this._clearTimer()}},{key:"getCurrentSize",value:function(){return this._cachedBlocks.size}},{key:"_updateTimer",value:function(){var e=this;if(null==this._timer){var t=this._cachedBlocks;this._timer=setInterval((function(){for(var r=Array.from(t),n=Date.now(),i=0;i<r.length&&r[i][1].ts<=n-e._duration;i++)t.delete(r[i][0]);0===t.size&&e._clearTimer()}),this._interval)}}},{key:"_trim",value:function(){var e=this._cachedBlocks;if(!(-1===this._size||this._size>=e.size))for(var t=Array.from(e),r=0;r<t.length-this._size;r++)e.delete(t[r][0])}},{key:"_clearTimer",value:function(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}]),e}(),o=r(80394),l=r(585),u=new Map,c=new s;function f(e,t){return null==t?e:"".concat(e,"?sliceId=").concat(t)}function d(e,t){var r={extent:null,rasterInfo:t,cache:new Map},n=u.get(e);return n?(n.push(r),n.length-1):(u.set(e,[r]),0)}function h(e,t){var r=u.get(e);r&&(r[t]=null,r.some((function(e){return null!=e}))||u.delete(e))}function p(e,t,r){var n,i=u.get(e);if(!i)return null==t?c.decreaseRefCount(e,r):0;if(null==t||null==i[t])return c.decreaseRefCount(e,r);var a=null===(n=i[t])||void 0===n?void 0:n.cache,s=null===a||void 0===a?void 0:a.get(r);if(a&&s){if(s.refCount--,0===s.refCount){a.delete(r);for(var o=0;o<i.length;o++){var l;null===(l=i[o])||void 0===l||l.cache.delete(r)}s.controller&&s.controller.abort()}return s.refCount}return 0}function m(e,t,r){var n,i=u.get(e);if(!i)return null==t?c.getBlock(e,r):null;if(null==t||null==i[t]){for(var a=0;a<i.length;a++){var s,o=null===(s=i[a])||void 0===s?void 0:s.cache.get(r);if(o)return o.refCount++,o.block}return c.getBlock(e,r)}var l=null===(n=i[t])||void 0===n?void 0:n.cache.get(r);if(l)return l.refCount++,l.block;for(var f=0;f<i.length;f++){var d;if(f!==t&&i[f]){var h=null===(d=i[f])||void 0===d?void 0:d.cache,p=null===h||void 0===h?void 0:h.get(r);if(h&&p)return p.refCount++,h.set(r,p),p.block}}return null}function v(e,t,r,n){var i,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=u.get(e);if(s)if(null!=t&&null!=s[t]){var o={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:a};n.then((function(){return o.isResolved=!0})).catch((function(){return o.isRejected=!0})),null===(i=s[t])||void 0===i||i.cache.set(r,o)}else c.putBlock(e,r,n,a);else null==t&&c.putBlock(e,r,n,a)}function y(e,t,r){var n,i=u.get(e);i?null!=t&&null!=i[t]?null===(n=i[t])||void 0===n||n.cache.delete(r):c.deleteBlock(e,r):null==t&&c.deleteBlock(e,r)}function g(e,t){var r,n=u.get(e);return n&&null!==(r=n[t])&&void 0!==r?r:null}function x(e,t,r,i,a,s){var u,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,f=g(e,t);if(f){var d=f.extent,h=f.cache,p=f.rasterInfo;if(!d||d.xmin!==r.xmin||d.xmax!==r.xmax||d.ymin!==r.ymin||d.ymax!==r.ymax){i=null!==(u=i)&&void 0!==u?u:0;for(var m=r.clone().normalize(),v=p.spatialReference,y=p.transform,x=new Set,b=0;b<m.length;b++){var k=m[b];if(!(k.xmax-k.xmin<=i||k.ymax-k.ymin<=i)){var w=(0,o.tB)(k,v,c);(0,n.pC)(y)&&(w=y.inverseTransform(w));var I=new l.Z({x:i,y:i,spatialReference:k.spatialReference});if(null==a&&!(a=(0,o.VO)(I,v,k,c)))return;var _=(0,o.kr)(a,p,s||"closest"),Z=_.pyramidLevel,S=_.pyramidResolution,R=_.excessiveReading;if(R)return;for(var C=p.storageInfo,T=C,F=T.origin,M={x:Math.max(0,Math.floor((w.xmin-F.x)/S.x)),y:Math.max(0,Math.floor((F.y-w.ymax)/S.y))},P=Math.ceil((w.xmax-w.xmin)/S.x-.1),D=Math.ceil((w.ymax-w.ymin)/S.y-.1),O=Z>0?C.pyramidBlockWidth:C.blockWidth,B=Z>0?C.pyramidBlockHeight:C.blockHeight,E=1,z=Math.max(0,Math.floor(M.x/O)-E),H=Math.max(0,Math.floor(M.y/B)-E),N=Math.floor((M.x+P-1)/O)+E,J=Math.floor((M.y+D-1)/B)+E,W=H;W<=J;W++)for(var A=z;A<=N;A++)x.add("".concat(Z,"/").concat(W,"/").concat(A))}}h.forEach((function(e,t){if(!x.has(t)){var r=h.get(t);(null==r||r.isResolved||r.isRejected)&&h.delete(t)}})),f.extent={xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax}}}}}}]);
//# sourceMappingURL=70905.aa520447.chunk.js.map