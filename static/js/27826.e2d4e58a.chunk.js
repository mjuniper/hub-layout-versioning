"use strict";(self.webpackChunkhub_layout_versioning=self.webpackChunkhub_layout_versioning||[]).push([[27826],{23254:function(e,t,r){r.d(t,{a:function(){return d}});var i=r(37762),n=r(15671),a=r(43144),s=2654435761,u=2246822519,o=3266489917,l=668265263,c=374761393;function h(e){for(var t=[],r=0,i=e.length;r<i;r++){var n=e.charCodeAt(r);n<128?t.push(n):n<2048?t.push(192|n>>6,128|63&n):n<55296||n>=57344?t.push(224|n>>12,128|n>>6&63,128|63&n):(r++,n=65536+((1023&n)<<10|1023&e.charCodeAt(r)),t.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return new Uint8Array(t)}var d=function(){function e(t){(0,n.Z)(this,e),this._seed=t,this._totallen=0,this._bufs=[],this.init()}return(0,a.Z)(e,[{key:"init",value:function(){return this._bufs=[],this._totallen=0,this}},{key:"updateFloatArray",value:function(e){var t,r=[],n=(0,i.Z)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;isNaN(a)?r.push("NaN"):a===1/0?r.push("Infinity"):a===-1/0?r.push("-Infinity"):0===a?r.push("0"):r.push(a.toString(16))}}catch(s){n.e(s)}finally{n.f()}this.update(h(r.join("")))}},{key:"updateIntArray",value:function(e){var t=Int32Array.from(e);this.update(new Uint8Array(t.buffer))}},{key:"updateUint8Array",value:function(e){this.update(Uint8Array.from(e))}},{key:"updateWithString",value:function(e){return this.update(h(e))}},{key:"update",value:function(e){return this._bufs.push(e),this._totallen+=e.length,this}},{key:"digest",value:function(){var e,t=new Uint8Array(this._totallen),r=0,n=(0,i.Z)(this._bufs);try{for(n.s();!(e=n.n()).done;){var a=e.value;t.set(a,r),r+=a.length}}catch(s){n.e(s)}finally{n.f()}return this.init(),this._xxHash32(t,this._seed)}},{key:"_xxHash32",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e,i=t+c&4294967295,n=0;if(r.length>=16){var a=[t+s+u&4294967295,t+u&4294967295,t+0&4294967295,t-s&4294967295],h=e,d=h.length-16,f=0;for(n=0;(4294967280&n)<=d;n+=4){var p=n,y=h[p+0]+(h[p+1]<<8),v=h[p+2]+(h[p+3]<<8),_=y*u+(v*u<<16),m=a[f]+_&4294967295,g=65535&(m=m<<13|m>>>19),b=m>>>16;a[f]=g*s+(b*s<<16)&4294967295,f=f+1&3}i=(a[0]<<1|a[0]>>>31)+(a[1]<<7|a[1]>>>25)+(a[2]<<12|a[2]>>>20)+(a[3]<<18|a[3]>>>14)&4294967295}i=i+e.length&4294967295;for(var F=e.length-4;n<=F;n+=4){var C=n,x=r[C+0]+(r[C+1]<<8),E=r[C+2]+(r[C+3]<<8);i=(65535&(i=(i=i+(x*o+(E*o<<16))&4294967295)<<17|i>>>15))*l+((i>>>16)*l<<16)&4294967295}for(;n<r.length;++n)i=(65535&(i=(i+=r[n]*c)<<11|i>>>21))*s+((i>>>16)*s<<16)&4294967295;return i=((65535&(i^=i>>>15))*u&4294967295)+((i>>>16)*u<<16),i=((65535&(i^=i>>>13))*o&4294967295)+((i>>>16)*o<<16),(i^=i>>>16)<0?i+4294967296:i}}]),e}()},23819:function(e,t,r){r.d(t,{H:function(){return f},b:function(){return d}});var i,n,a=r(30168),s=r(24967),u=r(64600),o=r(58406),l=r(98634),c=r(64201),h=r(19253);function d(e){var t=new c.kG;t.include(s.k),t.include(u.f);var r=e.usesHalfFloat;return t.fragment.uniforms.add([new h.A("densityMap",(function(e){return e.densityMap})),new h.A("tex",(function(e){return e.colorRamp})),new o.p("densityNormalizer",(function(e){return 1/(e.maxDensity-e.minDensity)})),new o.p("minDensity",(function(e){return e.minDensity}))]),t.fragment.uniforms.add(new o.p("densityMultiplier",(function(e){return 3/(e.searchRadius*e.searchRadius*Math.PI)}))),r&&t.constants.add("compressionFactor","float",4),t.fragment.code.add((0,l.H)(i||(i=(0,a.Z)(["\n    void main() {\n      float density = texture2D(densityMap, uv).r * densityMultiplier",";\n      float densityRatio = (density - minDensity) * densityNormalizer;\n\n      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));\n\n      discardOrAdjustAlpha(color);\n      gl_FragColor = color;\n    }\n  "])),r?(0,l.H)(n||(n=(0,a.Z)([" * compressionFactor"]))):"")),t}var f=Object.freeze(Object.defineProperty({__proto__:null,build:d},Symbol.toStringTag,{value:"Module"}))},65322:function(e,t,r){r.d(t,{H:function(){return y},b:function(){return p}});var i,n,a,s,u,o=r(30168),l=r(41012),c=r(58406),h=r(98634),d=r(64201),f=r(4760);function p(e){var t=new d.kG,r=t.vertex,p=t.fragment;(0,l.Sv)(r,e);var y=e.isAttributeDriven,v=e.usesHalfFloat;return t.attributes.add(f.T.POSITION,"vec3"),t.attributes.add(f.T.UV0,"vec2"),y&&(t.attributes.add(f.T.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),v&&t.constants.add("compressionFactor","float",.25),t.varyings.add("unitCirclePos","vec2"),r.uniforms.add(new c.p("radius",(function(e,t){var r=e.resolutionForScale,i=e.searchRadius,n=t.camera,a=t.screenToWorldRatio;return 2*i*(0===r?1:r/a)*n.pixelRatio/n.fullViewport[2]}))),r.code.add((0,h.H)(i||(i=(0,o.Z)(["\n    void main() {\n      unitCirclePos = uv0;\n\n      vec4 posProj = proj * (view * vec4(",", 1.0));\n      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);\n\n      ","\n      gl_Position = posProj + quadOffset;\n    }\n  "])),f.T.POSITION,y?(0,h.H)(n||(n=(0,o.Z)(["attributeValue = ",";"])),f.T.FEATUREATTRIBUTE):"")),p.code.add((0,h.H)(a||(a=(0,o.Z)(["\n    void main() {\n      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);\n      if (radiusRatioSquared > 1.0) {\n        discard;\n      }\n\n      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;\n      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared "," ",";\n      gl_FragColor = vec4(density);\n    }\n  "])),y?(0,h.H)(s||(s=(0,o.Z)([" * attributeValue"]))):"",v?(0,h.H)(u||(u=(0,o.Z)([" * compressionFactor"]))):"")),t}var y=Object.freeze(Object.defineProperty({__proto__:null,build:p},Symbol.toStringTag,{value:"Module"}))},5845:function(e,t,r){r.d(t,{g:function(){return G}});var i=r(37762),n=r(74165),a=r(15861),s=r(15671),u=r(43144),o=r(60136),l=r(92572),c=r(27366),h=r(85015),d=r(14921),f=r(80987),p=(r(93169),r(10064)),y=r(100),v=r(84652),_=r(32718),m=r(92026),g=r(67426),b=r(66978),F=r(94172),C=r(49861),x=(r(25243),r(69912)),E=r(61826),k=r(25899),T=r(37933),w=r(67387),R=r(33997),S=r(32080),Z=r(29439),O=r(52639),P=r(80885),V=r(43977),I=r(62554),D=r(1030),M=r(87037),A=r(62140),N=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]],U=function(){function e(t,r,i){(0,s.Z)(this,e),this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._dataExtentGraphic=null,this._enabled=!0,this._tileFetcher=t,this._view=i,this._tilingScheme=new A.t(r),this._loadedSymbols=N.map((function(e){return new D.Z(new V.Z({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}}))})),this._loadingSymbols=[new D.Z(new V.Z({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this._pendingSymbols=[new D.Z(new V.Z({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this._dataExtentSymbol=new D.Z(new V.Z({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}return(0,u.Z)(e,[{key:"destroy",value:function(){this.enabled=!1}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,this.update()}},{key:"update",value:function(){var e=this;this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:function(e){return e.isFetching},symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:function(e){return!e.isFetching},symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:function(e){return!e.isFetching},symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._loadingGraphics.clear(),this._loadedGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._loadedGraphics.clear(),this._pendingGraphics.forEach((function(t){e._view.graphics.removeMany(t)})),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}},{key:"showDataExtent",value:function(e){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),!(0,m.Wi)(e)){var t=P.Z.fromExtent(e);this._dataExtentGraphic=new O.Z({geometry:t,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}}},{key:"_synchronizeMaps",value:function(e,t){var r=this,i=[];e.forEach((function(e,n){var a=r._tileFetcher.test.getFeatureTileById(n);a&&t.filter(a)||(r._view.graphics.removeMany(e),i.push(n))})),i.forEach((function(t){return e.delete(t)})),this._tileFetcher.test.forEachFeatureTile((function(i){if(t.filter(i)&&!e.has(i.id)){var n=(0,Z.Z)(i.descriptor.lij,3),a=n[0],s=n[1],u=n[2];r._tilingScheme.ensureMaxLod(a);var o=r._tilingScheme.getExtentGeometry(a,s,u),l=[new O.Z({geometry:o,symbol:t.symbols[a%t.symbols.length]}),new O.Z({geometry:o.center,symbol:new I.Z({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new M.Z({text:"".concat(a,"/").concat(s,"/").concat(u),halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];e.set(i.id,l),r._view.graphics.addMany(l)}}))}}]),e}(),L=r(94463),G=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(e){var i;return(0,s.Z)(this,r),(i=t.call(this,e)).type="feature-tile-3d",i._watchUpdatingTracking=new E.t,i.serviceDataExtent=null,i.serviceDataCount=H.NO_SERVICE_DATA_COUNT,i.vertexLimitExceeded=!1,i.displayFeatureLimit=null,i._suspended=!1,i._tileFetcher=null,i._handles=new y.Z,i._fetchDataInfoPromise=null,i._fetchDataInfoAbortController=null,i._lifeCycleAbortController=new AbortController,i}return(0,u.Z)(r,[{key:"extent",set:function(e){if(!(0,m.pC)(e)||e.spatialReference.equals(this.layerView.view.spatialReference)){var t=this._get("extent");if(t!==e&&!((0,m.pC)(t)&&e&&t.equals(e))){var r=(0,m.pC)(e)?e.clone():null;this._set("extent",r)}}else _.Z.getLogger(this.declaredClass).error("#extent=","extent needs to be in the same spatial reference as the view")}},{key:"updating",get:function(){return!!((0,m.pC)(this._tileFetcher)&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._watchUpdatingTracking&&this._watchUpdatingTracking.updating)}},{key:"updatingTotal",get:function(){return this.updating&&(0,m.pC)(this._tileFetcher)?this._tileFetcher.updatingTotal:0}},{key:"updatingRemaining",get:function(){return this.updating&&(0,m.pC)(this._tileFetcher)?this._tileFetcher.updatingRemaining:0}},{key:"expectedFeatureDiff",get:function(){return this.updating&&(0,m.pC)(this._tileFetcher)?this._tileFetcher.expectedFeatureDiff:0}},{key:"memoryForUnusedFeatures",get:function(){return(0,m.pC)(this._tileFetcher)?this._tileFetcher.memoryForUnusedFeatures:0}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!(!(0,m.pC)(this._tileFetcher)||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}},{key:"maximumNumberOfFeatures",get:function(){return(0,m.pC)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",e)}},{key:"hasMaximumNumberOfFeaturesOverride",get:function(){return this._isOverridden("maximumNumberOfFeatures")}},{key:"mode",get:function(){var e,t,r=this.layerView.layer;if("feature"===r.type&&(0,m.pC)(r.infoFor3D))return"snapshot";if(!1===(null===(e=this.layerView.view.qualitySettings)||void 0===e||null===(t=e.graphics3D)||void 0===t?void 0:t.snapshotAvailable)||this.serviceDataCount===H.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var i=this.layerView.view,n=i&&i.featureTiles,a=n&&n.tilingScheme;if(r&&r.minScale&&this.serviceDataExtent&&a){var s=this._approximateExtentSizeAtScale(r.minScale,a);if((this.serviceDataExtent.width/s+this.serviceDataExtent.height/s)/2>H.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}},{key:"maxTotalSnapshotVertices",get:function(){var e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&(0,m.pC)(this._tileFetcher)&&this._tileFetcher.totalVertices||0;return Math.max(e,t)}},{key:"_approximateExtentSizeAtScale",value:function(e,t){var r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize+r.height/t.pixelSize)/2),n=t.levels[0];return i*((n.tileSize[0]/(n.scale/e)+n.tileSize[1]/(n.scale/e))/2)}},{key:"tileDescriptors",get:function(){return"snapshot"===this.mode?new f.Z([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new f.Z}},{key:"test",get:function(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}},{key:"initialize",value:function(){var e=this;this._watchUpdatingTracking.add((function(){return e.vertexLimitInfo}),(function(){return e._watchUpdatingTracking.addPromise(e._updateVertexLimitExceeded(null,e._lifeCycleAbortController.signal))})),this._watchUpdatingTracking.add((function(){return e.mode}),(function(){return e._modeChanged()}),F.nn),this.addResolvingPromise(Promise.resolve().then((function(){return e._verifyCapabilities()})).then((function(){return e._watchUpdatingTracking.addPromise(e._fetchServiceDataInfo())})).then((function(){return e._initializeTileFetcher()})))}},{key:"_verifyCapabilities",value:function(){var e,t=this.layerView.layer;if("ogc-feature"!==t.type&&(null===(e=(0,T.S1)(t))||void 0===e||!e.operations.supportsQuery))throw new p.Z("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:t})}},{key:"destroy",value:function(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,m.SC)(this._tileFetcher),this._handles=(0,m.SC)(this._handles),this._tilesHandle=(0,m.hw)(this._tilesHandle),this._lifeCycleAbortController=(0,m.IM)(this._lifeCycleAbortController),this._watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}},{key:"suspend",value:function(){this._suspended||(this._suspended=!0,(0,m.pC)(this._tileFetcher)&&this._tileFetcher.suspend())}},{key:"resume",value:function(){this._suspended&&(this._suspended=!1,(0,m.pC)(this._tileFetcher)&&this._tileFetcher.resume())}},{key:"restart",value:function(){var e=this,t=function(){(0,m.pC)(e._tileFetcher)&&e._tileFetcher.restart()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(t,t))}},{key:"refetch",value:function(){var e=this,t=function(){(0,m.pC)(e._tileFetcher)&&e._tileFetcher.refetch()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(t,t))}},{key:"_initializeTileFetcher",value:function(){var e=this,t=this.layerView.view;if(t){var r=(0,F.N1)((function(){var e;return null===(e=t.featureTiles)||void 0===e?void 0:e.tilingScheme}),this._lifeCycleAbortController.signal);this._watchUpdatingTracking.addPromise(r),r.then((function(){var r=e.layerView,i=e.tileDescriptors,n=r.layer,a=new S.j({context:e.context,filterExtent:e.extent,tileDescriptors:i,features:e.graphics});e._tileFetcher=a,e._suspended?e._tileFetcher.suspend():e._tileFetcher.resume();var s=e.layerView.view.resourceController;s&&e._handles.add((0,F.YP)((function(){return s.memoryController.memoryFactor}),(function(e){return a.memoryFactor=e}),F.tX));var u="polygon"===e.context.geometryType?"polygonLodFactor":"polyline"===e.context.geometryType?"polylineLodFactor":null;u&&e._handles.add((0,F.YP)((function(){var t,r,i;return null===(t=e.layerView.view)||void 0===t||null===(r=t.qualitySettings)||void 0===r||null===(i=r.graphics3D)||void 0===i?void 0:i[u]}),(function(e){return a.lodFactor=e||1}),F.nn));"ogc-feature"!==n.type&&e._watchUpdatingTracking.add((function(){return n.createQueryVersion}),(function(){return e._dataFilterChanged()})),e._watchUpdatingTracking.add((function(){return r.availableFields}),(function(t,r){return e._availableFieldsChanged(r,t)})),e._watchUpdatingTracking.add((function(){return r.requiredFields}),(function(t,r){return e._requiredFieldsChanged(r,t)})),e._handles.add([n.on("apply-edits",(function(t){return e._applyEdits(t)})),(0,F.YP)((function(){return e.extent}),(function(e){return a.filterExtent=e}),F.Z_),(0,F.YP)((function(){return e.tileDescriptors}),(function(e){return a.tileDescriptors=e}),F.Z_),(0,F.YP)((function(){return e.maximumNumberOfFeatures}),(function(t){a.maximumNumberOfFeatures=t,a.useTileCount=e.serviceDataCount>t}),F.tX),(0,F.YP)((function(){return e.serviceDataCount}),(function(t){return a.useTileCount=t>e.maximumNumberOfFeatures}),F.tX),(0,F.YP)((function(){return L.Z.FEATURE_TILE_FETCH_SHOW_TILES}),(function(r){r&&a&&!a.debugger?(a.debugger=new U(a,t.featureTiles.tilingScheme.toTileInfo(),t),a.debugger.update()):!r&&e._tileFetcher&&a.debugger&&(a.debugger.destroy(),a.debugger=null)}),F.tX)]),e._supportsExceedsLimitQuery||e._watchUpdatingTracking.add((function(){return e.maxTotalSnapshotVertices}),(function(){return e._watchUpdatingTracking.addPromise(e._updateVertexLimitExceeded(null,e._lifeCycleAbortController.signal))}))})).catch((function(){}))}}},{key:"_modeChanged",value:function(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:_.Z.getLogger(this.declaredClass).warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,m.pC)(this._tilesHandle)&&(this._tilesHandle.remove(),this._tilesHandle=null)}}},{key:"_dataFilterChanged",value:function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}},{key:"_applyEdits",value:function(e){var t=this;(0,m.Wi)(this._tileFetcher)||this._tileFetcher.applyEdits(e).then((function(e){if(e){if(!t._lifeCycleAbortController)throw(0,b.zE)();(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&t._watchUpdatingTracking.addPromise(t._updateServiceDataExtent(t._lifeCycleAbortController.signal))}})).catch((function(e){if(!(0,b.D_)(e))throw e}))}},{key:"_availableFieldsChanged",value:function(e,t){(0,m.pC)(this._tileFetcher)&&Q(this._tileFetcher.availableFields,t)&&this.refetch()}},{key:"_requiredFieldsChanged",value:function(e,t){(0,m.pC)(this._tileFetcher)&&Q(this._tileFetcher.availableFields,t)&&this.restart()}},{key:"_createVertexLimitExceededQuery",value:function(e){var t,r=this.layerView.layer,i=r.createQuery();return i.outStatistics=[new R.Z({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],null!==(t=r.capabilities)&&void 0!==t&&t.query.supportsCacheHint&&(i.cacheHint=!0),i}},{key:"_createDataInfoQuery",value:function(){var e,t=this.layerView.layer,r=t.createQuery();return r.outSpatialReference=this.layerView.view.spatialReference,null!==(e=t.capabilities)&&void 0!==e&&e.query.supportsCacheHint&&(r.cacheHint=!0),r}},{key:"_fullExtentIsAccurate",value:function(){var e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":case"oriented-imagery":return(0,k.M8)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}},{key:"_updateServiceDataExtent",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._tryUpdateServiceDataExtent(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),(0,b.D_)(e.t0)||this._set("serviceDataExtent",(0,v.d9)(this.layerView.fullExtentInLocalViewSpatialReference));case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_tryUpdateServiceDataExtent",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var r,i,a,s,u,o,l,c,h,d,f,p,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.layerView,s=a.layer,u=null!==(r=null===(i=s.capabilities)||void 0===i?void 0:i.query.supportsExtent)&&void 0!==r&&r,o=(0,v.d9)(a.fullExtentInLocalViewSpatialReference),l=s.fullExtent,c=this._fullExtentIsAccurate(),h=this.serviceDataCount,!(u&&h<=H.MAX_FEATURE_COUNT_FOR_EXTENT)||o&&c||!("queryExtent"in s)){e.next=9;break}return d=this._createDataInfoQuery(),e.next=5,s.queryExtent(d,{timeout:H.QUERY_EXTENT_TIMEOUT,signal:t});case 5:f=e.sent,this._set("serviceDataExtent",f.extent),e.next=22;break;case 9:if(!o){e.next=13;break}this._set("serviceDataExtent",o),e.next=22;break;case 13:if(!(0,m.pC)(l)){e.next=21;break}return p="portalItem"in s?s.portalItem:null,e.next=17,(0,w.projectGeometry)(l,a.view.spatialReference,p,t);case 17:y=e.sent,this._set("serviceDataExtent",y),e.next=22;break;case 21:this._set("serviceDataExtent",null);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateServiceDataCount",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var r,i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("queryFeatureCount"in(r=this.layerView.layer)){e.next=3;break}return e.abrupt("return",void this._set("serviceDataCount",H.NO_SERVICE_DATA_COUNT));case 3:return e.next=5,(0,d.q6)(r.queryFeatureCount(this._createDataInfoQuery(),{timeout:H.QUERY_STATISTICS_TIMEOUT,signal:t}));case 5:if(!0!==(i=e.sent).ok){e.next=10;break}this._set("serviceDataCount",i.value),e.next=13;break;case 10:if(!(0,b.D_)(i.error)){e.next=12;break}throw i.error;case 12:this._set("serviceDataCount",H.NO_SERVICE_DATA_COUNT);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"vertexLimitInfo",get:function(){if((0,m.Wi)(this.displayFeatureLimit)||(0,m.Wi)(this.displayFeatureLimit.averageSymbolComplexity))return null;var e=this.displayFeatureLimit,t=e.averageSymbolComplexity,r=e.maximumTotalNumberOfPrimitives,i=t.primitivesPerCoordinate,n=t.primitivesPerFeature,a=this._get("vertexLimitInfo");return(0,m.Wi)(a)||a.maximumTotalNumberOfPrimitives!==r||a.primitivesPerCoordinate!==i||a.primitivesPerFeature!==n?{primitivesPerCoordinate:i,primitivesPerFeature:n,maximumTotalNumberOfPrimitives:r}:a}},{key:"_supportsExceedsLimitQuery",get:function(){var e=this.layerView.layer;return null!=e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}},{key:"_minimumNumberOfVerticesForGeometry",get:function(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}},{key:"_updateVertexLimitExceeded",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s,u,o,l,c,h,f,p,y;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.vertexLimitInfo,!(0,m.Wi)(i)){e.next=3;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 3:if(a=i.primitivesPerFeature<=0,s=this._minimumNumberOfVerticesForGeometry>1,a||s){e.next=6;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 6:if(u=i.primitivesPerFeature,o=i.primitivesPerCoordinate,l=i.maximumTotalNumberOfPrimitives,e.t0=0!==u&&(0,m.pC)(t),!e.t0){e.next=11;break}return e.next=11,t;case 11:if(h=this.serviceDataCount,f=h!==H.NO_SERVICE_DATA_COUNT,c=f?Math.ceil((l-h*u)/(o||1)):Math.ceil(l/(o||1)),s&&(c=Math.min(c,z)),!(f&&this._minimumNumberOfVerticesForGeometry*h>c)){e.next=14;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!0));case 14:if(this._supportsExceedsLimitQuery){e.next=16;break}return e.abrupt("return",void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>c));case 16:return e.next=18,(0,d.q6)(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(c),{timeout:H.QUERY_STATISTICS_TIMEOUT,signal:r}));case 18:if(!1!==(p=e.sent).ok){e.next=23;break}if(!(0,b.D_)(p.error)){e.next=22;break}throw p.error;case 22:return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 23:(y=p.value.features[0])&&y.attributes?this._set("vertexLimitExceeded",!!y.attributes.exceedslimit):this._set("vertexLimitExceeded",!1);case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchServiceDataInfo",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){var t,r,i,a,s,u=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._cancelFetchServiceDataInfo(),t=new AbortController,r=t.signal,i=this._updateServiceDataCount(r),a=(0,b.as)([i,this._updateVertexLimitExceeded(i,r)]),s=a.then((function(){return u._updateServiceDataExtent(r)})).catch((function(e){(0,b.D_)(e)||_.Z.getLogger(u.declaredClass).error("#fetchServiceDataInfo()",e)})).then((function(){s===u._fetchDataInfoPromise&&(u._fetchDataInfoPromise=null,u._fetchDataInfoAbortController=null),t=null})),e.abrupt("return",(t&&(this._fetchDataInfoPromise=s),this._fetchDataInfoAbortController=t,a.then((function(){}),(function(){}))));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_cancelFetchServiceDataInfo",value:function(){var e=this._fetchDataInfoAbortController;e&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,e.abort())}},{key:"debug",get:function(){return{storedFeatures:(0,m.pC)(this._tileFetcher)?this._tileFetcher.storedFeatures:0,totalFeatures:(0,m.pC)(this._tileFetcher)?this._tileFetcher.totalFeatures:0,totalVertices:(0,m.pC)(this._tileFetcher)?this._tileFetcher.totalVertices:0,missingTiles:(0,m.pC)(this._tileFetcher)?this._tileFetcher.missingTiles:0}}}]),r}((0,g.v)(h.Z));(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"type",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],G.prototype,"graphics",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],G.prototype,"layerView",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],G.prototype,"context",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"extent",null),(0,c._)([(0,C.Cb)()],G.prototype,"updating",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"_watchUpdatingTracking",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"updatingTotal",null),(0,c._)([(0,C.Cb)()],G.prototype,"updatingRemaining",null),(0,c._)([(0,C.Cb)()],G.prototype,"expectedFeatureDiff",null),(0,c._)([(0,C.Cb)()],G.prototype,"memoryForUnusedFeatures",null),(0,c._)([(0,C.Cb)()],G.prototype,"maximumNumberOfFeaturesExceeded",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"serviceDataExtent",void 0),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"serviceDataCount",void 0),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"vertexLimitExceeded",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"displayFeatureLimit",void 0),(0,c._)([(0,C.Cb)({type:Number})],G.prototype,"maximumNumberOfFeatures",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"mode",null),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"maxTotalSnapshotVertices",null),(0,c._)([(0,C.Cb)({readOnly:!0,dependsOn:["mode"]})],G.prototype,"tileDescriptors",null),(0,c._)([(0,C.Cb)()],G.prototype,"_tileFetcher",void 0),(0,c._)([(0,C.Cb)()],G.prototype,"_fetchDataInfoPromise",void 0),(0,c._)([(0,C.Cb)({readOnly:!0})],G.prototype,"vertexLimitInfo",null),G=(0,c._)([(0,x.j)("esri.layers.graphics.controllers.FeatureTileController3D")],G);var H,q,z=5e6;function Q(e,t){if(!t)return!1;var r,n=(0,i.Z)(t);try{for(n.s();!(r=n.n()).done;){var a=r.value;if(!e.has(a))return!0}}catch(s){n.e(s)}finally{n.f()}return!1}(q=H||(H={})).NO_SERVICE_DATA_COUNT=1/0,q.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,q.reset=function(){q.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,q.QUERY_STATISTICS_TIMEOUT=12e3,q.QUERY_EXTENT_TIMEOUT=1e4},H.reset()},74509:function(e,t,r){r.d(t,{Jn:function(){return l},Lt:function(){return d},Ou:function(){return p},RL:function(){return h},VW:function(){return o},W_:function(){return b},Zz:function(){return s},jG:function(){return F},mF:function(){return u},tR:function(){return C},tq:function(){return m},vQ:function(){return y},vu:function(){return c},zx:function(){return v}});var i=r(92026),n=r(88152);function a(e){return e?F:C}function s(e,t){return(0,i.Wi)(t)||!t.mode?a(e).mode:t.mode}function u(e,t){return(0,i.pC)(t)?t:a(e)}function o(e,t){return s(!!(0,i.pC)(e)&&e.hasZ,t)}function l(e,t){return u(!!(0,i.pC)(e)&&!!e.hasZ,t)}function c(e){var t=f(e);return o(e.geometry,t)}function h(e){var t=f(e),r=o(e.geometry,t);return{mode:r,offset:(0,i.pC)(t)&&"on-the-ground"!==r?(0,i.Pt)(t.offset,0)*(0,n.Z7)((0,i.Pt)(t.unit,"meters")):0}}function d(e){if("on-the-ground"===c(e))return!1;var t=f(e),r=(0,i.pC)(t)&&t.featureExpressionInfo?t.featureExpressionInfo.expression:null;return!(!r||"0"===r)}function f(e){return e.layer&&"elevationInfo"in e.layer?e.layer.elevationInfo:null}function p(e,t,r){if(!(0,i.Wi)(r)&&r.mode){var n=e.hasZ?e.z:0,a=(0,i.pC)(r.offset)?r.offset:0;switch(r.mode){case"absolute-height":return n-a;case"on-the-ground":return 0;case"relative-to-ground":return n-((0,i.Pt)(t.elevationProvider.getElevation(e.x,e.y,n,e.spatialReference,"ground"),0)+a);case"relative-to-scene":return n-((0,i.Pt)(t.elevationProvider.getElevation(e.x,e.y,n,e.spatialReference,"scene"),0)+a)}}}function y(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return _(e,t.x,t.y,t.hasZ?t.z:0,t.spatialReference,r,i)}function v(e,t,r,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return _(e,t[0],t[1],t.length>2?t[2]:0,r,i,n)}function _(e,t,r,n,a,s){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(!(0,i.Wi)(s)){var o=(0,i.pC)(u)?u.mode:"absolute-height";if("on-the-ground"===o)return 0;var l=m(t,r,n,a,e,s),c=l.absoluteZ;return g(c,t,r,n,a,e,u,o)}}function m(e,t,r,n,a,s){var u=(0,i.pC)(s.offset)?s.offset:0;switch(s.mode){case"absolute-height":return{absoluteZ:r+u,elevation:0};case"on-the-ground":var o=(0,i.Pt)(a.elevationProvider.getElevation(e,t,0,n,"ground"),0);return{absoluteZ:o,elevation:o};case"relative-to-ground":var l=(0,i.Pt)(a.elevationProvider.getElevation(e,t,r,n,"ground"),0);return{absoluteZ:r+l+u,elevation:l};case"relative-to-scene":var c=(0,i.Pt)(a.elevationProvider.getElevation(e,t,r,n,"scene"),0);return{absoluteZ:r+c+u,elevation:c}}}function g(e,t,r,n,a,s,u,o){var l=(0,i.pC)(u)&&(0,i.pC)(u.offset)?u.offset:0;switch(o){case"absolute-height":return e-l;case"relative-to-ground":return e-((0,i.Pt)(s.elevationProvider.getElevation(t,r,n,a,"ground"),0)+l);case"relative-to-scene":return e-((0,i.Pt)(s.elevationProvider.getElevation(t,r,n,a,"scene"),0)+l)}}function b(e,t){if((0,i.Wi)(t))return!1;var r=t.mode;return(0,i.pC)(r)&&("scene"===e&&"relative-to-scene"===r||"ground"===e&&"absolute-height"!==r)}var F={mode:"absolute-height",offset:0},C={mode:"on-the-ground",offset:null}},43682:function(e,t,r){r.d(t,{R:function(){return Be}});var i=r(1413),n=r(74165),a=r(15861),s=r(15671),u=r(43144),o=r(11752),l=r(61120),c=r(60136),h=r(92572),d=r(27366),f=r(10064),p=r(92026),y=r(94172),v=r(49861),_=(r(25243),r(63780),r(69912)),m=r(37818),g=r(5845),b=r(21149),F=r(74579),C=r(60487),x=r(53586),E=r(82607),k=r(77098),T=r(37762),w=r(59896),R=r(41691),S=r(42537),Z=r(32718),O=r(17842),P=r(11186),V=r(71353),I=r(79803),D=r(82582),M=r(65618),A=r(83406),N=r(3182),U=r(80457),L=r(68928),G=r(80031),H=r(27811),q=r(26279),z=r(26511),Q=r(19384),j=r(91526),W=r(79100),B=r(50951),Y=r(20684),J=r(81341),X=r(98634),K=r(82144),$=r(31132),ee=r(33559),te=r(7566),re=r(78041),ie=r(27627),ne=r(8883),ae=r(23819),se=r(8548),ue=r(36207),oe=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).colorRamp=null,e.densityMap=null,e.searchRadius=1,e.fieldTotal=0,e.minDensity=0,e.maxDensity=100,e}return(0,u.Z)(r)}(X.K),le=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(e,i){var n;return(0,s.Z)(this,r),n=t.call(this,e,i,(function(){return n.destroy()}))}return(0,u.Z)(r,[{key:"initializeProgram",value:function(e){return new ie.$(e.rctx,r.shader.get().build(this.configuration),te.i)}},{key:"initializePipeline",value:function(){return(0,ue.sm)({blending:re.wu,colorWrite:ue.BK,depthTest:null,depthWrite:null})}},{key:"primitiveType",get:function(){return se.MX.TRIANGLE_STRIP}}]),r}($.A);le.shader=new K.J(ae.H,(function(){return r.e(28259).then(r.bind(r,28259))}));var ce=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).usesHalfFloat=!1,e}return(0,u.Z)(r)}(ne.W);(0,d._)([(0,ee.o)()],ce.prototype,"usesHalfFloat",void 0);var he=r(53634),de=r(371),fe=r(3384),pe=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(e){var i;return(0,s.Z)(this,r),(i=t.call(this,e)).pixelRatio=1,i._colorRampData=new Uint8ClampedArray(4),i.type="draped-heatmap",i._heatmapParameters=new oe,i}return(0,u.Z)(r,[{key:"initialize",value:function(){var e=this,t={colorTarget:se.Lm.TEXTURE,depthStencilTarget:se.OU.NONE,width:0,height:0},r={target:se.No.TEXTURE_2D,pixelFormat:this.pixelFormat,internalFormat:this.internalFormat,dataType:this.dataType,samplingMode:this.samplingMode,wrapMode:se.e8.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new he.X(this.rctx,t,r),this._quad=(0,Y.ow)(this.rctx);var i=this._colorRampData,n={target:se.No.TEXTURE_2D,pixelFormat:se.VI.RGBA,dataType:se.Br.UNSIGNED_BYTE,samplingMode:se.cw.LINEAR,wrapMode:se.e8.CLAMP_TO_EDGE,width:i.length/4,height:1};this._colorRamp=new de.x(this.rctx,n,i);var a=new ce;a.usesHalfFloat=this.dataType!==se.Br.FLOAT,this._technique=new le({rctx:this.rctx,viewingMode:B.JY.Local},a),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,y.YP)((function(){return[e.colorRampData,e.minDensity,e.maxDensity,e.fieldTotal,e.pixelRatio,e.searchRadius]}),(function(){return e.rendererContext.notifyContentChanged()})))}},{key:"destroy",value:function(){this._technique=(0,p.RY)(this._technique),this._densityMap=(0,p.M2)(this._densityMap),this._quad=(0,p.M2)(this._quad),this._colorRamp=(0,p.M2)(this._colorRamp)}},{key:"searchRadius",get:function(){return this._heatmapParameters.searchRadius},set:function(e){e!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=e,this.notifyChange("searchRadius"))}},{key:"minDensity",get:function(){return this._heatmapParameters.minDensity},set:function(e){e!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=e,this.notifyChange("minDensity"))}},{key:"maxDensity",get:function(){return this._heatmapParameters.maxDensity},set:function(e){e!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=e,this.notifyChange("maxDensity"))}},{key:"fieldTotal",get:function(){return this._heatmapParameters.fieldTotal},set:function(e){this._heatmapParameters.fieldTotal=e,this.notifyChange("fieldTotal")}},{key:"colorRampData",get:function(){return this._colorRampData},set:function(e){var t=this._heatmapParameters.colorRamp;if((0,p.pC)(t)&&e!==this._colorRampData){var r=t.descriptor.width,i=e.length/4;i!==r&&t.resize(i,1),t.setData(e)}this._colorRampData=e}},{key:"_colorRamp",get:function(){return this._heatmapParameters.colorRamp},set:function(e){this._heatmapParameters.colorRamp=e}},{key:"hasHighlights",get:function(){return!1}},{key:"hasWater",get:function(){return!1}},{key:"rendersOccluded",get:function(){return!1}},{key:"render",value:function(e){var t=this._sortedMaterialRenderers;if(!(t.length<1)){var r=this.rctx.getBoundFramebufferObject(),i=this.rctx.getViewport(),n=e.bindParameters,a=this.pixelRatio,s=Math.ceil(i.width*a),u=Math.ceil(i.height*a);this._densityMap.resize(s,u),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,s,u),this.rctx.clear(se.lk.COLOR_BUFFER_BIT);var o=!1;t.forAll((function(t){t.material.shouldRender(e)&&(o=t.render(e.output,n)||o)})),this.rctx.bindFramebuffer(r),this.rctx.setViewport(i.x,i.y,i.width,i.height),o&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,this._heatmapParameters,e.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,fe._V)(this._quad,"geometry")))}}}]),r}(J.S);(0,d._)([(0,v.Cb)()],pe.prototype,"searchRadius",null),(0,d._)([(0,v.Cb)()],pe.prototype,"minDensity",null),(0,d._)([(0,v.Cb)()],pe.prototype,"maxDensity",null),(0,d._)([(0,v.Cb)()],pe.prototype,"fieldTotal",null),(0,d._)([(0,v.Cb)()],pe.prototype,"pixelRatio",void 0),(0,d._)([(0,v.Cb)()],pe.prototype,"colorRampData",null),(0,d._)([(0,v.Cb)({constructOnly:!0})],pe.prototype,"dataType",void 0),(0,d._)([(0,v.Cb)({constructOnly:!0})],pe.prototype,"samplingMode",void 0),(0,d._)([(0,v.Cb)({constructOnly:!0})],pe.prototype,"pixelFormat",void 0),(0,d._)([(0,v.Cb)({constructOnly:!0})],pe.prototype,"internalFormat",void 0),(0,d._)([(0,v.Cb)()],pe.prototype,"_colorRampData",void 0),pe=(0,d._)([(0,_.j)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],pe);var ye=r(40779),ve=r(78289),_e=r(39077),me=r(78485),ge=r(4760),be=r(88396),Fe=r(6394),Ce=r(55158),xe=r(37081),Ee=r(23620),ke=r(56529),Te=r(93822),we=r(33236),Re=r(65322),Se=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).searchRadius=128,e.resolutionForScale=0,e}return(0,u.Z)(r)}(ke.Mt),Ze=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){return(0,s.Z)(this,r),t.apply(this,arguments)}return(0,u.Z)(r,[{key:"initializeProgram",value:function(e){return new ie.$(e.rctx,r.shader.get().build(this.configuration),te.i)}},{key:"initializePipeline",value:function(){return(0,ue.sm)({blending:(0,ue.if)(se.zi.ONE,se.zi.ONE,se.db.ADD),colorWrite:ue.BK,depthTest:null,depthWrite:null})}},{key:"destroy",value:function(){(0,o.Z)((0,l.Z)(r.prototype),"destroy",this).call(this)}}]),r}($.A);Ze.shader=new K.J(Re.H,(function(){return r.e(7682).then(r.bind(r,7682))}));var Oe=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).isAttributeDriven=!1,e.usesHalfFloat=!1,e}return(0,u.Z)(r)}(ne.W);(0,d._)([(0,ee.o)()],Oe.prototype,"isAttributeDriven",void 0),(0,d._)([(0,ee.o)()],Oe.prototype,"usesHalfFloat",void 0);var Pe=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).isAttributeDriven=!1,e.usesHalfFloats=!1,e}return(0,u.Z)(r)}(Se),Ve=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(e){var i;return(0,s.Z)(this,r),(i=t.call(this,e,new Pe))._configuration=new Oe,i}return(0,u.Z)(r,[{key:"requiresSlot",value:function(e,t){return e===Te.r.DRAPED_MATERIAL&&t===xe.H.Color}},{key:"getConfiguration",value:function(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}},{key:"createGLMaterial",value:function(e){return new Ie(e)}},{key:"intersect",value:function(){}},{key:"intersectDraped",value:function(e,t,r,i,n,a){for(var s=e.vertexAttributes.get(ge.T.POSITION),u=this.parameters.searchRadius,o=e.screenToWorldRatio,l=u*o+2*o,c=l*l,h=s.data.length/s.size,d=0;d<h;d++){var f=d*s.size,p=(0,be.s)(Ue,s.data[f],s.data[f+1]);(0,be.k)(p,i)<c&&n(a.dist,a.normal,-1,!1)}}},{key:"createBufferWriter",value:function(){return new De(this.parameters.isAttributeDriven?Ae:Me)}}]),r}(ke.F5),Ie=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){return(0,s.Z)(this,r),t.apply(this,arguments)}return(0,u.Z)(r,[{key:"beginSlot",value:function(e){return this.ensureTechnique(Ze,e)}}]),r}(Ee.Z),De=function(){function e(t){(0,s.Z)(this,e),this.vertexBufferLayout=t}return(0,u.Z)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get(ge.T.POSITION).length*Ne}},{key:"write",value:function(e,t,r,i,n){(0,we.ho)(r.indices.get(ge.T.POSITION),r.vertexAttributes.get(ge.T.POSITION).data,e,i.position,n,Ne);for(var a=r.indices.get(ge.T.POSITION).length,s=i.uv0,u=n,o=0;o<a;++o)s.setValues(u++,-1,-1),s.setValues(u++,1,-1),s.setValues(u++,1,1),s.setValues(u++,1,1),s.setValues(u++,-1,1),s.setValues(u++,-1,-1);var l=ge.T.FEATUREATTRIBUTE in i?i.featureAttribute:null;l&&(0,we.XW)(r.indices.get(ge.T.FEATUREATTRIBUTE),r.vertexAttributes.get(ge.T.FEATUREATTRIBUTE).data,l,n,Ne)}}]),e}(),Me=(0,Ce.U$)().vec3f(ge.T.POSITION).vec2f(ge.T.UV0),Ae=Me.clone().f32(ge.T.FEATUREATTRIBUTE),Ne=6,Ue=(0,Fe.a)(),Le=r(69787),Ge=r(34552),He="esri.views.3d.layers.support.HeatmapFeatureProcessor",qe=Z.Z.getLogger(He),ze=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(e){var i;return(0,s.Z)(this,r),(i=t.call(this,e)).type="heatmap",i.preferredUpdatePolicy=me.j.ASYNC,i.dataExtent=null,i.drapeSourceType=q.Lw.Features,i._renderGeometries=new Map,i._fieldTotal=0,i._drapeSourceRenderer=null,i._dataType=se.Br.HALF_FLOAT,i._pixelFormat=se.VI.RGBA,i.initializePromise=Promise.resolve(),i}return(0,u.Z)(r,[{key:"initialize",value:function(){var e=this;this._featureStore=new L.Z({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});var t=(0,Ge.v)(this._renderView.renderingContext,qe),r=t.dataType,n=t.samplingMode,a=t.pixelFormat,s=t.internalFormat;this._dataType=r,this._pixelFormat=a;var u=r!==se.Br.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,pe,(0,i.Z)((0,i.Z)({},this._rendererParameters),{},{dataType:r,samplingMode:n,pixelFormat:a,internalFormat:s})),this._material=new Ve({usesHalfFloats:u}),this._materialWithField=new Ve({usesHalfFloats:u,isAttributeDriven:!0}),this._filterVisibility=new z.n({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:function(){return e._loadedPointGraphics.length},setAllFeaturesVisibility:function(t){return e._setAllFeaturesVisibility(t)},clearFeaturesVisibility:function(){return e._setAllFeaturesVisibility(!0)},updateFeatureVisibilities:function(t){return e._updateFeatureVisibilities(t)}}}),this.updatingHandles.addOnCollectionChange((function(){return e._loadedPointGraphics}),(function(t){return e._onLoadedFeaturesChange(t)}),y.nn),this.updatingHandles.addWhen((function(){return e._materialParameters}),(function(t){return e._forEachMaterial((function(e){return e.setParameters(t)}))}),y.nn),this.updatingHandles.add((function(){return e._rendererParameters}),(function(t){return e._drapeSourceRenderer.set(t)})),this.updatingHandles.add((function(){return e._heatmapRendererField}),(function(){e._recreate()}),y.Z_),this.updatingHandles.add((function(){return{fieldName:e._heatmapRendererFieldName,numeric:e._heatmapRendererFieldIsNumeric}}),(function(t){var r=t.fieldName,i=t.numeric;if((0,p.pC)(r)&&i){var n=0;e._featureStore.forEach((function(e){var t;return n+=null!==(t=e.attributes[r])&&void 0!==t?t:0})),e._fieldTotal=n}else e._fieldTotal=e._featureStore.numFeatures}),y.nn),this.handles.add([(0,y.YP)((function(){return{fieldName:e._heatmapRendererFieldName,field:e._heatmapRendererField}}),(function(t){var r,i=t.fieldName,n=t.field;i&&!n&&qe.warn("Heatmap renderer field '".concat(i,"' for layer '").concat(null!==(r=e.layer.title)&&void 0!==r?r:e.layer.id,"' not found"))})),(0,y.YP)((function(){return{field:e._heatmapRendererField,numeric:e._heatmapRendererFieldIsNumeric}}),(function(t){var r,i=t.field,n=t.numeric;(0,p.pC)(i)&&!n&&qe.warn("Heatmap renderer field '".concat(i.name,"' for layer '").concat(null!==(r=e.layer.title)&&void 0!==r?r:e.layer.id,"' does not contain numeric values and cannot be used to drive the heatmap density"))})),(0,S.kB)((function(){return e.view.basemapTerrain.overlayManager.unregisterDrapeSource(e)}))])}},{key:"destroy",value:function(){this._renderGeometries.clear(),this._material=(0,p.M2)(this._material),this._materialWithField=(0,p.M2)(this._materialWithField),this._featureStore.clear(),this._featureStore=null}},{key:"layer",get:function(){return this.owner.layer}},{key:"featureStore",get:function(){return this._featureStore}},{key:"updating",get:function(){return this.updatingHandles.updating||this.filterVisibility.updating}},{key:"updatingRemaining",get:function(){return 0}},{key:"suspendInfo",get:function(){return{}}},{key:"legendEnabled",get:function(){return!0}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"displayFeatureLimit",get:function(){var e,t,r,i,n,a,s,u=null!==(e=null===(t=this.owner)||void 0===t||null===(r=t.view)||void 0===r||null===(i=r.resourceController)||void 0===i||null===(n=i.memoryController)||void 0===n?void 0:n.memoryFactor)&&void 0!==e?e:1,o=null===(a=this.owner)||void 0===a||null===(s=a.view)||void 0===s?void 0:s.qualitySettings,l=o?Math.ceil(o.heatmap.maxTotalNumberOfFeatures*u):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:l,maximumTotalNumberOfPrimitives:2*l,maximumNumberOfFeatures:l}}},{key:"hasZ",get:function(){return"hasZ"in this.layer&&this.layer.hasZ}},{key:"hasM",get:function(){return"hasM"in this.layer&&this.layer.hasM}},{key:"view",get:function(){return this.owner.view}},{key:"fullOpacity",get:function(){return this.owner.fullOpacity}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"scaleVisibilitySuspended",get:function(){if(!this._isScaleRangeActive)return!1;var e=this.layer.effectiveScaleRange,t=e.minScale,r=e.maxScale,i=this.view.scale;return!(0,Le.rs)(i,null!==t&&void 0!==t?t:0,null!==r&&void 0!==r?r:0)}},{key:"usedMemory",get:function(){var e,t,r,i,n=this.usedMemoryPerFeature*this._featureStore.numFeatures,a=this._pixelFormat===se.VI.RED?1:4,s=this._dataType===se.Br.FLOAT?4:2,u=null!==(e=Math.ceil((null!==(t=null===(r=this._overlayRenderer)||void 0===r||null===(i=r.overlays[0])||void 0===i?void 0:i.resolution)&&void 0!==t?t:0)*this._densityMapPixelRatio))&&void 0!==e?e:0;return u*u*a*s+n}},{key:"usedMemoryPerFeature",get:function(){var e=this._loadedPointGraphics.find((function(){return!0}));if((0,p.Wi)(e))return 0;var t=(0,w.f2)(e),r=(0,w.G3)();return 6*(0,w.do)([0,0,0],r)+6*(0,w.do)([0,0],r)+(this._heatmapRendererFieldIsNumeric?6*r:0)+t}},{key:"loadedFeatures",get:function(){return this._featureStore.numFeatures}},{key:"unprocessedMemoryEstimate",get:function(){return 0}},{key:"performanceInfo",get:function(){return{core:{visible:this._visibleFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}},{key:"renderer",get:function(){return this._heatmapRenderer}},{key:"_overlayRenderer",get:function(){return this.view.basemapTerrain.overlayManager.renderer}},{key:"_overlaySpatialReference",get:function(){return(0,p.Wg)(this._overlayRenderer.spatialReference)}},{key:"_rendererParameters",get:function(){return(0,i.Z)((0,i.Z)((0,i.Z)((0,i.Z)({},this._radiusParameter),this._densityParameters),this._colorRampParameter),this._pixelRatioParameter)}},{key:"_materialParameters",get:function(){return(0,i.Z)((0,i.Z)({},this._radiusParameter),this._resolutionForScaleParameter)}},{key:"_densityParameters",get:function(){var e=this._heatmapRenderer;return(0,p.Wi)(e)?null:{minDensity:e.minDensity,maxDensity:e.maxDensity,fieldTotal:this._fieldTotal}}},{key:"_radiusParameter",get:function(){var e=this;return(0,p.yw)(this._heatmapRenderer,(function(t){var r=t.radius;return{searchRadius:(0,O.F2)(e._clampSearchRadius(r))}}))}},{key:"_resolutionForScaleParameter",get:function(){var e=this;return(0,p.yw)(this._heatmapRenderer,(function(t){var r=t.referenceScale;return{resolutionForScale:0===r?0:(0,D.dp)(r,e.view.spatialReference)}}))}},{key:"_colorRampParameter",get:function(){return(0,p.yw)(this._heatmapRenderer,(function(e){return{colorRampData:(0,H.uI)(e.colorStops)}}))}},{key:"_pixelRatioParameter",get:function(){return{pixelRatio:this._densityMapPixelRatio}}},{key:"_densityMapPixelRatio",get:function(){var e,t,r,i,n,a,s,u,o=null!==(e=null===(t=this.owner)||void 0===t||null===(r=t.view)||void 0===r||null===(i=r.resourceController)||void 0===i||null===(n=i.memoryController)||void 0===n?void 0:n.memoryFactor)&&void 0!==e?e:1;return(null!==(a=null===(s=this.owner)||void 0===s||null===(u=s.view)||void 0===u?void 0:u.qualitySettings.heatmap.pixelRatio)&&void 0!==a?a:1)*Math.sqrt(o)}},{key:"_renderView",get:function(){return this.view._stage.renderView}},{key:"_featuresArePoints",get:function(){return"point"===this.layer.geometryType}},{key:"_loadedPointGraphics",get:function(){return this.owner.loadedGraphics}},{key:"_heatmapRenderer",get:function(){var e=this.layer.renderer;return"heatmap"===(null===e||void 0===e?void 0:e.type)?e:null}},{key:"_heatmapRendererFieldName",get:function(){return(0,p.yw)(this._heatmapRenderer,(function(e){return e.field}))}},{key:"_heatmapRendererField",get:function(){var e=this;return(0,p.yw)(this._heatmapRendererFieldName,(function(t){return e.layer.fieldsIndex.get(t)}))}},{key:"_heatmapRendererFieldIsNumeric",get:function(){var e=this._heatmapRendererField;return!(0,p.Wi)(e)&&(0,G.H7)(e)}},{key:"_isScaleRangeActive",get:function(){var e=this.layer;if(!("effectiveScaleRange"in e))return!1;var t=e.effectiveScaleRange,r=t.minScale,i=t.maxScale;return(0,Le.Av)(r,i)}},{key:"_visibleFeatures",get:function(){var e=0;return this._renderGeometries.forEach((function(t){t.visible&&++e})),e}},{key:"whenGraphicBounds",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",null);case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"computeAttachmentOrigin",value:function(){return null}},{key:"highlight",value:function(){return Qe}},{key:"maskOccludee",value:function(){return Qe}},{key:"setObjectIdVisibility",value:function(){}},{key:"refreshFilter",value:function(){this.filterVisibility.reapply()}},{key:"_onLoadedFeaturesChange",value:function(e){var t=this;if(this._featuresArePoints){var r=this.layer.objectIdField;this._featureStore.removeManyById(e.removed.map((function(e){return(0,M.MS)(e,r)}))),this._featureStore.addMany(e.added.map((function(e){var t=new N.u_((0,A.dd)(new U.Z,e.geometry),e.attributes,(0,p.yw)(e.centroid,(function(e){return(0,A.dd)(new U.Z,e)})),(0,M.MS)(e,r));return t.displayId=e.uid,t})));var i=e.added,n=e.removed;this._fieldTotal+=this._computeFieldTotalChange(i,n);var a=(0,p.e8)(n,(function(e){var r=e.uid,i=t._renderGeometries.get(r);return t._renderGeometries.delete(r),i})),s=i.map((function(e){var r=t._pointGraphicToRenderGeometry(e);return t._renderGeometries.set(e.uid,r),r}));a.length>0&&this._drapeSourceRenderer.removeGeometries(a,ve.T.REMOVE),s.length>0&&this._drapeSourceRenderer.addGeometries(s,ve.T.ADD),(s.length>0||a.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}}},{key:"_recreate",value:function(){if(this._loadedPointGraphics){var e=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:e,removed:e})}}},{key:"_pointGraphicToRenderGeometry",value:function(e){var t,r=this._heatmapRendererFieldName,i=(0,p.pC)(r)?this._materialWithField:this._material,n=(0,V.c)();(0,I.KC)(e.geometry,n,this._overlaySpatialReference),n[2]=Q.Rn;var a=[[ge.T.POSITION,new j.a(n,n.length)]],s=this._heatmapRendererFieldIsNumeric;(0,p.pC)(r)&&a.push([ge.T.FEATUREATTRIBUTE,new j.a([s&&null!==(t=e.attributes[r])&&void 0!==t?t:0],1)]);var u=new _e.z(new ye.Z(i,a,null,null,W.U.Point),{layerUid:this.layer.uid,graphicUid:e.uid});return(0,P.c)(u.boundingSphere,n),u.visible=this.filterVisibility.defaultVisibility,u}},{key:"_forEachMaterial",value:function(e){e(this._material),e(this._materialWithField)}},{key:"_computeFieldTotalChange",value:function(e,t){if((0,p.Wi)(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return e.length-t.length;var r=this._heatmapRendererFieldName,i=function(e,t){var i;return e+(null!==(i=t.attributes[r])&&void 0!==i?i:0)};return e.reduce(i,0)-t.reduce(i,0)}},{key:"_clampSearchRadius",value:function(e){return e>112&&qe.warnOnce("SceneView supports a maximum radius of ".concat(112," pt for HeatmapRenderer.")),Math.min(e,112)}},{key:"_updateFeatureVisibilities",value:function(e){var t=this,r=[];this._featureStore.forEach((function(i){var n=i.objectId,a=i.displayId,s=e(n),u=t._renderGeometries.get(a);u&&u.visible!==s&&(r.push(u),u.visible=s)})),this._drapeSourceRenderer.modifyGeometries(r,ve.$.VISIBILITY)}},{key:"_setAllFeaturesVisibility",value:function(e){var t,r=[],i=(0,T.Z)(this._renderGeometries.values());try{for(i.s();!(t=i.n()).done;){var n=t.value;n.visible!==e&&(r.push(n),n.visible=e)}}catch(a){i.e(a)}finally{i.f()}this._drapeSourceRenderer.modifyGeometries(r,ve.$.VISIBILITY)}},{key:"test",get:function(){return{visibleFeatureCount:this._visibleFeatures}}}]),r}(R.r);(0,d._)([(0,v.Cb)()],ze.prototype,"type",void 0),(0,d._)([(0,v.Cb)({constructOnly:!0})],ze.prototype,"owner",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"layer",null),(0,d._)([(0,v.Cb)()],ze.prototype,"featureStore",null),(0,d._)([(0,v.Cb)()],ze.prototype,"updating",null),(0,d._)([(0,v.Cb)()],ze.prototype,"updatingRemaining",null),(0,d._)([(0,v.Cb)()],ze.prototype,"suspendInfo",null),(0,d._)([(0,v.Cb)()],ze.prototype,"legendEnabled",null),(0,d._)([(0,v.Cb)()],ze.prototype,"filterVisibility",null),(0,d._)([(0,v.Cb)()],ze.prototype,"displayFeatureLimit",null),(0,d._)([(0,v.Cb)()],ze.prototype,"preferredUpdatePolicy",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"hasZ",null),(0,d._)([(0,v.Cb)()],ze.prototype,"hasM",null),(0,d._)([(0,v.Cb)()],ze.prototype,"dataExtent",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"view",null),(0,d._)([(0,v.Cb)()],ze.prototype,"fullOpacity",null),(0,d._)([(0,v.Cb)()],ze.prototype,"updatePolicy",null),(0,d._)([(0,v.Cb)()],ze.prototype,"drapeSourceType",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"scaleVisibilitySuspended",null),(0,d._)([(0,v.Cb)()],ze.prototype,"renderer",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_featureStore",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"_filterVisibility",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"_overlayRenderer",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_overlaySpatialReference",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_rendererParameters",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_materialParameters",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_densityParameters",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_radiusParameter",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_resolutionForScaleParameter",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_colorRampParameter",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_pixelRatioParameter",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_densityMapPixelRatio",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_renderGeometries",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"_material",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"_materialWithField",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"_renderView",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_featuresArePoints",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_loadedPointGraphics",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_heatmapRenderer",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_heatmapRendererFieldName",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_heatmapRendererField",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_heatmapRendererFieldIsNumeric",null),(0,d._)([(0,v.Cb)()],ze.prototype,"_fieldTotal",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"_drapeSourceRenderer",void 0),(0,d._)([(0,v.Cb)()],ze.prototype,"_isScaleRangeActive",null),ze=(0,d._)([(0,_.j)(He)],ze);var Qe=(0,S.kB)(),je=r(61712),We=r(93463),Be=function(e){var t=function(e){(0,c.Z)(r,e);var t=(0,h.Z)(r);function r(){var e;return(0,s.Z)(this,r),(e=t.apply(this,arguments)).controller=null,e.updatePolicy=me.j.SYNC,e.suspendResumeExtentMode="computed",e.slicePlaneEnabled=!1,e.fullExtentInLocalViewSpatialReference=null,e.suspendResumeExtent=null,e._controllerCreated=!1,e.supportsHeightUnitConversion=!0,e._pendingController=null,e.queryEngine=null,e}return(0,u.Z)(r,[{key:"initialize",value:function(){var e=this,t=this.layer;if("isTable"in t&&t.isTable)this.addResolvingPromise(Promise.reject(new f.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t})));else{this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add((function(){return e.layer.renderer}),(function(t){return e._recreateProcessor(t)}),y.nn),this.addResolvingPromise((0,a.Z)((0,n.Z)().mark((function t(){var r;return(0,n.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,je.E)(e);case 2:return r=t.sent,e.fullExtentInLocalViewSpatialReference=r,t.next=6,e._initializeController();case 6:case"end":return t.stop()}}),t)})))()),this.updatingHandles.add((function(){return e.updatePolicy}),(function(t){return e.processor.preferredUpdatePolicy=t}));this.queryEngine=new E.q({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return e.processor.featureStore},hasZ:this.hasZ,hasM:this.hasM},priority:We.T8.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}}},{key:"destroy",value:function(){this._destroyPendingController(),this.controller=(0,p.SC)(this.controller),this._set("processor",(0,p.SC)(this.processor)),this.queryEngine=(0,p.SC)(this.queryEngine),this.loadedGraphics=null}},{key:"_destroyPendingController",value:function(){this._pendingController=(0,p.SC)(this._pendingController)}},{key:"legendEnabled",get:function(){var e;return this.canResume()&&(null===(e=this.processor)||void 0===e?void 0:e.legendEnabled)}},{key:"graphics3DProcessor",get:function(){var e;return"graphics-3d"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}},{key:"heatmapProcessor",get:function(){var e;return"heatmap"===(null===(e=this.processor)||void 0===e?void 0:e.type)?this.processor:null}},{key:"symbologySnappingSupported",get:function(){var e,t,r,i=null===(e=this.layer)||void 0===e||null===(t=e.renderer)||void 0===t?void 0:t.getSymbols();return null!==(r=null===i||void 0===i?void 0:i.some(F.QL))&&void 0!==r&&r}},{key:"getHit",value:function(e){var t,r,i=this;return null!==(t=this.loadedGraphics)&&void 0!==t&&t.forEach((function(t){t.uid===e&&(r=(0,m.mW)(t,i.layer))})),r?{type:"graphic",graphic:r,layer:r.layer}:null}},{key:"whenGraphicBounds",value:function(e,t){var r;return null===(r=this.processor)||void 0===r?void 0:r.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){var r;return null===(r=this.processor)||void 0===r?void 0:r.computeAttachmentOrigin(e,t)}},{key:"elevationAlignPointsInFeatures",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.graphics3DProcessor,!(0,p.Wi)(i)){e.next=3;break}throw new f.Z("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");case 3:return e.abrupt("return",(0,C.W)(this.view,this.layer,(function(e){return i.getGraphics3DGraphicByObjectId(e)}),t,r));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryForSymbologySnapping",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.symbologySnappingSupported?(0,k.c)(this.graphics3DProcessor,t,r):{candidates:[],sourceCandidateIndices:[]});case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),(0,p.U2)(t,"signal"))}},{key:"queryObjectIds",value:function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),(0,p.U2)(t,"signal"))}},{key:"queryFeatureCount",value:function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),(0,p.U2)(t,"signal"))}},{key:"queryExtent",value:function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),(0,p.U2)(t,"signal"))}},{key:"_ensureQuery",value:function(e){return(0,p.Wi)(e)?this.createQuery():b.Z.from(e)}},{key:"highlight",value:function(e){return this.processor.highlight(e,this.layer.objectIdField)}},{key:"maskOccludee",value:function(e){return this.processor.maskOccludee(e)}},{key:"canResume",value:function(){var e;return(0,o.Z)((0,l.Z)(r.prototype),"canResume",this).call(this)&&!(null!==(e=this.processor)&&void 0!==e&&e.scaleVisibilitySuspended)}},{key:"getSuspendInfo",value:function(){var e=(0,o.Z)((0,l.Z)(r.prototype),"getSuspendInfo",this).call(this);return this.processor?(0,i.Z)((0,i.Z)({},e),this.processor.suspendInfo):e}},{key:"isUpdating",value:function(){var e,t,r;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&(null===(e=this.controller)||void 0===e||!e.updating)&&null!==(t=this.view)&&void 0!==t&&null!==(r=t.basemapTerrain)&&void 0!==r&&r.ready&&!this.processor.updating)}},{key:"_initializeController",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){var t;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.createController(),this._pendingController=t,e.next=4,t.when();case 4:this._setControllerWhenInitialized(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_setControllerWhenInitialized",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t){var r=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:if(this._controllerCreated=!0,this.notifyChange("updating"),!this.isResolved()||this.destroyed){e.next=19;break}return e.next=12,(0,y.N1)((function(){var e,t;return null===(e=r.view)||void 0===e||null===(t=e.basemapTerrain)||void 0===t?void 0:t.ready}));case 12:this.beforeSetController(t),this._pendingController=null,this.controller=t,this.loadedGraphics=t.graphics,this.notifyChange("updating"),e.next=20;break;case 19:this._destroyPendingController();case 20:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_updateClippingExtent",value:function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}},{key:"_validateGeometryType",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=this.layer.geometryType,e.next="multipatch"===e.t0||"multipoint"===e.t0?3:4;break;case 3:throw new f.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType});case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_recreateProcessor",value:function(e){var t,r,i=this,n="heatmap"===(null===e||void 0===e?void 0:e.type),a="heatmap"===(null===(t=this.processor)||void 0===t?void 0:t.type),s=this.processor;if(!s||n!==a){var u=n?new ze({owner:this}):new x.Z({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:function(e){return i._updateClippingExtent(e)}});this._set("processor",u),null!==s&&void 0!==s&&s.destroy(),null!==(r=this.queryEngine)&&void 0!==r&&r.clear(),this.addResolvingPromise(u.initializePromise)}}},{key:"_getResourceInfo",value:function(){var e,t,r=this.controller instanceof g.g?this.controller:null;return(0,i.Z)({displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:null!==(e=null===r||void 0===r?void 0:r.maximumNumberOfFeatures)&&void 0!==e?e:-1,totalNumberOfFeatures:null!==(t=null===r||void 0===r?void 0:r.serviceDataCount)&&void 0!==t?t:-1,nodes:0},this.processor.performanceInfo)}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return(0,d._)([(0,v.Cb)()],t.prototype,"loadedGraphics",void 0),(0,d._)([(0,v.Cb)()],t.prototype,"suspended",void 0),(0,d._)([(0,v.Cb)({readOnly:!0})],t.prototype,"legendEnabled",null),(0,d._)([(0,v.Cb)()],t.prototype,"updating",void 0),(0,d._)([(0,v.Cb)()],t.prototype,"controller",void 0),(0,d._)([(0,v.Cb)()],t.prototype,"processor",void 0),(0,d._)([(0,v.Cb)({readOnly:!0})],t.prototype,"updatePolicy",void 0),(0,d._)([(0,v.Cb)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),(0,d._)([(0,v.Cb)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),(0,d._)([(0,v.Cb)({readOnly:!0})],t.prototype,"suspendInfo",void 0),(0,d._)([(0,v.Cb)()],t.prototype,"graphics3DProcessor",null),(0,d._)([(0,v.Cb)()],t.prototype,"heatmapProcessor",null),(0,d._)([(0,v.Cb)()],t.prototype,"symbologySnappingSupported",null),t=(0,d._)([(0,_.j)("esri.views.3d.layers.FeatureLikeLayerView3D")],t)}},53586:function(e,t,r){r.d(t,{Z:function(){return N}});var i=r(74165),n=r(15861),a=r(1413),s=r(15671),u=r(43144),o=r(60136),l=r(92572),c=r(27366),h=r(52639),d=r(23254),f=r(41644),p=r(41691),y=r(92026),v=r(66978),_=r(94172),m=r(49861),g=(r(25243),r(63780),r(69912)),b=r(48732),F=r(81753),C=r(58801),x=r(34610),E=r(21149),k=r(26279),T=r(61310),w=r(86792),R=r(57848),S=r(84328),Z=r(46568),O=r(59453),P=r(96387),V=r(99879),I=r(26511),D=r(68401),M=r(78485),A=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(e){var i;return(0,s.Z)(this,r),(i=t.call(this,e)).type="graphics-3d",i._randomRotationRenderers=null,i.elevationFeatureExpressionEnabled=!1,i.scaleVisibilityEnabled=!1,i.filterVisibilityEnabled=!1,i.frustumVisibilityEnabled=!1,i.elevationAlignmentEnabled=!1,i.timeExtentEnabled=!1,i.setUidToIdOnAdd=!0,i.dataExtent=null,i.drapeSourceType=k.Lw.Features,i.preferredUpdatePolicy=M.j.ASYNC,i._suspendResumeExtent=null,i}return(0,u.Z)(r,[{key:"initialize",value:function(){var e=this,t=this.owner,r=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==t.layer.geometryType,i=new w.w({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.hasZ,hasM:t.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:function(e){return t.view.deconflictor.addGraphicsOwner(e)},labeler:function(e,r){return t.view.labeler.addGraphicsOwner(e,r)},elevationAlignment:this.elevationAlignmentEnabled?function(r,i){return new R.Z({graphicsCoreOwner:e,graphicsCore:r,queryGraphicUIDsInExtent:i,elevationProvider:t.view.elevationProvider})}:null,scaleVisibility:this.scaleVisibilityEnabled?function(r,i){return new O.Z({graphicsCoreOwner:e,layer:e.layer,queryGraphicUIDsInExtent:i,graphicsCore:r,basemapTerrain:t.view.basemapTerrain})}:null,filterVisibility:r?function(e){return new I.n({context:(0,a.Z)({layerView:t},e)})}:null,objectStates:function(e){return new Z.d(e)}}});this._set("graphicsCore",i),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new S.Z({graphicsCoreOwner:this})),this.elevationAlignment&&this.updatingHandles.add((function(){return e.layer.elevationInfo}),(function(t,r){(0,b.Hg)(t,r)&&e.updatingHandles.addPromise(e.graphicsCore.elevationInfoChange())})),this.updatingHandles.add((function(){return e.layer.labelsVisible}),(function(){return e.graphicsCore.updateVisibilityInfo()})),this.updatingHandles.add((function(){return e.layer.labelingInfo}),(function(t,r){(0,b.Hg)(t,r)&&e.graphicsCore.updateLabelingInfo()})),this.updatingHandles.add((function(){return e.preferredUpdatePolicy}),(function(t){return e.graphicsCore.preferredUpdatePolicy=t})),this._set("initializePromise",this._initializeAsync()),this.updatingHandles.addPromise(this.initializePromise)}},{key:"_initializeAsync",value:function(){var e=(0,n.Z)((0,i.Z)().mark((function e(){var t,r=this;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,v.U3)(this.graphicsCore.initializePromise);case 2:if(t=this.owner,this.updatingHandles.add((function(){return r.renderer}),(function(e){return r.updatingHandles.addPromise(r.graphicsCore.rendererChange(e))})),this.updatingHandles.add((function(){return t.fullOpacity}),(function(){return r.graphicsCore.opacityChange()})),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add((function(){return t.view.clippingArea}),(function(){return r._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),e.t0=this.graphicsCore.labelsEnabled,!e.t0){e.next=12;break}return e.next=12,(0,v.U3)(this.graphicsCore.updateLabelingInfo());case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",(0,y.SC)(this.frustumVisibility)),this._set("graphicsCore",(0,y.SC)(this.graphicsCore)),this._set("owner",null)}},{key:"layer",get:function(){return this.owner.layer}},{key:"renderer",get:function(){var e=this.layer,t=e.renderer,r=e.objectIdField;if(!t||!r||"heatmap"===t.type||!t.visualVariables)return t;var i=t.visualVariables.findIndex((function(e){return"rotation"===e.type&&null!=e.valueExpression&&(0,C.v)(e.valueExpression)===r&&(null==e.axis||"heading"===e.axis)&&"geographic"===e.rotationType}));if(i<0)return t;var n=t.clone();return n.visualVariables.splice(i,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(n,r),n}},{key:"scaleVisibility",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.scaleVisibility}},{key:"filterVisibility",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.filterVisibility}},{key:"elevationAlignment",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.elevationAlignment}},{key:"objectStates",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.objectStates}},{key:"suspendResumeExtentMode",get:function(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}},{key:"scaleVisibilitySuspended",get:function(){return(0,y.pC)(this.scaleVisibility)&&this.scaleVisibility.suspended}},{key:"suspended",get:function(){return this.owner.suspended}},{key:"legendEnabled",get:function(){return(0,y.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended}},{key:"suspendInfo",get:function(){var e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}},{key:"updating",get:function(){var e,t;return!!(null!==(e=this.graphicsCore)&&void 0!==e&&e.updating||(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.updating||null!==(t=this.updatingHandles)&&void 0!==t&&t.updating)}},{key:"updatingRemaining",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.updatingRemaining)&&void 0!==e?e:0}},{key:"featureStore",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.featureStore}},{key:"view",get:function(){return this.owner.view}},{key:"loadedGraphics",get:function(){return this.owner.loadedGraphics}},{key:"fullOpacity",get:function(){var e;return null===(e=this.owner)||void 0===e?void 0:e.fullOpacity}},{key:"filter",get:function(){return"filter"in this.owner?this.owner.filter:null}},{key:"slicePlaneEnabled",get:function(){return this.owner.slicePlaneEnabled}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"featureSpatialReference",get:function(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}},{key:"graphics3DGraphics",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphics}},{key:"graphics3DGraphicsByObjectID",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.graphics3DGraphicsByObjectID}},{key:"symbolUpdateType",get:function(){var e;return null===(e=this.graphicsCore)||void 0===e?void 0:e.symbolUpdateType}},{key:"displayFeatureLimit",get:function(){var e,t=this.view.resourceController.memoryController.memoryFactor,r=null===(e=this.graphicsCore)||void 0===e?void 0:e.displayFeatureLimit;if(1===t)return r;var i=Math.ceil(r.maximumNumberOfFeatures*t),n=Math.ceil(r.maximumTotalNumberOfFeatures*t),s=Math.ceil(r.minimumTotalNumberOfFeatures*t);return(0,a.Z)((0,a.Z)({},r),{},{maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:n,minimumTotalNumberOfFeatures:s})}},{key:"usedMemory",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0}},{key:"loadedFeatures",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.numberOfGraphics)&&void 0!==e?e:0}},{key:"usedMemoryPerFeature",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.usedMemoryPerGraphic)&&void 0!==e?e:0}},{key:"unprocessedMemoryEstimate",get:function(){var e,t;return null!==(e=null===(t=this.graphicsCore)||void 0===t?void 0:t.unprocessedMemoryEstimate)&&void 0!==e?e:0}},{key:"performanceInfo",get:function(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:(0,y.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibilitySuspended}}},{key:"maskOccludee",value:function(e){var t=this.objectStates.acquireSet(D.V_.MaskOccludee,null),r=t.set,i=t.handle;return this.objectStates.setUid(r,e.uid),i}},{key:"highlight",value:function(e,t){var r=this;if(e instanceof E.Z){var i=this.objectStates.acquireSet(D.V_.Highlight,t),n=i.set,a=i.handle;return this.owner.queryObjectIds(e).then((function(e){return r.objectStates.setObjectIds(n,e)})),a}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof h.Z)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof h.Z){var s=e;if(null==(0,V.g)(this.layer.fieldsIndex,s[0].attributes,t)){var u=s.map((function(e){return e.uid})),o=this.objectStates.acquireSet(D.V_.Highlight,null),l=o.set,c=o.handle;return this.objectStates.setUids(l,u),c}e=s.map((function(e){return(0,V.g)(r.layer.fieldsIndex,e.attributes,t)}))}if("number"==typeof e[0]||"string"==typeof e[0]){var d=e,f=this.objectStates.acquireSet(D.V_.Highlight,t),p=f.set,y=f.handle;return this.objectStates.setObjectIds(p,d),y}}return L}},{key:"resetObjectStates",value:function(){this.objectStates.reset()}},{key:"whenGraphicBounds",value:function(e,t){var r;return null===(r=this.graphicsCore)||void 0===r?void 0:r.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){var r;return null===(r=this.graphicsCore)||void 0===r?void 0:r.computeAttachmentOrigin(e,t)}},{key:"notifyGraphicGeometryChanged",value:function(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}},{key:"notifyGraphicVisibilityChanged",value:function(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}},{key:"getRenderingInfo",value:function(e,t,r){var i,n=(0,x.Kb)(e,{renderer:t,arcade:r});if((0,y.pC)(n)&&n.color){var a=n.color;a[0]=a[0]/255,a[1]=a[1]/255,a[2]=a[2]/255}if((0,y.pC)(n)&&(0,y.pC)(t)&&null!==(i=this._randomRotationRenderers)&&void 0!==i&&i.has(t)){var s=this._randomRotationRenderers.get(t),u=e.attributes[s],o=new d.a(0);o.updateFloatArray([u]),o.updateUint8Array([173]),n.heading=8.381e-8*o.digest()}return n}},{key:"getRenderingInfoAsync",value:function(e,t,r,i){return(0,x.xn)(e,(0,a.Z)({renderer:t,arcade:r},i))}},{key:"getSymbolLayerSize",value:function(e,t){var r;return null===(r=this.graphicsCore)||void 0===r?void 0:r.getSymbolLayerSize(e,t)}},{key:"setObjectIdVisibility",value:function(e,t){var r;null===(r=this.graphicsCore)||void 0===r||r.setObjectIdVisibility(e,t)}},{key:"refreshFilter",value:function(){(0,y.pC)(this.filterVisibility)&&this.filterVisibility.reapply()}},{key:"getGraphics3DGraphicByObjectId",value:function(e){var t;return null===(t=this.graphicsCore)||void 0===t?void 0:t.getGraphics3DGraphicByObjectId(e)}},{key:"_updateClippingExtent",value:function(){var e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}},{key:"_setupSuspendResumeExtent",value:function(){var e=this;(this.frustumVisibility||this.scaleVisibility)&&this.handles.add((0,_.YP)((function(){return e.suspendResumeExtentMode}),(function(){switch(e.handles.remove(U),e.suspendResumeExtentMode){case"computed":e.handles.add([(0,_.YP)((function(){return e.graphicsCore.computedExtent}),(function(t){return e._updateSuspendResumeExtent(t)}),_.nn),(0,_.YP)((function(){return e.graphicsCore.extentPadding}),(function(){return e._updateSuspendResumeExtent(e.graphicsCore.computedExtent)}))],U);break;case"data":e.handles.add([(0,_.gx)((function(){return e.dataExtent}),(function(t){return e._updateSuspendResumeExtent(t)}),_.nn),(0,_.YP)((function(){return e.graphicsCore.extentPadding}),(function(){return e._updateSuspendResumeExtent((0,y.Wg)(e.dataExtent))}))],U);break;default:(0,f.Bg)(e.suspendResumeExtentMode)}}),_.nn))}},{key:"_updateSuspendResumeExtent",value:function(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}},{key:"_extentToSuspendResumeRect",value:function(e,t){var r=this.owner.view.spatialReference;if(!e.spatialReference.equals(r)){if(!(0,F.Q8)(e,r))return;e=(0,F.iV)(e,r)}return(0,P.Go)(e,t,T.Z,this.graphicsCore.extentPadding)}},{key:"_suspendResumeExtentChanged",value:function(e){(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.setExtent(e),(0,y.pC)(this.scaleVisibility)&&this.scaleVisibility.setExtent(e)}}]),r}(p.r);(0,c._)([(0,m.Cb)()],A.prototype,"type",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"owner",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"layer",null),(0,c._)([(0,m.Cb)()],A.prototype,"renderer",null),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"updateClippingExtent",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"elevationFeatureExpressionEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"graphicsCore",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"scaleVisibilityEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"filterVisibilityEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"frustumVisibilityEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"elevationAlignmentEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"timeExtentEnabled",void 0),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"setUidToIdOnAdd",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"scaleVisibility",null),(0,c._)([(0,m.Cb)()],A.prototype,"filterVisibility",null),(0,c._)([(0,m.Cb)()],A.prototype,"elevationAlignment",null),(0,c._)([(0,m.Cb)({constructOnly:!0})],A.prototype,"frustumVisibility",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"objectStates",null),(0,c._)([(0,m.Cb)()],A.prototype,"initializePromise",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"suspendResumeExtentMode",null),(0,c._)([(0,m.Cb)()],A.prototype,"dataExtent",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"scaleVisibilitySuspended",null),(0,c._)([(0,m.Cb)()],A.prototype,"suspended",null),(0,c._)([(0,m.Cb)()],A.prototype,"legendEnabled",null),(0,c._)([(0,m.Cb)()],A.prototype,"suspendInfo",null),(0,c._)([(0,m.Cb)()],A.prototype,"updating",null),(0,c._)([(0,m.Cb)()],A.prototype,"updatingRemaining",null),(0,c._)([(0,m.Cb)()],A.prototype,"featureStore",null),(0,c._)([(0,m.Cb)()],A.prototype,"view",null),(0,c._)([(0,m.Cb)()],A.prototype,"loadedGraphics",null),(0,c._)([(0,m.Cb)()],A.prototype,"fullOpacity",null),(0,c._)([(0,m.Cb)()],A.prototype,"filter",null),(0,c._)([(0,m.Cb)()],A.prototype,"slicePlaneEnabled",null),(0,c._)([(0,m.Cb)()],A.prototype,"drapeSourceType",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"updatePolicy",null),(0,c._)([(0,m.Cb)()],A.prototype,"preferredUpdatePolicy",void 0),(0,c._)([(0,m.Cb)()],A.prototype,"displayFeatureLimit",null);var N=A=(0,c._)([(0,g.j)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],A),U="suspendResumeExtentMode",L={remove:function(){},pause:function(){},resume:function(){}}},82607:function(e,t,r){r.d(t,{q:function(){return F}});var i=r(1413),n=r(74165),a=r(15861),s=r(15671),u=r(43144),o=r(60136),l=r(92572),c=r(27366),h=(r(59486),r(85015)),d=r(92026),f=r(49861),p=(r(25243),r(63780),r(69912)),y=r(53866),v=r(14e3),_=r(49818),m=r(21149),g=r(27823),b=v.q,F=function(e){(0,o.Z)(r,e);var t=(0,l.Z)(r);function r(e){var i;return(0,s.Z)(this,r),(i=t.call(this,e))._dataQueryEngineInstance=null,i}return(0,u.Z)(r,[{key:"layer",get:function(){return this.context.layer}},{key:"spatialReference",get:function(){return this.context.spatialReference}},{key:"_queryGeometryType",get:function(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}},{key:"defaultQueryJSON",get:function(){return new m.Z({outSpatialReference:this.spatialReference}).toJSON()}},{key:"_dataQueryEngine",get:function(){return this._ensureDataQueryEngine()}},{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}},{key:"executeQueryForIdSet",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r,i){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(t,r),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"executeQueryForCount",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),r);case 2:return i=e.sent,a=i.count,s=i.extent,e.abrupt("return",{count:a,extent:y.Z.fromJSON(s)});case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForLatestObservations",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(t),r);case 2:return i=e.sent,a=_.Z.fromJSON(i),e.abrupt("return",(a.features.forEach((function(e){e.layer=s.layer,e.sourceLayer=s.layer})),a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQuery",value:function(){var e=(0,a.Z)((0,n.Z)().mark((function e(t,r){var i,a,s=this;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQuery(this._ensureQueryJSON(t),r);case 2:return i=e.sent,a=_.Z.fromJSON(i),e.abrupt("return",(a.features.forEach((function(e){e.layer=s.layer,e.sourceLayer=s.layer})),a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_ensureQueryJSON",value:function(e,t){var r=this.defaultQueryJSON;if((0,d.pC)(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),r=e.toJSON()),(0,d.pC)(t)){var n=t.geometries.map((function(e){return e.toJSON()})).reduce((function(e,t){return e.rings=e.rings.concat(t.rings),e}));r=(0,i.Z)((0,i.Z)({},r),{},{sceneFilter:(0,i.Z)((0,i.Z)({},t),{},{geometry:n})})}return r}},{key:"_ensureDataQueryEngine",value:function(){var e,t;if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var r="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,i=this.layer.objectIdField,n=g.M.toJSON(this._queryGeometryType),a=null!==(e=null===(t=this.layer.fields)||void 0===t?void 0:t.map((function(e){return e.toJSON()})))&&void 0!==e?e:[],s=this.priority,u=this.spatialReference.toJSON(),o=this.context,l=o.hasZ,c=o.hasM,h=o.featureStore,d=o.scheduler;return this._dataQueryEngineInstance=new b({hasZ:l,hasM:c,geometryType:n,fields:a,timeInfo:r,spatialReference:u,objectIdField:i,featureStore:h,scheduler:d,priority:s}),this._dataQueryEngineInstance}}]),r}(h.Z);(0,c._)([(0,f.Cb)({constructOnly:!0})],F.prototype,"context",void 0),(0,c._)([(0,f.Cb)({constructOnly:!0})],F.prototype,"priority",void 0),(0,c._)([(0,f.Cb)()],F.prototype,"layer",null),(0,c._)([(0,f.Cb)()],F.prototype,"spatialReference",null),(0,c._)([(0,f.Cb)()],F.prototype,"_queryGeometryType",null),(0,c._)([(0,f.Cb)()],F.prototype,"defaultQueryJSON",null),F=(0,c._)([(0,p.j)("esri.views.3d.layers.graphics.QueryEngine")],F)},32080:function(e,t,r){r.d(t,{j:function(){return L},A:function(){return H}});var i,n=r(37762),a=r(74165),s=r(15861),u=r(15671),o=r(43144),l=r(60136),c=r(92572),h=r(27366),d=r(85015),f=r(100),p=r(32718),y=r(77427),v=r(92026),_=r(66978),m=r(94172),g=r(99346),b=r(49861),F=(r(25243),r(63780)),C=r(69912),x=r(65156),E=r(65618),k=r(94618),T=r(21149),w=r(50951),R=(r(59896),r(93169),r(78952),r(41414),r(16889),r(53866),r(32238),r(77577),r(585),r(80885),r(29909),r(27823),r(83040),r(70178)),S=function(){function e(t,r){(0,u.Z)(this,e),this._highestResolutionVersion=null,this.versions=[],this.ref(t,r)}return(0,o.Z)(e,[{key:"isReferenced",get:function(){return 0!==this.versions.length}},{key:"isSingle",get:function(){return 1===this.versions.length&&1===this.versions[0].refCount}},{key:"ref",value:function(e,t){var r=this.feature;O.oldVersion=r,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});var i,a=(0,n.Z)(this.versions);try{for(a.s();!(i=a.n()).done;){var s=i.value;if(s.resolution===t){s.refCount++;var u=this._highestResolutionVersion===s&&!(0,R.f)(e,s.feature);return(u||this._highestResolutionVersion!==s)&&(s.feature=e),O.newVersion=u?e:r,O}}}catch(l){a.e(l)}finally{a.f()}var o={feature:e,resolution:t,refCount:1};return this.versions.push(o),!this._highestResolutionVersion||t<this._highestResolutionVersion.resolution?(O.newVersion=e,this._highestResolutionVersion=o):O.newVersion=r,O}},{key:"unref",value:function(e){for(var t=0;t<this.versions.length;t++){var r=this.versions[t];if(r.resolution===e)return r.refCount--,O.oldVersion=this.feature,0===r.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===r&&(this._recalculateHighestResolutionVersion(),O.oldVersion=r.feature)),O.newVersion=this.feature,O}return null}},{key:"feature",get:function(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}},{key:"_recalculateHighestResolutionVersion",value:function(){if(0!==this.versions.length){for(var e=this.versions[0],t=1;t<this.versions.length;t++){var r=this.versions[t];r.resolution<e.resolution&&(e=r)}this._highestResolutionVersion=e}else this._highestResolutionVersion=null}}]),e}(),Z=function(){function e(t){(0,u.Z)(this,e),this._feature=t,this._refCount=1}return(0,o.Z)(e,[{key:"isReferenced",get:function(){return 0!==this._refCount}},{key:"isSingle",get:function(){return 1===this._refCount}},{key:"ref",value:function(e){return++this._refCount,O.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),(0,R.f)(this._feature,e)||(this._feature=e),O.newVersion=this._feature,O}},{key:"unref",value:function(){return O.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(O.newVersion=null,O):(O.newVersion=this._feature,O)}},{key:"feature",get:function(){return this._feature}}]),e}(),O={oldVersion:null,newVersion:null},P=new Set,V=function(){function e(t){(0,u.Z)(this,e),this.descriptor=t,this.fetchStatus=i.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=I,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=P,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}return(0,o.Z)(e,[{key:"displayingFeatures",get:function(){return this._displayingFeatures},set:function(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}},{key:"perTileMaximumNumberOfFeaturesExceeded",get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}},{key:"features",get:function(){return this._features}},{key:"featureLimit",get:function(){return this._featureLimit},set:function(e){this._featureLimit!==e&&(this._featureLimit=e,this._estimatedUnusedSizeDirty=!0)}},{key:"availableFields",get:function(){return this._availableFields}},{key:"setFeatures",value:function(e,t,r){this._availableFields=(0,v.Pt)(r,P),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce((function(e,t){return e+(0,E.R3)(t.geometry)}),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}},{key:"emptyFeatureRatio",get:function(){return this._emptyFeatureRatio}},{key:"numFeatures",get:function(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0},set:function(e){this._numFeatures=e}},{key:"hasPreciseFeatureCount",get:function(){return this._numFeatures>I}},{key:"needsFeatureCount",get:function(){return this._numFeatures===I}},{key:"numVertices",get:function(){return this._numVertices}},{key:"id",get:function(){return this.descriptor.id}},{key:"estimatedSize",get:function(){return this.updateMemoryEstimates(),this._estimatedSize}},{key:"estimatedUnusedSize",get:function(){return this._estimatedUnusedSize}},{key:"updateMemoryEstimates",value:function(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(var e=0;e<this._features.length;++e){var t=(0,E.Xw)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(var r=this.featureLimit;r<this._features.length;++r)this._estimatedUnusedSize+=(0,E.Xw)(this._features[r]);return!0}return!1}},{key:"isFetching",get:function(){return this.fetchStatus===i.FETCHING||this.fetchStatus===i.REFETCHING}},{key:"isRefetching",get:function(){return this.fetchStatus===i.REFETCHING}},{key:"needsFetching",get:function(){return this.fetchStatus===i.FETCH_NEEDED||this.fetchStatus===i.REFETCH_NEEDED}},{key:"needsRefetching",get:function(){return this.fetchStatus===i.REFETCH_NEEDED}},{key:"isFetched",get:function(){return this.fetchStatus===i.DONE||this.fetchStatus===i.FULL}},{key:"resetFetching",value:function(){this.fetchStatus=this.fetchStatus===i.REFETCHING?i.REFETCH_NEEDED:i.FETCH_NEEDED}},{key:"needsDisplayUpdate",get:function(){return!!this._features&&!function(e,t,r){if((0,v.Wi)(t)||(0,v.Wi)(e)||r!==t.length||r>e.length)return!1;for(var i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}},{key:"intersects",value:function(e){return!(!(0,v.Wi)(e)&&this.descriptor.extent)||((0,x.oJ)(e,D),(0,x.kK)(this.descriptor.extent,D))}},{key:"intersectionIncludingBorrowed",value:function(e,t){var r=(0,v.pC)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||r?((0,v.pC)(e)?((0,x.oJ)(e,t),(0,x.jV)(t,r,t)):(0,x.JG)(t,r),t):((0,x.JG)(t,x.bd),t)}},{key:"_shuffle",value:function(e){this._features.sort((function(t,r){return(0,E.MS)(t,e)-(0,E.MS)(r,e)})),(0,F.TV)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}},{key:"reduceFeatures",value:function(e,t,r){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;var n=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===i.DONE&&this._features.length>0&&(this.fetchStatus=i.REFETCH_NEEDED,n=!0)),!this._shuffled&&e<1&&this._shuffle(r);var a=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>a&&(this._features.length=a,this.featuresMissing=!0,this.fetchStatus===i.FULL&&(this.fetchStatus=i.DONE)),n}},{key:"cache",get:function(){return{availableFields:this._availableFields,features:this._features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},set:function(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}]),e}(),I=-1;!function(e){e[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL"}(i||(i={}));var D=(0,x.Ue)(),M=r(36734),A=r(93463),N="esri.views.3d.layers.support.FeatureTileFetcher3D",U=p.Z.getLogger(N),L=function(e){(0,l.Z)(r,e);var t=(0,c.Z)(r);function r(e){var i;return(0,u.Z)(this,r),(i=t.call(this,e))._useTileCount=!1,i.updating=!1,i.running=!1,i.updatingTotal=0,i.updatingRemaining=0,i.expectedFeatureDiff=0,i.maximumNumberOfFeaturesExceeded=!1,i.maximumNumberOfFeaturesExceededThrottle=1e3,i._fullRatio=1,i._farRatio=1,i._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},i._handles=new f.Z,i._frameTask=A.sq,i._dirty=!1,i._featureTiles=new Map,i._displayingFeatureReferences=new Map,i._numDisplayingFeatureReferences=0,i._suspended=!0,i._pendingEdits=null,i}return(0,o.Z)(r,[{key:"maximumNumberOfFeatures",set:function(e){e=e||1/0;var t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}},{key:"memoryFactor",set:function(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}},{key:"lodFactor",set:function(e){this.lodFactor!==e&&(this._set("lodFactor",e),this._supportsResolution&&this.refetch())}},{key:"useTileCount",get:function(){return this._useTileCount&&(0,v.pC)(this.context.query.queryFeatureCount)},set:function(e){this._useTileCount=e,this.notifyChange("useTileCount")}},{key:"memoryForUnusedFeatures",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.estimatedUnusedSize})),e}},{key:"totalVertices",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.numVertices})),e}},{key:"totalFeatures",get:function(){var e=0;return this._featureTiles.forEach((function(t){return e+=t.numFeatures})),e}},{key:"filterExtent",set:function(e){if((0,v.pC)(e)&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))U.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");else{var t=this._get("filterExtent");if(!(t===e||(0,v.pC)(t)&&e&&t.equals(e))){var r=(0,v.pC)(e)?e.clone():null;this._set("filterExtent",r),this._reclip(r,t)}}}},{key:"initialize",value:function(){var e=this;this._handles.add((0,m.on)((function(){return e.tileDescriptors}),"change",(function(){return e._setDirty()}),{onListenerAdd:function(){return e._setDirty()}})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?S:Z;var t=this.context.scheduler;(0,v.pC)(t)&&(this._frameTask=t.registerTask(A.T8.FEATURE_TILE_FETCHER,this)),this._setDirty()}},{key:"destroy",value:function(){var e,t=this;this._frameTask.remove(),this._handles=(0,v.SC)(this._handles),this._featureTiles.forEach((function(e){t._cancelFetchTile(e),t._removeTile(e)})),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),null!==(e=this._pendingEdits)&&void 0!==e&&e.controller.abort(),this._pendingEdits=null}},{key:"_paused",get:function(){return this._suspended||!!this._pendingEdits}},{key:"restart",value:function(){var e=this;this._featureTiles.forEach((function(t){e._cancelFetchTile(t),e._clearTile(t),e._resetFetchTile(t)})),(0,v.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}},{key:"refetch",value:function(){var e=this;this._featureTiles.forEach((function(t){e._cancelFetchTile(t),e._resetFetchTile(t)})),(0,v.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}},{key:"suspend",value:function(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}},{key:"resume",value:function(){this._suspended&&(this._suspended=!1,this._unpause())}},{key:"_pause",value:function(){var e=this;this._paused&&(this._featureTiles.forEach((function(t){return e._cancelFetchTile(t)})),this._updated())}},{key:"_unpause",value:function(){this._paused||(this._setDirty(),this._updated())}},{key:"availableFields",get:function(){var e=null;return this._featureTiles.forEach((function(t){(0,v.Wi)(t.displayingFeatures)||0===t.displayingFeatures.length||((0,v.Wi)(e)?e=new Set(t.availableFields):e.forEach((function(r){t.availableFields.has(r)||(0,v.Wg)(e).delete(r)})))})),(0,v.pC)(e)?e:new Set}},{key:"applyEdits",value:function(e){var t=this;this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());var r=this._pendingEdits;r.count++;var i=r.edits.then((function(){return e.result.catch((function(e){if((0,_.D_)(e))throw e;return null})).then((function(e){return e?(t._applyEditsDeleteFeatures(e.deletedFeatures),t._applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,r.controller.signal).then((function(){return e}))):e})).then((function(e){return 0==--r.count&&(t._pendingEdits===r&&(t._pendingEdits=null),(0,v.pC)(t.context.memoryCache)&&t.context.memoryCache.clear(),t._unpause(),t._updated()),e}))}));return r.edits=i,this._updated(),i}},{key:"_applyEditsDeleteFeatures",value:function(e){var t=this;if(0!==e.length){var r=this.context.globalIdField,i=r&&this.availableFields.has(r),n=new Set,a=this._objectIdField;e.forEach((function(e){var s=e.objectId,u=e.globalId;if((!s||s<0)&&r){i||U.errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(r," to be included the layer's outFields for updates to be reflected in the view"));var o=t.features.find((function(e){return e.attributes&&e.attributes[r]===u}));o&&n.add((0,E.MS)(o,a))}else n.add(s)})),this._featureTiles.forEach((function(e){if(e.features){var r=e.features.filter((function(e){return!n.has((0,E.MS)(e,t._objectIdField))}));r.length!==e.features.length&&(e.setFeatures(r,0,e.availableFields),t._invalidateCounts())}}))}}},{key:"_applyEditsAddUpdateFeatures",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,i){var n,s,u,o=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],s=new Set,t.forEach((function(e){return n.push(e.objectId)})),r.forEach((function(e){n.push(e.objectId),s.add(e.objectId)})),0!==n.length){e.next=3;break}return e.abrupt("return");case 3:return u=[],this._featureTiles.forEach((function(e){var t=o._applyEditsAddUpdateTile(e,n,s,i);t&&u.push(t)})),e.next=7,(0,_.as)(u);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_applyEditsAddUpdateTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r,i,s){var u,o,l,c,h,d,f,p=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.features){e.next=2;break}return e.abrupt("return");case 2:return(u=this._createQuery(t)).resultType=void 0,u.cacheHint=!1,u.objectIds=r,e.next=6,this._queryFeatures(u,s);case 6:if(o=e.sent,l=null,i.size>0&&(c=t.features.filter((function(e){return!i.has((0,E.MS)(e,p._objectIdField))}))).length!==t.features.length&&(l=c),o.features.length>0){l||(l=t.features.slice()),h=(0,n.Z)(o.features);try{for(h.s();!(d=h.n()).done;)f=d.value,l.push(f)}catch(a){h.e(a)}finally{h.f()}}l&&(t.hasPreciseFeatureCount&&(t.numFeatures=Math.max(t.numFeatures,l.length)),t.setFeatures(l,0,j(t.availableFields,o.fields)),this._invalidateCounts());case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,i,n){return e.apply(this,arguments)}}()},{key:"_queryFeatures",value:function(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:J})}},{key:"_setDirty",value:function(){this._dirty=!0,this._updated()}},{key:"runTask",value:function(e){var t=this;if(this._frameTask.processQueue(e),this._dirty&&this.initialized){this._dirty=!1;var r=this._getListOfTiles();if(this._markTilesNotAlive(r),e.run((function(){return t._addTiles(r,e)}))&&e.run((function(){return t._filterExtentTiles(r,e)}))&&e.run((function(){return t._removeTiles(r,e)}))&&!e.done){var i=this._sortTiles(r);e.run((function(){return t._showTiles(i,e)}))&&e.run((function(){return t._fetchTiles(i,e)}))&&e.run((function(){return t._updateMemoryEstimates(i,e)}))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}else this._setDirty()}}},{key:"_markTilesNotAlive",value:function(e){var t,r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){t.value.alive=!1}}catch(i){r.e(i)}finally{r.f()}}},{key:"_addTiles",value:function(e,t){var r=this;return!this._suspended&&(this.tileDescriptors.forEach((function(i){var n=r._featureTiles.get(i.id);n?n.alive=!0:t.done||(e.push(r._addTile(i)),t.madeProgress())})),t.hasProgressed)}},{key:"_filterExtentTiles",value:function(e,t){var r,i=(0,n.Z)(e);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(t.done)break;a.alive&&(a.filtered=!a.intersects(this.filterExtent),a.filtered&&(this._clearTile(a),t.madeProgress()))}}catch(s){i.e(s)}finally{i.f()}return t.hasProgressed}},{key:"_removeTiles",value:function(e,t){for(var r=e.length-1;r>=0&&!t.done;r--){var i=e[r];i.alive||(this._removeTile(i),r!==e.length-1&&(e[r]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}},{key:"_sortTiles",value:function(e){return e.sort((function(e,t){var r,i;return(null!==(r=e.descriptor.loadPriority)&&void 0!==r?r:0)-(null!==(i=t.descriptor.loadPriority)&&void 0!==i?i:0)})),e}},{key:"_showTiles",value:function(e,t){var r,i=this,a=this._updateRatio(e),s=(0,n.Z)(e);try{var u=function(){var e=r.value;if(!t.run((function(){return function(e){var t=i._fullRatio<1?a(e)*i._farRatio:1;return e.reduceFeatures(t,i.memoryFactor,i._objectIdField)&&i._setDirty(),i._showTile(e)}(e)})))return i._setDirty(),"break"};for(s.s();!(r=s.n()).done;){if("break"===u())break}}catch(o){s.e(o)}finally{s.f()}return t.hasProgressed}},{key:"_fetchTiles",value:function(e,t){var r=this;if(this._paused)return!1;var i,a=!1,s=(0,n.Z)(e);try{var u=function(){var e=i.value;if(!e.needsFetching)return"continue";var n=(0,v.pC)(r.context.memoryCache)?r.context.memoryCache.pop(e.id):null;if((0,v.pC)(n))e.cache=n,r._setDirty(),r._scheduleUpdated(),t.madeProgress();else{if(r._needsNumFeatures(e)){var s=new AbortController,u=r._fetchTileCount(e,s.signal);r._handleRequest(e,u,s,(function(){return e.numFeatures=-2})),a=!0,t.madeProgress()}if(t.done)return{v:!0}}};for(s.s();!(i=s.n()).done;){var o=u();if("continue"!==o&&"object"===typeof o)return o.v}}catch(f){s.e(f)}finally{s.f()}if(a)return t.hasProgressed;var l,c=(0,n.Z)(e);try{var h=function(){var e=l.value;if(e.needsFetching){var i=new AbortController,n=r._fetchTile(e,i.signal);if(r._handleRequest(e,n,i,(function(t){e.setFeatures([],0,null),r._invalidateCounts(),e.featuresMissing=!1,r.context.logFetchError(U,t)})),t.madeProgress())return{v:!0}}};for(c.s();!(l=c.n()).done;){var d=h();if("object"===typeof d)return d.v}}catch(f){c.e(f)}finally{c.f()}return t.hasProgressed}},{key:"_updateMemoryEstimates",value:function(e,t){var r=this;return e.some((function(e){return!t.run((function(){return e.updateMemoryEstimates()}))&&(r._setDirty(),!0)})),t.hasProgressed}},{key:"_reclip",value:function(e,t){if(this.initialized){var r=new Array;this._featureTiles.forEach((function(i){(0,v.Wi)(i.displayingFeatures)||0===i.displayingFeatures.length||(i.intersectionIncludingBorrowed(t,B),i.intersectionIncludingBorrowed(e,Y),(0,x.fS)(B,Y)||r.push(i))})),this._refreshDisplayingFeatures(r),this._updated()}}},{key:"_refreshDisplayingFeatures",value:function(e){var t,r=new Set,i=this._changes.updates,a=(0,n.Z)(e);try{for(a.s();!(t=a.n()).done;){var s=t.value;if(!(0,v.Wi)(s.displayingFeatures)){var u,o=(0,n.Z)(s.displayingFeatures);try{for(o.s();!(u=o.n()).done;){var l=u.value,c=(0,E.MS)(l,this._objectIdField);if(!r.has(c)){r.add(c);var h=this._displayingFeatureReferences.get(c).feature;i.removes.push(h),i.adds.push(h)}}}catch(d){o.e(d)}finally{o.f()}}}}catch(d){a.e(d)}finally{a.f()}this._applyChanges()}},{key:"_updated",value:function(){var e=this,t=0;this._paused||this._featureTiles.forEach((function(e){return e.isFetching?++t:0}));var r=this._dirty||!!this._pendingEdits||t>0;if(this._set("running",this._dirty),this._set("updating",r),r){var i=0,n=0,a=0,s=0,u=0,o=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach((function(t){if(++n,t.isFetching&&t.hasPreciseFeatureCount){var r=e._maximumFeaturesForTile(t)*(1-t.emptyFeatureRatio),l=(0,v.pC)(t.displayingFeatures)?t.displayingFeatures.length*o:0;u+=r-l}t.needsFetching?++s:t.numFeatures>0&&(++a,i+=t.numFeatures)})),s+=t;var l=0,c=0;i?(c=i,l=Math.min(s*i/a,i)):(c=n,l=s),u=Math.min(this.maximumNumberOfFeatures-this.features.length,u),this._set("updatingTotal",c),this._set("updatingRemaining",l),this._set("expectedFeatureDiff",u)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}},{key:"_updateMaximumNumberOfFeaturesExceeded",value:function(){var e=(0,y.oE)(this._featureTiles,(function(e){return e.perTileMaximumNumberOfFeaturesExceeded}));this._set("maximumNumberOfFeaturesExceeded",e)}},{key:"_updateRatio",value:function(e){var t,r=function(e){var t,r=0,i=(0,n.Z)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;a.features&&a.features.length>0&&a.alive&&(r=Math.max(r,a.descriptor.lij[0]))}}catch(s){i.e(s)}finally{i.f()}return r}(e),i=function(e){return 1/(1<<Math.max(0,r-e.descriptor.lij[0]))},a=0,s=0,u=(0,n.Z)(e);try{for(u.s();!(t=u.n()).done;){var o=t.value,l=o.numFeatures;a+=l,s+=l*i(o)}}catch(c){u.e(c)}finally{u.f()}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/a),this._farRatio=this.maximumNumberOfFeatures/s,this._scheduleUpdated(),i}},{key:"_maximumFeaturesUpdated",value:function(e,t){var r=this;e!==t&&(t>e&&this._featureTiles.forEach((function(e){if(e.featuresMissing){var t=r._maximumFeaturesForTile(e);e.features&&(e.features.length>=t||e.fetchStatus===i.FULL)||(r._cancelFetchTile(e),r._resetFetchTile(e))}})),this._setDirty())}},{key:"_addTile",value:function(e){var t=new V(e);return this._featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}},{key:"_referenceDisplayingFeaturesFromRelatedTiles",value:function(e){var t=this,r=e.descriptor.resolution;this._featureTiles.forEach((function(i){if(!((0,v.Wi)(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!(0,M.E9)(e.descriptor.lij,i.descriptor.lij))){(0,v.Wi)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&((0,v.Wi)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=(0,x.d9)(e.descriptor.extent)),(0,x.jn)(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));var a,s=(0,n.Z)(i.displayingFeatures);try{for(s.s();!(a=s.n()).done;){var u=a.value;e.displayingFeatures.push(u);var o=t._displayingFeatureReferences.get((0,E.MS)(u,t._objectIdField));o.ref(o.feature,r),t._numDisplayingFeatureReferences++}}catch(l){s.e(l)}finally{s.f()}}})),e.featureLimit=(0,v.pC)(e.displayingFeatures)?e.displayingFeatures.length:0}},{key:"_removeTile",value:function(e){this._clearTile(e),this._featureTiles.delete(e.id)}},{key:"_resetFetchTile",value:function(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=i.DONE):e.fetchStatus=i.FETCH_NEEDED}},{key:"_cancelFetchTile",value:function(e){var t=e.requestController;(0,v.pC)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}},{key:"_fetchTileCount",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchCount(t,r);case 2:return t.numFeatures=e.sent,this._updateRatio(this._getListOfTiles()),e.abrupt("return",t.fetchStatus===i.REFETCHING?i.REFETCH_NEEDED:i.FETCH_NEEDED);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,u,o,l,c,h,d,f,p,y=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((n=this._maximumFeaturesForTile(t))<=0)){e.next=3;break}return e.abrupt("return",z(t));case 3:if(s=this._getMaxRecordCount(t),u=Math.ceil(n/s),!(G(t)||!this.context.capabilities.supportsMaxRecordCountFactor||t.numFeatures<=n&&u>T.Z.MAX_MAX_RECORD_COUNT_FACTOR)){e.next=6;break}return e.abrupt("return",this._fetchPagedTile(t,r));case 6:return(o=this._createQuery(t)).maxRecordCountFactor=Math.ceil(n/s),t.isRefetching&&t.features&&t.features.length>0&&(l=Math.ceil(t.features.length/(1-t.emptyFeatureRatio)/s),o.maxRecordCountFactor=Math.max(l+1,o.maxRecordCountFactor)),e.next=10,this._queryFeatures(o,r);case 10:return c=e.sent,h=c.features,d=c.exceededTransferLimit,f=c.fields,p=d?o.maxRecordCountFactor>=T.Z.MAX_MAX_RECORD_COUNT_FACTOR?i.FULL:i.DONE:i.FULL,e.next=17,this._frameTask.schedule((function(){t.featuresMissing=h.length<t.numFeatures||!!d;var e=y._removeEmptyFeatures(h);t.setFeatures(h,e,Q(f))}),r);case 17:return(0,_.k_)(r),this._invalidateCounts(),e.abrupt("return",p);case 20:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchCount",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.context.query.queryFeatureCount(this._createFeatureCountQuery(t),{signal:r}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetchPagedTile",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,r){var n,s,u,o,l,c,h,d,f,p=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=0,u=0,o=0,l=this._maximumFeaturesForTile(t)-o,c=this._getMaxRecordCount(t),h=null,d=(0,a.Z)().mark((function e(){var d,f,y,m,g,b;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=p._createQuery(t),f=p._setPagingParameters(d,s,l,c),e.next=4,p._queryFeatures(d,r);case 4:return y=e.sent,m=y.features,g=y.exceededTransferLimit,b=y.fields,e.next=10,p._frameTask.schedule((function(){f&&(s+=(0,v.Wg)(d.num)),o+=m.length,u+=p._removeEmptyFeatures(m),t.featuresMissing=s<t.numFeatures||!!g,n=n?n.concat(m):m,h=j(h,b),t.setFeatures(n,u,h)}),r);case 10:if((0,_.k_)(r),p._invalidateCounts(),p._setDirty(),l=p._maximumFeaturesForTile(t)-o,f&&g&&!(l<=0)){e.next=16;break}return e.abrupt("return",{v:g?i.DONE:i.FULL});case 16:case"end":return e.stop()}}),e)}));case 4:return e.delegateYield(d(),"t0",5);case 5:if("object"!==typeof(f=e.t0)){e.next=8;break}return e.abrupt("return",f.v);case 8:e.next=4;break;case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createFeatureCountQuery",value:function(e){var t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}},{key:"_createQuery",value:function(e){var t=this.context.createQuery(),r=e.descriptor.extent;if(r){var i=this.context.tilingScheme.spatialReference;t.geometry=(0,x.HH)(r,i)}return this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"_setPagingParameters",value:function(e,t,r,i){return!!this.context.capabilities.supportsPagination&&(e.start=t,r>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(r/i),e.num=Math.min(e.maxRecordCountFactor*i,r)):e.num=Math.min(i),!0)}},{key:"_getEffectiveTileResolution",value:function(e){if(null==e.descriptor.resolution)return null;var t=this.context.viewingMode===w.JY.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}},{key:"_supportsResolution",get:function(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}},{key:"_setResolutionParams",value:function(e,t){if(this._supportsResolution){var r=this._getEffectiveTileResolution(t);null!=r&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new k.Z({mode:"view",originPosition:"upper-left",tolerance:r,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=r))}}},{key:"_removeEmptyFeatures",value:function(e){for(var t=e.length,r=0;r<e.length;){var i=e[r];(0,E.dF)(i.geometry)?++r:(e[r]=e[e.length-1],--e.length)}return t-e.length}},{key:"_needsNumFeatures",value:function(e){return this.useTileCount&&e.needsFeatureCount&&!G(e)}},{key:"_getMaxRecordCount",value:function(e){var t=this.context,r=t.tileMaxRecordCount,i=t.maxRecordCount;return this._useTileQuery(e)&&(0,v.pC)(r)&&r>0&&this.context.capabilities.supportsResultType?r:(0,v.pC)(i)&&i>0?i:W}},{key:"_useTileQuery",value:function(e){return(!G(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}},{key:"_handleRequest",value:function(e,t,r,n){var a=this;e.fetchStatus=e.needsRefetching?i.REFETCHING:i.FETCHING,e.requestController=r;var s=!1;t.then((function(t){e.requestController=null,e.fetchStatus=t})).catch((function(t){e.requestController===r&&(e.requestController=null,e.fetchStatus=i.DONE),(0,_.D_)(t)?s=!0:n(t)})).then((function(){s||a._setDirty(),a._scheduleUpdated()}))}},{key:"_scheduleUpdated",value:function(){var e=this;this._handles&&!this._handles.has("scheduleUpdated")&&this._handles.add((0,g.Os)((function(){e._handles.remove("scheduleUpdated"),e._updated()})),"scheduleUpdated")}},{key:"_showTile",value:function(e){if((0,v.pC)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;var t=e.features;if(0===e.featureLimit||!t){var r=(0,v.pC)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],r}var i=e.descriptor.resolution,n=this._changes.updates,a=this._changes.adds,s=Math.min(e.featureLimit,t.length);e.featureLimit=s;for(var u=0;u<s;++u){var o=t[u],l=(0,E.MS)(o,this._objectIdField),c=this._displayingFeatureReferences.get(l);if(c){var h=c.ref(o,i);h.oldVersion!==h.newVersion&&(h.oldVersion&&n.removes.push(h.oldVersion),h.newVersion&&n.adds.push(h.newVersion))}else this._displayingFeatureReferences.set(l,new this.FeatureReferenceClass(o,i)),a.push(o);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,s),!0}},{key:"_hideTile",value:function(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}},{key:"_hideTileFeatures",value:function(e){if(!(0,v.Wi)(e.displayingFeatures)){var t,r=this._changes.updates,i=this._changes.removes,a=(0,n.Z)(e.displayingFeatures);try{for(a.s();!(t=a.n()).done;){var s=t.value,u=(0,E.MS)(s,this._objectIdField),o=this._displayingFeatureReferences.get(u);if(o){var l=o.unref(e.descriptor.resolution);this._numDisplayingFeatureReferences--,l?l.oldVersion!==l.newVersion&&(null==l.newVersion?(this._displayingFeatureReferences.delete(u),l.oldVersion&&i.push(l.oldVersion)):(r.adds.push(l.newVersion),l.oldVersion&&r.removes.push(l.oldVersion))):console.error("Hiding unreferenced feature")}}}catch(c){a.e(c)}finally{a.f()}this._applyChanges(),e.displayingFeatures=null}}},{key:"_applyChanges",value:function(){var e=this._changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);for(var t=this._changes.adds,r=this._changes.removes,i=Math.min(t.length,r.length),n=0;n<i;){var a=Math.min(n+X,i);this.features.addMany(t.slice(n,a)),this.features.removeMany(r.slice(n,a)),n=a}t.length>i&&this.features.addMany(0===n?t:t.slice(n)),r.length>i&&this.features.removeMany(0===n?r:r.slice(n)),t.length=0,r.length=0}},{key:"_clearTile",value:function(e){if(this._hideTile(e),e.features&&(0,v.pC)(this.context.memoryCache)){var t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this._invalidateCounts()}},{key:"_invalidateCounts",value:function(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}},{key:"_getListOfTiles",value:function(){return Array.from(this._featureTiles.values())}},{key:"storedFeatures",get:function(){return this._getListOfTiles().reduce((function(e,t){return e+(t.features?t.features.length:0)}),0)}},{key:"missingTiles",get:function(){return Array.from(this._featureTiles.values()).reduce((function(e,t){return e+(t.needsFetching||t.isFetching?1:0)}),0)}},{key:"_maximumFeaturesForTile",value:function(e){var t=e.hasPreciseFeatureCount?e.numFeatures:1/0,r=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,i=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(r*i/(1-e.emptyFeatureRatio)),t)}},{key:"test",get:function(){var e=this;return{process:function(t){return e.runTask(t)},getFeatureTileById:function(t){return e._featureTiles.get(t)},forEachFeatureTile:function(t){return e._featureTiles.forEach(t)}}}}]),r}(d.Z);function G(e){return"dummy-tile-full-extent"===e.id}function H(e){var t=e.capabilities.query;return{supportsMultipleResolutions:q(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function q(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function z(e){return e.setFeatures([],0,null),e.featuresMissing=!1,i.DONE}function Q(e){return(0,v.Wi)(e)?new Set:new Set(e.map((function(e){return e.name})))}function j(e,t){if((0,v.Wi)(e)||(0,v.Wi)(t))return Q(t);var r,i=new Set,a=(0,n.Z)(t);try{for(a.s();!(r=a.n()).done;){var s=r.value.name;e.has(s)&&i.add(s)}}catch(u){a.e(u)}finally{a.f()}return i}(0,h._)([(0,b.Cb)({constructOnly:!0})],L.prototype,"features",void 0),(0,h._)([(0,b.Cb)()],L.prototype,"tileDescriptors",void 0),(0,h._)([(0,b.Cb)({value:1/0})],L.prototype,"maximumNumberOfFeatures",null),(0,h._)([(0,b.Cb)({value:1})],L.prototype,"memoryFactor",null),(0,h._)([(0,b.Cb)({value:1})],L.prototype,"lodFactor",null),(0,h._)([(0,b.Cb)()],L.prototype,"useTileCount",null),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"updating",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"running",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"updatingTotal",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"updatingRemaining",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"expectedFeatureDiff",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"memoryForUnusedFeatures",null),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,h._)([(0,b.Cb)({constructOnly:!0})],L.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"totalVertices",null),(0,h._)([(0,b.Cb)({readOnly:!0})],L.prototype,"totalFeatures",null),(0,h._)([(0,b.Cb)()],L.prototype,"filterExtent",null),(0,h._)([(0,b.Cb)({constructOnly:!0})],L.prototype,"context",void 0),L=(0,h._)([(0,C.j)(N)],L);var W=2e3,B=(0,x.Ue)(),Y=(0,x.Ue)(),J=6e5,X=200},26511:function(e,t,r){r.d(t,{n:function(){return C}});var i=r(74165),n=r(15861),a=r(15671),s=r(43144),u=r(60136),o=r(92572),l=r(27366),c=r(14921),h=r(41691),d=r(32718),f=r(92026),p=r(66978),y=r(94172),v=r(49861),_=(r(25243),r(63780),r(69912)),m=r(18661),g=r(87072),b=r(82607),F=r(93463),C=function(e){(0,u.Z)(r,e);var t=(0,o.Z)(r);function r(e){var s;return(0,a.Z)(this,r),(s=t.call(this,e))._updateTask=null,s._frameTask=null,s._queryEngine=null,s._updateRequested=!0,s._updateVisibility=function(){var e=(0,n.Z)((0,i.Z)().mark((function e(t){var r;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((0,f.Wi)(s._compositedFeatureFilter)&&(0,f.Wi)(s._sceneFilter)||0===s.context.getFeatureCount())){e.next=2;break}return e.abrupt("return",s._frameTask.schedule((function(){return s.clear()}),t));case 2:return e.prev=2,e.next=5,s._queryEngine.executeQueryForIdSet(s._compositedFeatureFilter,s._sceneFilter,t);case 5:return r=e.sent,e.abrupt("return",s._frameTask.schedule((function(){s.context.updateFeatureVisibilities((function(e){return r.has(e)}))}),t));case 9:return e.prev=9,e.t0=e.catch(2),e.abrupt("return",((0,p.r9)(e.t0),d.Z.getLogger(s.declaredClass).warn("FeatureFilter query failed: ".concat(e.t0),{error:e.t0}),s._frameTask.schedule((function(){s.context.setAllFeaturesVisibility(!0)}),t)));case 12:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(t){return e.apply(this,arguments)}}(),s}return(0,s.Z)(r,[{key:"initialize",value:function(){var e=this,t=F.T8.FILTER_VISIBILITY,r=this._layerView,i=r.layer,n=r.view,a=this.context.featureStore,s="hasZ"in this._layerView&&this._layerView.hasZ,u="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new b.q({context:{spatialReference:n.spatialReference,layer:i,scheduler:n.resourceController.scheduler,featureStore:a,hasM:u,hasZ:s},priority:t}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(t,this),this.updatingHandles.add((function(){return[e._compositedFeatureFilter,e._sceneFilter]}),(function(){return e.reapply()}),y.nn)}},{key:"destroy",value:function(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=(0,f.IM)(this._updateTask),this._frameTask=(0,f.hw)(this._frameTask),this._queryEngine=(0,f.SC)(this._queryEngine),this._set("context",null)}},{key:"updating",get:function(){return this.running||this.updatingHandles.updating||(0,f.pC)(this._updateTask)&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return(0,f.Wi)(this._compositedFeatureFilter)&&(0,f.Wi)(this._sceneFilter)}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return(0,g.c)(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){var e=this._featureFilter,t=this._timeExtent,r=this._floorFilter;if((0,f.Wi)(t)&&(0,f.Wi)(r))return e;var i=(0,f.pC)(e)?e.clone():new m.Z;if((0,f.pC)(t)&&(i.timeExtent=(0,f.pC)(i.timeExtent)?i.timeExtent.intersection(t):t),(0,f.pC)(r)){var n=(0,f.Wi)(i.where)||""===i.where;i.where=n?r:"(".concat(i.where,") AND (").concat(r,")")}return i}},{key:"_layerView",get:function(){return this.context.layerView}},{key:"reapply",value:function(){this._updateRequested=!0}},{key:"clear",value:function(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}},{key:"runTask",value:function(e){this._updateRequested&&(this._updateTask=(0,f.IM)(this._updateTask),this._updateTask=(0,c.vr)(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e)}}]),r}(h.r);(0,l._)([(0,v.Cb)({constructOnly:!0})],C.prototype,"context",void 0),(0,l._)([(0,v.Cb)()],C.prototype,"updating",null),(0,l._)([(0,v.Cb)()],C.prototype,"running",null),(0,l._)([(0,v.Cb)()],C.prototype,"defaultVisibility",null),(0,l._)([(0,v.Cb)()],C.prototype,"_featureFilter",null),(0,l._)([(0,v.Cb)()],C.prototype,"_sceneFilter",null),(0,l._)([(0,v.Cb)()],C.prototype,"_floorFilter",null),(0,l._)([(0,v.Cb)()],C.prototype,"_timeExtent",null),(0,l._)([(0,v.Cb)()],C.prototype,"_compositedFeatureFilter",null),(0,l._)([(0,v.Cb)()],C.prototype,"_layerView",null),(0,l._)([(0,v.Cb)()],C.prototype,"_updateTask",void 0),(0,l._)([(0,v.Cb)()],C.prototype,"_updateRequested",void 0),C=(0,l._)([(0,_.j)("esri.views.3d.layers.support.FeatureVisibilityFilter")],C)},99879:function(e,t,r){function i(e,t,r){if(!r||null==t)return null;if(!e)return function(e,t){var r=t.toLowerCase();for(var i in e)if(i.toLowerCase()===r)return e[i];return null}(t,r);var i=e.get(r);return i?t[i.name]:null}r.d(t,{g:function(){return i}})},5198:function(e,t,r){r.d(t,{g:function(){return d}});var i=r(93433),n=r(37762),a=r(15671),s=r(43144),u=r(60136),o=r(92572),l=r(91505),c=r(62314),h=r(92377),d=function(e){(0,u.Z)(r,e);var t=(0,o.Z)(r);function r(){var e;return(0,a.Z)(this,r),(e=t.apply(this,arguments))._set=new Set,e}return(0,s.Z)(r,[{key:"clear",value:function(){if(this._set.size>0){var e=this.toArray();this._set.clear(),this.emit("after-changes",{type:c.y.REMOVE}),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._set.size}},{key:"addMany",value:function(e){if(0!==e.length){var t,r=(0,n.Z)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;this._set.add(i)}}catch(a){r.e(a)}finally{r.f()}this.emit("after-changes",{type:c.y.ADD}),this.emit("change",{added:e,removed:[]})}}},{key:"remove",value:function(e){this._set.delete(e)&&(this.emit("after-changes",{type:c.y.REMOVE}),this.emit("change",{added:[],removed:[e]}))}},{key:"removeMany",value:function(e){var t,r=[],i=(0,n.Z)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;this._set.delete(a)&&r.push(a)}}catch(s){i.e(s)}finally{i.f()}r.length>0&&(this.emit("after-changes",{type:c.y.REMOVE}),this.emit("change",{added:[],removed:r}))}},{key:"toArray",value:function(){return(0,i.Z)(this._set)}},{key:"find",value:function(e){var t;return(0,h.f)(this._set,(function(r){return!!e(r)&&(t=r,!0)})),t}},{key:"forEach",value:function(e){this._set.forEach((function(t){return e(t)}))}}]),r}(l.Z)},34552:function(e,t,r){r.d(t,{v:function(){return s}});var i=r(10064),n=r(92026),a=r(8548);function s(e,t){var r=e.capabilities,s=r.textureFloat,u=r.colorBufferFloat,o=null===s||void 0===s?void 0:s.textureFloat,l=null===s||void 0===s?void 0:s.textureFloatLinear,c=null===s||void 0===s?void 0:s.textureHalfFloat,h=null===s||void 0===s?void 0:s.textureHalfFloatLinear,d=null===s||void 0===s?void 0:s.HALF_FLOAT,f=null===u||void 0===u?void 0:u.textureFloat,p=null===u||void 0===u?void 0:u.textureHalfFloat,y=null===u||void 0===u?void 0:u.floatBlend,v=(0,n.s3)(e.driverTest).floatBufferBlend.result;if(!o&&!c)throw new i.Z("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float or OES_texture_half_float.");if(!f&&!p)throw new i.Z("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(y&&v||p))throw new i.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(v?"":" This device claims support for EXT_float_blend, but does not actually support it."));var _=o&&f&&y&&v,m=c&&p,g=l,b=h,F=!(null===u||void 0===u||!u.R32F),C=!(null===u||void 0===u||!u.R16F);if(_&&(g||!b))return g||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),{dataType:a.Br.FLOAT,samplingMode:g?a.cw.LINEAR:a.cw.NEAREST,pixelFormat:F?a.VI.RED:a.VI.RGBA,internalFormat:F?a.lP.R32F:a.VI.RGBA};if(m)return b||t.warnOnce("Missing WebGL extension OES_texture_half_float_linear. Heatmap quality may be reduced."),{dataType:d,samplingMode:b?a.cw.LINEAR:a.cw.NEAREST,pixelFormat:C?a.VI.RED:a.VI.RGBA,internalFormat:C?a.lP.R16F:a.VI.RGBA};throw new i.Z("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}}}]);
//# sourceMappingURL=27826.e2d4e58a.chunk.js.map