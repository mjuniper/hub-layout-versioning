"use strict";(self.webpackChunkhub_layout_versioning=self.webpackChunkhub_layout_versioning||[]).push([[63449,41863],{54748:function(e,t,i){i.d(t,{Z:function(){return Ge}});var n=i(29439),r=i(15671),a=i(43144),s=i(60136),o=i(92572),d=i(27366),l=i(31319),u=i(100),h=i(93169),c=i(32718),_=i(92026),f=i(27546),v=i(67426),g=i(66978),p=i(94172),m=i(49861),y=(i(25243),i(63780)),b=i(69912),x=i(79803),C=i(65156),k=i(65618),N=i(41388),w=i(50951),D=i(93463),I=function(e){(0,s.Z)(i,e);var t=(0,o.Z)(i);function i(){var e;return(0,r.Z)(this,i),(e=t.call(this)).referenceCount=0,e.callbacks=new Array,e.runIndex=0,e}return(0,a.Z)(i,[{key:"running",get:function(){return this.callbacks.some((function(e){return e.running}))}},{key:"runTask",value:function(e){this._sort();for(var t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0},n=0;n<t.length&&!e.done;++n)t[n].priority=t[n].runTask(e,i),this.runIndex=n}},{key:"_sort",value:function(){for(var e=this.callbacks,t=e.length,i=this.runIndex;i>0;i--){for(var n=e[i-1],r=i;r<e.length&&n.priority<=e[r].priority&&(r!==t||n.priority<e[r].priority);)e[r-1]=e[r],r++;e[r-1]=n,t=r-1}this.runIndex=0}},{key:"add",value:function(e){this._sort(),e.priority=1/0,this.callbacks.unshift(e),this.notifyChange("running")}},{key:"remove",value:function(e){(0,y.e$)(this.callbacks,e),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}}]),i}(l.Z);(0,d._)([(0,m.Cb)({readOnly:!0})],I.prototype,"running",null),I=(0,d._)([(0,b.j)("esri.views.3d.layers.i3s.I3SFrameTask")],I);var P=(0,a.Z)((function e(t,i){(0,r.Z)(this,e),this.task=t,this.handle=i})),L=new Map;function S(e,t){var i=L.get(e);if(null==i){var n=new I,r=e.registerTask(D.T8.I3S_CONTROLLER,n);i=new P(n,r),L.set(e,i)}return i.task.add(t),{remove:function(){null!=i&&(i.task.remove(t),i.task.callbacks.length>0||(L.delete(e),i.handle.remove(),i.task.destroy()),i=null)}}}var O=i(37762),F=i(11186),M=i(67077),A=i(95964),T=i(44011),E=i(89414),R=(0,a.Z)((function e(t,i,n,a,s){(0,r.Z)(this,e),this.childOffset=t,this.childCount=i,this.visibilityCache=n,this.ref=a,this.node=s,this.useAsHole=0,this.filterImpact=A.U_.NotChecked})),V=function(){function e(t,i,n,a,s,o,d,l,u,h,c,_,v,g){(0,r.Z)(this,e),this._streamDataController=n,this._viewportQueries=a,this._logger=s,this.holeFilling=o,this._isLoaded=d,this._isReloading=l,this._isSelected=u,this._enable=h,this._needsUpdate=c,this._canRequest=_,this._computeVisibilityObb=v,this._computeNodeFiltering=g,this._dirty=!0,this._nodePages=[],this._nodeCount=0,this._nodesPerPage=0,this._rootIndex=0,this._lodMetric=A.w5.None,this._lodConversion=function(e){return e},this._urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=W(0),this._visibilityCacheVersion=W(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new f.Z({deallocator:null}),this._prefetch=new f.Z({deallocator:null}),this._updates=new j(this._missing),this._imModificationUncategorized=new f.Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this._lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}return(0,a.Z)(e,[{key:"_init",value:function(e){if("page"===e.type){switch(this._urlPrefix=e.urlPrefix,this._nodesPerPage=e.pageSize,this._rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this._lodMetric=A.w5.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=A.w5.MaxScreenThreshold,this._lodConversion=J}this._addPage(Q(this._rootIndex,this._nodesPerPage),e.rootPage),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new A.$i(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}}},{key:"_loadPage",value:function(e){var t=this;this._loading.add(e);var i=this._urlPrefix+e;this._streamDataController.request(i,"json").then((function(i){t._pageQueue.push({pageIndex:e,page:i})})).catch((function(i){t._loading.delete(e),(0,g.D_)(i)||(t._failedPages.add(e),t._logger.error("#loadPage()",t._logLayer,"Error when loading page ".concat(e),i))}))}},{key:"_addQueuedPages",value:function(e){for(;this._pageQueue.length>0&&!e.done;){var t=this._pageQueue.shift(),i=t.pageIndex,n=t.page;this._addPage(i,n),this._loading.delete(i),e.madeProgress()}this._updateParentsAndLevel()}},{key:"_addPage",value:function(e,t){for(var i=this,n=this._nodePages.length;n<e;n++)this._nodePages[n]=null;var r=[],a=[],s=t.nodes.map((function(t,n){var s=r.length,o=t.children?t.children.length:0;a.push(-1);for(var d=0;d<o;d++)r.push(t.children[d]);var l="".concat(t.index),u=(0,E.d9)(t.obb),h=(0,M.b)([u.center[0],u.center[1],u.center[2],(0,F.l)(u.halfSize)]),c=t.mesh&&t.mesh.attribute,_=t.mesh&&t.mesh.geometry,f=t.mesh&&t.mesh.material,v={hasSharedResource:!1,hasFeatureData:!!_,attributes:c&&null!=c.resource?"".concat(c.resource):void 0,geometry:_&&null!=_.resource?"".concat(_.resource):void 0,texture:f&&null!=f.resource?"".concat(f.resource):void 0,geometryDefinition:_?_.definition:-1,materialDefinition:f?f.definition:-1},g=new A.NB(l,e*i._nodesPerPage+n,h,o,0,v,i._lastUpdate,i._lodMetric,i._lodConversion(t.lodThreshold),_?_.featureCount:null);return g.serviceObb=u,g.visibilityObb=i._computeVisibilityObb(g),g.vertexCount=_?_.vertexCount:0,new R(s,o,G(i._visibilityCacheVersion),null,g)}));this._nodePages[e]={nodes:s,children:r,parents:a},this._nodeCount+=s.length}},{key:"_updateParentsAndLevel",value:function(){var e=this,t=new Array,i=function(i,n,r){var a=e._getPage(i);if((0,_.pC)(a)){var s=z(i,e._nodesPerPage);a.parents[s]=n;var o=a.nodes[s].node;(0,_.pC)(o)&&(o.level=r,t.push(i))}};for(i(this._rootIndex,-1,0);t.length;){var n=t.pop(),r=this.getNode(n);if((0,_.pC)(r))for(var a=0;a<r.childCount;a++)i(this.getChildIndex(r.index,a),n,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}},{key:"_getPage",value:function(e){return this._nodePages[Q(e,this._nodesPerPage)]}},{key:"_getNodeInternal",value:function(e){var t=this._getPage(e);return(0,_.Wi)(t)?null:t.nodes[z(e,this._nodesPerPage)]}},{key:"_addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),n=(0,_.pC)(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?n+1:n);var r=function(e){if(e)for(var t=0;t<e.length;t++){var i,n=(0,O.Z)(K);try{for(n.s();!(i=n.n()).done;){var r=i.value;if(r[0]===e[t].metricType)return{lodMetric:r[1],maxError:e[t].maxError}}}catch(a){n.e(a)}finally{n.f()}}return{lodMetric:A.w5.None,maxError:0}}(e.lodSelection),a=r.lodMetric,s=r.maxError,o=(0,_.Wg)(this._getNodeInternal(t));return o.node=new A.NB(e.id,t,(0,M.b)(e.mbs),o.childCount,n,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=(0,E.d9)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),(0,_.pC)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"_makeRefNode",value:function(e,t){var i=this._nodePages[0];if(null==i)return-1;var n=i.nodes.length;return i.nodes.push(new R(0,0,G(this._visibilityCacheVersion),e,null)),this._nodeCount++,i.parents.push(t),(0,T.WD)(e.renderMbs),(0,T.VL)(e.serviceObbInRenderSR),n}},{key:"populateChildren",value:function(e,t){var i=(0,_.Wg)(this._getNodeInternal(e)),n=(0,_.Wg)(this._getPage(e));i.childOffset=n.children.length,i.childCount=t.length;for(var r=0;r<t.length;r++){var a=this._makeRefNode(t[r],e);n.children.push(a)}}},{key:"getNode",value:function(e){var t=this._getNodeInternal(e);return(0,_.pC)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this._forAllNodes((function(i,n){((0,_.pC)(i.node)&&i.node.id===e||(0,_.pC)(i.ref)&&i.ref.id===e)&&(t=n)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var i=this._getPage(e);if((0,_.Wi)(i))return-1;var n=i.nodes[z(e,this._nodesPerPage)];return i.children[n.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this._getPage(e);return(0,_.pC)(t)?t.parents[z(e,this._nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this._getNodeInternal(e);return(0,_.pC)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this._rootIndex)}},{key:"size",get:function(){return this._nodeCount}},{key:"removeAllGeometryObbs",value:function(){this._forAllNodes((function(e){(0,_.pC)(e.node)&&(e.node.geometryObb=null)}))}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=W(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this._getNodeInternal(e);(0,_.pC)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=G(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this._getNodeInternal(e);(0,_.pC)(t)&&(Z(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"updateElevationChanged",value:function(e){var t=this._getNodeInternal(e);if(!(0,_.Wi)(t))if(this.needNodeElevationRange){var i=(0,_.pC)(t.node)?t.node:t.ref;if(!(0,_.Wi)(i)){var n=i.elevationRange;(0,_.Wi)(n)||(n.valid=!1)}}else this.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){var t=this._getNodeInternal(e);(0,_.pC)(t)&&(0,_.pC)(t.node)&&(t.node.geometryObb=null,(0,T.WD)(t.node.renderMbs),(0,T.VL)(t.node.serviceObbInRenderSR))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;(0,_.Wi)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"_updateElevationRange",value:function(e){var t=this._getNodeInternal(e);if((0,_.Wi)(t))return null;var i=(0,_.pC)(t.node)?t.node:t.ref;if((0,_.Wi)(i))return null;var n=i.elevationRange;if((0,_.pC)(n)&&n.valid)return n;for(var r=new A.rw,a=!1,s=0;s<t.childCount;s++){var o=this._updateElevationRange(this.getChildIndex(e,s));(0,_.Wi)(o)?a=!0:(r.min=Math.min(r.min,o.min),r.max=Math.max(r.max,o.max))}if(0===t.childCount||a&&(0,_.pC)(t.node)&&t.node.resources.geometry){var d=this._viewportQueries.getElevationRange(i);(0,_.pC)(d)&&(r.min=Math.min(r.min,d.min),r.max=Math.max(r.max,d.max))}return(0,_.pC)(n)&&n.min===r.min&&n.max===r.max?(n.valid=!0,n):(r.valid=!0,i.elevationRange=r,this.invalidateBoundingVolumeCache(e),r)}},{key:"isNodeVisible",value:function(e){var t=this._getNodeInternal(e);if((0,_.Wi)(t)||(0,_.pC)(t.ref)&&!t.ref.mbs)return!0;if(this.needNodeElevationRange&&this._updateElevationRange(e),!B(t.visibilityCache,this._visibilityCacheVersion)){var i=t.node,n=(0,_.pC)(i)&&((0,_.Wi)(t.ref)||(0,_.pC)(i.visibilityObb))?i:(0,_.pC)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&((0,_.pC)(i)||(0,_.pC)(t.ref))&&t.filterImpact===A.U_.NotChecked){var r=(0,_.pC)(i)?i.mbs:(0,_.pC)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=r?this._computeNodeFiltering(r):A.U_.Unmodified}var a=(0,_.pC)(i)&&t.filterImpact===A.U_.Culled,s=!((0,_.pC)(i)&&i.imModificationImpact===A.O4.Culled)&&(!n||this._viewportQueries.isNodeVisible(n))&&!a;return t.visibilityCache=q(s,this._visibilityCacheVersion),s}return H(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this._getNodeInternal(e);return!((0,_.pC)(t)&&(0,_.pC)(t.node)&&(0,_.pC)(t.node.geometryObb)&&(!this.layerHasModifications||t.node.imModificationImpact!==A.O4.NotChecked))||this._viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,i,n,r){var a=this._getPage(e);if(!(0,_.Wi)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,d=t.childOffset;d<s;++d){var l=a.children[d],u=this._getNodeInternal(l);(0,_.pC)(u)&&(0,_.pC)(u.node)&&this.isGeometryVisible(l)&&o.push(u)}n/=o.length;for(var h=0,c=o;h<c.length;h++){var f=c[h],v=(0,_.Wg)(f.node).index;this._isLoaded(v)||this._isReloading(v)?(r.delta=Math.max(r.delta,i),r.coverage+=n):this._traverseCoverage(v,f,i+1,n,r)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this._getNodeInternal(e);if((0,_.Wi)(t))return!1;if("always"===this.holeFilling)return!0;if(B(t.useAsHole,this._version))return H(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var n=i.delta*i.coverage<=.5;return t.useAsHole=q(n,this._version),n}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=W(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this._forAllNodes((function(e){var i=e.node;(0,_.pC)(i)&&(i.imModificationImpact=A.O4.NotChecked,i.visibilityObb=t._computeVisibilityObb(i),i.hasModifications&&t.invalidateGeometryVisibility(i.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this._forAllNodes((function(e){if((0,_.pC)(e)){e.filterImpact=A.U_.NotChecked;var i=e.node;(0,_.pC)(i)&&t.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,i){var n=this;if(this._dirty){this._pageQueue.length>0&&this._addQueuedPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),U.clear();var r=!0,a=new Y,s=new Y,o=this._imModificationUncategorized;o.clear();var d=new Set;this.traverseVisible((function(l,u,h){if((0,_.Wi)(u)){var c=n._entryPriority(l);c===1/0&&(c=n._entryPriority(h));var f=Q(l,n._nodesPerPage);return U.set(f,Math.max(c,U.get(f)||0)),n._loading.has(f)||n._failedPages.has(f)||n._missing.push(f),void(n._maxProcessingPrio=Math.max(n._maxProcessingPrio,c))}var v=u.node;if(n._updateNodeFeatureEstimate(v,s),(0,_.Wi)(v)){var g=n._entryPriority(l);return n._loading.has(l)||n._failedNodes.has(l)||(n._missing.push(l),U.set(l,g)),void(n._maxProcessingPrio=Math.max(n._maxProcessingPrio,g))}var p=(0,_.Wg)(n._getPage(l));if(0===n._missing.length&&0===n._nodesPerPage)for(var m=0;m<u.childCount;m++){var y=p.children[u.childOffset+m],b=n._getNodeInternal(y);!(0,_.pC)(b)||b.node||n._loading.has(y)||n._failedNodes.has(y)||(U.set(y,n._entryPriority(y)),n._prefetch.push(y))}if(!v.failed&&v.resources.hasFeatureData)if(d.add(v.id),n._isLoaded(l)){if(a.known+=v.memory,++a.knownNodes,n._isSelected(v)?u.childCount>0&&(r=!1):(a.unremoved+=v.memory,r=!1),n._needsUpdate(v)){var x=n._entryPriority(l);U.set(l,x),n._maxProcessingPrio=Math.max(n._maxProcessingPrio,x),n._updates.update.push(l)}}else if(v.memory&&(a.known+=v.memory,++a.knownNodes),n._isSelected(v)){if(u.childCount>0&&(r=!1),v.memory?(a.missing+=v.memory,a.known+=v.memory,++a.knownNodes):++a.missingNodes,e.includes(v.index))return n._maxProcessingPrio=Math.max(n._maxProcessingPrio,n._entryPriority(l)),void(n._updates.cancel=n._updates.cancel.filter((function(e){return e!==v.index})));if(t.done||!n._enable(v)){var C=n._entryPriority(l);U.set(l,C),n._maxProcessingPrio=Math.max(n._maxProcessingPrio,C),n._updates.add.push(l),n.layerHasModifications&&i&&(0,_.pC)(v)&&v.imModificationImpact===A.O4.NotChecked&&o.push(l)}else t.madeProgress()}else n._isReloading(l)&&n._updates.remove.push(l);else r&&u.childCount>0&&n._isSelected(v)&&(r=!1)}));var l=this._updates.add;l.length>0&&this.layerHasModifications&&(o.length>0&&null!==i&&void 0!==i&&i(o),l.filterInPlace((function(e){var t=n._getNodeInternal(e),i=(0,_.Wi)(t)||(0,_.Wi)(t.node)||t.node.imModificationImpact!==A.O4.Culled;return i||n.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=r,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||n._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return U.get(e)-U.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=U.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return U.get(e)>=n._maxUnloadedPrio})).sort((function(e,t){return U.get(e)-U.get(t)})),this._updates.update.sort((function(e,t){return U.get(e)-U.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,U.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var i=this._viewportQueries.updateScreenSpaceErrorBias(t),n=t,r=t,a=i,s=10;s--;){var o=new Y;if(this._updateFeatureEstimate(n,o),this._computeFeatureEstimate(o)<=e){if(n>=t||o.missingNodes>0||0===s)break;a=n,n=.5*(n+r)}else r=n,n=.5*(n+a)}return this._version=W(this._version),this._viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,n)}},{key:"_updateFeatureEstimate",value:function(e,t){var i=this;this._version=W(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,n){return i._updateNodeFeatureEstimate((0,_.pC)(n)?n.node:void 0,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!((0,_.Wi)(e)||e.failed||(0,_.Wi)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&((0,_.pC)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return U.get(e)-U.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this._nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return!0}},{key:"isLoading",get:function(){return this._indexMissing>0}},{key:"isPrefetching",get:function(){return this._prefetch.length>0}},{key:"indexLoading",get:function(){return this._loading.size}},{key:"indexMissing",get:function(){return this._indexMissing}},{key:"unloadedMemoryEstimate",get:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"maxPriority",get:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"nodeTraversalState",value:function(e){if((0,_.Wi)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&B(t.version,this._version))return t;var i=this._viewportQueries.getLodLevel(e),n=this._viewportQueries.hasLOD(e),r=!0;if(n){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);r=!!s&&i>s.lodLevel}else r=i>0}else r=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=r,t.version=q(!0,this._version),t):(t=new A.oQ(n,r,i,q(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var i=(0,_.Wg)(this._getNodeInternal(e)).ref;if((0,_.Wi)(i))this._failedNodes.add(e);else{var n=i.id,r=this._urlPrefix+n,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this._streamDataController.request(r,"json").then((function(i){a();var r=t._validateNode(n,i);if(null!=r){r.obb&&t.invalidateNodeVisibilityCache(e);var s=t._addNode(r,e);t.nodeTraversalState(s)}}),(function(i){a(),(0,g.D_)(i)||(t._logger.error("#loadNode()",t._logLayer,"Error loading node: "+r),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var i=this;if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this._logger.warn("#validateNode()",this._logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this._logger.warn("#validateNode()",this._logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var n=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,r=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var n=function(t){return i._logger.error("#validateNode()",i._logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)n("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return n("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return n("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&i._logger.error("#validateNode()",i._logLayer,'Invalid node href on node "'.concat(e,'"'));var r=t.hasOwnProperty("obb")&&!i.ignoreServiceObb?t.obb:null,a=new A.$i("".concat(t.id),t.mbs);return a.serviceObb=r,a.visibilityObb=i._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:n,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:r}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((function(e){(0,_.pC)(e.node)&&(e.node.failed=!1)}))}},{key:"_entryPriority",value:function(e){var t=this._getNodeInternal(e),i=this.getParentIndex(e);if((0,_.Wi)(t)||i<0&&null==t.node)return i<0?1/0:this._entryPriority(i);var n=0;if(t.node&&i>=0){var r=this._nodeTraversalState.get(i);null!=r&&(n=r.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=(0,_.pC)(t.ref)?this._viewportQueries.distToPOI(t.ref):(0,_.pC)(t.node)?this._viewportQueries.distToPOI(t.node):0;return-o-n*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this._getNodeInternal(this._rootIndex);(0,_.Wi)(t)?e(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,i,n){if(i.node&&0===i.childCount)this.isGeometryVisible(e)&&n(e,i,t);else if(this.isNodeVisible(e)&&(n(e,i,t),null!=i.node)){var r=this.nodeTraversalState(i.node);if(null===r||void 0===r||!r.nodeHasLOD||r.lodLevel!==this._maxLodLevel)for(var a=(0,_.Wg)(this._getPage(e)),s=0;s<i.childCount;s++){var o=a.children[i.childOffset+s],d=this._getNodeInternal(o);(0,_.pC)(d)?this._traverseVisible(o,e,d,n):n(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var i=e.index,n=this._getNodeInternal(i);(0,_.pC)(n)&&this._traverseChildren(i,n,t)}},{key:"_traverseChildren",value:function(e,t,i){var n=this._getPage(e);if(!(0,_.Wi)(n))for(var r=t.childOffset+t.childCount,a=t.childOffset;a<r;++a){var s=n.children[a],o=this._getNodeInternal(s);(0,_.pC)(o)&&(0,_.pC)(o.node)&&i(o.node)&&this._traverseChildren(s,o,i)}}},{key:"updateChildrenLoaded",value:function(e,t){for(var i=this.getNode(e);(0,_.pC)(i);)i.childrenLoaded+=t,i=this.getParent(i.index)}},{key:"checkChildrenLoadedInvariant",value:function(){var e=this;if((0,_.Wi)(this.rootNode))return!0;var t=[];return function i(n){var r=e._isLoaded(n.index)||e._isReloading(n.index)?1:0;return e.traverseChildren(n,(function(e){return r+=i(e),!1})),n.childrenLoaded!==r&&t.push(n.index),r}(this.rootNode),t.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+t.join(",")),t.length>0}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||0),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"updateElevationInfo",value:function(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}},{key:"invalidateAllElevationRanges",value:function(){this._forAllNodes((function(e){Z(e),(0,_.pC)(e.node)&&(e.node.elevationRange=null),(0,_.pC)(e.ref)&&(e.ref.elevationRange=null)}))}},{key:"_forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var i=this._nodePages[t];if(i)for(var n=t*this._nodesPerPage,r=0;r<i.nodes.length;r++)e(i.nodes[r],n+r)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,i){return e._addNode(t,i)}}}}]),e}(),U=new Map,j=function(){function e(t){(0,r.Z)(this,e),this.missing=t,this.update=new f.Z({deallocator:null}),this.add=new f.Z({deallocator:null}),this.remove=new f.Z({deallocator:null}),this.cancel=[]}return(0,a.Z)(e,[{key:"reset",value:function(e){this.add.clear(),this.update.clear(),this.cancel=e}}]),e}();function Z(e){(0,_.pC)(e.node)&&((0,T.WD)(e.node.renderMbs),(0,T.VL)(e.node.serviceObbInRenderSR)),(0,_.pC)(e.ref)&&((0,T.WD)(e.ref.renderMbs),(0,T.VL)(e.ref.serviceObbInRenderSR))}function G(e){return(0,T.HV)(e,-2)}function W(e){return(0,T.HV)(e,2)}function q(e,t){return t+(e?1:0)}function B(e,t){return(-2&e)===t}function H(e){return 1==(1&e)}function Q(e,t){return 0===t?0:e/t|0}function z(e,t){return 0===t?e:e%t}var K=[["maxScreenThreshold",A.w5.MaxScreenThreshold],["screenSpaceRelative",A.w5.ScreenSpaceRelative],["removedFeatureDiameter",A.w5.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",A.w5.DistanceRangeFromDefaultCamera]];var Y=(0,a.Z)((function e(){(0,r.Z)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}));function J(e){return Math.sqrt(e*(4/Math.PI))}var X=i(21765),$=function(){function e(t){(0,r.Z)(this,e),this._layerView=t,this._lodGlobalDirty=!1}return(0,a.Z)(e,[{key:"startNodeLoading",value:function(e,t,i,n){this._maxLodLevel=n.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if((0,_.Wi)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));ee.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);var n=ee.length;this._removeNodes(ee,e);var r=ee.length<n;return 0!==ee.length&&(this._lodGlobalDirty=!0),ee.clear(),r}},{key:"_lodGlobalHandling",value:function(e,t,i,n){if((0,_.Wi)(e))return!1;var r=e.index,a=this._index,s=this._layerView,o=a.nodeTraversalState(e),d=this._isChosenMaxLOD(o),l=!e.resources.hasFeatureData;if(d&&l)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;var u=s.isNodeLoaded(r);if(n&&u&&d){var h=!i&&this.hasNoVisibleChildren(e);s.fadeNode(r,X.B.FadeIn,!h)}var c=u&&(!s.isNodeFullyFadedIn||s.isNodeFullyFadedIn(r));if(u&&(s.updateNodeState(r,d?A.FE.Leaf:A.FE.Hole),d))return c&&this._removeChildrenRecursive(e),c;var f=e.childCount>0,v=f;if(f)for(var g=0;g<e.childCount;g++){var p=a.getChildIndex(r,g),m=a.getNode(p);(0,_.pC)(m)?a.isGeometryVisible(p)&&!this._lodGlobalHandling(m,t,i||c,n)&&this._isNodeInScaleBounds(m)&&(v=!1):a.isNodeVisible(p)&&(v=!1)}var y=u&&!d&&(v||ee.length<t);y&&ee.push(r),!n||y||!u||i||v||s.fadeNode(r,X.B.FadeIn,!1);var b=!e.resources.hasFeatureData;return v||c&&!y||b}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t._layerView.isNodeLoaded(e.index)||t._layerView.isNodeReloading(e.index))&&ee.push(e.index),e.childrenLoaded>0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,i=!0;return this._index.traverseChildren(e,(function(e){return!(!i||!t._index.isNodeVisible(e.index))&&(t._layerView.isNodeLoaded(e.index)?(i=!1,!1):e.childrenLoaded>0)})),i}},{key:"_childrenRequireLoading",value:function(e){var t=this,i=!1,n=!0;return this._index.traverseChildren(e,(function(e){if(!n||!t._index.isNodeVisible(e.index))return!1;var r=t._index.nodeTraversalState(e);return t._isChosenMaxLOD(r)&&t._index.isGeometryVisible(e.index)&&(i=!0),t._layerView.isNodeLoaded(e.index)?(n=!1,!1):e.childrenLoaded>0})),n&&i}},{key:"_isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),ee=new f.Z({deallocator:null}),te=i(74165),ie=i(15861),ne=i(14921),re=i(84652),ae=i(35995),se=i(99048),oe=i(28278),de=i(4046),le=function(){function e(t,i,n,a,s,o){if((0,r.Z)(this,e),this._streamDataController=i,this._logger=n,this._defaultGeometrySchema=a,this._requiredAttributes=s,this._options=o,this._logLayer=t,this._layerUrl=t.parsedUrl.path,this._geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var d=t.textureSetDefinitions;this._materialAndTextures=t.materialDefinitions.map((function(e){return(0,de.R0)(d,e)}))}}return(0,a.Z)(e,[{key:"_load",value:function(e,t,i){return this._streamDataController.request(e,t,i)}},{key:"_loadAttribute",value:function(e,t,i){var n="".concat(this._layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this._load(n,"binary",i).then((function(e){return(0,oe.qM)(t,e)}))}},{key:"loadAttributes",value:function(e,t,i){var n=this;return(0,g.as)(t.map((function(t){return n._loadAttribute(e,t.attributeStorageInfo,i)}))).then((function(i){for(var r={},a=0;a<t.length;++a){var s=i[a].value;if(s)r[t[a].name]=s;else{if((0,g.D_)(i[a].error))throw i[a].error;n._logger.error("#loadAttributes",n._logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),i[a].error)}}return r}))}},{key:"loadNodeData",value:function(){var e=(0,ie.Z)((0,te.Z)().mark((function e(t,i){var n,r,a,s,o,d,l,u,h,c,f,v,g,p,m,y,b,x,C,k,N,w,D,I;return(0,te.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null!=this._requiredAttributes&&t.resources.attributes?(0,ne.q6)(this.loadAttributes(t,this._requiredAttributes,i)):null,a=_e(this._geometryDefinitions,t),s=a.bufferDefinition,o=a.bufferIndex,d=!!t.resources.geometry,l=d?(0,ne.q6)(this._loadGeometry(t.resources.geometry,o,i)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this._loadShared(t,i);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(u=e.t0,h=t.resources.materialDefinition,c=this._materialAndTextures&&null!=h&&h>=0?this._materialAndTextures[h]:null!=u?(0,de.Pg)(u):null,f=null===c||void 0===c?void 0:c.material,v=null!==(n=null===c||void 0===c?void 0:c.textures)&&void 0!==n?n:[],g="".concat(t.id),!(p=!d&&this._options.loadFeatureData)){e.next=26;break}return e.next=23,this._loadFeatureData(g,i);case 23:e.t1=e.sent,e.next=27;break;case 26:e.t1=null;case 27:if(m=e.t1,y=p?ue(m):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:f}}],featureDataPosition:[0,0,0]},b=(0,_.Wi)(y)?he(m):null,x=v.length>0?(0,ne.q6)(this.loadTextures(t,v,i)):null,C=null,k=null,!l){e.next=40;break}return e.t2=ne.w6,e.next=36,l;case 36:e.t3=e.sent,C=(0,e.t2)(e.t3),N=ce(this._defaultGeometrySchema,u),k=(0,oe.Es)(s,N);case 40:if(!x){e.next=48;break}return e.t5=ne.w6,e.next=44,x;case 44:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=49;break;case 48:e.t4=null;case 49:if(w=e.t4,!r){e.next=58;break}return e.t8=ne.w6,e.next=54,r;case 54:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=59;break;case 58:e.t7={};case 59:if(D=e.t7,I=D?{attributeData:D,loadedAttributes:this._requiredAttributes}:null,!(0,_.pC)(y)){e.next=63;break}return e.abrupt("return",{geometryData:y,attributeDataInfo:I,geometryBuffer:C,geometryDescriptor:k,requiredTextures:v,textureData:w});case 63:if(!(0,_.pC)(b)){e.next=65;break}return e.abrupt("return",{pointData:b,attributeDataInfo:I,geometryBuffer:C,geometryDescriptor:k,requiredTextures:v,textureData:w});case 65:throw new Error;case 66:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_loadShared",value:function(t,i){var n="".concat(this._layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this._load(n,"json",i).then((function(t){return e._fixTextureEncodings(t),e._addAbsoluteHrefTexture(t,n),t}))}},{key:"_loadTexture",value:function(e,t,i,n,r,a){var s=!1;return r===se.j.DDS_S3TC||r===se.j.KTX2||r===se.j.Basis?this._load(e,"binary",a).then((function(e){return{id:t,usage:i,data:e,encoding:r,downsampled:s}})):this._load(e,"image",a).then((function(e){var a=e;if(n&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),d=Math.ceil(e.height/2),l=document.createElement("canvas");l.width=o,l.height=d,l.getContext("2d").drawImage(e,0,0,o,d),a=l,s=!0}return{id:t,usage:i,data:a,encoding:r,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,i){var n=this,r=!!this._options.uncompressedTextureDownsamplingEnabled,a=this._options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=(0,de.nn)(t.encodings,n._options.textureEncodings);if(null==s)return n._logger.error("#loadTextures",n._logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,d="".concat(n._layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return n._loadTexture(d,t.id,t.usage,r,s.encoding,i)})))}},{key:"_loadFeatureData",value:function(e,t){var i="".concat(this._layerUrl,"/nodes/").concat(e,"/features/0");return this._load(i,"json",t)}},{key:"_loadGeometry",value:function(e,t,i){var n="".concat(this._layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this._load(n,"binary",i)}}],[{key:"_addAbsoluteHrefTexture",value:function(e,t){var i=e.textureDefinitions;if(null!=i)for(var n=0,r=Object.keys(i);n<r.length;n++){var a,s=r[n],o=(0,O.Z)(i[s].images);try{for(o.s();!(a=o.n()).done;){var d=a.value;Array.isArray(d.href)?d.hrefConcat=d.href.map((function(e){return(0,ae.hF)(e,t)})):d.hrefConcat=(0,ae.hF)(d.href,t)}}catch(l){o.e(l)}finally{o.f()}}}},{key:"_fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var i in t){var n=t[i];if(Array.isArray(n.encoding))for(var r=0;r<n.encoding.length;r++){var a=n.encoding[r];"data:"===a.substring(0,5)&&(n.encoding[r]=a.substring(5))}else{var s=n.encoding;"data:"===s.substring(0,5)&&(n.encoding=s.substring(5))}}}}]),e}();function ue(e){if(!e)return null;var t,i=(0,O.Z)(e.featureData);try{for(i.s();!(t=i.n()).done;){var n=t.value,r=n.geometries;if(null!=r){var a,s=(0,O.Z)(r);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[n.id],featureDataPosition:n.position,geometries:[o]}}}catch(d){s.e(d)}finally{s.f()}}}}catch(d){i.e(d)}finally{i.f()}return null}function he(e){if(!e)return null;var t,i=new Array,n=(0,O.Z)(e.featureData);try{for(n.s();!(t=n.n()).done;){var r=t.value;null!=r.position&&i.push({featureIds:[r.id],featureDataPosition:r.position,geometries:[]})}}catch(a){n.e(a)}finally{n.f()}return i}function ce(e,t){if(!e||!t||!t.materialDefinitions)return e;var i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=(0,re.d9)(e)).vertexAttributes.region,e}function _e(e,t){var i={bufferDefinition:null,bufferIndex:0},n=t.resources.geometryDefinition;if(null==e||null==n||n<0)return i;var r=n>=0?e[n].geometryBuffers:null;if(null==r)return i;for(var a=0;a<r.length;a++){var s=r[a];if(null==s.compressedAttributes)i.bufferIndex=a,i.bufferDefinition=r[a];else if("draco"===s.compressedAttributes.encoding&&!(0,h.Z)("disable-feature:i3s-draco"))return i.bufferIndex=a,i.bufferDefinition=s,i}return i}var fe=function(){function e(t,i){(0,r.Z)(this,e),this._requester=t,this._apiKey=i,this._activeRequests=new Set}return(0,a.Z)(e,[{key:"busy",get:function(){return this._requester.busy}},{key:"request",value:function(e,t,i){var n=this,r=new AbortController,a=(0,g.$F)(i,(function(){return r.abort()})),s={signal:r.signal,query:{token:this._apiKey}},o=this._requester.request(e,t,s),d={response:o,abortController:r,abortHandle:a};return this._activeRequests.add(d),(0,g.Bx)(o,(function(){var e;d.abortController=null,null!==(e=d.abortHandle)&&void 0!==e&&e.remove(),d.abortHandle=null,n._activeRequests.delete(d)})),o}},{key:"cancelAll",value:function(){this._activeRequests.forEach((function(e){var t,i;null!==(t=e.abortController)&&void 0!==t&&t.abort(),e.abortController=null,null===(i=e.abortHandle)||void 0===i||i.remove()})),this._activeRequests.clear()}}]),e}(),ve=i(71353),ge=i(90045),pe=i(83448),me=i(29691),ye=i(95773),be=i(92975),xe=i(23470),Ce=i(69691),ke=i(78935),Ne=i(8821),we=1e5,De=function(){function e(t,i,n,a,s,o,d,l){var u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{};(0,r.Z)(this,e),this._indexSR=t,this._renderCoordsHelper=i,this._clippingArea=s,this._elevationProvider=o,this._viewingMode=d,this._options=u,this._frustum=(0,ye.Ue)(),this._useFrustumCulling=!1,this._poi=(0,ve.c)(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=(0,E.Ue)(),this._tmp1=(0,ve.c)(),this._tmp2=(0,ve.c)(),this._tmp3=(0,ve.c)(),this._tmp0=(0,ve.c)(),this._screenspaceErrorBias=u.screenspaceErrorBias||1,this._progressiveLoadFactor=u.progressiveLoadFactor||1,this.updateCamera(n,a),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(l),this._tmpPoint=(0,k.Tx)(0,0,0,t),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||(0,be.QM)(this.engineSR)),this._indexSREllipsoidRadius=(0,pe.Iu)(this._indexSR).radius}return(0,a.Z)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=ke.o.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,Ne.bw)((0,Ne.WI)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&(0,ye.q_)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}},{key:"updateClippingArea",value:function(e){this._clippingArea=e}},{key:"getElevationRange",value:function(e){if((0,_.Wi)(this._elevationContext))return null;var t=e.mbs;if(!t)return null;var i=t[0],n=t[1],r=t[2],a=t[3],s="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(i,n,r,a,this._indexSR,s);var o=this._elevationProvider.getElevation(i,n,r,this._indexSR,s);return(0,_.pC)(o)?{min:o,max:o}:null}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return(0,T.c$)(t)||(e.mbs&&(0,ge.c)(t,e.mbs),this._elevationContext&&t[3]<we&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=(0,Ce.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),(0,x.st)(t,this._indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if((0,_.pC)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb,i=.01*this._indexSREllipsoidRadius;return(0,_.Wi)(t)||!e.mbs||!(0,T.vH)(t)||this._isECEFOBBInLocalMode&&t.halfSize.some((function(e){return e>i}))?null:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3],e.elevationRange),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,i,n){if((0,_.Wi)(t))t=(0,E.Ue)();else if((0,T.vH)(t))return t;var r=0,a=0;if(this._elevationContext&&(0,_.pC)(n)&&Number.isFinite(n.min))switch(this._elevationContext.mode){case"relative-to-ground":r=this._elevationContext.geometryZWithOffset(e.center[2],this._renderCoordsHelper)+n.min-e.center[2],a=n.max-n.min;break;case"on-the-ground":r=n.min-e.center[2],a=n.max-n.min}else this._elevationContext&&i<we&&(this._tmpPoint.x=e.center[0],this._tmpPoint.y=e.center[1],this._tmpPoint.z=e.center[2],r=(0,Ce.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]);return a>0?((0,T.jv)(e,this._indexSR,this._tmpObb,this.engineSR,r),(0,E.gI)(this._tmpObb,0,a,this._viewingMode,t)):(0,T.jv)(e,this._indexSR,t,this.engineSR,r),t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;var i=this.getVisibilityObb(e);return(0,_.pC)(i)?(0,E.pn)(i,this._frustum):(0,ye.hr)(this._frustum,(0,xe.w)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return(0,_.pC)(t)?(0,E.pn)(t,this._frustum):this.isNodeVisible(e)}},{key:"_isMBSinClippingArea",value:function(e){return!!(0,_.Wi)(this._clippingArea)||(0,T.cr)(this._clippingArea,e)!==T.pD.OUTSIDE}},{key:"_screenSpaceDiameterMbs",value:function(e,t){var i=this.getRenderMbs(e),n=Math.sqrt((0,F.d)(i,this._camPos)),r=n-i[3];return this._updateMinMaxDistance(n),r<0?.5*Number.MAX_VALUE:t/r*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),i=(0,F.i)(t,this._camPos);return this._updateMinMaxDistance(i),i}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),i=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,F.l)(t)+i)/(0,F.i)(t,this._camPos);return Math.min(1,n)}},{key:"hasLOD",value:function(e){return e.lodMetric!==A.w5.None}},{key:"_getDistancePlanarMode",value:function(e,t){var i=e[0]-t[0],n=e[1]-t[1],r=e[2]-t[2],a=i*i+n*n,s=t[3];if(a<=s*s)return Math.abs(r);var o=Math.sqrt(a)-s;return Math.sqrt(r*r+o*o)}},{key:"_getDistanceGlobeMode",value:function(e,t){var i=(0,F.l)(t),n=(0,F.l)(e)-i;(0,F.g)(this._tmp0,e,(0,F.e)(e,t)/(0,F.p)(e));var r=(0,F.d)(t,this._tmp0),a=t[3];if(r<=a*a)return Math.abs(n);var s=(0,F.g)(this._tmp0,t,1/i),o=i,d=a*a/2/o,l=(0,F.g)(this._tmp1,s,o-d),u=e,h=(0,F.b)(this._tmp2,u,l),c=(0,F.b)(this._tmp2,h,(0,F.g)(this._tmp3,s,(0,F.e)(s,h))),_=(0,F.a)(this._tmp2,l,(0,F.g)(this._tmp2,c,a/(0,F.l)(c))),f=(0,F.i)(u,_);if(n>=2e5){var v=(0,F.b)(this._tmp1,u,_),g=(0,F.e)(v,s)/(0,F.l)(v);g<.08&&(g=1e-4),f/=g}return f}},{key:"_getDistance",value:function(e,t){return this.engineSR===(0,me.rS)(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(e.lodMetric===A.w5.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){var t=this._progressiveLoadFactor*this._screenspaceErrorBias,i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case A.w5.ScreenSpaceRelative:var i=this.getRenderMbs(e),n=this._getDistance(this._camPos,i),r=2*n/this._screenSizeFactor,a=n+i[3];return this._updateMinMaxDistance(a),e.maxError*t<=r;case A.w5.MaxScreenThreshold:var s=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case A.w5.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case A.w5.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return(0,F.i)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return(0,F.i)(this._camPos,this._poi)}}]),e}(),Ie=i(65206),Pe=i(45888),Le=i(69787),Se="esri.layers.graphics.controllers.I3SOnDemandController",Oe=c.Z.getLogger(Se),Fe=1e-4,Me=function(e){(0,s.Z)(i,e);var t=(0,o.Z)(i);function i(e){var n;return(0,r.Z)(this,i),(n=t.call(this,e)).screenSizeFactor=0,n.featureTarget=5e4,n.fixedFeatureTarget=!1,n.updating=!0,n.updatingProgress=1,n.leavesReached=!1,n.scaleVisibilityEnabled=!0,n._featureLOD=1,n._stableFeatureLOD=!1,n._isIdle=!1,n._cameraDirty=!0,n._invisibleDirty=!1,n._idleStateCallbacks=null,n._newLoadingNodes=new f.Z({deallocator:null}),n._loadedNodeScales=new Map,n._modificationsNodeFilteringArray=new f.Z,n._downloadingCount=0,n._loadingNodes=new Map,n._updatingNodes=new Map,n._progressMaxNumNodes=1,n._requiredAttributes=new Array,n._requiredAttributesDirty=!0,n._updatesDisabled=!1,n.disableIDBCache=!1,n._disableMemCache=!1,n._restartNodeLoading=!1,n._fields=null,n._attributeStorageInfo=null,n._handles=new u.Z,n._idleQueue=new N.b,n._elevationUpdateNodes=new f.Z({deallocator:null}),n._errorCount=0,n}return(0,a.Z)(i,[{key:"isMeshPyramid",get:function(){var e;return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===(null===(e=this.layer.store)||void 0===e?void 0:e.lodType)}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"useMaximumNumberOfFeatures",get:function(){return!this.isMeshPyramid&&((0,_.Wi)(this.layer.priority)||"High"===this.layer.priority)}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(Pe.Bh.I3S_INDEX);return new fe(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(Pe.Bh.I3S_DATA);return new fe(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return(0,T.T2)(this.layer)}},{key:"crsIndex",get:function(){return(0,T.tp)(this.layer)}},{key:"layer",get:function(){return this.layerView.i3slayer}},{key:"running",get:function(){return this.updating}},{key:"rootNodeVisible",get:function(){if((0,_.pC)(this._index)){var e=this._index.rootNode;if((0,_.pC)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this,t=this.layerView,i=this.layer;this._disableMemCache=!t.loadCachedGPUData||!t.addCachedGPUData,this._lodHandling=new $(t),this._defaultGeometrySchema=i.store.defaultGeometrySchema,this.disableIDBCache=(0,h.Z)("disable-feature:idb-cache"),"fields"in i&&(this._fields=i.fields,this._attributeStorageInfo=i.attributeStorageInfo),this.addResolvingPromise(Promise.all([i.indexInfo,i.when(),t.when()]).then((function(r){var a=(0,n.Z)(r,1)[0];if(!e.destroyed&&t&&!t.destroyed&&a){var s=t.view,o=s.resourceController;e._setClippingArea(s.clippingArea),e.addHandles([(0,p.YP)((function(){var e,t;return null===s||void 0===s||null===(e=s.pointsOfInterest)||void 0===e||null===(t=e.focus)||void 0===t?void 0:t.renderLocation}),(function(t){return e._pointOfInterestChanged(t)}),p.nn),(0,p.YP)((function(){return o.memoryController.memoryFactor}),(function(){return e._setCameraDirty()}),p.Z_),(0,p.YP)((function(){return t.suspended}),(function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},n=t?function(){}:function(){return e._updateIdleState(!1)};!t&&(0,_.pC)(e._index)&&e._index.invalidateAllElevationRanges(),e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=n):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(i,n)}),p.nn),S(t.view.resourceController.scheduler,e),(0,p.YP)((function(){return t.uncompressedTextureDownsamplingEnabled}),(function(){return e.restartNodeLoading()})),(0,p.YP)((function(){return[e.featureTarget,e.fixedFeatureTarget]}),(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),(0,p.YP)((function(){var e;return null===(e=s.state)||void 0===e?void 0:e.contentCamera}),(function(){return e._setCameraDirty()})),(0,p.YP)((function(){return i.elevationInfo}),(function(t){return e._elevationInfoChanged(t)})),(0,p.YP)((function(){return i.effectiveScaleRange}),(function(){return e._scaleBoundsChanged()})),(0,p.YP)((function(){return t.lodFactor}),(function(){return e._setCameraDirty()})),(0,p.YP)((function(){return t.availableFields}),(function(){return e._requiredFieldsChange()})),(0,p.YP)((function(){return t.holeFilling}),(function(t){return(0,_.pC)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new De(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,e.isMeshPyramid?s.basemapTerrain:s.elevationProvider,(0,w.wg)(s.viewingMode),e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e._lod,angleDependentLoD:e._lod<.5}),e._index=new V(i,a,e.indexStreamController,e._viewportQueries,Oe,t.holeFilling,(function(e){return t.isNodeLoaded(e)}),(function(e){return t.isNodeReloading(e)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,A.FE.Leaf)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(e){return t.computeVisibilityObb?t.computeVisibilityObb(e):null}),null!==t&&void 0!==t&&t.computeNodeFiltering?function(e){return t.computeNodeFiltering(e)}:void 0),e._index.updateElevationInfo(e.layer.elevationInfo,e.isMeshPyramid),e._index.imModificationsChanged(!!t.hasModifications),e._startNodeLoading()}}))),this._tmpPoint=(0,k.Tx)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=this._index,n=this.layerView;(0,_.pC)(i)&&(null===n||void 0===n?void 0:n.updateNodeModificationStatus)&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var n=i.getNode(e);(0,_.pC)(n)&&t._modificationsNodeFilteringArray.push(n)})),n.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,Te.prune(),(0,_.pC)(Ae)&&(Ae.hide(),Ae=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((function(i){var n=Re(e,i),r=Re(t,i);return n>=0&&r>=0?{index:n,name:t[r].name,field:t[r],attributeStorageInfo:e[n]}:null})).filter((function(e){return null!=e&&e.name!==i}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Ee(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=(0,C.Ue)();(0,Ie.G)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){(0,_.pC)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),(0,_.pC)(this._index)&&(this._index.progressiveLoadPenalty=je.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),(0,_.pC)(this._viewportQueries)&&(0,_.pC)(this._index)&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var i=this._index;if((0,_.Wi)(i)||(0,_.Wi)(i.rootNode)||(0,_.Wi)(t))return null;this.crsIndex.equals(t)||((0,x.dH)(e,t,Ze,this.crsIndex),e=Ze);var n=this._elevationUpdateNodes;return n.clear(),(0,T.tS)(e,i.rootNode,i,(function(e){return n.push(e.index)})),n.length&&(n.forAll((function(e){return i.updateElevationChanged(e)})),this._setCameraDirty()),n}},{key:"getParentIndex",value:function(e){return(0,_.pC)(this._index)?this._index.getParentIndex(e):-1}},{key:"removeAllGeometryObbs",value:function(){(0,_.pC)(this._index)&&this._index.removeAllGeometryObbs()}},{key:"getRenderMbs",value:function(e){return(0,_.pC)(this._viewportQueries)?this._viewportQueries.getRenderMbs(e):null}},{key:"_elevationInfoChanged",value:function(e){(0,_.Wi)(this._index)||(this._index.updateElevationInfo(e,this.isMeshPyramid),this._setCameraDirty())}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this._areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this._areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t){var i=this,n=this._index;if(!(0,_.Wi)(n)){var r=n.rootNode;!(0,_.Wi)(r)&&(0,x.dH)(e,t,Ze,this.crsIndex)&&this._loadedNodeScales.forEach((function(e,t){var r=n.getNode(t);(0,_.pC)(r)&&(0,C.hr)(Ze,r.mbs)&&i._loadedNodeScales.set(t,i._computeScale(r))}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"_isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"_areScaleBoundsActive",get:function(){var e=(0,Le.lu)(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)}},{key:"unloadedMemoryEstimate",get:function(){return(0,_.Wi)(this._index)||this.layerView.suspended?0:this._index.unloadedMemoryEstimate*this._lodDropFactor}},{key:"indexDepth",get:function(){return(0,_.pC)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"runTask",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||(0,_.Wi)(this._index)?-1/0:(this._processWithErrorLogging(e,t),this._index.maxPriority)}},{key:"_processWithErrorLogging",value:function(e,t){try{this._process(e,t)}catch(I){this._errorCount<50?Oe.error("Error during processing: "+I):50===this._errorCount&&Oe.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var i=this;this._restartNodeLoading&&this._startNodeLoading(),null==this._nodeLoader||(0,_.Wi)(this._index)||(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(e.enabled=!1),e.run((function(){return i._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return i._processCache(e)})),this._isIntegratedMesh&&(e.enabled=!0),e.run((function(){return i._processNodes(e,t)})),this._idleQueue.runTask(e),e.run((function(){return i._prefetchIndex()})),t.numIndexLoading+=this._index.indexLoading,t.numNodesLoading+=this._downloadingCount,e.run((function(){return i._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating())}},{key:"_processIndex",value:function(e){var t=this;if((0,_.Wi)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var i=this._index.featureEstimate.leavesReached;this._index.isLoading||i===this._get("leavesReached")||this._set("leavesReached",i)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!((0,_.Wi)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.useMaximumNumberOfFeatures&&!(0,_.Wi)(this._index)&&!(0,_.Wi)(this._viewportQueries)){var e=!this._index.isLoading,t=this.featureTarget*this._baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.indexMissing>500){if(this._featureLOD<=Fe)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var n=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=n;var r=this._lod,a=this._index.checkFeatureTarget(t,r);a!==r&&(this._featureLOD=a/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Fe)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Fe,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if((0,_.Wi)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var i=this._newLoadingNodes.pop(),n=t.getParent(i);(0,_.pC)(n)&&!this.layerView.isNodeLoaded(n.index)&&this._isNodeInScaleBounds(n);n=t.getParent(n.index))if(this._enableFromGPUCache(n,A.FE.Hole)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if((0,_.Wi)(this._index))return!1;var i=(this._isIdle?100:2)-this._loadingNodes.size,n=this._index.updates;for(n.cancel.forEach(this._cancelNode,this),n.cancel=[];n.remove.length>0&&!e.done;)this.layerView.removeNode(n.remove.pop()),e.madeProgress();for(;n.update.length>0&&!e.done;){var r=this._index.getNode(n.update.pop());(0,_.pC)(r)&&(this._updateLoadedNode(r),e.madeProgress())}for(;n.add.length>0&&!e.done&&i>0;){--i;var a=this._index.getNode(n.add.back());if((0,_.Wi)(a)||a.cacheState!==A.Hw.Cached&&!this._hasNodeLoadToken(t))break;n.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Pe.NT&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var i=((0,_.pC)(this._index)?this._index.indexMissing:0)+3*((0,_.pC)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||(0,_.pC)(this._index)&&this._index.isPrefetching),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!(0,_.Wi)(this._index)&&!(0,_.Wi)(this._viewportQueries)){var e=this.layerView.view,t=e.state,i=t.contentCamera,n=t.fixedContentCamera;this.screenSizeFactor=1/(i.perScreenPixelRatio/2),this._viewportQueries.updateCamera(i,!n||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=je.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"_lod",get:function(){return this._featureLOD*this._baseLOD}},{key:"_baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"_lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return(0,_.pC)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){(0,_.pC)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){(0,_.pC)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){(0,_.pC)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){(0,_.pC)(this._index)&&this._index.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&!((0,_.Wi)(this._index)||!this._index.isGeometryVisible(e.index))&&this._isNodeInScaleBounds(e)}},{key:"_shouldDropNode",value:function(e){if((0,_.Wi)(this._viewportQueries))return!1;var t=this._lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||(0,_.Wi)(t)||(0,_.Wi)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var i={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new le(this.layer,this.dataStreamController,Oe,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,i){return e._removeNodes(t,i,Ve.fadeout)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,i=this._index;if((0,_.Wi)(i)||(0,_.Wi)(this._viewportQueries))return!1;Te.clear(),this.layerView.getLoadedNodeIndices(Te);var n=0===this._viewportQueries.maxDistance,r=n?function(){return!1}:function(e){return t._shouldDropNode(e)};return Te.filterInPlace((function(e){var n=i.getNode(e);return(0,_.Wi)(n)||!i.isGeometryVisible(e)||r(n)||!t._isNodeInScaleBounds(n)})),Te.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Te,e,Ve.pop),!(n&&this._lodDropFactor<1)&&(0===Te.length||(Te.clear(),!1))}},{key:"markNodeToRemove",value:function(e){Te.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(Te,D.G5,Ve.pop)}},{key:"_removeNodes",value:function(e,t,i){var n=e.length;if(0!==n&&!t.done){for((0,_.pC)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var r=e.pop(),a=this._index;i===Ve.fadeout&&this.layerView.nodeFadeoutEnabled&&(0,_.pC)(a)&&a.isGeometryVisible(r)?this.layerView.fadeNode(r,X.B.FadeOut,!0):this.layerView.removeNode(r),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<n;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,i=new AbortController;this._updatingNodes.set(e.index,i),(Ee(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,i.signal)).then((function(n){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:n},i.signal)}),i.signal)})).catch((function(n){if(!(0,g.D_)(n))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},i.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))Oe.error("already loading node "+e.index);else{var i=new AbortController;this._loadingNodes.set(e.index,i),this._evaluateUpdating(),this._loadAndAddNode(e,i.signal).then((function(n){n&&(0,_.pC)(t._index)&&t._loadingNodes.get(e.index)===i&&(t._loadingNodes.delete(e.index),t._index.requestUpdate())})).catch((function(e){if(!(0,g.D_)(e))throw e})).finally((function(){t._loadingNodes.get(e.index)===i&&t._loadingNodes.delete(e.index),t._evaluateUpdating()}))}}},{key:"_loadAndAddNode",value:function(e,t){return e.cacheState===A.Hw.Uncached?this._loadUncached(e,t).then((function(){return!1})):this._loadCached(e,t).then((function(t){return!t&&(e.cacheState=A.Hw.Uncached,!0)})).catch((function(t){return!(0,g.D_)(t)&&(e.cacheState=A.Hw.Uncached,!0)}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||(0,_.Wi)(this._index))return!1;if(t===A.FE.Hole&&!this._index.useNodeAsHole(e.index))return!0;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return(0,_.pC)(t)&&(0,_.pC)(t.attributeInfo)&&Ee(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){(0,_.pC)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateLoadStatus",value:function(e,t){var i=this._index;(0,_.pC)(i)&&i.updateChildrenLoaded(e,t?1:-1)}},{key:"_loadCached",value:function(e,t){var i=this;if(this._enableFromGPUCache(e,A.FE.Leaf))return Promise.resolve(!0);var n=this.layerView;return!this.disableIDBCache&&n.loadCachedNodeData&&n.addCachedNodeData?this.schedule((function(){return n.loadCachedNodeData(e,t,(function(t,n){return i._nodeLoader.loadTextures(e,t,n)}))}),t).then((function(r){if((0,_.Wi)(r))return!1;var a=i._requiredAttributes;return i.reschedule((function(){return i._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return i.reschedule((function(){return n.addCachedNodeData(e,r,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return i._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var i=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw i._downloadingCount--,e})).then((function(n){return i._downloadingCount--,i.schedule((function(){return i.layerView.addNode(e,n,t)}),t)})).then((function(){i._nodeAdded(),e.cacheState=A.Hw.Cached})).catch((function(t){if(!(0,g.D_)(t))throw Oe.error("#loadNodeData()",i.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,(0,_.pC)(i._index)&&i._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&(0,_.pC)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);var t=this._computeScale(e);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_computeScale",value:function(e){this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=e.mbs[3];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,t)}},{key:"_isNodeInScaleBounds",value:function(e){if(!this._areScaleBoundsActive)return!0;var t=this._getScale(e),i=(0,Le.lu)(this.layer),n=i.minScale,r=i.maxScale;return(0,Le.rs)(t,n,r)}},{key:"updateStats",value:function(e){e.index=(0,_.pC)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this._baseLOD),(0,_.pC)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){(0,_.pC)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),(0,_.pC)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;(0,_.pC)(t)&&t.layerFilterChanged(e),this._setCameraDirty()}}]),i}((0,v.v)(l.Z));(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"isMeshPyramid",null),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"isGraphics3D",null),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"useMaximumNumberOfFeatures",null),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"indexStreamController",null),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"dataStreamController",null),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"crsVertex",null),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"crsIndex",null),(0,d._)([(0,m.Cb)()],Me.prototype,"screenSizeFactor",void 0),(0,d._)([(0,m.Cb)()],Me.prototype,"featureTarget",void 0),(0,d._)([(0,m.Cb)()],Me.prototype,"fixedFeatureTarget",void 0),(0,d._)([(0,m.Cb)()],Me.prototype,"layerView",void 0),(0,d._)([(0,m.Cb)()],Me.prototype,"layer",null),(0,d._)([(0,m.Cb)()],Me.prototype,"updating",void 0),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"running",null),(0,d._)([(0,m.Cb)()],Me.prototype,"updatingProgress",void 0),(0,d._)([(0,m.Cb)({readOnly:!0})],Me.prototype,"leavesReached",void 0),(0,d._)([(0,m.Cb)({constructOnly:!0})],Me.prototype,"scaleVisibilityEnabled",void 0),(0,d._)([(0,m.Cb)({readOnly:!0,dependsOn:[]})],Me.prototype,"rootNodeVisible",null),Me=(0,d._)([(0,b.j)(Se)],Me);var Ae,Te=new f.Z({deallocator:null});function Ee(e,t){return(0,_.pC)(e)&&e.length===t.length&&e.every((function(e){return Re(t,e.name)>=0}))}function Re(e,t){for(var i=t.toLowerCase(),n=0;n<e.length;n++)if(e[n].name.toLowerCase()===i)return n;return-1}var Ve,Ue,je={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ze=(0,C.Ue)();(Ue=Ve||(Ve={}))[Ue.pop=0]="pop",Ue[Ue.fadeout=1]="fadeout";var Ge=Me},41863:function(e,t,i){i.r(t),i.d(t,{default:function(){return g}});var n=i(15671),r=i(43144),a=i(60136),s=i(92572),o=i(27366),d=i(10064),l=i(92026),u=i(49861),h=(i(25243),i(63780),i(69912)),c=i(79803),_=i(37933),f=i(28554),v=function(e){(0,a.Z)(i,e);var t=(0,s.Z)(i);function i(){var e;return(0,n.Z)(this,i),(e=t.apply(this,arguments)).type="feature-3d",e.direct3DObjectFeatureLayerDisplayEnabled=(0,f.hq)(),e}return(0,r.Z)(i,[{key:"initialize",value:function(){var e,t=this.layer,i=this.view;null!==(e=(0,_.S1)(t))&&void 0!==e&&e.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new d.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:t}))),(0,l.pC)(t.infoFor3D)&&(this.direct3DObjectFeatureLayerDisplayEnabled?this._set("suspendResumeExtentMode","computed"):this.addResolvingPromise(Promise.reject(new d.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ".concat(t.geometryType))))),"mesh"!==t.geometryType||(0,c.Up)(t.spatialReference,i.spatialReference)||this.addResolvingPromise(Promise.reject(new d.Z("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}},{key:"featureSpatialReference",get:function(){var e,t;return null===(e=this.view.featureTiles)||void 0===e||null===(t=e.tilingScheme)||void 0===t?void 0:t.spatialReference}}]),i}(i(53952).Z);(0,o._)([(0,u.Cb)({constructOnly:!0})],v.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,o._)([(0,u.Cb)()],v.prototype,"layer",void 0);var g=v=(0,o._)([(0,h.j)("esri.views.3d.layers.FeatureLayerView3D")],v)},4046:function(e,t,i){i.d(t,{K0:function(){return D},Pg:function(){return b},R0:function(){return g},RE:function(){return w},cU:function(){return C},dY:function(){return x},nn:function(){return I}});var n,r=i(4942),a=i(93169),s=i(16889),o=i(92026),d=i(99048),l=i(89261),u=i(41481),h=i(26461),c=i(86097),_=i(68401),f=i(1487),v=i(8548);function g(e,t){var i=new Map,n=function(e,t){if((0,o.Wi)(e))return-1;var n=i.get(e.id);if(n)return n.usage|=t,n.id;var r=i.size;return i.set(e.id,{id:r,usage:t}),r},r=t.pbrMetallicRoughness,a=r&&r.baseColorFactor,s=t.emissiveFactor,l=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!r||null==r.metallicRoughnessTexture&&1===r.roughnessFactor&&(1===r.metallicFactor||0===r.metallicFactor)),h=l?u.Fw[0]:r?r.metallicFactor:1,c=l?u.Fw[1]:r?r.roughnessFactor:1,f="mask"===t.alphaMode?d.v.Color|d.v.AlphaMask:d.v.Color,v={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:n(r&&r.baseColorTexture,f),metallicRoughnessTextureId:n(r&&r.metallicRoughnessTexture,d.v.MetallicRoughness),metallicFactor:h,roughnessFactor:c},g={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?_.Vr.None:"back"===t.cullFace?_.Vr.Back:"front"===t.cullFace?_.Vr.Front:_.Vr.None,normalTextureId:n(t.normalTexture,d.v.Normal),emissiveTextureId:n(t.emissiveTexture,d.v.Emissive),occlusionTextureId:n(t.occlusionTexture,d.v.Occlusion),emissiveFactor:s?[s[0],s[1],s[2]]:[0,0,0],metallicRoughness:v,wrapTextures:!1,hasParametersFromSource:l},y=[];return i.forEach((function(t,i){var n=t.usage,r=(0,o.pC)(e)&&e[i]&&e[i].formats,a=r?p(r.map((function(e){var t=e.name,i=e.format;return{name:t,encoding:m[i]}}))):[];y.push({id:i,usage:n,encodings:a})})),{material:g,textures:y}}function p(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var m={ktx2:d.j.KTX2,basis:d.j.Basis,dds:d.j.DDS_S3TC,png:d.j.PNG,jpg:d.j.JPG,"ktx-etc2":d.j.KTX_ETC2},y=(n={},(0,r.Z)(n,_.Ti.KTX2_ENCODING,d.j.Basis),(0,r.Z)(n,_.Ti.BASIS_ENCODING,d.j.Basis),(0,r.Z)(n,_.Ti.DDS_ENCODING,d.j.DDS_S3TC),(0,r.Z)(n,"image/png",d.j.PNG),(0,r.Z)(n,"image/jpg",d.j.JPG),(0,r.Z)(n,"image/jpeg",d.j.JPG),(0,r.Z)(n,"image/ktx",d.j.KTX_ETC2),n);function b(e){var t,i,n=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,r=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,a=n?null===(t=e.materialDefinitions)||void 0===t?void 0:t[n]:null,o=r?null===(i=e.textureDefinitions)||void 0===i?void 0:i[r]:null,l=x();if(null!=a){var u=a.params;u.diffuse&&(l.metallicRoughness.baseColorFactor=[u.diffuse[0],u.diffuse[1],u.diffuse[2],1]),null!=u.doubleSided&&(l.doubleSided=u.doubleSided,l.cullFace=u.doubleSided?_.Vr.None:_.Vr.Back),"none"!==u.cullFace&&"front"!==u.cullFace&&"back"!==u.cullFace||(l.cullFace="none"===u.cullFace?_.Vr.None:"back"===u.cullFace?_.Vr.Back:_.Vr.Front),u.transparency&&(l.metallicRoughness.baseColorFactor[3]=(0,s.uZ)(1-u.transparency,0,1)),(u.useVertexColorAlpha||l.metallicRoughness.baseColorFactor[3]<1)&&(l.alphaMode="blend")}var h=[];if(null!=o){!o.wrap||"repeat"!==o.wrap[0]&&"repeat"!==o.wrap[1]||(l.wrapTextures=!0);var c=d.v.Color;"rgba"===o.channels&&(l.alphaMode="blend",c|=d.v.AlphaMask);var f=o.images.length-1,v=o.images[f],g=function(e){return e&&e.split("/").pop()},m=Array.isArray(o.encoding)?p(o.encoding.map((function(e,t){return{name:g(v.href[t]),encoding:y[e]||0}}))):[{name:g(v.href),encoding:y[o.encoding]||0}];h.push({id:0,usage:c,encodings:m}),l.metallicRoughness.baseColorTextureId=0}return{material:l,textures:h}}var x=function(){return{alphaMode:"opaque",alphaCutoff:h.F,doubleSided:!0,cullFace:_.Vr.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function C(e,t,i,n){if((0,o.Wi)(e)||null==e.data)return null;var r=e.data,a=!(r instanceof HTMLImageElement)||(0,s.wt)(r.width)&&(0,s.wt)(r.height),l=n.renderingContext.parameters.maxMaxAnisotropy,u=i&&!n.capabilities.shaderTextureLOD?1:l,h=a&&!e.downsampled&&u>1,c=i||!t.wrapTextures?k:N,v=function(e){switch(e){case d.j.KTX2:return _.Ti.KTX2_ENCODING;case d.j.Basis:return _.Ti.BASIS_ENCODING;case d.j.DDS_S3TC:return _.Ti.DDS_ENCODING;case d.j.PNG:return"image/png";case d.j.JPG:return"image/jpeg";case d.j.KTX_ETC2:return"image/ktx";default:return""}}(e.encoding),g=e.usage&d.v.Color?"opaque"===t.alphaMode?3:4:3;return new f.x(r,{mipmap:h,maxAnisotropy:u,encoding:v,wrap:c,components:g,noUnpackFlip:!0})}var k={s:v.e8.CLAMP_TO_EDGE,t:v.e8.CLAMP_TO_EDGE},N={s:v.e8.REPEAT,t:v.e8.REPEAT};function w(e,t,i,n,r,a){var u=a.rendererTextureUsage,f=function(e){return function(e,t,i){if((0,o.Wi)(e)||i===d.v.None)return null;for(var n=0;n<e.length;n++){var r=e[n];if((0,o.pC)(r)&&0!=(r.usage&i)){var a=t[n];return(0,o.pC)(a)?a.id:null}}return null}(n,i,e&u)},v=t.metallicRoughness.baseColorFactor,g=(0,s.uZ)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[v[0],v[1],v[2],g],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=a.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=a.isIntegratedMesh,e.textureAlphaCutoff="mask"===t.alphaMode?t.alphaCutoff:h.F,e.alphaDiscardMode="opaque"===t.alphaMode?_.JJ.Opaque:"mask"===t.alphaMode?_.JJ.Mask:_.JJ.MaskBlend;var p=[],m=f(d.v.Color|d.v.AlphaMask);(0,o.pC)(m)&&(e.baseColorTexture=new l.T(r,m),p.push(e.baseColorTexture.loadPromise));var y=f(d.v.MetallicRoughness);(0,o.pC)(y)&&(e.metallicRoughnessTexture=new l.T(r,y),p.push(e.metallicRoughnessTexture.loadPromise));var b=f(d.v.Emissive);(0,o.pC)(b)&&(e.emissionTexture=new l.T(r,b),p.push(e.emissionTexture.loadPromise));var x=f(d.v.Occlusion);(0,o.pC)(x)&&(e.occlusionTexture=new l.T(r,x),p.push(e.occlusionTexture.loadPromise));var C=f(d.v.Normal);return(0,o.pC)(C)&&(e.normalTexture=new l.T(r,C),p.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.hasSlicePlane=a.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=(0,c.j)(a.viewSpatialReference),Promise.all(p)}function D(e){var t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,n=(0,a.Z)("disable-feature:i3s-basis")?0:d.j.Basis|d.j.KTX2,r=d.j.JPG|d.j.PNG,s=n|d.j.DDS_S3TC;return r|(t?s:0)|(i?n:0)}function I(e,t){if(null!=t)return e.find((function(e){return 0!=(e.encoding&t)}))}},95964:function(e,t,i){i.d(t,{$i:function(){return f},FE:function(){return o},Hw:function(){return a},NB:function(){return g},O4:function(){return r},U_:function(){return n},oQ:function(){return p},rw:function(){return v},w5:function(){return s}});var n,r,a,s,o,d,l=i(60136),u=i(92572),h=i(43144),c=i(15671),_=i(23470),f=(0,h.Z)((function e(t,i){(0,c.Z)(this,e),this.id=t,this.mbs=i,this.renderMbs=(0,_.f)(0,0,0,-1),this.elevationRange=null})),v=(0,h.Z)((function e(){(0,c.Z)(this,e),this.min=1/0,this.max=-1/0,this.valid=!1}));(d=n||(n={}))[d.Unmodified=0]="Unmodified",d[d.Culled=1]="Culled",d[d.NotChecked=2]="NotChecked",function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(r||(r={}));var g=function(e){(0,l.Z)(i,e);var t=(0,u.Z)(i);function i(e,n,s,o,d,l,u,h,_,f){var v;return(0,c.Z)(this,i),(v=t.call(this,e,s)).index=n,v.childCount=o,v.level=d,v.resources=l,v.version=u,v.lodMetric=h,v.maxError=_,v.numFeatures=f,v.failed=!1,v.cacheState=a.Unknown,v.vertexCount=0,v.memory=0,v.childrenLoaded=0,v.hasModifications=!1,v.imModificationImpact=r.NotChecked,v}return(0,h.Z)(i)}(f);!function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}(a||(a={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(s||(s={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(o||(o={}));var p=(0,h.Z)((function e(t,i,n,r){(0,c.Z)(this,e),this.nodeHasLOD=t,this.isChosen=i,this.lodLevel=n,this.version=r}))},75162:function(e,t,i){i.d(t,{v:function(){return P}});var n=i(74165),r=i(15861),a=i(29439),s=i(37762),o=i(93433),d=i(15671),l=i(43144),u=i(60136),h=i(92572),c=i(27366),_=i(76200),f=i(31319),v=i(63780),g=i(14921),p=i(59896),m=i(32718),y=i(92026),b=i(66978),x=i(94172),C=i(49861),k=(i(25243),i(69912)),N=i(6291),w=i(12322),D=i(28554),I=i(41863),P=function(e){(0,u.Z)(i,e);var t=(0,h.Z)(i);function i(e){var n;return(0,d.Z)(this,i),(n=t.call(this,e))._warnMaximumChangedObjectsExceeded=!1,n._interactiveEditingSessions=null,n._maximumNumberOfEditOVerrides=M,n._original3DOFLDefinitionExpression=null,n._associatedLayerView=null,n._changedObjectIds=new Set,n._pendingFetchChangedObjectIds=null,n._pendingFetchAbortController=new AbortController,n}return(0,l.Z)(i,[{key:"initialize",value:function(){var e,t=this;this._memCache=this.memoryController.newCache("".concat(this.layer.uid,"-attribute-overrides")),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(null===(e=this._pendingFetchAbortController)||void 0===e?void 0:e.signal),this._pendingFetchChangedObjectIds.then((function(){t._pendingFetchAbortController=null,t._pendingFetchChangedObjectIds=null})),this.is3DOFL&&(0,D.hq)()&&(0,y.pC)(this._associatedLayer)&&this._associatedLayer.load().then((function(e){t.destroyed||(t._original3DOFLDefinitionExpression=e.definitionExpression,t.addHandles((0,x.YP)((function(){return t._definitionExpression}),(function(t){return e.definitionExpression=t}),x.nn)),t._associatedLayerView=new I.default({layer:t._associatedLayer,view:t.view}))}))}},{key:"destroy",value:function(){this.is3DOFL&&(0,D.hq)()&&(0,y.pC)(this._associatedLayerView)&&(0,y.pC)(this._associatedLayer)&&(this._associatedLayer.definitionExpression=(0,y.Wg)(this._original3DOFLDefinitionExpression)),this._set("layer",null),this._memCache=(0,y.SC)(this._memCache),this._pendingFetchAbortController=(0,y.IM)(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null}},{key:"is3DOFL",get:function(){return(0,D.Rx)()&&(0,y.pC)(this._associatedLayer)&&(0,y.pC)(this._associatedLayer.infoFor3D)}},{key:"geometryChangedObjectIds",get:function(){return this.is3DOFL?(0,o.Z)(this._changedObjectIds):[]}},{key:"_associatedLayer",get:function(){return null==this.layer?null:this.layer.associatedLayer}},{key:"_definitionExpression",get:function(){var e=this.geometryChangedObjectIds;return 0===e.length?"1 = 0":"OBJECTID IN (".concat(e.join(","),")")}},{key:"updating",get:function(){return!!this.is3DOFL&&(!!(0,D.hq)()&&(!(0,y.pC)(this._associatedLayerView)||(0,y.pC)(this._associatedLayerView)&&this._associatedLayerView.updating))}},{key:"isEmpty",get:function(){return null==this._pendingFetchChangedObjectIds&&0===this._changedObjectIds.size}},{key:"createInteractiveEditSession",value:function(e){var t=this;this._changedObjectIds.add(e),this.notifyChange("_changedObjectIds"),(0,y.Wi)(this._interactiveEditingSessions)&&(this._interactiveEditingSessions=[]);var i=this._interactiveEditingSessions,n=new O(e,{rollback:function(){(0,v.Od)(i,n),0===i.length&&(t._interactiveEditingSessions=null)},commit:function(i){var n,r=(0,s.Z)(i);try{for(r.s();!(n=r.n()).done;){var o=(0,a.Z)(n.value,2),d=o[0],l=o[1];t.updateAttributeValue(e,d,l)}}catch(u){r.e(u)}finally{r.f()}}});return i.unshift(n),n}},{key:"apply",value:function(){var e=(0,r.Z)((0,n.Z)().mark((function e(t,i,r){var a,s,o,d,l,u,h;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,y.Wi)(i)){e.next=2;break}return e.abrupt("return");case 2:if(a=i.loadedAttributes,s=i.attributeData,!(0,y.Wi)(a)&&0!==a.length&&!(0,y.Wi)(s)){e.next=5;break}return e.abrupt("return");case 5:if(e.t0=this._pendingFetchChangedObjectIds,!e.t0){e.next=9;break}return e.next=9,(0,b.Hl)(this._pendingFetchChangedObjectIds,r);case 9:if(0!==this._changedObjectIds.size){e.next=11;break}return e.abrupt("return");case 11:if(o={loadedAttributes:a,attributeData:s},d=this._getOverridesFromCache(t,o,this._changedObjectIds),l=d.objectIds,u=d.fieldNames,0!==l.length&&0!==u.length){e.next=14;break}return e.abrupt("return");case 14:return e.next=16,this._queryOverridesFromAssociatedLayer(l,u,r);case 16:h=e.sent,(0,y.Wi)(h)||this._processOverridesFromAssociatedLayer(t,h,u,o);case 18:case"end":return e.stop()}}),e,this)})));return function(t,i,n){return e.apply(this,arguments)}}()},{key:"updateGeometry",value:function(e){this._changedObjectIds.add(e),this.notifyChange("_changedObjectIds")}},{key:"updateAttributeValue",value:function(e,t,i){this._changedObjectIds.add(e),this._cacheAttributeValue(e,t,i),this.notifyChange("_changedObjectIds")}},{key:"_cacheAttributeValue",value:function(e,t,i){this._memCache.put(this._getAttributeCacheKey(e,t),i,this._memCacheAttributeValueSize(i))}},{key:"_getOverridesFromCache",value:function(e,t,i){var n,r=t.loadedAttributes,a=t.attributeData,o=new Set,d=new Array,l=(0,s.Z)(r);try{for(l.s();!(n=l.n()).done;){var u=n.value;d[u.index]=a[u.name]}}catch(m){l.e(m)}finally{l.f()}for(var h=new Set,c=0;c<e.length;c++){var _=e[c];if(i.has(_)){var f,v=(0,s.Z)(r);try{for(v.s();!(f=v.n()).done;){var g=f.value,p=this._fromCache(_,g.index);void 0===p?(o.add(_),h.add(g.name)):d[g.index][c]=p}}catch(m){v.e(m)}finally{v.f()}}}return{objectIds:Array.from(o),fieldNames:Array.from(h)}}},{key:"_fromCache",value:function(e,t){var i=this._fromInteractiveEditingSession(e,t);if(void 0!==i)return i;var n=this._getAttributeCacheKey(e,t);return this._memCache.get(n)}},{key:"_fromInteractiveEditingSession",value:function(e,t){if(!(0,y.Wi)(this._interactiveEditingSessions)){var i,n=(0,s.Z)(this._interactiveEditingSessions);try{for(n.s();!(i=n.n()).done;){var r=i.value;if(r.objectId===e){var a=r.get(t);if(void 0!==a)return a}}}catch(o){n.e(o)}finally{n.f()}}}},{key:"_getAttributeCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"_queryOverridesFromAssociatedLayer",value:function(){var e=(0,r.Z)((0,n.Z)().mark((function e(t,i,r){var a,s,d,l;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==i.length){e.next=2;break}return e.abrupt("return",null);case 2:if(t=t.sort((function(e,t){return e-t})),this._warnMaximumChangedObjectsExceeded&&(this._warnMaximumChangedObjectsExceeded=!1,this._logMaximumObjectsExceededWarning()),a=this.layer.associatedLayer,!(0,y.Wi)(a)){e.next=6;break}return e.abrupt("return",null);case 6:return(s=a.createQuery()).where="1=1",s.returnGeometry=!1,s.outFields=[a.objectIdField].concat((0,o.Z)(i)),s.cacheHint=!0,s.objectIds=t,d=(0,w.qo)(a),l=t.length>d?(0,v.vr)(t,d).map((function(e){var t=s.clone();return t.objectIds=e,(0,g.mt)((0,w.UK)(a,t,{signal:r}))})):[(0,g.mt)((0,w.UK)(a,s,{signal:r}))],e.next=11,Promise.all(l);case 11:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 12:case"end":return e.stop()}}),e,this)})));return function(t,i,n){return e.apply(this,arguments)}}()},{key:"_logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat((0,N.uf)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),m.Z.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"_processOverridesFromAssociatedLayer",value:function(e,t,i,n){var r=n.loadedAttributes,a=n.attributeData,o=this.layer.associatedLayer;if(!(0,y.Wi)(o)){var d,l=o.objectIdField,u=i.map((function(e){return a[e]})),h=new Map(r.map((function(e){return[e.name,e.index]}))),c=i.map((function(e){return h.get(e)})),_=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=(0,s.Z)(t);try{for(f.s();!(d=f.n()).done;)for(var v=d.value,g=v.attributes[l],p=0;p<i.length;p++){var m=c[p],b=_.get(g),x=v.attributes[i[p]];u[p][b]=x,this._cacheAttributeValue(g,m,x)}}catch(C){f.e(C)}finally{f.f()}}}},{key:"_memCacheAttributeValueSize",value:function(e){return"string"==typeof e?(0,p.hH)(e):(0,p.G3)()}},{key:"_fetchChangedObjectIds",value:function(){var e=(0,r.Z)((0,n.Z)().mark((function e(t){var i,r,a,s,o,d,l,u,h,c,f,v,p,m,b,x;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.layer,e.next=3,s.load({signal:t});case 3:if(this._changedObjectIds.clear(),!(0,y.Wi)(s.associatedLayer)&&null!==(i=s.associatedLayer.capabilities)&&void 0!==i&&null!==(r=i.operations)&&void 0!==r&&r.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(o=this._getFetchChangedObjectIdsServerGen(),!(0,y.Wi)(o)){e.next=9;break}return e.abrupt("return");case 9:return d=s.associatedLayer.layerId,l=(0,y.pC)(s.associatedLayer.infoFor3D),e.next=13,(0,g.q6)((0,_.default)("".concat(s.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"[".concat(d,"]"),returnUpdates:!0,returnDeletes:l,returnInserts:l,layerServerGens:JSON.stringify([{id:d,serverGen:o}])},timeout:F,signal:t}));case 13:if((u=e.sent).ok&&null!==(a=u.value.data)&&void 0!==a&&a.edits&&1===u.value.data.edits.length)for(h=u.value.data.edits[0],c=(0,y.U2)(h,"objectIds","adds"),f=(0,y.U2)(h,"objectIds","updates"),v=(0,y.U2)(h,"objectIds","deletes"),p=[],(0,y.pC)(c)&&(p=p.concat(c)),(0,y.pC)(f)&&(p=p.concat(f)),(0,y.pC)(v)&&(p=p.concat(v)),(m=Math.min(this._maximumNumberOfEditOVerrides,p.length))<p.length&&(this._warnMaximumChangedObjectsExceeded=!0),b=p.sort((function(e,t){return e-t})),x=0;x<m;x++)this._changedObjectIds.add(b[x]);this.notifyChange("_changedObjectIds");case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if((0,y.pC)(e.serviceUpdateTimeStamp)&&(0,y.pC)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return(0,y.pC)(t)&&(0,y.pC)(t.serverGens)&&(0,y.pC)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this._changedObjectIds),t=this._pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),i}(f.Z);(0,c._)([(0,C.Cb)({constructOnly:!0})],P.prototype,"view",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],P.prototype,"layer",void 0),(0,c._)([(0,C.Cb)({readOnly:!0})],P.prototype,"is3DOFL",null),(0,c._)([(0,C.Cb)({readOnly:!0})],P.prototype,"geometryChangedObjectIds",null),(0,c._)([(0,C.Cb)()],P.prototype,"_associatedLayer",null),(0,c._)([(0,C.Cb)()],P.prototype,"_associatedLayerView",void 0),(0,c._)([(0,C.Cb)({constructOnly:!0})],P.prototype,"memoryController",void 0),(0,c._)([(0,C.Cb)()],P.prototype,"_changedObjectIds",void 0),(0,c._)([(0,C.Cb)()],P.prototype,"_pendingFetchChangedObjectIds",void 0),(0,c._)([(0,C.Cb)()],P.prototype,"_definitionExpression",null),(0,c._)([(0,C.Cb)()],P.prototype,"updating",null),(0,c._)([(0,C.Cb)()],P.prototype,"isEmpty",null),P=(0,c._)([(0,k.j)("esri.views.3d.layers.i3s.I3SOverrides")],P);var L,S,O=function(){function e(t,i){(0,d.Z)(this,e),this.objectId=t,this._options=i,this._updates=new Map,this._state=L.ACTIVE}return(0,l.Z)(e,[{key:"get",value:function(e){return this._updates.get(e)}},{key:"set",value:function(e,t){this._isActive&&this._updates.set(e,t)}},{key:"rollback",value:function(){this._isActive&&(this._state=L.ROLLED_BACK,this._options.rollback())}},{key:"commit",value:function(){this._isActive&&(this._state=L.COMMITTED,this._options.commit(this._updates),this._updates.clear())}},{key:"_isActive",get:function(){return this._state===L.ACTIVE}}]),e}();(S=L||(L={}))[S.ACTIVE=0]="ACTIVE",S[S.COMMITTED=1]="COMMITTED",S[S.ROLLED_BACK=2]="ROLLED_BACK";var F=1e4,M=5e4},99048:function(e,t,i){var n,r;i.d(t,{j:function(){return n},v:function(){return r}}),function(e){e[e.KTX2=1]="KTX2",e[e.Basis=2]="Basis",e[e.DDS_S3TC=4]="DDS_S3TC",e[e.PNG=8]="PNG",e[e.JPG=16]="JPG",e[e.KTX_ETC2=32]="KTX_ETC2"}(n||(n={})),function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.MetallicRoughness=2]="MetallicRoughness",e[e.Normal=4]="Normal",e[e.Occlusion=8]="Occlusion",e[e.Emissive=16]="Emissive",e[e.AlphaMask=32]="AlphaMask",e[e.ColorTextures=19]="ColorTextures",e[e.GeometryTextures=36]="GeometryTextures",e[e.GeometryTexturesPBR=44]="GeometryTexturesPBR",e[e.AllTextures=37]="AllTextures",e[e.AllTexturesPBR=63]="AllTexturesPBR"}(r||(r={}))},21765:function(e,t,i){var n;i.d(t,{B:function(){return n}}),function(e){e[e.FadeIn=0]="FadeIn",e[e.FadeOut=1]="FadeOut"}(n||(n={}))},89261:function(e,t,i){i.d(t,{T:function(){return o}});var n=i(15671),r=i(43144),a=i(92026),s=i(66978),o=function(){function e(t,i){var r=this;(0,n.Z)(this,e),this._textureRep=t,this.loadPromise=null,this._disposed=!1;var o=this._textureRep.acquire(i);(0,s.y8)(o)?(o.then((function(e){r._disposed?(0,a.RY)(e):r._textureRef=e})),this.loadPromise=o):this._textureRef=o}return(0,r.Z)(e,[{key:"dispose",value:function(){this._textureRef=(0,a.RY)(this._textureRef),this._disposed=!0}},{key:"glTexture",get:function(){return(0,a.pC)(this._textureRef)?this._textureRef.glTexture:null}}]),e}()}}]);
//# sourceMappingURL=63449.afa7c009.chunk.js.map