"use strict";(self.webpackChunkhub_layout_versioning=self.webpackChunkhub_layout_versioning||[]).push([[56717],{61029:function(e,t,i){i.d(t,{e:function(){return o},s:function(){return l}});var r=i(1413),n=(i(93169),i(10064)),a=i(92026),s=i(23707);function o(e){return(0,a.Wi)(e)||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function l(e,t){if((0,a.Wi)(e))return null;if(!o(e))return new n.Z("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '".concat(e.type||e.declaredClass,"'"),{renderer:e});switch(e.type){case"simple":return h(i=e,(0,s.q)(i.symbol).error);case"unique-value":return function(e,t){var i,n=(0,r.Z)((0,r.Z)({},s.K),t),o=null===(i=e.uniqueValueInfos)||void 0===i?void 0:i.map((function(e){return(0,s.q)(e.symbol,n).error})).filter(a.pC),l=(0,s.q)(e.defaultSymbol,n);return l.error&&null!==o&&void 0!==o&&o.unshift(l.error),h(e,o)}(e,t);case"class-breaks":return function(e){var t=e.classBreakInfos.map((function(e){return(0,s.q)(e.symbol).error})).filter(a.pC),i=(0,s.q)(e.defaultSymbol);return i.error&&t.unshift(i.error),h(e,t)}(e);case"dictionary":case"heatmap":return null}var i;return null}function h(e,t){if(!t)return null;var i;if((i=Array.isArray(t)?t:[t]).length>0){var r=i.map((function(e){return e.details.symbol.type||e.details.symbol.declaredClass})).filter((function(e){return!!e}));r.sort();var a=[];return r.forEach((function(e,t){0!==t&&e===r[t-1]||a.push(e)})),new n.Z("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols (".concat(a.join(", "),") which are not supported in 3D"),{renderer:e,symbolErrors:i})}return null}},52404:function(e,t,i){i.d(t,{D:function(){return l}});var r=i(15671),n=i(43144),a=i(27546),s=i(65156),o=i(93463),l=function(){function e(){(0,r.Z)(this,e),this._extents=new a.Z({allocator:function(e){return e||(0,s.Ue)()}}),this._tmpExtent=(0,s.Ue)(),this._dirty=!1}return(0,n.Z)(e,[{key:"empty",get:function(){return 0===this._extents.length}},{key:"size",get:function(){return this._extents.length}},{key:"clear",value:function(){this._extents.clear()}},{key:"add",value:function(e){this._contains(e)||(this._removeContained(e),(0,s.JG)(this._extents.pushNew(),e),this._dirty=!0)}},{key:"pop",value:function(){return this._dirty&&this._mergeTight(),this._extents.pop()}},{key:"merge",value:function(e){return this._mergeTight(e),e.hasProgressed}},{key:"_mergeTight",value:function(){for(var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:o.G5,i=this._extents,r=new Set,n=0;n!==i.length;){i.sort((function(e,t){return e[0]-t[0]})),n=i.length,r.clear();for(var a=function(n){if(t.done)return{v:void 0};var a=i.getItemAt(n);if(a){for(var o=n+1;o<i.length;++o){var l=i.getItemAt(o);if(null==l||l[0]>=a[2])break;r.add(l)}r.forEach((function(n){if(a!==n)if(n[2]<=a[0])r.delete(n);else{var o=(0,s.SO)(a),l=(0,s.SO)(n),h=e._tmpExtent;(0,s.jn)(a,n,h);var c=o+l;((0,s.SO)(h)-c)/c<.05&&((0,s.JG)(a,h),r.delete(n),i.remove(n),t.madeProgress())}})),r.add(a)}},l=0;l<i.length;++l){var h=a(l);if("object"===typeof h)return h.v}}this._dirty=!1}},{key:"_contains",value:function(e){return this._extents.some((function(t){return(0,s.r3)(t,e)}))}},{key:"_removeContained",value:function(e){this._extents.filterInPlace((function(t){return!(0,s.r3)(e,t)}))}},{key:"test",get:function(){var e=this;return{containsPoint:function(t){return e._extents.some((function(e){return(0,s.BD)(e,t)}))}}}}]),e}()},86792:function(e,t,i){i.d(t,{w:function(){return at}});var r=i(93433),n=i(29439),a=i(74165),s=i(15861),o=i(37762),l=i(15671),h=i(43144),c=i(97326),u=i(60136),d=i(92572),p=i(27366),y=(i(59486),i(94931),i(78451),i(98689),i(57823),i(32066),i(49018),i(34999),i(28189)),v=(i(9014),i(51508),i(31319)),f=i(93169),g=i(10064),_=i(100),b=i(42537),m=i(32718),C=i(77427),S=i(92026),w=i(27546),G=i(66978),x=i(94172),k=i(99346),I=i(49861),E=(i(25243),i(63780)),R=i(69912),D=i(48732),P=i(11186),O=i(71353),A=i(79803),Z=i(41414),L=i(65156),U=i(92975),V=i(30651),j=i(65618),F=i(37818),T=i(61029),W=i(819),z=i(43977),M=i(31655),B=i(16915),H=i(62554),N=i(1030),q=i(66985),Y=i(61574),Q=i(76115),J=H.Z.fromSimpleMarkerSymbol(Y.xA),X=M.Z.fromSimpleLineSymbol(Y.CJ),K=N.Z.fromSimpleFillSymbol(Y.z3),$=new B.Z({symbolLayers:[new z.Z({material:{color:Q.SQ},edges:new q.Z({size:"1px",color:Q.X1})})]});function ee(e){if((0,S.Wi)(e))return null;switch(e.type){case"mesh":return $;case"point":case"multipoint":return J;case"polyline":return X;case"polygon":case"extent":return K}return null}var te=i(23707),ie=i(91293),re=i(70446),ne=i(8821),ae=i(91505),se=i(3182),oe=i(80457),le=i(77835),he=(0,Z.Ue)(),ce=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e)).events=new ae.Z,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.featureAdapter={getAttribute:function(e,t){return"graphic"in e?e.graphic.attributes[t]:le.n.getAttribute(e,t)},getAttributes:function(e){return"graphic"in e?e.graphic.attributes:le.n.getAttributes(e)},getObjectId:function(e){var t;return"graphic"in e?null!==(t=(0,j.MS)(e.graphic,r.objectIdField))&&void 0!==t?t:void 0:le.n.getObjectId(e)},getGeometry:function(e){return"graphic"in e?e.getAsOptimizedGeometry(r.hasZ,r.hasM):le.n.getGeometry(e)},getCentroid:function(e,t){if("graphic"in e){var i=null;(0,S.pC)(e.centroid)?i=e.centroid:"point"===e.graphic.geometry.type&&(0,A.nF)(e.graphic.geometry,ue,r.viewSpatialReference)&&(i=ue);var n=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return(0,S.Wi)(i)?(n[0]=0,n[1]=0,n[2]=0,n[3]=0):(n[0]=i.x,n[1]=i.y,t.hasZ&&(n[2]=i.hasZ?i.z:0),t.hasM&&(n[t.hasZ?3:2]=i.hasM?i.m:0)),new oe.Z([],n)}return le.n.getCentroid(e,t)},cloneWithGeometry:function(e,t){return"graphic"in e?new se.u_(t,r.featureAdapter.getAttributes(e),null,r.featureAdapter.getObjectId(e)):le.n.cloneWithGeometry(e,t)}},r}return(0,h.Z)(i,[{key:"forEachInBounds",value:function(e,t){this.getSpatialIndex().forEachInBounds(e,t)}},{key:"forEachBounds",value:function(e,t){var i,r=this.getSpatialIndex(),n=(0,o.Z)(e);try{for(n.s();!(i=n.n()).done;){var a=i.value,s=this.featureAdapter.getObjectId(a);(0,S.pC)(r.getBounds(s,he))&&t(he)}}catch(l){n.e(l)}finally{n.f()}}}]),i}(v.Z);(0,p._)([(0,I.Cb)({constructOnly:!0})],ce.prototype,"getSpatialIndex",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],ce.prototype,"forEach",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],ce.prototype,"hasZ",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],ce.prototype,"hasM",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],ce.prototype,"objectIdField",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],ce.prototype,"viewSpatialReference",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],ce.prototype,"featureSpatialReference",void 0),ce=(0,p._)([(0,R.j)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],ce);var ue={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},de=i(91107),pe=(0,h.Z)((function e(t,i){(0,l.Z)(this,e),this.scheduler=t,this.schedule=i,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1})),ye=i(11752),ve=i(61120),fe=i(14921),ge=i(67166),_e=i(95437),be=i(89639),me=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e,r,n){var a;return(0,l.Z)(this,i),(a=t.call(this,e,r,n))._calloutSymbolLayer=null,a.symbol.hasVisibleCallout()&&(a._calloutSymbolLayer=(0,ge.S)(a.symbol,r)),a}return(0,h.Z)(i,[{key:"doLoad",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var r,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._calloutSymbolLayer?(0,fe.q6)(this._calloutSymbolLayer.load()):null,e.prev=1,e.next=4,(0,ye.Z)((0,ve.Z)(i.prototype),"doLoad",this).call(this,t);case 4:(0,G.k_)(t),e.next=10;break;case 7:throw e.prev=7,e.t0=e.catch(1),null!==(n=this._calloutSymbolLayer)&&void 0!==n&&n.abortLoad(),e.t0;case 10:if(e.t1=r,!e.t1){e.next=14;break}return e.next=14,r;case 14:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(t){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){(0,ye.Z)((0,ve.Z)(i.prototype),"destroy",this).call(this),this._calloutSymbolLayer=(0,S.SC)(this._calloutSymbolLayer)}},{key:"createGraphics3DGraphic",value:function(e,t){var r=(0,ye.Z)((0,ve.Z)(i.prototype),"createGraphics3DGraphic",this).call(this,e,t);if((0,S.pC)(this._calloutSymbolLayer)&&(0,S.pC)(r)){var n=this._createCalloutGraphic(e);(0,S.pC)(n)&&r.addAuxiliaryGraphic(n)}return r}},{key:"globalPropertyChanged",value:function(e,t){var r=this;return!!(0,ye.Z)((0,ve.Z)(i.prototype),"globalPropertyChanged",this).call(this,e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,(function(e){return r._getCalloutGraphicLayer(e)})))}},{key:"updateGeometry",value:function(e,t){var r=(0,ye.Z)((0,ve.Z)(i.prototype),"updateGeometry",this).call(this,e,t);if(r&&this._calloutSymbolLayer){var n=this._getCalloutGraphicLayer(e);if(n)return this._calloutSymbolLayer.updateGeometry(n,t)}return r}},{key:"_createCalloutGraphic",value:function(e){var t=e.renderingInfo;return e.renderingInfo=new _e.Ly(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}},{key:"_getCalloutGraphicLayer",value:function(e){var t,i=(0,o.Z)(e._auxiliaryLayers);try{for(i.s();!(t=i.n()).done;){var r=t.value;if(r.graphics3DSymbolLayer===this._calloutSymbolLayer)return r}}catch(n){i.e(n)}finally{i.f()}}}]),i}(be.Z);var Ce=i(19477),Se=function(){function e(t){var i=this;(0,l.Z)(this,e),this._graphicsCore=t,this._idToState=new Map,this._states=new Set;var r=t.owner.layer&&t.owner.layer.objectIdField;r?(this._getGraphicId=function(e){return(0,j.MS)(e,r)},this._getGraphics3DGraphicById=function(e){return i._graphicsCore.getGraphics3DGraphicByObjectId(e)}):(this._getGraphicId=function(e){return e.uid},this._getGraphics3DGraphicById=function(e){return i._graphicsCore.getGraphics3DGraphicById(e)})}return(0,h.Z)(e,[{key:"destroy",value:function(){var e=this;this._idToState.clear(),this._states.forEach((function(t,i){return e.remove(i)}))}},{key:"add",value:function(e){var t=this,i={remove:function(){return t.remove(e)}};if(this._states.has(e))return i;var r=this._getGraphicId(e.graphic),n=this._getGraphics3DGraphicById(r);return this._states.has(e)||this._states.add(e),this._ensureStateList(r).push(e),e.displaying=!!(0,S.pC)(n)&&n.isVisible(),e.isDraped=!!(0,S.pC)(n)&&n.isDraped,e.tracking=!0,(0,S.pC)(n)&&e.emit("changed"),i}},{key:"remove",value:function(e){if(this._states.has(e)){if(this._idToState.size){var t=this._getGraphicId(e.graphic),i=this._idToState.get(t);i&&((0,E.Od)(i,e),0===i.length&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}},{key:"addGraphic",value:function(e){this._forEachState(e,(function(t){t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed")}))}},{key:"removeGraphic",value:function(e){this._forEachState(e,(function(e){e.displaying=!1,e.isDraped=!1}))}},{key:"updateGraphicGeometry",value:function(e){this._forEachState(e,(function(e){return e.emit("changed")}))}},{key:"updateGraphicVisibility",value:function(e){this._forEachState(e,(function(t){return t.displaying=e.isVisible()}))}},{key:"allGraphicsDeleted",value:function(){this._states.forEach((function(e){e.displaying=!1}))}},{key:"_ensureStateList",value:function(e){var t=this._idToState.get(e);if(t)return t;var i=new Array;return this._idToState.set(e,i),i}},{key:"_forEachState",value:function(e,t){if(0!==this._states.size&&0!==this._idToState.size){var i=this._getGraphicId(e.graphic),r=this._idToState.get(i);null!=r&&r.forEach(t)}}}]),e}(),we=i(96387),Ge=i(41325),xe=i(85042),ke=i(13491),Ie=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e))._index=new ke.Q(9,(0,f.Z)("esri-csp-restrictions")?function(e){return{minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}}:[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),r._missing=new Set,r._boundsByFeature=new Map,r.spatialReference=null,r.hasZ=null,r.hasM=null,r.objectIdField=null,r.updating=!1,r}return(0,h.Z)(i,[{key:"setup",value:function(e){this._addMany(e)}},{key:"destroy",value:function(){this._missing.clear(),this._index=(0,S.SC)(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}},{key:"update",value:function(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}},{key:"updatingRemaining",get:function(){return this._missing.size}},{key:"queryGraphicUIDsInExtent",value:function(e,t,i){!(0,S.Wi)(t)&&t.equals(this.spatialReference)&&(Ee.minX=e[0],Ee.minY=e[1],Ee.maxX=e[2],Ee.maxY=e[3],this.update(),this._index.search(Ee,(function(e){return i(e.graphic.uid)})))}},{key:"add",value:function(e){this._missing.add(e),this.updating=!0}},{key:"remove",value:function(e){if(this._missing.delete(e))this.updating=this._missing.size>0;else{this._index.remove(e);var t=(0,j.MS)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}}},{key:"_addMany",value:function(e){if(0!==e.length){var t,i=this._get("objectIdField"),r=(0,o.Z)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;n.computeExtent(this.spatialReference);var a=(0,j.MS)(n.graphic,i);null!=a&&this._boundsByFeature.set(a,n.extent)}}catch(s){r.e(s)}finally{r.f()}this._index.load(e)}}},{key:"clear",value:function(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}},{key:"forEachInBounds",value:function(e,t){Ee.minX=e[0],Ee.minY=e[1],Ee.maxX=e[2],Ee.maxY=e[3],this.update(),this._index.search(Ee,(function(e){t(e)}))}},{key:"getBounds",value:function(e,t){this.update();var i=this._boundsByFeature.get(e);return i?(0,Z.JR)(t,i):null}}]),i}(v.Z);(0,p._)([(0,I.Cb)({constructOnly:!0})],Ie.prototype,"spatialReference",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],Ie.prototype,"hasZ",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],Ie.prototype,"hasM",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],Ie.prototype,"objectIdField",void 0),(0,p._)([(0,I.Cb)()],Ie.prototype,"updating",void 0),(0,p._)([(0,I.Cb)({readOnly:!0})],Ie.prototype,"updatingRemaining",null),Ie=(0,p._)([(0,R.j)("esri.views.3d.layers.graphics.SpatialIndex2D")],Ie);var Ee={minX:0,minY:0,maxX:0,maxY:0},Re=i(35218),De=i(68860),Pe=i(88152),Oe=i(88153),Ae=i(54463),Ze=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e))._elevationOffset=0,r._layerHandes=new _.Z,r}return(0,h.Z)(i,[{key:"spatialReference",get:function(){var e;return null===(e=this.view)||void 0===e?void 0:e.spatialReference}},{key:"initialize",value:function(){var e=this;this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=(0,Oe.Z8)(this.view.state.viewingMode),this._intersector.options.store=Ae.eC.MIN;var t=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=t[2],this._zmax=t[5];var i=this.stageLayer.events;this._layerHandes.add([i.on("layerObjectAdded",(function(t){return e._objectChanged(t.object)})),i.on("layerObjectRemoved",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryAdded",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryRemoved",(function(t){return e._objectChanged(t.object)})),i.on("objectGeometryUpdated",(function(t){return e._objectChanged(t.object)})),i.on("objectTransformation",(function(t){return e._objectChanged(t)}))])}},{key:"dispose",value:function(){this._layerHandes.destroy()}},{key:"elevationInfoChanged",value:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){var t,i=(0,De._R)(this.layer.spatialReference),r=(0,Pe.Z7)(null!==(t=e.unit)&&void 0!==t?t:"meters");this._elevationOffset=(0,S.Pt)(e.offset,0)*r/i}else this._elevationOffset=0}},{key:"getElevation",value:function(e,t,i,r){if(We[0]=e,We[1]=t,We[2]=i,!this._renderCoordsHelper.toRenderCoords(We,r,We))return m.Z.getLogger(this.declaredClass).error("could not project point for elevation alignment"),null;var n=this._elevationOffset,a=this._zmin+n,s=this._zmax+n;this._renderCoordsHelper.setAltitude(ze,s,We),this._renderCoordsHelper.setAltitude(Me,a,We);return this._intersector.reset(ze,Me,null),this._intersector.intersect(this._intersectLayers,null,1,null,(function(e){var t;return!(null===(t=e.metadata)||void 0===t||!t.isElevationSource)})),this._intersector.results.min.getIntersectionPoint(We)?this._renderCoordsHelper.getAltitude(We):null}},{key:"_objectChanged",value:function(e){var t,i=this.spatialReference;if(null!==(t=e.metadata)&&void 0!==t&&t.isElevationSource&&!(0,S.Wi)(i)){(0,Z.cS)(je);var r=e.metadata.lastValidElevationBB;r.isEmpty()||this._expandExtent(i,r.min,r.max,je);var n=e.boundingVolumeWorldSpace,a=n.min,s=n.max;this._expandExtent(i,a,s,je),(0,Z.y8)(je,Fe),this._zmin=Math.min(this._zmin,je[2]),this._zmax=Math.max(this._zmax,je[5]),Te.extent=Fe,Te.spatialReference=i,this.emit("elevation-change",Te),(0,P.c)(r.min,a),(0,P.c)(r.max,s)}}},{key:"_computeLayerExtent",value:function(e,t){var i=this;return(0,Z.cS)(je),(0,S.pC)(e)&&t.objects.forAll((function(t){return i._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,je)})),je}},{key:"_expandExtent",value:function(e,t,i,r){for(var n=0;n<8;++n)We[0]=1&n?t[0]:i[0],We[1]=2&n?t[1]:i[1],We[2]=4&n?t[2]:i[2],this._renderCoordsHelper.fromRenderCoords(We,We,e),(0,Z.pp)(r,We);return r}}]),i}(ae.Z.EventedMixin(v.Z));(0,p._)([(0,I.Cb)({constructOnly:!0})],Ze.prototype,"layer",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],Ze.prototype,"stageLayer",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],Ze.prototype,"view",void 0),(0,p._)([(0,I.Cb)()],Ze.prototype,"spatialReference",null),Ze=(0,p._)([(0,R.j)("esri.views.3d.layers.support.StageLayerElevationProvider")],Ze);var Le,Ue,Ve,je=(0,Z.cS)(),Fe=(0,L.cS)(),Te={spatialReference:null,extent:Fe,context:"scene"},We=(0,O.c)(),ze=(0,O.c)(),Me=(0,O.c)(),Be=i(65206),He=i(76419),Ne=i(19962),qe=i(78485),Ye=i(97882),Qe=i(93463),Je=i(53866),Xe=i(585),Ke=i(24931),$e=i(58009),et=i(80045),tt=(0,O.c)(),it=(0,Z.Ue)(),rt="esri.views.3d.layers.graphics.Graphics3DCore",nt=m.Z.getLogger(rt),at=Le=function(e){(0,u.Z)(i,e);var t=(0,d.Z)(i);function i(e){var r;return(0,l.Z)(this,i),(r=t.call(this,e))._propertiesPool=new He.L({computedExtent:Je.Z},(0,c.Z)(r)),r.computedExtent=null,r.currentRenderer=null,r.rendererHasGeometryOperations=!1,r._graphicStateTracking=null,r.graphics3DGraphics=new Map,r.stageLayer=null,r.stage=null,r._graphicsDrapedUids=new Set,r._graphicsBySymbol=new Map,r._symbolConversionCache=new Map,r._symbols=new Map,r._graphicsWithoutSymbol=new Map,r._graphicsWaitingForSymbol=new Map,r._graphicsUpdateId=0,r._handles=new _.Z,r._frameTask=Qe.sq,r._suspendSymbolCleanup=!1,r._arcadeOnDemand=null,r._rendererChangeAbortController=null,r._elevationInfoChangeAbortController=null,r._initializeAbortController=null,r._scaleVisibility=null,r._filterVisibility=null,r._spatialIndex=null,r.extentPadding=0,r._updatingPendingLoadedGraphicsChange=null,r._featureStore=null,r._deconflictor=null,r._labeler=null,r._objectStates=null,r._viewElevationProvider=null,r._stageLayerElevationProvider=null,r._sharedSymbolResourcesOwnerHandle=null,r._whenGraphics3DGraphicRequests={},r._pendingUpdates=new Map,r._numberOfGraphics=0,r._numberOfGraphicsProvidingElevation=0,r._pendingAdds=0,r._pendingRemoves=0,r._applyPendingRemovesFirst=!1,r._loadingSymbols=0,r._pendingUpdatesPool=new w.Z({allocator:function(e){return e||new st},deallocator:function(e){return e.clear(),e}}),r._symbolWarningLogged=!1,r._geometryWarningLogged=!1,r._objectIdInvisibleSet=new Set,r._whenSymbolRemoved=new w.Z,r.preferredUpdatePolicy=qe.j.SYNC,r._forcedUpdatePolicy=null,r.elevationFeatureExpressionEnabled=!0,r.owner=null,r.layer=null,r.graphicSymbolSupported=!0,r.getRenderingInfoWithoutRenderer=!1,r.setUidToIdOnAdd=!0,r.hasZ=null,r.hasM=null,r._usedMemory=0,r._visible=!1,r._startCreateGraphics=!1,r.symbolCreationContext=new pe(e.owner.view.resourceController.scheduler,(function(e,t){return r._frameTask.schedule(e,t)})),r}return(0,h.Z)(i,[{key:"_viewSpatialReference",get:function(){return this.owner.view.spatialReference}},{key:"spatialIndex",get:function(){var e;return this._spatialIndex||(this._spatialIndex=new Ie({objectIdField:null===(e=this.owner.layer)||void 0===e?void 0:e.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}},{key:"numberOfGraphics",get:function(){return this._numberOfGraphics}},{key:"effectiveUpdatePolicy",get:function(){return(0,S.pC)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?qe.j.ASYNC:(0,S.Pt)(this._forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"featureStore",get:function(){return this._featureStore}},{key:"initializePromise",get:function(){return this._initializePromise}},{key:"scaleVisibility",get:function(){return this._scaleVisibility}},{key:"elevationAlignment",get:function(){return this._elevationAlignment}},{key:"objectStates",get:function(){return this._objectStates}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"updating",get:function(){var e;return!!(this._graphicsWaitingForSymbol.size>0||this.running||null!==(e=this._elevationAlignment)&&void 0!==e&&e.updating||(0,S.pC)(this._scaleVisibility)&&this._scaleVisibility.updating||(0,S.pC)(this._filterVisibility)&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}},{key:"running",get:function(){var e;return this._pendingUpdates.size>0||!(null===(e=this._spatialIndex)||void 0===e||!e.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var e;return this.owner.suspended||!(null===(e=this.owner.suspendInfo)||void 0===e||!e.outsideOfView)}},{key:"updatingRemaining",get:function(){var e,t;return this.updating?this._pendingUpdates.size+.1*((null===(e=this._spatialIndex)||void 0===e?void 0:e.updatingRemaining)||0)+.1*((null===(t=this._elevationAlignment)||void 0===t?void 0:t.updatingRemaining)||0):0}},{key:"displayFeatureLimit",get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,n=this.averageSymbolComplexity,a=Math.max(1,(0,S.pC)(n)?n.primitivesPerFeature:1),s=(0,S.pC)(n)&&n.drawCallsPerFeature>0?i/n.drawCallsPerFeature*.3:i,o=Math.ceil(r/a),l=Math.max(t,Math.min(i,o,s)),h=this._get("displayFeatureLimit");return h&&h.minimumTotalNumberOfFeatures===t&&h.maximumTotalNumberOfFeatures===i&&h.maximumTotalNumberOfPrimitives===r&&h.averageSymbolComplexity===n&&h.maximumNumberOfFeatures===l?h:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:n,maximumNumberOfFeatures:l}}},{key:"averageSymbolComplexity",get:function(){var e=(0,Re.bz)(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||(0,S.pC)(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}},{key:"usedMemory",get:function(){var e=(0,S.pC)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce((function(e,t){return e+t.memory.resourceBytes}),0);return this._usedMemory+e+t}},{key:"usedMemoryPerGraphic",get:function(){if(this._usedMemory&&this._numberOfGraphics){var e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if((0,S.pC)(this.averageSymbolComplexity)){var t=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+t}return 0}},{key:"unprocessedMemoryEstimate",get:function(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}},{key:"_symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},{key:"visible",get:function(){return this._visible}},{key:"_getConvertedSymbol",value:function(e){var t,i;if("web-style"===e.type)return e.clone();var r=this._symbolConversionCache.get(e.id);if((0,S.pC)(r))return r;var n=(0,te.q)(e,{geometryType:null!==(t=null===(i=this.layer)||void 0===i?void 0:i.geometryType)&&void 0!==t?t:void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),a=n.symbol||null;return(0,S.Wi)(a)&&n.error&&nt.error(n.error.message),this._symbolConversionCache.set(e.id,a),a}},{key:"_getSymbolComplexitiesUsedOrRenderer",value:function(e){if((0,S.Wi)(e))return[];var t=e.getSymbols(),i="backgroundFillSymbol"in e?e.backgroundFillSymbol:null;if(!(i||t&&t.length))return[];var r=[],n=this._getSymbolComplexityUsedOrRenderer(i);(0,S.pC)(n)&&r.push(n);var a,s=(0,o.Z)(t);try{for(s.s();!(a=s.n()).done;){var l=a.value,h=this._getSymbolComplexityUsedOrRenderer(l);(0,S.pC)(h)&&r.push(h)}}catch(c){s.e(c)}finally{s.f()}return r}},{key:"_getSymbolComplexityUsedOrRenderer",value:function(e){if((0,S.Wi)(e))return null;var t=this._symbols.get(e.id);if((0,S.pC)(t))return t.complexity;var i=this._getConvertedSymbol(e);return(0,S.pC)(i)?(0,Re.V9)(i):null}},{key:"_getSymbolComplexitiesUsed",value:function(){var e=[];return this._symbols.forEach((function(t){(0,S.pC)(t)&&e.push(t.complexity)})),e}},{key:"_objectIdField",get:function(){return this.layer.objectIdField}},{key:"initialize",value:function(){var e=this;this._featureStore=new ce({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:function(){return e.spatialIndex},forEach:function(t){return e.graphics3DGraphics.forEach(t)}});var t=function(t,i,r){return e.spatialIndex.queryGraphicUIDsInExtent(t,i,r)},i=this.componentFactories;if((0,S.pC)(i.elevationAlignment)){var r=i.elevationAlignment(this,t);this._elevationAlignment=r}if((0,S.pC)(i.scaleVisibility)){var n=i.scaleVisibility(this,t);this._scaleVisibility=n}if((0,S.pC)(i.filterVisibility)){var a=i.filterVisibility({featureStore:this._featureStore,getFeatureCount:function(){return e.graphics3DGraphics.size},updateFeatureVisibilities:function(t){return e.modifyGraphics3DGraphicVisibilities((function(i){return i.setVisibilityFlag(re.P.FILTER,t((0,j.MS)(i.graphic,e._objectIdField)),re.E.GRAPHIC)}))},setAllFeaturesVisibility:function(t){return e.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(re.P.FILTER,t,re.E.GRAPHIC)}))},clearFeaturesVisibility:function(){return e.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(re.P.FILTER)}))}});this._filterVisibility=a}if((0,S.pC)(i.deconflictor)){var s=i.deconflictor(this);this._deconflictor=s}if((0,S.pC)(i.labeler)&&(0,S.pC)(this._scaleVisibility)){var o=i.labeler(this,this._scaleVisibility);this._labeler=o}if((0,S.pC)(i.objectStates)){var l=i.objectStates(this);this._objectStates=l}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}},{key:"_initializeAsync",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,i,r,n,s,o,l,h,c,u=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=null===(t=this._initializeAbortController)||void 0===t?void 0:t.signal,o=this.owner.view,this._viewElevationProvider=new ie.Y(this._viewSpatialReference,o),this._initializeStage(o,this.layer.uid),l=o.sharedSymbolResources,this.symbolCreationContext.sharedResources=l,this._sharedSymbolResourcesOwnerHandle=l.addGraphicsOwner(this.owner),(0,S.pC)(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=l.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=o.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new Ne.C(o.renderSpatialReference),this.symbolCreationContext.elevationProvider=o.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=function(e){return u.notifyGraphicGeometryChanged(e)},this.symbolCreationContext.notifyGraphicVisibilityChanged=function(e){return u.notifyGraphicVisibilityChanged(e)},h=(0,ne.WI)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=7,(0,ne.kr)(h,this._viewSpatialReference,s,nt);case 7:if(this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,G.k_)(s),this.symbolCreationContext.screenSizePerspectiveEnabled=o.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!(null===(i=this.owner.view.qualitySettings)||void 0===i||!i.physicallyBasedRenderingEnabled),this.symbolCreationContext.skipHighSymbolLods=!(null===(r=this.owner.view.qualitySettings)||void 0===r||null===(n=r.graphics3D)||void 0===n||!n.skipHighSymbolLods),!("drapeSourceType"in this.owner)){e.next=16;break}c=this.owner,this.symbolCreationContext.drapeSourceRenderer=o.basemapTerrain.overlayManager.registerGeometryDrapeSource(c),this._handles.add((0,b.kB)((function(){return o.basemapTerrain.overlayManager.unregisterDrapeSource(c)})));case 16:this._handles.add([(0,x.YP)((function(){return u.suspendedOrOutsideOfView}),(function(){return u._frameTask.reschedule((function(){return u._updateLayerVisibility()}))})),(0,x.YP)((function(){var e;return[null===(e=u.layer)||void 0===e?void 0:e.screenSizePerspectiveEnabled,u.owner.view.screenSizePerspectiveEnabled]}),(function(){var e,t=o.screenSizePerspectiveEnabled&&!!u.layer.screenSizePerspectiveEnabled;t!==u.symbolCreationContext.screenSizePerspectiveEnabled&&(u.symbolCreationContext.screenSizePerspectiveEnabled=t,null!==(e=u._labeler)&&void 0!==e&&e.reset(),u.recreateAllGraphicsAndSymbols())})),(0,x.YP)((function(){return u.owner.slicePlaneEnabled}),(function(e){return u._slicePlaneEnabledChange(!!e)})),(0,x.YP)((function(){var e;return null===(e=u.owner.view.state)||void 0===e?void 0:e.rasterPixelRatio}),(function(){return u._pixelRatioChange()})),(0,x.YP)((function(){var e;return!(null===(e=u.owner.view.qualitySettings)||void 0===e||!e.physicallyBasedRenderingEnabled)}),(function(e){return u._physicalBasedRenderingChange(e)})),(0,x.YP)((function(){var e,t;return!(null===(e=u.owner.view.qualitySettings)||void 0===e||null===(t=e.graphics3D)||void 0===t||!t.skipHighSymbolLods)}),(function(e){return u._skipHighSymbolLoDsChange(e)})),(0,x.gx)((function(){var e;return null===(e=o.basemapTerrain)||void 0===e?void 0:e.tilingScheme}),(function(e){if(!e.spatialReference.equals(u.symbolCreationContext.overlaySR)&&(0,S.pC)(o.basemapTerrain.spatialReference)&&(u.symbolCreationContext.overlaySR=o.basemapTerrain.spatialReference),u._handles.has("loaded-graphics"))u.recreateAllGraphics();else{u._handles.add([(0,x.on)((function(){var e;return null===(e=u.owner)||void 0===e?void 0:e.loadedGraphics}),"change",(function(e){u._graphicsCollectionChanged(e),u._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:function(){u.recreateAllGraphics(),u._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),(0,x.YP)((function(){return u.effectiveUpdatePolicy}),(function(e){(0,S.pC)(u.stageLayer)&&(u.stageLayer.updatePolicy=e),u.symbolCreationContext.isAsync=u.effectiveUpdatePolicy===qe.j.ASYNC,e===qe.j.SYNC&&u.runTask(Qe.G5)}),x.tX)]),this._frameTask=o.resourceController.scheduler.registerTask(Qe.T8.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this._handles.add((0,x.YP)((function(){return u.layer.featureReduction}),(function(){return u._deconflictor.featureReductionChange()}))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((function(){})),this._initializeAbortController=null;case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_abortInitialize",value:function(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}},{key:"destroy",value:function(){for(var e in this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTask.remove(),this._frameTask=Qe.sq,this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._elevationAlignment=(0,S.SC)(this._elevationAlignment),this._scaleVisibility=(0,S.SC)(this._scaleVisibility),this._filterVisibility=(0,S.SC)(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=(0,S.SC)(this._objectStates),this.clear(),this._featureStore=(0,S.SC)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,S.hw)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,S.SC)(this._graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=(0,S.SC)(this._handles),this._set("owner",null),this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new g.Z("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,S.hw)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,S.SC)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,S.SC)(this._spatialIndex)}},{key:"clear",value:function(){var e,t;null!==(e=this._objectStates)&&void 0!==e&&e.allGraphicsDeleted(),(0,S.pC)(this._graphicStateTracking)&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((function(e){return e.destroy()})),null!==(t=this._spatialIndex)&&void 0!==t&&t.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(S.SC),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}},{key:"_initializeStage",value:function(e,t){var i=this;this.stage=e._stage,this.stageLayer=new Ye.F({pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);var r=this.stageLayer.events;r.on("objectTransformation",(function(e){return i.notifyGraphicGeometryChanged(e.metadata.graphicUid)})),r.on("visibilityChanged",(function(e){return i.notifyGraphicVisibilityChanged(e.metadata.graphicUid)})),r.on("objectGeometryAdded",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("objectGeometryRemoved",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)})),r.on("objectGeometryUpdated",(function(e){return i.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)}))}},{key:"notifyGraphicGeometryChanged",value:function(e){if(!(0,S.Wi)(this._graphicStateTracking)&&!(0,S.Wi)(e)){var t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}}},{key:"notifyGraphicVisibilityChanged",value:function(e){if(!(0,S.Wi)(this._graphicStateTracking)&&!(0,S.Wi)(e)){var t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}}},{key:"_updateLayerVisibility",value:function(){var e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*ot,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}},{key:"_updateStageLayerVisibility",value:function(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}},{key:"getGraphics3DGraphicById",value:function(e){return null!=e?this.graphics3DGraphics.get(e):void 0}},{key:"getGraphics3DGraphicByObjectId",value:function(e){var t;return null!==(t=this.owner.layer)&&void 0!==t&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}},{key:"_getGraphicObjectID",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.owner.layer&&this.owner.layer.objectIdField;return(0,j.MS)(e,t)}},{key:"graphics3DGraphicsByObjectID",get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(t){var i=new Map;return this.graphics3DGraphics.forEach((function(r){if(r){var n=r.graphic,a=e._getGraphicObjectID(n,t);(0,S.pC)(a)&&i.set(a,r)}})),i}}},{key:"labelsEnabled",get:function(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}},{key:"updateLabelingInfo",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var i,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._deconflictor&&this._deconflictor.labelingInfoChange(t),r=this._labeler&&this._labeler.labelingInfoChange(t),e.next=3,(0,G.as)([i,r]);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateVisibilityInfo",value:function(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange()}},{key:"symbolUpdateType",get:function(){var e=this;if(this._pendingUpdates.size>0)return"unknown";var t=0,i=0;return(0,C.oE)(this._symbols,(function(r,n){if((0,S.pC)(r)){var a=r.getFastUpdateStatus();if(a.loading>0)return!0;e._graphicsBySymbol.has(n)&&(i+=a.fast,t+=a.slow)}return!1}))?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"}},{key:"runTask",value:function(e){if(this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining"),!e.hasProgressed)return Qe.iQ.YIELD}},{key:"setObjectIdVisibility",value:function(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);(0,S.pC)(i)&&this._updateUserVisibility(i)}},{key:"_findGraphics3DGraphicByObjectId",value:function(e){var t=this;return(0,C.fQ)(this.graphics3DGraphics,(function(i){return t._getGraphicObjectID(i.graphic)===e}))}},{key:"_updateUserVisibility",value:function(e){if((0,S.Wi)(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&((0,S.Wi)(i)||!this._objectIdInvisibleSet.has(i));return e.setVisibilityFlag(re.P.USER_SETTING,r,re.E.GRAPHIC)}},{key:"_whenGraphics3DGraphic",value:function(e){var t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);var i=this._whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=(0,G.dD)();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}},{key:"_boundsForGraphics3DGraphic",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var r,n,s,o,l,h,c,u,d,p;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._viewSpatialReference,n=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,i){return(0,A.CM)(e,n,t,e,r,t,i)},l=function(e,t,i){return(0,A.CM)(e,s,t,e,r,t,i)},h=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:!!(0,S.pC)(i)&&!!i.useViewElevation,minDemResolution:(0,S.pC)(i)?i.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,e.next=8,t.getProjectedBoundingBox(o,l,h,(0,S.U2)(i,"signal"));case 8:if(c=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:return u=c.boundingBox,c.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&((0,Z.be)(u,tt),p=(0,S.Pt)(d.getElevation(tt[0],tt[1],0,r,"ground"),0),u[2]=Math.min(u[2],p),u[5]=Math.max(u[5],p)),e.abrupt("return",{boundingBox:u,screenSpaceObjects:c.screenSpaceObjects});case 14:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"whenGraphicBounds",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var r,n,s,o=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,x.N1)((function(){var e;return null===(e=o.owner)||void 0===e?void 0:e.loadedGraphics}));case 2:if(r=this.owner.layer&&this.owner.layer.objectIdField,n=this.owner.loadedGraphics.find((function(e){return e===t||null!=r&&null!=e.attributes&&t.attributes&&e.attributes[r]===t.attributes[r]})),n){e.next=5;break}throw new g.Z("internal:graphic-not-part-of-view","Graphic is not part of this view");case 5:return e.next=7,this._whenGraphics3DGraphic(n);case 7:return s=e.sent,e.abrupt("return",this._boundsForGraphics3DGraphic(s,i));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"computeAttachmentOrigin",value:function(e,t){var i=this.graphics3DGraphics.get(e.uid);if(!i)return null;var r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;(0,P.s)(lt,0,0,0);var a=0;if(r.render.num>0){if(!(0,A.SH)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,ht,t))return null;(0,P.a)(lt,lt,ht),a++}if(r.draped.num>0){var s=(0,n.Z)(r.draped.origin,2),o=s[0],l=s[1],h=(0,S.Pt)(this._viewElevationProvider.getElevation(o,l,"ground"),0);if((0,P.s)(ht,o,l,h),!(0,A.SH)(ht,this._viewElevationProvider.spatialReference,ht,t))return null;(0,P.a)(lt,lt,ht),a++}return a>1&&(0,P.g)(lt,lt,1/a),new Xe.Z({x:lt[0],y:lt[1],z:lt[2],spatialReference:t})}},{key:"getSymbolLayerSize",value:function(e,t){var i=this._symbols.get(e.id);if((0,S.Wi)(i))throw new g.Z("internal:symbol-not-part-of-view","Symbol is not part of this view");var r=e.symbolLayers.indexOf(t);if(-1===r)throw new g.Z("internal:missing-symbol-layer","Symbol layer is not in symbol");var n=i.getSymbolLayerSize(r);if((0,S.Wi)(n))throw new g.Z("internal:missing-size","Symbol layer has no valid size");return n}},{key:"_graphicsCollectionChanged",value:function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}},{key:"graphicUpdateHandler",value:function(e){var t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(!(0,S.Wi)(i)||!(0,S.Wi)(this._graphicsWithoutSymbol.get(t)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(i,e)}}},{key:"_graphicUpdateGeometryHandler",value:function(e,t){var i=t.graphic.geometry;if((0,S.Wi)(i))this._recreateGraphic(t.graphic);else if((0,S.Wi)(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var n=this._symbols.get(r);if((0,S.pC)(n)&&n.loadStatus===xe.P.LOADING)return}this._recreateGraphic(t.graphic)}else{var a=e.graphics3DSymbol;!(0,S.Wi)(t.newValue)&&a.updateGeometry(e,t.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(i)}}},{key:"_graphicUpdateSymbolHandler",value:function(e,t){var i=t.graphic,r=(0,S.pC)(e)?e.graphics3DSymbol:(0,S.pC)(t.oldValue)?this._symbols.get(t.oldValue.id):null;if((0,S.Wi)(r)||(0,S.Wi)(t.newValue))this._recreateGraphic(i);else{var n=r.symbol,a=this._getConvertedSymbol(t.newValue);if((0,S.pC)(a)&&(a.type!==n.type||"web-style"===a.type)||"web-style"===n.type)this._recreateGraphic(i);else{var s=this._graphicsBySymbol.get(n.id);if(s&&1!==s.size)this._recreateGraphic(i);else{var l=(0,D.Hg)(n,a);if((0,S.Wi)(l))this._updateSymbolMapping(n.id,a);else{var h={diff:l,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(h),(0,D.xb)(h.diff)){var c=this._getRenderingInfo(i);if((0,S.Wi)(c))this._recreateGraphic(i);else{var u,d=r.extentPadding,p=(0,o.Z)(h.symbolStatePatches);try{for(p.s();!(u=p.n()).done;){(0,u.value)()}}catch(f){p.e(f)}finally{p.f()}if(d!==r.extentPadding&&this._recomputeExtentPadding(),(0,S.pC)(e)){var y,v=(0,o.Z)(h.graphics3DGraphicPatches);try{for(v.s();!(y=v.n()).done;){(0,y.value)(e,c)}}catch(f){v.e(f)}finally{v.f()}}this._updateSymbolMapping(n.id,a)}}else this._recreateGraphic(i)}}}}}},{key:"_graphicUpdateVisibleHandler",value:function(e){this._updateUserVisibility(e)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"_graphicUpdateTransformHandler",value:function(e,t){}},{key:"recreateGraphics",value:function(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===qe.j.SYNC&&this._cleanupSymbols()}},{key:"_recreateGraphic",value:function(e){this.recreateGraphics([e])}},{key:"_beginGraphicUpdate",value:function(e){var t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating"),t}},{key:"_endGraphicUpdate",value:function(e){e&&(this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}},{key:"_recomputeExtentPadding",value:function(){var e=0;this._symbols.forEach((function(t){(0,S.pC)(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}},{key:"_expandComputedExtent",value:function(e){var t=it,i=e.spatialReference;(0,j.FS)(e,t);var r=this._viewSpatialReference,n=Le.tmpVec;if((0,U.fS)(i,r)||(0,A.Rg)(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],(0,A.Rg)(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])){var a=this.computedExtent,s=null,o=isFinite(t[2])&&isFinite(t[5]),l=o&&(!a||null==a.zmin||t[2]<a.zmin),h=o&&(!a||null==a.zmax||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||l||h)&&((s=this._propertiesPool.get("computedExtent")).xmin=Math.min(t[0],a.xmin),s.ymin=Math.min(t[1],a.ymin),s.xmax=Math.max(t[3],a.xmax),s.ymax=Math.max(t[4],a.ymax),s.spatialReference=r):((s=this._propertiesPool.get("computedExtent")).xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(l&&(s.zmin=t[2]),h&&(s.zmax=t[5]),this._set("computedExtent",s))}}},{key:"_abortElevationInfoChange",value:function(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}},{key:"elevationInfoChange",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){var t,i,r,n,s=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._abortElevationInfoChange(),r=new AbortController,this._elevationInfoChangeAbortController=r,n=(0,ne.WI)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),e.next=6,(0,ne.kr)(n,this._viewSpatialReference,r.signal,nt);case 6:this.symbolCreationContext.featureExpressionInfoContext=e.sent,(0,G.k_)(r.signal),this._elevationInfoChangeAbortController=null,null!==(t=this._labeler)&&void 0!==t&&t.elevationInfoChange(),this.forEachGraphics3DSymbol((function(e,t,i){e.globalPropertyChanged("elevationInfo",t)?t.forEach((function(e){var t,i=e.graphic,r=e.labelLayers,n=(0,o.Z)(r);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.graphics3DSymbolLayer.updateGraphicElevationContext(i,a)}}catch(s){n.e(s)}finally{n.f()}})):s._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),null===(i=this._elevationAlignment)||void 0===i||i.elevationInfoChange();case 13:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateStageLayerElevationProvider",value:function(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,S.M2)(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new Ze({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}},{key:"_clearSymbolsAndGraphics",value:function(){var e,t,i,r;this.clear(),(0,S.pC)(this._filterVisibility)&&this._filterVisibility.clear(),null!==(e=this._labeler)&&void 0!==e&&e.reset(),null!==(t=this._deconflictor)&&void 0!==t&&t.clear(),null!==(i=this._elevationAlignment)&&void 0!==i&&i.clear(),null!==(r=this.stageLayer)&&void 0!==r&&r.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,S.M2)(this._stageLayerElevationProvider))}},{key:"startCreateGraphics",value:function(){this._startCreateGraphics=!0,this.recreateAllGraphics()}},{key:"recreateAllGraphics",value:function(){this._recreateAllGraphics(!1)}},{key:"recreateAllGraphicsAndSymbols",value:function(){this._recreateAllGraphics(!0)}},{key:"_recreateAllGraphics",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._startCreateGraphics){var t=this.owner,i=t.loadedGraphics,r=t.view,n=r.basemapTerrain.tilingScheme&&i&&i.length?i.toArray():null;!e&&n||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),n&&(e?this.add(n):this.recreateGraphics(n))}}},{key:"_recreateSymbol",value:function(e){var t=this,i=this._graphicsBySymbol.get(e),r=[];i&&(i.forEach((function(e,i){var n,a=e.usedMemory;t._conditionalRemove(e,i),null!==(n=t._spatialIndex)&&void 0!==n&&n.remove(e),r.push(e.graphic),e.destroy(),t._removeGraphics3DGraphic(i,a),t._updateLayerVisibility(),t._featureStore.events.emit("changed")})),this._graphicsBySymbol.set(e,new Map));var n=this._symbols.get(e);(0,S.SC)(n),this._symbols.delete(e),this.add(r)}},{key:"_recreateGraphicsForSymbol",value:function(e){var t=this._graphicsBySymbol.get(e);if(t){var i=[];t.forEach((function(e){return i.push(e.graphic)})),this.recreateGraphics(i)}}},{key:"_conditionalRemove",value:function(e,t){var i,r,n;this._graphicsDrapedUids.delete(t),null!==(i=this._objectStates)&&void 0!==i&&i.removeGraphic(e),null!==(r=this._labeler)&&void 0!==r&&r.removeGraphic(e),null!==(n=this._deconflictor)&&void 0!==n&&n.removeGraphic(e),(0,S.pC)(this._graphicStateTracking)&&this._graphicStateTracking.removeGraphic(e)}},{key:"add",value:function(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===qe.j.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):nt.error("#add()","Cannot add graphics before terrain surface has been initialized"))}},{key:"_updatePolicyForGraphics",value:function(e){if(this.effectiveUpdatePolicy===qe.j.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType)){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;if((0,S.pC)(r.geometry)&&"mesh"===r.geometry.type&&!r.geometry.loaded)return qe.j.ASYNC}}catch(n){i.e(n)}finally{i.f()}}return this.effectiveUpdatePolicy}},{key:"_addImmediate",value:function(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._addGraphic(r,this._getRenderingInfo(r,nt),qe.j.SYNC)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}},{key:"_addDelayed",value:function(e){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r,n=t.value,a=n.uid,s=this._pendingUpdates.get(a);s?s.add?s.state!==Ue.NEW&&(null===(r=s.abortController)||void 0===r||r.abort()):this._pendingAdds++:(s=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(a,s)),s.add=n}}catch(l){i.e(l)}finally{i.f()}this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"remove",value:function(e){this.effectiveUpdatePolicy===qe.j.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")}},{key:"_removeImmediate",value:function(e){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._removeGraphic(r)}}catch(n){i.e(n)}finally{i.f()}this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_removeDelayed",value:function(e){var t,i=(0,o.Z)(e);try{for(i.s();!(t=i.n()).done;){var r,n=t.value,a=n.uid,s=this._pendingUpdates.get(a);if(s)s.add&&(s.remove?s.add=null:this._pendingUpdates.delete(a),s.state===Ue.LOADING&&null!==(r=s.abortController)&&void 0!==r&&r.abort(),this._pendingAdds--);else{var l=this._pendingUpdatesPool.pushNew();l.remove=n,this._pendingUpdates.set(a,l),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}}catch(h){i.e(h)}finally{i.f()}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}},{key:"_finishPendingUpdates",value:function(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&nt.warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}},{key:"_applyPendingUpdates",value:function(e){var t;if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&null!==(t=this._spatialIndex)&&void 0!==t&&t.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;var i,r=(0,o.Z)(this._pendingUpdates);try{for(r.s();!(i=r.n()).done;){var a=(0,n.Z)(i.value,2),s=a[0],l=a[1];if(e.done){this._applyPendingRemovesFirst=!0;break}if(l.remove&&!l.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(l.remove),l.remove=null,this._pendingUpdates.delete(s),0===this._pendingRemoves))break}}catch(v){r.e(v)}finally{r.f()}}var h,c=(0,o.Z)(this._pendingUpdates);try{for(c.s();!(h=c.n()).done;){var u=(0,n.Z)(h.value,2),d=u[0],p=u[1];if(e.done)break;p.add&&p.state===Ue.NEW&&this._processPendingUpdateNew(p);var y=this.effectiveUpdatePolicy;if(!p.remove||p.add&&p.state!==Ue.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(p.remove),p.remove=null,y=qe.j.SYNC),p.add)switch(p.state){case Ue.READY:this._addGraphic(p.add,p.renderingInfo,y),p.add=null,this._pendingAdds--,e.madeProgress();break;case Ue.REJECTED:p.add=null,this._pendingAdds--;case Ue.LOADING:}null==p.remove&&null==p.add&&this._pendingUpdates.delete(d)}}catch(v){c.e(v)}finally{c.f()}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}},{key:"_processPendingUpdateNew",value:function(e){if(e.add){var t=e.add.geometry;(0,S.pC)(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e)}else e.state=Ue.READY}},{key:"_processPendingUpdateNewMesh",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t,i){var r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.state=Ue.LOADING,t.abortController=new AbortController,r=t.abortController.signal,e.prev=2,e.next=5,i.load({signal:r});case 5:e.next=10;break;case 7:return e.prev=7,e.t0=e.catch(2),e.abrupt("return",this._processPendingUpdateNewError(t,e.t0));case 10:t.abortController=null,this._processPendingUpdateNewRenderingInfo(t);case 11:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_processPendingUpdateNewError",value:function(e,t){e.abortController=null,(0,G.D_)(t)?e.state=Ue.NEW:e.state=Ue.REJECTED}},{key:"_processPendingUpdateNewRenderingInfo",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,S.Wi)(this.layer.renderer)&&"dictionary"===this.layer.renderer.type){e.next=2;break}return e.abrupt("return",(t.renderingInfo=this._getRenderingInfo(t.add,nt),void(t.state=Ue.READY)));case 2:return t.state=Ue.LOADING,t.abortController=new AbortController,i=null,e.prev=4,e.next=7,this._getRenderingInfoAsync(t.add,{signal:t.abortController.signal});case 7:i=e.sent,e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(4),e.abrupt("return",(t.abortController=null,void((0,G.D_)(e.t0)?t.state=Ue.NEW:t.state=Ue.REJECTED)));case 13:(0,S.Wi)(i)||(0,S.Wi)(i.symbol)?(nt&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,nt.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),t.renderingInfo=null):t.renderingInfo=i,t.state=Ue.READY;case 14:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"_addGraphic",value:function(e,t,i){var r=this;if(this._graphicsWithoutSymbol.set(e.uid,e),!(0,S.Wi)(t)&&!(0,S.Wi)(t.symbol)&&(0,j.S6)(e)){(0,S.pC)(this.stage.renderView.objectAndLayerIdRenderHelper)&&this.setUidToIdOnAdd&&this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled);var n=t.symbol,a=this.getOrCreateGraphics3DSymbol(n,t.renderer);if(!(0,S.Wi)(a)){this._expandComputedExtent(e.geometry);var s=this._beginGraphicUpdate(e),o=new de.Z(e,t,this.layer),l=!1,h=function(e){e===a.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(h);var c=function(){if(--r._loadingSymbols,!r.destroyed){if(r._whenSymbolRemoved.removeUnordered(h),r._graphicsWaitingForSymbol.get(e.uid)!==s||l||a.destroyed||r.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,r._cleanupSymbols();else{var t=r._createGraphics3DGraphic(a,o);r._spatialIndex&&(0,S.pC)(t)&&r._spatialIndex.add(t),--a.referenced,r._endGraphicUpdate(e)}r._featureStore.events.emit("changed"),r._labeler&&r.owner.view.labeler.setDirty()}},u=function(t){--r._loadingSymbols,r.destroyed||(r._whenSymbolRemoved.removeUnordered(h),l||((0,G.D_)(t)?r.add([e]):a.destroyed||r._endGraphicUpdate(e)))};++this._loadingSymbols,i===qe.j.ASYNC?a.load((function(){return r._frameTask.schedule(c)}),(function(e){return r._frameTask.schedule((function(){return u(e)}))})):a.load(c,u)}}}},{key:"_removeGraphic",value:function(e){var t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r,n;i.graphics3DSymbol.onRemoveGraphic(i);var a=i.usedMemory,s=i.isElevationSource;this._conditionalRemove(i,t),null===(r=this._spatialIndex)||void 0===r||r.remove(i);var o=i.graphics3DSymbol.symbol.id;null!==(n=this._graphicsBySymbol.get(o))&&void 0!==n&&n.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,a,s),i.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}},{key:"_hasLabelingContext",value:function(e){if(e instanceof Ke.Z||e instanceof $e.Z){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((function(t){return t.symbol===e}))}return!1}},{key:"_hasValidSymbolCreationContext",value:function(e){return!(e instanceof Ke.Z&&!this._hasLabelingContext(e))||(nt.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}},{key:"_getRenderingInfo",value:function(e,t){var i=e.geometry;if((0,S.Wi)(i))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!(0,A.Up)(i.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has incompatible spatial reference and will not render"))),null;if(!this.graphicSymbolSupported&&(0,S.pC)(e.symbol))return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r,n=this.rendererHasGeometryOperations?(0,F.mW)(e,this.layer):e;return r=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||(0,S.pC)(this.currentRenderer))?this.owner.getRenderingInfo(n,this.currentRenderer,this._arcadeOnDemand):{symbol:n.symbol||ee(n.geometry)},(0,S.Wi)(r)||(0,S.Wi)(r.symbol)?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),null):r}},{key:"_getRenderingInfoAsync",value:function(e,t){var i=e.geometry;if((0,S.Wi)(i))return nt&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,nt.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!this.graphicSymbolSupported&&(0,S.pC)(e.symbol))return nt&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,nt.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;var r=this.rendererHasGeometryOperations?(0,F.mW)(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,this.currentRenderer,this._arcadeOnDemand,t)}},{key:"_createGraphics3DSymbol",value:function(e,t){var i=this;if(!this._hasValidSymbolCreationContext(e))return null;var r,n=this._getConvertedSymbol(e);if(!n)return null;if((0,S.pC)(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var a=(0,te.q)(t.backgroundFillSymbol,{ignoreDrivers:!0});(0,S.pC)(a.symbol)&&"web-style"!==a.symbol.type&&"cim"!==a.symbol.type&&(r=a.symbol.symbolLayers)}var s=function(e,t,i){return"point-3d"===e.type?new me(e,t,i):new be.Z(e,t,i)}(n,this.symbolCreationContext,r);return s.load((function(){var e=s.extentPadding;e>i.extentPadding&&i._set("extentPadding",e),i.notifyChange("averageSymbolComplexity")}),(function(){})),s}},{key:"getOrCreateGraphics3DSymbol",value:function(e,t){var i=this,r=this._symbols.get(e.id);return void 0===r&&(r=e instanceof et.Z?new Ce.Z(e,(function(e){return i._frameTask.schedule(e)}),(function(e){return i._createGraphics3DSymbol(e,t)})):this._createGraphics3DSymbol(e,t),this._symbols.set(e.id,r)),(0,S.pC)(r)&&++r.referenced,r}},{key:"trackGraphicState",value:function(e){return(0,S.Wi)(this._graphicStateTracking)&&(this._graphicStateTracking=new Se(this)),this._graphicStateTracking.add(e)}},{key:"_addGraphics3DGraphic",value:function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_removeGraphics3DGraphic",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,i&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}},{key:"_createGraphics3DGraphic",value:function(e,t){var i,r,n,a=t.graphic;if(this._graphicsWithoutSymbol.delete(a.uid),!this._symbols.has(e.symbol.id))return this.add([a]),null;if(this.graphics3DGraphics.has(a.uid))return null;var s=e.createGraphics3DGraphic(t);if((0,S.Wi)(s))return null;this._addGraphics3DGraphic(s);var o=e.symbol.id;if(this._graphicsBySymbol.has(o)||this._graphicsBySymbol.set(o,new Map),this._graphicsBySymbol.get(o).set(a.uid,s),s.isDraped&&this._graphicsDrapedUids.add(a.uid),s.centroid=null,(0,S.pC)(a.geometry)&&"point"!==a.geometry.type&&(s.centroid=(0,we.zE)(a.geometry,this._viewSpatialReference)),this._updateUserVisibility(s),(0,S.pC)(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(s),(0,S.pC)(this._filterVisibility)){var l=this._filterVisibility.defaultVisibility;s.setVisibilityFlag(re.P.FILTER,l,re.E.GRAPHIC),l||this._filterVisibility.reapply()}null!==(i=this._deconflictor)&&void 0!==i&&i.addGraphic(s),null!==(r=this._labeler)&&void 0!==r&&r.addGraphic(s),null!==(n=this._objectStates)&&void 0!==n&&n.addGraphic(s),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,s),s.initialize(this.stage,this.stageLayer,this.owner),(0,S.pC)(this._graphicStateTracking)&&this._graphicStateTracking.addGraphic(s);var h=this._whenGraphics3DGraphicRequests[a.uid];return h&&(delete this._whenGraphics3DGraphicRequests[a.uid],h.resolve(s)),s}},{key:"_abortRendererChange",value:function(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}},{key:"rendererChange",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(t){var i,r,n,s,o,l=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._abortRendererChange(),t===this.currentRenderer){e.next=37;break}if(this._validateRenderer(t),(0,S.Wi)(t)&&this._currentRendererChange(null,!1),!(0,T.e)(t)){e.next=36;break}if(!(0,S.pC)(t)||!t.arcadeRequired){e.next=25;break}return i=new AbortController,this._rendererChangeAbortController=i,e.next=7,this._ensureArcade();case 7:if(r=e.sent,n=r.arcadeUtils,(0,G.k_)(i),s=n.hasGeometryOperations(t),e.t0=s,!e.t0){e.next=16;break}return e.next=15,n.enableGeometryOperations();case 15:(0,G.k_)(i);case 16:if(this.effectiveUpdatePolicy!==qe.j.ASYNC){e.next=21;break}return e.next=19,this._frameTask.schedule((function(){return l._currentRendererChange(t,s)}),i.signal);case 19:e.next=22;break;case 21:this._currentRendererChange(t,s);case 22:this._rendererChangeAbortController=null,e.next=34;break;case 25:if(this.effectiveUpdatePolicy!==qe.j.ASYNC){e.next=33;break}return o=new AbortController,this._rendererChangeAbortController=o,e.next=30,this._frameTask.schedule((function(){return l._currentRendererChange(t,!1)}),o.signal);case 30:this._rendererChangeAbortController=null,e.next=34;break;case 33:this._currentRendererChange(t,!1);case 34:e.next=37;break;case 36:this._currentRendererChange(t,!1);case 37:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_ensureArcade",value:function(){var e=(0,s.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(0,S.Wi)(this._arcadeOnDemand)){e.next=7;break}return e.next=3,(0,W.LC)();case 3:this._arcadeOnDemand=e.sent,e.t0=this._arcadeOnDemand,e.next=8;break;case 7:e.t0=this._arcadeOnDemand;case 8:return e.abrupt("return",e.t0);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_currentRendererChange",value:function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=(0,S.Wg)(this._arcadeOnDemand);var i=this.symbolCreationContext.renderer;if(e!==i){if(this._symbolConversionCache.clear(),(0,S.Wi)(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();var r=(0,D.Hg)(i,e);this._updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,(0,S.Wi)(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,i)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}}},{key:"_diffHasSymbolChange",value:function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}},{key:"_applySymbolSetDiff",value:function(e,t,i){var r=this;e=e||[],t=t||[];var n,a=[],s=(0,o.Z)(t);try{var l=function(){var t=n.value,s=r._graphicsBySymbol.get(t.id);s&&s.forEach((function(n,o){var l=n.graphic,h=r.layer instanceof V.Z?r.layer:null,c=(0,S.Wg)(r._arcadeOnDemand);if(t!==i.defaultSymbol||i.getSymbol((0,F.mW)(l,h),{arcade:c})!==i.defaultSymbol){var u=n.usedMemory;e.length||i.defaultSymbol?a.push(l):r._graphicsWithoutSymbol.set(o,l);var d=r.graphics3DGraphics.get(o);r._conditionalRemove(d,o),n.destroy(),s.delete(o),r._removeGraphics3DGraphic(o,u),r._updateLayerVisibility()}})),r._whenSymbolRemoved.forAll((function(e){return e(t.id)}))};for(s.s();!(n=s.n()).done;)l()}catch(h){s.e(h)}finally{s.f()}(e.length||a.length)&&(this._graphicsWithoutSymbol.forEach((function(e){return a.push(e)})),this._graphicsWithoutSymbol.clear(),this.add(a)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}},{key:"_applyUniqueValueRendererDiff",value:function(e,t,i){var r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){var a=n?n.added.map((function(e){return e.symbol})).filter(S.pC):[],s=n?n.removed.map((function(e){return e.symbol})).filter(S.pC):[];if(n)for(var o=0;o<n.changed.length;o++)a.push(n.changed[o].newValue.symbol),s.push(n.changed[o].oldValue.symbol);return r?(i.defaultSymbol&&s.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&s.push(t.defaultSymbol),this._applySymbolSetDiff(a,s,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}},{key:"_calculateUnchangedSymbolMapping",value:function(e,t,i){if("unique-value"!==(null===t||void 0===t?void 0:t.type)||"unique-value"!==(null===i||void 0===i?void 0:i.type)||(0,S.pC)(e)&&"partial"!==e.type)return[];var r,n=function(e){return(0,S.pC)(e)?e.id:null},a=e&&e.diff,s=a&&a.defaultSymbol,l=a&&a.uniqueValueInfos;if(l)r=l.unchanged.map((function(e){return{oldId:n(e.oldValue.symbol),newId:n(e.newValue.symbol)}}));else{var h;r=[];var c,u=(0,o.Z)(null!==(h=i.uniqueValueInfos)&&void 0!==h?h:[]);try{var d=function(){var e,i=c.value,a=n(i.symbol),s=null===(e=t.uniqueValueInfos)||void 0===e?void 0:e.find((function(e){return e.value===i.value}));s&&a!==n(s.symbol)&&r.push({oldId:a,newId:n(s.symbol)})};for(u.s();!(c=u.n()).done;)d()}catch(p){u.e(p)}finally{u.f()}}return!s&&i.defaultSymbol&&r.push({oldId:n(i.defaultSymbol),newId:n(t.defaultSymbol)}),r}},{key:"_updateSymbolMapping",value:function(e,t){var i=(0,S.pC)(t)&&t?"string"==typeof t?t:t.id:null;if(!(0,S.Wi)(e)&&e!==i){var r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==r&&this._graphicsBySymbol.set(i,r);var n=this._symbols.get(e);if(void 0!==n&&(this._symbols.delete(e),this._symbols.set(i,n),(0,S.pC)(n))){var a="string"==typeof t?null:t;(0,S.pC)(a)?n.symbol=a:n.symbol.id=i}}}},{key:"_updateUnchangedSymbolMappings",value:function(e,t,i){var r,n=this._calculateUnchangedSymbolMapping(e,t,i),a=(0,o.Z)(n);try{for(a.s();!(r=a.n()).done;){var s=r.value,l=s.oldId,h=s.newId;this._updateSymbolMapping(l,h)}}catch(c){a.e(c)}finally{a.f()}}},{key:"_applyRendererDiff",value:function(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof y.Z&&i instanceof y.Z&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;var r,a=(0,o.Z)(this._graphicsBySymbol);try{for(a.s();!(r=a.n()).done;){var s=(0,n.Z)(r.value,1)[0],l=this._symbols.get(s);if((0,S.pC)(l))switch(l.applyRendererDiff(e,t)){case Ge.W.Recreate_Symbol:this._recreateSymbol(s);break;case Ge.W.Recreate_Graphics:this._recreateGraphicsForSymbol(s);case Ge.W.Fast_Update:}}}catch(h){a.e(h)}finally{a.f()}return!0}},{key:"opacityChange",value:function(){this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("opacity",t)})),this._updateStageLayerVisibility()}},{key:"_slicePlaneEnabledChange",value:function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol((function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)})),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())}},{key:"_physicalBasedRenderingChange",value:function(e){var t=this;this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((function(e,i,r){e.globalPropertyChanged("physicalBasedRenderingEnabled",i)||t._recreateSymbol(r)}))}},{key:"_skipHighSymbolLoDsChange",value:function(e){var t=this;this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol((function(e,i,r){e.globalPropertyChanged("skipHighSymbolLods",i)||t._recreateSymbol(r)}))}},{key:"_pixelRatioChange",value:function(){var e=this;this.forEachGraphics3DSymbol((function(t,i,r){t.globalPropertyChanged("pixelRatio",i)||e._recreateSymbol(r)}))}},{key:"_signalUpdatingDuringAsyncLoadedGraphicsChange",value:function(){var e=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,k.Os)((function(){e._updatingPendingLoadedGraphicsChange=null}))}},{key:"setClippingExtent",value:function(e,t){var i=this.symbolCreationContext.clippingExtent,r=(0,L.Ue)();return(0,Be.G)(e,r,t)?this.symbolCreationContext.clippingExtent=(0,Z.JR)((0,Z.Ue)(),r):this.symbolCreationContext.clippingExtent=null,!(0,Z.fS)(this.symbolCreationContext.clippingExtent,i)}},{key:"modifyGraphics3DGraphicVisibilities",value:function(e){var t,i=!1;this.graphics3DGraphics.forEach((function(t){e(t)&&(i=!0)})),i&&(null!==(t=this.owner.view.labeler)&&void 0!==t&&t.setDirty(),this.owner.view.deconflictor.setDirty())}},{key:"forEachGraphics3DSymbol",value:function(e){var t,i=(0,o.Z)(this._symbols);try{for(i.s();!(t=i.n()).done;){var r=(0,n.Z)(t.value,2),a=r[0],s=r[1];if((0,S.Wi)(s))return;e(s,this._graphicsBySymbol.get(a)||ct,a)}}catch(l){i.e(l)}finally{i.f()}}},{key:"updateAllGraphicsVisibility",value:function(){var e=this;(0,S.pC)(this._filterVisibility)&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((function(t){var i=e._updateUserVisibility(t),r=(0,S.pC)(e._scaleVisibility)&&e._scaleVisibility.updateVisibility(t);return i||r}))}},{key:"_hideAllGraphics",value:function(){this.modifyGraphics3DGraphicVisibilities((function(e){return e.setVisibilityFlag(re.P.USER_SETTING,!1,re.E.GRAPHIC)}))}},{key:"_validateRenderer",value:function(e){var t,i=(0,T.s)(e,{geometryType:null===(t=this.layer)||void 0===t?void 0:t.geometryType});if(i){var r="Renderer for layer '".concat(this.layer.title?"".concat(this.layer.title,", "):"",", id:").concat(this.layer.id,"' is not supported in a SceneView");nt.warn(r,i.message)}}},{key:"_volatileGraphicsUpdated",value:function(){var e;null!==(e=this._labeler)&&void 0!==e&&e.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}},{key:"_cleanupSymbols",value:function(){var e=this;if(!(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)){var t=!1;this._symbols.forEach((function(i,r){if(!((0,S.Wi)(i)||i.referenced>0)){var n=e._graphicsBySymbol.get(r);n&&0!==n.size||(e._graphicsBySymbol.delete(r),e._symbols.delete(r),(0,S.SC)(i),t=!0)}})),t&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}}},{key:"test",get:function(){var e=this;return{snapshotInternals:function(){return{graphics:(0,r.Z)(e.graphics3DGraphics.keys()).sort(),symbols:(0,r.Z)(e._symbols.keys()).sort(),graphicsBySymbol:(0,r.Z)(e._graphicsBySymbol.keys()).sort().map((function(t){return{symbolId:t,graphics:(0,r.Z)(e._graphicsBySymbol.get(t).keys()).sort()}})),graphicsWithoutSymbol:(0,r.Z)(e._graphicsWithoutSymbol.keys()).sort(),graphicsDrapedUids:(0,r.Z)(e._graphicsDrapedUids).sort(),pendingUpdates:e._pendingUpdates}},symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:function(t){e._forcedUpdatePolicy=t}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,pending:this._pendingUpdates.size}}}]),i}(v.Z);at.tmpVec=(0,O.c)(),(0,p._)([(0,I.Cb)({readOnly:!0})],at.prototype,"computedExtent",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"currentRenderer",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"rendererHasGeometryOperations",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_frameTask",void 0),(0,p._)([(0,I.Cb)({readOnly:!0})],at.prototype,"_viewSpatialReference",null),(0,p._)([(0,I.Cb)()],at.prototype,"_rendererChangeAbortController",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_elevationInfoChangeAbortController",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_initializeAbortController",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_elevationAlignment",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_scaleVisibility",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_filterVisibility",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_initializePromise",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_spatialIndex",void 0),(0,p._)([(0,I.Cb)({readOnly:!0})],at.prototype,"extentPadding",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_featureStore",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_deconflictor",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_labeler",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_objectStates",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_loadingSymbols",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"preferredUpdatePolicy",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_forcedUpdatePolicy",void 0),(0,p._)([(0,I.Cb)({readOnly:!0})],at.prototype,"effectiveUpdatePolicy",null),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"elevationFeatureExpressionEnabled",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"owner",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"layer",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"graphicSymbolSupported",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"componentFactories",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"setUidToIdOnAdd",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"featureStore",null),(0,p._)([(0,I.Cb)()],at.prototype,"initializePromise",null),(0,p._)([(0,I.Cb)()],at.prototype,"scaleVisibility",null),(0,p._)([(0,I.Cb)()],at.prototype,"elevationAlignment",null),(0,p._)([(0,I.Cb)()],at.prototype,"objectStates",null),(0,p._)([(0,I.Cb)()],at.prototype,"filterVisibility",null),(0,p._)([(0,I.Cb)({readOnly:!0})],at.prototype,"updating",null),(0,p._)([(0,I.Cb)({readOnly:!0})],at.prototype,"running",null),(0,p._)([(0,I.Cb)({readOnly:!0})],at.prototype,"suspendedOrOutsideOfView",null),(0,p._)([(0,I.Cb)({readOnly:!0,dependsOn:[]})],at.prototype,"updatingRemaining",null),(0,p._)([(0,I.Cb)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],at.prototype,"displayFeatureLimit",null),(0,p._)([(0,I.Cb)({readOnly:!0,dependsOn:[]})],at.prototype,"averageSymbolComplexity",null),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"hasZ",void 0),(0,p._)([(0,I.Cb)({constructOnly:!0})],at.prototype,"hasM",void 0),(0,p._)([(0,I.Cb)()],at.prototype,"_objectIdField",null),at=Le=(0,p._)([(0,R.j)(rt)],at),(Ve=Ue||(Ue={}))[Ve.NEW=0]="NEW",Ve[Ve.LOADING=1]="LOADING",Ve[Ve.READY=2]="READY",Ve[Ve.REJECTED=3]="REJECTED";var st=function(){function e(){(0,l.Z)(this,e),this.add=null,this.renderingInfo=null,this.state=Ue.NEW,this.abortController=null,this.remove=null}return(0,h.Z)(e,[{key:"clear",value:function(){this.add=null,this.renderingInfo=null,this.state=Ue.NEW,this.abortController=null,this.remove=null}}]),e}(),ot=10,lt=(0,O.c)(),ht=(0,O.c)(),ct=new Map},57848:function(e,t,i){i.d(t,{Z:function(){return m}});var r=i(37762),n=i(15671),a=i(43144),s=i(60136),o=i(92572),l=i(27366),h=i(31319),c=i(91505),u=i(100),d=i(92026),p=i(94172),y=i(49861),v=(i(25243),i(63780),i(69912)),f=i(52404),g=i(78485),_=i(93463),b=function(e){(0,s.Z)(i,e);var t=(0,o.Z)(i);function i(e){var r;return(0,n.Z)(this,i),(r=t.call(this,e))._dirtyExtents=new f.D,r._globalDirty=!1,r._averageExtentUpdateSize=0,r._dirtyGraphicsSet=new Set,r._handles=new u.Z,r._updateElevation=!1,r.graphicsCoreOwner=null,r.graphicsCore=null,r.events=new c.Z,r}return(0,a.Z)(i,[{key:"initialize",value:function(){var e=this,t=this.elevationProvider,i=this.graphicsCoreOwner.view.resourceController.scheduler;this._handles.add([t.on("elevation-change",(function(t){return e._elevationChanged(t)})),(0,p.YP)((function(){return e.graphicsCoreOwner.suspended}),(function(){return e._suspendedChange()})),i.registerTask(_.T8.ELEVATION_ALIGNMENT,this)])}},{key:"destroy",value:function(){this._dirtyGraphicsSet.clear(),this._handles=(0,d.SC)(this._handles),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}},{key:"clear",value:function(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}},{key:"_suspendedChange",value:function(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}},{key:"elevationInfoChange",value:function(){this._globalDirty=!0,this.notifyChange("updating")}},{key:"updating",get:function(){return this.running}},{key:"running",get:function(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}},{key:"updatingRemaining",get:function(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}},{key:"runTask",value:function(e){var t=this;for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run((function(){return t._dirtyExtents.merge(e)}));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange("updating")}},{key:"_updateDirtyGraphics",value:function(e){var t,i=this.graphicsCoreOwner.view.renderCoordsHelper,n=this.graphicsCore.effectiveUpdatePolicy===g.j.ASYNC,a=(0,r.Z)(this._dirtyGraphicsSet.keys());try{for(a.s();!(t=a.n()).done;){var s=t.value,o=this.graphicsCore.getGraphics3DGraphicById(s);if(this._dirtyGraphicsSet.delete(s),(0,d.pC)(o)&&(o.alignWithElevation(this.elevationProvider,i,n),this.graphicsCoreOwner.view.deconflictor.setDirty(),e.madeProgress()),e.done)return}}catch(l){a.e(l)}finally{a.f()}}},{key:"_updateDirtyExtents",value:function(e){for(var t=this;!this._dirtyExtents.empty&&!e.done;){var i=this._dirtyExtents.pop(),r=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:i,spatialReference:r});var n=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(i,r,(function(e){var i=t.graphicsCore.getGraphics3DGraphicById(e);(0,d.pC)(i)&&i.needsElevationUpdates()&&t._dirtyGraphicsSet.add(e)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-n)+.9*this._averageExtentUpdateSize,e.madeProgress()}}},{key:"_markAllGraphicsElevationDirty",value:function(){var e=this;this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((function(t,i){return e._dirtyGraphicsSet.add(i)}))}},{key:"_elevationChanged",value:function(e){if("scene"!==e.context||this.graphicsCore.layer.elevationInfo&&"relative-to-scene"===this.graphicsCore.layer.elevationInfo.mode){var t=e.extent,i=e.spatialReference;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){var r=this.graphicsCore.computedExtent;r&&t[2]>r.xmin&&t[0]<r.xmax&&t[3]>r.ymin&&t[1]<r.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}}}]),i}(h.Z);(0,l._)([(0,y.Cb)()],b.prototype,"graphicsCoreOwner",void 0),(0,l._)([(0,y.Cb)()],b.prototype,"graphicsCore",void 0),(0,l._)([(0,y.Cb)()],b.prototype,"queryGraphicUIDsInExtent",void 0),(0,l._)([(0,y.Cb)()],b.prototype,"elevationProvider",void 0),(0,l._)([(0,y.Cb)({readOnly:!0})],b.prototype,"updating",null),(0,l._)([(0,y.Cb)({readOnly:!0})],b.prototype,"updatingRemaining",null);var m=b=(0,l._)([(0,v.j)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],b)},84328:function(e,t,i){i.d(t,{Z:function(){return _}});var r=i(15671),n=i(43144),a=i(60136),s=i(92572),o=i(27366),l=i(31319),h=i(100),c=i(92026),u=i(94172),d=i(49861),p=(i(25243),i(63780),i(69912)),y=i(83448),v=i(57557),f=i(93463),g=function(e){(0,a.Z)(i,e);var t=(0,s.Z)(i);function i(e){var n;return(0,r.Z)(this,i),(n=t.call(this,e)).suspended=!1,n._extent=null,n._extentIntersectionDirty=!0,n._isVisibleBelowSurfaceInternal=!1,n._handles=new h.Z,n.graphicsCoreOwner=null,n.updating=!0,n}return(0,n.Z)(i,[{key:"initialize",value:function(){var e=this,t=this.graphicsCoreOwner;this._extentIntersection=new v.q({renderCoordsHelper:t.view.renderCoordsHelper});var i=t.view,r=i.basemapTerrain,n=i.resourceController.scheduler;this._handles.add([i.on("resize",(function(){return e._viewChange()})),(0,u.YP)((function(){return i.state.camera}),(function(){return e._viewChange()}),u.Z_),n.registerTask(f.T8.FRUSTUM_VISIBILITY,this),(0,u.YP)((function(){return r.visibleElevationBounds}),(function(){return e._elevationBoundsChange()}))]),"local"===i.viewingMode?this._isVisibleBelowSurface=!0:this._handles.add([(0,u.YP)((function(){var e,t,n;return[r.baseOpacity,r.wireframe,null===(e=i.map)||void 0===e||null===(t=e.ground)||void 0===t||null===(n=t.navigationConstraint)||void 0===n?void 0:n.type]}),(function(){return e._updateIsVisibleBelowSurface()}),u.nn)])}},{key:"destroy",value:function(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null,this._handles=(0,c.SC)(this._handles)}},{key:"_setDirty",value:function(){this.updating||this._set("updating",!0)}},{key:"setExtent",value:function(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}},{key:"_viewChange",value:function(){this._setDirty()}},{key:"_elevationBoundsChange",value:function(){this._setDirty(),this._extentIntersectionDirty=!0}},{key:"_isVisibleBelowSurface",set:function(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}},{key:"_updateIsVisibleBelowSurface",value:function(){var e,t,i=this.graphicsCoreOwner.view,r=i.basemapTerrain,n="local"===i.viewingMode,a="none"===(null===(e=i.map.ground)||void 0===e||null===(t=e.navigationConstraint)||void 0===t?void 0:t.type);this._isVisibleBelowSurface=n||!r.opaque||a}},{key:"_updateExtentIntersection",value:function(){if(this._extentIntersectionDirty){this._extentIntersectionDirty=!1;var e,t=this.graphicsCoreOwner.view;if(this._isVisibleBelowSurfaceInternal)e=-.3*(0,y.Iu)(t.spatialReference).radius;else{var i=t.basemapTerrain.visibleElevationBounds,r=i.min,n=i.max;e=r-Math.max(1,(n-r)*(1.2-1))}this._extentIntersection.update(this._extent,t.spatialReference,e)}}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),f.iQ.YIELD;this._updateExtentIntersection();var t=this.graphicsCoreOwner.view.frustum,i=(0,y.Iu)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,i)),e.madeProgress()}}]),i}(l.Z);(0,o._)([(0,d.Cb)({readOnly:!0})],g.prototype,"suspended",void 0),(0,o._)([(0,d.Cb)({constructOnly:!0})],g.prototype,"graphicsCoreOwner",void 0),(0,o._)([(0,d.Cb)({readOnly:!0})],g.prototype,"updating",void 0);var _=g=(0,o._)([(0,p.j)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],g)},46568:function(e,t,i){i.d(t,{d:function(){return c}});var r,n=i(15671),a=i(43144),s=i(42537),o=i(68401);!function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT"}(r||(r={}));var l=function(){function e(){(0,n.Z)(this,e),this._items=[]}return(0,a.Z)(e,[{key:"addObject",value:function(e,t){this._items.push({type:r.Object,objectStateId:t,object:e})}},{key:"addRenderGeometry",value:function(e,t,i){this._items.push({type:r.RenderGeometry,objectStateId:t,renderGeometry:e,owner:i})}},{key:"addExternal",value:function(e,t){this._items.push({type:r.External,objectStateId:t,remove:e})}},{key:"remove",value:function(e){for(var t=this._items.length-1;t>=0;--t){var i=this._items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}},{key:"removeObject",value:function(e){for(var t=this._items.length-1;t>=0;--t){var i=this._items[t];i.type===r.Object&&i.object===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}},{key:"removeRenderGeometry",value:function(e){for(var t=this._items.length-1;t>=0;--t){var i=this._items[t];i.type===r.RenderGeometry&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this._items.splice(t,1))}}},{key:"removeAll",value:function(){var e=this;this._items.forEach((function(t){e._removeObjectStateItem(t)})),this._items=[]}},{key:"_removeObjectStateItem",value:function(e){switch(e.type){case r.Object:e.objectStateId.channel===o.V_.Highlight?e.object.removeHighlight(e.objectStateId):e.objectStateId.channel===o.V_.MaskOccludee&&e.object.removeOcclude(e.objectStateId);break;case r.RenderGeometry:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case r.External:e.remove(e.objectStateId)}}}]),e}(),h=function(){function e(t,i){(0,n.Z)(this,e),this.stateType=t,this.objectIdField=i,this.objectStateSet=new l,this.ids=new Set,this.paused=!1}return(0,a.Z)(e,[{key:"hasGraphic",value:function(e){if(this.objectIdField){var t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}]),e}(),c=function(){function e(t){(0,n.Z)(this,e),this._graphicsCore=t,this._stateSets=new Array}return(0,a.Z)(e,[{key:"destroy",value:function(){this.reset(),this._stateSets=null}},{key:"reset",value:function(){this._stateSets&&(this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()})),this._stateSets.length=0)}},{key:"acquireSet",value:function(e,t){var i=this,r=new h(e,t);this._stateSets.push(r);var n=(0,s.kB)((function(){return i.releaseSet(r)}));return{set:r,handle:n}}},{key:"releaseSet",value:function(e){e.objectStateSet.removeAll();var t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}},{key:"_addObjectStateSet",value:function(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}},{key:"_removeObjectStateSet",value:function(e,t){e.removeObjectState(t.objectStateSet)}},{key:"setUid",value:function(e,t){e.ids.add(t);var i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}},{key:"setUids",value:function(e,t){var i=this;t.forEach((function(t){return i.setUid(e,t)}))}},{key:"setObjectIds",value:function(e,t){t.forEach((function(t){return e.ids.add(t)})),this._initializeSet(e)}},{key:"addGraphic",value:function(e){var t=this;this._stateSets.forEach((function(i){!i.paused&&i.hasGraphic(e)&&t._addObjectStateSet(e,i)}))}},{key:"removeGraphic",value:function(e){var t=this;this._stateSets.forEach((function(i){i.hasGraphic(e)&&t._removeObjectStateSet(e,i)}))}},{key:"allGraphicsDeleted",value:function(){this._stateSets&&this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()}))}},{key:"_initializeSet",value:function(e){var t=this,i=this._graphicsCore.graphics3DGraphics;e.objectIdField?i.forEach((function(i){i&&e.hasGraphic(i)&&t._addObjectStateSet(i,e)})):e.ids.forEach((function(r){var n=i.get(r);n&&t._addObjectStateSet(n,e)}))}},{key:"test",get:function(){return{states:this._stateSets}}}]),e}()},59453:function(e,t,i){i.d(t,{Z:function(){return w}});var r=i(15671),n=i(43144),a=i(60136),s=i(92572),o=i(27366),l=i(41691),h=i(32718),c=i(92026),u=i(49861),d=(i(25243),i(63780),i(69912)),p=i(79803),y=i(65156),v=i(70446),f=i(69787),g=i(93463),_=h.Z.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility"),b=function(e){(0,a.Z)(i,e);var t=(0,s.Z)(i);function i(e){var n;return(0,r.Z)(this,i),(n=t.call(this,e))._scaleRangeActive=!1,n._layerScaleRangeVisibilityQuery=!1,n._extent=null,n.graphicsCoreOwner=null,n.layer=null,n.queryGraphicUIDsInExtent=null,n.graphicsCore=null,n.basemapTerrain=null,n.layerScaleEnabled=!0,n.suspended=!1,n._dirty=!0,n}return(0,n.Z)(i,[{key:"initialize",value:function(){var e=this;this.updateScaleRangeActive();var t=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add(t.registerTask(g.T8.SCALE_VISIBILITY,this)),this.updatingHandles.add((function(){return e.layer.effectiveScaleRange}),(function(){return e.layerMinMaxScaleChangeHandler()}))}},{key:"destroy",value:function(){this.updatingHandles.removeAll(),this.handles.removeAll(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}},{key:"updating",get:function(){return this._dirty||this.updatingHandles.updating}},{key:"_setDirty",value:function(){this._dirty=!0}},{key:"setExtent",value:function(e){var t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this._extent=null!==e&&void 0!==e?e:null;else{var r=(0,y.Ue)();(0,p.dH)(e,t,r,i)?this._extent=r:this._extent=null}this._setDirty()}},{key:"scaleRangeActive",value:function(){return this._scaleRangeActive}},{key:"updateScaleRangeActive",value:function(){var e=this,t=this.layer,i=t.effectiveScaleRange,r=this.layerScaleEnabled&&null!=i&&m(i.minScale,i.maxScale);t.labelingInfo&&!r&&(r=t.labelingInfo.some((function(e){var t,i;return e&&m(null!==(t=e.minScale)&&void 0!==t?t:0,null!==(i=e.maxScale)&&void 0!==i?i:0)})));var n=this._scaleRangeActive!==r;return this._scaleRangeActive=r,r&&!this.handles.has(C)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),C),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(function(){return e._setDirty()})),C)):!r&&this.handles.has(C)&&this.handles.remove(C),n}},{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}},{key:"runTask",value:function(e){var t=this,i=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&i&&i.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return g.iQ.YIELD;this._layerScaleRangeVisibilityQuery=!0;var r=this.layer.effectiveScaleRange,n=r.minScale,a=r.maxScale;i.queryVisibleScaleRange(this._extent,n,a,(function(e){return t._finishUpdate(e)}))}else this._finishUpdate(!0);e.madeProgress()}},{key:"_finishUpdate",value:function(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1}},{key:"_visibleAtLayerScale",value:function(e){var t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,f.rs)(e,t.minScale||0,t.maxScale||0)}},{key:"_visibleAtLabelScale",value:function(e,t){return(0,f.rs)(e,t.minScale||0,t.maxScale||0)}},{key:"_graphicScale",value:function(e){var t;return(0,c.pC)(e.centroid)?t=e.centroid:(0,c.pC)(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}},{key:"_graphicVisible",value:function(e){if(!this.layerScaleEnabled)return!0;var t=this._graphicScale(e);return this._visibleAtLayerScale(t)}},{key:"updateVisibility",value:function(e){if(this._scaleRangeActive){var t=this._graphicVisible(e);return e.setVisibilityFlag(v.P.SCALE_RANGE,t,v.E.GRAPHIC)}return!1}},{key:"updateGraphicLabelScaleVisibility",value:function(e){if(!this._scaleRangeActive)return!1;if(!e.labelLayers||0===e.labelLayers.length)return!1;var t=this._graphicScale(e),i=this._updateLabelScaleVisibility(e,t);return i&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),i}},{key:"_updateLabelScaleVisibility",value:function(e,t){if(!e.labelLayers||0===e.labelLayers.length)return!1;var i=e.labelLayers[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){var r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(v.P.SCALE_RANGE,r,v.E.LABEL))return!0}return!1}},{key:"_scaleUpdateHandler",value:function(e){var t=this;if(this._setDirty(),this.graphicsCore.visible){var i=e.extent,r=e.scale,n=this._visibleAtLayerScale(r),a=!1,s=this.graphicsCoreOwner.view.spatialReference,o=e.spatialReference;if((0,c.Wi)(o))_.error("scaleUpdate: Internal error, no SpatialReference given for tiles");else{var l=!o.equals(s);if(!l||(0,p.dH)(i,o,S,s)){var h=l?S:i;this.queryGraphicUIDsInExtent(h,s,(function(e){var s=t.graphicsCore.getGraphics3DGraphicById(e);if(!(0,c.Wi)(s)){var o=s.centroid;(0,c.pC)(o)&&(i[0]>o.x||i[1]>o.y||i[2]<o.x||i[3]<o.y)||(s.setVisibilityFlag(v.P.SCALE_RANGE,n,v.E.GRAPHIC)&&(a=!0),t._updateLabelScaleVisibility(s,r)&&(a=!0))}})),a&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}else _.error("scaleUpdate: Internal error, cannot project AABR from "+o+" to wkid "+s)}}}},{key:"layerMinMaxScaleChangeHandler",value:function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(v.P.SCALE_RANGE)})):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}}]),i}(l.r);function m(e,t){return e>0||t>0}(0,o._)([(0,u.Cb)()],b.prototype,"graphicsCoreOwner",void 0),(0,o._)([(0,u.Cb)()],b.prototype,"layer",void 0),(0,o._)([(0,u.Cb)()],b.prototype,"queryGraphicUIDsInExtent",void 0),(0,o._)([(0,u.Cb)()],b.prototype,"graphicsCore",void 0),(0,o._)([(0,u.Cb)()],b.prototype,"basemapTerrain",void 0),(0,o._)([(0,u.Cb)({constructOnly:!0})],b.prototype,"layerScaleEnabled",void 0),(0,o._)([(0,u.Cb)({readOnly:!0})],b.prototype,"suspended",void 0),(0,o._)([(0,u.Cb)({readOnly:!0})],b.prototype,"updating",null),(0,o._)([(0,u.Cb)()],b.prototype,"_dirty",void 0),b=(0,o._)([(0,d.j)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],b);var C="terrain-events",S=(0,y.Ue)(),w=b}}]);
//# sourceMappingURL=56717.8bca23d5.chunk.js.map