"use strict";(self.webpackChunkhub_layout_versioning=self.webpackChunkhub_layout_versioning||[]).push([[37791],{71039:function(e,t,r){r.d(t,{z:function(){return M}});var n=r(37762),i=r(93433),a=r(15671),s=r(43144),o=r(60136),u=r(92572),c=r(27366),l=(r(59486),r(31319)),f=r(63780),p=r(32718),y=r(16889),d=r(92026),h=r(25666),v=r(94172),g=r(68860),b=r(49861),m=(r(25243),r(69912)),_=r(11186),w=r(48562),C=r(79803),E=r(41414),S=r(65156),k=r(22186),F=r(92975),I=r(81753),R=r(18661),Z=r(44011),x=r(88699),O=r(78952),j="esri.views.3d.layers.i3s.I3SMeshViewFilter",Q=p.Z.getLogger(j),M=function(e){(0,o.Z)(n,e);var t=(0,u.Z)(n);function n(e){var r;return(0,a.Z)(this,n),(r=t.call(this,e))._projectionEngineLoaded=!1,r}return(0,s.Z)(n,[{key:"initialize",value:function(){var e=this;(0,v.N1)((function(){var t;return(null===(t=(0,d.Wg)(e.viewFilter))||void 0===t?void 0:t.geometry)||(0,d.pC)(e.layerFilter)})).then((function(){return e.loadAsyncModule(Promise.all([r.e(99058),r.e(2170)]).then(r.bind(r,2170)).then((function(t){e.destroyed||(e._geometryEngine=t)})))}))}},{key:"sortedObjectIds",get:function(){if((0,d.Wi)(this.viewFilter)||(0,d.Wi)(this.viewFilter.objectIds))return null;var e=(0,x.QZ)(this.viewFilter.objectIds);return e.sort(),e}},{key:"parsedWhereClause",get:function(){var e=(0,d.pC)(this.viewFilter)?this.viewFilter.where:null;if((0,d.Wi)(e)||!e)return null;try{return w.WhereClause.create(e,this.layerFieldsIndex)}catch(t){Q.error("Failed to parse filter where clause: ".concat(t))}return null}},{key:"addFilters",value:function(e,t,r,n){var i=this.sortedObjectIds;(0,d.pC)(i)&&e.push((function(e){return(0,Z.Yb)(i,!0,e)})),this.addSqlFilter(e,this.parsedWhereClause);var a=(0,h.lK)(this._layerMaskGeometries),s=this._geometryEngine;if((0,d.pC)(a)&&(0,d.pC)(this.layerFilter)&&(0,d.pC)(s)){var o=this.layerFilter.spatialRelationship;e.push((function(e,i){return A(s,e,i,n,t,r,a,o)}))}var u=(0,h.lK)(this._viewMaskGeometries);if((0,d.pC)(u)&&(0,d.pC)(this.viewFilter)&&(0,d.pC)(s)){var c=this.viewFilter.spatialRelationship;e.push((function(e,i){return A(s,e,i,n,t,r,u,c)}))}}},{key:"isMBSGeometryVisible",value:function(e,t,r){var n=(0,h.lK)(this._layerMaskGeometries),i=this._geometryEngine;if((0,d.pC)(n)&&(0,d.pC)(this.layerFilter)&&(0,d.pC)(i)){var a=this.layerFilter.spatialRelationship,s=n[0].spatialReference||t;return(0,C.st)(e,r,K,s)?G(i,K,n,s,a):(Q.warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}var o=(0,h.lK)(this._viewMaskGeometries);if((0,d.pC)(o)&&(0,d.pC)(this.viewFilter)&&(0,d.pC)(i)){var u=this.viewFilter.spatialRelationship,c=o[0].spatialReference||t;return(0,C.st)(e,r,K,c)?G(i,K,o,c,u):(Q.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}},{key:"parsedGeometry",get:function(){var e=(0,h.lK)(this._viewMaskGeometries),t=(0,h.lK)(this._layerMaskGeometries);return(0,d.Wi)(e)||(0,d.Wi)(t)?e||t:t.concat(e)}},{key:"_layerMaskGeometries",get:function(){var e=this.layerFilter;return(0,d.Wi)(e)?null:(0,d.Wi)(this._geometryEngine)?h.cn:"disjoint"===e.spatialRelationship?e.geometries.map((function(e){return{type:"polygon",rings:e.rings,spatialReference:e.spatialReference,cache:{}}})):[e.geometries.reduce((function(e,t){return e.rings=[].concat((0,i.Z)(e.rings),(0,i.Z)(t.rings)),e}),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}},{key:"_viewMaskGeometries",get:function(){var e=this;if((0,d.Wi)(this.viewFilter))return null;var t=this.viewFilter.geometry;if((0,d.Wi)(t))return null;if((0,d.Wi)(this.viewFilter)||(0,d.Wi)(this._geometryEngine))return h.cn;var r=this.viewFilter,n=r.distance,i=r.units,a=this.viewFilter.spatialRelationship,s="mesh"===t.type?t.extent:t;if((0,d.Wi)(n)||0===n)return T(this._geometryEngine,s,a);var o=i||(0,g.qE)(s.spatialReference);if(s.spatialReference.isWGS84){var u=this._geometryEngine.geodesicBuffer(s,n,o);return T(this._geometryEngine,u,a)}var c=(0,I.iV)(s,O.Z.WGS84);if((0,d.pC)(c)){var l=(0,I.iV)(this._geometryEngine.geodesicBuffer(c,n,o),s.spatialReference);return T(this._geometryEngine,l,a)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule((0,C.zD)().then((function(){return e._projectionEngineLoaded=!0}))),!this._projectionEngineLoaded))return null;var f=null;try{f=(0,C.iV)(s,O.Z.WGS84)}catch(p){}if(f)try{f=(0,C.iV)(this._geometryEngine.geodesicBuffer(f,n,o),s.spatialReference)}catch(p){f=null}return f||Q.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry (".concat(s.spatialReference.wkid,") to WGS84.")),T(this._geometryEngine,f,a)}},{key:"updating",get:function(){return(0,h.j)(this._layerMaskGeometries)||(0,h.j)(this._viewMaskGeometries)}}],[{key:"checkSupport",value:function(e){return!(0,d.Wi)(e)&&(e.timeExtent?(Q.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!function(e){return null!=e&&D.includes(e)}(e.spatialRelationship)||(Q.warn("Filters with spatialRelationship other than ".concat(D.join(", ")," are not supported for mesh scene layers")),!1))}}]),n}(l.Z);(0,c._)([(0,b.Cb)()],M.prototype,"layerFilter",void 0),(0,c._)([(0,b.Cb)({type:R.Z})],M.prototype,"viewFilter",void 0),(0,c._)([(0,b.Cb)()],M.prototype,"layerFieldsIndex",void 0),(0,c._)([(0,b.Cb)()],M.prototype,"loadAsyncModule",void 0),(0,c._)([(0,b.Cb)()],M.prototype,"addSqlFilter",void 0),(0,c._)([(0,b.Cb)({readOnly:!0})],M.prototype,"sortedObjectIds",null),(0,c._)([(0,b.Cb)({readOnly:!0})],M.prototype,"parsedWhereClause",null),(0,c._)([(0,b.Cb)({readOnly:!0})],M.prototype,"parsedGeometry",null),(0,c._)([(0,b.Cb)({readOnly:!0})],M.prototype,"_layerMaskGeometries",null),(0,c._)([(0,b.Cb)({readOnly:!0})],M.prototype,"_viewMaskGeometries",null),(0,c._)([(0,b.Cb)()],M.prototype,"updating",null),(0,c._)([(0,b.Cb)()],M.prototype,"_projectionEngineLoaded",void 0),(0,c._)([(0,b.Cb)()],M.prototype,"_geometryEngine",void 0),M=(0,c._)([(0,m.j)(j)],M);var N,W,D=["contains","intersects","disjoint"];function T(e,t,r){if((0,d.Wi)(t))return null;if("disjoint"===r&&"polygon"===t.type){var n=function(){for(var r=t.rings.length,n=t.spatialReference,i=new Array(r),a=0;a<r;++a){var s=(0,S.al)(1/0,1/0,-1/0,-1/0);(0,S.Wi)(s,t.rings[a]),i[a]={type:"polygon",rings:[t.rings[a]],spatialReference:n,cache:{},aabr:s}}i.sort((function(e,t){return e.aabr[0]-t.aabr[0]}));for(var o=new Set,u=new f.SO,c=function(t){var r=i[t],n=r.aabr[0];o.forEach((function(t){if(n>=t.aabr[2])o.delete(t);else if(!(r.aabr[1]>t.aabr[3]||r.aabr[3]<t.aabr[1])&&e.intersects(r,t)){r.rings=r.rings.concat(t.rings),(0,S.jn)(r.aabr,t.aabr,r.aabr),r.cache={},o.delete(t);var a=(0,f.cq)(i,t,i.length,u);i.splice(a,1)}})),o.add(r)},l=0;l<i.length;++l)c(l);for(var p=0,y=i;p<y.length;p++){y[p].aabr=void 0}return{v:i}}();if("object"===typeof n)return n.v}return[t]}function G(e,t,r,n,i){var a=J(e,t,n);return r.every((function(t){return V(e,t,a,i)!==N.DISCARD}))}function A(e,t,r,i,a,s,o,u){var c=o[0].spatialReference||a.spatialReference;if((0,C.st)(r.node.mbs,s,K,c)){var l,f=J(e,K,c),p=function(e,t,r,n,i){var a=t.renderSpatialReference,s=new Map,o={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};o.rings[0][3]=o.rings[0][0];var u,c,l={indices:null,data:null,stride:0,startIndex:0,endIndex:0};switch(e){case"intersects":u=function(e,t,r){return e.intersects(t,r)?N.KEEP:N.TEST},c=P;break;case"contains":u=function(e,t,r){return e.contains(t,r)?N.TEST:N.DISCARD},c=P;break;default:u=function(e,t,r){return e.disjoint(t,r)?N.TEST:N.DISCARD},c=q}return{collection:n,object:i,type:e,maskSR:r,renderSR:a,aabbCache:s,triangle:o,positions:l,triangleTest:u,geometryTest:c}}(u,a,c,i,r.objectHandle),y=(0,n.Z)(o);try{var d=function(){var n=l.value;if(0===t.length)return{v:void 0};switch(V(e,n,f,u)){case N.DISCARD:return{v:void(t.length=0)};case N.KEEP:return"continue"}(0,Z.hv)(t,r.featureIds,(function(t){return function(e,t,r,n){var i=n.collection,a=n.object,s=n.renderSR,o=n.maskSR,u=n.geometryTest,c=n.aabbCache,l=c.get(r);if(!l){var f=i.getObjectTransform(a);i.getComponentAabb(a,r,B);for(var p=[[B[0],B[1],0],[B[0],B[4],0],[B[3],B[4],0],[B[3],B[1],0]],y=0;y<4;++y)(0,_.t)(p[y],p[y],f.rotationScale),(0,_.a)(p[y],p[y],f.position),(0,C.SH)(p[y],s,p[y],o);(l={type:"polygon",rings:[p],spatialReference:o,cache:{}}).rings[0][4]=l.rings[0][0],c.set(r,l)}switch(u(e,t,l)){case N.DISCARD:return!1;case N.KEEP:return!0}var d=n.triangle,h=n.triangleTest,v=n.positions,g=d.rings[0][0],b=d.rings[0][1],m=d.rings[0][2],w=i.getObjectTransform(a);i.getComponentPositions(a,r,v);for(var E=v.indices,S=v.data,k=v.stride,F=v.startIndex,I=v.endIndex,R=F;R<I;R+=3){var Z=k*E[R+0],x=k*E[R+1],O=k*E[R+2];switch((0,_.s)(g,S[Z+0],S[Z+1],S[Z+2]),(0,_.s)(b,S[x+0],S[x+1],S[x+2]),(0,_.s)(m,S[O+0],S[O+1],S[O+2]),(0,_.t)(g,g,w.rotationScale),(0,_.t)(b,b,w.rotationScale),(0,_.t)(m,m,w.rotationScale),(0,_.a)(g,g,w.position),(0,_.a)(b,b,w.position),(0,_.a)(m,m,w.position),(0,C.SH)(g,s,g,o),(0,C.SH)(b,s,b,o),(0,C.SH)(m,s,m,o),h(e,t,d)){case N.DISCARD:return!1;case N.KEEP:return!0}}return"intersects"!==n.type}(e,n,t,p)}))};for(y.s();!(l=y.n()).done;){var h=d();if("continue"!==h&&"object"===typeof h)return h.v}}catch(v){y.e(v)}finally{y.f()}}else Q.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")}(W=N||(N={}))[W.KEEP=0]="KEEP",W[W.DISCARD=1]="DISCARD",W[W.TEST=2]="TEST";var K=[0,0,0,0];function J(e,t,r){var n={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},i=!(0,F.oR)(r)&&!(0,F.sS)(r),a=Number.isNaN(t[3])?0:(0,y.uZ)(t[3],0,2*k.sv.radius),s=i?e.buffer(n,a,1):e.geodesicBuffer(n,a,1);return s.type="polygon",s}function V(e,t,r,n){switch(n){case"intersects":case"contains":return P(e,t,r);case"disjoint":return q(e,t,r)}}function P(e,t,r){return e.intersects(t,r)?e.contains(t,r)?N.KEEP:N.TEST:N.DISCARD}function q(e,t,r){return e.intersects(t,r)?e.contains(t,r)?N.DISCARD:N.TEST:N.KEEP}var B=(0,E.Ue)()},43812:function(e,t,r){r.d(t,{u:function(){return C}});var n=r(74165),i=r(15861),a=r(15671),s=r(43144),o=r(60136),u=r(92572),c=r(27366),l=r(31319),f=r(10064),p=r(100),y=r(92026),d=r(49861),h=(r(25243),r(63780),r(69912)),v=r(53866),g=r(28970),b=r(14e3),m=r(49818),_=r(21149),w=b.q,C=function(e){(0,o.Z)(r,e);var t=(0,u.Z)(r);function r(e){var n;return(0,a.Z)(this,r),(n=t.call(this,e))._handles=new p.Z,n}return(0,s.Z)(r,[{key:"spatialReference",get:function(){return this.layerView.view.spatialReference}},{key:"layer",get:function(){return this.layerView.i3slayer}},{key:"defaultQueryJSON",get:function(){return new _.Z({outSpatialReference:this.spatialReference}).toJSON()}},{key:"_dataQueryEngine",get:function(){return this._ensureDataQueryEngine()}},{key:"initialize",value:function(){var e=this;this._handles.add(this.layerView.on("visible-geometry-changed",(function(){return e.spatialIndex.events.emit("changed")})))}},{key:"destroy",value:function(){this._dataQueryEngineInstance=(0,y.SC)(this._dataQueryEngineInstance),this._handles=(0,y.SC)(this._handles),this._set("layerView",null)}},{key:"executeQueryForCount",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,a,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),r);case 2:return i=e.sent,a=i.count,s=i.extent,e.abrupt("return",{count:a,extent:v.Z.fromJSON(s)});case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQuery",value:function(){var e=(0,i.Z)((0,n.Z)().mark((function e(t,r){var i,a,s;return(0,n.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=this._ensureQueryJSON(t)).returnGeometry){e.next=3;break}throw new f.Z("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");case 3:if(!i.returnCentroid){e.next=5;break}throw new f.Z("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");case 5:return e.next=7,this._dataQueryEngine.executeQuery(i,r);case 7:return a=e.sent,s=m.Z.fromJSON(a),e.abrupt("return",(s.features.forEach((function(e){e.geometry=null})),s));case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_ensureQueryJSON",value:function(e){return(0,y.Wi)(e)?this.defaultQueryJSON:e.toJSON()}},{key:"_ensureDataQueryEngine",value:function(){var e,t;if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var r=this.layer.objectIdField||g.d,n=null!==(e=null===(t=this.layer.fields)||void 0===t?void 0:t.map((function(e){return e.toJSON()})))&&void 0!==e?e:[],i=this.layerView.view.resourceController.scheduler,a=this.spatialReference.toJSON(),s=this.priority,o=this.spatialIndex;return this._dataQueryEngineInstance=new w({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:n,timeInfo:null,spatialReference:a,objectIdField:r,featureStore:o,scheduler:i,priority:s}),this._dataQueryEngineInstance}}]),r}(l.Z);(0,c._)([(0,d.Cb)({constructOnly:!0})],C.prototype,"layerView",void 0),(0,c._)([(0,d.Cb)({constructOnly:!0})],C.prototype,"priority",void 0),(0,c._)([(0,d.Cb)({constructOnly:!0})],C.prototype,"spatialIndex",void 0),(0,c._)([(0,d.Cb)()],C.prototype,"spatialReference",null),(0,c._)([(0,d.Cb)()],C.prototype,"layer",null),(0,c._)([(0,d.Cb)()],C.prototype,"defaultQueryJSON",null),C=(0,c._)([(0,h.j)("esri.views.3d.layers.i3s.I3SQueryEngine")],C)},51246:function(e,t,r){r.d(t,{u:function(){return f}});var n=r(29439),i=r(15671),a=r(43144),s=r(92026),o=r(41414),u=r(85403),c=r(80457),l=r(44011),f=function(){function e(t){(0,i.Z)(this,e),this._objectIdField=t.objectIdField,this._getFeatureExtent=t.getFeatureExtent}return(0,a.Z)(e,[{key:"getObjectId",value:function(e){return e.id}},{key:"getAttributes",value:function(e){var t=e.meta,r=e.index,n={};this._objectIdField&&(n[this._objectIdField]=e.id);var i=(0,s.pC)(t.attributeInfo)&&t.attributeInfo.attributeData;if((0,s.pC)(i))for(var a=0,o=Object.keys(i);a<o.length;a++){var u=o[a];n[u]=(0,l.Jx)(i[u],r)}return n}},{key:"getAttribute",value:function(e,t){if(t===this._objectIdField)return e.id;var r=e.meta,n=e.index,i=(0,s.pC)(r.attributeInfo)&&r.attributeInfo.attributeData;return(0,s.pC)(i)?(0,l.Jx)(i[t],n):null}},{key:"getGeometry",value:function(e){if(e.geometry)return e.geometry;var t=this._getFeatureExtent(e,p),r=(0,n.Z)(t,5),i=r[0],a=r[1],s=r[2],o=r[3],u=r[4];return new c.Z([5],[i,a,s,o,a,s,o,u,s,i,u,s,i,a,s])}},{key:"getCentroid",value:function(e,t){if(e.geometry)return(0,u.Y)(new c.Z,e.geometry,t.hasZ,t.hasM);var r=this._getFeatureExtent(e,p),i=(0,n.Z)(r,6),a=i[0],s=i[1],o=i[2],l=i[3],f=i[4],y=i[5];return new c.Z([0],[(a+l)/2,(s+f)/2,(o+y)/2])}},{key:"cloneWithGeometry",value:function(e,t){return{id:e.id,index:e.index,meta:e.meta,geometry:t}}}]),e}(),p=(0,o.Ue)()},73552:function(e,t,r){r.d(t,{I:function(){return m}});var n=r(37762),i=r(15671),a=r(43144),s=r(60136),o=r(92572),u=r(27366),c=r(31319),l=r(91505),f=r(49861),p=(r(25243),r(63780),r(69912)),y=r(67077),d=r(79803),h=r(41414),v=r(65156),g=r(42757),b=(0,h.Ue)(),m=function(e){(0,s.Z)(r,e);var t=(0,o.Z)(r);function r(e){var n;return(0,i.Z)(this,r),(n=t.call(this,e)).events=new l.Z,n}return(0,a.Z)(r,[{key:"forEach",value:function(e){this.forAllFeatures((function(t){return e(t),g.K.CONTINUE}))}},{key:"forEachBounds",value:function(e,t){var r,i=this.getFeatureExtent,a=(0,n.Z)(e);try{for(a.s();!(r=a.n()).done;){t(i(r.value,b))}}catch(s){a.e(s)}finally{a.f()}}},{key:"forEachInBounds",value:function(e,t){var r=this;this.forAllFeatures((function(n){var i=r.getFeatureExtent(n,w);return(0,v.kK)(e,(0,h.y8)(i,C))&&t(n),g.K.CONTINUE}),(function(t){if((0,d.st)(t.node.mbs,r.sourceSpatialReference,_,r.viewSpatialReference),_[0]>=e[0]&&_[2]<=e[2]&&_[1]>=e[1]&&_[3]<=e[3])return g.K.CONTINUE;var n=Math.max(e[0],Math.min(_[0],e[2])),i=Math.max(e[1],Math.min(_[1],e[3])),a=_[0]-n,s=_[1]-i;return a*a+s*s<=_[3]*_[3]?g.K.CONTINUE:g.K.SKIP}))}}]),r}(c.Z);(0,u._)([(0,f.Cb)({constructOnly:!0})],m.prototype,"featureAdapter",void 0),(0,u._)([(0,f.Cb)({constructOnly:!0})],m.prototype,"forAllFeatures",void 0),(0,u._)([(0,f.Cb)({constructOnly:!0})],m.prototype,"getFeatureExtent",void 0),(0,u._)([(0,f.Cb)({constructOnly:!0})],m.prototype,"sourceSpatialReference",void 0),(0,u._)([(0,f.Cb)({constructOnly:!0})],m.prototype,"viewSpatialReference",void 0),m=(0,u._)([(0,p.j)("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],m);var _=(0,y.c)(),w=(0,h.Ue)(),C=(0,v.Ue)()}}]);
//# sourceMappingURL=37791.fa7ce25c.chunk.js.map